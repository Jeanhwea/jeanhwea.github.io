#+TITLE: MySQL优化器实现原理探索
#+AUTHOR: Jinghui Hu
#+EMAIL: hujinghui@buaa.edu.cn
#+DATE: <2023-02-22 Wed 11:36:43>
#+HTML_LINK_UP: ../readme.html
#+HTML_LINK_HOME: ../index.html
#+SETUPFILE: ~/.emacs.d/site-lisp/org-html-themes/setup/theme-readtheorg-local.setup
#+PROPERTY: header-args:sql :dbhost 127.0.0.1 :database employees :engine mysql :dbuser root :exports both


* SQL 执行流程
参考 [[https://dev.mysql.com/doc/dev/mysql-server/8.0.30/PAGE_SQL_EXECUTION.html][执行流程]]

[[file:../static/image/2023/0222/193853.png]]

#+BEGIN_EXAMPLE
  T@8: | | | >lex_start => 词法解析
  T@8: | | | | >LEX::new_top_level_query
  T@8: | | | | | >*LEX::new_query
  T@8: | | | | | | outer_field: creating ctx 0x11e0139e0
  T@8: | | | | | | outer_field: ctx 0x11e0139e0 <-> SL# 1
  T@8: | | | | | <*LEX::new_query
  T@8: | | | | <LEX::new_top_level_query
  T@8: | | | <lex_start

  T@8: | | | >parse_sql => 语法解析
  T@8: | | | | >*Query_block::add_table_to_list
  T@8: | | | | | >*MEM_ROOT::AllocSlow
  T@8: | | | | | | enter: root: 0x11d80ca40
  T@8: | | | | | | >*MEM_ROOT::AllocBlock
  T@8: | | | | | | | >char *PFS_instr_name::str
  T@8: | | | | | | | <char *PFS_instr_name::str
  T@8: | | | | | | <*MEM_ROOT::AllocBlock
  T@8: | | | | | <*MEM_ROOT::AllocSlow
  T@8: | | | | <*Query_block::add_table_to_list
  T@8: | | | | >Query_block::add_joined_table
  T@8: | | | | <Query_block::add_joined_table
  T@8: | | | <parse_sql

  T@8: | | | >mysql_execute_command
  T@8: | | | | >Diagnostics_area::reset_diagnostics_area

  T@8: | | | | >open_temporary_tables
  T@8: | | | | | >open_temporary_table
  T@8: | | | | | | enter: table: 'employees'.'dept_manager'
  T@8: | | | | | <open_temporary_table
  T@8: | | | | <open_temporary_tables
  T@8: | | | | >bool Sql_cmd_dml::execute => DML 执行方法
  T@8: | | | | | >bool Sql_cmd_dml::prepare
  T@8: | | | | | | >check_table_access
  T@8: | | | | | | | info: table: dept_manager derived: 0  view: 0
  T@8: | | | | | | | >check_access
  T@8: | | | | | | | | enter: db: employees  want_access: 1  master_access: 2147483647
  T@8: | | | | | | | | THD::enter_stage: 'checking permissions' /Users/bytedance/code/jeanhwea/mysql-server/sql/auth/sql_authorization.cc:2147

  T@8: | | | | | >Query_expression::optimize => 优化器
  T@8: | | | | | | >Query_block::optimize
  T@8: | | | | | | | >JOIN::optimize
  T@8: | | | | | | | | THD::enter_stage: 'optimizing' /Users/bytedance/code/jeanhwea/mysql-server/sql/sql_optimizer.cc:296

  T@8: | | | | | | | | | opt: (null): ending struct
  T@8: | | | | | | | | | opt: rows_estimation: ending struct
  T@8: | | | | | | | | | opt: (null): ending struct
  T@8: | | | | | | | | | >Optimize_table_order::choose_table_order
  T@8: | | | | | | | | | | >Query_block::reset_nj_counters
  T@8: | | | | | | | | | | <Query_block::reset_nj_counters
  T@8: | | | | | | | | | | opt: (null): starting struct
  T@8: | | | | | | | | | | opt: considered_execution_plans: starting struct
  T@8: | | | | | | | | | | >Optimize_table_order::greedy_search
  T@8: | | | | | | | | | | | >Optimize_table_order::best_extension_by_limited_search

  T@8: | | | | | | | | | | | | <Optimize_table_order::best_access_path
  T@8: | | | | | | | | | | | | opt: condition_filtering_pct: 100
  T@8: | | | | | | | | | | | | opt: rows_for_plan: 24
  T@8: | | | | | | | | | | | | opt: cost_for_plan: 3.4
  T@8: | | | | | | | | | | | | opt: sort_cost: 24
  T@8: | | | | | | | | | | | | opt: new_cost_for_plan: 27.4
  T@8: | | | | | | | | | | | | opt: chosen: 1
  T@8: | | | | | | | | | | | | opt: (null): ending struct
  T@8: | | | | | | | | | | | <Optimize_table_order::best_extension_by_limited_search
  T@8: | | | | | | | | | | <Optimize_table_order::greedy_search

  T@8: | | | | | | | <JOIN::optimize
  T@8: | | | | | | <Query_block::optimize
  T@8: | | | | | <Query_expression::optimize
  T@8: | | | | | >Query_expression::execute => 执行 SQL
  T@8: | | | | | | THD::enter_stage: 'executing' /Users/bytedance/code/jeanhwea/mysql-server/sql/sql_union.cc:1186
  T@8: | | | | | | >PROFILING::status_change
  T@8: | | | | | | <PROFILING::status_change
  T@8: | | | | | | opt: (null): starting struct
  T@8: | | | | | | opt: join_execution: starting struct
  T@8: | | | | | | opt: select#: 1
  T@8: | | | | | | opt: steps: starting struct
  T@8: | | | | | | >THD::send_result_metadata
  T@8: | | | | | | | >bool Protocol_classic::start_result_metadata
  T@8: | | | | | | | | info: num_cols 2, flags 5
  T@8: | | | | | | | | net write: Memory: 0x17131d03f  Bytes: (1)

  T@8: | | <dispatch_sql_command
  T@8: | | info: query ready
  T@8: | | >THD::send_statement_status
  T@8: | | | >bool Protocol_classic::send_eof
  T@8: | | | | >net_send_ok
  T@8: | | | | | info: affected_rows: 0  id: 0  status: 2  warning_count: 0
  T@8: | | | | | net write: Memory: 0x17132032e  Bytes: (7)
  T@8: | | | | | >vio_is_blocking
  T@8: | | | | | <vio_is_blocking
#+END_EXAMPLE

* Explain vs Optimize Trace
** Explain
Explain 可以看出简要的执行计划

#+BEGIN_SRC sql :results output :exports both
  explain format=json select emp_no from employees where emp_no < 11111\G
#+END_SRC

#+RESULTS:
#+begin_example
,*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "224.08" // => cost值
    },
    "table": {
      "table_name": "employees",
      "access_type": "range", // 范围扫描
      "possible_keys": [
        "PRIMARY"
      ],
      "key": "PRIMARY", // 命中主键
      "used_key_parts": [
        "emp_no"
      ],
      "key_length": "4",
      "rows_examined_per_scan": 1110, // 需要扫描 1110 行数据
      "rows_produced_per_join": 1110,
      "filtered": "100.00",
      "using_index": true,
      "cost_info": {
        "read_cost": "113.08",
        "eval_cost": "111.00",
        "prefix_cost": "224.08",
        "data_read_per_join": "147K"
      },
      "used_columns": [
        "emp_no"
      ],
      "attached_condition": "(`employees`.`employees`.`emp_no` < 11111)"
    }
  }
}
#+end_example

** Optimize Trace

#+BEGIN_SRC sql :results output :exports both
  set optimizer_trace="enabled=on";
  select emp_no from employees where emp_no < 11111;
  select * from information_schema.optimizer_trace\g
#+END_SRC

#+BEGIN_EXAMPLE
  QUERY: select emp_no from employees where emp_no < 11111
  TRACE: {
    "steps": [
      {
        "join_preparation": {
          "select#": 1,
          "steps": [
            {
              "expanded_query": "/* select#1 */ select `employees`.`emp_no` AS `emp_no` from `employees` where (`employees`.`emp_no` < 11111)"
            }
          ]
        }
      },
      {
        "join_optimization": {
          "select#": 1,
          "steps": [
            {
              "condition_processing": {
                "condition": "WHERE",
                "original_condition": "(`employees`.`emp_no` < 11111)",
                "steps": [
                  {
                    "transformation": "equality_propagation",
                    "resulting_condition": "(`employees`.`emp_no` < 11111)"
                  },
                  {
                    "transformation": "constant_propagation",
                    "resulting_condition": "(`employees`.`emp_no` < 11111)"
                  },
                  {
                    "transformation": "trivial_condition_removal",
                    "resulting_condition": "(`employees`.`emp_no` < 11111)"
                  }
                ]
              }
            },
            {
              "substitute_generated_columns": {
              }
            },
            {
              "table_dependencies": [
                {
                  "table": "`employees`",
                  "row_may_be_null": false,
                  "map_bit": 0,
                  "depends_on_map_bits": [
                  ]
                }
              ]
            },
            {
              "ref_optimizer_key_uses": [
              ]
            },
            {
              "rows_estimation": [
                {
                  "table": "`employees`",
                  "range_analysis": {
                    "table_scan": {
                      "rows": 299556,
                      "cost": 30874.9
                    },
                    "potential_range_indexes": [
                      {
                        "index": "PRIMARY",
                        "usable": true,
                        "key_parts": [
                          "emp_no"
                        ]
                      }
                    ],
                    "best_covering_index_scan": {
                      "index": "PRIMARY",
                      "cost": 30245.1,
                      "chosen": true
                    },
                    "setup_range_conditions": [
                    ],
                    "group_index_range": {
                      "chosen": false,
                      "cause": "not_group_by_or_distinct"
                    },
                    "skip_scan_range": {
                      "potential_skip_scan_indexes": [
                        {
                          "index": "PRIMARY",
                          "usable": false,
                          "cause": "prefix_not_const_equality"
                        }
                      ]
                    },
                    "analyzing_range_alternatives": { => 范围扫描分析参数
                      "range_scan_alternatives": [
                        {
                          "index": "PRIMARY",
                          "ranges": [
                            "emp_no < 11111"
                          ],
                          "index_dives_for_eq_ranges": true,
                          "rowid_ordered": true,
                          "using_mrr": false,
                          "index_only": true,
                          "in_memory": 0.01693,
                          "rows": 1110,
                          "cost": 113.084,
                          "chosen": true
                        }
                      ],
                      "analyzing_roworder_intersect": {
                        "usable": false,
                        "cause": "too_few_roworder_scans"
                      }
                    },
                    "chosen_range_access_summary": {
                      "range_access_plan": {
                        "type": "range_scan",
                        "index": "PRIMARY",
                        "rows": 1110,
                        "ranges": [
                          "emp_no < 11111"
                        ]
                      },
                      "rows_for_plan": 1110,
                      "cost_for_plan": 113.084,
                      "chosen": true
                    }
                  }
                }
              ]
            },
            {
              "considered_execution_plans": [
                {
                  "plan_prefix": [
                  ],
                  "table": "`employees`",
                  "best_access_path": {
                    "considered_access_paths": [
                      {
                        "rows_to_scan": 1110,
                        "access_type": "range",
                        "range_details": {
                          "used_index": "PRIMARY"
                        },
                        "resulting_rows": 1110,
                        "cost": 224.084,
                        "chosen": true
                      }
                    ]
                  },
                  "condition_filtering_pct": 100,
                  "rows_for_plan": 1110,
                  "cost_for_plan": 224.084,
                  "chosen": true
                }
              ]
            },
            {
              "attaching_conditions_to_tables": {
                "original_condition": "(`employees`.`emp_no` < 11111)",
                "attached_conditions_computation": [
                ],
                "attached_conditions_summary": [
                  {
                    "table": "`employees`",
                    "attached": "(`employees`.`emp_no` < 11111)"
                  }
                ]
              }
            },
            {
              "finalizing_table_conditions": [
                {
                  "table": "`employees`",
                  "original_table_condition": "(`employees`.`emp_no` < 11111)",
                  "final_table_condition   ": "(`employees`.`emp_no` < 11111)"
                }
              ]
            },
            {
              "refine_plan": [
                {
                  "table": "`employees`"
                }
              ]
            }
          ]
        }
      },
      {
        "join_execution": {
          "select#": 1,
          "steps": [
          ]
        }
      }
    ]
  }
  MISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0
            INSUFFICIENT_PRIVILEGES: 0
  1 row in set (0.01 sec)
#+END_EXAMPLE
