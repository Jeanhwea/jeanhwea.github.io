<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-02-26 Sun 08:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MySQL优化器实现原理探索</title>
<meta name="author" content="Jinghui Hu" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">MySQL优化器实现原理探索</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc37aeae">1. 引言 MySQL Architecture</a></li>
<li><a href="#org0937516">2. 工具 Explain vs Optimize Trace</a>
<ul>
<li><a href="#org53cd2d0">2.1. Explain</a></li>
<li><a href="#orgc58ab8c">2.2. Optimize Trace</a></li>
</ul>
</li>
<li><a href="#org2213d80">3. 主题 Topics</a>
<ul>
<li><a href="#org92b0495">3.1. Logical Transformations</a>
<ul>
<li><a href="#org6b6bfe7">3.1.1. 前置说明</a></li>
<li><a href="#org3f29363">3.1.2. 主键相关</a></li>
<li><a href="#org4f59ae7">3.1.3. 其它类型</a></li>
</ul>
</li>
<li><a href="#org40cd323">3.2. Cost-based Optimization</a>
<ul>
<li><a href="#orgd9d6be2">3.2.1. 计算流程</a></li>
<li><a href="#org28054f8">3.2.2. cost 常量</a></li>
<li><a href="#org8bcb199">3.2.3. 元数据 &amp; 统计数据</a></li>
<li><a href="#org5b3e1f0">3.2.4. cost 常量配置实验</a></li>
</ul>
</li>
<li><a href="#org7db2dd5">3.3. Hints</a>
<ul>
<li><a href="#org79b6ab7">3.3.1. Old Style Hints</a></li>
<li><a href="#orgee8fb63">3.3.2. New Comment-Style Hints</a></li>
</ul>
</li>
<li><a href="#org15653d6">3.4. Index Optimization</a>
<ul>
<li><a href="#org21ea902">3.4.1. Comparing Plans</a></li>
<li><a href="#orgc71d9c6">3.4.2. Composite Indexes</a></li>
<li><a href="#org5bc0a37">3.4.3. Covering Indexes</a></li>
<li><a href="#orga11c9bf">3.4.4. Transient Plans</a></li>
</ul>
</li>
<li><a href="#org0890fc1">3.5. Subqueries</a>
<ul>
<li><a href="#org823f5e1">3.5.1. Scalar Subquery</a></li>
<li><a href="#org7ed577f">3.5.2. IN Subquery (Unique)</a></li>
<li><a href="#org459311b">3.5.3. IN Subquery (Non-Unique)</a></li>
<li><a href="#orgbf74ecd">3.5.4. NOT IN Subquery</a></li>
<li><a href="#org732d7b2">3.5.5. Derived Table</a></li>
</ul>
</li>
<li><a href="#org57c2cd6">3.6. CTEs and Views</a></li>
<li><a href="#orgc3857b2">3.7. Join</a></li>
<li><a href="#orgf52a45e">3.8. Aggregation</a></li>
<li><a href="#org3359b7b">3.9. Sorting</a></li>
<li><a href="#org89bc1dc">3.10. Partitioning</a></li>
<li><a href="#org72da9f1">3.11. Query Rewrite</a></li>
<li><a href="#org2f2e990">3.12. Invisible Indexes</a></li>
<li><a href="#org3c806a7">3.13. Profiling Queries</a></li>
<li><a href="#orgd4cd8fa">3.14. JSON and Generated Columns</a></li>
<li><a href="#orge170297">3.15. Character Sets</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgc37aeae" class="outline-2">
<h2 id="orgc37aeae"><span class="section-number-2">1.</span> 引言 MySQL Architecture</h2>
<div class="outline-text-2" id="text-1">
<p>
参考 <a href="https://dev.mysql.com/doc/dev/mysql-server/8.0.30/PAGE_SQL_EXECUTION.html">执行流程</a>
</p>


<div id="orgb4c92d3" class="figure">
<p><img src="../static/image/2023/0222/193853.png" alt="193853.png" />
</p>
</div>

<pre class="example" id="org85e87bd">
T@8: | | | &gt;lex_start =&gt; 词法解析
T@8: | | | | &gt;LEX::new_top_level_query
T@8: | | | | | &gt;*LEX::new_query
T@8: | | | | | | outer_field: creating ctx 0x11e0139e0
T@8: | | | | | | outer_field: ctx 0x11e0139e0 &lt;-&gt; SL# 1
T@8: | | | | | &lt;*LEX::new_query
T@8: | | | | &lt;LEX::new_top_level_query
T@8: | | | &lt;lex_start

T@8: | | | &gt;parse_sql =&gt; 语法解析
T@8: | | | | &gt;*Query_block::add_table_to_list
T@8: | | | | | &gt;*MEM_ROOT::AllocSlow
T@8: | | | | | | enter: root: 0x11d80ca40
T@8: | | | | | | &gt;*MEM_ROOT::AllocBlock
T@8: | | | | | | | &gt;char *PFS_instr_name::str
T@8: | | | | | | | &lt;char *PFS_instr_name::str
T@8: | | | | | | &lt;*MEM_ROOT::AllocBlock
T@8: | | | | | &lt;*MEM_ROOT::AllocSlow
T@8: | | | | &lt;*Query_block::add_table_to_list
T@8: | | | | &gt;Query_block::add_joined_table
T@8: | | | | &lt;Query_block::add_joined_table
T@8: | | | &lt;parse_sql

T@8: | | | &gt;mysql_execute_command
T@8: | | | | &gt;Diagnostics_area::reset_diagnostics_area

T@8: | | | | &gt;open_temporary_tables
T@8: | | | | | &gt;open_temporary_table
T@8: | | | | | | enter: table: 'employees'.'dept_manager'
T@8: | | | | | &lt;open_temporary_table
T@8: | | | | &lt;open_temporary_tables
T@8: | | | | &gt;bool Sql_cmd_dml::execute =&gt; DML 执行方法
T@8: | | | | | &gt;bool Sql_cmd_dml::prepare
T@8: | | | | | | &gt;check_table_access
T@8: | | | | | | | info: table: dept_manager derived: 0  view: 0
T@8: | | | | | | | &gt;check_access
T@8: | | | | | | | | enter: db: employees  want_access: 1  master_access: 2147483647
T@8: | | | | | | | | THD::enter_stage: 'checking permissions' /Users/bytedance/code/jeanhwea/mysql-server/sql/auth/sql_authorization.cc:2147

T@8: | | | | | &gt;Query_expression::optimize =&gt; 优化器
T@8: | | | | | | &gt;Query_block::optimize
T@8: | | | | | | | &gt;JOIN::optimize
T@8: | | | | | | | | THD::enter_stage: 'optimizing' /Users/bytedance/code/jeanhwea/mysql-server/sql/sql_optimizer.cc:296

T@8: | | | | | | | | | opt: (null): ending struct
T@8: | | | | | | | | | opt: rows_estimation: ending struct
T@8: | | | | | | | | | opt: (null): ending struct
T@8: | | | | | | | | | &gt;Optimize_table_order::choose_table_order
T@8: | | | | | | | | | | &gt;Query_block::reset_nj_counters
T@8: | | | | | | | | | | &lt;Query_block::reset_nj_counters
T@8: | | | | | | | | | | opt: (null): starting struct
T@8: | | | | | | | | | | opt: considered_execution_plans: starting struct
T@8: | | | | | | | | | | &gt;Optimize_table_order::greedy_search
T@8: | | | | | | | | | | | &gt;Optimize_table_order::best_extension_by_limited_search

T@8: | | | | | | | | | | | | &lt;Optimize_table_order::best_access_path
T@8: | | | | | | | | | | | | opt: condition_filtering_pct: 100
T@8: | | | | | | | | | | | | opt: rows_for_plan: 24
T@8: | | | | | | | | | | | | opt: cost_for_plan: 3.4
T@8: | | | | | | | | | | | | opt: sort_cost: 24
T@8: | | | | | | | | | | | | opt: new_cost_for_plan: 27.4
T@8: | | | | | | | | | | | | opt: chosen: 1
T@8: | | | | | | | | | | | | opt: (null): ending struct
T@8: | | | | | | | | | | | &lt;Optimize_table_order::best_extension_by_limited_search
T@8: | | | | | | | | | | &lt;Optimize_table_order::greedy_search

T@8: | | | | | | | &lt;JOIN::optimize
T@8: | | | | | | &lt;Query_block::optimize
T@8: | | | | | &lt;Query_expression::optimize
T@8: | | | | | &gt;Query_expression::execute =&gt; 执行 SQL
T@8: | | | | | | THD::enter_stage: 'executing' /Users/bytedance/code/jeanhwea/mysql-server/sql/sql_union.cc:1186
T@8: | | | | | | &gt;PROFILING::status_change
T@8: | | | | | | &lt;PROFILING::status_change
T@8: | | | | | | opt: (null): starting struct
T@8: | | | | | | opt: join_execution: starting struct
T@8: | | | | | | opt: select#: 1
T@8: | | | | | | opt: steps: starting struct
T@8: | | | | | | &gt;THD::send_result_metadata
T@8: | | | | | | | &gt;bool Protocol_classic::start_result_metadata
T@8: | | | | | | | | info: num_cols 2, flags 5
T@8: | | | | | | | | net write: Memory: 0x17131d03f  Bytes: (1)

T@8: | | &lt;dispatch_sql_command
T@8: | | info: query ready
T@8: | | &gt;THD::send_statement_status
T@8: | | | &gt;bool Protocol_classic::send_eof
T@8: | | | | &gt;net_send_ok
T@8: | | | | | info: affected_rows: 0  id: 0  status: 2  warning_count: 0
T@8: | | | | | net write: Memory: 0x17132032e  Bytes: (7)
T@8: | | | | | &gt;vio_is_blocking
T@8: | | | | | &lt;vio_is_blocking
</pre>
</div>
</div>

<div id="outline-container-org0937516" class="outline-2">
<h2 id="org0937516"><span class="section-number-2">2.</span> 工具 Explain vs Optimize Trace</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org53cd2d0" class="outline-3">
<h3 id="org53cd2d0"><span class="section-number-3">2.1.</span> Explain</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Explain 可以看出简要的执行计划
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span> <span style="color: #859900;">select</span> emp_no <span style="color: #6c71c4;">from</span> employees <span style="color: #859900;">where</span> emp_no &lt; 11111\G
</pre>
</div>

<pre class="example" id="org9207c48">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "224.08" // =&gt; cost值
    },
    "table": {
      "table_name": "employees",
      "access_type": "range", // 范围扫描
      "possible_keys": [
        "PRIMARY"
      ],
      "key": "PRIMARY", // 命中主键
      "used_key_parts": [
        "emp_no"
      ],
      "key_length": "4",
      "rows_examined_per_scan": 1110, // 需要扫描 1110 行数据
      "rows_produced_per_join": 1110,
      "filtered": "100.00",
      "using_index": true,
      "cost_info": {
        "read_cost": "113.08",
        "eval_cost": "111.00",
        "prefix_cost": "224.08",
        "data_read_per_join": "147K"
      },
      "used_columns": [
        "emp_no"
      ],
      "attached_condition": "(`employees`.`employees`.`emp_no` &lt; 11111)"
    }
  }
}
</pre>
</div>
</div>

<div id="outline-container-orgc58ab8c" class="outline-3">
<h3 id="orgc58ab8c"><span class="section-number-3">2.2.</span> Optimize Trace</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Optimize Trace 工具使用步骤
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">&#24320;&#21551; trace</span>
<span style="color: #859900;">set</span> optimizer_trace="enabled=<span style="color: #859900;">on</span>";

<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">&#25191;&#34892; Query</span>
<span style="color: #859900;">select</span> emp_no <span style="color: #6c71c4;">from</span> employees <span style="color: #859900;">where</span> emp_no &lt; 11111;

<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">Trace &#26085;&#24535;&#34920;&#32467;&#26500;</span>
mysql&gt; <span style="color: #859900;">desc</span> information_schema.optimizer_trace;
+<span style="color: #586e75; font-style: italic;">-----------------------------------</span><span style="color: #586e75; font-style: italic;">+----------------+------+-----+---------+-------+</span>
| <span style="color: #6c71c4;">Field</span>                             | <span style="color: #859900;">Type</span>           | <span style="color: #859900;">Null</span> | <span style="color: #859900;">Key</span> | <span style="color: #859900;">Default</span> | Extra |
+<span style="color: #586e75; font-style: italic;">-----------------------------------</span><span style="color: #586e75; font-style: italic;">+----------------+------+-----+---------+-------+</span>
| QUERY                             | <span style="color: #268bd2;">varchar</span>(65535) | <span style="color: #859900;">NO</span>   |     |         |       |
| TRACE                             | <span style="color: #268bd2;">varchar</span>(65535) | <span style="color: #859900;">NO</span>   |     |         |       |
| MISSING_BYTES_BEYOND_MAX_MEM_SIZE | <span style="color: #268bd2;">int</span>            | <span style="color: #859900;">NO</span>   |     |         |       |
| INSUFFICIENT_PRIVILEGES           | <span style="color: #268bd2;">tinyint</span>(1)     | <span style="color: #859900;">NO</span>   |     |         |       |
+<span style="color: #586e75; font-style: italic;">-----------------------------------</span><span style="color: #586e75; font-style: italic;">+----------------+------+-----+---------+-------+</span>
4 <span style="color: #859900;">rows</span> <span style="color: #859900;">in</span> <span style="color: #859900;">set</span> (0.03 sec)

<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">&#26597;&#30475;&#32467;&#26524;</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> information_schema.optimizer_trace\G
<span style="color: #859900;">select</span> trace <span style="color: #6c71c4;">from</span> information_schema.optimizer_trace\G
</pre>
</div>

<pre class="example" id="orgd1f94be">
QUERY: select emp_no from employees where emp_no &lt; 11111
TRACE: {
  "steps": [
    {
      "join_preparation": {
        "select#": 1,
        "steps": [
          {
            "expanded_query": "/* select#1 */ select `employees`.`emp_no` AS `emp_no` from `employees` where (`employees`.`emp_no` &lt; 11111)"
          }
        ]
      }
    },
    {
      "join_optimization": {
        "select#": 1,
        "steps": [
          {
            "condition_processing": {
              "condition": "WHERE",
              "original_condition": "(`employees`.`emp_no` &lt; 11111)",
              "steps": [
                {
                  "transformation": "equality_propagation",
                  "resulting_condition": "(`employees`.`emp_no` &lt; 11111)"
                },
                {
                  "transformation": "constant_propagation",
                  "resulting_condition": "(`employees`.`emp_no` &lt; 11111)"
                },
                {
                  "transformation": "trivial_condition_removal",
                  "resulting_condition": "(`employees`.`emp_no` &lt; 11111)"
                }
              ]
            }
          },
          {
            "substitute_generated_columns": {
            }
          },
          {
            "table_dependencies": [
              {
                "table": "`employees`",
                "row_may_be_null": false,
                "map_bit": 0,
                "depends_on_map_bits": [
                ]
              }
            ]
          },
          {
            "ref_optimizer_key_uses": [
            ]
          },
          {
            "rows_estimation": [
              {
                "table": "`employees`",
                "range_analysis": {
                  "table_scan": {
                    "rows": 299556,
                    "cost": 30874.9
                  },
                  "potential_range_indexes": [
                    {
                      "index": "PRIMARY",
                      "usable": true,
                      "key_parts": [
                        "emp_no"
                      ]
                    }
                  ],
                  "best_covering_index_scan": {
                    "index": "PRIMARY",
                    "cost": 30245.1,
                    "chosen": true
                  },
                  "setup_range_conditions": [
                  ],
                  "group_index_range": {
                    "chosen": false,
                    "cause": "not_group_by_or_distinct"
                  },
                  "skip_scan_range": {
                    "potential_skip_scan_indexes": [
                      {
                        "index": "PRIMARY",
                        "usable": false,
                        "cause": "prefix_not_const_equality"
                      }
                    ]
                  },
                  "analyzing_range_alternatives": { =&gt; 范围扫描分析参数
                    "range_scan_alternatives": [
                      {
                        "index": "PRIMARY",
                        "ranges": [
                          "emp_no &lt; 11111"
                        ],
                        "index_dives_for_eq_ranges": true,
                        "rowid_ordered": true,
                        "using_mrr": false,
                        "index_only": true,
                        "in_memory": 0.01693,
                        "rows": 1110,
                        "cost": 113.084,
                        "chosen": true
                      }
                    ],
                    "analyzing_roworder_intersect": {
                      "usable": false,
                      "cause": "too_few_roworder_scans"
                    }
                  },
                  "chosen_range_access_summary": {
                    "range_access_plan": {
                      "type": "range_scan",
                      "index": "PRIMARY",
                      "rows": 1110,
                      "ranges": [
                        "emp_no &lt; 11111"
                      ]
                    },
                    "rows_for_plan": 1110,
                    "cost_for_plan": 113.084,
                    "chosen": true
                  }
                }
              }
            ]
          },
          {
            "considered_execution_plans": [
              {
                "plan_prefix": [
                ],
                "table": "`employees`",
                "best_access_path": {
                  "considered_access_paths": [
                    {
                      "rows_to_scan": 1110,
                      "access_type": "range",
                      "range_details": {
                        "used_index": "PRIMARY"
                      },
                      "resulting_rows": 1110,
                      "cost": 224.084,
                      "chosen": true
                    }
                  ]
                },
                "condition_filtering_pct": 100,
                "rows_for_plan": 1110,
                "cost_for_plan": 224.084,
                "chosen": true
              }
            ]
          },
          {
            "attaching_conditions_to_tables": {
              "original_condition": "(`employees`.`emp_no` &lt; 11111)",
              "attached_conditions_computation": [
              ],
              "attached_conditions_summary": [
                {
                  "table": "`employees`",
                  "attached": "(`employees`.`emp_no` &lt; 11111)"
                }
              ]
            }
          },
          {
            "finalizing_table_conditions": [
              {
                "table": "`employees`",
                "original_table_condition": "(`employees`.`emp_no` &lt; 11111)",
                "final_table_condition   ": "(`employees`.`emp_no` &lt; 11111)"
              }
            ]
          },
          {
            "refine_plan": [
              {
                "table": "`employees`"
              }
            ]
          }
        ]
      }
    },
    {
      "join_execution": {
        "select#": 1,
        "steps": [
        ]
      }
    }
  ]
}
MISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0
          INSUFFICIENT_PRIVILEGES: 0
1 row in set (0.01 sec)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2213d80" class="outline-2">
<h2 id="org2213d80"><span class="section-number-2">3.</span> 主题 Topics</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org92b0495" class="outline-3">
<h3 id="org92b0495"><span class="section-number-3">3.1.</span> Logical Transformations</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org6b6bfe7" class="outline-4">
<h4 id="org6b6bfe7"><span class="section-number-4">3.1.1.</span> 前置说明</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Transformation 可以理解对输入的 Query 字符串进行转化，我们以例子进行分析
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 5000000 <span style="color: #859900;">and</span> continent = <span style="color: #2aa198;">'Asia'</span> <span style="color: #859900;">and</span> 1 = 1;
</pre>
</div>

<p>
Trace 的日志的结果
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"steps"</span>: <span style="color: #d8241f;">[</span>
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_preparation"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` where ((`country`.`Population` &gt; 5000000) and (`country`.`Continent` = 'Asia'))"</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_optimization"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"condition_processing"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"condition"</span>: <span style="color: #2aa198;">"WHERE"</span>,
              <span style="color: #859900;">"original_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and (`country`.`Continent` = 'Asia'))"</span>,
              <span style="color: #859900;">"steps"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"equality_propagation"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and multiple equal('Asia', `country`.`Continent`))"</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"constant_propagation"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and multiple equal('Asia', `country`.`Continent`))"</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"trivial_condition_removal"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and multiple equal('Asia', `country`.`Continent`))"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"substitute_generated_columns"</span>: <span style="color: #00bed1;">{</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"table_dependencies"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"row_may_be_null"</span>: <span style="color: #268bd2;">false</span>,
                <span style="color: #859900;">"map_bit"</span>: <span style="color: #268bd2;">0</span>,
                <span style="color: #859900;">"depends_on_map_bits"</span>: <span style="color: #e574c3;">[</span>
                <span style="color: #e574c3;">]</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"ref_optimizer_key_uses"</span>: <span style="color: #00bed1;">[</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"rows_estimation"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"table_scan"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                  <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">1.75</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"considered_execution_plans"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #e574c3;">[</span>
                <span style="color: #e574c3;">]</span>,
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"best_access_path"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #8d5649;">[</span>
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">239</span>,
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                      <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">239</span>,
                      <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">25.65</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">]</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">100</span>,
                <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">239</span>,
                <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">25.65</span>,
                <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"attaching_conditions_to_tables"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"original_condition"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 5000000))"</span>,
              <span style="color: #859900;">"attached_conditions_computation"</span>: <span style="color: #bcbf00;">[</span>
              <span style="color: #bcbf00;">]</span>,
              <span style="color: #859900;">"attached_conditions_summary"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                  <span style="color: #859900;">"attached"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 5000000))"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"finalizing_table_conditions"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"original_table_condition"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 5000000))"</span>,
                <span style="color: #859900;">"final_table_condition   "</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 5000000))"</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"refine_plan"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_execution"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">]</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
这三次的转换分别是
</p>
<ul class="org-ul">
<li>equality<sub>propagation</sub> 等值条件句转换</li>
<li>constant<sub>propagation</sub> 常量条件句转换</li>
<li>trivial<sub>condition</sub><sub>removal</sub> 无效条件移除的转换，该例子将 <code>1 = 1</code> 永真表达式剔除了</li>
</ul>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #859900;">"steps"</span>: <span style="color: #8d5649;">[</span>
  <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"equality_propagation"</span>,
    <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and multiple equal('Asia', `country`.`Continent`))"</span>
  <span style="color: #d8241f;">}</span>,
  <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"constant_propagation"</span>,
    <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and multiple equal('Asia', `country`.`Continent`))"</span>
  <span style="color: #d8241f;">}</span>,
  <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"trivial_condition_removal"</span>,
    <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 5000000) and multiple equal('Asia', `country`.`Continent`))"</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">]</span>
</pre>
</div>

<p>
Transformation 过后生成的结果 expanded<sub>query</sub> 如下
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75; font-style: italic;">/* select#1 */</span>
<span style="color: #859900;">select</span>
  `country`.`Code` <span style="color: #859900;">as</span> `Code`,
  `country`.`<span style="color: #859900;">Name</span>` <span style="color: #859900;">as</span> `<span style="color: #859900;">Name</span>`,
  `country`.`Continent` <span style="color: #859900;">as</span> `Continent`,
  `country`.`Region` <span style="color: #859900;">as</span> `Region`,
  `country`.`SurfaceArea` <span style="color: #859900;">as</span> `SurfaceArea`,
  `country`.`IndepYear` <span style="color: #859900;">as</span> `IndepYear`,
  `country`.`Population` <span style="color: #859900;">as</span> `Population`,
  `country`.`LifeExpectancy` <span style="color: #859900;">as</span> `LifeExpectancy`,
  `country`.`GNP` <span style="color: #859900;">as</span> `GNP`,
  `country`.`GNPOld` <span style="color: #859900;">as</span> `GNPOld`,
  `country`.`LocalName` <span style="color: #859900;">as</span> `LocalName`,
  `country`.`GovernmentForm` <span style="color: #859900;">as</span> `GovernmentForm`,
  `country`.`HeadOfState` <span style="color: #859900;">as</span> `HeadOfState`,
  `country`.`Capital` <span style="color: #859900;">as</span> `Capital`,
  `country`.`Code2` <span style="color: #859900;">as</span> `Code2`
<span style="color: #6c71c4;">from</span>
  `country`
<span style="color: #859900;">where</span> ((`country`.`Population` &gt; 5000000)
  <span style="color: #859900;">and</span> (`country`.`Continent` = <span style="color: #2aa198;">'Asia'</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f29363" class="outline-4">
<h4 id="org3f29363"><span class="section-number-4">3.1.2.</span> 主键相关</h4>
<div class="outline-text-4" id="text-3-1-2">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75; font-style: italic;">-- </span><span style="color: #586e75; font-style: italic;">&#21629;&#20013;&#20027;&#38190;</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> code = <span style="color: #2aa198;">'CAN'</span>;
<span style="color: #586e75; font-style: italic;">-- </span><span style="color: #586e75; font-style: italic;">&#26410;&#21629;&#20013;&#20027;&#38190;</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> code = <span style="color: #2aa198;">'XYZ'</span>;
</pre>
</div>

<div id="orgbc5b9fa" class="figure">
<p><img src="../static/image/2023/0223/111928.png" alt="111928.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org4f59ae7" class="outline-4">
<h4 id="org4f59ae7"><span class="section-number-4">3.1.3.</span> 其它类型</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
永假式优化
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> code = <span style="color: #2aa198;">'CAN'</span> <span style="color: #859900;">and</span> 1 = 0;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75; font-style: italic;">/* select#1 */</span>
<span style="color: #859900;">select</span>
  `country`.`Code` <span style="color: #859900;">as</span> `Code`,
  `country`.`<span style="color: #859900;">Name</span>` <span style="color: #859900;">as</span> `<span style="color: #859900;">Name</span>`,
  `country`.`Continent` <span style="color: #859900;">as</span> `Continent`,
  `country`.`Region` <span style="color: #859900;">as</span> `Region`,
  `country`.`SurfaceArea` <span style="color: #859900;">as</span> `SurfaceArea`,
  `country`.`IndepYear` <span style="color: #859900;">as</span> `IndepYear`,
  `country`.`Population` <span style="color: #859900;">as</span> `Population`,
  `country`.`LifeExpectancy` <span style="color: #859900;">as</span> `LifeExpectancy`,
  `country`.`GNP` <span style="color: #859900;">as</span> `GNP`,
  `country`.`GNPOld` <span style="color: #859900;">as</span> `GNPOld`,
  `country`.`LocalName` <span style="color: #859900;">as</span> `LocalName`,
  `country`.`GovernmentForm` <span style="color: #859900;">as</span> `GovernmentForm`,
  `country`.`HeadOfState` <span style="color: #859900;">as</span> `HeadOfState`,
  `country`.`Capital` <span style="color: #859900;">as</span> `Capital`,
  `country`.`Code2` <span style="color: #859900;">as</span> `Code2`
<span style="color: #6c71c4;">from</span>
  `country`
<span style="color: #859900;">where</span>
  <span style="color: #859900;">false</span>
</pre>
</div>

<p>
嵌入式 join 的转化
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span>
  city.*
<span style="color: #6c71c4;">from</span>
  city,
  (
    <span style="color: #859900;">select</span>
      *
    <span style="color: #6c71c4;">from</span>
      country
    <span style="color: #859900;">where</span>
      continent = <span style="color: #2aa198;">'Asia'</span>) <span style="color: #859900;">as</span> country
<span style="color: #859900;">where</span>
  country.code = City.countryCode
  <span style="color: #859900;">and</span> country.population &gt; 5000000;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"join_preparation"</span>: <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
    <span style="color: #859900;">"steps"</span>: <span style="color: #9564bf;">[</span>
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"join_preparation"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
          <span style="color: #859900;">"steps"</span>: <span style="color: #1776b6;">[</span>
            <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#2 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` where (`country`.`Continent` = 'Asia')"</span>
              // select
              //   `country`.`Code` as `Code`,
              //   `country`.`Name` as `Name`,
              //   `country`.`Continent` as `Continent`,
              //   `country`.`Region` as `Region`,
              //   `country`.`SurfaceArea` as `SurfaceArea`,
              //   `country`.`IndepYear` as `IndepYear`,
              //   `country`.`Population` as `Population`,
              //   `country`.`LifeExpectancy` as `LifeExpectancy`,
              //   `country`.`GNP` as `GNP`,
              //   `country`.`GNPOld` as `GNPOld`,
              //   `country`.`LocalName` as `LocalName`,
              //   `country`.`GovernmentForm` as `GovernmentForm`,
              //   `country`.`HeadOfState` as `HeadOfState`,
              //   `country`.`Capital` as `Capital`,
              //   `country`.`Code<span style="color: #268bd2;">2</span>` as `Code<span style="color: #268bd2;">2</span>`
              // from
              //   `country`
              // where <span style="color: #bcbf00;">(</span>`country`.`Continent` = 'Asia'<span style="color: #bcbf00;">)</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">]</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"derived"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`` `country`"</span>,
          <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
          <span style="color: #859900;">"merged"</span>: <span style="color: #268bd2;">true</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `city`.`ID` AS `ID`,`city`.`Name` AS `Name`,`city`.`CountryCode` AS `CountryCode`,`city`.`District` AS `District`,`city`.`Population` AS `Population` from `city` join (`country`) on((`country`.`Continent` = 'Asia')) where ((`country`.`Code` = `city`.`CountryCode`) and (`country`.`Population` &gt; 5000000))"</span>
        // select
        //   `city`.`ID` as `ID`,
        //   `city`.`Name` as `Name`,
        //   `city`.`CountryCode` as `CountryCode`,
        //   `city`.`District` as `District`,
        //   `city`.`Population` as `Population`
        // from
        //   `city`
        //   join <span style="color: #ff7f00;">(</span>`country`<span style="color: #ff7f00;">)</span> on <span style="color: #ff7f00;">(</span>`country`.`Continent` = 'Asia'<span style="color: #ff7f00;">)</span>
        // where <span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span>`country`.`Code` = `city`.`CountryCode`<span style="color: #1776b6;">)</span>
        //   and <span style="color: #1776b6;">(</span>`country`.`Population` &gt; <span style="color: #268bd2;">5000000</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"transformations_to_nested_joins"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"transformations"</span>: <span style="color: #1776b6;">[</span>
            <span style="color: #2aa198;">"JOIN_condition_to_WHERE"</span>,
            <span style="color: #2aa198;">"parenthesis_removal"</span>
          <span style="color: #1776b6;">]</span>,
          <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `city`.`ID` AS `ID`,`city`.`Name` AS `Name`,`city`.`CountryCode` AS `CountryCode`,`city`.`District` AS `District`,`city`.`Population` AS `Population` from `city` join `country` where ((`country`.`Code` = `city`.`CountryCode`) and (`country`.`Population` &gt; 5000000) and (`country`.`Continent` = 'Asia'))"</span>
          // select
          //   `city`.`ID` as `ID`,
          //   `city`.`Name` as `Name`,
          //   `city`.`CountryCode` as `CountryCode`,
          //   `city`.`District` as `District`,
          //   `city`.`Population` as `Population`
          // from
          //   `city`
          //   join `country`
          // where <span style="color: #1776b6;">(</span><span style="color: #00bed1;">(</span>`country`.`Code` = `city`.`CountryCode`<span style="color: #00bed1;">)</span>
          //   and <span style="color: #00bed1;">(</span>`country`.`Population` &gt; <span style="color: #268bd2;">5000000</span><span style="color: #00bed1;">)</span>
          //   and <span style="color: #00bed1;">(</span>`country`.`Continent` = 'Asia'<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">]</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
基于视图优化
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> <span style="color: #859900;">view</span> <span style="color: #b58900;">countries_in_asia</span> <span style="color: #859900;">as</span> <span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent = <span style="color: #2aa198;">'Asia'</span>;

<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> countries_in_asia <span style="color: #859900;">where</span> population &gt; 5000000;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"join_preparation"</span>: <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
    <span style="color: #859900;">"steps"</span>: <span style="color: #9564bf;">[</span>
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"join_preparation"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
          <span style="color: #859900;">"steps"</span>: <span style="color: #1776b6;">[</span>
            <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#2 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` where (`country`.`Continent` = 'Asia')"</span>
              // select
              //   `country`.`Code` as `Code`,
              //   `country`.`Name` as `Name`,
              //   `country`.`Continent` as `Continent`,
              //   `country`.`Region` as `Region`,
              //   `country`.`SurfaceArea` as `SurfaceArea`,
              //   `country`.`IndepYear` as `IndepYear`,
              //   `country`.`Population` as `Population`,
              //   `country`.`LifeExpectancy` as `LifeExpectancy`,
              //   `country`.`GNP` as `GNP`,
              //   `country`.`GNPOld` as `GNPOld`,
              //   `country`.`LocalName` as `LocalName`,
              //   `country`.`GovernmentForm` as `GovernmentForm`,
              //   `country`.`HeadOfState` as `HeadOfState`,
              //   `country`.`Capital` as `Capital`,
              //   `country`.`Code<span style="color: #268bd2;">2</span>` as `Code<span style="color: #268bd2;">2</span>`
              // from
              //   `country`
              // where <span style="color: #bcbf00;">(</span>`country`.`Continent` = 'Asia'<span style="color: #bcbf00;">)</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">]</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"view"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countries_in_asia`"</span>,
          <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
          <span style="color: #859900;">"merged"</span>: <span style="color: #268bd2;">true</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from &lt;constant table&gt; join (`country`) on((`country`.`Continent` = 'Asia')) where (`country`.`Population` &gt; 5000000)"</span>
        // select
        //   `country`.`Code` as `Code`,
        //   `country`.`Name` as `Name`,
        //   `country`.`Continent` as `Continent`,
        //   `country`.`Region` as `Region`,
        //   `country`.`SurfaceArea` as `SurfaceArea`,
        //   `country`.`IndepYear` as `IndepYear`,
        //   `country`.`Population` as `Population`,
        //   `country`.`LifeExpectancy` as `LifeExpectancy`,
        //   `country`.`GNP` as `GNP`,
        //   `country`.`GNPOld` as `GNPOld`,
        //   `country`.`LocalName` as `LocalName`,
        //   `country`.`GovernmentForm` as `GovernmentForm`,
        //   `country`.`HeadOfState` as `HeadOfState`,
        //   `country`.`Capital` as `Capital`,
        //   `country`.`Code<span style="color: #268bd2;">2</span>` as `Code<span style="color: #268bd2;">2</span>`
        // from
        //   &lt; constant table &gt;
        //   join <span style="color: #ff7f00;">(</span>`country`<span style="color: #ff7f00;">)</span> on <span style="color: #ff7f00;">(</span>`country`.`Continent` = 'Asia'<span style="color: #ff7f00;">)</span>
        // where <span style="color: #ff7f00;">(</span>`country`.`Population` &gt; <span style="color: #268bd2;">5000000</span><span style="color: #ff7f00;">)</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"transformations_to_nested_joins"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"transformations"</span>: <span style="color: #1776b6;">[</span>
            <span style="color: #2aa198;">"JOIN_condition_to_WHERE"</span>,
            <span style="color: #2aa198;">"parenthesis_removal"</span>
          <span style="color: #1776b6;">]</span>,
          <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` where ((`country`.`Population` &gt; 5000000) and (`country`.`Continent` = 'Asia'))"</span>
          // select
          //   `country`.`Code` as `Code`,
          //   `country`.`Name` as `Name`,
          //   `country`.`Continent` as `Continent`,
          //   `country`.`Region` as `Region`,
          //   `country`.`SurfaceArea` as `SurfaceArea`,
          //   `country`.`IndepYear` as `IndepYear`,
          //   `country`.`Population` as `Population`,
          //   `country`.`LifeExpectancy` as `LifeExpectancy`,
          //   `country`.`GNP` as `GNP`,
          //   `country`.`GNPOld` as `GNPOld`,
          //   `country`.`LocalName` as `LocalName`,
          //   `country`.`GovernmentForm` as `GovernmentForm`,
          //   `country`.`HeadOfState` as `HeadOfState`,
          //   `country`.`Capital` as `Capital`,
          //   `country`.`Code<span style="color: #268bd2;">2</span>` as `Code<span style="color: #268bd2;">2</span>`
          // from
          //   `country`
          // where <span style="color: #1776b6;">(</span><span style="color: #00bed1;">(</span>`country`.`Population` &gt; <span style="color: #268bd2;">5000000</span><span style="color: #00bed1;">)</span>
          //   and <span style="color: #00bed1;">(</span>`country`.`Continent` = 'Asia'<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">]</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org40cd323" class="outline-3">
<h3 id="org40cd323"><span class="section-number-3">3.2.</span> Cost-based Optimization</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-orgd9d6be2" class="outline-4">
<h4 id="orgd9d6be2"><span class="section-number-4">3.2.1.</span> 计算流程</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
CBO 是 MySQL 优化器的计算模型，其简要的流程如下：
</p>
<ol class="org-ol">
<li>为每个操作分配一个成本 (cost)</li>
<li>评估每个可能的计划需要多少次操作</li>
<li>将各个操作成本相加</li>
<li>选择总成本最低的计划</li>
</ol>

<div id="orgab09316" class="figure">
<p><img src="../static/image/2023/0223/165913.png" alt="165913.png" />
</p>
</div>

<p>
为什么是简化的？因为优化器不会分析每种可能的执行计划的成本，只会从中选出那些很有
可能成为最优的计划，想象一下，假如有 5 张表关联查询，每张表有 5 个索引，那么共有
\(5! * 5! = 14400\) 种可能的执行计划，如果优化器都逐个分析，很有可能分析所耗费的时
间都比 sql 语句执行的时间长，这样的分析就失去了它的价值。
</p>

<p>
MySQL 的 optimizer<sub>search</sub><sub>depth</sub> 参数可以控制优化器搜索的深度
</p>

<p>
正因为如此，优化器选择的计划不是每次都是最优的，如果你能明确知道某种计划是最优的，
那么你可以强制执行那个计划，比如：明确知道用索引 index<sub>a</sub> 是最快的，那么你可以使
用 <code>force index('index_a')</code> 强制优化器执行
</p>
</div>
</div>

<div id="outline-container-org28054f8" class="outline-4">
<h4 id="org28054f8"><span class="section-number-4">3.2.2.</span> cost 常量</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
MySQL 8.0 的 cose 配置常量如下所示, 详见 <a href="https://dev.mysql.com/doc/refman/8.0/en/cost-model.html">Cost Model</a>
服务端的 cost
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> mysql.server_cost;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">cost<sub>name</sub></th>
<th scope="col" class="org-left">cost<sub>value</sub></th>
<th scope="col" class="org-left">last<sub>update</sub></th>
<th scope="col" class="org-left">comment</th>
<th scope="col" class="org-right">default<sub>value</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">disk<sub>temptable</sub><sub>create</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-left">disk<sub>temptable</sub><sub>row</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">0.5</td>
</tr>

<tr>
<td class="org-left">key<sub>compare</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">0.05</td>
</tr>

<tr>
<td class="org-left">memory<sub>temptable</sub><sub>create</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">memory<sub>temptable</sub><sub>row</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">0.1</td>
</tr>

<tr>
<td class="org-left">row<sub>evaluate</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">0.1</td>
</tr>
</tbody>
</table>

<p>
引擎 cost 列表
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> mysql.engine_cost;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">engine<sub>name</sub></th>
<th scope="col" class="org-right">device<sub>type</sub></th>
<th scope="col" class="org-left">cost<sub>name</sub></th>
<th scope="col" class="org-left">cost<sub>value</sub></th>
<th scope="col" class="org-left">last<sub>update</sub></th>
<th scope="col" class="org-left">comment</th>
<th scope="col" class="org-right">default<sub>value</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">default</td>
<td class="org-right">0</td>
<td class="org-left">io<sub>block</sub><sub>read</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">default</td>
<td class="org-right">0</td>
<td class="org-left">memory<sub>block</sub><sub>read</sub><sub>cost</sub></td>
<td class="org-left">NULL</td>
<td class="org-left">2023-02-20 14:39:39</td>
<td class="org-left">NULL</td>
<td class="org-right">0.25</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org8bcb199" class="outline-4">
<h4 id="org8bcb199"><span class="section-number-4">3.2.3.</span> 元数据 &amp; 统计数据</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
MySQL 优化器的计算模型依赖系统的元数据和统计信息，见 <a href="https://dev.mysql.com/doc/refman/8.0/en/optimizer-statistics.html">Optimizer Statistics</a>
常见使用的元数据如下：
</p>


<div id="orge697998" class="figure">
<p><img src="../static/image/2023/0223/201652.png" alt="201652.png" />
</p>
</div>

<p>
相关统计信息如下：
</p>


<div id="org73c6492" class="figure">
<p><img src="../static/image/2023/0223/201742.png" alt="201742.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org5b3e1f0" class="outline-4">
<h4 id="org5b3e1f0"><span class="section-number-4">3.2.4.</span> cost 常量配置实验</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
默认执行 SQL 的花费
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span> <span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000\G
</pre>
</div>

<pre class="example" id="org07bc924">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "25.65" // 总体 cost 值
    },
    "table": {
      "table_name": "country",
      "access_type": "ALL",
      "rows_examined_per_scan": 239,
      "rows_produced_per_join": 11,
      "filtered": "4.76",
      "cost_info": {
        "read_cost": "24.51",
        "eval_cost": "1.14",
        "prefix_cost": "25.65",
        "data_read_per_join": "10K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "((`world`.`country`.`Continent` = 'asia') and (`world`.`country`.`Population` &gt; 5000000))"
    }
  }
}
</pre>

<p>
将 row<sub>evaluate</sub><sub>cost</sub> 从默认值 0.1 修改成 1
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">update</span> mysql.server_cost <span style="color: #859900;">set</span> cost_value=1 <span style="color: #859900;">where</span> cost_name=<span style="color: #2aa198;">'row_evaluate_cost'</span>;
flush optimizer_costs;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span> <span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000\G
</pre>
</div>

<pre class="example" id="org572460f">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "240.75" // 总体 cost 提升了 10 倍
    },
    "table": {
      "table_name": "country",
      "access_type": "ALL",
      "rows_examined_per_scan": 239,
      "rows_produced_per_join": 11,
      "filtered": "4.76",
      "cost_info": {
        "read_cost": "229.37",
        "eval_cost": "11.38",
        "prefix_cost": "240.75",
        "data_read_per_join": "10K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "((`world`.`country`.`Continent` = 'asia') and (`world`.`country`.`Population` &gt; 5000000))"
    }
  }
}
</pre>

<p>
恢复默认值, 防止影响后续实验
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">update</span> mysql.server_cost <span style="color: #859900;">set</span> cost_value=<span style="color: #859900;">null</span> <span style="color: #859900;">where</span> cost_name=<span style="color: #2aa198;">'row_evaluate_cost'</span>;
flush optimizer_costs;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7db2dd5" class="outline-3">
<h3 id="org7db2dd5"><span class="section-number-3">3.3.</span> Hints</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-org79b6ab7" class="outline-4">
<h4 id="org79b6ab7"><span class="section-number-4">3.3.1.</span> Old Style Hints</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
老版本的 Hints 是直接写在 SQL 语句中的，目前 Hints 的写法在 MySQL 8.0 依然支持，
下面有一些示例
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75; font-style: italic;">-- </span><span style="color: #586e75; font-style: italic;">Join tables in the order specified</span>
<span style="color: #859900;">select</span> <span style="color: #859900;">straight_join</span> country.<span style="color: #859900;">name</span> <span style="color: #859900;">as</span> countryname, city.<span style="color: #859900;">name</span> <span style="color: #859900;">as</span> city
<span style="color: #6c71c4;">from</span> country <span style="color: #859900;">inner</span> <span style="color: #859900;">join</span> city <span style="color: #859900;">on</span> city.countrycode=country.code;

<span style="color: #586e75; font-style: italic;">-- </span><span style="color: #586e75; font-style: italic;">Force usage of an index</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">force</span> <span style="color: #859900;">index</span> (p)
<span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000;

<span style="color: #586e75; font-style: italic;">-- </span><span style="color: #586e75; font-style: italic;">Ignore an index</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">ignore</span> <span style="color: #859900;">index</span> (p)
<span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000;

<span style="color: #586e75; font-style: italic;">-- </span><span style="color: #586e75; font-style: italic;">Suggest an index over other indexes</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">use</span> <span style="color: #859900;">index</span> (p)
<span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000;
</pre>
</div>

<p>
如果直接写 SQL, 全表扫描的 query<sub>cost</sub> = 25.65
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000\G
</pre>
</div>

<pre class="example" id="org006ef2f">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "25.65"
    },
    "table": {
      "table_name": "country",
      "access_type": "ALL",
      "possible_keys": [
        "p"
      ],
      "rows_examined_per_scan": 239,
      "rows_produced_per_join": 15,
      "filtered": "6.46",
      "cost_info": {
        "read_cost": "24.11",
        "eval_cost": "1.54",
        "prefix_cost": "25.65",
        "data_read_per_join": "14K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "((`world`.`country`.`Continent` = 'Asia') and (`world`.`country`.`Population` &gt; 5000000))"
    }
  }
}
</pre>

<p>
强制走索引 p, query<sub>cost</sub> = 48.86
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">force</span> <span style="color: #859900;">index</span> (p) <span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span> <span style="color: #859900;">and</span> population &gt; 5000000\G
</pre>
</div>

<pre class="example" id="orgdda815b">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "48.86"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "p"
      ],
      "key": "p",
      "used_key_parts": [
        "Population"
      ],
      "key_length": "4",
      "rows_examined_per_scan": 108,
      "rows_produced_per_join": 15,
      "filtered": "14.29",
      "index_condition": "(`world`.`country`.`Population` &gt; 5000000)",
      "cost_info": {
        "read_cost": "47.32",
        "eval_cost": "1.54",
        "prefix_cost": "48.86",
        "data_read_per_join": "14K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "(`world`.`country`.`Continent` = 'Asia')"
    }
  }
}
</pre>
</div>
</div>

<div id="outline-container-orgee8fb63" class="outline-4">
<h4 id="orgee8fb63"><span class="section-number-4">3.3.2.</span> New Comment-Style Hints</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
常见的注释类型的 Hints 如下： <a href="https://dev.mysql.com/doc/refman/8.0/en/optimizer-hints.html">Hints</a>
</p>


<div id="org3c3ffdf" class="figure">
<p><img src="../static/image/2023/0223/205348.png" alt="205348.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 1000000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="orgd28ad95">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "1.16"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "p"
      ],
      "key": "p",
      "used_key_parts": [
        "Population"
      ],
      "key_length": "4",
      "rows_examined_per_scan": 2,
      "rows_produced_per_join": 0,
      "filtered": "14.29",
      "index_condition": "(`world`.`country`.`Population` &gt; 1000000000)",
      "cost_info": {
        "read_cost": "1.13",
        "eval_cost": "0.03",
        "prefix_cost": "1.16",
        "data_read_per_join": "276"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "(`world`.`country`.`Continent` = 'Asia')"
    }
  }
}
</pre>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
  <span style="color: #859900;">select</span> <span style="color: #586e75; font-style: italic;">/*+NO_RANGE_OPTIMIZATION(Country) */</span>  * <span style="color: #6c71c4;">from</span> country
  <span style="color: #859900;">where</span> population &gt; 1000000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="org38bdad6">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "25.65"
    },
    "table": {
      "table_name": "country",
      "access_type": "ALL",
      "possible_keys": [
        "p"
      ],
      "rows_examined_per_scan": 239,
      "rows_produced_per_join": 11,
      "filtered": "4.76",
      "cost_info": {
        "read_cost": "24.51",
        "eval_cost": "1.14",
        "prefix_cost": "25.65",
        "data_read_per_join": "10K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "((`world`.`country`.`Continent` = 'Asia') and (`world`.`country`.`Population` &gt; 1000000000))"
    }
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org15653d6" class="outline-3">
<h3 id="org15653d6"><span class="section-number-3">3.4.</span> Index Optimization</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org21ea902" class="outline-4">
<h4 id="org21ea902"><span class="section-number-4">3.4.1.</span> Comparing Plans</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
添加两个索引: c 洲, p 人口数
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">add</span> <span style="color: #859900;">index</span> c(continent);
<span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">add</span> <span style="color: #859900;">index</span> p(population);
</pre>
</div>

<p>
亚洲 500 万人口的国家
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 5000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="org089fc36">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "10.35"
    },
    "table": {
      "table_name": "country",
      "access_type": "ref",
      "possible_keys": [
        "p",
        "c"
      ],
      "key": "c",
      "used_key_parts": [
        "Continent"
      ],
      "key_length": "1",
      "ref": [
        "const"
      ],
      "rows_examined_per_scan": 51,
      "rows_produced_per_join": 23,
      "filtered": "45.19",
      "index_condition": "(`world`.`country`.`Continent` = 'Asia')",
      "cost_info": {
        "read_cost": "5.25",
        "eval_cost": "2.30",
        "prefix_cost": "10.35",
        "data_read_per_join": "21K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "(`world`.`country`.`Population` &gt; 5000000)"
    }
  }
}
</pre>

<p>
亚洲 5 亿人口的国家
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 500000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="org1cd072e">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "1.16"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "p",
        "c"
      ],
      "key": "p",
      "used_key_parts": [
        "Population"
      ],
      "key_length": "4",
      "rows_examined_per_scan": 2,
      "rows_produced_per_join": 0,
      "filtered": "21.34",
      "index_condition": "(`world`.`country`.`Population` &gt; 500000000)",
      "cost_info": {
        "read_cost": "1.12",
        "eval_cost": "0.04",
        "prefix_cost": "1.16",
        "data_read_per_join": "413"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ],
      "attached_condition": "(`world`.`country`.`Continent` = 'Asia')"
    }
  }
}
</pre>

<p>
查看 Optimization Trace, 可以探测出走什么执行计划
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"steps"</span>: <span style="color: #d8241f;">[</span>
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_preparation"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` where ((`country`.`Population` &gt; 500000000) and (`country`.`Continent` = 'Asia'))"</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_optimization"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"condition_processing"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"condition"</span>: <span style="color: #2aa198;">"WHERE"</span>,
              <span style="color: #859900;">"original_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 500000000) and (`country`.`Continent` = 'Asia'))"</span>,
              <span style="color: #859900;">"steps"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"equality_propagation"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 500000000) and multiple equal('Asia', `country`.`Continent`))"</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"constant_propagation"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 500000000) and multiple equal('Asia', `country`.`Continent`))"</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"trivial_condition_removal"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`country`.`Population` &gt; 500000000) and multiple equal('Asia', `country`.`Continent`))"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"substitute_generated_columns"</span>: <span style="color: #00bed1;">{}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"table_dependencies"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"row_may_be_null"</span>: <span style="color: #268bd2;">false</span>,
                <span style="color: #859900;">"map_bit"</span>: <span style="color: #268bd2;">0</span>,
                <span style="color: #859900;">"depends_on_map_bits"</span>: <span style="color: #e574c3;">[]</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"ref_optimizer_key_uses"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"field"</span>: <span style="color: #2aa198;">"Continent"</span>,
                <span style="color: #859900;">"equals"</span>: <span style="color: #2aa198;">"'Asia'"</span>,
                <span style="color: #859900;">"null_rejecting"</span>: <span style="color: #268bd2;">true</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"rows_estimation"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"range_analysis"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"table_scan"</span>: <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                    <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">27.75</span>
                  <span style="color: #8d5649;">}</span>,
                  <span style="color: #859900;">"potential_range_indexes"</span>: <span style="color: #8d5649;">[</span> // =&gt; &#21487;&#33021;&#20351;&#29992;&#30340;&#32034;&#24341;
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                      <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"not_applicable"</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"p"</span>,
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">true</span>,
                      <span style="color: #859900;">"key_parts"</span>: <span style="color: #9564bf;">[</span>
                        <span style="color: #2aa198;">"Population"</span>,
                        <span style="color: #2aa198;">"Code"</span>
                      <span style="color: #9564bf;">]</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"c"</span>,
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">true</span>,
                      <span style="color: #859900;">"key_parts"</span>: <span style="color: #9564bf;">[</span>
                        <span style="color: #2aa198;">"Continent"</span>,
                        <span style="color: #2aa198;">"Code"</span>
                      <span style="color: #9564bf;">]</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">]</span>,
                  <span style="color: #859900;">"setup_range_conditions"</span>: <span style="color: #8d5649;">[]</span>,
                  <span style="color: #859900;">"group_index_range"</span>: <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>,
                    <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"not_group_by_or_distinct"</span>
                  <span style="color: #8d5649;">}</span>,
                  <span style="color: #859900;">"skip_scan_range"</span>: <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"potential_skip_scan_indexes"</span>: <span style="color: #d8241f;">[</span>
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"p"</span>,
                        <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"query_references_nonkey_column"</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"c"</span>,
                        <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"query_references_nonkey_column"</span>
                      <span style="color: #9564bf;">}</span>
                    <span style="color: #d8241f;">]</span>
                  <span style="color: #8d5649;">}</span>,
                  <span style="color: #859900;">"analyzing_range_alternatives"</span>: <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"range_scan_alternatives"</span>: <span style="color: #d8241f;">[</span>
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"p"</span>, // =&gt; &#20351;&#29992;&#32034;&#24341; p &#30340;&#20195;&#20215; <span style="color: #268bd2;">0.96</span>
                        <span style="color: #859900;">"ranges"</span>: <span style="color: #24a222;">[</span>
                          <span style="color: #2aa198;">"500000000 &lt; Population"</span>
                        <span style="color: #24a222;">]</span>,
                        <span style="color: #859900;">"index_dives_for_eq_ranges"</span>: <span style="color: #268bd2;">true</span>,
                        <span style="color: #859900;">"rowid_ordered"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"using_mrr"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"index_only"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"in_memory"</span>: <span style="color: #268bd2;">1</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">2</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">0.96</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"c"</span>, // =&gt; &#20351;&#29992;&#32034;&#24341; c &#30340;&#20195;&#20215; <span style="color: #268bd2;">18.11</span>
                        <span style="color: #859900;">"ranges"</span>: <span style="color: #24a222;">[</span>
                          <span style="color: #2aa198;">"Continent = 'Asia'"</span>
                        <span style="color: #24a222;">]</span>,
                        <span style="color: #859900;">"index_dives_for_eq_ranges"</span>: <span style="color: #268bd2;">true</span>,
                        <span style="color: #859900;">"rowid_ordered"</span>: <span style="color: #268bd2;">true</span>,
                        <span style="color: #859900;">"using_mrr"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"index_only"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"in_memory"</span>: <span style="color: #268bd2;">1</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">51</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">18.11</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"cost"</span>
                      <span style="color: #9564bf;">}</span>
                    <span style="color: #d8241f;">]</span>,
                    <span style="color: #859900;">"analyzing_roworder_intersect"</span>: <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                      <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"too_few_roworder_scans"</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">}</span>,
                  <span style="color: #859900;">"chosen_range_access_summary"</span>: <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"range_access_plan"</span>: <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"type"</span>: <span style="color: #2aa198;">"range_scan"</span>,
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"p"</span>,
                      <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">2</span>,
                      <span style="color: #859900;">"ranges"</span>: <span style="color: #9564bf;">[</span>
                        <span style="color: #2aa198;">"500000000 &lt; Population"</span>
                      <span style="color: #9564bf;">]</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">2</span>,
                    <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">0.96</span>,
                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                  <span style="color: #8d5649;">}</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"considered_execution_plans"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #e574c3;">[]</span>,
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"best_access_path"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #8d5649;">[</span>
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"c"</span>,
                      <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">51</span>,
                      <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">10.35</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">2</span>,
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"range"</span>,
                      <span style="color: #859900;">"range_details"</span>: <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"used_index"</span>: <span style="color: #2aa198;">"p"</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">2</span>,
                      <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">1.16</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">]</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">100</span>,
                <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">2</span>,
                <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">1.16</span>,
                <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"attaching_conditions_to_tables"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"original_condition"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 500000000))"</span>,
              <span style="color: #859900;">"attached_conditions_computation"</span>: <span style="color: #bcbf00;">[]</span>,
              <span style="color: #859900;">"attached_conditions_summary"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                  <span style="color: #859900;">"attached"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 500000000))"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"finalizing_table_conditions"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"original_table_condition"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 500000000))"</span>,
                <span style="color: #859900;">"final_table_condition   "</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`country`.`Population` &gt; 500000000))"</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"refine_plan"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"pushed_index_condition"</span>: <span style="color: #2aa198;">"(`country`.`Population` &gt; 500000000)"</span>,
                <span style="color: #859900;">"table_condition_attached"</span>: <span style="color: #2aa198;">"(`country`.`Continent` = 'Asia')"</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_execution"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">]</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc71d9c6" class="outline-4">
<h4 id="orgc71d9c6"><span class="section-number-4">3.4.2.</span> Composite Indexes</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
添加两个联合索引
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">add</span> <span style="color: #859900;">index</span> c_p(continent, population);
<span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">add</span> <span style="color: #859900;">index</span> p_c(population, continent);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">drop</span> <span style="color: #859900;">index</span> c;
<span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">drop</span> <span style="color: #859900;">index</span> p;
</pre>
</div>

<p>
Cost 值对比
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Index</th>
<th scope="col" class="org-right">Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">p<sub>c</sub></td>
<td class="org-right">48.86</td>
</tr>

<tr>
<td class="org-left">c<sub>p</sub></td>
<td class="org-right">14.66</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">force</span> <span style="color: #859900;">index</span>(p_c) <span style="color: #859900;">where</span> population &gt; 5000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="org155454b">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "48.86"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "p_c"
      ],
      "key": "p_c",
      "used_key_parts": [
        "Population"
      ],
      "key_length": "4",
      "rows_examined_per_scan": 108,
      "rows_produced_per_join": 15,
      "filtered": "14.29",
      "index_condition": "((`world`.`country`.`Continent` = 'Asia') and (`world`.`country`.`Population` &gt; 5000000))",
      "cost_info": {
        "read_cost": "47.32",
        "eval_cost": "1.54",
        "prefix_cost": "48.86",
        "data_read_per_join": "14K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ]
    }
  }
}
</pre>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 5000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="org7302396">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "14.66"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "c_p",
        "p_c"
      ],
      "key": "c_p",
      "used_key_parts": [
        "Continent",
        "Population"
      ],
      "key_length": "5",
      "rows_examined_per_scan": 32,
      "rows_produced_per_join": 32,
      "filtered": "100.00",
      "index_condition": "((`world`.`country`.`Continent` = 'Asia') and (`world`.`country`.`Population` &gt; 5000000))",
      "cost_info": {
        "read_cost": "11.46",
        "eval_cost": "3.20",
        "prefix_cost": "14.66",
        "data_read_per_join": "30K"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ]
    }
  }
}
</pre>

<p>
下面总结了一些常见的索引优化原则
</p>
<ol class="org-ol">
<li>Left most rule. An index on (First Name, Last Name) can be used to also
satisfy queries that need an index on (First Name), but not on queries that
require an index on (Last Name). Try and design composite indexes in such a
way that they can be reused by the greatest number of queries possible.</li>
<li>Ranges to the right. An index on (Age, First Name) can not be used to satisfy
a query in the form of WHERE age BETWEEN x and y AND first<sub>name</sub> = 'John'. Or
to state more specifically: the rest of the composite index will not be used
after the first range condition.</li>
<li>Most selective columns to the left. Think about how you can eliminate work in
the index as fast as possible. This usually has the effect of improving
memory fit because fewer index pages need to be accessed.</li>
<li>Be careful changing index order. Mixing ASC or DESC may affect how much of a
composite index can be used.</li>
</ol>
</div>
</div>

<div id="outline-container-org5bc0a37" class="outline-4">
<h4 id="org5bc0a37"><span class="section-number-4">3.4.3.</span> Covering Indexes</h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
添加 (洲, 人口数, 名称) 联合索引
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">country</span> <span style="color: #859900;">add</span> <span style="color: #859900;">index</span> c_p_n(continent, population, <span style="color: #859900;">name</span>);
</pre>
</div>

<p>
添加索引前
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> <span style="color: #859900;">name</span> <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 5000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="orgcf2882f">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "14.66"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "c_p",
        "p_c"
      ],
      "key": "c_p",
      "used_key_parts": [
        "Continent",
        "Population"
      ],
      "key_length": "5",
      "rows_examined_per_scan": 32,
      "rows_produced_per_join": 32,
      "filtered": "100.00",
      "index_condition": "((`world`.`country`.`Continent` = 'Asia') and (`world`.`country`.`Population` &gt; 5000000))",
      "cost_info": {
        "read_cost": "11.46",
        "eval_cost": "3.20",
        "prefix_cost": "14.66",
        "data_read_per_join": "30K"
      },
      "used_columns": [
        "Name",
        "Continent",
        "Population"
      ]
    }
  }
}
</pre>

<p>
添加 c<sub>p</sub><sub>n</sub> 索引后
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> <span style="color: #859900;">name</span> <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> population &gt; 5000000 <span style="color: #859900;">and</span> continent=<span style="color: #2aa198;">'Asia'</span>\G
</pre>
</div>

<pre class="example" id="orgd9cd518">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "6.87"
    },
    "table": {
      "table_name": "country",
      "access_type": "range",
      "possible_keys": [
        "c_p",
        "p_c",
        "c_p_n"
      ],
      "key": "c_p_n",
      "used_key_parts": [
        "Continent",
        "Population"
      ],
      "key_length": "5",
      "rows_examined_per_scan": 32,
      "rows_produced_per_join": 32,
      "filtered": "100.00",
      "using_index": true, // =&gt; 表示使用覆盖索引
      "cost_info": {
        "read_cost": "3.67",
        "eval_cost": "3.20",
        "prefix_cost": "6.87",
        "data_read_per_join": "30K"
      },
      "used_columns": [
        "Name",
        "Continent",
        "Population"
      ],
      "attached_condition": "((`world`.`country`.`Continent` = 'Asia') and (`world`.`country`.`Population` &gt; 5000000))"
    }
  }
}
</pre>
</div>
</div>

<div id="outline-container-orga11c9bf" class="outline-4">
<h4 id="orga11c9bf"><span class="section-number-4">3.4.4.</span> Transient Plans</h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
通常执行计划会收到数据不同而变化，所以我们对于执行计划需要往往需要根据实际情形进行分析
</p>

<p>
下面举一个例子，更加不同条件产生的 cost 值统计表如下：
<img src="../static/image/2023/0223/235710.png" alt="235710.png" />
</p>

<p>
同时即使固定一个值，不同索引执行的 Cost 也可能是不一样的
<img src="../static/image/2023/0224/000023.png" alt="000023.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org0890fc1" class="outline-3">
<h3 id="org0890fc1"><span class="section-number-3">3.5.</span> Subqueries</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-org823f5e1" class="outline-4">
<h4 id="org823f5e1"><span class="section-number-4">3.5.1.</span> Scalar Subquery</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
Scalar Subquery 指只返回一条数据的子查询，这种查询通常可以被优化成缓存
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> code = (<span style="color: #859900;">select</span> countrycode <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> <span style="color: #859900;">name</span>=<span style="color: #2aa198;">'Toronto'</span>)\G
</pre>
</div>

<pre class="example" id="orgbc778ff">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "1.00"
    },
    "table": {
      "table_name": "country",
      "access_type": "const",
      "possible_keys": [
        "PRIMARY"
      ],
      "key": "PRIMARY",
      "used_key_parts": [
        "Code"
      ],
      "key_length": "12",
      "ref": [
        "const"
      ],
      "rows_examined_per_scan": 1,
      "rows_produced_per_join": 1,
      "filtered": "100.00",
      "cost_info": {
        "read_cost": "0.00",
        "eval_cost": "0.10",
        "prefix_cost": "0.00",
        "data_read_per_join": "968"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ]
    },
    "optimized_away_subqueries": [
      {
        "dependent": false,
        "cacheable": true,
        "query_block": {
          "select_id": 2,
          "cost_info": {
            "query_cost": "410.85"
          },
          "table": {
            "table_name": "city",
            "access_type": "ALL", // =&gt; city 全表扫描
            "rows_examined_per_scan": 4046,
            "rows_produced_per_join": 404,
            "filtered": "10.00",
            "cost_info": {
              "read_cost": "370.39",
              "eval_cost": "40.46",
              "prefix_cost": "410.85",
              "data_read_per_join": "97K"
            },
            "used_columns": [
              "Name",
              "CountryCode"
            ],
            "attached_condition": "(`world`.`city`.`Name` = 'Toronto')"
          }
        }
      }
    ]
  }
}
</pre>

<p>
添加一个索引来改善标量查询
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">alter</span> <span style="color: #859900;">table</span> <span style="color: #b58900;">city</span> <span style="color: #859900;">add</span> <span style="color: #859900;">index</span> n(<span style="color: #859900;">name</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> code = (<span style="color: #859900;">select</span> countrycode <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> <span style="color: #859900;">name</span>=<span style="color: #2aa198;">'Toronto'</span>)\G
</pre>
</div>

<pre class="example" id="orga29629b">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "1.00"
    },
    "table": {
      "table_name": "country",
      "access_type": "const",
      "possible_keys": [
        "PRIMARY"
      ],
      "key": "PRIMARY",
      "used_key_parts": [
        "Code"
      ],
      "key_length": "12",
      "ref": [
        "const"
      ],
      "rows_examined_per_scan": 1,
      "rows_produced_per_join": 1,
      "filtered": "100.00",
      "cost_info": {
        "read_cost": "0.00",
        "eval_cost": "0.10",
        "prefix_cost": "0.00",
        "data_read_per_join": "968"
      },
      "used_columns": [
        "Code",
        "Name",
        "Continent",
        "Region",
        "SurfaceArea",
        "IndepYear",
        "Population",
        "LifeExpectancy",
        "GNP",
        "GNPOld",
        "LocalName",
        "GovernmentForm",
        "HeadOfState",
        "Capital",
        "Code2"
      ]
    },
    "optimized_away_subqueries": [
      {
        "dependent": false,
        "cacheable": true,
        "query_block": {
          "select_id": 2,
          "cost_info": {
            "query_cost": "0.35"
          },
          "table": {
            "table_name": "city",
            "access_type": "ref", // 添加索引后，全表扫描优化成了走索引
            "possible_keys": [
              "n"
            ],
            "key": "n",
            "used_key_parts": [
              "Name"
            ],
            "key_length": "140",
            "ref": [
              "const"
            ],
            "rows_examined_per_scan": 1,
            "rows_produced_per_join": 1,
            "filtered": "100.00",
            "index_condition": "(`world`.`city`.`Name` = 'Toronto')",
            "cost_info": {
              "read_cost": "0.25",
              "eval_cost": "0.10",
              "prefix_cost": "0.35",
              "data_read_per_join": "248"
            },
            "used_columns": [
              "Name",
              "CountryCode"
            ]
          }
        }
      }
    ]
  }
}
</pre>
</div>
</div>
<div id="outline-container-org7ed577f" class="outline-4">
<h4 id="org7ed577f"><span class="section-number-4">3.5.2.</span> IN Subquery (Unique)</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
code 是 country 表的唯一索引
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> countrycode <span style="color: #859900;">in</span> (<span style="color: #859900;">select</span> code <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent = <span style="color: #2aa198;">'Asia'</span>)\G
</pre>
</div>

<pre class="example" id="org6b36dc1">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "316.67"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "country",
          "access_type": "ref",
          "possible_keys": [
            "PRIMARY",
            "c"
          ],
          "key": "c", // =&gt; 走 c 索引
          "used_key_parts": [
            "Continent"
          ],
          "key_length": "1",
          "ref": [
            "const"
          ],
          "rows_examined_per_scan": 51,
          "rows_produced_per_join": 51,
          "filtered": "100.00",
          "using_index": true, // =&gt; 索引覆盖
          "cost_info": {
            "read_cost": "0.27",
            "eval_cost": "5.10",
            "prefix_cost": "5.37",
            "data_read_per_join": "48K"
          },
          "used_columns": [
            "Code",
            "Continent"
          ],
          "attached_condition": "(`world`.`country`.`Continent` = 'Asia')"
        }
      },
      {
        "table": {
          "table_name": "city",
          "access_type": "ref",
          "possible_keys": [
            "CountryCode"
          ],
          "key": "CountryCode",
          "used_key_parts": [
            "CountryCode"
          ],
          "key_length": "12",
          "ref": [
            "world.country.Code"
          ],
          "rows_examined_per_scan": 17,
          "rows_produced_per_join": 889,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "222.36",
            "eval_cost": "88.94",
            "prefix_cost": "316.67",
            "data_read_per_join": "215K"
          },
          "used_columns": [
            "ID",
            "Name",
            "CountryCode",
            "District",
            "Population"
          ]
        }
      }
    ]
  }
}
</pre>

<p>
上述的子查询会有如下几步的转化
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #859900;">"join_preparation"</span>: <span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
  <span style="color: #859900;">"steps"</span>: <span style="color: #d8241f;">[</span>
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_preparation"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#2 */ select `country`.`Code` from `country` where (`country`.`Continent` = 'Asia')"</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `city`.`ID` AS `ID`,`city`.`Name` AS `Name`,`city`.`CountryCode` AS `CountryCode`,`city`.`District` AS `District`,`city`.`Population` AS `Population` from `city` where `city`.`CountryCode` in (/* select#2 */ select `country`.`Code` from `country` where (`country`.`Continent` = 'Asia'))"</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"transformation"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
        <span style="color: #859900;">"from"</span>: <span style="color: #2aa198;">"IN (SELECT)"</span>,
        <span style="color: #859900;">"to"</span>: <span style="color: #2aa198;">"semijoin"</span>,
        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>,
        <span style="color: #859900;">"transformation_to_semi_join"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"subquery_predicate"</span>: <span style="color: #2aa198;">"`city`.`CountryCode` in (/* select#2 */ select `country`.`Code` from `country` where (`country`.`Continent` = 'Asia'))"</span>,
          <span style="color: #859900;">"embedded in"</span>: <span style="color: #2aa198;">"WHERE"</span>,
          <span style="color: #859900;">"evaluating_constant_semijoin_conditions"</span>: <span style="color: #1776b6;">[</span>
          <span style="color: #1776b6;">]</span>,
          <span style="color: #859900;">"semi-join condition"</span>: <span style="color: #2aa198;">"((`country`.`Continent` = 'Asia') and (`city`.`CountryCode` = `country`.`Code`))"</span>,
          <span style="color: #859900;">"decorrelated_predicates"</span>: <span style="color: #1776b6;">[</span>
            <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"outer"</span>: <span style="color: #2aa198;">"`city`.`CountryCode`"</span>,
              <span style="color: #859900;">"inner"</span>: <span style="color: #2aa198;">"`country`.`Code`"</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">]</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"transformations_to_nested_joins"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"transformations"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #2aa198;">"semijoin"</span>
        <span style="color: #ff7f00;">]</span>,
        <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `city`.`ID` AS `ID`,`city`.`Name` AS `Name`,`city`.`CountryCode` AS `CountryCode`,`city`.`District` AS `District`,`city`.`Population` AS `Population` from `city` semi join (`country`) where ((`country`.`Continent` = 'Asia') and (`city`.`CountryCode` = `country`.`Code`))"</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">]</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
最终转化成 <code>semi-join</code>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #586e75; font-style: italic;">/* select#1 */</span>
<span style="color: #859900;">select</span>
  `city`.`ID` <span style="color: #859900;">as</span> `ID`,
  `city`.`<span style="color: #859900;">Name</span>` <span style="color: #859900;">as</span> `<span style="color: #859900;">Name</span>`,
  `city`.`CountryCode` <span style="color: #859900;">as</span> `CountryCode`,
  `city`.`District` <span style="color: #859900;">as</span> `District`,
  `city`.`Population` <span style="color: #859900;">as</span> `Population`
<span style="color: #6c71c4;">from</span>
  `city` semi <span style="color: #859900;">join</span> (`country`)
<span style="color: #859900;">where</span> ((`country`.`Continent` = <span style="color: #2aa198;">'Asia'</span>)
  <span style="color: #859900;">and</span> (`city`.`CountryCode` = `country`.`Code`));
</pre>
</div>
</div>
</div>

<div id="outline-container-org459311b" class="outline-4">
<h4 id="org459311b"><span class="section-number-4">3.5.3.</span> IN Subquery (Non-Unique)</h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
国家的官方语言可能不止一种
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> code <span style="color: #859900;">in</span> (<span style="color: #859900;">select</span> countrycode <span style="color: #6c71c4;">from</span> countrylanguage <span style="color: #859900;">where</span> isofficial=1)\G
</pre>
</div>

<pre class="example" id="org9a968a1">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "186.54"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "country",
          "access_type": "ALL",
          "possible_keys": [
            "PRIMARY"
          ],
          "rows_examined_per_scan": 239,
          "rows_produced_per_join": 239,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "1.75",
            "eval_cost": "23.90",
            "prefix_cost": "25.65",
            "data_read_per_join": "225K"
          },
          "used_columns": [
            "Code",
            "Name",
            "Continent",
            "Region",
            "SurfaceArea",
            "IndepYear",
            "Population",
            "LifeExpectancy",
            "GNP",
            "GNPOld",
            "LocalName",
            "GovernmentForm",
            "HeadOfState",
            "Capital",
            "Code2"
          ]
        }
      },
      {
        "table": {
          "table_name": "countrylanguage",
          "access_type": "ref",
          "possible_keys": [
            "PRIMARY",
            "CountryCode"
          ],
          "key": "PRIMARY",
          "used_key_parts": [
            "CountryCode"
          ],
          "key_length": "12",
          "ref": [
            "world.country.Code"
          ],
          "rows_examined_per_scan": 4,
          "rows_produced_per_join": 239,
          "filtered": "50.00",
          "first_match": "country",
          "cost_info": {
            "read_cost": "59.96",
            "eval_cost": "23.90",
            "prefix_cost": "186.54",
            "data_read_per_join": "33K"
          },
          "used_columns": [
            "CountryCode",
            "IsOfficial"
          ],
          "attached_condition": "(`world`.`countrylanguage`.`IsOfficial` = 1)"
        }
      }
    ]
  }
}
</pre>

<p>
查看一下 Trace 日志
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"steps"</span>: <span style="color: #d8241f;">[</span>
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_preparation"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"join_preparation"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
              <span style="color: #859900;">"steps"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#2 */ select `countrylanguage`.`CountryCode` from `countrylanguage` where (`countrylanguage`.`IsOfficial` = 1)"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` where `country`.`Code` in (/* select#2 */ select `countrylanguage`.`CountryCode` from `countrylanguage` where (`countrylanguage`.`IsOfficial` = 1))"</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"transformation"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">2</span>,
              <span style="color: #859900;">"from"</span>: <span style="color: #2aa198;">"IN (SELECT)"</span>,
              <span style="color: #859900;">"to"</span>: <span style="color: #2aa198;">"semijoin"</span>,
              <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>,
              <span style="color: #859900;">"transformation_to_semi_join"</span>: <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"subquery_predicate"</span>: <span style="color: #2aa198;">"`country`.`Code` in (/* select#2 */ select `countrylanguage`.`CountryCode` from `countrylanguage` where (`countrylanguage`.`IsOfficial` = 1))"</span>,
                <span style="color: #859900;">"embedded in"</span>: <span style="color: #2aa198;">"WHERE"</span>,
                <span style="color: #859900;">"evaluating_constant_semijoin_conditions"</span>: <span style="color: #e574c3;">[]</span>,
                <span style="color: #859900;">"semi-join condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`IsOfficial` = 1) and (`country`.`Code` = `countrylanguage`.`CountryCode`))"</span>,
                <span style="color: #859900;">"decorrelated_predicates"</span>: <span style="color: #e574c3;">[</span>
                  <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"outer"</span>: <span style="color: #2aa198;">"`country`.`Code`"</span>,
                    <span style="color: #859900;">"inner"</span>: <span style="color: #2aa198;">"`countrylanguage`.`CountryCode`"</span>
                  <span style="color: #8d5649;">}</span>
                <span style="color: #e574c3;">]</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"transformations_to_nested_joins"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"transformations"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #2aa198;">"semijoin"</span>
              <span style="color: #bcbf00;">]</span>,
              <span style="color: #859900;">"expanded_query"</span>: <span style="color: #2aa198;">"/* select#1 */ select `country`.`Code` AS `Code`,`country`.`Name` AS `Name`,`country`.`Continent` AS `Continent`,`country`.`Region` AS `Region`,`country`.`SurfaceArea` AS `SurfaceArea`,`country`.`IndepYear` AS `IndepYear`,`country`.`Population` AS `Population`,`country`.`LifeExpectancy` AS `LifeExpectancy`,`country`.`GNP` AS `GNP`,`country`.`GNPOld` AS `GNPOld`,`country`.`LocalName` AS `LocalName`,`country`.`GovernmentForm` AS `GovernmentForm`,`country`.`HeadOfState` AS `HeadOfState`,`country`.`Capital` AS `Capital`,`country`.`Code2` AS `Code2` from `country` semi join (`countrylanguage`) where ((`countrylanguage`.`IsOfficial` = 1) and (`country`.`Code` = `countrylanguage`.`CountryCode`))"</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_optimization"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[</span>
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"condition_processing"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"condition"</span>: <span style="color: #2aa198;">"WHERE"</span>,
              <span style="color: #859900;">"original_condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`IsOfficial` = 1) and (`country`.`Code` = `countrylanguage`.`CountryCode`))"</span>,
              <span style="color: #859900;">"steps"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"equality_propagation"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`IsOfficial` = 1) and multiple equal(`country`.`Code`, `countrylanguage`.`CountryCode`))"</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"constant_propagation"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`IsOfficial` = 1) and multiple equal(`country`.`Code`, `countrylanguage`.`CountryCode`))"</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"transformation"</span>: <span style="color: #2aa198;">"trivial_condition_removal"</span>,
                  <span style="color: #859900;">"resulting_condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`IsOfficial` = 1) and multiple equal(`country`.`Code`, `countrylanguage`.`CountryCode`))"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"substitute_generated_columns"</span>: <span style="color: #00bed1;">{}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"table_dependencies"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"row_may_be_null"</span>: <span style="color: #268bd2;">false</span>,
                <span style="color: #859900;">"map_bit"</span>: <span style="color: #268bd2;">0</span>,
                <span style="color: #859900;">"depends_on_map_bits"</span>: <span style="color: #e574c3;">[]</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                <span style="color: #859900;">"row_may_be_null"</span>: <span style="color: #268bd2;">false</span>,
                <span style="color: #859900;">"map_bit"</span>: <span style="color: #268bd2;">1</span>,
                <span style="color: #859900;">"depends_on_map_bits"</span>: <span style="color: #e574c3;">[]</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"ref_optimizer_key_uses"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"field"</span>: <span style="color: #2aa198;">"Code"</span>,
                <span style="color: #859900;">"equals"</span>: <span style="color: #2aa198;">"`countrylanguage`.`CountryCode`"</span>,
                <span style="color: #859900;">"null_rejecting"</span>: <span style="color: #268bd2;">true</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                <span style="color: #859900;">"field"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                <span style="color: #859900;">"equals"</span>: <span style="color: #2aa198;">"`country`.`Code`"</span>,
                <span style="color: #859900;">"null_rejecting"</span>: <span style="color: #268bd2;">true</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                <span style="color: #859900;">"field"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                <span style="color: #859900;">"equals"</span>: <span style="color: #2aa198;">"`country`.`Code`"</span>,
                <span style="color: #859900;">"null_rejecting"</span>: <span style="color: #268bd2;">true</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"pulled_out_semijoin_tables"</span>: <span style="color: #00bed1;">[]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"rows_estimation"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"table_scan"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                  <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">1.75</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                <span style="color: #859900;">"table_scan"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">984</span>,
                  <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">1.5</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"execution_plan_for_potential_materialization"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"steps"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"considered_execution_plans"</span>: <span style="color: #8d5649;">[</span>
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #9564bf;">[]</span>,
                      <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                      <span style="color: #859900;">"best_access_path"</span>: <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #24a222;">[</span>
                          <span style="color: #ff7f00;">{</span>
                            <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                            <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                            <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                            <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                          <span style="color: #ff7f00;">}</span>,
                          <span style="color: #ff7f00;">{</span>
                            <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                            <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                            <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                            <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                          <span style="color: #ff7f00;">}</span>,
                          <span style="color: #ff7f00;">{</span>
                            <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">984</span>,
                            <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #1776b6;">[]</span>,
                            <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">0.5</span>,
                            <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                            <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">492</span>,
                            <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">99.9</span>,
                            <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                          <span style="color: #ff7f00;">}</span>
                        <span style="color: #24a222;">]</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">100</span>,
                      <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">492</span>,
                      <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">99.9</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">]</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"considered_execution_plans"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #e574c3;">[]</span>,
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                <span style="color: #859900;">"best_access_path"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #8d5649;">[</span>
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">239</span>,
                      <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #9564bf;">[]</span>,
                      <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">1</span>,
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                      <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">239</span>,
                      <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">25.65</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">]</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">100</span>,
                <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">239</span>,
                <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">25.65</span>,
                <span style="color: #859900;">"semijoin_strategy_choice"</span>: <span style="color: #e574c3;">[]</span>,
                <span style="color: #859900;">"rest_of_plan"</span>: <span style="color: #e574c3;">[</span>
                  <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #d8241f;">[</span>
                      <span style="color: #2aa198;">"`country`"</span>
                    <span style="color: #d8241f;">]</span>,
                    <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                    <span style="color: #859900;">"best_access_path"</span>: <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #9564bf;">[</span>
                        <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                          <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                          <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">4.22318</span>,
                          <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">160.894</span>,
                          <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                        <span style="color: #24a222;">}</span>,
                        <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                          <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                          <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">4.22318</span>,
                          <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">353.269</span>,
                          <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                        <span style="color: #24a222;">}</span>,
                        <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">984</span>,
                          <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #ff7f00;">[]</span>,
                          <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">0.5</span>,
                          <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                          <span style="color: #859900;">"using_join_cache"</span>: <span style="color: #268bd2;">true</span>,
                          <span style="color: #859900;">"buffers_needed"</span>: <span style="color: #268bd2;">1</span>,
                          <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">492</span>,
                          <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">11853.9</span>,
                          <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                        <span style="color: #24a222;">}</span>
                      <span style="color: #9564bf;">]</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">50</span>,
                    <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">504.67</span>,
                    <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">186.544</span>,
                    <span style="color: #859900;">"semijoin_strategy_choice"</span>: <span style="color: #d8241f;">[</span>
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"FirstMatch"</span>,
                        <span style="color: #859900;">"recalculate_access_paths_and_cost"</span>: <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"tables"</span>: <span style="color: #ff7f00;">[]</span>
                        <span style="color: #24a222;">}</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">186.544</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"MaterializeLookup"</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">199.65</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                        <span style="color: #859900;">"duplicate_tables_left"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"DuplicatesWeedout"</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">261.911</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                        <span style="color: #859900;">"duplicate_tables_left"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                      <span style="color: #9564bf;">}</span>
                    <span style="color: #d8241f;">]</span>,
                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                  <span style="color: #8d5649;">}</span>
                <span style="color: #e574c3;">]</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #e574c3;">[]</span>,
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                <span style="color: #859900;">"best_access_path"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #8d5649;">[</span>
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                      <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">984</span>,
                      <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #9564bf;">[]</span>,
                      <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">0.5</span>,
                      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                      <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">492</span>,
                      <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">99.9</span>,
                      <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                    <span style="color: #d8241f;">}</span>
                  <span style="color: #8d5649;">]</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">100</span>,
                <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">492</span>,
                <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">99.9</span>,
                <span style="color: #859900;">"semijoin_strategy_choice"</span>: <span style="color: #e574c3;">[</span>
                  <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"MaterializeScan"</span>,
                    <span style="color: #859900;">"choice"</span>: <span style="color: #2aa198;">"deferred"</span>
                  <span style="color: #8d5649;">}</span>
                <span style="color: #e574c3;">]</span>,
                <span style="color: #859900;">"rest_of_plan"</span>: <span style="color: #e574c3;">[</span>
                  <span style="color: #8d5649;">{</span>
                    <span style="color: #859900;">"plan_prefix"</span>: <span style="color: #d8241f;">[</span>
                      <span style="color: #2aa198;">"`countrylanguage`"</span>
                    <span style="color: #d8241f;">]</span>,
                    <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                    <span style="color: #859900;">"best_access_path"</span>: <span style="color: #d8241f;">{</span>
                      <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #9564bf;">[</span>
                        <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"eq_ref"</span>,
                          <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                          <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">1</span>,
                          <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">172.2</span>,
                          <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>,
                          <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"clustered_pk_chosen_by_heuristics"</span>
                        <span style="color: #24a222;">}</span>,
                        <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">239</span>,
                          <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #ff7f00;">[]</span>,
                          <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">1</span>,
                          <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                          <span style="color: #859900;">"using_join_cache"</span>: <span style="color: #268bd2;">true</span>,
                          <span style="color: #859900;">"buffers_needed"</span>: <span style="color: #268bd2;">1</span>,
                          <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">239</span>,
                          <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">11760.6</span>,
                          <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                        <span style="color: #24a222;">}</span>
                      <span style="color: #9564bf;">]</span>
                    <span style="color: #d8241f;">}</span>,
                    <span style="color: #859900;">"condition_filtering_pct"</span>: <span style="color: #268bd2;">100</span>,
                    <span style="color: #859900;">"rows_for_plan"</span>: <span style="color: #268bd2;">492</span>,
                    <span style="color: #859900;">"cost_for_plan"</span>: <span style="color: #268bd2;">272.1</span>,
                    <span style="color: #859900;">"semijoin_strategy_choice"</span>: <span style="color: #d8241f;">[</span>
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"LooseScan"</span>,
                        <span style="color: #859900;">"recalculate_access_paths_and_cost"</span>: <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"tables"</span>: <span style="color: #ff7f00;">[</span>
                            <span style="color: #1776b6;">{</span>
                              <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                              <span style="color: #859900;">"best_access_path"</span>: <span style="color: #00bed1;">{</span>
                                <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #bcbf00;">[</span>
                                  <span style="color: #e574c3;">{</span>
                                    <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                                    <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                                    <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                                  <span style="color: #e574c3;">}</span>,
                                  <span style="color: #e574c3;">{</span>
                                    <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
                                    <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                                    <span style="color: #859900;">"usable"</span>: <span style="color: #268bd2;">false</span>,
                                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                                  <span style="color: #e574c3;">}</span>,
                                  <span style="color: #e574c3;">{</span>
                                    <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">984</span>,
                                    <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #8d5649;">[]</span>,
                                    <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">0.5</span>,
                                    <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                                    <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">492</span>,
                                    <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">99.9</span>,
                                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                                  <span style="color: #e574c3;">}</span>
                                <span style="color: #bcbf00;">]</span>
                              <span style="color: #00bed1;">}</span>,
                              <span style="color: #859900;">"unknown_key_1"</span>: <span style="color: #00bed1;">{</span>
                                <span style="color: #859900;">"searching_loose_scan_index"</span>: <span style="color: #bcbf00;">{</span>
                                  <span style="color: #859900;">"indexes"</span>: <span style="color: #e574c3;">[</span>
                                    <span style="color: #8d5649;">{</span>
                                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                                      <span style="color: #859900;">"ref_possible"</span>: <span style="color: #268bd2;">false</span>,
                                      <span style="color: #859900;">"covering_scan_possible"</span>: <span style="color: #268bd2;">false</span>
                                    <span style="color: #8d5649;">}</span>,
                                    <span style="color: #8d5649;">{</span>
                                      <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"CountryCode"</span>,
                                      <span style="color: #859900;">"ref_possible"</span>: <span style="color: #268bd2;">false</span>,
                                      <span style="color: #859900;">"covering_scan_possible"</span>: <span style="color: #268bd2;">false</span>
                                    <span style="color: #8d5649;">}</span>
                                  <span style="color: #e574c3;">]</span>
                                <span style="color: #bcbf00;">}</span>
                              <span style="color: #00bed1;">}</span>
                            <span style="color: #1776b6;">}</span>
                          <span style="color: #ff7f00;">]</span>
                        <span style="color: #24a222;">}</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"MaterializeScan"</span>,
                        <span style="color: #859900;">"recalculate_access_paths_and_cost"</span>: <span style="color: #24a222;">{</span>
                          <span style="color: #859900;">"tables"</span>: <span style="color: #ff7f00;">[</span>
                            <span style="color: #1776b6;">{</span>
                              <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                              <span style="color: #859900;">"best_access_path"</span>: <span style="color: #00bed1;">{</span>
                                <span style="color: #859900;">"considered_access_paths"</span>: <span style="color: #bcbf00;">[</span>
                                  <span style="color: #e574c3;">{</span>
                                    <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"eq_ref"</span>,
                                    <span style="color: #859900;">"index"</span>: <span style="color: #2aa198;">"PRIMARY"</span>,
                                    <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">1</span>,
                                    <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">172.2</span>,
                                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>,
                                    <span style="color: #859900;">"cause"</span>: <span style="color: #2aa198;">"clustered_pk_chosen_by_heuristics"</span>
                                  <span style="color: #e574c3;">}</span>,
                                  <span style="color: #e574c3;">{</span>
                                    <span style="color: #859900;">"rows_to_scan"</span>: <span style="color: #268bd2;">239</span>,
                                    <span style="color: #859900;">"filtering_effect"</span>: <span style="color: #8d5649;">[]</span>,
                                    <span style="color: #859900;">"final_filtering_effect"</span>: <span style="color: #268bd2;">1</span>,
                                    <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"scan"</span>,
                                    <span style="color: #859900;">"using_join_cache"</span>: <span style="color: #268bd2;">true</span>,
                                    <span style="color: #859900;">"buffers_needed"</span>: <span style="color: #268bd2;">1</span>,
                                    <span style="color: #859900;">"resulting_rows"</span>: <span style="color: #268bd2;">239</span>,
                                    <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">11760.6</span>,
                                    <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">false</span>
                                  <span style="color: #e574c3;">}</span>
                                <span style="color: #bcbf00;">]</span>
                              <span style="color: #00bed1;">}</span>
                            <span style="color: #1776b6;">}</span>
                          <span style="color: #ff7f00;">]</span>
                        <span style="color: #24a222;">}</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">371.5</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">1</span>,
                        <span style="color: #859900;">"duplicate_tables_left"</span>: <span style="color: #268bd2;">true</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                      <span style="color: #9564bf;">}</span>,
                      <span style="color: #9564bf;">{</span>
                        <span style="color: #859900;">"strategy"</span>: <span style="color: #2aa198;">"DuplicatesWeedout"</span>,
                        <span style="color: #859900;">"cost"</span>: <span style="color: #268bd2;">346.2</span>,
                        <span style="color: #859900;">"rows"</span>: <span style="color: #268bd2;">239</span>,
                        <span style="color: #859900;">"duplicate_tables_left"</span>: <span style="color: #268bd2;">false</span>,
                        <span style="color: #859900;">"chosen"</span>: <span style="color: #268bd2;">true</span>
                      <span style="color: #9564bf;">}</span>
                    <span style="color: #d8241f;">]</span>,
                    <span style="color: #859900;">"pruned_by_cost"</span>: <span style="color: #268bd2;">true</span>
                  <span style="color: #8d5649;">}</span>
                <span style="color: #e574c3;">]</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"final_semijoin_strategy"</span>: <span style="color: #2aa198;">"FirstMatch"</span>, // =&gt; &#26368;&#32456; semi-join &#31574;&#30053;
                <span style="color: #859900;">"recalculate_access_paths_and_cost"</span>: <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"tables"</span>: <span style="color: #8d5649;">[]</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"attaching_conditions_to_tables"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"original_condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`CountryCode` = `country`.`Code`) and (`countrylanguage`.`IsOfficial` = 1))"</span>,
              <span style="color: #859900;">"attached_conditions_computation"</span>: <span style="color: #bcbf00;">[]</span>,
              <span style="color: #859900;">"attached_conditions_summary"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>,
                  <span style="color: #859900;">"attached"</span>: <span style="color: #268bd2;">null</span>
                <span style="color: #e574c3;">}</span>,
                <span style="color: #e574c3;">{</span>
                  <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                  <span style="color: #859900;">"attached"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`CountryCode` = `country`.`Code`) and (`countrylanguage`.`IsOfficial` = 1))"</span>
                <span style="color: #e574c3;">}</span>
              <span style="color: #bcbf00;">]</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"finalizing_table_conditions"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>,
                <span style="color: #859900;">"original_table_condition"</span>: <span style="color: #2aa198;">"((`countrylanguage`.`CountryCode` = `country`.`Code`) and (`countrylanguage`.`IsOfficial` = 1))"</span>,
                <span style="color: #859900;">"final_table_condition   "</span>: <span style="color: #2aa198;">"(`countrylanguage`.`IsOfficial` = 1)"</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"refine_plan"</span>: <span style="color: #00bed1;">[</span>
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`country`"</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"table"</span>: <span style="color: #2aa198;">"`countrylanguage`"</span>
              <span style="color: #bcbf00;">}</span>
            <span style="color: #00bed1;">]</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"join_execution"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"select#"</span>: <span style="color: #268bd2;">1</span>,
        <span style="color: #859900;">"steps"</span>: <span style="color: #ff7f00;">[]</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">]</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
Semi-join 的执行概括来看就是想办法把内层的查询进行去重。在写我们自己的 Semi-join
执行前，我们先学习一下 MySQL 中执行的方式，主要有 4 种，分别是：
</p>

<ol class="org-ol">
<li>DuplicateWeedout，使用临时表针对 join 序列中，join 内表产生的重复部分，做消除
处理；内层子查询的表通过在外层表的 rowid 上建立唯一索引来对重复生成的 country
行数据做去重。</li>
<li>FirstMatch，比较好理解，在选中内部表的第 1 条与外表匹配的记录后，就跳过后续的
匹配过程，从外层表的下一条记录重新开始，从而也达到了去重的目的。</li>
<li>LooseScan，把 inner-tables 中的第一个表，其数据基于索引进行分组，取每组第一条
数据向后做匹配。</li>
<li>Materialize，这个是想法上最直观的，通过将 inner-table 去重，并固化成临时表，
遍历 outer-table，然后在固化表上去寻找匹配。</li>
</ol>
</div>
</div>

<div id="outline-container-orgbf74ecd" class="outline-4">
<h4 id="orgbf74ecd"><span class="section-number-4">3.5.4.</span> NOT IN Subquery</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
NOT IN 子查询通常有两种优化策略：
</p>
<ol class="org-ol">
<li>materialization</li>
<li>exits</li>
</ol>

<p>
这里 code 是 country 的主键
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> countrycode <span style="color: #859900;">not</span> <span style="color: #859900;">in</span> (<span style="color: #859900;">select</span> code <span style="color: #6c71c4;">from</span> country)\G
</pre>
</div>

<pre class="example" id="orgb0b5bec">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "887.80"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "city",
          "access_type": "ALL",
          "rows_examined_per_scan": 4035,
          "rows_produced_per_join": 4035,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "25.00",
            "eval_cost": "403.50",
            "prefix_cost": "428.50",
            "data_read_per_join": "977K"
          },
          "used_columns": [
            "ID",
            "Name",
            "CountryCode",
            "District",
            "Population"
          ]
        }
      },
      {
        "table": {
          "table_name": "&lt;subquery2&gt;",
          "access_type": "eq_ref",
          "key": "&lt;auto_distinct_key&gt;",
          "key_length": "13",
          "ref": [
            "world.city.CountryCode"
          ],
          "rows_examined_per_scan": 1,
          "not_exists": true,
          "attached_condition": "&lt;if&gt;(is_not_null_compl(&lt;subquery2&gt;), &lt;if&gt;(found_match(&lt;subquery2&gt;), false, true), true)",
          "materialized_from_subquery": { // =&gt; 采用 materialized 策略
            "using_temporary_table": true,
            "query_block": {
              "table": {
                "table_name": "country",
                "access_type": "index",
                "possible_keys": [
                  "PRIMARY"
                ],
                "key": "c_p",
                "used_key_parts": [
                  "Continent",
                  "Population"
                ],
                "key_length": "5",
                "rows_examined_per_scan": 239,
                "rows_produced_per_join": 239,
                "filtered": "100.00",
                "using_index": true,
                "cost_info": {
                  "read_cost": "7.00",
                  "eval_cost": "23.90",
                  "prefix_cost": "30.90",
                  "data_read_per_join": "225K"
                },
                "used_columns": [
                  "Code"
                ]
              }
            }
          }
        }
      }
    ]
  }
}
</pre>

<p>
我们可以通过 hints 来强制使用 Exits 策略, 通过查看执行计划
</p>
<ul class="org-ul">
<li>exists<sub>cost</sub>[428.50] &lt; materialize<sub>cost</sub>[887.80]</li>
<li>这里是执行的优化器选取策略有问题的场景</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> countrycode <span style="color: #859900;">not</span> <span style="color: #859900;">in</span> (<span style="color: #859900;">select</span> <span style="color: #586e75; font-style: italic;">/*+ SUBQUERY(INTOEXISTS) */</span> code <span style="color: #6c71c4;">from</span> country)\G
</pre>
</div>

<pre class="example" id="org8948bc0">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "428.50"
    },
    "table": {
      "table_name": "city",
      "access_type": "ALL",
      "rows_examined_per_scan": 4035,
      "rows_produced_per_join": 4035,
      "filtered": "100.00",
      "cost_info": {
        "read_cost": "25.00",
        "eval_cost": "403.50",
        "prefix_cost": "428.50",
        "data_read_per_join": "977K"
      },
      "used_columns": [
        "ID",
        "Name",
        "CountryCode",
        "District",
        "Population"
      ],
      "attached_condition": "&lt;in_optimizer&gt;(`world`.`city`.`CountryCode`,&lt;exists&gt;(&lt;primary_index_lookup&gt;(&lt;cache&gt;(`world`.`city`.`CountryCode`) in country on PRIMARY)) is false)",
      "attached_subqueries": [
        {
          "dependent": true,
          "cacheable": false,
          "query_block": {
            "select_id": 2,
            "cost_info": {
              "query_cost": "1.10"
            },
            "table": {
              "table_name": "country",
              "access_type": "unique_subquery",
              "possible_keys": [
                "PRIMARY"
              ],
              "key": "PRIMARY",
              "used_key_parts": [
                "Code"
              ],
              "key_length": "12",
              "ref": [
                "func"
              ],
              "rows_examined_per_scan": 1,
              "rows_produced_per_join": 1,
              "filtered": "100.00",
              "using_index": true,
              "cost_info": {
                "read_cost": "1.00",
                "eval_cost": "0.10",
                "prefix_cost": "1.10",
                "data_read_per_join": "968"
              },
              "used_columns": [
                "Code"
              ]
            }
          }
        }
      ]
    }
  }
}
</pre>

<p>
如果添加 continent 限制条件, 这种子查询会使用二级索引，通常的策略就是
materialize
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> countrycode <span style="color: #859900;">not</span> <span style="color: #859900;">in</span> (<span style="color: #859900;">select</span> code <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent <span style="color: #859900;">in</span> (<span style="color: #2aa198;">'Asia'</span>, <span style="color: #2aa198;">'Europe'</span>, <span style="color: #2aa198;">'North America'</span>))\G
</pre>
</div>

<pre class="example" id="org1cd8d5f">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "887.80"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "city",
          "access_type": "ALL",
          "rows_examined_per_scan": 4035,
          "rows_produced_per_join": 4035,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "25.00",
            "eval_cost": "403.50",
            "prefix_cost": "428.50",
            "data_read_per_join": "977K"
          },
          "used_columns": [
            "ID",
            "Name",
            "CountryCode",
            "District",
            "Population"
          ]
        }
      },
      {
        "table": {
          "table_name": "&lt;subquery2&gt;",
          "access_type": "eq_ref",
          "key": "&lt;auto_distinct_key&gt;",
          "key_length": "13",
          "ref": [
            "world.city.CountryCode"
          ],
          "rows_examined_per_scan": 1,
          "not_exists": true,
          "attached_condition": "&lt;if&gt;(is_not_null_compl(&lt;subquery2&gt;), &lt;if&gt;(found_match(&lt;subquery2&gt;), false, true), true)",
          "materialized_from_subquery": {
            "using_temporary_table": true,
            "query_block": {
              "table": {
                "table_name": "country",
                "access_type": "index",
                "possible_keys": [
                  "PRIMARY",
                  "c_p"
                ],
                "key": "c_p",
                "used_key_parts": [
                  "Continent",
                  "Population"
                ],
                "key_length": "5",
                "rows_examined_per_scan": 239,
                "rows_produced_per_join": 239,
                "filtered": "100.00",
                "using_index": true,
                "cost_info": {
                  "read_cost": "7.00",
                  "eval_cost": "23.90",
                  "prefix_cost": "30.90",
                  "data_read_per_join": "225K"
                },
                "used_columns": [
                  "Code",
                  "Continent"
                ],
                "attached_condition": "(`world`.`country`.`Continent` in ('Asia','Europe','North America'))"
              }
            }
          }
        }
      }
    ]
  }
}
</pre>
</div>
</div>

<div id="outline-container-org732d7b2" class="outline-4">
<h4 id="org732d7b2"><span class="section-number-4">3.5.5.</span> Derived Table</h4>
<div class="outline-text-4" id="text-3-5-5">
<p>
子查询一般不需要 materialization, MySQL 通常是采用 merge 的策略，和视图合并的策
略有点类似
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
  <span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span>
  country, (<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> countrycode =<span style="color: #2aa198;">'CAN'</span> ) <span style="color: #859900;">as</span> citytmp
  <span style="color: #859900;">where</span> country.code=citytmp.countrycode <span style="color: #859900;">and</span> citytmp.<span style="color: #859900;">name</span> =<span style="color: #2aa198;">'Toronto'</span>\G
</pre>
</div>

<pre class="example" id="org7d9aa4f">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "0.35"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "country",
          "access_type": "const",
          "possible_keys": [
            "PRIMARY"
          ],
          "key": "PRIMARY",
          "used_key_parts": [
            "Code"
          ],
          "key_length": "12",
          "ref": [
            "const"
          ],
          "rows_examined_per_scan": 1,
          "rows_produced_per_join": 1,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "0.00",
            "eval_cost": "0.10",
            "prefix_cost": "0.00",
            "data_read_per_join": "968"
          },
          "used_columns": [
            "Code",
            "Name",
            "Continent",
            "Region",
            "SurfaceArea",
            "IndepYear",
            "Population",
            "LifeExpectancy",
            "GNP",
            "GNPOld",
            "LocalName",
            "GovernmentForm",
            "HeadOfState",
            "Capital",
            "Code2"
          ]
        }
      },
      {
        "table": {
          "table_name": "city", //
          "access_type": "ref", // =&gt; 从这里可以看出使用了 merge 策略
          "possible_keys": [
            "CountryCode",
            "n"
          ],
          "key": "n",
          "used_key_parts": [
            "Name"
          ],
          "key_length": "140",
          "ref": [
            "const"
          ],
          "rows_examined_per_scan": 1,
          "rows_produced_per_join": 0,
          "filtered": "5.00",
          "index_condition": "(`world`.`city`.`Name` = 'Toronto')",
          "cost_info": {
            "read_cost": "0.25",
            "eval_cost": "0.01",
            "prefix_cost": "0.35",
            "data_read_per_join": "12"
          },
          "used_columns": [
            "ID",
            "Name",
            "CountryCode",
            "District",
            "Population"
          ],
          "attached_condition": "(`world`.`city`.`CountryCode` = 'CAN')"
        }
      }
    ]
  }
}
</pre>

<p>
通过下面的配置可以关闭 merge 策略
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">set</span> optimizer_switch=<span style="color: #2aa198;">'derived_merge=off'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">set</span> optimizer_switch=<span style="color: #2aa198;">'derived_merge=off'</span>;
<span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
  <span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span>
  country, (<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> city <span style="color: #859900;">where</span> countrycode =<span style="color: #2aa198;">'CAN'</span> ) <span style="color: #859900;">as</span> citytmp
  <span style="color: #859900;">where</span> country.code=citytmp.countrycode <span style="color: #859900;">and</span> citytmp.<span style="color: #859900;">name</span> =<span style="color: #2aa198;">'Toronto'</span>\G
</pre>
</div>

<pre class="example" id="org87f0bbf">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "4.67"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "citytmp",
          "access_type": "ALL",
          "rows_examined_per_scan": 2,
          "rows_produced_per_join": 2,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "2.52",
            "eval_cost": "0.20",
            "prefix_cost": "2.73",
            "data_read_per_join": "496"
          },
          "used_columns": [
            "ID",
            "Name",
            "CountryCode",
            "District",
            "Population"
          ],
          "materialized_from_subquery": { // =&gt; 这里没有使用 merge 策略，而是使用了 materialized
            "using_temporary_table": true,
            "dependent": false,
            "cacheable": true,
            "query_block": {
              "select_id": 2,
              "cost_info": {
                "query_cost": "0.35"
              },
              "table": {
                "table_name": "city",
                "access_type": "ref",
                "possible_keys": [
                  "CountryCode",
                  "n"
                ],
                "key": "n",
                "used_key_parts": [
                  "Name"
                ],
                "key_length": "140",
                "ref": [
                  "const"
                ],
                "rows_examined_per_scan": 1,
                "rows_produced_per_join": 0,
                "filtered": "5.00",
                "index_condition": "(`world`.`city`.`Name` = 'Toronto')",
                "cost_info": {
                  "read_cost": "0.25",
                  "eval_cost": "0.01",
                  "prefix_cost": "0.35",
                  "data_read_per_join": "12"
                },
                "used_columns": [
                  "ID",
                  "Name",
                  "CountryCode",
                  "District",
                  "Population"
                ],
                "attached_condition": "(`world`.`city`.`CountryCode` = 'CAN')"
              }
            }
          }
        }
      },
      {
        "table": {
          "table_name": "country",
          "access_type": "eq_ref",
          "possible_keys": [
            "PRIMARY"
          ],
          "key": "PRIMARY",
          "used_key_parts": [
            "Code"
          ],
          "key_length": "12",
          "ref": [
            "citytmp.CountryCode"
          ],
          "rows_examined_per_scan": 1,
          "rows_produced_per_join": 2,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "1.75",
            "eval_cost": "0.20",
            "prefix_cost": "4.67",
            "data_read_per_join": "1K"
          },
          "used_columns": [
            "Code",
            "Name",
            "Continent",
            "Region",
            "SurfaceArea",
            "IndepYear",
            "Population",
            "LifeExpectancy",
            "GNP",
            "GNPOld",
            "LocalName",
            "GovernmentForm",
            "HeadOfState",
            "Capital",
            "Code2"
          ]
        }
      }
    ]
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org57c2cd6" class="outline-3">
<h3 id="org57c2cd6"><span class="section-number-3">3.6.</span> CTEs and Views</h3>
<div class="outline-text-3" id="text-3-6">
<ol class="org-ol">
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/create-view.html">View</a> 使用一种把 SQL 保存下来，以便后续使用</li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/with.html">CTE</a> 和 View 类似，只是其生命周期短一些</li>
<li>CTE 和 View 的优化策略类似
<ul class="org-ul">
<li>merge, 将定义视图的表转化到其它查询中，这里有一个技巧，可以在 <code>explain</code> 过后
通过 <code>show warnings</code> 查看转化的 SQL</li>
<li>materialize, 将查询的结果集存入一个临时表，以供后续的查询使用</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> <span style="color: #859900;">view</span> <span style="color: #b58900;">v_country_asia</span> <span style="color: #859900;">as</span> <span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span>;

<span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> v_country_asia <span style="color: #859900;">where</span> <span style="color: #859900;">name</span>=<span style="color: #2aa198;">'China'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"query_block"</span>: <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"select_id"</span>: <span style="color: #268bd2;">1</span>,
    <span style="color: #859900;">"cost_info"</span>: <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"query_cost"</span>: <span style="color: #2aa198;">"23.47"</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #859900;">"table"</span>: <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"table_name"</span>: <span style="color: #2aa198;">"country"</span>,
      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
      <span style="color: #859900;">"possible_keys"</span>: <span style="color: #24a222;">[</span>
        <span style="color: #2aa198;">"c_p"</span>
      <span style="color: #24a222;">]</span>,
      <span style="color: #859900;">"key"</span>: <span style="color: #2aa198;">"c_p"</span>,
      <span style="color: #859900;">"used_key_parts"</span>: <span style="color: #24a222;">[</span>
        <span style="color: #2aa198;">"Continent"</span>
      <span style="color: #24a222;">]</span>,
      <span style="color: #859900;">"key_length"</span>: <span style="color: #2aa198;">"1"</span>,
      <span style="color: #859900;">"ref"</span>: <span style="color: #24a222;">[</span>
        <span style="color: #2aa198;">"const"</span>
      <span style="color: #24a222;">]</span>,
      <span style="color: #859900;">"rows_examined_per_scan"</span>: <span style="color: #268bd2;">51</span>,
      <span style="color: #859900;">"rows_produced_per_join"</span>: <span style="color: #268bd2;">5</span>,
      <span style="color: #859900;">"filtered"</span>: <span style="color: #2aa198;">"10.00"</span>,
      <span style="color: #859900;">"index_condition"</span>: <span style="color: #2aa198;">"(`world`.`country`.`Continent` = 'Asia')"</span>,
      <span style="color: #859900;">"cost_info"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"read_cost"</span>: <span style="color: #2aa198;">"18.38"</span>,
        <span style="color: #859900;">"eval_cost"</span>: <span style="color: #2aa198;">"0.51"</span>,
        <span style="color: #859900;">"prefix_cost"</span>: <span style="color: #2aa198;">"23.48"</span>,
        <span style="color: #859900;">"data_read_per_join"</span>: <span style="color: #2aa198;">"4K"</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #859900;">"used_columns"</span>: <span style="color: #24a222;">[</span>
        <span style="color: #2aa198;">"Code"</span>,
        <span style="color: #2aa198;">"Name"</span>,
        <span style="color: #2aa198;">"Continent"</span>,
        <span style="color: #2aa198;">"Region"</span>,
        <span style="color: #2aa198;">"SurfaceArea"</span>,
        <span style="color: #2aa198;">"IndepYear"</span>,
        <span style="color: #2aa198;">"Population"</span>,
        <span style="color: #2aa198;">"LifeExpectancy"</span>,
        <span style="color: #2aa198;">"GNP"</span>,
        <span style="color: #2aa198;">"GNPOld"</span>,
        <span style="color: #2aa198;">"LocalName"</span>,
        <span style="color: #2aa198;">"GovernmentForm"</span>,
        <span style="color: #2aa198;">"HeadOfState"</span>,
        <span style="color: #2aa198;">"Capital"</span>,
        <span style="color: #2aa198;">"Code2"</span>
      <span style="color: #24a222;">]</span>,
      <span style="color: #859900;">"attached_condition"</span>: <span style="color: #2aa198;">"(`world`.`country`.`Name` = 'China')"</span>
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
通过 <code>show warnings</code> 查询转化后的 SQL 可以看出 View 在查询中被 merge 了
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">select</span>
  `world`.`country`.`Code` <span style="color: #859900;">as</span> `Code`,
  `world`.`country`.`<span style="color: #859900;">Name</span>` <span style="color: #859900;">as</span> `<span style="color: #859900;">Name</span>`,
  `world`.`country`.`Continent` <span style="color: #859900;">as</span> `Continent`,
  `world`.`country`.`Region` <span style="color: #859900;">as</span> `Region`,
  `world`.`country`.`SurfaceArea` <span style="color: #859900;">as</span> `SurfaceArea`,
  `world`.`country`.`IndepYear` <span style="color: #859900;">as</span> `IndepYear`,
  `world`.`country`.`Population` <span style="color: #859900;">as</span> `Population`,
  `world`.`country`.`LifeExpectancy` <span style="color: #859900;">as</span> `LifeExpectancy`,
  `world`.`country`.`GNP` <span style="color: #859900;">as</span> `GNP`,
  `world`.`country`.`GNPOld` <span style="color: #859900;">as</span> `GNPOld`,
  `world`.`country`.`LocalName` <span style="color: #859900;">as</span> `LocalName`,
  `world`.`country`.`GovernmentForm` <span style="color: #859900;">as</span> `GovernmentForm`,
  `world`.`country`.`HeadOfState` <span style="color: #859900;">as</span> `HeadOfState`,
  `world`.`country`.`Capital` <span style="color: #859900;">as</span> `Capital`,
  `world`.`country`.`Code2` <span style="color: #859900;">as</span> `Code2`
<span style="color: #6c71c4;">from</span>
  `world`.`country`
<span style="color: #859900;">where</span> ((`world`.`country`.`Continent` = <span style="color: #2aa198;">'Asia'</span>)
  <span style="color: #859900;">and</span> (`world`.`country`.`<span style="color: #859900;">Name</span>` = <span style="color: #2aa198;">'China'</span>))
</pre>
</div>

<p>
这里也举例说明一种不能被 merge 的场景
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">create</span> <span style="color: #859900;">view</span> <span style="color: #b58900;">v_countrys_per_continent</span> <span style="color: #859900;">as</span> <span style="color: #859900;">select</span> continent, <span style="color: #6c71c4;">count</span>(*) <span style="color: #859900;">as</span> <span style="color: #6c71c4;">count</span> <span style="color: #6c71c4;">from</span> country <span style="color: #859900;">group</span> <span style="color: #859900;">by</span> continent;

<span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span> * <span style="color: #6c71c4;">from</span> v_countrys_per_continent <span style="color: #859900;">where</span> continent=<span style="color: #2aa198;">'Asia'</span>;
</pre>
</div>

<p>
explain 结果
</p>
<div class="org-src-container">
<pre class="src src-json"><span style="color: #8d5649;">{</span>
  <span style="color: #859900;">"query_block"</span>: <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">"select_id"</span>: <span style="color: #268bd2;">1</span>,
    <span style="color: #859900;">"cost_info"</span>: <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"query_cost"</span>: <span style="color: #2aa198;">"1.00"</span>
    <span style="color: #9564bf;">}</span>,
    <span style="color: #859900;">"table"</span>: <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">"table_name"</span>: <span style="color: #2aa198;">"v_countrys_per_continent"</span>,
      <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"system"</span>,
      <span style="color: #859900;">"rows_examined_per_scan"</span>: <span style="color: #268bd2;">1</span>,
      <span style="color: #859900;">"rows_produced_per_join"</span>: <span style="color: #268bd2;">1</span>,
      <span style="color: #859900;">"filtered"</span>: <span style="color: #2aa198;">"100.00"</span>,
      <span style="color: #859900;">"cost_info"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"read_cost"</span>: <span style="color: #2aa198;">"0.00"</span>,
        <span style="color: #859900;">"eval_cost"</span>: <span style="color: #2aa198;">"0.10"</span>,
        <span style="color: #859900;">"prefix_cost"</span>: <span style="color: #2aa198;">"0.00"</span>,
        <span style="color: #859900;">"data_read_per_join"</span>: <span style="color: #2aa198;">"16"</span>
      <span style="color: #24a222;">}</span>,
      <span style="color: #859900;">"used_columns"</span>: <span style="color: #24a222;">[</span>
        <span style="color: #2aa198;">"continent"</span>,
        <span style="color: #2aa198;">"count"</span>
      <span style="color: #24a222;">]</span>,
      <span style="color: #859900;">"materialized_from_subquery"</span>: <span style="color: #24a222;">{</span>
        <span style="color: #859900;">"using_temporary_table"</span>: <span style="color: #268bd2;">true</span>,
        <span style="color: #859900;">"dependent"</span>: <span style="color: #268bd2;">false</span>,
        <span style="color: #859900;">"cacheable"</span>: <span style="color: #268bd2;">true</span>,
        <span style="color: #859900;">"query_block"</span>: <span style="color: #ff7f00;">{</span>
          <span style="color: #859900;">"select_id"</span>: <span style="color: #268bd2;">2</span>,
          <span style="color: #859900;">"cost_info"</span>: <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"query_cost"</span>: <span style="color: #2aa198;">"5.37"</span>
          <span style="color: #1776b6;">}</span>,
          <span style="color: #859900;">"grouping_operation"</span>: <span style="color: #1776b6;">{</span>
            <span style="color: #859900;">"using_filesort"</span>: <span style="color: #268bd2;">false</span>,
            <span style="color: #859900;">"table"</span>: <span style="color: #00bed1;">{</span>
              <span style="color: #859900;">"table_name"</span>: <span style="color: #2aa198;">"country"</span>,
              <span style="color: #859900;">"access_type"</span>: <span style="color: #2aa198;">"ref"</span>,
              <span style="color: #859900;">"possible_keys"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #2aa198;">"c_p"</span>,
                <span style="color: #2aa198;">"p_c"</span>
              <span style="color: #bcbf00;">]</span>,
              <span style="color: #859900;">"key"</span>: <span style="color: #2aa198;">"c_p"</span>,
              <span style="color: #859900;">"used_key_parts"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #2aa198;">"Continent"</span>
              <span style="color: #bcbf00;">]</span>,
              <span style="color: #859900;">"key_length"</span>: <span style="color: #2aa198;">"1"</span>,
              <span style="color: #859900;">"ref"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #2aa198;">"const"</span>
              <span style="color: #bcbf00;">]</span>,
              <span style="color: #859900;">"rows_examined_per_scan"</span>: <span style="color: #268bd2;">51</span>,
              <span style="color: #859900;">"rows_produced_per_join"</span>: <span style="color: #268bd2;">51</span>,
              <span style="color: #859900;">"filtered"</span>: <span style="color: #2aa198;">"100.00"</span>,
              <span style="color: #859900;">"using_index"</span>: <span style="color: #268bd2;">true</span>,
              <span style="color: #859900;">"cost_info"</span>: <span style="color: #bcbf00;">{</span>
                <span style="color: #859900;">"read_cost"</span>: <span style="color: #2aa198;">"0.28"</span>,
                <span style="color: #859900;">"eval_cost"</span>: <span style="color: #2aa198;">"5.10"</span>,
                <span style="color: #859900;">"prefix_cost"</span>: <span style="color: #2aa198;">"5.38"</span>,
                <span style="color: #859900;">"data_read_per_join"</span>: <span style="color: #2aa198;">"48K"</span>
              <span style="color: #bcbf00;">}</span>,
              <span style="color: #859900;">"used_columns"</span>: <span style="color: #bcbf00;">[</span>
                <span style="color: #2aa198;">"Continent"</span>
              <span style="color: #bcbf00;">]</span>,
              <span style="color: #859900;">"attached_condition"</span>: <span style="color: #2aa198;">"(`world`.`country`.`Continent` = 'Asia')"</span>
            <span style="color: #00bed1;">}</span>
          <span style="color: #1776b6;">}</span>
        <span style="color: #ff7f00;">}</span>
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
可以看出这里使用了 materialize 策略, 直接固化结果
</p>
<div class="org-src-container">
<pre class="src src-text">mysql&gt; show warnings\G
*************************** 1. row ***************************
  Level: Note
   Code: 1003
Message: /* select#1 */ select 'Asia' AS `continent`,'51' AS `count` from dual
1 row in set (0.00 sec)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc3857b2" class="outline-3">
<h3 id="orgc3857b2"><span class="section-number-3">3.7.</span> Join</h3>
<div class="outline-text-3" id="text-3-7">
<p>
MySQL 的 Join 使用 <a href="https://dev.mysql.com/doc/refman/8.0/en/nested-loop-joins.html">nested-loop</a> 策略, 以下面 3 个表 Join 的例子
</p>
<ol class="org-ol">
<li>先选定驱动表, 这里是 country</li>
<li>通过过滤条件 <code>`world`.`country`.`Continent` = 'Asia'</code> 选出待查询的数据，接着
再处理被驱动表 city</li>
<li>city 中匹配出的结果集再处理 countrylanguage 表, 最后还会应用过滤条件
<code>`world`.`countrylanguage`.`IsOfficial` = 'T'</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900;">explain</span> <span style="color: #6c71c4;">format</span>=<span style="color: #268bd2;">json</span>
<span style="color: #859900;">select</span>
  country.<span style="color: #859900;">name</span> <span style="color: #859900;">as</span> country,
  city.<span style="color: #859900;">name</span> <span style="color: #859900;">as</span> capital,
  <span style="color: #859900;">language</span>
<span style="color: #6c71c4;">from</span>
  city
  <span style="color: #859900;">inner</span> <span style="color: #859900;">join</span> country <span style="color: #859900;">on</span> country.capital = city.id
  <span style="color: #859900;">inner</span> <span style="color: #859900;">join</span> countrylanguage <span style="color: #859900;">on</span> countrylanguage.countrycode = country.code
<span style="color: #859900;">where</span>
  country.continent = <span style="color: #2aa198;">'Asia'</span>
  <span style="color: #859900;">and</span> countrylanguage.isofficial = <span style="color: #2aa198;">'T'</span>\G
</pre>
</div>

<pre class="example" id="orgc8e7214">
*************************** 1. row ***************************
EXPLAIN: {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "75.66"
    },
    "nested_loop": [
      {
        "table": {
          "table_name": "country",
          "access_type": "ref",
          "possible_keys": [
            "PRIMARY",
            "c_p"
          ],
          "key": "c_p",
          "used_key_parts": [
            "Continent"
          ],
          "key_length": "1",
          "ref": [
            "const"
          ],
          "rows_examined_per_scan": 51,
          "rows_produced_per_join": 51,
          "filtered": "100.00",
          "index_condition": "(`world`.`country`.`Continent` = 'Asia')",
          "cost_info": {
            "read_cost": "18.38",
            "eval_cost": "5.10",
            "prefix_cost": "23.48",
            "data_read_per_join": "48K"
          },
          "used_columns": [
            "Code",
            "Name",
            "Continent",
            "Capital"
          ],
          "attached_condition": "(`world`.`country`.`Capital` is not null)"
        }
      },
      {
        "table": {
          "table_name": "city",
          "access_type": "eq_ref",
          "possible_keys": [
            "PRIMARY"
          ],
          "key": "PRIMARY",
          "used_key_parts": [
            "ID"
          ],
          "key_length": "4",
          "ref": [
            "world.country.Capital"
          ],
          "rows_examined_per_scan": 1,
          "rows_produced_per_join": 51,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "12.75",
            "eval_cost": "5.10",
            "prefix_cost": "41.33",
            "data_read_per_join": "12K"
          },
          "used_columns": [
            "ID",
            "Name"
          ]
        }
      },
      {
        "table": {
          "table_name": "countrylanguage",
          "access_type": "ref",
          "possible_keys": [
            "PRIMARY",
            "CountryCode"
          ],
          "key": "PRIMARY",
          "used_key_parts": [
            "CountryCode"
          ],
          "key_length": "12",
          "ref": [
            "world.country.Code"
          ],
          "rows_examined_per_scan": 4,
          "rows_produced_per_join": 107,
          "filtered": "50.00",
          "cost_info": {
            "read_cost": "12.79",
            "eval_cost": "10.77",
            "prefix_cost": "75.66",
            "data_read_per_join": "15K"
          },
          "used_columns": [
            "CountryCode",
            "Language",
            "IsOfficial"
          ],
          "attached_condition": "(`world`.`countrylanguage`.`IsOfficial` = 'T')"
        }
      }
    ]
  }
}
</pre>

<p>
附录 nested-loop 实现算法
</p>


<div id="org2cd2a4d" class="figure">
<p><img src="../static/image/2023/0225/214200.png" alt="214200.png" />
</p>
</div>

<p>
MySQL 支持以下三种 <a href="https://dev.mysql.com/doc/refman/8.0/en/join.html">Join</a> 类型
</p>
<ul class="org-ul">
<li>INNER JOIN</li>
<li>LEFT JOIN</li>
<li>RIGHT JOIN</li>
</ul>
</div>
</div>

<div id="outline-container-orgf52a45e" class="outline-3">
<h3 id="orgf52a45e"><span class="section-number-3">3.8.</span> Aggregation</h3>
</div>

<div id="outline-container-org3359b7b" class="outline-3">
<h3 id="org3359b7b"><span class="section-number-3">3.9.</span> Sorting</h3>
</div>

<div id="outline-container-org89bc1dc" class="outline-3">
<h3 id="org89bc1dc"><span class="section-number-3">3.10.</span> Partitioning</h3>
</div>

<div id="outline-container-org72da9f1" class="outline-3">
<h3 id="org72da9f1"><span class="section-number-3">3.11.</span> Query Rewrite</h3>
</div>

<div id="outline-container-org2f2e990" class="outline-3">
<h3 id="org2f2e990"><span class="section-number-3">3.12.</span> Invisible Indexes</h3>
</div>

<div id="outline-container-org3c806a7" class="outline-3">
<h3 id="org3c806a7"><span class="section-number-3">3.13.</span> Profiling Queries</h3>
</div>

<div id="outline-container-orgd4cd8fa" class="outline-3">
<h3 id="orgd4cd8fa"><span class="section-number-3">3.14.</span> JSON and Generated Columns</h3>
</div>

<div id="outline-container-orge170297" class="outline-3">
<h3 id="orge170297"><span class="section-number-3">3.15.</span> Character Sets</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2023-02-26 Sun 08:03. Created by Jinghui Hu at 2023-02-22 Wed 11:36.</p>
</div>
</body>
</html>
