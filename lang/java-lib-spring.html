<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-07-30 Tue 11:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring 全家桶</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring 全家桶</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org37b0141">1. Spring Framework</a>
<ul>
<li><a href="#orgac4af4d">1.1. Spring 的特性</a></li>
<li><a href="#orgfdd17b6">1.2. Spring 的优点</a></li>
</ul>
</li>
<li><a href="#org37c931b">2. Spring MVC</a>
<ul>
<li><a href="#org6cce5e6">2.1. Spring MVC 项目包结构</a></li>
</ul>
</li>
<li><a href="#orgf587b65">3. Spring Boot</a>
<ul>
<li><a href="#orgce138e5">3.1. 命令行工具</a></li>
<li><a href="#orgbed5bed">3.2. 编译系统</a>
<ul>
<li><a href="#org79b9b6a">3.2.1. 继承父 starter</a></li>
<li><a href="#org26df4fd">3.2.2. Starters</a></li>
</ul>
</li>
<li><a href="#org71b9aac">3.3. Spring Beans 和依赖注入</a></li>
<li><a href="#org149fa6e">3.4. <code>@SpringBootApplication</code> 标注</a></li>
<li><a href="#org128fb74">3.5. 外部配置</a>
<ul>
<li><a href="#org3b01d1b">3.5.1. <code>@Value</code> 方式配置</a></li>
<li><a href="#org95fa4f6">3.5.2. <code>@ConfigurationProperties</code> 方式配置</a></li>
</ul>
</li>
<li><a href="#org3f4b393">3.6. 日志</a>
<ul>
<li><a href="#orgbef1691">3.6.1. 日志样式</a></li>
<li><a href="#org8a8d133">3.6.2. 控制台输出</a></li>
<li><a href="#orgfb13308">3.6.3. 文件输出</a></li>
<li><a href="#org0cdca98">3.6.4. 日志级别</a></li>
<li><a href="#org06c4641">3.6.5. 日志分组</a></li>
</ul>
</li>
<li><a href="#org5ca7725">3.7. 配置数据库</a>
<ul>
<li><a href="#org8fe6cc3">3.7.1. MySQL</a></li>
<li><a href="#org666df06">3.7.2. PostgreSQL</a></li>
<li><a href="#org5bda7be">3.7.3. Oracle</a></li>
<li><a href="#orgbf90b8e">3.7.4. Tomcat 连接池配置</a></li>
</ul>
</li>
<li><a href="#org06c2f27">3.8. 开发工具</a></li>
</ul>
</li>
<li><a href="#org8af72f8">4. Spring Data</a>
<ul>
<li><a href="#org38725e7">4.1. Spring Data JPA</a></li>
</ul>
</li>
<li><a href="#orgd0f1e58">5. Spring Cloud</a>
<ul>
<li><a href="#org1c0595e">5.1. Spring Cloud Config</a>
<ul>
<li><a href="#org1b4fce0">5.1.1. 配置文件命名格式</a></li>
<li><a href="#org15816d1">5.1.2. Config Server</a></li>
<li><a href="#orga11a750">5.1.3. Config Client</a></li>
</ul>
</li>
<li><a href="#org1f7927e">5.2. Spring Cloud Netflix</a>
<ul>
<li><a href="#orgff83a4b">5.2.1. Eureka</a></li>
<li><a href="#orge8b0b6d">5.2.2. Hystrix</a></li>
<li><a href="#org5fe2652">5.2.3. Zuul</a></li>
<li><a href="#org5c6cc59">5.2.4. Ribbon</a></li>
</ul>
</li>
<li><a href="#org0e45760">5.3. Spring Cloud Gateway</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-org37b0141" class="outline-2">
<h2 id="org37b0141"><span class="section-number-2">1</span> Spring Framework</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://spring.io/projects/spring-framework">Spring Framework</a> 是一个开源框架，是为了解决企业应用程序开发复杂性而创建的。框
架的主要优势之一就是其分层架构，分层架构允许您选择使用哪一个组件，同时为 J2EE
应用程序开发提供集成的框架。
</p>


<div class="figure">
<p><img src="../static/image/2019/07/spring-projects.png" alt="spring-projects.png" />
</p>
</div>
</div>

<div id="outline-container-orgac4af4d" class="outline-3">
<h3 id="orgac4af4d"><span class="section-number-3">1.1</span> Spring 的特性</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>核心技术：依赖注入，事件，资源，i18n，验证，数据绑定，类型转换，SpEL，AOP</li>
<li>测试：模拟对象，TestContext 框架，Spring MVC 测试，WebTestClient。</li>
<li>数据访问：事务，DAO 支持，JDBC，ORM，编组 XML。</li>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc">Spring MVC</a> 和 Spring WebFlux Web 框架</li>
<li>整合：远程处理，JMS，JCA，JMX，电子邮件，任务，调度，缓存。</li>
<li>语言：Kotlin，Groovy，动态语言。</li>
</ul>
</div>
</div>

<div id="outline-container-orgfdd17b6" class="outline-3">
<h3 id="orgfdd17b6"><span class="section-number-3">1.2</span> Spring 的优点</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>轻量级：Spring 在大小和透明性方面绝对属于轻量级的，基础版本的 Spring 框架大
约只有 2MB。</li>
<li>控制反转(IOC)：Spring 使用控制反转技术实现了松耦合。依赖被注入到对象，而不
是创建或寻找依赖对象。</li>
<li>面向切面编程(AOP)： Spring 支持面向切面编程，同时把应用的业务逻辑与系统的服
务分离开来。</li>
<li>容器：Spring 包含并管理应用程序对象的配置及生命周期。</li>
<li>MVC 框架：Spring 的 Web 框架是一个设计优良的 Web MVC 框架，很好的取代了一些
Web 框架。</li>
<li>事务管理：Spring 对下至本地业务上至全局业务(JAT)提供了统一的事务管理接口。</li>
<li>异常处理：Spring 提供一个方便的 API 将特定技术的异常(由 JDBC, Hibernate, 或
JDO 抛出)转化为一致的、Unchecked 异常。</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org37c931b" class="outline-2">
<h2 id="org37c931b"><span class="section-number-2">2</span> Spring MVC</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org6cce5e6" class="outline-3">
<h3 id="org6cce5e6"><span class="section-number-3">2.1</span> Spring MVC 项目包结构</h3>
<div class="outline-text-3" id="text-2-1">

<div class="figure">
<p><img src="../static/image/2019/07/spring-mvc-module.png" alt="spring-mvc-module.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf587b65" class="outline-2">
<h2 id="orgf587b65"><span class="section-number-2">3</span> Spring Boot</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://spring.io/projects/spring-boot/#overview">Spring Boot</a> 是由 Pivotal 团队提供的全新框架，其设计目的是用来简化新 Spring 应
用的初始搭建以及开发过程。该框架使用了特定的方式来进行配置，从而使开发人员不再
需要定义样板化的配置。通过这种方式，Spring Boot 致力于在蓬勃发展的快速应用开发
领域(rapid application development) 成为领导者。Spring Boot 的文档见 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/">html</a> ，源
代码托管于 <a href="https://github.com/spring-projects/spring-boot">GitHub</a> 。
</p>
</div>

<div id="outline-container-orgce138e5" class="outline-3">
<h3 id="orgce138e5"><span class="section-number-3">3.1</span> 命令行工具</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Spring Boot 命令行工具参考 <a href="../tool/springboot-cli.html">cli</a>
</p>
</div>
</div>

<div id="outline-container-orgbed5bed" class="outline-3">
<h3 id="orgbed5bed"><span class="section-number-3">3.2</span> 编译系统</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org79b9b6a" class="outline-4">
<h4 id="org79b9b6a"><span class="section-number-4">3.2.1</span> 继承父 starter</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Spring Boot 项目需要继承的父级 Starter，配置如下：
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">Inherit defaults from Spring Boot </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">parent</span>&gt;
 &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #b58900;">groupId</span>&gt;
 &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-boot-starter-parent&lt;/<span style="color: #b58900;">artifactId</span>&gt;
 &lt;<span style="color: #b58900;">version</span>&gt;2.1.0.RELEASE&lt;/<span style="color: #b58900;">version</span>&gt;
&lt;/<span style="color: #b58900;">parent</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org26df4fd" class="outline-4">
<h4 id="org26df4fd"><span class="section-number-4">3.2.2</span> Starters</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Starters 是 Spring Boot 对其依赖的再打包，官方的 Starter 都是以
<code>spring-boot-starter</code> 开头，并且存放在 <a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-project/spring-boot-starters">spring-boot-starters</a> 中
</p>


<div class="figure">
<p><img src="../static/image/2019/07/spring-boot-starters.png" alt="spring-boot-starters.png" />
</p>
</div>

<ul class="org-ul">
<li><code>spring-boot-starter</code> : Core starter, including auto-configuration support,
logging and YAML</li>
<li><code>spring-boot-starter-activemq</code> : Starter for JMS messaging using Apache
ActiveMQ</li>
<li><code>spring-boot-starter-amqp</code> : Starter for using Spring AMQP and Rabbit MQ</li>
<li><code>spring-boot-starter-aop</code> : Starter for aspect-oriented programming with
Spring AOP and AspectJ</li>
<li><code>spring-boot-starter-cloud-connectors</code> : Starter for using Spring Cloud
Connectors which simplifies connecting to services in cloud platforms like
Cloud Foundry and Heroku</li>
<li><code>spring-boot-starter-data-elasticsearch</code> : Starter for using Elasticsearch
search and analytics engine and Spring Data Elasticsearch</li>
<li><code>spring-boot-starter-data-jpa</code> : Starter for using Spring Data JPA with
Hibernate</li>
<li><code>spring-boot-starter-data-ldap</code> : Starter for using Spring Data LDAP</li>
<li><code>spring-boot-starter-data-mongodb</code> : Starter for using MongoDB
document-oriented database and Spring Data MongoDB</li>
<li><code>spring-boot-starter-data-mongodb-reactive</code> : Starter for using MongoDB
document-oriented database and Spring Data MongoDB Reactive</li>
<li><code>spring-boot-starter-data-neo4j</code> : Starter for using Neo4j graph database
and Spring Data Neo4j</li>
<li><code>spring-boot-starter-data-redis</code> : Starter for using Redis key-value data
store with Spring Data Redis and the Lettuce client</li>
<li><code>spring-boot-starter-data-redis-reactive</code> : Starter for using Redis
key-value data store with Spring Data Redis reactive and the Lettuce client</li>
<li><code>spring-boot-starter-integration</code> : Starter for using Spring Integration</li>
<li><code>spring-boot-starter-json</code> : Starter for reading and writing json</li>
<li><code>spring-boot-starter-oauth2-client</code> : Starter for using Spring Security's
OAuth2/OpenID Connect client features</li>
<li><code>spring-boot-starter-oauth2-resource-server</code> : Starter for using Spring
Security's OAuth2 resource server features</li>
<li><code>spring-boot-starter-quartz</code> : Starter for using the Quartz scheduler</li>
<li><code>spring-boot-starter-security</code> : Starter for using Spring Security</li>
<li><code>spring-boot-starter-test</code> : Starter for testing Spring Boot applications
with libraries including JUnit, Hamcrest and Mockito</li>
<li><code>spring-boot-starter-web</code> : Starter for building web, including RESTful,
applications using Spring MVC. Uses Tomcat as the default embedded
container</li>
<li><code>spring-boot-starter-web-services</code> : Starter for using Spring Web Services</li>
<li><code>spring-boot-starter-webflux</code> : Starter for building WebFlux applications
using Spring Framework's Reactive Web support</li>
<li><code>spring-boot-starter-websocket</code> : Starter for building WebSocket
applications using Spring Framework's WebSocket support</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org71b9aac" class="outline-3">
<h3 id="org71b9aac"><span class="section-number-3">3.3</span> Spring Beans 和依赖注入</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Spring Framework 的相关技术在 Spring Boot 工程中都是支持的，常见的标注如下：
</p>
<ul class="org-ul">
<li><code>@ComponentScan</code> : 查找 Beans</li>
<li><code>@Autowired</code> : 注入的构造器</li>
<li><code>@Component</code> : 组件</li>
<li><code>@Repository</code> : 仓库</li>
<li><code>@Service</code> : 服务</li>
<li><code>@Controller</code> : 控制器</li>
</ul>

<p>
下面是依赖注入的示例
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">package</span> com.example.<span style="color: #268bd2;">service</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">beans</span>.<span style="color: #268bd2;">factory</span>.<span style="color: #268bd2;">annotation</span>.<span style="color: #268bd2;">Autowired</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">stereotype</span>.<span style="color: #268bd2;">Service</span>;

<span style="color: #268bd2;">@Service</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">DatabaseAccountService</span> <span style="color: #859900;">implements</span> <span style="color: #268bd2;">AccountService</span> <span style="color: #8d5649;">{</span>
  <span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">RiskAssessor</span> <span style="color: #6c71c4;">riskAssessor</span>;

  <span style="color: #268bd2;">@Autowired</span>
  <span style="color: #859900;">public</span> <span style="color: #b58900;">DatabaseAccountService</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">RiskAssessor</span> <span style="color: #6c71c4;">riskAssessor</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">this</span>.riskAssessor = riskAssessor;
  <span style="color: #d8241f;">}</span>

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">...</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Service</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">DatabaseAccountService</span> <span style="color: #859900;">implements</span> <span style="color: #268bd2;">AccountService</span> <span style="color: #8d5649;">{</span>
  <span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">RiskAssessor</span> <span style="color: #6c71c4;">riskAssessor</span>;

  <span style="color: #859900;">public</span> <span style="color: #b58900;">DatabaseAccountService</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">RiskAssessor</span> <span style="color: #6c71c4;">riskAssessor</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">this</span>.riskAssessor = riskAssessor;
  <span style="color: #d8241f;">}</span>

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">...</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org149fa6e" class="outline-3">
<h3 id="org149fa6e"><span class="section-number-3">3.4</span> <code>@SpringBootApplication</code> 标注</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Spring Framework 提供了下面的基本标注
</p>
<ul class="org-ul">
<li><code>@EnableAutoConfiguration</code> : 开启自动配置</li>
<li><code>@ComponentScan</code> : 开启自动扫描组件</li>
<li><code>@Configuration</code> : 允许在上下文中注册其它的 Bean 或导入其它的配置类</li>
</ul>

<p>
<code>@SpringBootApplication</code> 相当于同时开启了上面三项配置
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">package</span> com.example.<span style="color: #268bd2;">myapplication</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">boot</span>.<span style="color: #268bd2;">SpringApplication</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">boot</span>.<span style="color: #268bd2;">autoconfigure</span>.<span style="color: #268bd2;">SpringBootApplication</span>;


<span style="color: #268bd2;">@SpringBootApplication</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">same as @Configuration @EnableAutoConfiguration @ComponentScan</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    SpringApplication.run<span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span>, args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org128fb74" class="outline-3">
<h3 id="org128fb74"><span class="section-number-3">3.5</span> 外部配置</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Spring Boot 允许在 web 应用中读取外部配置，方便程序在不同的环境下产生不同行为。
常见的有两种配置方式，两种配置方式对比如下：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Feature</th>
<th scope="col" class="org-left"><code>@ConfigurationProperties</code></th>
<th scope="col" class="org-left"><code>@Value</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Relaxed binding</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Meta-data support</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">SpEL evaluation</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org3b01d1b" class="outline-4">
<h4 id="org3b01d1b"><span class="section-number-4">3.5.1</span> <code>@Value</code> 方式配置</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
直接使用注释的方式即可将配置的值读入 Java Bean 中，示例如下：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Component</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">MyBean</span> <span style="color: #8d5649;">{</span>

  <span style="color: #268bd2;">@Value</span><span style="color: #d8241f;">(</span><span style="color: #2aa198;">"${name}"</span><span style="color: #d8241f;">)</span>
  <span style="color: #859900;">private</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>;

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">...</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org95fa4f6" class="outline-4">
<h4 id="org95fa4f6"><span class="section-number-4">3.5.2</span> <code>@ConfigurationProperties</code> 方式配置</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
该种配置方法比 <code>@Value</code> 更加安全
</p>

<p>
先定义配置项的 Java Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">package</span> com.<span style="color: #268bd2;">example</span>;

<span style="color: #859900;">import</span> <span style="color: #268bd2;">java</span>.<span style="color: #268bd2;">net</span>.<span style="color: #268bd2;">InetAddress</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">java</span>.<span style="color: #268bd2;">util</span>.<span style="color: #268bd2;">ArrayList</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">java</span>.<span style="color: #268bd2;">util</span>.<span style="color: #268bd2;">Collections</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">java</span>.<span style="color: #268bd2;">util</span>.<span style="color: #268bd2;">List</span>;

<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">boot</span>.<span style="color: #268bd2;">context</span>.<span style="color: #268bd2;">properties</span>.<span style="color: #268bd2;">ConfigurationProperties</span>;

<span style="color: #268bd2;">@ConfigurationProperties</span><span style="color: #8d5649;">(</span><span style="color: #2aa198;">"acme"</span><span style="color: #8d5649;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">AcmeProperties</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">private</span> <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">enabled</span>;
  <span style="color: #859900;">private</span> <span style="color: #268bd2;">InetAddress</span> <span style="color: #6c71c4;">remoteAddress</span>;
  <span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Security</span> <span style="color: #6c71c4;">security</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">Security</span><span style="color: #d8241f;">()</span>;

  <span style="color: #859900;">public</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isEnabled</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span> ... <span style="color: #d8241f;">}</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">setEnabled</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">enabled</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span> ... <span style="color: #d8241f;">}</span>

  <span style="color: #859900;">public</span> <span style="color: #268bd2;">InetAddress</span> <span style="color: #b58900;">getRemoteAddress</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span> ... <span style="color: #d8241f;">}</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">setRemoteAddress</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">InetAddress</span> <span style="color: #6c71c4;">remoteAddress</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span> ... <span style="color: #d8241f;">}</span>

  <span style="color: #859900;">public</span> <span style="color: #268bd2;">Security</span> <span style="color: #b58900;">getSecurity</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span> ... <span style="color: #d8241f;">}</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Security</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">private</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">username</span>;
    <span style="color: #859900;">private</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">password</span>;
    <span style="color: #859900;">private</span> <span style="color: #268bd2;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">roles</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;(</span>Collections.singleton<span style="color: #24a222;">(</span><span style="color: #2aa198;">"USER"</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;

    <span style="color: #859900;">public</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">getUsername</span><span style="color: #9564bf;">()</span> <span style="color: #9564bf;">{</span> ... <span style="color: #9564bf;">}</span>
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">setUsername</span><span style="color: #9564bf;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">username</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span> ... <span style="color: #9564bf;">}</span>

    <span style="color: #859900;">public</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">getPassword</span><span style="color: #9564bf;">()</span> <span style="color: #9564bf;">{</span> ... <span style="color: #9564bf;">}</span>
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">setPassword</span><span style="color: #9564bf;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">password</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span> ... <span style="color: #9564bf;">}</span>

    <span style="color: #859900;">public</span> <span style="color: #268bd2;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #b58900;">getRoles</span><span style="color: #9564bf;">()</span> <span style="color: #9564bf;">{</span> ... <span style="color: #9564bf;">}</span>
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">setRoles</span><span style="color: #9564bf;">(</span><span style="color: #268bd2;">List</span><span style="color: #24a222;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #6c71c4;">roles</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span> ... <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
上述的配置类对应于配置文件中的这些配置项
</p>
<ul class="org-ul">
<li><code>acme.enabled</code> 定义一个值，默认为空</li>
<li><code>acme.remote-address</code> 能通过字符串强制转换的类型</li>
<li><code>acme.security.username</code> 自带 Security 对象，用户名</li>
<li><code>acme.security.password</code></li>
<li><code>acme.security.roles</code> 字符串集合</li>
</ul>

<p>
添加配置项，通过 <code>@EnableConfigurationProperties</code> 标注来扫描配置的 Java Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Configuration</span>
<span style="color: #268bd2;">@EnableConfigurationProperties</span><span style="color: #8d5649;">(</span>AcmeProperties.<span style="color: #859900;">class</span><span style="color: #8d5649;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">MyConfiguration</span> <span style="color: #8d5649;">{</span>
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">...</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
并且需要添加 <code>@Configuration</code> 到 Java Bean 中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Component</span>
<span style="color: #268bd2;">@ConfigurationProperties</span><span style="color: #8d5649;">(</span>prefix=<span style="color: #2aa198;">"acme"</span><span style="color: #8d5649;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">AcmeProperties</span> <span style="color: #8d5649;">{</span>
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">... see the preceding example</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
最后就可以将定义的 Java Bean 配置项注入到其它组件中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Service</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">MyService</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">AcmeProperties</span> <span style="color: #6c71c4;">properties</span>;

  <span style="color: #268bd2;">@Autowired</span>
  <span style="color: #859900;">public</span> <span style="color: #b58900;">MyService</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">AcmeProperties</span> <span style="color: #6c71c4;">properties</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">this</span>.properties = properties;
  <span style="color: #d8241f;">}</span>

  <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">...</span>

  <span style="color: #268bd2;">@PostConstruct</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">openConnection</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #268bd2;">Server</span> <span style="color: #6c71c4;">server</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">Server</span><span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.properties.getRemoteAddress<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">...</span>
  <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3f4b393" class="outline-3">
<h3 id="org3f4b393"><span class="section-number-3">3.6</span> 日志</h3>
<div class="outline-text-3" id="text-3-6">
<p>
Spring Boot 提供了一个统一的日志配置，可以兼容 Java Util Logging、Log4J2 和
Logback 等日志系统作为后端。
</p>
</div>

<div id="outline-container-orgbef1691" class="outline-4">
<h4 id="orgbef1691"><span class="section-number-4">3.6.1</span> 日志样式</h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
默认的输出样式如下：
</p>
<div class="org-src-container">
<pre class="src src-text">2014-03-05 10:57:51.112  INFO 45469 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/7.0.52
2014-03-05 10:57:51.253  INFO 45469 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2014-03-05 10:57:51.253  INFO 45469 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1358 ms
2014-03-05 10:57:51.698  INFO 45469 --- [ost-startStop-1] o.s.b.c.e.ServletRegistrationBean        : Mapping servlet: 'dispatcherServlet' to [/]
2014-03-05 10:57:51.702  INFO 45469 --- [ost-startStop-1] o.s.b.c.embedded.FilterRegistrationBean  : Mapping filter: 'hiddenHttpMethodFilter' to: [/*]
</pre>
</div>
<p>
包括以下几个部分：
</p>
<ul class="org-ul">
<li>Date and Time: Millisecond precision and easily sortable.</li>
<li>Log Level: ERROR, WARN, INFO, DEBUG, or TRACE.</li>
<li>Process ID.</li>
<li>A &#x2014; separator to distinguish the start of actual log messages.</li>
<li>Thread name: Enclosed in square brackets (may be truncated for console output).</li>
<li>Logger name: This is usually the source class name (often abbreviated).</li>
<li>The log message</li>
</ul>
</div>
</div>

<div id="outline-container-org8a8d133" class="outline-4">
<h4 id="org8a8d133"><span class="section-number-4">3.6.2</span> 控制台输出</h4>
<div class="outline-text-4" id="text-3-6-2">
<p>
控制台输出默认记录 ERROR, WARN 和 INFO 基本的日志，可以使用 <code>--debug</code> 开启调
试级别的输出。
</p>
<div class="org-src-container">
<pre class="src src-sh">java -jar myapp.jar --debug
</pre>
</div>

<p>
也可以在配置文件 <code>application.yml</code> 中设置 <code>debug=true</code>
</p>

<p>
如果控制台支持彩色输出，那么还可以配置彩色输出日志
</p>
<ul class="org-ul">
<li>开启配置文件中的 <code>spring.output.ansi.enabled</code> 选项</li>
<li>使用 <code>%clr(%5p)</code> 可以根据日志基本来变换颜色。各级别对应的颜色： 红色
(FATAL, ERROR)，黄色（INFO），绿色（INFO, DEBUG）</li>
<li>设置日期的颜色 <code>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){yellow}</code> ，默认支持以下几
种色彩： blue cyan faint green magenta red yellow</li>
</ul>
</div>
</div>

<div id="outline-container-orgfb13308" class="outline-4">
<h4 id="orgfb13308"><span class="section-number-4">3.6.3</span> 文件输出</h4>
<div class="outline-text-4" id="text-3-6-3">
<p>
文件输出通过 <code>logging.file</code> 和 <code>logging.path</code> 来控制
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">logging.file</th>
<th scope="col" class="org-left">logging.path</th>
<th scope="col" class="org-left">Example</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">(none)</td>
<td class="org-left">(none)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">仅开启控制台输出</td>
</tr>

<tr>
<td class="org-left">Specific file</td>
<td class="org-left">(none)</td>
<td class="org-left">my.log</td>
<td class="org-left">输出到文件，文件路径是当前文件夹的相对路径</td>
</tr>

<tr>
<td class="org-left">(none)</td>
<td class="org-left">Specific directory</td>
<td class="org-left">/var/log</td>
<td class="org-left">输出到文件，文件路径可以是相对路径或绝对路径</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><code>logging.file.max-size</code> 设置文件的最大存储大小</li>
<li><code>logging.file.max-history</code> 设置最大的历史文件数量</li>
</ul>
</div>
</div>

<div id="outline-container-org0cdca98" class="outline-4">
<h4 id="org0cdca98"><span class="section-number-4">3.6.4</span> 日志级别</h4>
<div class="outline-text-4" id="text-3-6-4">
<p>
日志级别可以通过 <code>logging.level.&lt;logger-name&gt;=&lt;level&gt;</code> 来设置，其中
<code>logging.level.root</code> 是设置默认级别
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #6c71c4;">logging.level.root</span>=WARN
<span style="color: #6c71c4;">logging.level.org.springframework.web</span>=DEBUG
<span style="color: #6c71c4;">logging.level.org.hibernate</span>=ERROR
</pre>
</div>
</div>
</div>

<div id="outline-container-org06c4641" class="outline-4">
<h4 id="org06c4641"><span class="section-number-4">3.6.5</span> 日志分组</h4>
<div class="outline-text-4" id="text-3-6-5">
<p>
日志基本可以通过分组来设置，例如
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #6c71c4;">logging.group.tomcat</span>=org.apache.catalina, org.apache.coyote, org.apache.tomcat
</pre>
</div>

<p>
Spring Boot 的默认分组有下面几个：
</p>
<ul class="org-ul">
<li>web : <code>org.springframework.core.codec, org.springframework.http, org.springframework.web</code></li>
<li>sql : <code>org.springframework.jdbc.core, org.hibernate.SQL</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org5ca7725" class="outline-3">
<h3 id="org5ca7725"><span class="section-number-3">3.7</span> 配置数据库</h3>
<div class="outline-text-3" id="text-3-7">
</div>
<div id="outline-container-org8fe6cc3" class="outline-4">
<h4 id="org8fe6cc3"><span class="section-number-4">3.7.1</span> MySQL</h4>
<div class="outline-text-4" id="text-3-7-1">
<p>
<code>application.yml</code> 配置文件中添加用户名、密码等相关信息
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">jpa</span>:
    <span style="color: #6c71c4;">database-platform</span>: org.hibernate.dialect.MySQL5Dialect
  <span style="color: #6c71c4;">datasource</span>:
    <span style="color: #6c71c4;">platform</span>: mysql
    <span style="color: #6c71c4;">username</span>: username
    <span style="color: #6c71c4;">password</span>: password
    <span style="color: #6c71c4;">url</span>: jdbc:mysql://localhost:3306/database?useUnicode=true<span style="color: #b58900;">&amp;characterEncoding</span>=utf-8<span style="color: #b58900;">&amp;useSSL</span>=false
    <span style="color: #6c71c4;">driver-class-name</span>: com.mysql.jdbc.Driver
</pre>
</div>

<p>
<code>pom.xml</code> 文件中添加 MySQL 依赖
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #b58900;">dependency</span>&gt;
  &lt;<span style="color: #b58900;">groupId</span>&gt;mysql&lt;/<span style="color: #b58900;">groupId</span>&gt;
  &lt;<span style="color: #b58900;">artifactId</span>&gt;mysql-connector-java&lt;/<span style="color: #b58900;">artifactId</span>&gt;
  &lt;<span style="color: #b58900;">version</span>&gt;5.1.38&lt;/<span style="color: #b58900;">version</span>&gt;
&lt;/<span style="color: #b58900;">dependency</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org666df06" class="outline-4">
<h4 id="org666df06"><span class="section-number-4">3.7.2</span> PostgreSQL</h4>
<div class="outline-text-4" id="text-3-7-2">
<p>
<code>application.yml</code> 配置文件中添加用户名、密码等相关信息
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">jpa</span>:
    <span style="color: #6c71c4;">database-platform</span>: org.hibernate.dialect.PostgreSQL9Dialect
  <span style="color: #6c71c4;">datasource</span>:
    <span style="color: #6c71c4;">platform</span>: postgres
    <span style="color: #6c71c4;">username</span>: username
    <span style="color: #6c71c4;">password</span>: password
    <span style="color: #6c71c4;">url</span>: jdbc:postgresql://localhost:5432/database
    <span style="color: #6c71c4;">driver-class-name</span>: org.postgresql.Driver
</pre>
</div>

<p>
<code>pom.xml</code> 文件中添加 PostgreSQL 依赖
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #b58900;">dependency</span>&gt;
  &lt;<span style="color: #b58900;">groupId</span>&gt;org.postgresql&lt;/<span style="color: #b58900;">groupId</span>&gt;
  &lt;<span style="color: #b58900;">artifactId</span>&gt;postgresql&lt;/<span style="color: #b58900;">artifactId</span>&gt;
  &lt;<span style="color: #b58900;">version</span>&gt;42.2.5&lt;/<span style="color: #b58900;">version</span>&gt;
&lt;/<span style="color: #b58900;">dependency</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5bda7be" class="outline-4">
<h4 id="org5bda7be"><span class="section-number-4">3.7.3</span> Oracle</h4>
<div class="outline-text-4" id="text-3-7-3">
<p>
<code>application.yml</code> 配置文件中添加用户名、密码等相关信息
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">jpa</span>:
    <span style="color: #6c71c4;">database-platform</span>: org.hibernate.dialect.Oracle10gDialect
  <span style="color: #6c71c4;">datasource</span>:
    <span style="color: #6c71c4;">username</span>: username
    <span style="color: #6c71c4;">password</span>: password
    <span style="color: #6c71c4;">url</span>: jdbc:oracle:thin:@//localhost:1521/database
    <span style="color: #6c71c4;">driver-class-name</span>: oracle.jdbc.OracleDriver
</pre>
</div>

<p>
<code>pom.xml</code> 文件中添加 PostgreSQL 依赖
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #b58900;">dependency</span>&gt;
  &lt;<span style="color: #b58900;">groupId</span>&gt;com.oracle&lt;/<span style="color: #b58900;">groupId</span>&gt;
  &lt;<span style="color: #b58900;">artifactId</span>&gt;ojdbc6&lt;/<span style="color: #b58900;">artifactId</span>&gt;
  &lt;<span style="color: #b58900;">version</span>&gt;11.2.0.4.0&lt;/<span style="color: #b58900;">version</span>&gt;
  &lt;<span style="color: #b58900;">scope</span>&gt;provided&lt;/<span style="color: #b58900;">scope</span>&gt;
&lt;/<span style="color: #b58900;">dependency</span>&gt;
</pre>
</div>

<p>
Oracle 的驱动是收费的，需要手工安装，默认在 <code>$ORACLE_HOME/jdbc/lib/</code> 文件夹中，
文档中对 ojdbc 描述如下：
</p>
<div class="org-src-container">
<pre class="src src-text">Driver Versions
---------------

These are the driver versions in the 10.2.0.1.0 release:

  - JDBC Thin Driver 10.2.0.1.0
    100% Java client-side JDBC driver for use in client applications,
    middle-tier servers and applets.

  - JDBC OCI Driver 10.2.0.1.0
    Client-side JDBC driver for use on a machine where OCI 10.2.0.1.0
    is installed.

  - JDBC Thin Server-side Driver 10.2.0.1.0
    JDBC driver for use in Java program in the database to access
    remote Oracle databases.

  - JDBC Server-side Internal Driver 10.2.0.1.0
    Server-side JDBC driver for use by Java Stored procedures.  This
    driver used to be called the "JDBC Kprb Driver".

For complete documentation, please refer to "JDBC Developer's Guide
and Reference".


Contents Of This Release
------------------------

For all platforms:

  [ORACLE_HOME]/jdbc/lib contains:

  - classes12.jar
    Classes for use with JDK 1.2 and JDK 1.3.  It contains the
    JDBC driver classes, except classes for NLS support in Oracle
    Object and Collection types.

  - classes12_g.jar
    Same as classes12.jar, except that classes were compiled with
    "javac -g" and contain some tracing information.

  - classes12dms.jar
    Same as classes12.jar, except that it contains additional code
    to support Oracle Dynamic Monitoring Service. Can only be used
    when dms.jar is in the classpath. dms.jar is provided as part of
    recent Oracle Application Server releases.

  - classes12dms_g.jar
    Same as classes12dms.jar except that classes were compiled with
    "javac -g" and contain some tracing information.

  - ojdbc14.jar
    Classes for use with JDK 1.4 and 5.0.  It contains the JDBC driver
    classes, except classes for NLS support in Oracle Object and
    Collection types.

  - ojdbc14_g.jar
    Same as ojdbc14.jar, except that classes were compiled with
    "javac -g" and contain some tracing information.

  - ojdbc14dms.jar
    Same as ojdbc14.jar, except that it contains additional code
    to support Oracle Dynamic Monitoring Service. Can only be used
    when dms.jar is in the classpath. dms.jar is provided as part of
    recent Oracle Application Server releases.

  - ojdbc14dms_g.jar
    Same as ojdbc14dms.jar except that classes were compiled with
    "javac -g" and contain some tracing information.

  [ORACLE_HOME]/jdbc/doc/javadoc.tar contains the JDBC Javadoc
  for the public API of the public classes of Oracle JDBC.

  [ORACLE_HOME]/jdbc/demo/demo.tar contains sample JDBC programs.

  [ORACLE_HOME]/jlib/orai18n.jar
    NLS classes for use with JDK 1.2, 1.3, 1.4, and 5.0.  It contains
    classes for NLS support in Oracle Object and Collection types.
    This jar file replaces the old nls_charset jar/zip files. In
    Oracle 10g R1 it was duplicated in [ORACLE_HOME]/jdbc/lib. We
    have removed the duplicate copy and you should now get it from
    its proper location.

</pre>
</div>
<p>
安装适配你项目的 jar 文件即可
</p>
<div class="org-src-container">
<pre class="src src-sh">mvn install:install-file -Dpackaging=jar <span style="color: #2aa198;">\</span>
  -DgroupId=com.oracle -DartifactId=ojdbc6 -Dversion=11.2.0.4.0 <span style="color: #2aa198;">\</span>
  -Dfile=&lt;path-to-jar&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf90b8e" class="outline-4">
<h4 id="orgbf90b8e"><span class="section-number-4">3.7.4</span> Tomcat 连接池配置</h4>
<div class="outline-text-4" id="text-3-7-4">
<p>
如果你在项目中使用<a href="https://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html#Common_Attributes"> Tomcat 连接池</a>作为数据库连接，可能还需要设置的相关参数
</p>
<div class="org-src-container">
<pre class="src src-conf"># Number of ms to wait before throwing an exception if no connection is available.
<span style="color: #6c71c4;">spring.datasource.tomcat.max-wait</span>=10000

# Maximum number of active connections that can be allocated from this pool at the same time.
<span style="color: #6c71c4;">spring.datasource.tomcat.max-active</span>=50

# Validate the connection before borrowing it from the pool.
<span style="color: #6c71c4;">spring.datasource.tomcat.test-on-borrow</span>=true
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org06c2f27" class="outline-3">
<h3 id="org06c2f27"><span class="section-number-3">3.8</span> 开发工具</h3>
<div class="outline-text-3" id="text-3-8">
<p>
Spring Boot 的提供了开发工具套件，可以实现自动加载，仅仅需要在 <code>pom.xml</code> 文件中
加入下面依赖即可自动添加
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #b58900;">dependencies</span>&gt;
 &lt;<span style="color: #b58900;">dependency</span>&gt;
  &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #b58900;">groupId</span>&gt;
  &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-boot-devtools&lt;/<span style="color: #b58900;">artifactId</span>&gt;
  &lt;<span style="color: #b58900;">optional</span>&gt;true&lt;/<span style="color: #b58900;">optional</span>&gt;
 &lt;/<span style="color: #b58900;">dependency</span>&gt;
&lt;/<span style="color: #b58900;">dependencies</span>&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8af72f8" class="outline-2">
<h2 id="org8af72f8"><span class="section-number-2">4</span> Spring Data</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org38725e7" class="outline-3">
<h3 id="org38725e7"><span class="section-number-3">4.1</span> Spring Data JPA</h3>
<div class="outline-text-3" id="text-4-1">
<p>
JPA(Java Persistence API)意即 Java 持久化 API，是 Sun 官方在 JDK5.0 后提出的
Java 持久化规范。JPA 的出现主要是为了简化持久层开发以及整合 ORM 技术，结束
Hibernate、TopLink、JDO 等 ORM 框架各自为营的局面。JPA 是在吸收现有 ORM 框架
的基础上发展而来，易于使用，伸缩性强。总的来说，JPA 包括以下 3 方面的技术：
</p>

<ul class="org-ul">
<li>ORM 映射元数据： 支持 XML 和注解两种元数据的形式，元数据描述对象和表之间的
映射关系</li>
<li>API： 操作实体对象来执行 CRUD 操作</li>
<li>查询语言： 通过面向对象而非面向数据库的查询语言（JPQL）查询数据，避免程序的
SQL 语句紧密耦合</li>
</ul>

<p>
<a href="https://spring.io/projects/spring-data-jpa#overview">Spring Data JPA </a>是 Spring Data 家族的一部分，可以轻松实现基于 JPA 的存储库。
此模块处理对基于 JPA 的数据访问层的增强支持。 它使构建使用数据访问技术的
Spring 驱动应用程序变得更加容易。其代码托管于 <a href="https://github.com/spring-projects/spring-data-jpa">GitHub</a> ， 文档见 <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/">reference</a> 。
</p>
</div>
</div>
</div>

<div id="outline-container-orgd0f1e58" class="outline-2">
<h2 id="orgd0f1e58"><span class="section-number-2">5</span> Spring Cloud</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="https://spring.io/projects/spring-cloud">Spring Cloud</a> 是一系列框架的有序集合。它利用 Spring Boot 的开发便利性巧妙地简化了
分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、
数据监控等，都可以用 Spring Boot 的开发风格做到一键启动和部署。Spring Cloud 并没
有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组
合起来，通过 Spring Boot 风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发
者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。
</p>
</div>

<div id="outline-container-org1c0595e" class="outline-3">
<h3 id="org1c0595e"><span class="section-number-3">5.1</span> Spring Cloud Config</h3>
<div class="outline-text-3" id="text-5-1">
<p>
<a href="https://spring.io/projects/spring-cloud-config">Spring Cloud Config</a> 项目是一个解决分布式系统的配置管理方案。它包含了 Client 和
Server 两个部分，server 提供配置文件的存储、以接口的形式将配置文件的内容提供出
去，client 通过接口获取数据、并依据此数据初始化自己的应用。
</p>


<div class="figure">
<p><img src="../static/image/2019/07/spring-cloud-config.png" alt="spring-cloud-config.png" />
</p>
</div>
</div>

<div id="outline-container-org1b4fce0" class="outline-4">
<h4 id="org1b4fce0"><span class="section-number-4">5.1.1</span> 配置文件命名格式</h4>
<div class="outline-text-4" id="text-5-1-1">
<ul class="org-ul">
<li>配置文件命名方式为: <b>{appname}-{profile}.yml</b>
<ul class="org-ul">
<li>appname 是微服务的名称</li>
<li>profile 是不同的环境，建议用: <code>dev</code> 表示开发环境， <code>prod</code> 表示线
上运行环境</li>
</ul></li>
<li>对应请求的 URI 有以下几种格式
<ul class="org-ul">
<li><code>/{application}/{profile}[/{label}]</code></li>
<li><code>/{application}-{profile}.yml</code></li>
<li><code>/{label}/{application}-{profile}.yml</code></li>
<li><code>/{application}-{profile}.properties</code></li>
<li><code>/{label}/{application}-{profile}.properties</code></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org15816d1" class="outline-4">
<h4 id="org15816d1"><span class="section-number-4">5.1.2</span> Config Server</h4>
<div class="outline-text-4" id="text-5-1-2">
</div>
<ol class="org-ol">
<li><a id="orgc4d8a37"></a>项目依赖<br />
<div class="outline-text-5" id="text-5-1-2-1">
<p>
在 <code>pom.xml</code> 文件中添加如下的依赖项
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #b58900;">project</span>&gt;
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-config-server&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;

  &lt;<span style="color: #b58900;">dependencyManagement</span>&gt;
    &lt;<span style="color: #b58900;">dependencies</span>&gt;
      &lt;<span style="color: #b58900;">dependency</span>&gt;
        &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
        &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-dependencies&lt;/<span style="color: #b58900;">artifactId</span>&gt;
        &lt;<span style="color: #b58900;">version</span>&gt;Greenwich.SR2&lt;/<span style="color: #b58900;">version</span>&gt;
        &lt;<span style="color: #b58900;">type</span>&gt;pom&lt;/<span style="color: #b58900;">type</span>&gt;
        &lt;<span style="color: #b58900;">scope</span>&gt;import&lt;/<span style="color: #b58900;">scope</span>&gt;
      &lt;/<span style="color: #b58900;">dependency</span>&gt;
    &lt;/<span style="color: #b58900;">dependencies</span>&gt;
  &lt;/<span style="color: #b58900;">dependencyManagement</span>&gt;
&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>
</div>
</li>

<li><a id="orgf82ab50"></a>引导类<br />
<div class="outline-text-5" id="text-5-1-2-2">
<p>
中心服务器的引导累着需要添加 <code>@EnableConfigServer</code> 来启用配置服务器
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">boot</span>.<span style="color: #268bd2;">SpringApplication</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">boot</span>.<span style="color: #268bd2;">autoconfigure</span>.<span style="color: #268bd2;">SpringBootApplication</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">cloud</span>.<span style="color: #268bd2;">config</span>.<span style="color: #268bd2;">server</span>.<span style="color: #268bd2;">EnableConfigServer</span>;

<span style="color: #268bd2;">@SpringBootApplication</span>
<span style="color: #268bd2;">@EnableConfigServer</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    SpringApplication.run<span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span>, args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="orga819e4e"></a>Git 远端配置项<br />
<div class="outline-text-5" id="text-5-1-2-3">
<p>
在中心配置服务器中的 <code>application.yml</code> 中添加相应的配置
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">profiles</span>:
    <span style="color: #6c71c4;">active</span>: default
  <span style="color: #6c71c4;">cloud</span>:
    <span style="color: #6c71c4;">config</span>:
      <span style="color: #6c71c4;">server</span>:
        <span style="color: #6c71c4;">git</span>:
          <span style="color: #6c71c4;">uri</span>: http://github.com/avic/configfiles.git
          <span style="color: #6c71c4;">searchPaths</span>:
            - path1
            - path2
          <span style="color: #6c71c4;">username</span>: user
          <span style="color: #6c71c4;">password</span>: pass
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orga11a750" class="outline-4">
<h4 id="orga11a750"><span class="section-number-4">5.1.3</span> Config Client</h4>
<div class="outline-text-4" id="text-5-1-3">
</div>
<ol class="org-ol">
<li><a id="org612fe61"></a>配置相关文件<br />
<div class="outline-text-5" id="text-5-1-3-1">
<p>
首先修改 <b>pom.xml</b>, <b>application.yml</b> 和 <b>bootstrap.yml</b> 这三项配置文件
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">pom.xml </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">project</span>&gt;
  <span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">1. &#28155;&#21152;&#19979;&#38754;&#22235;&#20010;&#20381;&#36182;&#39033; </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-starter-config&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-boot-starter-actuator&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-boot-starter-web&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-boot-starter-test&lt;/<span style="color: #b58900;">artifactId</span>&gt;
      &lt;<span style="color: #b58900;">scope</span>&gt;test&lt;/<span style="color: #b58900;">scope</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;

  <span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">2. &#35774;&#32622;&#20381;&#36182;&#31649;&#29702; </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
  &lt;<span style="color: #b58900;">dependencyManagement</span>&gt;
    &lt;<span style="color: #b58900;">dependencies</span>&gt;
      &lt;<span style="color: #b58900;">dependency</span>&gt;
        &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
        &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-dependencies&lt;/<span style="color: #b58900;">artifactId</span>&gt;
        <span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">&#36825;&#20010; version &#38656;&#35201;&#21644;&#20320;&#20351;&#29992;&#30340; spring boot &#29256;&#26412;&#36866;&#37197;&#65292;&#21542;&#21017;&#24212;&#29992;&#36215;&#19981;&#26469; </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
        &lt;<span style="color: #b58900;">version</span>&gt;Greenwich.SR2&lt;/<span style="color: #b58900;">version</span>&gt;
        <span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">&#25105;&#30340;&#39033;&#30446;&#20013; spring boot &#29256;&#26412;&#26159; 2.1.0.RELEASE, &#25152;&#20197; cloud &#30340;&#29256;&#26412;&#20351;&#29992; Greenwich </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
        &lt;<span style="color: #b58900;">type</span>&gt;pom&lt;/<span style="color: #b58900;">type</span>&gt;
        &lt;<span style="color: #b58900;">scope</span>&gt;import&lt;/<span style="color: #b58900;">scope</span>&gt;
      &lt;/<span style="color: #b58900;">dependency</span>&gt;
    &lt;/<span style="color: #b58900;">dependencies</span>&gt;
  &lt;/<span style="color: #b58900;">dependencyManagement</span>&gt;

&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">src/main/resources/application.yml</span>
<span style="color: #6c71c4;">management</span>:
  <span style="color: #6c71c4;">endpoints</span>:
    <span style="color: #6c71c4;">web</span>:
      <span style="color: #6c71c4;">exposure</span>:
        <span style="color: #6c71c4;">include</span>: <span style="color: #2aa198;">'*'</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">src/main/resources/bootstrap.yml</span>
<span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">application</span>:
    <span style="color: #6c71c4;">name</span>: appname <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#36825;&#37324;&#20889;&#20320;&#39033;&#30446;&#30340;&#21517;&#31216;</span>
  <span style="color: #6c71c4;">profiles</span>:
    <span style="color: #6c71c4;">active</span>: dev   <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#36825;&#37324;&#37197;&#32622;&#20320;&#38656;&#35201;&#30340; profile</span>
  <span style="color: #6c71c4;">cloud</span>:
    <span style="color: #6c71c4;">config</span>:
      <span style="color: #6c71c4;">uri</span>: http://192.168.0.231/peizhi
</pre>
</div>
</div>
</li>

<li><a id="org71fc16e"></a>引导类<br />
<div class="outline-text-5" id="text-5-1-3-2">
<p>
在系统启动的引导类中添加 <code>@RefreshScope</code> 注解
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">boot</span>.<span style="color: #268bd2;">autoconfigure</span>.<span style="color: #268bd2;">SpringBootApplication</span>;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">org</span>.<span style="color: #268bd2;">springframework</span>.<span style="color: #268bd2;">cloud</span>.<span style="color: #268bd2;">context</span>.<span style="color: #268bd2;">config</span>.<span style="color: #268bd2;">annotation</span>.<span style="color: #268bd2;">RefreshScope</span>;

<span style="color: #268bd2;">@SpringBootApplication</span>
<span style="color: #268bd2;">@RefreshScope</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>
  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    SpringApplication.run<span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span>, args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org1f7927e" class="outline-3">
<h3 id="org1f7927e"><span class="section-number-3">5.2</span> Spring Cloud Netflix</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<a href="https://spring.io/projects/spring-cloud-netflix">Spring Cloud Netflix</a> 是通过自动配置和绑定提供为 spring boot 应用提供 OSS 集成
功能，它的子项目包括：
</p>
<ul class="org-ul">
<li>Eureka: 服务发现 (Service Discovery)</li>
<li>Hystrix : 断路器 (Circuit Breaker)</li>
<li>Zuul : 智能路由 (Intelligent Routing)</li>
<li>Ribbon : 客户端的负载均衡 (Client Side Load Balancing)</li>
</ul>
</div>

<div id="outline-container-orgff83a4b" class="outline-4">
<h4 id="orgff83a4b"><span class="section-number-4">5.2.1</span> Eureka</h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
Eureka 是 <a href="https://spring.io/projects/spring-cloud-netflix">Spring Cloud Netflix</a> 开发的服务发现框架，本身是一个基于 REST 的服
务。Spring Cloud 将它集成在其子项目 spring-cloud-netflix 中，以实现 Spring
Cloud 的服务发现功能。 Eureka 项目本身包括客户端和服务器两个子项目，具体配置
如下：
</p>
</div>

<ol class="org-ol">
<li><a id="orgf1706af"></a>Eureka Client<br />
<ol class="org-ol">
<li><a id="org9b81224"></a>配置相关文件<br />
<div class="outline-text-6" id="text-5-2-1-1-1">
<p>
<code>pom.xml</code> 添加 <code>spring-cloud-starter-netflix-eureka-client</code> 的依赖项
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">pom.xml </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">project</span>&gt;
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-starter-netflix-eureka-client&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;
&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>

<p>
<code>application.yml</code> 添加配置项
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">eureka</span>:
  <span style="color: #6c71c4;">instance</span>:
    <span style="color: #6c71c4;">preferIpAddress</span>: true       <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#20351;&#29992; IP &#22320;&#22336;&#27880;&#20876;&#65292;&#32780;&#19981;&#26159;&#20351;&#29992;&#20027;&#26426;&#21517;&#27880;&#20876;</span>
  <span style="color: #6c71c4;">client</span>:
    <span style="color: #6c71c4;">fetchRegistry</span>: <span style="color: #268bd2;">true</span>
    <span style="color: #6c71c4;">registerWithEureka</span>: <span style="color: #268bd2;">true</span>
    <span style="color: #6c71c4;">serviceUrl</span>:
      <span style="color: #6c71c4;">defaultZone</span>: http://localhost:8761/eureka/
</pre>
</div>

<p>
通常建议开启 <code>preferIpAddress</code> ，因为有的时候微服务被部署到 docker 容器中，
主机名可能是随机分配的，不好管理。
</p>
</div>
</li>

<li><a id="orge089898"></a>配置引导类<br />
<div class="outline-text-6" id="text-5-2-1-1-2">
<p>
如果是 Spring Boot 项目的话，添加了
<code>spring-cloud-starter-netflix-eureka-client</code> 的依赖项后会自动注册到 Eureka
Server 上
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@SpringBootApplication</span>
<span style="color: #268bd2;">@RestController</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>

  <span style="color: #268bd2;">@RequestMapping</span><span style="color: #d8241f;">(</span><span style="color: #2aa198;">"/"</span><span style="color: #d8241f;">)</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">home</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #2aa198;">"Hello world"</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">new</span> <span style="color: #268bd2;">SpringApplicationBuilder</span><span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span><span style="color: #9564bf;">)</span>.web<span style="color: #9564bf;">(</span><span style="color: #268bd2;">true</span><span style="color: #9564bf;">)</span>.run<span style="color: #9564bf;">(</span>args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
也可以使用 <code>@EnableDiscoveryClient</code> 的注解来显示激活
</p>
</div>
</li>
</ol>
</li>

<li><a id="org7f36fe2"></a>Eureka Server<br />
<ol class="org-ol">
<li><a id="orgc9fba5e"></a>配置相关文件<br />
<div class="outline-text-6" id="text-5-2-1-2-1">
<p>
<code>pom.xml</code> 添加 <code>spring-cloud-starter-netflix-eureka-server</code> 的依赖项
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">pom.xml </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">project</span>&gt;
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-starter-netflix-eureka-server&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;
&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>

<p>
<code>application.yml</code> 添加配置项，下面是 Standalone 模式的配置方法
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">eureka</span>:
  <span style="color: #6c71c4;">instance</span>:
    <span style="color: #6c71c4;">hostname</span>: localhost
  <span style="color: #6c71c4;">client</span>:
    <span style="color: #6c71c4;">fetchRegistry</span>: false                <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#19981;&#35201;&#22312;&#26412;&#22320;&#32531;&#23384;&#27880;&#20876;&#34920;&#20449;&#24687;</span>
    <span style="color: #6c71c4;">registerWithEureka</span>: <span style="color: #268bd2;">false</span>
    <span style="color: #6c71c4;">serverUrl</span>:
      <span style="color: #6c71c4;">defaultZone</span>: http://localhost:8761/eureka/
  <span style="color: #6c71c4;">server</span>:
    <span style="color: #6c71c4;">waitTimeInMsWhenSyncEmpty</span>: 5      <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#22312;&#26381;&#21153;&#22120;&#25509;&#25910;&#35831;&#27714;&#20043;&#21069;&#30340;&#31561;&#24453;&#26102;&#38388;</span>
</pre>
</div>

<p>
Peer Awareness 模式配置方法如下：
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #93a1a1; font-style: italic;">---</span>
<span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">profiles</span>: peer1
<span style="color: #6c71c4;">eureka</span>:
  <span style="color: #6c71c4;">instance</span>:
    <span style="color: #6c71c4;">hostname</span>: peer1
  <span style="color: #6c71c4;">client</span>:
    <span style="color: #6c71c4;">serviceUrl</span>:
      <span style="color: #6c71c4;">defaultZone</span>: https://peer2/eureka/

<span style="color: #93a1a1; font-style: italic;">---</span>
<span style="color: #6c71c4;">spring</span>:
  <span style="color: #6c71c4;">profiles</span>: peer2
<span style="color: #6c71c4;">eureka</span>:
  <span style="color: #6c71c4;">instance</span>:
    <span style="color: #6c71c4;">hostname</span>: peer2
  <span style="color: #6c71c4;">client</span>:
    <span style="color: #6c71c4;">serviceUrl</span>:
      <span style="color: #6c71c4;">defaultZone</span>: https://peer1/eureka/
</pre>
</div>
</div>
</li>

<li><a id="orgd5c0587"></a>配置引导类<br />
<div class="outline-text-6" id="text-5-2-1-2-2">
<p>
使用 <code>@EnableEurekaServer</code> 来开启 Eureka Server
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@SpringBootApplication</span>
<span style="color: #268bd2;">@EnableEurekaServer</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">new</span> <span style="color: #268bd2;">SpringApplicationBuilder</span><span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span><span style="color: #9564bf;">)</span>.web<span style="color: #9564bf;">(</span><span style="color: #268bd2;">true</span><span style="color: #9564bf;">)</span>.run<span style="color: #9564bf;">(</span>args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-orge8b0b6d" class="outline-4">
<h4 id="orge8b0b6d"><span class="section-number-4">5.2.2</span> Hystrix</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
Hystrix 是 SOA 微服务架构中提供服务隔离、熔断、降级机制的工具/框架。Hystrix
是断路器的一种实现，用于高微服务架构的可用性，是防止服务出现雪崩的利器。
Hystrix 实现了 Martin Fowler 的 <a href="https://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker</a> 模式，熔断器的机制的思想很简
单直白，即在 client 和 supplier 之间实现一个 circuit breaker 层，当 supplier
出现错误或超时，就对 client 的请求进行截断
</p>
</div>

<ol class="org-ol">
<li><a id="org28881f7"></a>Hystrix Client<br />
<ol class="org-ol">
<li><a id="orgcd00e54"></a>配置相关文件<br />
<div class="outline-text-6" id="text-5-2-2-1-1">
<p>
<code>pom.xml</code> 添加 <code>spring-cloud-starter-netflix-hystrix</code> 的依赖项
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">pom.xml </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">project</span>&gt;
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-starter-netflix-hystrix&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;com.netflix.hystrix&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;hystrix-javanica&lt;/<span style="color: #b58900;">artifactId</span>&gt;
      <span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">&lt;version&gt;x.y.z&lt;/version&gt; </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;
&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>
</div>
</li>

<li><a id="orgeadc04a"></a>配置引导类<br />
<div class="outline-text-6" id="text-5-2-2-1-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@SpringBootApplication</span>
<span style="color: #268bd2;">@EnableCircuitBreaker</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">new</span> <span style="color: #268bd2;">SpringApplicationBuilder</span><span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span><span style="color: #9564bf;">)</span>.web<span style="color: #9564bf;">(</span><span style="color: #268bd2;">true</span><span style="color: #9564bf;">)</span>.run<span style="color: #9564bf;">(</span>args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>

<span style="color: #268bd2;">@Component</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">StoreIntegration</span> <span style="color: #8d5649;">{</span>

  <span style="color: #268bd2;">@HystrixCommand</span><span style="color: #d8241f;">(</span>fallbackMethod = <span style="color: #2aa198;">"defaultStores"</span><span style="color: #d8241f;">)</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getStores</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Map</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Object</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">parameters</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">do stuff that might fail</span>
  <span style="color: #d8241f;">}</span>

  <span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">defaultStores</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Map</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Object</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">parameters</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #93a1a1; font-style: italic;">something useful */</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>@HystrixCommand</code> 由 <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-javanica">javanica</a> 库提供，该库可以自动代理一些熔断处理。
<code>@EnableCircuitBreaker</code> 开启熔断器
</p>
</div>
</li>

<li><a id="org17e2d64"></a>弹性模式<br />
<div class="outline-text-6" id="text-5-2-2-1-3">
<p>
Hystrix 的常见弹性模式有以下几种：
</p>
<ul class="org-ul">
<li>断路器模式：确保客户端不会重复调用失败的服务</li>
<li>后备模式：调用失败后，询问是否有可以执行的替代方案</li>
<li>舱壁模式：隔断服务客户端上的不同服务调用，以确保表现不佳的服务不会耗尽客
户端的所有资源</li>
</ul>
</div>
</li>
</ol>
</li>

<li><a id="orgb1d8917"></a>Hystrix Dashboard<br />
<div class="outline-text-5" id="text-5-2-2-2">
<p>
Hystrix 监控除了隔离依赖服务的调用以外，Hystrix 还提供了近实时的监控，Hystrix
会实时、累加地记录所有关于 HystrixCommand 的执行信息，包括每秒执行多少请求多
少成功，多少失败等。Netflix 通过 hystrix-metrics-event-stream 项目实现了对以上
指标的监控。
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org5fe2652" class="outline-4">
<h4 id="org5fe2652"><span class="section-number-4">5.2.3</span> Zuul</h4>
<div class="outline-text-4" id="text-5-2-3">
<p>
Zuul 是在云平台上提供动态路由,监控,弹性,安全等边缘服务的框架。Zuul 相当于是
设备和 Netflix 流应用的 Web 网站后端所有请求的前门
</p>


<div class="figure">
<p><img src="../static/image/2019/07/netflix-zuul.png" alt="netflix-zuul.png" />
</p>
</div>
</div>

<ol class="org-ol">
<li><a id="org70217c4"></a>配置相关文件<br />
<div class="outline-text-6" id="text-5-2-3-0-1">
<p>
<code>pom.xml</code> 添加 <code>spring-cloud-starter-netflix-zuul</code> 的依赖项将 Zuul 引入项目
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">pom.xml </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">project</span>&gt;
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-starter-netflix-zuul&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;
&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>
</div>
</li>

<li><a id="org5c828c1"></a>配置引导类<br />
<div class="outline-text-6" id="text-5-2-3-0-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@SpringBootApplication</span>
<span style="color: #268bd2;">@EnableZuulProxy</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">Application</span> <span style="color: #8d5649;">{</span>

  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">main</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">new</span> <span style="color: #268bd2;">SpringApplicationBuilder</span><span style="color: #9564bf;">(</span>Application.<span style="color: #859900;">class</span><span style="color: #9564bf;">)</span>.web<span style="color: #9564bf;">(</span><span style="color: #268bd2;">true</span><span style="color: #9564bf;">)</span>.run<span style="color: #9564bf;">(</span>args<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>@EnableZuulProxy</code> 来开启 Zuul 服务
</p>
</div>
</li>

<li><a id="org284fe01"></a>配置反向代理<br />
<div class="outline-text-6" id="text-5-2-3-0-3">
<p>
Zuul 的反向代理使用的是以下几种方式进行设置
</p>
<ul class="org-ul">
<li>通过服务发现自动映射路由</li>
<li>通过服务发现手动映射路由</li>
<li>通过静态 URL 手动映射路由</li>
</ul>

<p>
使用 <code>@EnableZuulProxy</code> 开启 Zuul 服务后，如果正确地配置了 Eureka Client
服务的话，不需要进行其它的配置就可以自动映射路由。根据惯例，Zuul 会自动给
反向代理的微服务添加前缀，例如： 如果微服务的名字是 <code>users</code> ，则 Zuul 会将
<code>/users/**</code> 的请求全部映射到 <code>users</code> 微服务中
</p>


<p>
手动配置反向代理需要修改 <code>application.yml</code> 配置文件，例如下面的配置将
<code>/myusers/**</code> 请求传递到 <code>users</code> 微服务中
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">zuul</span>:
 <span style="color: #6c71c4;">routes</span>:
   <span style="color: #6c71c4;">users</span>:
     <span style="color: #6c71c4;">path</span>: /myusers/**
     <span style="color: #6c71c4;">serviceId</span>: users_service
</pre>
</div>

<p>
使用静态 URL 手动映射路由
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">zuul</span>:
 <span style="color: #6c71c4;">routes</span>:
   <span style="color: #6c71c4;">users</span>:
     <span style="color: #6c71c4;">path</span>: /myusers/**
     <span style="color: #6c71c4;">url</span>: https://example.com/users_service
</pre>
</div>
</div>
</li>

<li><a id="org6482c9d"></a>忽略某些微服务<br />
<div class="outline-text-6" id="text-5-2-3-0-4">
<p>
Zuul 允许配置对一些微服务的忽略项
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#24573;&#30053;&#25152;&#26377;&#24494;&#26381;&#21153;</span>
<span style="color: #6c71c4;">zuul</span>:
  <span style="color: #6c71c4;">ignoredServices</span>: <span style="color: #2aa198;">'*'</span>
  <span style="color: #6c71c4;">routes</span>:
    <span style="color: #6c71c4;">users</span>: /myusers/**

<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#24573;&#30053;&#26576;&#20010;&#24494;&#26381;&#21153;&#65292;&#24494;&#26381;&#21153;&#30340;&#21517;&#23383;&#20026; appname</span>
<span style="color: #6c71c4;">zuul</span>:
  <span style="color: #6c71c4;">ignoredServices</span>: <span style="color: #2aa198;">'appname'</span>
  <span style="color: #6c71c4;">routes</span>:
    <span style="color: #6c71c4;">users</span>: /myusers/**

<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#28155;&#21152;&#32479;&#19968;&#30340;&#21069;&#32512; /api</span>
<span style="color: #6c71c4;">zuul</span>:
  <span style="color: #6c71c4;">ignoredServices</span>: <span style="color: #2aa198;">'*'</span>
  <span style="color: #6c71c4;">prefix</span>: /api
  <span style="color: #6c71c4;">routes</span>:
    <span style="color: #6c71c4;">users</span>: /myusers/**

<span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#24573;&#30053;&#25152;&#26377;&#24102;&#26377; /admin/ &#36335;&#30001;&#30340;&#35843;&#29992;&#25509;&#21475;</span>
<span style="color: #6c71c4;">zuul</span>:
  <span style="color: #6c71c4;">ignoredPatterns</span>: /**/admin/**
  <span style="color: #6c71c4;">routes</span>:
    <span style="color: #6c71c4;">users</span>: /myusers/**
</pre>
</div>
</div>
</li>

<li><a id="org8f4900f"></a>头部的设置选项<br />
<div class="outline-text-6" id="text-5-2-3-0-5">
<p>
将 <code>Cookies</code>, <code>Set-Cookie</code>, <code>Authorization</code> 设置成敏感的头部，忽略一些头部
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">zuul</span>:
  <span style="color: #6c71c4;">routes</span>:
    <span style="color: #6c71c4;">users</span>:
      <span style="color: #6c71c4;">path</span>: /myusers/**
      <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">Cookies &#21644;&#25935;&#24863;&#30340;&#22836;&#37096;</span>
      <span style="color: #6c71c4;">sensitiveHeaders</span>: Cookie,Set-Cookie,Authorization
      <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#24573;&#30053;&#30340;&#22836;&#37096;</span>
      <span style="color: #6c71c4;">ignoredHeaders</span>: Header1
      <span style="color: #93a1a1; font-style: italic;"># </span><span style="color: #93a1a1; font-style: italic;">&#26159;&#21542;&#24573;&#30053;&#23433;&#20840;&#22836;&#37096;</span>
      <span style="color: #6c71c4;">ignoreSecurityHeaders</span>: <span style="color: #268bd2;">true</span>
      <span style="color: #6c71c4;">url</span>: https://downstream
</pre>
</div>
</div>
</li>

<li><a id="org4c6e6bb"></a>管理端点 Endpoint<br />
<div class="outline-text-6" id="text-5-2-3-0-6">
<p>
Zuul 提供了一些管理路由的 RESTful 接口
</p>
<ul class="org-ul">
<li><code>GET /routes</code> 获取所有解析的路由</li>
<li><code>GET /routes/detail</code> 获取详细路由信息</li>
<li><code>POST /routes</code> 强制刷新路由</li>
<li><code>GET /filter</code> 获取所有的过滤器</li>
</ul>

<p>
下面是一些示例
</p>
<div class="org-src-container">
<pre class="src src-sh">curl http://localhost/routes
</pre>
</div>
<div class="org-src-container">
<pre class="src src-json">{
  <span style="color: #859900;">"/stores/**"</span>: <span style="color: #2aa198;">"http://localhost:8081"</span>
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">curl http://localhost/routes/detail
</pre>
</div>
<div class="org-src-container">
<pre class="src src-json">{
  <span style="color: #859900;">"/stores/**"</span>: {
    <span style="color: #859900;">"id"</span>: <span style="color: #2aa198;">"stores"</span>,
    <span style="color: #859900;">"fullPath"</span>: <span style="color: #2aa198;">"/stores/**"</span>,
    <span style="color: #859900;">"location"</span>: <span style="color: #2aa198;">"http://localhost:8081"</span>,
    <span style="color: #859900;">"path"</span>: <span style="color: #2aa198;">"/**"</span>,
    <span style="color: #859900;">"prefix"</span>: <span style="color: #2aa198;">"/stores"</span>,
    <span style="color: #859900;">"retryable"</span>: <span style="color: #268bd2;">false</span>,
    <span style="color: #859900;">"customSensitiveHeaders"</span>: <span style="color: #268bd2;">false</span>,
    <span style="color: #859900;">"prefixStripped"</span>: <span style="color: #268bd2;">true</span>
  }
}
</pre>
</div>
</div>
</li>

<li><a id="org7758ebd"></a>基本使用场景<br />
<div class="outline-text-6" id="text-5-2-3-0-7">
<p>
如下所示将相关路由反向代理到对应的 URL
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">原始请求</th>
<th scope="col" class="org-left">代理后的请求</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">/fisrt/1</td>
<td class="org-left"><a href="https://first.exmple.com/1">https://first.exmple.com/1</a></td>
</tr>

<tr>
<td class="org-left">/second/2</td>
<td class="org-left">/second/2</td>
</tr>

<tr>
<td class="org-left">/third/3</td>
<td class="org-left">/3rd/3</td>
</tr>

<tr>
<td class="org-left">/no</td>
<td class="org-left"><a href="https://legacy.example.com/no">https://legacy.example.com/no</a></td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">zuul</span>:
 <span style="color: #6c71c4;">routes</span>:
   <span style="color: #6c71c4;">first</span>:
     <span style="color: #6c71c4;">path</span>: /first/**
     <span style="color: #6c71c4;">url</span>: https://first.example.com
   <span style="color: #6c71c4;">second</span>:
     <span style="color: #6c71c4;">path</span>: /second/**
     <span style="color: #6c71c4;">url</span>: forward:/second
   <span style="color: #6c71c4;">third</span>:
     <span style="color: #6c71c4;">path</span>: /third/**
     <span style="color: #6c71c4;">url</span>: forward:/3rd
   <span style="color: #6c71c4;">legacy</span>:
     <span style="color: #6c71c4;">path</span>: /**
     <span style="color: #6c71c4;">url</span>: https://legacy.example.com
</pre>
</div>

<p>
Zuul 的详细配置见 <a href="https://github.com/Netflix/zuul/wiki/How-it-Works">Zuul wiki</a>
</p>
</div>
</li>

<li><a id="orgd160077"></a>过滤器<br />
<div class="outline-text-6" id="text-5-2-3-0-8">
<p>
前置过滤器（Pre Filter）的在请求之前先进行处理，设置 <code>RequestContext</code> 的相
关参数提供后面的处理
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">QueryParamPreFilter</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">ZuulFilter</span> <span style="color: #8d5649;">{</span>
  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">filterOrder</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> PRE_DECORATION_FILTER_ORDER - 1; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">run before PreDecoration</span>
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">filterType</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> PRE_TYPE;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">shouldFilter</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #268bd2;">RequestContext</span> <span style="color: #6c71c4;">ctx</span> = RequestContext.getCurrentContext<span style="color: #9564bf;">()</span>;
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">!</span>ctx.containsKey<span style="color: #9564bf;">(</span>FORWARD_TO_KEY<span style="color: #9564bf;">)</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">a filter has already forwarded</span>
      &amp;&amp; <span style="color: #268bd2;">!</span>ctx.containsKey<span style="color: #9564bf;">(</span>SERVICE_ID_KEY<span style="color: #9564bf;">)</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">a filter has already determined serviceId</span>
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">run</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #268bd2;">RequestContext</span> <span style="color: #6c71c4;">ctx</span> = RequestContext.getCurrentContext<span style="color: #9564bf;">()</span>;
    <span style="color: #268bd2;">HttpServletRequest</span> <span style="color: #6c71c4;">request</span> = ctx.getRequest<span style="color: #9564bf;">()</span>;
    <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>request.getParameter<span style="color: #24a222;">(</span><span style="color: #2aa198;">"sample"</span><span style="color: #24a222;">)</span> != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">put the serviceId in `RequestContext`</span>
      ctx.put<span style="color: #24a222;">(</span>SERVICE_ID_KEY, request.getParameter<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"foo"</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
    <span style="color: #9564bf;">}</span>
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
路由过滤器（Route Filter）在前置过滤器之后，请求其它服务之前。通常路由过滤
器用来转义请求和回复的数据，下面是一个例子
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">OkHttpRoutingFilter</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">ZuulFilter</span> <span style="color: #8d5649;">{</span>
  <span style="color: #268bd2;">@Autowired</span>
  <span style="color: #859900;">private</span> <span style="color: #268bd2;">ProxyRequestHelper</span> <span style="color: #6c71c4;">helper</span>;

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">filterType</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> ROUTE_TYPE;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">filterOrder</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> SIMPLE_HOST_ROUTING_FILTER_ORDER - 1;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">shouldFilter</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> RequestContext.getCurrentContext<span style="color: #9564bf;">()</span>.getRouteHost<span style="color: #9564bf;">()</span> != <span style="color: #268bd2;">null</span>
      &amp;&amp; RequestContext.getCurrentContext<span style="color: #9564bf;">()</span>.sendZuulResponse<span style="color: #9564bf;">()</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">run</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #268bd2;">OkHttpClient</span> <span style="color: #6c71c4;">httpClient</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">OkHttpClient</span>.<span style="color: #268bd2;">Builder</span><span style="color: #9564bf;">()</span>
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">customize</span>
      .build<span style="color: #9564bf;">()</span>;

    <span style="color: #268bd2;">RequestContext</span> <span style="color: #6c71c4;">context</span> = RequestContext.getCurrentContext<span style="color: #9564bf;">()</span>;
    <span style="color: #268bd2;">HttpServletRequest</span> <span style="color: #6c71c4;">request</span> = context.getRequest<span style="color: #9564bf;">()</span>;

    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">method</span> = request.getMethod<span style="color: #9564bf;">()</span>;

    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">uri</span> = <span style="color: #859900;">this</span>.helper.buildZuulRequestURI<span style="color: #9564bf;">(</span>request<span style="color: #9564bf;">)</span>;

    <span style="color: #268bd2;">Headers</span>.<span style="color: #268bd2;">Builder</span> <span style="color: #6c71c4;">headers</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">Headers</span>.<span style="color: #268bd2;">Builder</span><span style="color: #9564bf;">()</span>;
    <span style="color: #268bd2;">Enumeration</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">headerNames</span> = request.getHeaderNames<span style="color: #9564bf;">()</span>;
    <span style="color: #859900;">while</span> <span style="color: #9564bf;">(</span>headerNames.hasMoreElements<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span> = headerNames.nextElement<span style="color: #24a222;">()</span>;
      <span style="color: #268bd2;">Enumeration</span><span style="color: #24a222;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #6c71c4;">values</span> = request.getHeaders<span style="color: #24a222;">(</span>name<span style="color: #24a222;">)</span>;

      <span style="color: #859900;">while</span> <span style="color: #24a222;">(</span>values.hasMoreElements<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
        <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">value</span> = values.nextElement<span style="color: #ff7f00;">()</span>;
        headers.add<span style="color: #ff7f00;">(</span>name, value<span style="color: #ff7f00;">)</span>;
      <span style="color: #24a222;">}</span>
    <span style="color: #9564bf;">}</span>

    <span style="color: #268bd2;">InputStream</span> <span style="color: #6c71c4;">inputStream</span> = request.getInputStream<span style="color: #9564bf;">()</span>;

    <span style="color: #268bd2;">RequestBody</span> <span style="color: #6c71c4;">requestBody</span> = <span style="color: #268bd2;">null</span>;
    <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>inputStream != <span style="color: #268bd2;">null</span> &amp;&amp; HttpMethod.permitsRequestBody<span style="color: #24a222;">(</span>method<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      <span style="color: #268bd2;">MediaType</span> <span style="color: #6c71c4;">mediaType</span> = <span style="color: #268bd2;">null</span>;
      <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>headers.get<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Content-Type"</span><span style="color: #ff7f00;">)</span> != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
        mediaType = MediaType.parse<span style="color: #ff7f00;">(</span>headers.get<span style="color: #1776b6;">(</span><span style="color: #2aa198;">"Content-Type"</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
      <span style="color: #24a222;">}</span>
      requestBody = RequestBody.create<span style="color: #24a222;">(</span>mediaType, StreamUtils.copyToByteArray<span style="color: #ff7f00;">(</span>inputStream<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
    <span style="color: #9564bf;">}</span>

    <span style="color: #268bd2;">Request</span>.<span style="color: #268bd2;">Builder</span> <span style="color: #6c71c4;">builder</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">Request</span>.<span style="color: #268bd2;">Builder</span><span style="color: #9564bf;">()</span>
      .headers<span style="color: #9564bf;">(</span>headers.build<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>
      .url<span style="color: #9564bf;">(</span>uri<span style="color: #9564bf;">)</span>
      .method<span style="color: #9564bf;">(</span>method, requestBody<span style="color: #9564bf;">)</span>;

    <span style="color: #268bd2;">Response</span> <span style="color: #6c71c4;">response</span> = httpClient.newCall<span style="color: #9564bf;">(</span>builder.build<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>.execute<span style="color: #9564bf;">()</span>;

    <span style="color: #268bd2;">LinkedMultiValueMap</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">responseHeaders</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">LinkedMultiValueMap</span><span style="color: #9564bf;">&lt;&gt;()</span>;

    <span style="color: #859900;">for</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">Map</span>.<span style="color: #268bd2;">Entry</span><span style="color: #24a222;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span><span style="color: #24a222;">&gt;</span> <span style="color: #b58900;">entry</span> : response.headers<span style="color: #24a222;">()</span>.toMultimap<span style="color: #24a222;">()</span>.entrySet<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      responseHeaders.put<span style="color: #24a222;">(</span>entry.getKey<span style="color: #ff7f00;">()</span>, entry.getValue<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
    <span style="color: #9564bf;">}</span>

    <span style="color: #859900;">this</span>.helper.setResponse<span style="color: #9564bf;">(</span>response.code<span style="color: #24a222;">()</span>, response.body<span style="color: #24a222;">()</span>.byteStream<span style="color: #24a222;">()</span>, responseHeaders<span style="color: #9564bf;">)</span>;
    context.setRouteHost<span style="color: #9564bf;">(</span><span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">prevent SimpleHostRoutingFilter from running</span>
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
后置路由器（Post Filter）主要处理回复，下面是一个添加 <code>UUID</code> 和 <code>X-Sample</code>
头的例子
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">AddResponseHeaderFilter</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">ZuulFilter</span> <span style="color: #8d5649;">{</span>
  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">filterType</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> POST_TYPE;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">filterOrder</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> SEND_RESPONSE_FILTER_ORDER - 1;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">shouldFilter</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">true</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Override</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">run</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #268bd2;">RequestContext</span> <span style="color: #6c71c4;">context</span> = RequestContext.getCurrentContext<span style="color: #9564bf;">()</span>;
    <span style="color: #268bd2;">HttpServletResponse</span> <span style="color: #6c71c4;">servletResponse</span> = context.getResponse<span style="color: #9564bf;">()</span>;
    servletResponse.addHeader<span style="color: #9564bf;">(</span><span style="color: #2aa198;">"X-Sample"</span>, UUID.randomUUID<span style="color: #24a222;">()</span>.toString<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org5c6cc59" class="outline-4">
<h4 id="org5c6cc59"><span class="section-number-4">5.2.4</span> Ribbon</h4>
<div class="outline-text-4" id="text-5-2-4">
<p>
Ribbon 是 Netflix 发布的开源项目，主要功能是提供客户端的软件负载均衡算法，将
Netflix 的中间层服务连接在一起。Ribbon 客户端组件提供一系列完善的配置项如连
接超时，重试等。简单的说，就是在配置文件中列出 Load Balancer（简称 LB）后面
所有的机器，Ribbon 会自动的帮助你基于某种规则（如简单轮询，随即连接等）去连
接这些机器。我们也很容易使用 Ribbon 实现自定义的负载均衡算法。
</p>
</div>

<ol class="org-ol">
<li><a id="orgfbdb75d"></a>Ribbon Client<br />
<ol class="org-ol">
<li><a id="org9ef76d6"></a>配置相关文件<br />
<div class="outline-text-6" id="text-5-2-4-1-1">
<p>
<code>pom.xml</code> 添加 <code>spring-cloud-starter-netflix-ribbon</code> 的依赖项
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #93a1a1; font-style: italic;">&lt;!-- </span><span style="color: #93a1a1; font-style: italic;">pom.xml </span><span style="color: #93a1a1; font-style: italic;">--&gt;</span>
&lt;<span style="color: #b58900;">project</span>&gt;
  &lt;<span style="color: #b58900;">dependencies</span>&gt;
    &lt;<span style="color: #b58900;">dependency</span>&gt;
      &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework.cloud&lt;/<span style="color: #b58900;">groupId</span>&gt;
      &lt;<span style="color: #b58900;">artifactId</span>&gt;spring-cloud-starter-netflix-ribbon&lt;/<span style="color: #b58900;">artifactId</span>&gt;
    &lt;/<span style="color: #b58900;">dependency</span>&gt;
  &lt;/<span style="color: #b58900;">dependencies</span>&gt;
&lt;/<span style="color: #b58900;">project</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #6c71c4;">users</span>:
  <span style="color: #6c71c4;">ribbon</span>:
    <span style="color: #6c71c4;">NIWSServerListClassName</span>: com.netflix.loadbalancer.ConfigurationBasedServerList
    <span style="color: #6c71c4;">NFLoadBalancerRuleClassName</span>: com.netflix.loadbalancer.WeightedResponseTimeRule
</pre>
</div>
</div>
</li>

<li><a id="orgd3d6323"></a>使用配置类来进行配置<br />
<div class="outline-text-6" id="text-5-2-4-1-2">
<p>
Ribbon 支持使用配置类来配置，使用 <code>@RibbonClient</code> 注解进行相关配置
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">&#35774;&#32622;&#40664;&#35748;&#35843;&#29992;&#30340;&#37197;&#32622;&#31867;</span>
<span style="color: #268bd2;">@RibbonClients</span><span style="color: #8d5649;">(</span>defaultConfiguration = DefaultRibbonConfig.<span style="color: #859900;">class</span><span style="color: #8d5649;">)</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">RibbonClientDefaultConfigurationTestsConfig</span> <span style="color: #8d5649;">{</span>
  <span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">BazServiceList</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">ConfigurationBasedServerList</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">public</span> <span style="color: #b58900;">BazServiceList</span><span style="color: #9564bf;">(</span><span style="color: #268bd2;">IClientConfig</span> <span style="color: #6c71c4;">config</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      <span style="color: #859900;">super</span>.initWithNiwsConfig<span style="color: #24a222;">(</span>config<span style="color: #24a222;">)</span>;
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">&#23458;&#25143;&#31471;&#37197;&#32622;&#23454;&#29616;&#31867;</span>
<span style="color: #268bd2;">@Configuration</span>
<span style="color: #859900;">class</span> <span style="color: #268bd2;">DefaultRibbonConfig</span> <span style="color: #8d5649;">{</span>

  <span style="color: #268bd2;">@Bean</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">IRule</span> <span style="color: #b58900;">ribbonRule</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span> <span style="color: #859900;">return</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BestAvailableRule</span><span style="color: #9564bf;">()</span>; <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Bean</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">IPing</span> <span style="color: #b58900;">ribbonPing</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span> <span style="color: #859900;">return</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">PingUrl</span><span style="color: #9564bf;">()</span>; <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Bean</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">ServerList</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">Server</span><span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">ribbonServerList</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">IClientConfig</span> <span style="color: #6c71c4;">config</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">RibbonClientDefaultConfigurationTestsConfig</span>.<span style="color: #268bd2;">BazServiceList</span><span style="color: #9564bf;">(</span>config<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #268bd2;">@Bean</span>
  <span style="color: #859900;">public</span> <span style="color: #268bd2;">ServerListSubsetFilter</span> <span style="color: #b58900;">serverListFilter</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #268bd2;">ServerListSubsetFilter</span> <span style="color: #6c71c4;">filter</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ServerListSubsetFilter</span><span style="color: #9564bf;">()</span>;
    <span style="color: #859900;">return</span> filter;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
Ribbon 客户端的配置, 如果不指定会使用默认的实现:
</p>
<ul class="org-ul">
<li><code>IClientConfig</code> 客户端相关配置</li>
<li><code>IRule</code> 定义负载均衡策略</li>
<li><code>IPing</code> 定义如何 ping 目标服务实例来判断是否存活, ribbon 使用单独的线程
每隔一段时间(默认 10s)对本地缓存的 <code>ServerList</code> 做一次检查</li>
<li><code>ServerList</code> 定义如何获取服务实例列表. 两种实现基于配置的
<code>ConfigurationBasedServerList</code> 和基于 Eureka 服务发现的
<code>DiscoveryEnabledNIWSServerList</code></li>
<li><code>ServerListFilter</code> 用来使用期望的特征过滤静态配置动态获得的候选服务实例
列表. 若未提供, 默认使用 <code>ZoneAffinityServerListFilter</code></li>
<li><code>ILoadBalancer</code> 定义了软负载均衡器的操作的接口. 一个典型的负载均衡器至少需
要一组用来做负载均衡的服务实例, 一个标记某个服务实例不在旋转中的方法, 和
对应的方法调用从实例列表中选出某一个服务实例.</li>
<li><code>ServerListUpdater</code> <code>DynamicServerListLoadBalancer</code> 用来更新实例列表的策
略 (推 -&gt; <code>EurekaNotificationServerListUpdater</code>; 拉 -&gt;
<code>PollingServerListUpdater</code>, 默认是拉)</li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>

<div id="outline-container-org0e45760" class="outline-3">
<h3 id="org0e45760"><span class="section-number-3">5.3</span> Spring Cloud Gateway</h3>
<div class="outline-text-3" id="text-5-3">
<p>
<a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway</a> 是 Spring 官方基于 Spring 5.0，Spring Boot 2.0 和 Project
Reactor 等技术开发的网关，Spring Cloud Gateway 旨在为微服务架构提供一种简单而有
效的统一的 API 路由管理方式，官方的手册见 <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.0.M1/">2.2.0.M1</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2019-07-30 Tue 11:11. Created by Jinghui Hu at 2019-07-10 Wed 11:04.</p>
</div>
</body>
</html>
