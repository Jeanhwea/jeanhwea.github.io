<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-08-23 Mon 14:33 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Redis</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Redis</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf658c75">1. Redis 特性</a></li>
<li><a href="#orgf9a1796">2. Redis 使用场景</a></li>
<li><a href="#org833ad41">3. 安装及使用</a></li>
<li><a href="#org6c8afae">4. 内部数据结构</a>
<ul>
<li><a href="#org4f8ab8d">4.1. 简单动态字符串 (Simple Dynamic String)</a></li>
<li><a href="#org1b74d40">4.2. 双端链表 (Doubly Linked List)</a></li>
<li><a href="#orgf67d0f8">4.3. 字典 (Hash Table)</a></li>
<li><a href="#org51b9e08">4.4. 跳跃表 (Skip List)</a></li>
</ul>
</li>
<li><a href="#org200ee72">5. 内存映射数据结构</a>
<ul>
<li><a href="#orgbc3d9c1">5.1. 整数集合 (intset)</a></li>
<li><a href="#orgf5bad4f">5.2. 压缩列表 (ziplist)</a></li>
</ul>
</li>
<li><a href="#org2b8db8f">6. 数据类型</a>
<ul>
<li><a href="#orgecf44a2">6.1. 对象处理机制</a></li>
<li><a href="#orgf213302">6.2. 字符串 String</a></li>
<li><a href="#org0d0e7c1">6.3. 哈希表 Hash</a></li>
<li><a href="#org04d1271">6.4. 列表 List</a></li>
<li><a href="#org3bb9e10">6.5. 集合 Set</a></li>
<li><a href="#org8d230b3">6.6. 有序集合 Zset</a></li>
<li><a href="#org874a051">6.7. 使用示例</a></li>
</ul>
</li>
<li><a href="#org1058a16">7. Redis 缓存相关问题</a></li>
<li><a href="#org989207a">8. 相关连接</a></li>
</ul>
</div>
</div>


<div id="outline-container-orgf658c75" class="outline-2">
<h2 id="orgf658c75"><span class="section-number-2">1</span> Redis 特性</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>速度快
<ul class="org-ul">
<li>内存数据库</li>
<li>I/O 多路复用</li>
<li>协议简单</li>
<li>C 语言开发</li>
</ul></li>
<li>键值对的数据结构服务器
<ul class="org-ul">
<li>key 永远是 String</li>
<li>value 可以是多种类型, 可以通过 <code>object encoding &lt;key&gt;</code> 来查看</li>
</ul></li>
<li>丰富的功能</li>
<li>简单稳定
<ul class="org-ul">
<li>主线程是单线程</li>
</ul></li>
<li>持久化
<ul class="org-ul">
<li>RDB (Redis DataBase)</li>
<li>AOF (Append-Only File)</li>
</ul></li>
<li>主从复制</li>
<li>高可用和分布式转移</li>
<li>客户端语言多</li>
</ol>
</div>
</div>

<div id="outline-container-orgf9a1796" class="outline-2">
<h2 id="orgf9a1796"><span class="section-number-2">2</span> Redis 使用场景</h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li>缓存数据库</li>
<li>排行榜</li>
<li>计数器</li>
<li>社交网络</li>
<li>消息队列</li>
<li>分布式锁</li>
</ol>
</div>
</div>

<div id="outline-container-org833ad41" class="outline-2">
<h2 id="org833ad41"><span class="section-number-2">3</span> 安装及使用</h2>
<div class="outline-text-2" id="text-3">
<p>
下载并安装
</p>
<div class="org-src-container">
<pre class="src src-sh">wget https://download.redis.io/releases/redis-6.2.5.tar.gz
tar xzf redis-6.2.5.tar.gz
<span style="color: #4f97d7;">cd</span> redis-6.2.5
make
</pre>
</div>

<p>
启动 Redis Server
</p>
<div class="org-src-container">
<pre class="src src-sh">src/redis-server
</pre>
</div>

<p>
客户端连接 Redis
</p>
<div class="org-src-container">
<pre class="src src-sh">$ src/redis-cli
redis&gt; set foo bar
OK
redis&gt; get foo
<span style="color: #2d9574;">"bar"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c8afae" class="outline-2">
<h2 id="org6c8afae"><span class="section-number-2">4</span> 内部数据结构</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org4f8ab8d" class="outline-3">
<h3 id="org4f8ab8d"><span class="section-number-3">4.1</span> 简单动态字符串 (Simple Dynamic String)</h3>
<div class="outline-text-3" id="text-4-1">
<ol class="org-ol">
<li><p>
sds 是对 C 语言字符串的扩展, 除了记录底层字符串，还缓存了当前长度
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sds &#30340;&#23454;&#29616;&#32467;&#26500;&#20307;&#19981;&#27490;&#19968;&#20010;&#65292;&#20294;&#26159;&#23450;&#20041;&#30340;&#26041;&#24335;&#31867;&#20284;&#65292;&#21482;&#26159;&#25805;&#20316;&#31995;&#32479;&#20301;&#25968;&#19981;&#19968;&#33268;</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#19979;&#38754;&#20197; sdshdr64 &#20026;&#20363;&#23637;&#31034;</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #4f97d7; font-weight: bold;">__attribute__</span> <span style="color: #8d5649;">(</span><span style="color: #d8241f;">(</span>__packed__<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span> <span style="color: #ce537a; font-weight: bold;">sdshdr64</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">uint64_t</span> <span style="color: #7590db;">len</span>; <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">used </span><span style="color: #93a1a1; font-style: italic;">*/</span>
  <span style="color: #ce537a; font-weight: bold;">uint64_t</span> <span style="color: #7590db;">alloc</span>; <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">excluding the header and null terminator </span><span style="color: #93a1a1; font-style: italic;">*/</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">flags</span>; <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">3 lsb of type, 5 unused bits </span><span style="color: #93a1a1; font-style: italic;">*/</span>
  <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #d8241f;">[]</span>;
<span style="color: #8d5649;">}</span>;
</pre>
</div></li>
<li>Redis 的字符串是 <span class="underline">二进制安全</span></li>
<li>对比 C 语言字符串，提供了如下的特性
<ul class="org-ul">
<li>高效计算字符串长度 <code>strlen</code></li>
<li>高效追加字符串 <code>append</code></li>
</ul></li>
<li>代码实现在 <code>sds.h</code> 和 <code>sds.c</code> 两个文件中</li>
</ol>
</div>
</div>

<div id="outline-container-org1b74d40" class="outline-3">
<h3 id="org1b74d40"><span class="section-number-3">4.2</span> 双端链表 (Doubly Linked List)</h3>
<div class="outline-text-3" id="text-4-2">
<ol class="org-ol">
<li>代码实现在 <code>adlist.h</code> 和 <code>adlist.c</code> 两个文件中</li>
<li><p>
该数据结构的定义如下
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">listNode</span> <span style="color: #8d5649;">{</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35760;&#24405;&#38142;&#34920;&#33410;&#28857;</span>
  <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">listNode</span> *<span style="color: #7590db;">prev</span>;
  <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">listNode</span> *<span style="color: #7590db;">next</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">value</span>;
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">listNode</span>;

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">listIter</span> <span style="color: #8d5649;">{</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35760;&#24405;&#38142;&#34920;&#30340;&#36845;&#20195;&#22120;</span>
  <span style="color: #ce537a; font-weight: bold;">listNode</span> *<span style="color: #7590db;">next</span>;
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">direction</span>;
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">listIter</span>;

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">list</span> <span style="color: #8d5649;">{</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#38142;&#34920;&#30340;&#25968;&#25454;&#32467;&#26500;</span>
  <span style="color: #ce537a; font-weight: bold;">listNode</span> *<span style="color: #7590db;">head</span>;
  <span style="color: #ce537a; font-weight: bold;">listNode</span> *<span style="color: #7590db;">tail</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #d8241f;">(</span>*dup<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #d8241f;">(</span>*free<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span><span style="color: #d8241f;">)</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35760;&#24405;&#38142;&#34920;&#30340;&#31354;&#38386;&#25351;&#38024;</span>
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #d8241f;">(</span>*match<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key</span><span style="color: #d8241f;">)</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21305;&#37197;&#30340;&#20989;&#25968;&#25351;&#38024;</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">len</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#32531;&#23384;&#38142;&#34920;&#38271;&#24230;</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">list</span>;
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-orgf67d0f8" class="outline-3">
<h3 id="orgf67d0f8"><span class="section-number-3">4.3</span> 字典 (Hash Table)</h3>
<div class="outline-text-3" id="text-4-3">
<ol class="org-ol">
<li>代码实现在 <code>dict.h</code> 和 <code>dict.c</code> 两个文件中</li>
<li>字典的实现在 Redis 中有两个作用
<ul class="org-ul">
<li>实现数据库键空间 (Key Space), 例如: <code>DBSIZE</code>, <code>FLUSHDB</code>, <code>RANDOMKEY</code></li>
<li>用作 Hash 类型键的底层实现之一</li>
</ul></li>
<li><p>
该数据结构的定义如下
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dictEntry</span> <span style="color: #8d5649;">{</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#23383;&#20856;&#39033;&#23450;&#20041;</span>
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key</span>;
  <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #d8241f;">{</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">val</span>;
    <span style="color: #ce537a; font-weight: bold;">uint64_t</span> <span style="color: #7590db;">u64</span>;
    <span style="color: #ce537a; font-weight: bold;">int64_t</span> <span style="color: #7590db;">s64</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">d</span>;
  <span style="color: #d8241f;">}</span> <span style="color: #7590db;">v</span>;
  <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dictEntry</span> *<span style="color: #7590db;">next</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25351;&#21521;&#30456;&#24212;&#25968;&#25454;&#39033;</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">dictEntry</span>;

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dictType</span> <span style="color: #8d5649;">{</span>
  uint64_t <span style="color: #d8241f;">(</span>*hashFunction<span style="color: #d8241f;">)(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #d8241f;">(</span>*keyDup<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #d8241f;">(</span>*valDup<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">obj</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #d8241f;">(</span>*keyCompare<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key1</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key2</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #d8241f;">(</span>*keyDestructor<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">key</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #d8241f;">(</span>*valDestructor<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">obj</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #d8241f;">(</span>*expandAllowed<span style="color: #d8241f;">)(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">moreMem</span>, <span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">usedRatio</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">dictType</span>;

<span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">This is our hash table structure. Every dictionary has two of this as we</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * implement incremental rehashing, for the old to the new table. </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#27599;&#20010;&#23383;&#20856;&#30340; entry &#26377;&#20004;&#20010; dictht, &#20027;&#35201;&#30446;&#30340;&#26159;&#21487;&#20197;&#24555;&#36895; rehash</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dictht</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">dictEntry</span> **<span style="color: #7590db;">table</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21704;&#24076;&#26742; bucket</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">size</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25351;&#38024;&#25968;&#32452;&#22823;&#23567; bucket size</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">sizemask</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25351;&#38024;&#25968;&#32452;&#38271;&#24230;&#25513;&#30721;&#65292;&#29992;&#20110;&#35745;&#31639;&#32034;&#24341;&#20540;</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">used</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21704;&#24076;&#34920;&#29616;&#26377;&#33410;&#28857;&#25968;&#37327;</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">dictht</span>;

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dict</span> <span style="color: #8d5649;">{</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#23383;&#20856;&#25968;&#25454;&#31867;&#22411;&#30340;&#23450;&#20041;</span>
  <span style="color: #ce537a; font-weight: bold;">dictType</span> *<span style="color: #7590db;">type</span>;
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>;
  <span style="color: #ce537a; font-weight: bold;">dictht</span> <span style="color: #7590db;">ht</span><span style="color: #d8241f;">[</span>2<span style="color: #d8241f;">]</span>;
  <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">rehashidx</span>; <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">rehashing not in progress if rehashidx == -1 </span><span style="color: #93a1a1; font-style: italic;">*/</span>
  <span style="color: #ce537a; font-weight: bold;">int16_t</span> <span style="color: #7590db;">pauserehash</span>; <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">If &gt;0 rehashing is paused (&lt;0 indicates coding error) </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">dict</span>;

<span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">If safe is set to 1 this is a safe iterator, that means, you can call</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * dictAdd, dictFind, and other functions against the dictionary even while</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * iterating. Otherwise it is a non safe iterator, and only dictNext()</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * should be called while iterating. </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dictIterator</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">dict</span> *<span style="color: #7590db;">d</span>;
  <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">index</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#27491;&#22312;&#36845;&#20195;&#30340;&#25968;&#32452;&#32034;&#24341;</span>
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">table</span>, <span style="color: #7590db;">safe</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">table &#34920;&#31034;&#27491;&#22312;&#36845;&#20195;&#30340;&#21495;&#30721;&#65288;0&#25110;1&#65289;, safe=1, &#34920;&#31034;&#36845;&#20195;&#36807;&#31243;&#20013;&#20462;&#25913;&#21704;&#24076;&#34920;</span>
  <span style="color: #ce537a; font-weight: bold;">dictEntry</span> *<span style="color: #7590db;">entry</span>, *<span style="color: #7590db;">nextEntry</span>;
  <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">unsafe iterator fingerprint for misuse detection. </span><span style="color: #93a1a1; font-style: italic;">*/</span>
  <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">fingerprint</span>;
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">dictIterator</span>;

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">dictScanFunction</span><span style="color: #8d5649;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">dictEntry</span> *<span style="color: #7590db;">de</span><span style="color: #8d5649;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">dictScanBucketFunction</span><span style="color: #8d5649;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">privdata</span>, <span style="color: #ce537a; font-weight: bold;">dictEntry</span> **<span style="color: #7590db;">bucketref</span><span style="color: #8d5649;">)</span>;

<span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">This is the initial size of every hash table </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">DICT_HT_INITIAL_SIZE</span>     4
</pre>
</div></li>
<li>字典的每个项记录两个 <code>dictht</code>
<ul class="org-ul">
<li><code>ht[0]</code> 是字典主要使用的哈希表，</li>
<li><code>ht[1]</code> 则只有在程序对 <code>ht[0]</code> 进行 rehash 时才使用</li>
</ul></li>
<li><code>dictCreate()</code> 创建新的字典
<ul class="org-ul">
<li><code>dictCreate()</code> 创建了 <code>dict</code> 和两个 <code>dictht</code></li>
<li><code>dictCreate()</code> 并没有给 <code>dictht</code> 的 <code>table</code> 分配空间</li>
</ul></li>
<li><code>dictAdd()</code> 表示向字典中添加 <code>dictEntry</code> 数据
<ul class="org-ul">
<li>该过程可能触发 rehash
<ul class="org-ul">
<li>rehash 可以是扩展数据，也可能是收缩数据 (shrink)</li>
</ul></li>
<li>rehash 使用 <code>ht[1]</code> 作为中转节点</li>
<li>为了 hash 效率, Redis 采用渐进式哈希
<ul class="org-ul">
<li><code>_dictRehashStep</code> 用于对数据库字典、以及哈希键的字典进行被动 rehash</li>
<li><code>dictRehashMilliseconds</code> 则由 Redis 服务器常规任务程序执行，用于对数据
库字典进行主动 rehash</li>
</ul></li>
</ul></li>
<li>字典使用 <span class="underline">链地址</span> 解决哈希冲突</li>
</ol>
</div>
</div>

<div id="outline-container-org51b9e08" class="outline-3">
<h3 id="org51b9e08"><span class="section-number-3">4.4</span> 跳跃表 (Skip List)</h3>
<div class="outline-text-3" id="text-4-4">
<ol class="org-ol">
<li>跳跃表主要使用场景就是 <span class="underline">有序集合</span> zset
<ul class="org-ul">
<li>包含的元素数量比较多</li>
<li>元素成员 (member) 是比较长的字符串</li>
</ul></li>
<li><a href="https://www.cl.cam.ac.uk/teaching/0506/Algorithms/skiplists.pdf">跳跃表</a>以有序的方式在 <span class="underline">层次化</span> 的链表中保存元素， 效率和平衡树媲美</li>
<li>查找、删除、添加等操作都可以在 <span class="underline">O(logN)</span> 期望时间下完成</li>
<li>比起平衡树来说， 跳跃表的实现要简单直观得多</li>
<li>跳跃表的构成部分
<ul class="org-ul">
<li>表头 (head): 负责维护跳跃表的节点指针</li>
<li>跳跃表节点: 保存着元素值，以及多个层</li>
<li>层: 保存着指向其他元素的指针
<ul class="org-ul">
<li>高层的指针越过的元素数量大于等于低层的指针</li>
<li>为了提高查找的效率，程序总是从高层先开始访问，然后随着元素值范围的缩小，
慢慢降低层次</li>
</ul></li>
<li>表尾: 全部由 NULL 组成，表示跳跃表的末尾</li>
</ul></li>
<li><p>
跳跃表的定义位于 <code>server.h</code> 中
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">ZSETs use a specialized version of Skiplists </span><span style="color: #93a1a1; font-style: italic;">*/</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">zskiplistNode</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sds</span> <span style="color: #7590db;">ele</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">score</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">zskiplistNode</span> *<span style="color: #7590db;">backward</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21518;&#36864;&#25351;&#38024;</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">zskiplistLevel</span> <span style="color: #d8241f;">{</span> <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#23618;</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">zskiplistNode</span> *<span style="color: #7590db;">forward</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21069;&#36827;&#25351;&#38024;</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">span</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35813;&#23618;&#36328;&#22495;&#30340;&#33410;&#28857;&#25968;&#37327;</span>
    <span style="color: #d8241f;">}</span> <span style="color: #7590db;">level</span><span style="color: #d8241f;">[]</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">level[] &#22312; Redis &#20013;&#26159; 1 &#21040; 32 &#30340;&#38543;&#26426;&#25968;</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">zskiplistNode</span>;

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">zskiplist</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">zskiplistNode</span> *<span style="color: #7590db;">header</span>, *<span style="color: #7590db;">tail</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22836;&#33410;&#28857;&#21644;&#23614;&#33410;&#28857;</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">length</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33410;&#28857;&#25968;&#37327;</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">level</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#30446;&#21069;&#34920;&#20869;&#33410;&#28857;&#30340;&#26368;&#22823;&#23618;&#25968;</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">zskiplist</span>;
</pre>
</div></li>
<li>Redis 在 William Pugh 关于 Skip List 的设计中进行修改，满足自身查询的需求
<ul class="org-ul">
<li>score 值可重复</li>
<li>对比一个元素需要同时检查它的 score 和 member</li>
<li>每个节点带有高度为 1 层的后退指针，用于从表尾方向向表头方向迭代</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org200ee72" class="outline-2">
<h2 id="org200ee72"><span class="section-number-2">5</span> 内存映射数据结构</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgbc3d9c1" class="outline-3">
<h3 id="orgbc3d9c1"><span class="section-number-3">5.1</span> 整数集合 (intset)</h3>
<div class="outline-text-3" id="text-5-1">
<ol class="org-ol">
<li>用于有序、无重复地保存多个整数值，根据元素的值，自动选择该用什么长度的整数
类型来保存元素</li>
<li>intset 的应用范围如下
<ul class="org-ul">
<li>只保存着整数元素</li>
<li>元素的数量不多</li>
</ul></li>
<li><p>
intset 的实习见 <code>intset.c</code> 和 <code>intset.h</code> 中
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">intset</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">encoding</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20445;&#23384;&#25152;&#20351;&#29992;&#31867;&#22411;&#30340;&#38271;&#24230;</span>
  <span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">length</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20803;&#32032;&#20010;&#25968;</span>
  <span style="color: #ce537a; font-weight: bold;">int8_t</span> <span style="color: #7590db;">contents</span><span style="color: #d8241f;">[]</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20803;&#32032;</span>
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">intset</span>;
</pre>
</div></li>
<li><code>contents</code> 数组中的整数位数提升时，需要对整数进行扩充操作，这个扩充过程叫
做 <span class="underline">升级</span> (upgrade)</li>
<li><code>contents</code> 数组不支持降级操作，一旦升级过后即使最大位数的数字被删除了，依
旧使用保持最大位数</li>
</ol>
</div>
</div>

<div id="outline-container-orgf5bad4f" class="outline-3">
<h3 id="orgf5bad4f"><span class="section-number-3">5.2</span> 压缩列表 (ziplist)</h3>
<div class="outline-text-3" id="text-5-2">
<ol class="org-ol">
<li>ziplist 是由一系列特殊编码的内存块构成的列表
<ul class="org-ul">
<li>一个 ziplist 可以包含多个节点 (entry)</li>
<li>每个节点可以保存一个长度受限的字符数组 (不以 <code>\0</code> 结尾的 char 数组) 或者
整数</li>
</ul></li>
<li>哈希键、列表键和有序集合键初始化的底层实现皆采用 ziplist</li>
<li>添加和删除 ziplist 节点有可能会引起连锁更新，因此，添加和删除操作的最坏复
杂度为 <code>O(N^2)</code></li>
<li><p>
ziplist 的典型结构如下，其中存储数据的是 entries
</p>
<div class="org-src-container">
<pre class="src src-text">area        |&lt;---- ziplist header ----&gt;|&lt;----------- entries -------------&gt;|&lt;-end-&gt;|

size          4 bytes  4 bytes  2 bytes    ?        ?        ?        ?     1 byte
            +---------+--------+-------+--------+--------+--------+--------+-------+
component   | zlbytes | zltail | zllen | entry1 | entry2 |  ...   | entryN | zlend |
            +---------+--------+-------+--------+--------+--------+--------+-------+
                                       ^                          ^        ^
address                                |                          |        |
                                ZIPLIST_ENTRY_HEAD                |   ZIPLIST_ENTRY_END
                                                                  |
                                                         ZIPLIST_ENTRY_TAIL
</pre>
</div></li>
<li><p>
ziplist 的 entry 如下
</p>
<div class="org-src-container">
<pre class="src src-text">area        |&lt;------------------- entry --------------------&gt;|

            +------------------+----------+--------+---------+
component   | pre_entry_length | encoding | length | content |
            +------------------+----------+--------+---------+
</pre>
</div></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org2b8db8f" class="outline-2">
<h2 id="org2b8db8f"><span class="section-number-2">6</span> 数据类型</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgecf44a2" class="outline-3">
<h3 id="orgecf44a2"><span class="section-number-3">6.1</span> 对象处理机制</h3>
<div class="outline-text-3" id="text-6-1">
<ol class="org-ol">
<li><p>
对象的类型定义位于 <code>redisObject</code> 结构体
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">redisObject</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #7590db;">type</span>:4; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#31867;&#22411;&#65306;&#23383;&#31526;&#20018;&#65292;&#21704;&#24076;&#34920;&#65292;&#21015;&#34920;&#31561;&#31561;</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #7590db;">encoding</span>:4; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#32534;&#30721;&#26684;&#24335;&#65306;sds, int, hashtable, zipmap, list, ziplist, skiplist</span>
  <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #7590db;">lru</span>:LRU_BITS; <span style="color: #93a1a1; font-style: italic;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">LRU time (relative to global lru_clock) or</span>
<span style="color: #2aa1ae; background-color: #292e34;">                          * LFU data (least significant 8 bits frequency</span>
<span style="color: #2aa1ae; background-color: #292e34;">                          * and most significant 16 bits access time). </span><span style="color: #93a1a1; font-style: italic;">*/</span>
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">refcount</span>; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#24341;&#29992;&#35745;&#25968;</span>
  <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>;
<span style="color: #8d5649;">}</span> <span style="color: #ce537a; font-weight: bold;">robj</span>;
</pre>
</div></li>
<li>对象的内存释放方式是使用引用计数
<ul class="org-ul">
<li>对象初始创建时 <code>refcount</code> 的值被设置成 1</li>
<li>当 <code>refcount</code> 降至 0 后，该 <code>redisObject</code> 将会被释放</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgf213302" class="outline-3">
<h3 id="orgf213302"><span class="section-number-3">6.2</span> 字符串 String</h3>
<div class="outline-text-3" id="text-6-2">
<ol class="org-ol">
<li>字符串默认有如下两种类型
<ul class="org-ul">
<li><code>REDIS_ENCODING_INT</code> 使用 <code>long</code> 类型来保存 <code>long</code> 类型值</li>
<li><code>REDIS_ENCODING_RAW</code> 则使用 <code>sdshdr</code> 结构来如下类型的值
<ul class="org-ul">
<li><code>sds</code> (也即是 <code>char*</code> )</li>
<li><code>long long</code></li>
<li><code>double</code></li>
<li><code>long double</code></li>
</ul></li>
</ul></li>
<li>二进制安全, 可以存储图片和序列化对象, 最多可存储 512M 的数据</li>
<li>get/set/del, 操作单个字符串键的指令</li>
<li>mset 同时设置多个键</li>
<li>incr/decr</li>
<li>strlen/append</li>
</ol>
</div>
</div>

<div id="outline-container-org0d0e7c1" class="outline-3">
<h3 id="org0d0e7c1"><span class="section-number-3">6.3</span> 哈希表 Hash</h3>
<div class="outline-text-3" id="text-6-3">
<ol class="org-ol">
<li>哈希表使用如下两种编码格式
<ul class="org-ul">
<li><code>REDIS_ENCODING_ZIPLIST</code>
<ul class="org-ul">
<li>键和值一同推入压缩列表</li>
<li>形成保存哈希表所需的键-值对结构</li>
</ul></li>
<li><code>REDIS_ENCODING_HT</code> 当出现如下条件时, ziplist 转 hashtable
<ul class="org-ul">
<li>哈希表中某个键或某个值的长度大于 <code>server.hash_max_ziplist_value</code>, 默认
值为 64</li>
<li>压缩列表中的节点数量大于 <code>server.hash_max_ziplist_entries</code>, 默认值为
512</li>
</ul></li>
</ul></li>
<li>操作哈希表的指令 hmset/hget/hgetall</li>
<li>物理存储会在 ziplist 和 hashtable 两种类型中转换</li>
<li>ziplist 比 hashtable 节约空间，默认使用 ziplist</li>
<li>当有需要时，Redis 会自动将 ziplist 转成 hashtable</li>
</ol>
</div>
</div>

<div id="outline-container-org04d1271" class="outline-3">
<h3 id="org04d1271"><span class="section-number-3">6.4</span> 列表 List</h3>
<div class="outline-text-3" id="text-6-4">
<ol class="org-ol">
<li>列表使用如下两种编码格式
<ul class="org-ul">
<li><code>REDIS_ENCODING_ZIPLIST</code>
<ul class="org-ul">
<li>将值添加到压缩列表中</li>
</ul></li>
<li><code>REDIS_ENCODING_LINKEDLIST</code> 当出现如下条件时, ziplist 转 linkedlist
<ul class="org-ul">
<li>哈希表中某个键或某个值的长度大于 <code>server.list_max_ziplist_value</code>, 默认
值为 64</li>
<li>压缩列表中的节点数量大于 <code>server.list_max_ziplist_entries</code>, 默认值为
512</li>
</ul></li>
</ul></li>
<li>列表是一个双向链表, 最多存储 <code>2^32-1</code> 个元素</li>
<li>常见列表操作 lpush/lpop/rpush/rpop</li>
<li>范围查找 lrange key 0 10</li>
<li>llen</li>
</ol>
</div>
</div>

<div id="outline-container-org3bb9e10" class="outline-3">
<h3 id="org3bb9e10"><span class="section-number-3">6.5</span> 集合 Set</h3>
<div class="outline-text-3" id="text-6-5">
<ul class="org-ul">
<li>sadd/smembers</li>
</ul>
</div>
</div>
<div id="outline-container-org8d230b3" class="outline-3">
<h3 id="org8d230b3"><span class="section-number-3">6.6</span> 有序集合 Zset</h3>
<div class="outline-text-3" id="text-6-6">
<ul class="org-ul">
<li>有序的集合类型, 键是不可重复的</li>
<li>zadd</li>
</ul>
</div>
</div>

<div id="outline-container-org874a051" class="outline-3">
<h3 id="org874a051"><span class="section-number-3">6.7</span> 使用示例</h3>
<div class="outline-text-3" id="text-6-7">
<p>
整数操作
</p>
<div class="org-src-container">
<pre class="src src-text">127.0.0.1:6379&gt; flushdb
OK
127.0.0.1:6379&gt; set hello 'world'
OK
127.0.0.1:6379&gt; keys *
1) "hello"
127.0.0.1:6379&gt; get hello
"world"
127.0.0.1:6379&gt; append hello '!'
(integer) 6
127.0.0.1:6379&gt; get hello
"world!"
</pre>
</div>

<p>
计数器
</p>
<div class="org-src-container">
<pre class="src src-text">127.0.0.1:6379&gt; set count 1
OK
127.0.0.1:6379&gt; incr count
(integer) 2
127.0.0.1:6379&gt; get count
"2"
127.0.0.1:6379&gt; incr count
(integer) 3
127.0.0.1:6379&gt;
</pre>
</div>

<p>
哈希使用
</p>
<div class="org-src-container">
<pre class="src src-text">127.0.0.1:6379&gt; flushdb
OK
127.0.0.1:6379&gt; hmset user name zhang age 12
OK
127.0.0.1:6379&gt; hgetall user
1) "name"
2) "zhang"
3) "age"
4) "12"
</pre>
</div>

<p>
集合操作
</p>
<div class="org-src-container">
<pre class="src src-text">127.0.0.1:6379&gt; sadd course math
(integer) 1
127.0.0.1:6379&gt; sadd course chinese
(integer) 1
127.0.0.1:6379&gt; object encoding course
"hashtable"
127.0.0.1:6379&gt; smembers course
1) "math"
2) "chinese"
</pre>
</div>

<p>
获取对象存储类型
</p>
<div class="org-src-container">
<pre class="src src-text">127.0.0.1:6379&gt; keys *
1) "a"
2) "str1"
127.0.0.1:6379&gt; object encoding a
"quicklist"
127.0.0.1:6379&gt; object encoding str1
"embstr"
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1058a16" class="outline-2">
<h2 id="org1058a16"><span class="section-number-2">7</span> Redis 缓存相关问题</h2>
<div class="outline-text-2" id="text-7">
<ol class="org-ol">
<li><b>缓存穿透</b> 指查询一个数据库中不存在的数据
<ul class="org-ul">
<li>容易产生对数据库过大的访问压力导致数据库崩溃</li>
<li>解决方案: 设置缓存过期时间, 即使未查到时设置一个空值</li>
</ul></li>
<li><b>缓存雪崩</b> 指在某一个时间段, 缓存集中失效
<ul class="org-ul">
<li>对数据库产生周期性的压力</li>
<li>解决方案: 对冷数据, 超时设置短一点, 对热数据, 超时设置长一点</li>
</ul></li>
<li><b>缓存击穿</b> 指一个非常热的 Key, 在失效的瞬间大并发量把数据库击穿
<ul class="org-ul">
<li>瞬间并发量高, 直接把数据库打崩溃掉</li>
<li>解决方案: 对于特别大的热 Key, 可以设置永不过期</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org989207a" class="outline-2">
<h2 id="org989207a"><span class="section-number-2">8</span> 相关连接</h2>
<div class="outline-text-2" id="text-8">
<ol class="org-ol">
<li><a href="https://redis.io/">Redis Official Site</a></li>
<li><a href="http://origin.redisbook.com/">Redis 设计与实现（第一版）</a></li>
<li><a href="https://github.com/huangz1990/redisbook">《Redis 设计与实现》第一版的原稿</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-08-23 Mon 14:33. Created by Jinghui Hu at 2021-07-07 Wed 16:51.</p>
</div>
</body>
</html>
