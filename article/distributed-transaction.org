#+TITLE: 分布式事务
#+AUTHOR: Jinghui Hu
#+EMAIL: hujinghui@buaa.edu.cn
#+DATE: <2021-07-28 Wed 08:23:51>
#+HTML_LINK_UP: ../readme.html
#+HTML_LINK_HOME: ../index.html
#+SETUPFILE: ~/.emacs.d/site-lisp/org-html-themes/setup/theme-readtheorg-local.setup
#+TAGS: distributed transaction


* 分布式事务
  分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于
  不同的分布式系统的不同节点之上
  1. 事务参与者 (APP)
     - 前端处理请求的应用
  2. 事务管理器 (TM)
     - 后台协调事务的应用
  3. 资源服务器 (RM)
     - 一般指的是数据库中的数据

* TCC
  1. Try
  2. Commit
  3. Cancel

* 2PC & 3PC
** 2PC (tow-phase-commit)
   参与 2PC 的事务提交的处理流程如下，事务包含
   1. 一个业务发起方 APP
   2. 一个事务管理器 TM
   3. 三个资源管理器 RM
   #+BEGIN_SRC text
     [APP] ->[  TM  ]-> [RM_1]
               |  |
               |  +---> [RM_2]
               |
               +------> [RM_3]
   #+END_SRC

   1. Prepare 阶段
      - APP 向 TM 发送请求
      - TM 向所有参与的 RM 发送预请求，RM 需要报告能否执行操作
        + 一般来说，RM 就是打开本地事务，执行到待提交的阶段
        + 然后反馈能否成功执行事务
   2. Commit 阶段
      - TM 接收所有 RM 的报告
      - TM 接收到所有的报告，如果所有 RM 表示可以成功执行
        + TM 发送全局提交 (Global Commit) 信号
        + 所有 RM 提交事务
      - TM 接收到所有的报告，如果有一个 RM 表示不能成功执行
        + TM 发送全局回滚 (Global Commit) 信号
        + 所有 RM 回滚事务

** 3PC
   1. CanCommit 阶段
   2. PreCommit 阶段
   3. doCommit 阶段
