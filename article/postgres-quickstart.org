#+TITLE: Postgres 快速使用
#+AUTHOR: Jinghui Hu
#+EMAIL: hujinghui@buaa.edu.cn
#+DATE: <2019-06-16 Sun>
#+TAGS: postgres sql


* 常用命令速查

** 查看数据库基本信息
   #+BEGIN_SRC sql
     -- 查看所有用户列表:
     SELECT rolname FROM pg_roles;
     -- 查看当前用户:
     SELECT current_user;
     -- 查看当前用户权限
     \du
     -- 查看所有数据库列表
     \l
     -- 查看当前数据库
     SELECT current_database();
     -- 查看当前数据库的所有表
     \dt
     -- 查看函数列表
     \df <schema>
    #+END_SRC
** 数据库相关的操作命令
    #+BEGIN_SRC sql
      -- 连接数据库
      \c <database_name>
      -- 创建数据库
      CREATE DATABASE <database_name> WITH OWNER <username>;
      -- 删除数据库
      DROP DATABASE IF EXISTS <database_name>;
      -- 重命名数据库
      ALTER DATABASE <old_name> RENAME TO <new_name>;
    #+END_SRC
** 用户信息相关的操作命令
    #+BEGIN_SRC sql
      -- 查看所有用户
      SELECT rolname FROM pg_roles;
      -- 创建用户
      CREATE USER <user_name> WITH PASSWORD '<password>';
      -- 删除用户
      DROP USER IF EXISTS <user_name>;
      -- 修改用户密码
      ALTER ROLE <user_name> WITH PASSWORD '<password>';
    #+END_SRC
** 表相关的操作命令
    #+BEGIN_SRC sql
      -- 查看所有表
      \dt
      -- 查看全局的表
      \dt *.*
      -- 创建表
      CREATE TABLE <table_name> (
        <column_name> <column_type>,
        <column_name> <column_type>,
        <column_name> <column_type>
      );

      -- 创建用户表的例子
      CREATE SEQUENCE global_id
        INCREMENT BY 1
        MINVALUE 1 NO MAXVALUE
        START WITH 9999;

      CREATE TABLE users (
        id INT PRIMARY KEY NOT NULL DEFAULT NEXTVAL('global_id'),
        code VARCHAR(32), -- data is invalid when code is NULL
        created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        username VARCHAR(64) NOT NULL,
        nickname VARCHAR(64),
        password VARCHAR(128),
        birthday DATE,
        CONSTRAINT unique_username UNIQUE (username)
      );
      ALTER TABLE users OWNER TO <tabowner_name>;
      COMMENT ON TABLE users IS '用户表';
      COMMENT ON COLUMN users.username IS '用户登录的用户名';
      COMMENT ON COLUMN users.nickname IS '用户昵称';

      -- 删除表
      DROP TABLE IF EXISTS <table_name> CASCADE;
    #+END_SRC
** 数据备份与还原
    #+BEGIN_SRC shell
      # 备份数据库
      pg_dump <database_name>
      # 还原数据库
      pg_restore -d <database_name> -a <file_pathway>
    #+END_SRC
    #+BEGIN_SRC sql
      -- 导出 csv 文件
      \copy <table_name> TO '<file_path>' CSV;
      -- 导入 csv 文件
      \copy <table_name> FROM '<file_path>' CSV;
    #+END_SRC
* 小技巧
** 竖行显示查询结果
   有时候查看的行数比较多，不方便一次性浏览，可以使用 ~\x~ 来开启竖行显示，这样
   结果更加易读。
   #+BEGIN_SRC text
     pgdb=> select * from users;
        id   | code |         created_at         |         updated_at         | username  |  nickname  | password |  birthday
     --------+------+----------------------------+----------------------------+-----------+------------+----------+------------
      100001 |      | 2019-06-20 20:05:56.214153 | 2019-06-20 20:05:56.214153 | admin     | SuperUser  |          |
      100000 |      | 2019-06-20 20:05:56.116695 | 2019-06-22 22:21:48.667    | hujinghui | Jinghui Hu |          | 1992-06-15
     (2 rows)

     pgdb=> \x
     Expanded display is on.

     pgdb=> select * from users;
     -[ RECORD 1 ]--------------------------
     id         | 100001
     code       |
     created_at | 2019-06-20 20:05:56.214153
     updated_at | 2019-06-20 20:05:56.214153
     username   | admin
     nickname   | SuperUser
     password   |
     birthday   |
     -[ RECORD 2 ]--------------------------
     id         | 100000
     code       |
     created_at | 2019-06-20 20:05:56.116695
     updated_at | 2019-06-22 22:21:48.667
     username   | hujinghui
     nickname   | Jinghui Hu
     password   |
     birthday   | 1992-06-15
   #+END_SRC
** 查看表结构及注释
   psql 的可以使用 ~\d~ 显示一个表的结构，如果需要显示每行的注释，可以使用 ~\d+~
   选项。
   #+BEGIN_SRC text
     pgdb=> \d students;
                                       Table "public.students"
        Column   |            Type             |                    Modifiers
     ------------+-----------------------------+-------------------------------------------------
      id         | integer                     | not null default nextval('global_id'::regclass)
      code       | character varying(32)       |
      created_at | timestamp without time zone | not null default now()
      updated_at | timestamp without time zone | not null default now()
      name       | character varying(64)       | not null
      gender     | character varying(1)        |
      phone      | character varying(16)       |
      joined_at  | date                        |
     Indexes:
         "students_pkey" PRIMARY KEY, btree (id)
     Referenced by:
         TABLE "course_students" CONSTRAINT "course_students_student_id_fkey" FOREIGN KEY (student_id) REFERENCES students(id)
         TABLE "scores" CONSTRAINT "scores_student_id_fkey" FOREIGN KEY (student_id) REFERENCES students(id)

     pgdb=> \d+ students;
                                                                Table "public.students"
        Column   |            Type             |                    Modifiers                    | Storage  | Stats target |     Description
     ------------+-----------------------------+-------------------------------------------------+----------+--------------+----------------------
      id         | integer                     | not null default nextval('global_id'::regclass) | plain    |              |
      code       | character varying(32)       |                                                 | extended |              |
      created_at | timestamp without time zone | not null default now()                          | plain    |              |
      updated_at | timestamp without time zone | not null default now()                          | plain    |              |
      name       | character varying(64)       | not null                                        | extended |              |
      gender     | character varying(1)        |                                                 | extended |              | M = Male, F = Female
      phone      | character varying(16)       |                                                 | extended |              |
      joined_at  | date                        |                                                 | plain    |              |
     Indexes:
         "students_pkey" PRIMARY KEY, btree (id)
     Referenced by:
         TABLE "course_students" CONSTRAINT "course_students_student_id_fkey" FOREIGN KEY (student_id) REFERENCES students(id)
         TABLE "scores" CONSTRAINT "scores_student_id_fkey" FOREIGN KEY (student_id) REFERENCES students(id)
   #+END_SRC
