#+TITLE: 使用 dot 画图工具
#+AUTHOR: Jinghui Hu
#+EMAIL: hujinghui@buaa.edu.cn
#+DATE: <2019-07-12 Fri 23:58:24>
#+HTML_LINK_UP: ../readme.html
#+HTML_LINK_HOME: ../index.html
#+TAGS: dot graphviz graph cli


* Graphviz 画图工具和 dot 语言
  Graphviz 是一个由 AT&T 实验室启动的开源工具包，用于绘制 dot 语言脚本描述的图形。
  类似微软的 visio，但是他和 visio 也有很大的不同，他是用代码绘图的，使用一种名
  为 dot 的语言绘图，对于绘制复杂的流程图，类图等非常好用。 这种设计使得用户更关
  注于逻辑关系，实现 "所思即所得"。Graphviz 的自动布局功能，无需人为干预就可以做
  到 "最小化连线交叉"。

* 基本画图
  dot 可以生成 GIF, PNG, SVG, PDF 和 PostScript 格式的图片。dot 语言画图的类别可
  以分成以下两类：
  - ~digraph~ 有向图
  - ~graph~ 无向图

** 图的基本元素
   每种图中包含以下常见要素：
   - ~node~ 节点
   - ~edge~ 边
   - ~subgraph~ 子图
   - ~attr~ 属性

   #+BEGIN_SRC dot
     digraph G {
       main -> parse -> execute;
       main -> init;
       main -> cleanup;
       execute -> make_string;
       execute -> printf
       init -> make_string;
       main -> printf;
       execute -> compare;
     }
   #+END_SRC

   - dot 语言中每个变量表示一个节点
   - =->= 表示连接边
   - 使用 dot 命令编译生成 PNG 图片，示例如下：
   #+BEGIN_SRC sh
     dot -Tpng fig1.dot -o fig1.png
   #+END_SRC

   [[file:../static/image/2019/07/fig1.png]]

** 图的属性
   在绘制图的时候一般需要根据需求来设置节点和边的属性，如下例子中
   #+BEGIN_SRC dot
     digraph G {
       size ="4,4";
       main [shape=box];   /* this is a comment */
       main -> parse [weight=8];
       parse -> execute;
       main -> init [style=dotted];
       main -> cleanup;
       execute -> { make_string; printf}
       init -> make_string;
       edge [color=red];   // so is this
       main -> printf [style=bold,label="100 times"];
       make_string [label="make a\nstring"];
       node [shape=box,style=filled,color=".7 .3 1.0"];
       execute -> compare;
     }
   #+END_SRC

   - ~size~ 设置图片大小为 4,4（英尺）
   - 节点和边的属性写在方括号里
   - ~shape=box~ 设置节点形状为方框
   - 花括号表示一个节点连接多个节点 ~execute -> { make_string; printf}~ 等同于
     ~execute -> make_string; execute -> printf;~
   - 节点和边的文字可以使用 ~label~ 属性来设置

   [[file:../static/image/2019/07/fig2.png]]

* 图的属性介绍
  主要的属性可以参考[[http://www.graphviz.org/doc/info/attrs.html][attrs]]。

** 节点形状
   节点属性默认设置为 ~shape=ellipse, width=.75, height=.5~ 并且使用节点的名字作
   为其 label 。节点的形状见 [[http://www.graphviz.org/doc/info/shapes.html][shapes]] 。

   [[file:../static/image/2019/07/fig3.png]]

   - 节点的形状分为两类 =polygon-based= 和 =record-based=
   - 除了 ~record~ 和 ~Mrecord~ 属于 =record-based= 以外，其它都是
     =polygon-based=
   - =polygon-based= 一般直接作为形状
   - =record-based= 可以用于递归定义

   #+BEGIN_SRC dot
     digraph structs {
       node [shape=record];
       struct1 [label="<f0> left|<f1> mid\ dle|<f2> right"];
       struct2 [label="<f0> one|<f1> two"];
       struct3 [label="hello\nworld |{ b |{c|<here> d|e}| f}| g | h"];
       struct1:f1 -> struct2:f0;
       struct1:f2 -> struct3:here;
     }
   #+END_SRC

   - =|= 用来分隔域
   - =<>= 里面是 field_id
   - label 里面的空格和换行符需要转义

   [[file:../static/image/2019/07/fig4.png]]

** 标签文字
   标签文字默认是
   - 换行需要转义，其中 =\n=, =\l=, =\r= 分别表示换行居中，靠左和靠右。
   - graph 和 cluster subgraph 也有 label，默认在图片正下方， ~labelloc=t~ 将
     label 移到图的上方， ~labelloc=b~ 将图片移到下面。 ~labeljust=r~ 文字靠右。
   - 字体默认是 "Times-Roman 14", 可以设置 ~fontname~, ~fontsize~ 和 ~fontcolor~
     这些属性。例如： ~fontname=Helvetica~
   - 边可以设置两端的 label， ~headlabel~ 和 ~taillabel~ ，以及 label 的字体
     ~labelfontname~, ~labelfontsize~ 和 ~labelfontcolor~ ，另外如果有需求也可以
     设置 ~labelangle~ 和 ~labeldistance~

** HTML 类型标签
   #+BEGIN_SRC dot
     digraph structs {
       node [shape=plaintext]
       struct1 [label=<
                <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0">
                <TR><TD>left</TD><TD PORT="f1">mid dle</TD><TD PORT="f2">right</TD></TR>
                </TABLE>>];
       struct2 [label=<
                <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0">
                <TR><TD PORT="f0">one</TD><TD>two</TD></TR>
                </TABLE>>];
       struct3 [label=<
                <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
                <TR>
                <TD ROWSPAN="3">hello<BR/>world</TD>
                <TD COLSPAN="3">b</TD>
                <TD ROWSPAN="3">g</TD>
                <TD ROWSPAN="3">h</TD>
                </TR>
                <TR>
                <TD>c</TD><TD PORT="here">d</TD><TD>e</TD>
                </TR>
                <TR>
                <TD COLSPAN="3">f</TD>
                </TR>
                </TABLE>>];
       struct1:f1 -> struct2:f0;
       struct1:f2 -> struct3:here;
     }
   #+END_SRC
   - =<TD>= 的 PORT 表示单元格的名称

   [[file:../static/image/2019/07/fig5.png]]
** 节点和边的样式
   节点和边的颜色使用 ~color~ 属性来设置， ~color~ 接收以下几种类型的值：
   - X11 的颜色名称，例如： red, yellow, green
   - 0 到 1 之间表示 HSB 的三元组，例如： "0.83, 0.48, 0.85"
   - 十六进制的 RGB 值，例如： "#DA70D6"

   通过 ~fontcolor~ 和 ~fontname~ 设置字体颜色，例如： ~fontcolor=white;~
   ~fontname=Helvetica;~ 。样式 ~style~ 也有预定义的值，线条属性包括： solid,
   dashed, dotted, bold 和 invis；节点属性包括：filled, diagonals 和 rounded。

   边有 ~dir~ 属性来设置箭头方向，包括：forward, back, both 和 none。还有一些可
   以控制箭头的头和尾样式的属性 ~arrowhead~ 和 ~arrowtail~ 。箭头样式包括：
   normal, inv, dot, invdot, odot, invodot, empty 和 none 等等。 ~arrowsize~ 设
   置箭头的长度，例如 ~arrowsize=2.0~ 可以将箭头长度扩大两倍。

   #+BEGIN_SRC dot
     digraph fig6 {
       mynode [color=red; style=diagonals];
       b[style="bold,filled"];
       c[shape=box,style="bold,filled",color="#24a222",fillcolor="#ff7f00"fontcolor=white];
       d[shape=Mrecord,style=filled,color="red",fillcolor="#666666"fontcolor=white];
       a -> b [arrowhead=dot];
       a -> c [arrowhead=vee; arrowsize=2];
       a -> d [dir=back, arrowtail=empty];
     }
   #+END_SRC

   [[file:../static/image/2019/07/fig6.png]]
