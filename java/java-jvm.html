<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-10-16 Sat 09:40 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JVM 知识点</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">JVM 知识点</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgbea7b48">1. 基础知识</a>
<ul>
<li><a href="#org9d3f814">1.1. JVM 运行内存的分类</a></li>
<li><a href="#org210de8b">1.2. Java 内存堆和栈区别</a></li>
<li><a href="#org921c87c">1.3. Java 四引用</a></li>
<li><a href="#orgb4630f8">1.4. GC 回收机制</a></li>
<li><a href="#orgde6583a">1.5. GC 标记对象的死活</a></li>
<li><a href="#orgfa9e06f">1.6. GC 回收算法</a></li>
<li><a href="#org581c85b">1.7. MinorGC 和 FullGC</a></li>
<li><a href="#orgf3f8351">1.8. 内存分配与回收策略</a></li>
<li><a href="#org850d36b">1.9. GC 垃圾收集器</a></li>
<li><a href="#org368c9fb">1.10. 内存泄漏的几种情形</a></li>
<li><a href="#org0ae0878">1.11. Java 类加载机制</a></li>
<li><a href="#org4f7b260">1.12. 引起类加载操作的五个行为</a></li>
<li><a href="#org7132ce7">1.13. Java 对象创建时机</a></li>
</ul>
</li>
<li><a href="#org09fa631">2. 实践案例</a>
<ul>
<li><a href="#orgabdadaf">2.1. JVM 调优参数</a></li>
<li><a href="#orgb4b89b6">2.2. JDK 调试工具</a>
<ul>
<li><a href="#orgefd2af5">2.2.1. jps</a></li>
<li><a href="#org1c8897e">2.2.2. jstat</a></li>
<li><a href="#org37a54fb">2.2.3. jmap</a></li>
<li><a href="#org1f8b27c">2.2.4. jstack</a></li>
<li><a href="#orgb64fe40">2.2.5. arthas</a></li>
<li><a href="#org6d60285">2.2.6. Eclipse Memory Analyzer</a></li>
</ul>
</li>
<li><a href="#org4266804">2.3. 逃逸分析</a></li>
<li><a href="#orgf60fbb0">2.4. JDBC 知识点</a></li>
</ul>
</li>
<li><a href="#orge3b9764">3. 反射</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgbea7b48" class="outline-2">
<h2 id="orgbea7b48"><span class="section-number-2">1</span> 基础知识</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org9d3f814" class="outline-3">
<h3 id="org9d3f814"><span class="section-number-3">1.1</span> JVM 运行内存的分类</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li><b>程序计数器</b> 当前线程所执行的字节码的行号指示器，用于记录正在执行的虚拟机
字节指令地址，线程私有 注: 如果正在执行的是 Native 方法，计数器值则为空</li>
<li><b>Java 线程栈</b> 存放基本数据类型、对象的引用、方法出口等，线程私有
<ul class="org-ul">
<li>局部变量表</li>
<li>操作数栈</li>
<li>动态链接</li>
<li>方法出口地址</li>
</ul></li>
<li><b>本地方法栈</b> 和线程栈相似，只不过它服务于 Native 方法，线程私有</li>
<li><b>Java 堆</b> Java 内存最大的一块，所有对象实例、数组都存放在 Java 堆，GC 回收
的地方，线程共享</li>
<li><b>元空间</b> 存放已被加载的类信息、常量、静态变量、即时编译器编译后的代码数据
等。（即永久代），回收目标主要是常量池的回收和类型的卸载，各线程共享
<ul class="org-ul">
<li>元空间是 JDK 1.7 之前叫方法区</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org210de8b" class="outline-3">
<h3 id="org210de8b"><span class="section-number-3">1.2</span> Java 内存堆和栈区别</h3>
<div class="outline-text-3" id="text-1-2">
<ol class="org-ol">
<li>栈内存用来存储基本类型的变量和对象的引用变量，堆内存用来存储 Java 中的对象，
无论是成员变量，局部变量，还是类变量，它们指向的对象都存储在堆内存中</li>
<li>栈内存归属于单个线程，每个线程都会有一个栈内存，其存储的变量只能在其所属线
程中可见，即栈内存可以理解成线程的私有内存，堆内存中的对象对所有线程可见。
堆内存中的对象可以被所有线程访问</li>
<li>如果栈内存没有可用的空间存储方法调用和局部变量，JVM 会抛出
<code>java.lang.StackOverFlowError</code>, 如果是堆内存没有可用的空间存储生成的对象，
JVM 会抛出 <code>java.lang.OutOfMemoryError</code></li>
<li>栈的内存要远远小于堆内存，如果你使用递归的话，那么你的栈很快就会充满,
<ul class="org-ul">
<li><code>-Xms&lt;size&gt;</code> set initial Java heap size</li>
<li><code>-Xmx&lt;size&gt;</code> set maximum Java heap size</li>
<li><code>-Xss&lt;size&gt;</code> set java thread stack size</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org921c87c" class="outline-3">
<h3 id="org921c87c"><span class="section-number-3">1.3</span> Java 四引用</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li><b>强引用</b> （StrongReference）强引用是使用最普遍的引用。如果一个对象具有强引
用，那垃圾回收器绝不会回收它。当内存空间不足，Java 虚拟机宁愿抛出
<code>OutOfMemoryError</code> 错误，使程序异常终止，也不会靠随意回收具有强引用的对象
来解决内存不足的问题</li>
<li><b>软引用</b> （SoftReference） 如果内存空间不足了，就会回收这些对象的内存。只
要垃圾回收器没有回收它，软引用可以和一个引用队列（ReferenceQueue）联合使用，
如果软引用所引用的对象被垃圾回收器回收，Java 虚拟机就会把这个软引用加入到
与之关联的引用队列中</li>
<li><b>弱引用</b> （WeakReference） 弱引用与软引用的区别在于: 只具有弱引用的对象拥
有更短暂的生命周期。在垃圾回收器线程扫描它所管辖的内存区域的过程中，一旦发
现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。弱引用
可以和一个引用队列（ReferenceQueue）联合使用，如果弱引用所引用的对象被垃圾
回收，Java 虚拟机就会把这个弱引用加入到与之关联的引用队列中</li>
<li><b>虚引用</b> （PhantomReference）虚引用在任何时候都可能被垃圾回收器回收，主要
用来跟踪对象被垃圾回收器回收的活动，被回收时会收到一个系统通知。虚引用与软
引用和弱引用的一个区别在于: 虚引用必须和引用队列 （ReferenceQueue）联合使
用。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的
内存之前，把这个虚引用加入到与之关联的引用队列中</li>
</ol>
</div>
</div>

<div id="outline-container-orgb4630f8" class="outline-3">
<h3 id="orgb4630f8"><span class="section-number-3">1.4</span> GC 回收机制</h3>
<div class="outline-text-3" id="text-1-4">
<ol class="org-ol">
<li>Java 中对象是采用 <code>new</code> 或者反射的方法创建的，这些对象的创建都是在堆（Heap）
中分配的，所有对象的回收都是由 Java 虚拟机通过垃圾回收机制完成的。GC 为了
能够正确释放对象，会监控每个对象的运行状况，对他们的申请、引用、被引用、赋
值等状 况进行监控</li>
<li>Java 程序员不用担心内存管理，因为垃圾收集器会自动进行管理</li>
<li>可以调用下面的方法之一 <code>System.gc()</code> 或 <code>Runtime.getRuntime().gc()</code> 但 JVM
可以屏蔽掉显示的垃圾回收调用</li>
</ol>
</div>
</div>

<div id="outline-container-orgde6583a" class="outline-3">
<h3 id="orgde6583a"><span class="section-number-3">1.5</span> GC 标记对象的死活</h3>
<div class="outline-text-3" id="text-1-5">
<ol class="org-ol">
<li><b>引用计数法</b> 给对象添加一个引用计数器,没当被引用的时候,计数器的值就加一。
引用失效的时候减一,当计数器的值为 0 的时候就表示改对象可以被 GC 回收了，弊
端: <code>A-&gt;B,B-&gt;A</code>, 那么 AB 将永远不会被回收了。也就是引用有环的情况</li>
<li><b>根搜索算法</b> (可达性算法) GC Roots Tracing: 通过一个叫 GC Roots 的对象作为
起点,从这些结点开始向下搜索,搜索所走过的路径称为引用链,当一个对象没有与任
何的引用链相连的时候则改对象就可以被。 GC 回收回收了 Roots 包括: Java 虚拟
机栈中引用的对象,本地方法栈中引用的对象,方法区中常量引用的对象,方法区中静
态属性引用的对象在 Java 语言里，可作为 GC Roots 的对象包括以下几种:
<ul class="org-ul">
<li>虚拟机栈（栈帧中的本地变量表）中的引用的对象</li>
<li>方法区中的类静态属性引用的对象</li>
<li>方法区中的常量引用的对象</li>
<li>本地方法栈中 JNI(即一般说的 Native 方法)的引用的对象</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgfa9e06f" class="outline-3">
<h3 id="orgfa9e06f"><span class="section-number-3">1.6</span> GC 回收算法</h3>
<div class="outline-text-3" id="text-1-6">
<ol class="org-ol">
<li><b>标记-清除法</b>: 标记出没有用的对象，然后一个一个回收掉
<ul class="org-ul">
<li>缺点: 标记和 清除两个过程效率不高，产生内存碎片导致需要分配较大对象时无
法找到足够的连续内存而需要触发一次 GC 操作</li>
</ul></li>
<li><b>复制回收算法</b>: 按照容量划分二个大小相等的内存区域，当一块用完的时候将活着
的对象复制到另一块上，然后再把已使用的内存空间一次清理掉
<ul class="org-ul">
<li>缺点: 将内存缩小为了原来的一半</li>
</ul></li>
<li><b>标记-整理法</b>: 标记出没有用的对象，让所有存活的对象都向一端移动，然后直接
清除掉端边界以外的内
<ul class="org-ul">
<li>优点: 解决了标记-清除算法导致的内存碎片问题和在存活率较高时复制算法效率
低的问题</li>
</ul></li>
<li><b>分代收集法</b>: 根据对象存活周期的不同将内存划分为几块，一般是新生代和老年代，
新生代基本采用复制算法，老年代采用标记整理算法</li>
</ol>
</div>
</div>

<div id="outline-container-org581c85b" class="outline-3">
<h3 id="org581c85b"><span class="section-number-3">1.7</span> MinorGC 和 FullGC</h3>
<div class="outline-text-3" id="text-1-7">
<ol class="org-ol">
<li><b>Minor GC</b> 通常发生在新生代的 Eden 区，在这个区的对象生存期短，往往发生 GC
的频率较高，回收速度比较快，一般采用复制回收算法</li>
<li><b>Full GC/Major GC</b> 发生在老年代，一般情况下，触发老年代 GC 的时候不会触发
Minor GC，所采用的是标记-清除算法</li>
</ol>
</div>
</div>

<div id="outline-container-orgf3f8351" class="outline-3">
<h3 id="orgf3f8351"><span class="section-number-3">1.8</span> 内存分配与回收策略</h3>
<div class="outline-text-3" id="text-1-8">
<ol class="org-ol">
<li>结构（堆大小 = 新生代(1/3) + 老年代(2/3)）:
<ul class="org-ul">
<li><b>新生代</b>: 初始对象，生命周期短, <code>Eden:s0:s1 = 8:1:1</code></li>
<li><b>老年代</b>: 长时间存在的对象</li>
</ul></li>
<li>一般小型的对象都会在 Eden 区上分配，如果 Eden 区无法分配，那么尝试把活着的
对象放到 survivor0 中去（ <code>Minor GC</code> ）
<ul class="org-ul">
<li>如果 survivor0 可以放入，那么放入之后清除 Eden 区</li>
<li>如果 survivor0 不可以放入，那么尝试把 Eden 和 survivor0 的存活对象放到
survivor1 中
<ul class="org-ul">
<li>如果 survivor1 可以放入，那么放入 survivor1 之后清除 Eden 和 survivor0，
之后再把 survivor1 中的对象复制到 survivor0 中，保持 survivor1 一直为
空。</li>
<li>如果 survivor1 不可以放入，那么直接把它们放入到老年代中，并清除 Eden
和 survivor0，这个过程也称为 <b>分配担保</b> （ <code>Full GC</code> ）</li>
</ul></li>
</ul></li>
<li>大对象、长期存活 (年龄 15 的对象, CMS 收集器默认 6 岁) 的对象则直接进入老
年代</li>
<li>动态对象年龄判定，当进入一批进入 survivor0 对象大小大于等于 survivor0 总内
存 50% 时会直接进入老年代 (可通过 <code>-XX:TargetSurvivorRatio</code> 控制 )</li>
<li>空间分配担保，Full GC</li>
</ol>
</div>
</div>

<div id="outline-container-org850d36b" class="outline-3">
<h3 id="org850d36b"><span class="section-number-3">1.9</span> GC 垃圾收集器</h3>
<div class="outline-text-3" id="text-1-9">
<ol class="org-ol">
<li>年轻代常见垃圾收集器
<ol class="org-ol">
<li>Serial New 收集器是针对新生代的收集器，
<ul class="org-ul">
<li>采用的是复制算法</li>
<li>每次收集使用单线程来做 GC 操作</li>
</ul></li>
<li>Parallel New 收集器，是  SN 收集器的多线程版本
<ul class="org-ul">
<li>使用复制算法</li>
<li>每次收集使用多线程并行来做 GC 操作</li>
</ul></li>
<li>Parallel Scavenge 收集器，针对新生代，采用复制收集算法
<ul class="org-ul">
<li>提供了参数 <code>-XX:+UseAdaptiveSizePolicy</code>, 打开参数后，就不需要手工指定
新生代的大小（-Xmn）, Eden 和 Survivor 区的比例 <code>-XX:SurvivorRatio</code>,
晋升老年代对象年龄 <code>-XX:PretenureSizeThreshold</code> 等细节参数</li>
<li>吞吐量高 虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些
参数以提供最合适的停顿时间或者最大的吞吐量</li>
</ul></li>
</ol></li>
<li>老年代常见垃圾收集器
<ol class="org-ol">
<li>Serial Old 收集器，老年代采用标记清理，一般配合年轻代 SN 收集器使用</li>
<li>CMS 收集器，基于标记清理，目的是 <code>减少单次 GC的响应时间</code>, 一般配合年轻
代 PN 收集器一起使用
<ol class="org-ol">
<li>初次标记（触发 STW），仅标记 GC Roots 直接引用对象，耗时短</li>
<li>并发标记（不 STW），多线程标记待回收的对象，耗时长</li>
<li>重新标记（触发 STW, 修正初次标记），并发标记因为没有 STW, 可能产生错
误标记，这里修正这些错误</li>
<li>并发清理</li>
</ol></li>
<li>Parallel Old 收集器，针对老年代，标记整理，一般配合年轻代 PS 收集使用</li>
</ol></li>
<li>G1 收集器(JDK): 整体上是基于标记清理，局部采用复制
<ol class="org-ol">
<li>标记成 Region 的网格区域</li>
<li>E, S, O 分片存在不同 Region</li>
</ol></li>
<li>综上: 新生代基本采用复制算法，老年代采用标记整理算法。CMS 采用标记清理</li>
</ol>
</div>
</div>

<div id="outline-container-org368c9fb" class="outline-3">
<h3 id="org368c9fb"><span class="section-number-3">1.10</span> 内存泄漏的几种情形</h3>
<div class="outline-text-3" id="text-1-10">
<ol class="org-ol">
<li><b>静态集合类</b>: 如 HashMap、LinkedList 等等
<ul class="org-ul">
<li>如果这些容器为静态的，那么它们的生命周期与程序一致，则容器中的对象在程序
结束之前将不能被释放</li>
<li>长生命周期的对象持有短生命周期对象的引用，尽管短生命周期的</li>
<li>对象不再使用，但是因为长生命周期对象持有它的引用而导致不能被回收</li>
</ul></li>
<li><b>各种连接不释放</b>: 如数据库连接、网络连接和 IO 连接等
<ul class="org-ul">
<li>在对数据库进行操作的过程中，首先需要建立与数据库的连接，当不再使用时，需
要调用 <code>close()</code> 方法来释放与数据库的 连接。只有连接被关闭后，垃圾回收器
才会回收对应的对象</li>
<li>如果在访问数据库的过程中，对 Connection、Statement 或 ResultSet 不显性地
关闭，将会造成大量的对象无法被回收，从而引起内存泄漏。</li>
</ul></li>
<li><b>变量不合理的作用域</b>:
<ul class="org-ul">
<li>变量的定义的作用范围大于其使用范围，很有可能会造成内存泄漏</li>
<li>如果没有及时地把对象设置为 null，很有可能导致内存泄漏的发生</li>
</ul></li>
<li><b>内部类持有外部类</b>:
<ul class="org-ul">
<li>如果一个外部类的实例对象的方法返回了一个内部类的实例对象，这个内部类对象
被长期引用了，即使那个外部类实例对象不再被使用，但由于内部类持有外部类的
实例对象，这个外部类对象将不会被垃圾回收，这也会造成内存泄露</li>
</ul></li>
<li><b>改变哈希值</b>:
<ul class="org-ul">
<li>当一个对象被存储进 HashSet 集合中以后，就不能修改这个对象中的那些参与计算
哈希值的字段了，</li>
<li>否则，对象修改后的哈希值与最初存储进 HashSet 集合中时的哈希值就不同了，在
这种情况下，即使在 contains 方法使用该对象的当前引用作为的参数去 HashSet 集
合中检索对象，也将返回找不到对象的结果，这也会导致无法从 HashSet 集合中单
独删除当前对象，造成内存泄露</li>
</ul></li>
<li><b>缓存泄漏</b>:
<ul class="org-ul">
<li>内存泄漏的另一个常见来源是缓存，一旦你把对象引用放入到缓存中，他就很容易
遗忘</li>
<li>对于这个问题，可以使用 WeakHashMap 代表缓存，此种 Map 的特点是，当除了自
身有对 key 的引用外，此 key 没有其他引用那么此 map 会自动丢弃此值</li>
</ul></li>
<li><b>监听器和回调</b>:
<ul class="org-ul">
<li>内存泄漏第三个常见来源是监听器和其他回调</li>
<li>如果客户端在你实现的 API 中注册回调，却没有显示的取消，那么就会积聚</li>
<li>需要确保回调立即被当作垃圾回收的最佳方法是只保存他的若引用，例如将他们保
存成为 WeakHashMap 中的键</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org0ae0878" class="outline-3">
<h3 id="org0ae0878"><span class="section-number-3">1.11</span> Java 类加载机制</h3>
<div class="outline-text-3" id="text-1-11">
<ol class="org-ol">
<li>概念:
<ul class="org-ul">
<li>虚拟机把描述类的数据文件（字节码）加载到内存，并对数据进行验证、准备、解
析以及类初始化，最终形成可以被虚拟机直接使用的 <code>java.lang.Class</code> Java 类
型对象</li>
</ul></li>
<li>类的生命周期:
<ul class="org-ul">
<li><b>加载</b>: 通过一个类的全限定名来获取定义此类的二进制字节流，将这个字节流所
代表的静态存储结构转化为方法区的运行时数据结构。在内存中(方法区)生成一个
代表这个类的 <code>java.lang.Class</code> 对象，作为方法区这个类的各种数据的访问入口</li>
<li><b>验证</b>: 为了确保 <code>Class</code> 文件的字节流中包含的信息符合当前虚拟机的要求，
文件格式验证、元数据验证、字节码验证、符号引用验证</li>
<li><b>准备</b>: 正式为类属性分配内存，设置类属性初始值，这些内存都将在方法区中进
行分配</li>
<li><b>解析</b>: 虚拟机将常量池内的符号引用替换为直接引用</li>
<li><b>初始化</b>: 类初始化阶段是类加载过程最后一步。初始化阶段就是执行类构造器
<code>&lt;clinit&gt;()</code> 方法的过程</li>
<li><b>使用</b>:</li>
<li><b>卸载</b>:</li>
</ul></li>
<li>Java 类加载器:
<ul class="org-ul">
<li>类加载器负责加载所有的类，同一个类(一个类用其全限定类名(包名加类名)标志)
只会被加载一次</li>
<li><code>Bootstrap ClassLoader</code> : 根类加载器，负责加载 Java 的核心类，它不是
<code>java.lang.ClassLoader</code> 的子类，而是由 JVM 自身实现, 主要负责加载
<code>jre/lib</code> 目录中或被 <code>-Xbootclasspath</code> 指定的路径中的并且文件名是被虚拟
机识别的文件</li>
<li><code>Extension ClassLoader</code>: 扩展类加载器，扩展类加载器的加载路径是 JDK 目录
下 <code>jre/lib/ext</code>, 扩展类的 <code>getParent()</code> 方法返回 null,实际上扩展类加载
器的父类加载器是根加载器，只是根加载器并不是 Java 实现的</li>
<li><p>
<code>System ClassLoader</code>: 系统(应用)类加载器，它负责在 JVM 启动时加载来自
Java 命令的 <code>-classpath</code> 选项, <code>java.class.path</code> 系统属性或 <code>CLASSPATH</code>
环境变量所指定的 jar 包和类路径。程序可以通过 <code>getSystemClassLoader()</code>
来获取系统类加载器。系统加载器的加载路径是程序运行的当前路径
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #7aa6da;">ClassLoader</span> <span style="color: #e7c547;">loader</span> = ClassLoader.getSystemClassLoader<span style="color: #8d5649;">()</span>;
System.out.println<span style="color: #8d5649;">(</span>loader<span style="color: #8d5649;">)</span>; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">=&gt; sun.misc.Launcher$AppClassLoader@73d16e93</span>
System.out.println<span style="color: #8d5649;">(</span>loader.getParent<span style="color: #d8241f;">()</span><span style="color: #8d5649;">)</span>; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">=&gt; sun.misc.Launcher$ExtClassLoader@15db9742</span>
System.out.println<span style="color: #8d5649;">(</span>loader.getParent<span style="color: #d8241f;">()</span>.getParent<span style="color: #d8241f;">()</span><span style="color: #8d5649;">)</span>; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">=&gt; null</span>
</pre>
</div></li>
</ul></li>
<li>双亲委派模型的工作过程:
<ul class="org-ul">
<li>首先会先查找当前 <code>ClassLoader</code> 是否加载过此类，有就返回</li>
<li>如果没有，查询父 <code>ClassLoader</code> 是否已经加载过此类，如果已经加载过，就直
接返回 Parent 加载的类</li>
<li>如果整个类加载器体系上的 <code>ClassLoader</code> 都没有加载过，才由当前 <code>ClassLoader</code>
加载(调用 <code>findClass</code>)，整个过程类似循环链表一样。</li>
</ul></li>
<li>双亲委托机制的作用:
<ul class="org-ul">
<li>共享功能: 可以避免重复加载，当父亲已经加载了该类的时候，子类不需要再次加
载，一些 Framework 层级的类一旦被顶层的 <code>ClassLoader</code> 加载过就缓存在内存
里面，以后任何地方用到都不需要重新加载。</li>
<li>隔离功能: 因为 String 已经在启动时被加载，所以用户自定义类是无法加载一个
自定义的类装载器，保证 Java/Android 核心类库的纯净和安全，防止恶意加载。</li>
</ul></li>
<li>如何打破双亲委派模型？
<ul class="org-ul">
<li>双亲委派模型的逻辑都在 <code>loadClass()</code> 中，重写 <code>loaderClass()</code>, 在实际工
程中一般是通过重写 <code>findClass()</code> 实现类加载</li>
<li>系统自带的三个类加载器都加载特定目录下的类，如果我们自己的类加载器放在一
个特殊的目录，那么系统的加载器就无法加载，也就是最终还是由我们自己的加载
器加载</li>
</ul></li>
<li>自定义 <code>ClassLoader</code>:
<ul class="org-ul">
<li><code>loadClass(String name, boolean resolve)</code>: 根据指定的二进制名称加载类</li>
<li><code>findClass(String name)</code>: 根据二进制名称来查找类</li>
<li>直接使用或继承已有的 <code>ClassLoader</code> 实现: <code>java.net.URLClassLoader</code>,
<code>java.security.SecureClassLoader</code>, <code>java.rmi.server.RMIClassLoader</code></li>
<li>在调用 <code>loadClass()</code>, 会先根据委派模型在父加载器中加载，如果加载失败，则
会调用自己的 <code>findClass</code> 方法来完成加载</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org4f7b260" class="outline-3">
<h3 id="org4f7b260"><span class="section-number-3">1.12</span> 引起类加载操作的五个行为</h3>
<div class="outline-text-3" id="text-1-12">
<ol class="org-ol">
<li>遇到 <code>new</code>, <code>getstatic</code>, <code>putstatic</code> 或 <code>invokestatic</code> 这四条字节码指令</li>
<li>反射调用的时候，如果类没有进行过初始化，则需要先触发其初始化</li>
<li>子类初始化的时候，如果其父类还没初始化，则需先触发其父类的初始化</li>
<li>虚拟机执行主类的时候(有 <code>main(string[] args)</code> )</li>
<li>JDK1.7 动态语言支持</li>
</ol>
</div>
</div>

<div id="outline-container-org7132ce7" class="outline-3">
<h3 id="org7132ce7"><span class="section-number-3">1.13</span> Java 对象创建时机</h3>
<div class="outline-text-3" id="text-1-13">
<ol class="org-ol">
<li>使用 <code>new</code> 关键字创建对象</li>
<li>使用 <code>Class</code> 类的 <code>newInstance</code> 方法(反射机制)</li>
<li>使用 <code>Constructor</code> 类的 <code>newInstance</code> 方法(反射机制)</li>
<li>使用 <code>Clone</code> 方法创建对象</li>
<li>使用(反)序列化机制创建对象</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org09fa631" class="outline-2">
<h2 id="org09fa631"><span class="section-number-2">2</span> 实践案例</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgabdadaf" class="outline-3">
<h3 id="orgabdadaf"><span class="section-number-3">2.1</span> JVM 调优参数</h3>
<div class="outline-text-3" id="text-2-1">
<p>
设置堆空间，栈空间和元数据空间大小
</p>
<div class="org-src-container">
<pre class="src src-sh">java -Xms3072M -Xmx3072M -Xss1M -XX:<span style="color: #e7c547;">MetaspaceSize</span>=512M -XX:<span style="color: #e7c547;">MaxMetaspaceSize</span>=512M -jar app.jar
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4b89b6" class="outline-3">
<h3 id="orgb4b89b6"><span class="section-number-3">2.2</span> JDK 调试工具</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgefd2af5" class="outline-4">
<h4 id="orgefd2af5"><span class="section-number-4">2.2.1</span> jps</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
打印 JVM 进程号
</p>
<div class="org-src-container">
<pre class="src src-text">$ jps
 7 jar
 2078 Jps
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c8897e" class="outline-4">
<h4 id="org1c8897e"><span class="section-number-4">2.2.2</span> jstat</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
通过 <code>jstat</code> 动态查看堆内存使用情况
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#26597;&#30475;&#22534;&#20869;&#23384;&#20351;&#29992;&#24773;&#20917;</span>
jstat -gcutil &lt;pid&gt; 1000

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#26597;&#30475;&#32769;&#24180;&#20195;&#20351;&#29992;&#24773;&#20917;</span>
jstat -gcold &lt;pid&gt; 1000

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#26597;&#30475;&#24180;&#36731;&#20195;&#20351;&#29992;&#24773;&#20917;</span>
jstat -gcnew &lt;pid&gt; 1000
</pre>
</div>

<p>
使用示例，每一秒刷新一次
</p>
<div class="org-src-container">
<pre class="src src-text"># &#26597;&#30475;&#22534;&#20869;&#23384;&#20351;&#29992;&#24773;&#20917;
$ jstat -gcutil 70670 1000
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
  0.00   0.00   6.00   7.90  93.92  84.70      2    0.009     2    0.150    0.159
  0.00   0.00   6.00   7.90  93.92  84.70      2    0.009     2    0.150    0.159
  0.00   0.00   6.00   7.90  93.92  84.70      2    0.009     2    0.150    0.159
  0.00   0.00   6.00   7.90  93.92  84.70      2    0.009     2    0.150    0.159
  0.00   0.00   6.00   7.90  93.92  84.70      2    0.009     2    0.150    0.159

# &#26597;&#30475;&#32769;&#24180;&#20195;&#20351;&#29992;&#24773;&#20917;
$ jstat -gcold 70670 1000
     MC       MU      CCSC     CCSU       OC          OU       YGC    FGC    FGCT     GCT
 21888.0  20556.1   2432.0   2059.9     79872.0      6313.3      2     2    0.150    0.159
 21888.0  20556.1   2432.0   2059.9     79872.0      6313.3      2     2    0.150    0.159
 21888.0  20556.1   2432.0   2059.9     79872.0      6313.3      2     2    0.150    0.159
 21888.0  20556.1   2432.0   2059.9     79872.0      6313.3      2     2    0.150    0.159
 21888.0  20556.1   2432.0   2059.9     79872.0      6313.3      2     2    0.150    0.159

# &#26597;&#30475;&#24180;&#36731;&#20195;&#20351;&#29992;&#24773;&#20917;
$ jstat -gcnew 70670 1000
 S0C    S1C    S0U    S1U   TT MTT  DSS      EC       EU     YGC     YGCT
 0.0    0.0    0.0    0.0  1  15 1024.0  51200.0   3072.0      2    0.009
 0.0    0.0    0.0    0.0  1  15 1024.0  51200.0   3072.0      2    0.009
 0.0    0.0    0.0    0.0  1  15 1024.0  51200.0   3072.0      2    0.009
 0.0    0.0    0.0    0.0  1  15 1024.0  51200.0   3072.0      2    0.009
 0.0    0.0    0.0    0.0  1  15 1024.0  51200.0   3072.0      2    0.009
</pre>
</div>
</div>
</div>

<div id="outline-container-org37a54fb" class="outline-4">
<h4 id="org37a54fb"><span class="section-number-4">2.2.3</span> jmap</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
使用 <code>jmap</code> 查看 JVM 虚拟机内存
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#26597;&#30475;&#25152;&#26377;&#20869;&#23384;&#20998;&#24067;</span>
jmap &lt;pid&gt;

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#25171;&#21360;&#22534;&#20869;&#23384;&#20449;&#24687;</span>
jmap -heap &lt;pid&gt;

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#26174;&#31034;&#22534;&#20013;&#23545;&#35937;&#30340;&#32479;&#35745;&#20449;&#24687;</span>
jmap -histo:live &lt;pid&gt;

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#25171;&#21360;&#31867;&#21152;&#36733;&#22120;&#20449;&#24687;</span>
jmap -clstats &lt;pid&gt;

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#25171;&#21360;&#31561;&#24453;&#32456;&#32467;&#30340;&#23545;&#35937;&#20449;&#24687;</span>
jmap -finalizerinfo &lt;pid&gt;

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#29983;&#25104;&#22534;&#36716;&#20648;&#24555;&#29031; dump &#25991;&#20214;</span>
jmap -dump:<span style="color: #e7c547;">format</span>=b,<span style="color: #e7c547;">file</span>=heapdump.hprof &lt;pid&gt;
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">live &#23376;&#36873;&#39033;&#34920;&#31034;&#21482; dump &#23384;&#27963;&#30340;&#23545;&#35937;</span>
jmap -dump:live,<span style="color: #e7c547;">format</span>=b,<span style="color: #e7c547;">file</span>=heapdump.hprof &lt;pid&gt;

jmap -dump:live,<span style="color: #e7c547;">format</span>=b,<span style="color: #e7c547;">file</span>=heapdump-live-$(date +<span style="color: #70c0b1;">'%Y%m%d-%H%M%S'</span>).hprof &lt;pid&gt;
jmap -dump:<span style="color: #e7c547;">format</span>=b,<span style="color: #e7c547;">file</span>=heapdump-all-$(date +<span style="color: #70c0b1;">'%Y%m%d-%H%M%S'</span>).hprof &lt;pid&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-text">$ jmap 19112
Attaching to process ID 19112, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.191-b12
0x0000000069790000      144K    C:\Local\Java\jdk1.8.0_191\jre\bin\sunec.dll
0x0000000069800000      52K     C:\Local\Java\jdk1.8.0_191\jre\bin\management.dll
0x0000000069810000      140K    C:\Local\Java\jdk1.8.0_191\jre\bin\instrument.dll
0x0000000069840000      68K     C:\Local\Java\jdk1.8.0_191\jre\bin\nio.dll
0x0000000069860000      104K    C:\Local\Java\jdk1.8.0_191\jre\bin\net.dll
0x0000000069880000      88K     C:\Local\Java\jdk1.8.0_191\jre\bin\zip.dll
0x00000000698a0000      164K    C:\Local\Java\jdk1.8.0_191\jre\bin\java.dll
0x00000000698d0000      60K     C:\Local\Java\jdk1.8.0_191\jre\bin\verify.dll
0x00000000698e0000      8848K   C:\Local\Java\jdk1.8.0_191\jre\bin\server\jvm.dll
0x000000006a190000      840K    C:\Local\Java\jdk1.8.0_191\jre\bin\msvcr100.dll
0x00007ff78f6f0000      220K    C:\Local\Java\jdk1.8.0_191\bin\java.exe
... &#30465;&#30053;
0x00007ffaebe60000      72K     C:\WINDOWS\System32\winrnr.dll
0x00007ffaebe80000      84K     C:\WINDOWS\system32\wshbth.dll
0x00007ffaebfa0000      108K    C:\WINDOWS\system32\pnrpnsp.dll
0x00007ffb16e60000      756K    C:\WINDOWS\System32\KERNEL32.DLL
0x00007ffb16f20000      1196K   C:\WINDOWS\System32\RPCRT4.dll
0x00007ffb17680000      1664K   C:\WINDOWS\System32\USER32.dll
0x00007ffb17820000      696K    C:\WINDOWS\System32\SHCORE.dll
0x00007ffb178d0000      632K    C:\WINDOWS\System32\msvcrt.dll
0x00007ffb17970000      168K    C:\WINDOWS\System32\GDI32.dll
0x00007ffb17a30000      192K    C:\WINDOWS\System32\IMM32.DLL
0x00007ffb17ac0000      428K    C:\WINDOWS\System32\WS2_32.dll
0x00007ffb17b30000      7420K   C:\WINDOWS\System32\SHELL32.dll
0x00007ffb18310000      2004K   C:\WINDOWS\SYSTEM32\ntdll.dll

$ jmap -heap 19112
Attaching to process ID 19112, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.191-b12

using thread-local object allocation.
Parallel GC with 8 thread(s)

Heap Configuration:
   MinHeapFreeRatio         = 0
   MaxHeapFreeRatio         = 100
   MaxHeapSize              = 4276092928 (4078.0MB)
   NewSize                  = 89128960 (85.0MB)
   MaxNewSize               = 1425014784 (1359.0MB)
   OldSize                  = 179306496 (171.0MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 0 (0.0MB)

Heap Usage:
PS Young Generation
Eden Space:
   capacity = 538968064 (514.0MB)
   used     = 39151888 (37.33815002441406MB)
   free     = 499816176 (476.66184997558594MB)
   7.2642315222595455% used
From Space:
   capacity = 24117248 (23.0MB)
   used     = 24101024 (22.984527587890625MB)
   free     = 16224 (0.015472412109375MB)
   99.93272864300272% used
To Space:
   capacity = 35651584 (34.0MB)
   used     = 0 (0.0MB)
   free     = 35651584 (34.0MB)
   0.0% used
PS Old Generation
   capacity = 213385216 (203.5MB)
   used     = 68250752 (65.0889892578125MB)
   free     = 145134464 (138.4110107421875MB)
   31.98476130605037% used

38914 interned Strings occupying 4036696 bytes.

</pre>
</div>
</div>
</div>

<div id="outline-container-org1f8b27c" class="outline-4">
<h4 id="org1f8b27c"><span class="section-number-4">2.2.4</span> jstack</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
<code>jstack</code> 可以打印线程栈
</p>
<div class="org-src-container">
<pre class="src src-text"># jstack 7
2021-07-05 10:50:34
Full thread dump OpenJDK 64-Bit Server VM (25.212-b04 mixed mode):

"Attach Listener" #2044 daemon prio=9 os_prio=0 tid=0x00007f2820001000 nid=0x99a waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"logback-6" #1731 daemon prio=5 os_prio=0 tid=0x00007f27d8090000 nid=0x6df waiting on condition [0x00007f27b1de6000]
   java.lang.Thread.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x00000007b9cc83c0&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
        at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1081)
        at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:809)
        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)

"logback-5" #1730 daemon prio=5 os_prio=0 tid=0x00007f27d8405800 nid=0x6de waiting on condition [0x00007f27b1ee7000]
   java.lang.Thread.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x00000007b9cc83c0&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
        at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1081)
        at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:809)
        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)

... &#30465;&#30053;

"Service Thread" #20 daemon prio=9 os_prio=0 tid=0x00007f28b0431000 nid=0x33 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C1 CompilerThread14" #19 daemon prio=9 os_prio=0 tid=0x00007f28b042e000 nid=0x32 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C1 CompilerThread13" #18 daemon prio=9 os_prio=0 tid=0x00007f28b042c000 nid=0x31 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

... &#30465;&#30053;

"VM Thread" os_prio=0 tid=0x00007f28b03c6000 nid=0x20 runnable

"GC task thread#0 (ParallelGC)" os_prio=0 tid=0x00007f28b0020000 nid=0x9 runnable

"GC task thread#1 (ParallelGC)" os_prio=0 tid=0x00007f28b0022000 nid=0xa runnable

... &#30465;&#30053;

"VM Periodic Task Thread" os_prio=0 tid=0x00007f28b0433800 nid=0x34 waiting on condition

JNI global references: 2614
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb64fe40" class="outline-4">
<h4 id="orgb64fe40"><span class="section-number-4">2.2.5</span> arthas</h4>
<div class="outline-text-4" id="text-2-2-5">
<p>
阿里巴巴开源的 JVM 监控调试工具 <a href="https://github.com/alibaba/arthas">Arthas</a> 提供更多调试方法
</p>
</div>
</div>

<div id="outline-container-org6d60285" class="outline-4">
<h4 id="org6d60285"><span class="section-number-4">2.2.6</span> Eclipse Memory Analyzer</h4>
<div class="outline-text-4" id="text-2-2-6">
<p>
Eclipse <a href="https://www.eclipse.org/mat/downloads.php">mat</a> 工具提供分析内存镜像的方法，可以自行前往官网下载
</p>
</div>
</div>
</div>

<div id="outline-container-org4266804" class="outline-3">
<h3 id="org4266804"><span class="section-number-3">2.3</span> 逃逸分析</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Java 在发现 new 出来的对象如果只在当前方法中运行，会直接进入线程栈，而不会放入
堆空间，这个现象叫做逃逸分析
</p>

<p>
实验时可以添加下列 Java 启动参数来显示，为达到演示效果需要现在堆空间为 10M
</p>
<div class="org-src-container">
<pre class="src src-sh">-Xmx10m -Xms10m -XX:+PrintGC -XX:-DoEscapeAnalysis
</pre>
</div>

<p>
JDK 1.6 后默认开启逃逸分析 <code>-XX:-DoEscapeAnalysis</code> 选项，为完成实验需要临时关
闭一下逃逸分析选项
</p>

<p>
添加如下实验代码
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #b9ca4a;">public</span> <span style="color: #b9ca4a;">class</span> <span style="color: #7aa6da;">Example02</span> <span style="color: #8d5649;">{</span>
  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">-Xmx10m -Xms10m -XX:+PrintGC -XX:-DoEscapeAnalysis</span>
  <span style="color: #b9ca4a;">public</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">void</span> <span style="color: #e78c45;">main</span><span style="color: #d8241f;">(</span><span style="color: #7aa6da;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #e7c547;">args</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #b9ca4a;">while</span> <span style="color: #9564bf;">(</span><span style="color: #7aa6da;">true</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      <span style="color: #7aa6da;">Integer</span> <span style="color: #e7c547;">temp</span> = <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">Integer</span><span style="color: #24a222;">(</span>999999999<span style="color: #24a222;">)</span>;
    <span style="color: #9564bf;">}</span>
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
添加 <code>-XX:-DoEscapeAnalysis</code> 选项关闭逃逸分析后
</p>
<div class="org-src-container">
<pre class="src src-text">[GC (Allocation Failure)  2048K-&gt;488K(9728K), 0.0015437 secs]
[GC (Allocation Failure)  2536K-&gt;504K(9728K), 0.0013609 secs]
[GC (Allocation Failure)  2552K-&gt;504K(9728K), 0.0004373 secs]
[GC (Allocation Failure)  2552K-&gt;488K(9728K), 0.0004283 secs]
[GC (Allocation Failure)  2536K-&gt;488K(9728K), 0.0004708 secs]
[GC (Allocation Failure)  2536K-&gt;488K(9728K), 0.0004193 secs]
[GC (Allocation Failure)  2536K-&gt;433K(9728K), 0.0004879 secs]
[GC (Allocation Failure)  2481K-&gt;433K(8704K), 0.0002465 secs]
[GC (Allocation Failure)  1457K-&gt;433K(9216K), 0.0002974 secs]
[GC (Allocation Failure)  1457K-&gt;433K(9216K), 0.0002519 secs]
[GC (Allocation Failure)  1457K-&gt;433K(9216K), 0.0002466 secs]
[GC (Allocation Failure)  1457K-&gt;433K(9216K), 0.0002524 secs]
... &#30127;&#29378;&#22320; GC
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf60fbb0" class="outline-3">
<h3 id="orgf60fbb0"><span class="section-number-3">2.4</span> JDBC 知识点</h3>
<div class="outline-text-3" id="text-2-4">
<ol class="org-ol">
<li>SPI (Service Provider Interface) 实际上是基于接口的编程, 策略模式和配置文
件组合实现的动态加载机制
<ul class="org-ul">
<li>三方驱动在 <code>META-INF/services/java.sql.Driver</code> 中添加驱动配置信息</li>
<li><p>
<code>DriverManager</code> 的静态代码块中通过调用 <code>loadInitialDrivers();</code> 来读取使
用驱动信息
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #c397d8;">/**</span>
<span style="color: #c397d8;"> * Load the initial JDBC drivers by checking the System property</span>
<span style="color: #c397d8;"> * jdbc.properties and then use the </span><span style="color: #7aa6da;">{@code ServiceLoader}</span><span style="color: #c397d8;"> mechanism</span>
<span style="color: #c397d8;"> */</span>
<span style="color: #b9ca4a;">static</span> <span style="color: #8d5649;">{</span>
    loadInitialDrivers<span style="color: #d8241f;">()</span>;
    println<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"JDBC DriverManager initialized"</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li><p>
在 <code>loadInitialDrivers();</code> 方法中， <code>ServiceLoader.load(Driver.class)</code>
通过扫描 <code>META-INF/services</code> 目录下的配置文件找到实现类的全限定名，把类
加载到 JVM
</p>
<div class="org-src-container">
<pre class="src src-java">AccessController.doPrivileged<span style="color: #8d5649;">(</span><span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">PrivilegedAction</span><span style="color: #d8241f;">&lt;</span><span style="color: #7aa6da;">Void</span><span style="color: #d8241f;">&gt;()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #b9ca4a;">public</span> <span style="color: #7aa6da;">Void</span> <span style="color: #e78c45;">run</span><span style="color: #9564bf;">()</span> <span style="color: #9564bf;">{</span>

        <span style="color: #7aa6da;">ServiceLoader</span><span style="color: #24a222;">&lt;</span><span style="color: #7aa6da;">Driver</span><span style="color: #24a222;">&gt;</span> <span style="color: #e7c547;">loadedDrivers</span> = ServiceLoader.load<span style="color: #24a222;">(</span>Driver.<span style="color: #b9ca4a;">class</span><span style="color: #24a222;">)</span>;
        <span style="color: #7aa6da;">Iterator</span><span style="color: #24a222;">&lt;</span><span style="color: #7aa6da;">Driver</span><span style="color: #24a222;">&gt;</span> <span style="color: #e7c547;">driversIterator</span> = loadedDrivers.iterator<span style="color: #24a222;">()</span>;

        <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Load these drivers, so that they can be instantiated.</span>
<span style="color: #969896; font-style: italic;">         * It may be the case that the driver class may not be there</span>
<span style="color: #969896; font-style: italic;">         * i.e. there may be a packaged driver with the service class</span>
<span style="color: #969896; font-style: italic;">         * as implementation of java.sql.Driver but the actual class</span>
<span style="color: #969896; font-style: italic;">         * may be missing. In that case a java.util.ServiceConfigurationError</span>
<span style="color: #969896; font-style: italic;">         * will be thrown at runtime by the VM trying to locate</span>
<span style="color: #969896; font-style: italic;">         * and load the service.</span>
<span style="color: #969896; font-style: italic;">         *</span>
<span style="color: #969896; font-style: italic;">         * Adding a try catch block to catch those runtime errors</span>
<span style="color: #969896; font-style: italic;">         * if driver not available in classpath but it's</span>
<span style="color: #969896; font-style: italic;">         * packaged as service and that service is there in classpath.</span>
<span style="color: #969896; font-style: italic;">         */</span>
        <span style="color: #b9ca4a;">try</span><span style="color: #24a222;">{</span>
            <span style="color: #b9ca4a;">while</span><span style="color: #ff7f00;">(</span>driversIterator.hasNext<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                driversIterator.next<span style="color: #1776b6;">()</span>;
            <span style="color: #ff7f00;">}</span>
        <span style="color: #24a222;">}</span> <span style="color: #b9ca4a;">catch</span><span style="color: #24a222;">(</span><span style="color: #7aa6da;">Throwable</span> <span style="color: #e7c547;">t</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
        <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Do nothing</span>
        <span style="color: #24a222;">}</span>
        <span style="color: #b9ca4a;">return</span> <span style="color: #7aa6da;">null</span>;
    <span style="color: #9564bf;">}</span>
<span style="color: #d8241f;">}</span><span style="color: #8d5649;">)</span>;
</pre>
</div></li>
</ul></li>
<li><p>
使用 <code>DriverManager</code> 中定义了 <code>registeredDrivers</code> 来存储项目中引用的确定类
信息
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">List of registered JDBC drivers</span>
<span style="color: #b9ca4a;">private</span> <span style="color: #b9ca4a;">final</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">CopyOnWriteArrayList</span><span style="color: #8d5649;">&lt;</span><span style="color: #7aa6da;">DriverInfo</span><span style="color: #8d5649;">&gt;</span> <span style="color: #e7c547;">registeredDrivers</span> = <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">CopyOnWriteArrayList</span><span style="color: #8d5649;">&lt;&gt;()</span>;
</pre>
</div></li>
<li><p>
调用 <code>getConnection</code> 方法时通过变量所有注册的驱动来获取连接信息
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #969896; font-style: italic;">//  </span><span style="color: #969896; font-style: italic;">Worker method called by the public getConnection() methods.</span>
<span style="color: #b9ca4a;">private</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">Connection</span> <span style="color: #e78c45;">getConnection</span><span style="color: #8d5649;">(</span>
    <span style="color: #7aa6da;">String</span> <span style="color: #e7c547;">url</span>, <span style="color: #7aa6da;">java</span>.<span style="color: #7aa6da;">util</span>.<span style="color: #7aa6da;">Properties</span> <span style="color: #e7c547;">info</span>, <span style="color: #7aa6da;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #e7c547;">caller</span><span style="color: #8d5649;">)</span> <span style="color: #b9ca4a;">throws</span> <span style="color: #7aa6da;">SQLException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #969896; font-style: italic;">/*</span>
<span style="color: #969896; font-style: italic;">     * When callerCl is null, we should check the application's</span>
<span style="color: #969896; font-style: italic;">     * (which is invoking this class indirectly)</span>
<span style="color: #969896; font-style: italic;">     * classloader, so that the JDBC driver class outside rt.jar</span>
<span style="color: #969896; font-style: italic;">     * can be loaded from here.</span>
<span style="color: #969896; font-style: italic;">     */</span>
    <span style="color: #7aa6da;">ClassLoader</span> <span style="color: #e7c547;">callerCL</span> = caller != <span style="color: #7aa6da;">null</span> ? caller.getClassLoader<span style="color: #d8241f;">()</span> : <span style="color: #7aa6da;">null</span>;
    <span style="color: #b9ca4a;">synchronized</span><span style="color: #d8241f;">(</span>DriverManager.<span style="color: #b9ca4a;">class</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">synchronize loading of the correct classloader.</span>
        <span style="color: #b9ca4a;">if</span> <span style="color: #9564bf;">(</span>callerCL == <span style="color: #7aa6da;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            callerCL = Thread.currentThread<span style="color: #24a222;">()</span>.getContextClassLoader<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #b9ca4a;">if</span><span style="color: #d8241f;">(</span>url == <span style="color: #7aa6da;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #b9ca4a;">throw</span> <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">SQLException</span><span style="color: #9564bf;">(</span><span style="color: #70c0b1;">"The url cannot be null"</span>, <span style="color: #70c0b1;">"08001"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    println<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"DriverManager.getConnection(\""</span> + url + <span style="color: #70c0b1;">"\")"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Walk through the loaded registeredDrivers attempting to make a connection.</span>
    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Remember the first exception that gets raised so we can reraise it.</span>
    <span style="color: #7aa6da;">SQLException</span> <span style="color: #e7c547;">reason</span> = <span style="color: #7aa6da;">null</span>;

    <span style="color: #b9ca4a;">for</span><span style="color: #d8241f;">(</span><span style="color: #7aa6da;">DriverInfo</span> <span style="color: #e7c547;">aDriver</span> : registeredDrivers<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">If the caller does not have permission to load the driver then</span>
        <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">skip it.</span>
        <span style="color: #b9ca4a;">if</span><span style="color: #9564bf;">(</span>isDriverAllowed<span style="color: #24a222;">(</span>aDriver.driver, callerCL<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #b9ca4a;">try</span> <span style="color: #24a222;">{</span>
                println<span style="color: #ff7f00;">(</span><span style="color: #70c0b1;">"    trying "</span> + aDriver.driver.getClass<span style="color: #1776b6;">()</span>.getName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
                <span style="color: #7aa6da;">Connection</span> <span style="color: #e7c547;">con</span> = aDriver.driver.connect<span style="color: #ff7f00;">(</span>url, info<span style="color: #ff7f00;">)</span>;
                <span style="color: #b9ca4a;">if</span> <span style="color: #ff7f00;">(</span>con != <span style="color: #7aa6da;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Success!</span>
                    println<span style="color: #1776b6;">(</span><span style="color: #70c0b1;">"getConnection returning "</span> + aDriver.driver.getClass<span style="color: #00bed1;">()</span>.getName<span style="color: #00bed1;">()</span><span style="color: #1776b6;">)</span>;
                    <span style="color: #b9ca4a;">return</span> <span style="color: #1776b6;">(</span>con<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #24a222;">(</span><span style="color: #7aa6da;">SQLException</span> <span style="color: #e7c547;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #b9ca4a;">if</span> <span style="color: #ff7f00;">(</span>reason == <span style="color: #7aa6da;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    reason = ex;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>

        <span style="color: #9564bf;">}</span> <span style="color: #b9ca4a;">else</span> <span style="color: #9564bf;">{</span>
            println<span style="color: #24a222;">(</span><span style="color: #70c0b1;">"    skipping: "</span> + aDriver.getClass<span style="color: #ff7f00;">()</span>.getName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

    <span style="color: #d8241f;">}</span>

    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">if we got here nobody could connect.</span>
    <span style="color: #b9ca4a;">if</span> <span style="color: #d8241f;">(</span>reason != <span style="color: #7aa6da;">null</span><span style="color: #d8241f;">)</span>    <span style="color: #d8241f;">{</span>
        println<span style="color: #9564bf;">(</span><span style="color: #70c0b1;">"getConnection failed: "</span> + reason<span style="color: #9564bf;">)</span>;
        <span style="color: #b9ca4a;">throw</span> reason;
    <span style="color: #d8241f;">}</span>

    println<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"getConnection: no suitable driver found for "</span>+ url<span style="color: #d8241f;">)</span>;
    <span style="color: #b9ca4a;">throw</span> <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">SQLException</span><span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"No suitable driver found for "</span>+ url, <span style="color: #70c0b1;">"08001"</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li>打破双亲委派
<ul class="org-ul">
<li><p>
由于 <code>java.sql.Driver</code> 的类加载器是 Bootstrap ClassLoader, 而实际加载三
方实现类的 <code>Launcher.AppClassLoader.getAppClassLoader(var1);</code> 方法的线程
上下文应该是 <code>AppClassLoader</code>, 这违背了双亲委派模型
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #b9ca4a;">public</span> <span style="color: #b9ca4a;">class</span> <span style="color: #7aa6da;">Launcher</span> <span style="color: #8d5649;">{</span>
    <span style="color: #b9ca4a;">private</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">URLStreamHandlerFactory</span> <span style="color: #e7c547;">factory</span> = <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">Launcher</span>.<span style="color: #7aa6da;">Factory</span><span style="color: #d8241f;">()</span>;
    <span style="color: #b9ca4a;">private</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">Launcher</span> <span style="color: #e7c547;">launcher</span> = <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">Launcher</span><span style="color: #d8241f;">()</span>;
    <span style="color: #b9ca4a;">private</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">String</span> <span style="color: #e7c547;">bootClassPath</span> = System.getProperty<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"sun.boot.class.path"</span><span style="color: #d8241f;">)</span>;
    <span style="color: #b9ca4a;">private</span> <span style="color: #7aa6da;">ClassLoader</span> <span style="color: #e7c547;">loader</span>;
    <span style="color: #b9ca4a;">private</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">URLStreamHandler</span> <span style="color: #e7c547;">fileHandler</span>;

    <span style="color: #b9ca4a;">public</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">Launcher</span> <span style="color: #e78c45;">getLauncher</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #b9ca4a;">return</span> launcher;
    <span style="color: #d8241f;">}</span>

    <span style="color: #b9ca4a;">public</span> <span style="color: #e78c45;">Launcher</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #7aa6da;">Launcher</span>.<span style="color: #7aa6da;">ExtClassLoader</span> <span style="color: #e7c547;">var1</span>;
        <span style="color: #b9ca4a;">try</span> <span style="color: #9564bf;">{</span>
            var1 = <span style="color: #7aa6da;">Launcher</span>.ExtClassLoader.getExtClassLoader<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #7aa6da;">IOException</span> <span style="color: #e7c547;">var10</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #b9ca4a;">throw</span> <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">InternalError</span><span style="color: #24a222;">(</span><span style="color: #70c0b1;">"Could not create extension class loader"</span>, var10<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #b9ca4a;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #b9ca4a;">this</span>.loader = <span style="color: #7aa6da;">Launcher</span>.AppClassLoader.getAppClassLoader<span style="color: #24a222;">(</span>var1<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #7aa6da;">IOException</span> <span style="color: #e7c547;">var9</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #b9ca4a;">throw</span> <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">InternalError</span><span style="color: #24a222;">(</span><span style="color: #70c0b1;">"Could not create application class loader"</span>, var9<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        Thread.currentThread<span style="color: #9564bf;">()</span>.setContextClassLoader<span style="color: #9564bf;">(</span><span style="color: #b9ca4a;">this</span>.loader<span style="color: #9564bf;">)</span>;
        <span style="color: #7aa6da;">String</span> <span style="color: #e7c547;">var2</span> = System.getProperty<span style="color: #9564bf;">(</span><span style="color: #70c0b1;">"java.security.manager"</span><span style="color: #9564bf;">)</span>;
        <span style="color: #b9ca4a;">if</span> <span style="color: #9564bf;">(</span>var2 != <span style="color: #7aa6da;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #7aa6da;">SecurityManager</span> <span style="color: #e7c547;">var3</span> = <span style="color: #7aa6da;">null</span>;
            <span style="color: #b9ca4a;">if</span> <span style="color: #24a222;">(</span><span style="color: #7aa6da;">!</span><span style="color: #70c0b1;">""</span>.equals<span style="color: #ff7f00;">(</span>var2<span style="color: #ff7f00;">)</span> &amp;&amp; <span style="color: #7aa6da;">!</span><span style="color: #70c0b1;">"default"</span>.equals<span style="color: #ff7f00;">(</span>var2<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #b9ca4a;">try</span> <span style="color: #ff7f00;">{</span>
                    var3 = <span style="color: #1776b6;">(</span><span style="color: #7aa6da;">SecurityManager</span><span style="color: #1776b6;">)</span><span style="color: #b9ca4a;">this</span>.loader.loadClass<span style="color: #1776b6;">(</span>var2<span style="color: #1776b6;">)</span>.newInstance<span style="color: #1776b6;">()</span>;
                <span style="color: #ff7f00;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #7aa6da;">IllegalAccessException</span> <span style="color: #e7c547;">var5</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                <span style="color: #ff7f00;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #7aa6da;">InstantiationException</span> <span style="color: #e7c547;">var6</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                <span style="color: #ff7f00;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #7aa6da;">ClassNotFoundException</span> <span style="color: #e7c547;">var7</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                <span style="color: #ff7f00;">}</span> <span style="color: #b9ca4a;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #7aa6da;">ClassCastException</span> <span style="color: #e7c547;">var8</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span> <span style="color: #b9ca4a;">else</span> <span style="color: #24a222;">{</span>
                var3 = <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">SecurityManager</span><span style="color: #ff7f00;">()</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #b9ca4a;">if</span> <span style="color: #24a222;">(</span>var3 == <span style="color: #7aa6da;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #b9ca4a;">throw</span> <span style="color: #b9ca4a;">new</span> <span style="color: #7aa6da;">InternalError</span><span style="color: #ff7f00;">(</span><span style="color: #70c0b1;">"Could not create SecurityManager: "</span> + var2<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            System.setSecurityManager<span style="color: #24a222;">(</span>var3<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

    <span style="color: #d8241f;">}</span>

  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#30465;&#30053;</span>
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li>JDBC 4.0 之前使用 <code>Class.forName("")</code> 方式加载驱动是不会破坏双亲委派的，
JDBC 4.0 之后使用 SPI 机制才会破坏双亲委派机制</li>
<li>Bootstrap ClassLoader 和 Extension ClassLoader, 他们只能加载自己指定目录
下的类，无法加载运行时的，其他目录下的类</li>
<li>JDBC 接口都是由 JDK 提供，具体实现是由第三方数据库产商提供的,所以也只能
采用这种方式去加载驱动实现类</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orge3b9764" class="outline-2">
<h2 id="orge3b9764"><span class="section-number-2">3</span> 反射</h2>
<div class="outline-text-2" id="text-3">
<p>
Java 提供可以动态创建对象和操作对象的方法，一般叫做反射
</p>
<ol class="org-ol">
<li><code>private</code> 属性处理时需要设置可见性</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #b9ca4a;">public</span> <span style="color: #b9ca4a;">static</span> <span style="color: #7aa6da;">void</span> <span style="color: #e78c45;">main</span><span style="color: #8d5649;">(</span><span style="color: #7aa6da;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #e7c547;">args</span><span style="color: #8d5649;">)</span> <span style="color: #b9ca4a;">throws</span> <span style="color: #7aa6da;">Exception</span> <span style="color: #8d5649;">{</span>
  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462; Class &#31867;</span>
  <span style="color: #7aa6da;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #e7c547;">clz</span> = Class.forName<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"io.github.jeanhwea.app03.bean.Person"</span><span style="color: #d8241f;">)</span>;

  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#31867;&#30340;&#26500;&#36896;&#22120;</span>
  <span style="color: #7aa6da;">Constructor</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #e7c547;">ctor</span> = clz.getConstructor<span style="color: #d8241f;">()</span>;
  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#26032;&#24314;&#23545;&#35937;</span>
  <span style="color: #7aa6da;">Object</span> <span style="color: #e7c547;">obj</span> = ctor.newInstance<span style="color: #d8241f;">()</span>;

  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#23450;&#20041;&#30340;&#23383;&#27573;</span>
  <span style="color: #7aa6da;">Field</span> <span style="color: #e7c547;">field</span> = clz.getDeclaredField<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"name"</span><span style="color: #d8241f;">)</span>;
  field.setAccessible<span style="color: #d8241f;">(</span><span style="color: #7aa6da;">true</span><span style="color: #d8241f;">)</span>; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">private &#20462;&#39280;&#30340;&#23383;&#27573;&#38656;&#35201;&#37197;&#32622;&#21487;&#35265;&#24615;</span>
  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#35774;&#32622;&#23383;&#27573;&#20540;</span>
  field.set<span style="color: #d8241f;">(</span>obj, <span style="color: #70c0b1;">"Injected Person Name"</span><span style="color: #d8241f;">)</span>;

  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#31867;&#30340;&#26041;&#27861;</span>
  <span style="color: #7aa6da;">Method</span> <span style="color: #e7c547;">method</span> = clz.getMethod<span style="color: #d8241f;">(</span><span style="color: #70c0b1;">"getName"</span><span style="color: #d8241f;">)</span>;
  <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#35843;&#29992;&#26041;&#27861;</span>
  <span style="color: #7aa6da;">String</span> <span style="color: #e7c547;">name</span> = <span style="color: #d8241f;">(</span><span style="color: #7aa6da;">String</span><span style="color: #d8241f;">)</span> method.invoke<span style="color: #d8241f;">(</span>obj<span style="color: #d8241f;">)</span>;
  System.out.println<span style="color: #d8241f;">(</span>name<span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
反射的一些注意事项
</p>
<ol class="org-ol">
<li>内部类调用 <code>getConstructor()</code> 时可能没有默认的构造器，声明成静态内部类</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-10-16 Sat 09:40. Created by Jinghui Hu at 2021-06-21 Mon 14:27.</p>
</div>
</body>
</html>
