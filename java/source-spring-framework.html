<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-30 Fri 09:17 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring Framework 源码赏析</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring Framework 源码赏析</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga742f97">1. Spring 核心类和方法</a>
<ul>
<li><a href="#org8f74ba6">1.1. 核心类</a></li>
<li><a href="#org700d173">1.2. IoC 的理解</a></li>
<li><a href="#org0d9a5a5">1.3. IoC 核心方法</a></li>
</ul>
</li>
<li><a href="#org769f7b0">2. 容器实现原理</a>
<ul>
<li><a href="#org6446d04">2.1. Bean 工厂接口: BeanFactory</a></li>
<li><a href="#orgc9491da">2.2. Bean 工厂的实现类: DefaultListableBeanFactory</a></li>
<li><a href="#org2c75641">2.3. Bean 定义的读取器: XmlBeanDefinitionReader</a></li>
<li><a href="#orgdfa362b">2.4. BeanDefinition 自动加载流程</a></li>
<li><a href="#orgfbc10b3">2.5. BeanDefinition 注册的实现</a></li>
<li><a href="#org9ef444b">2.6. BeanDefinition 移除的实现</a></li>
<li><a href="#org4e68f27">2.7. BeanDefinition 获取的实现</a></li>
<li><a href="#orge9fb0c0">2.8. <code>&lt;bean/&gt;</code> 标签解析</a></li>
</ul>
</li>
<li><a href="#org35cd457">3. Bean 实现原理</a>
<ul>
<li><a href="#orgc5aca46">3.1. Bean 的生命周期</a></li>
<li><a href="#org90aba18">3.2. Bean 的流程分析</a>
<ul>
<li><a href="#org47bceb8">3.2.1. 实例化 Bean: <code>instantiateBean()</code> 方法</a></li>
<li><a href="#orgaad00f3">3.2.2. 获取 Bean 实例: <code>doGetBean()</code> 方法</a></li>
</ul>
</li>
<li><a href="#orgd111db2">3.3. 特殊的 Spring Bean: FactoryBean</a></li>
<li><a href="#org5232613">3.4. 单例 Bean 工厂的实现</a>
<ul>
<li><a href="#orgc2ef99e">3.4.1. 单例 Bean 工厂的三级缓存: <code>DefaultSingletonBeanRegistry</code> 类的缓存</a></li>
<li><a href="#org25e2bd8">3.4.2. 为什么必须要三级缓存</a></li>
<li><a href="#org47c4fd6">3.4.3. 获取单例 Bean 方法: <code>getSingleton(...)</code> 方法</a></li>
<li><a href="#org7ff2a63">3.4.4. beanInstance 到 beanOject 过程: <code>getObjectForBeanInstance(...)</code> 方法</a></li>
</ul>
</li>
<li><a href="#org6e642a2">3.5. Bean 生命周期的实现</a>
<ul>
<li><a href="#org48d4d07">3.5.1. Bean 创建的实现类: <code>AbstractAutowireCapableBeanFactory</code></a></li>
<li><a href="#org59d1433">3.5.2. Bean 的实例化: <code>createBean(...)</code> 方法</a></li>
<li><a href="#orgad76908">3.5.3. Bean 的初始化: <code>initializeBean(...)</code> 方法</a></li>
<li><a href="#org4e0ce19">3.5.4. Bean 的销毁</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9bc4da8">4. 容器功能扩展</a>
<ul>
<li><a href="#orgce38d28">4.1. 应用上下文: ApplicationContext</a></li>
<li><a href="#orga792179">4.2. ApplicationContext 接口的常见实现类</a>
<ul>
<li><a href="#org35806ba">4.2.1. ClassPathXmlApplicationContext</a></li>
<li><a href="#orgf3c648d">4.2.2. AnnotationConfigApplicationContext</a></li>
</ul>
</li>
<li><a href="#org8cf92d7">4.3. 刷新应用上下文: <code>refresh()</code> 方法</a>
<ul>
<li><a href="#orgd888c6a">4.3.1. <code>refresh()</code> 方法总览</a></li>
<li><a href="#org66e952e">4.3.2. 环境准备</a></li>
<li><a href="#orgffb1635">4.3.3. 加载 BeanFactory</a></li>
<li><a href="#orgef94fd4">4.3.4. BeanFactory 准备工作</a></li>
<li><a href="#org8698a60">4.3.5. BeanFactory 后续处理工作</a></li>
<li><a href="#org6640b6e">4.3.6. 初始化非延迟加载单例</a></li>
<li><a href="#org6d37fd6">4.3.7. 完成上下文刷新</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgdec5a9a">5. AOP 面向切面编程</a>
<ul>
<li><a href="#org5ba22ae">5.1. AOP 预备知识</a>
<ul>
<li><a href="#org019e8ec">5.1.1. AOP 核心概念</a></li>
<li><a href="#orge98124c">5.1.2. JDK 动态代理和 cglib 动态代理</a></li>
<li><a href="#org5295842">5.1.3. Spring AOP 和 AspectJ 的区别</a></li>
<li><a href="#org97cfd38">5.1.4. AOP 组件</a></li>
<li><a href="#org0d0fec3">5.1.5. AOP 实践案例</a></li>
</ul>
</li>
<li><a href="#org43f24f0">5.2. AOP 实现原理</a>
<ul>
<li><a href="#org87a08ca">5.2.1. AOP 的工具类 <code>AopNamespaceUtils</code></a></li>
<li><a href="#org44c5657">5.2.2. AOP 代理是否开启 <code>AspectJAutoProxyRegistrar</code></a></li>
<li><a href="#org7162e4e">5.2.3. AspectJ 创建器 <code>AnnotationAwareAspectJAutoProxyCreator</code></a></li>
<li><a href="#org6fbdb6c">5.2.4. <code>AbstractAutoProxyCreator</code> 提前埋点</a></li>
<li><a href="#org721be0a">5.2.5. XML 方式的 AOP 读取</a></li>
</ul>
</li>
<li><a href="#orgf3bf51e">5.3. 创建 AOP 代理</a>
<ul>
<li><a href="#org16b96d8">5.3.1. 创建 AOP 代理</a></li>
<li><a href="#org9e2de85">5.3.2. 获取增强器 Advisor</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgcd0fbb4">6. SpringBoot 自动装配</a></li>
<li><a href="#org0c7e01e">7. 参考链接</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga742f97" class="outline-2">
<h2 id="orga742f97"><span class="section-number-2">1</span> Spring 核心类和方法</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org8f74ba6" class="outline-3">
<h3 id="org8f74ba6"><span class="section-number-3">1.1</span> 核心类</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li>BeanFactory <code>Bean工厂</code>
<ul class="org-ul">
<li><code>getBean(...)</code></li>
<li>AbstractBeanFactory (实现了 BeanFactory 的核心方法)
<ul class="org-ul">
<li><code>doGetBean(...)</code></li>
</ul></li>
<li>DefaultListableBeanFactory</li>
</ul></li>
<li>BeanDefinition <code>Bean定义</code>
<ul class="org-ul">
<li>BeanDefinition 描述 Bean 实例定义的相关信息</li>
<li>BeanDefinition 提供 BeanFactoryPostProcessor 操作属性的最小接口</li>
<li>抽象类 <code>AbstractBeanDefinition</code> 实现了一些常用的方法
<ul class="org-ul">
<li><code>setBeanClassName(...)</code></li>
<li><code>isSingleton(...)</code></li>
</ul></li>
<li>BeanDefinitionReader 接口提供 <code>loadBeanDefinitions(...)</code> 方法
<ul class="org-ul">
<li>读取 BeanDefinition 对象</li>
<li>在 <code>XmlBeanDefinitionReader</code> 具体实现 <code>doLoadBeanDefinitions(...)</code> 读取
XML 中定义的 Bean 数据</li>
</ul></li>
</ul></li>
<li>SingletonBeanRegistry <code>单例 Bean 注册</code>
<ul class="org-ul">
<li><code>registerSingleton(...)</code> 方法提供注册单例 Bean 入口</li>
<li>常见的实现类 <code>DefaultSingletonBeanRegistry</code>
<ul class="org-ul">
<li><code>registerBeanDefinition(...)</code> 注册 BeanDefinition
<ul class="org-ul">
<li><code>Map&lt;String, BeanDefinition&gt; beanDefinitionMap</code></li>
<li><code>registerBeanDefinition(...)</code> 添加 BeanDefinition 到
beanDefinitionMap</li>
</ul></li>
<li>三级缓存解决循环依赖
<ul class="org-ul">
<li><code>Map&lt;String, Object&gt; singletonObjects</code></li>
<li><code>Map&lt;String, Object&gt; earlySingletonObjects</code></li>
<li><code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories</code></li>
</ul></li>
</ul></li>
</ul></li>
<li>ApplicationContext <code>应用上下文</code>
<ul class="org-ul">
<li>AbstractApplicationContext
<ul class="org-ul">
<li><code>refresh()</code> 实现 Spring Bean 加载的核心逻辑</li>
<li>包含 15 个子函数处理 Bean 全生命周期的事情</li>
</ul></li>
<li><code>ClassPathXmlApplicationContext</code> 读取 XML 文件中的 BeanDefinition</li>
<li><code>AnnotationConfigApplicationContext</code> 扫描包含 <code>@Component</code> 注解的
BeanDefinition</li>
</ul></li>
<li>BeanFactoryPostProcessor <code>Bean工厂后置处理器</code>
<ul class="org-ul">
<li>函数式接口 <code>@FunctionalInterface</code></li>
<li>提供注册 Registration</li>
<li>处理加载顺序 Ordering</li>
<li><code>postProcessBeanFactory(...)</code> beanFactory 初始化过后调用</li>
<li>常见子接口
<ul class="org-ul">
<li><code>BeanDefinitionRegistryPostProcessor</code>
<ul class="org-ul">
<li>提交 SPI 机制，提供 BeanDefinition 注册机制</li>
<li><code>postProcessBeanDefinitionRegistry(...)</code> 注册器后置处理器</li>
</ul></li>
</ul></li>
</ul></li>
<li>BeanPostProcessor <code>Bean后置处理器</code>
<ul class="org-ul">
<li>提供自定义 Bean 实例化的处理接口扩展</li>
<li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化前置处理方法</li>
</ul></li>
<li><code>postProcessAfterInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化后置处理方法</li>
</ul></li>
<li>常见子接口
<ul class="org-ul">
<li><code>InstantiationAwareBeanPostProcessor</code>
<ul class="org-ul">
<li><code>postProcessBeforeInstantiation(...)</code></li>
<li><code>postProcessAfterInitialization(...)</code></li>
<li><code>postProcessAfterInstantiation(...)</code></li>
<li><code>postProcessBeforeInitialization(...)</code></li>
</ul></li>
<li><code>SmartInstantiationAwareBeanPostProcessor</code>
<ul class="org-ul">
<li>继承自 <code>InstantiationAwareBeanPostProcessor</code></li>
<li><code>determineCandidateConstructors(...)</code></li>
<li><code>predictBeanType(...)</code></li>
<li><code>getEarlyBeanReference(...)</code></li>
</ul></li>
<li><code>DestructionAwareBeanPostProcessor</code>
<ul class="org-ul">
<li><code>postProcessBeforeDestruction(...)</code></li>
<li><code>requiresDestruction(...)</code></li>
</ul></li>
<li><code>MergedBeanDefinitionPostProcessor</code>
<ul class="org-ul">
<li><code>postProcessMergedBeanDefinition(...)</code></li>
<li><code>resetBeanDefinition(...)</code></li>
</ul></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org700d173" class="outline-3">
<h3 id="org700d173"><span class="section-number-3">1.2</span> IoC 的理解</h3>
<div class="outline-text-3" id="text-1-2">
<p>
IoC 叫做控制反转 (Inversion of Control)
</p>
<ol class="org-ol">
<li>通过 Spring 来管理 Bean 的创建、配置和生命周期，相当于把控制权交给了框架</li>
<li>这样做的好处就是解耦，不需要人工来管理对象之间复杂的依赖关系</li>
<li>在 Spring 里面，主要提供了 BeanFactory 和 ApplicationContext 两种 IOC 容器，
通过他们来实现对 Bean 的管理</li>
</ol>
</div>
</div>

<div id="outline-container-org0d9a5a5" class="outline-3">
<h3 id="org0d9a5a5"><span class="section-number-3">1.3</span> IoC 核心方法</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li><code>getBean()</code> 获取 Bean</li>
<li><code>doGetBean()</code> 真正获取 Bean</li>
<li><code>transformedBeanName()</code> 转换 Bean 名称</li>
<li><code>getSingleton()</code> 获取单例 Bean</li>
<li><code>getParentBeanFactory()</code> 获取父 Bean 工厂</li>
<li><code>getDependsOn()</code> 获取依赖项</li>
<li><code>getSingleton()</code> 获取单例 Bean</li>
<li><code>createBean()</code> 创建 Bean</li>
<li><code>resolveBeforeInstantiation()</code> 实例化前解析</li>
<li><code>doCreateBean()</code> 真正创建 Bean</li>
<li><code>createBeanInstance()</code> 创建 Bean 实例</li>
<li><code>addSingletonFactory()</code> 添加单例工厂</li>
<li><code>populateBean()</code> 填充 Bean 属性</li>
<li><code>initializeBean()</code> 初始化 Bean</li>
<li><code>addSingleton()</code> 添加单例 Bean</li>
</ol>

<p>
添加单例的典型调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">addSingleton:134, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
registerSingleton:123, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
registerSingleton:1061, DefaultListableBeanFactory (org.springframework.beans.factory.support)
prepareBeanFactory:680, AbstractApplicationContext (org.springframework.context.support)
refresh:525, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:29, MyApp02 (io.github.jeanhwea.app02_bean_lifecycle)
</pre>
</div>

<p>
添加单例工厂的典型调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">addSingletonFactory:152, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doCreateBean:588, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1519736165 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$36)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:29, MyApp02 (io.github.jeanhwea.app02_bean_lifecycle)
</pre>
</div>

<p>
填充 Bean 的典型调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">populateBean:1370, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:594, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1519736165 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$36)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:29, MyApp02 (io.github.jeanhwea.app02_bean_lifecycle)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org769f7b0" class="outline-2">
<h2 id="org769f7b0"><span class="section-number-2">2</span> 容器实现原理</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org6446d04" class="outline-3">
<h3 id="org6446d04"><span class="section-number-3">2.1</span> Bean 工厂接口: BeanFactory</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<code>BeanFactory</code> 是 Spring 的 Bean 工厂的接口定义，它定义对 Spring Bean 容器访问的
基本操作方法，这里简化如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">BeanFactory</span> <span style="color: #8d5649;">{</span>

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">FactoryBean &#30340; beanName &#21069;&#32512;</span>
  <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">FACTORY_BEAN_PREFIX</span> = <span style="color: #2d9574;">"&amp;"</span>;

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462; Bean &#30340;&#20027;&#26041;&#27861;</span>
  <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
  <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">Object</span>... <span style="color: #7590db;">args</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">requiredType</span>, <span style="color: #ce537a; font-weight: bold;">Object</span>... <span style="color: #7590db;">args</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;

  <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ce537a; font-weight: bold;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">requiredType</span><span style="color: #d8241f;">)</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ce537a; font-weight: bold;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">ResolvableType</span> <span style="color: #7590db;">requiredType</span><span style="color: #d8241f;">)</span>;

  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">containsBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #d8241f;">)</span>;

  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isSingleton</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span>;
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isPrototype</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span>;

  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">ResolvableType</span> <span style="color: #7590db;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span>;
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span>;

  <span style="color: #a45bad;">@Nullable</span>
  <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #bc6ec5; font-weight: bold;">getType</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span>;
  <span style="color: #a45bad;">@Nullable</span>
  <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #bc6ec5; font-weight: bold;">getType</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">allowFactoryBeanInit</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span>;

  <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #bc6ec5; font-weight: bold;">getAliases</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9491da" class="outline-3">
<h3 id="orgc9491da"><span class="section-number-3">2.2</span> Bean 工厂的实现类: DefaultListableBeanFactory</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<code>DefaultListableBeanFactory</code> 是实现 <code>BeanFactory</code> 接口的核心类，熟悉它的类继
承和实现接口是了解 Bean 工厂功能的基本方法， <code>DefaultListableBeanFactory</code> 的
关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultListableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory
                            org.springframework.beans.factory.support.DefaultListableBeanFactory

    All Implemented Interfaces:
        Serializable, BeanFactory, AutowireCapableBeanFactory,
        ConfigurableBeanFactory, ConfigurableListableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory, ListableBeanFactory,
        BeanDefinitionRegistry, org.springframework.core.AliasRegistry

    Direct Known Subclasses:
        XmlBeanFactory
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><code>SimpleAliasRegistry</code> 实现了 <code>AliasRegistry</code> 接口
<ul class="org-ul">
<li><code>AliasRegistry</code> 定义了对别名的增删查改操作</li>
</ul></li>
<li><code>DefaultSingletonBeanRegistry</code> 实现了 <code>SingletonBeanRegistry</code> 接口
<ul class="org-ul">
<li><code>SingletonBeanRegistry</code> 定义了对单例 Bean 的注册及获取方法</li>
<li><code>SingletonBeanRegistry</code> 通过三级缓存来解决循环依赖</li>
</ul></li>
<li><code>FactoryBeanRegistrySupport</code> 实现了对 <code>FactoryBean</code> 的操作支持
<ul class="org-ul">
<li>在 Spring 管理中, <code>FactoryBean</code> 的 beanName 以 <code>&amp;</code> 开头</li>
<li><code>FactoryBean</code> 的创建方式和普通 Spring Bean 是不一样的，它没有
BeanDefinition, 直接通过实现 <code>T getObject()</code> 方法来返回创建的 Bean 对象</li>
<li><code>FactoryBean</code> 还需要实现一些其他的方法，例如： <code>isSingleton()</code>,
<code>getObjectType()</code></li>
</ul></li>
<li><code>AbstractBeanFactory</code> 实现了 <code>BeanFactory</code> 接口
<ul class="org-ul">
<li><code>BeanFactory</code> 接口的直接实现是 <code>AbstractBeanFactory</code> 抽象类</li>
<li><code>AbstractBeanFactory</code> 有很多核心方法
<ul class="org-ul">
<li><code>doGetBean(...)</code> 实现了获取 Bean 的核心逻辑</li>
<li><code>isSingleton(...)</code> 实现了判断 Bean 是否单例的核心逻辑</li>
<li><code>isPrototype(...)</code> 实现了判断 Bean 是否原型的核心逻辑</li>
</ul></li>
</ul></li>
<li><code>HierarchicalBeanFactory</code> 接口继承自 <code>BeanFactory</code>, 它增强了对 parentFactory
的支持</li>
<li><code>ConfigurableBeanFactory</code> 接口提供了配置 Factory 的各种操作
<ul class="org-ul">
<li><code>setBeanClassLoader(...)</code> 设置 Bean 的类加载器</li>
<li><code>registerDependentBean(...)</code> 方法注册依赖 Bean</li>
<li><code>registerScope(...)</code> 注册 Scope</li>
<li><code>isFactoryBean(...)</code> 判断是否为 FactoryBean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
</ul></li>
<li><code>ListableBeanFactory</code> 定义了一些获取 Bean 清单的操作
<ul class="org-ul">
<li><code>getBeanDefinitionCount()</code> 获取工厂中定义 BeanDefinition 的数量</li>
<li><code>getBeanDefinitionNames()</code> 获取工厂定义的 BeanDefinition 名称</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org2c75641" class="outline-3">
<h3 id="org2c75641"><span class="section-number-3">2.3</span> Bean 定义的读取器: XmlBeanDefinitionReader</h3>
<div class="outline-text-3" id="text-2-3">
<p>
<code>XmlBeanDefinitionReader</code> 是实现读取 BeanDefinition 的类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.xml
Class XmlBeanDefinitionReader

    java.lang.Object
        org.springframework.beans.factory.support.AbstractBeanDefinitionReader
            org.springframework.beans.factory.xml.XmlBeanDefinitionReader

    All Implemented Interfaces:
        BeanDefinitionReader, org.springframework.core.env.EnvironmentCapable
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><p>
<code>AbstractBeanDefinitionReader</code> 实现了对 BeanDefinition 的读取操作，它包含
如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistry</span> <span style="color: #7590db;">registry</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">ResourceLoader</span> <span style="color: #7590db;">resourceLoader</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">ClassLoader</span> <span style="color: #7590db;">beanClassLoader</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">Environment</span> <span style="color: #7590db;">environment</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">BeanNameGenerator</span> <span style="color: #7590db;">beanNameGenerator</span> = <span style="color: #a45bad;">DefaultBeanNameGenerator</span>.INSTANCE;
</pre>
</div>
<ul class="org-ul">
<li>registry 表示 BeanDefinition 的注册类</li>
<li>resourceLoader 实现了资源加载</li>
<li>environment 实现了读取系统环境变量和 Java 属性</li>
<li>beanNameGenerator 是 beanName 生成器</li>
</ul></li>
<li><code>XmlBeanDefinitionReader</code> 直接继承自 <code>AbstractBeanDefinitionReader</code>, 增加了
<ul class="org-ul">
<li><code>DocumentLoader</code> 将资源转化成 Document 对象功能</li>
<li>添加了对 XML 的格式验证的方法
<ul class="org-ul">
<li>DTD (Document Type Definition) 验证</li>
<li>XSD (XML Schema Definition) 验证</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgdfa362b" class="outline-3">
<h3 id="orgdfa362b"><span class="section-number-3">2.4</span> BeanDefinition 自动加载流程</h3>
<div class="outline-text-3" id="text-2-4">
<p>
<code>DefaultListableBeanFactory</code> 类定义了存储 BeanDefinition 类的哈希表, 具体定义如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/** Map of bean definition objects, keyed by bean name. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">beanDefinitionMap</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Map of singleton and non-singleton bean names, keyed by dependency type. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">allBeanNamesByType</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Map of singleton-only bean names, keyed by dependency type. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">singletonBeanNamesByType</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** List of bean definition names, in registration order. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">beanDefinitionNames</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
最终 BeanDefinition 通过调用 <code>registerBeanDefinition(...)</code> 方法注册到
<code>beanDefinitionMap</code> 中，代码的注释也写了是对 <code>BeanDefinitionRegistry</code> 的实现
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">---------------------------------------------------------------------</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">---------------------------------------------------------------------</span>

<span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2d9574;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2d9574;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #4f97d7; font-weight: bold;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionValidationException</span> <span style="color: #7590db;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2d9574;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">existingDefinition</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2d9574;">"] with ["</span> + beanDefinition + <span style="color: #2d9574;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2d9574;">"] with ["</span> + beanDefinition + <span style="color: #2d9574;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2d9574;">"] with ["</span> + beanDefinition + <span style="color: #2d9574;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #7590db;">updatedDefinitions</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Still in startup registration phase</span>
            <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.frozenBeanDefinitionNames = <span style="color: #a45bad;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #a45bad;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在 <code>registerBeanDefinition(...)</code> 方法中添加端点可以获得如下的调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">registerBeanDefinition:914, DefaultListableBeanFactory (org.springframework.beans.factory.support)
registerBeanDefinition:164, BeanDefinitionReaderUtils (org.springframework.beans.factory.support)
processBeanDefinition:311, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseDefaultElement:197, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseBeanDefinitions:176, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
doRegisterBeanDefinitions:149, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:96, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:509, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
doLoadBeanDefinitions:389, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:336, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:305, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:188, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:224, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:195, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:257, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:128, AbstractXmlApplicationContext (org.springframework.context.support)
loadBeanDefinitions:94, AbstractXmlApplicationContext (org.springframework.context.support)
refreshBeanFactory:133, AbstractRefreshableApplicationContext (org.springframework.context.support)
obtainFreshBeanFactory:637, AbstractApplicationContext (org.springframework.context.support)
refresh:522, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:144, ClassPathXmlApplicationContext (org.springframework.context.support)
&lt;init&gt;:85, ClassPathXmlApplicationContext (org.springframework.context.support)
main:10, MyApp01 (io.github.jeanhwea.app01)
</pre>
</div>

<p>
观察调用栈可以得到 BeanDefinition 的加载步骤如下:
</p>
<ol class="org-ol">
<li>入口方法为 <code>AbstractApplicationContext#refresh(...)</code></li>
<li><code>obtainFreshBeanFactory(...)</code> 方法获取 BeanFactory 的同时需要注册
BeanDefinition</li>
<li><code>XmlBeanDefinitionReader#doLoadBeanDefinitions(...)</code> 方法完成如下操作
<ul class="org-ul">
<li><p>
定义了 documentLoader 成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">DocumentLoader</span> <span style="color: #7590db;">documentLoader</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DefaultDocumentLoader</span><span style="color: #8d5649;">()</span>;
</pre>
</div></li>
<li>首先调用 <code>doLoadDocument(inputSource, resource)</code> 读取到 Document 对象</li>
<li>然后调用 <code>registerBeanDefinitions(doc, resource)</code> 完成 BeanDefinition 的
注册</li>
</ul></li>
<li>调用 <code>parseDefaultElement(...)</code> 方法对默认元素进行解析
<ul class="org-ul">
<li>对 import 类型标签解析</li>
<li>对 alias 类型标签解析</li>
<li>对 bean 类型标签解析</li>
<li>对嵌套 bean 类型标签解析</li>
</ul></li>
<li>接着对标签进行处理，最终交付到
<code>DefaultListableBeanFactory#registerBeanDefinition(...)</code> 方法进行注册</li>
</ol>
</div>
</div>

<div id="outline-container-orgfbc10b3" class="outline-3">
<h3 id="orgfbc10b3"><span class="section-number-3">2.5</span> BeanDefinition 注册的实现</h3>
<div class="outline-text-3" id="text-2-5">
<p>
<code>DefaultListableBeanFactory</code> 的 <code>registerBeanDefinition(...)</code> 才是真正实现注
册 BeanDefinition 逻辑，其代码如下：
</p>
<ol class="org-ol">
<li>对 beanDefinition 进行验证</li>
<li>检查 beanDefinition 是否存在
<ul class="org-ul">
<li>如果存在，判断是否覆盖对应的 BeanDefinition</li>
<li>如果 beanDefinition 不存在，进行创建并注册</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">---------------------------------------------------------------------</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">---------------------------------------------------------------------</span>

<span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2d9574;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2d9574;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #4f97d7; font-weight: bold;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionValidationException</span> <span style="color: #7590db;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2d9574;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">existingDefinition</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2d9574;">"] with ["</span> + beanDefinition + <span style="color: #2d9574;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2d9574;">"] with ["</span> + beanDefinition + <span style="color: #2d9574;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2d9574;">"] with ["</span> + beanDefinition + <span style="color: #2d9574;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #7590db;">updatedDefinitions</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Still in startup registration phase</span>
            <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.frozenBeanDefinitionNames = <span style="color: #a45bad;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #a45bad;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在上面注册过程中， <code>hasBeanCreationStarted()</code> 方法用于判断 Bean 是否开始创建，
它实现逻辑在父类 <code>AbstractBeanFactory</code> 中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Check whether this factory's bean creation phase already started,</span>
<span style="color: #9f8766;"> * i.e. whether any bean has been marked as created in the meantime.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@since</span><span style="color: #9f8766;"> 4.2.2</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #markBeanAsCreated</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">hasBeanCreationStarted</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">!</span><span style="color: #4f97d7; font-weight: bold;">this</span>.alreadyCreated.isEmpty<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
父类 <code>AbstractBeanFactory</code> 中定义了一个集合记录正在创建的 Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/** Names of beans that have already been created at least once. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">alreadyCreated</span> = Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>256<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
创建时通过 <code>markBeanAsCreated(...)</code> 方法标记，注意对 <code>alreadyCreated</code> 的访问
是需要加锁的
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Mark the specified bean as already created (or about to be created).</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">&lt;p&gt;</span><span style="color: #9f8766;">This allows the bean factory to optimize its caching for repeated</span>
<span style="color: #9f8766;"> * creation of the specified bean.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">markBeanAsCreated</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span><span style="color: #4f97d7; font-weight: bold;">this</span>.alreadyCreated.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.mergedBeanDefinitions<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span><span style="color: #a45bad;">!</span><span style="color: #4f97d7; font-weight: bold;">this</span>.alreadyCreated.contains<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Let the bean definition get re-merged now that we're actually creating</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">the bean... just in case some of its metadata changed in the meantime.</span>
                clearMergedBeanDefinition<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">this</span>.alreadyCreated.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9ef444b" class="outline-3">
<h3 id="org9ef444b"><span class="section-number-3">2.6</span> BeanDefinition 移除的实现</h3>
<div class="outline-text-3" id="text-2-6">
<p>
BeanDefinition 的移除方法如下，通过 <code>removeBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">removeBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2d9574;">"'beanName' must not be empty"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">bd</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.remove<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"No bean named '"</span> + beanName + <span style="color: #2d9574;">"' found in "</span> + <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>hasBeanCreationStarted<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
        <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #24a222;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #7590db;">updatedDefinitions</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #24a222;">&lt;&gt;(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames<span style="color: #24a222;">)</span>;
            updatedDefinitions.remove<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames = updatedDefinitions;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Still in startup registration phase</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">this</span>.frozenBeanDefinitionNames = <span style="color: #a45bad;">null</span>;

    resetBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
移除 BeanDefinition 中调用了刷新 BeanDefinition 的方法
<code>resetBeanDefinition(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Reset all bean definition caches for the given bean,</span>
<span style="color: #9f8766;"> * including the caches of beans that are derived from it.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">&lt;p&gt;</span><span style="color: #9f8766;">Called after an existing bean definition has been replaced or removed,</span>
<span style="color: #9f8766;"> * triggering </span><span style="color: #a45bad;">{@link #clearMergedBeanDefinition}</span><span style="color: #9f8766;">, </span><span style="color: #a45bad;">{@link #destroySingleton}</span>
<span style="color: #9f8766;"> * and </span><span style="color: #a45bad;">{@link MergedBeanDefinitionPostProcessor#resetBeanDefinition}</span><span style="color: #9f8766;"> on the</span>
<span style="color: #9f8766;"> * given bean and on all bean definitions that have the given bean as parent.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean to reset</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #registerBeanDefinition</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #removeBeanDefinition</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">resetBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Remove the merged bean definition for the given bean, if already created.</span>
    clearMergedBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Remove corresponding bean from singleton cache, if any. Shouldn't usually</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">be necessary, rather just meant for overriding a context's default beans</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">(e.g. the default StaticMessageSource in a StaticApplicationContext).</span>
    destroySingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Notify all post-processors that the specified bean definition has been reset.</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span> <span style="color: #7590db;">processor</span> : getBeanPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>processor <span style="color: #4f97d7; font-weight: bold;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">MergedBeanDefinitionPostProcessor</span><span style="color: #ff7f00;">)</span> processor<span style="color: #24a222;">)</span>.resetBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Reset all bean definitions that have the given bean as parent (recursively).</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">bdName</span> : <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>beanName.equals<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">bd</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.get<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span>;
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Ensure bd is non-null due to potential concurrent modification</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">of the beanDefinitionMap.</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>bd != <span style="color: #a45bad;">null</span> &amp;&amp; beanName.equals<span style="color: #ff7f00;">(</span>bd.getParentName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                resetBeanDefinition<span style="color: #ff7f00;">(</span>bdName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e68f27" class="outline-3">
<h3 id="org4e68f27"><span class="section-number-3">2.7</span> BeanDefinition 获取的实现</h3>
<div class="outline-text-3" id="text-2-7">
<p>
<code>DefaultListableBeanFactory</code> 的实现获取 BeanDefinition 的逻辑如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #bc6ec5; font-weight: bold;">getBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">bd</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"No bean named '"</span> + beanName + <span style="color: #2d9574;">"' found in "</span> + <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> bd;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9fb0c0" class="outline-3">
<h3 id="orge9fb0c0"><span class="section-number-3">2.8</span> <code>&lt;bean/&gt;</code> 标签解析</h3>
<div class="outline-text-3" id="text-2-8">
<p>
之前在 BeanDefinition 自动加载流程中忽略了对 <code>&lt;bean/&gt;</code> 标签的解析，其核心实现
逻辑 <code>BeanDefinitionDocumentReader</code> 类中的 <code>processBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Process the given bean element, parsing the bean definition</span>
<span style="color: #9f8766;"> * and registering it with the registry.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">processBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">ele</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinitionParserDelegate</span> <span style="color: #7590db;">delegate</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">BeanDefinitionHolder</span> <span style="color: #7590db;">bdHolder</span> = delegate.parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>bdHolder != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        bdHolder = delegate.decorateBeanDefinitionIfRequired<span style="color: #9564bf;">(</span>ele, bdHolder<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register the final decorated instance.</span>
            BeanDefinitionReaderUtils.registerBeanDefinition<span style="color: #24a222;">(</span>bdHolder, getReaderContext<span style="color: #ff7f00;">()</span>.getRegistry<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionStoreException</span> <span style="color: #7590db;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getReaderContext<span style="color: #24a222;">()</span>.error<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Failed to register bean definition with name '"</span> +
                    bdHolder.getBeanName<span style="color: #ff7f00;">()</span> + <span style="color: #2d9574;">"'"</span>, ele, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Send registration event.</span>
        getReaderContext<span style="color: #9564bf;">()</span>.fireComponentRegistered<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanComponentDefinition</span><span style="color: #24a222;">(</span>bdHolder<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
可以看出对 XML 标签的解析核心逻辑为 <code>parseBeanDefinitionElement(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Parses the supplied </span><span style="color: #a45bad;">{@code </span><span style="color: #a45bad;">&lt;bean&gt;</span><span style="color: #a45bad;">}</span><span style="color: #9f8766;"> element. May return </span><span style="color: #a45bad;">{@code null}</span>
<span style="color: #9f8766;"> * if there were errors during parse. Errors are reported to the</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">{@link org.springframework.beans.factory.parsing.ProblemReporter}</span><span style="color: #9f8766;">.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #a45bad;">@Nullable</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionHolder</span> <span style="color: #bc6ec5; font-weight: bold;">parseBeanDefinitionElement</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">ele</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">containingBean</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">id</span> = ele.getAttribute<span style="color: #d8241f;">(</span>ID_ATTRIBUTE<span style="color: #d8241f;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">nameAttr</span> = ele.getAttribute<span style="color: #d8241f;">(</span>NAME_ATTRIBUTE<span style="color: #d8241f;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">aliases</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>nameAttr<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #7590db;">nameArr</span> = StringUtils.tokenizeToStringArray<span style="color: #9564bf;">(</span>nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS<span style="color: #9564bf;">)</span>;
        aliases.addAll<span style="color: #9564bf;">(</span>Arrays.asList<span style="color: #24a222;">(</span>nameArr<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span> = id;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>StringUtils.hasText<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> &amp;&amp; <span style="color: #a45bad;">!</span>aliases.isEmpty<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanName = aliases.remove<span style="color: #9564bf;">(</span>0<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"No XML 'id' specified - using '"</span> + beanName +
                    <span style="color: #2d9574;">"' as bean name and "</span> + aliases + <span style="color: #2d9574;">" as aliases"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>containingBean == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        checkNameUniqueness<span style="color: #9564bf;">(</span>beanName, aliases, ele<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">AbstractBeanDefinition</span> <span style="color: #7590db;">beanDefinition</span> = parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele, beanName, containingBean<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanDefinition != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>StringUtils.hasText<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>containingBean != <span style="color: #a45bad;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    beanName = BeanDefinitionReaderUtils.generateBeanName<span style="color: #1776b6;">(</span>
                            beanDefinition, <span style="color: #4f97d7; font-weight: bold;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>, <span style="color: #a45bad;">true</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #ff7f00;">{</span>
                    beanName = <span style="color: #4f97d7; font-weight: bold;">this</span>.readerContext.generateBeanName<span style="color: #1776b6;">(</span>beanDefinition<span style="color: #1776b6;">)</span>;
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register an alias for the plain bean class name, if still possible,</span>
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if the generator returned the class name plus a suffix.</span>
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">This is expected for Spring 1.2/2.0 backwards compatibility.</span>
                    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanClassName</span> = beanDefinition.getBeanClassName<span style="color: #1776b6;">()</span>;
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>beanClassName != <span style="color: #a45bad;">null</span> &amp;&amp;
                            beanName.startsWith<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span> &amp;&amp; beanName.length<span style="color: #00bed1;">()</span> &gt; beanClassName.length<span style="color: #00bed1;">()</span> &amp;&amp;
                            <span style="color: #a45bad;">!</span><span style="color: #4f97d7; font-weight: bold;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>.isBeanNameInUse<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        aliases.add<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>logger.isTraceEnabled<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    logger.trace<span style="color: #1776b6;">(</span><span style="color: #2d9574;">"Neither XML 'id' nor 'name' specified - "</span> +
                            <span style="color: #2d9574;">"using generated bean name ["</span> + beanName + <span style="color: #2d9574;">"]"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">Exception</span> <span style="color: #7590db;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                error<span style="color: #ff7f00;">(</span>ex.getMessage<span style="color: #1776b6;">()</span>, ele<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #7590db;">aliasesArray</span> = StringUtils.toStringArray<span style="color: #9564bf;">(</span>aliases<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionHolder</span><span style="color: #9564bf;">(</span>beanDefinition, beanName, aliasesArray<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org35cd457" class="outline-2">
<h2 id="org35cd457"><span class="section-number-2">3</span> Bean 实现原理</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgc5aca46" class="outline-3">
<h3 id="orgc5aca46"><span class="section-number-3">3.1</span> Bean 的生命周期</h3>
<div class="outline-text-3" id="text-3-1">
<p>
SpringBean 生命周期简单概括为 4 个阶段：
</p>
<ol class="org-ol">
<li><b>实例化</b>: 创建一个 Bean 对象</li>
<li><b>填充属性</b>: 为属性赋值</li>
<li><b>初始化</b>: 包括如下的基本逻辑
<ul class="org-ul">
<li>如果实现了 xxxAware 接口， 通过不同类型的 Aware 接口拿到 Spring 容器的资源</li>
<li>如果实现了 BeanPostProcessor 接口，则会回调该接口的
<ul class="org-ul">
<li>postProcessBeforeInitialzation 方法</li>
<li>postProcessAfterInitialization 方法</li>
</ul></li>
<li>如果配置了 init-method 方法，则会执行 init-method 配置的方法</li>
</ul></li>
<li><b>销毁</b>: 容器关闭后，如果 Bean 实现了 DisposableBean 接口， 则会回调该接口
的 destroy 方法如果配置了 destroy-method 方法，则会执行 destroy-method 配
置的方法</li>
</ol>

<p>
<code>BeanFactory</code> 的注释中完整地说明的实现标准 BeanFactory 的代码
</p>
<ol class="org-ol">
<li>BeanFactory 初始化过程，支持的标准 Bean 的生命周期
<ul class="org-ul">
<li><code>BeanNameAware#setBeanName(...)</code></li>
<li><code>BeanClassLoaderAware#setBeanClassLoader(...)</code></li>
<li><code>BeanFactoryAware#setBeanFactory(...)</code></li>
<li><code>EnvironmentAware#setEnvironment(...)</code></li>
<li><code>EmbeddedValueResolverAware#setEmbeddedValueResolver(...)</code></li>
<li><code>ResourceLoaderAware#setResourceLoader(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationEventPublisherAware#setApplicationEventPublisher(...)</code> 在
ApplicationContext 中</li>
<li><code>MessageSourceAware#setMessageSource(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationContextAware#setApplicationContext(...)</code> 在
ApplicationContext 中</li>
<li><code>ServletContextAware#setServletContext(...)</code> 在 ApplicationContext 中</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessBeforeInitialization(...)</code> 方法</li>
<li><code>InitializingBean#afterPropertiesSet(...)</code></li>
<li>a custom init-method definition</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessAfterInitialization(...)</code> 方法</li>
</ul></li>
<li>关闭 BeanFactory 时，执行的 Bean 销毁方法
<ul class="org-ul">
<li><code>DestructionAwareBeanPostProcessors</code> 的一系列
<code>postProcessBeforeDestruction(...)</code> 方法</li>
<li><code>DisposableBean#destroy(...)</code></li>
<li>a custom destroy-method definition</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org90aba18" class="outline-3">
<h3 id="org90aba18"><span class="section-number-3">3.2</span> Bean 的流程分析</h3>
<div class="outline-text-3" id="text-3-2">
<p>
实例化 Bean 的方法为 <code>BeanUtils#instantiateClass(...)</code>, 先添加断点获取调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">instantiateClass:185, BeanUtils (org.springframework.beans)
instantiate:87, SimpleInstantiationStrategy (org.springframework.beans.factory.support)
instantiateBean:1312, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBeanInstance:1214, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:557, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1027007693 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$29)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
main:18, MyApp02 (io.github.jeanhwea.app02)
</pre>
</div>

<p>
先分析调用栈，可以知道创建 Bean 的入口是 <code>refresh()</code> 方法的
<code>invokeBeanFactoryPostProcessors()</code> 方法，这里牵扯到几个核心的方法
</p>
<ol class="org-ol">
<li><code>AbstractApplicationContext#refresh()</code></li>
<li><code>AbstractBeanFactory#doGetBean(...)</code></li>
<li><code>AbstractAutowireCapableBeanFactory#instantiateBean(...)</code></li>
</ol>
</div>

<div id="outline-container-org47bceb8" class="outline-4">
<h4 id="org47bceb8"><span class="section-number-4">3.2.1</span> 实例化 Bean: <code>instantiateBean()</code> 方法</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
<code>instantiateBean(...)</code> 实例化 Bean 主要完成如下工作
</p>
<ol class="org-ol">
<li>使用 InstantiationStrategy 实例化策略来实例化 Bean, Spring 中创建 Bean 有如
下两种方式
<ul class="org-ul">
<li>通过 <code>BeanUtils.instantiateClass()</code> 方法创建实例</li>
<li>通过 <code>new CglibSubclassCreator(bd, owner).instantiate(ctor, args)</code> 方式
进行创建</li>
</ul></li>
<li>添加 BeanWrapper 封装 Bean 对象
<ul class="org-ul">
<li>实现类为 <code>BeanWrapperImpl</code></li>
<li><code>BeanWrapperImpl</code> 继承自 <code>AbstractNestablePropertyAccessor</code></li>
<li><code>AbstractNestablePropertyAccessor#setPropertyValue(...)</code> 方法设置属性值</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Instantiate the given bean using its default constructor.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> mbd the bean definition for the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> a BeanWrapper for the new instance</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">BeanWrapper</span> <span style="color: #bc6ec5; font-weight: bold;">instantiateBean</span><span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">beanInstance</span>;
        <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">BeanFactory</span> <span style="color: #7590db;">parent</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            beanInstance = AccessController.doPrivileged<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">PrivilegedAction</span><span style="color: #1776b6;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #1776b6;">&gt;</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">()</span> -&gt;
                    getInstantiationStrategy<span style="color: #ff7f00;">()</span>.instantiate<span style="color: #ff7f00;">(</span>mbd, beanName, parent<span style="color: #ff7f00;">)</span>,
                    getAccessControlContext<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            beanInstance = getInstantiationStrategy<span style="color: #24a222;">()</span>.instantiate<span style="color: #24a222;">(</span>mbd, beanName, parent<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #ce537a; font-weight: bold;">BeanWrapper</span> <span style="color: #7590db;">bw</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanWrapperImpl</span><span style="color: #9564bf;">(</span>beanInstance<span style="color: #9564bf;">)</span>;
        initBeanWrapper<span style="color: #9564bf;">(</span>bw<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> bw;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2d9574;">"Instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaad00f3" class="outline-4">
<h4 id="orgaad00f3"><span class="section-number-4">3.2.2</span> 获取 Bean 实例: <code>doGetBean()</code> 方法</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
<code>doGetBean(...)</code> 方法是获取 Bean 的最终处理函数，它的逻辑比较复杂，可以分成
以下流程
</p>
<ol class="org-ol">
<li>获取 beanName
<ul class="org-ul">
<li>解析带有别名的 Bean 到最终的名称</li>
<li>去除 FactoryBean 的修饰符，即 <code>&amp;</code> 前缀</li>
</ul></li>
<li>缓存获取
<ul class="org-ul">
<li>调用 <code>DefaultSingletonBeanRegistry#getSingleton()</code> 尝试从单例容器缓存中
获取</li>
<li>单例 Bean 只创建一次，创建完成直接放入缓存，参考
<code>DefaultSingletonBeanRegistry</code> 的实现</li>
<li>依赖的 Bean 避免循环依赖，只记录 <code>ObjectFactory</code> 对象, 参考
<code>singletonFactories</code> 变量的定义及循环依赖的解决方法</li>
</ul></li>
<li>创建 Bean 实例
<ul class="org-ul">
<li>获取 FactoryBean 生成的 Bean 实例
<ul class="org-ul">
<li>FactoryBean 实例需要获取到的对象是 <code>factory-method</code> 返回的 Bean 对象</li>
<li><code>getObjectForBeanInstance()</code> 方法实现了从 Bean 实例中获取 Bean 对象的
逻辑，后续再说明该方法的逻辑</li>
</ul></li>
<li>如果不是 FactoryBean
<ul class="org-ul">
<li>调用 <code>isPrototypeCurrentlyInCreation(...)</code> 判断创建原型 Bean 是否出现
循环依赖</li>
<li>尝试从 parentBeanFactory 中获取 Bean</li>
<li>将 BeanDefinition 进行合并，得到 <code>RootBeanDefinition</code>, 并检验</li>
<li>调用 <code>markBeanAsCreated()</code> 方法标记创建 Bean</li>
<li>解决 Bean 依赖
<ul class="org-ul">
<li>Bean 是动态加载的，当前待创建 Bean 的可能存在依赖项</li>
<li>解决依赖的策略是顺序寻找出所有依赖，并完成创建</li>
</ul></li>
<li>通过不同的 scope 完成对应 Bean 的创建
<ul class="org-ul">
<li>单例 Bean 创建: <code>getSingleton(...)</code></li>
<li>原型 Bean 创建: <code>getSingleton(...)</code></li>
<li>其它情况 Bean 创建，例如： <code>@RequestScope</code> <code>@SessionScope</code> 等</li>
</ul></li>
</ul></li>
</ul></li>
<li>检查 Bean 实例，完成类型转换</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Return an instance, which may be shared or independent, of the specified bean.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> name the name of the bean to retrieve</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> requiredType the required type of the bean to retrieve</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> args arguments to use when creating a bean instance using explicit arguments</span>
<span style="color: #9f8766;"> * (only applied when creating a new instance as opposed to retrieving an existing one)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> typeCheckOnly whether the instance is obtained for a type check,</span>
<span style="color: #9f8766;"> * not for actual use</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> an instance of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@throws</span><span style="color: #9f8766;"> BeansException if the bean could not be created</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #a45bad;">@SuppressWarnings</span><span style="color: #8d5649;">(</span><span style="color: #2d9574;">"unchecked"</span><span style="color: #8d5649;">)</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ce537a; font-weight: bold;">T</span> <span style="color: #bc6ec5; font-weight: bold;">doGetBean</span><span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">requiredType</span>,
        <span style="color: #a45bad;">@Nullable</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">args</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">typeCheckOnly</span><span style="color: #8d5649;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span> = transformedBeanName<span style="color: #d8241f;">(</span>name<span style="color: #d8241f;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Eagerly check singleton cache for manually registered singletons.</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">sharedInstance</span> = getSingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>sharedInstance != <span style="color: #a45bad;">null</span> &amp;&amp; args == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>isSingletonCurrentlyInCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Returning eagerly cached instance of singleton bean '"</span> + beanName +
                        <span style="color: #2d9574;">"' that is not fully initialized yet - a consequence of a circular reference"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Returning cached instance of singleton bean '"</span> + beanName + <span style="color: #2d9574;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        bean = getObjectForBeanInstance<span style="color: #9564bf;">(</span>sharedInstance, name, beanName, <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Fail if we're already creating this bean instance:</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">We're assumably within a circular reference.</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>isPrototypeCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Check if bean definition exists in this factory.</span>
        <span style="color: #ce537a; font-weight: bold;">BeanFactory</span> <span style="color: #7590db;">parentBeanFactory</span> = getParentBeanFactory<span style="color: #9564bf;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>parentBeanFactory != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #a45bad;">!</span>containsBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Not found -&gt; check parent.</span>
            <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">nameToLookup</span> = originalBeanName<span style="color: #24a222;">(</span>name<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>parentBeanFactory <span style="color: #4f97d7; font-weight: bold;">instanceof</span> AbstractBeanFactory<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">AbstractBeanFactory</span><span style="color: #1776b6;">)</span> parentBeanFactory<span style="color: #ff7f00;">)</span>.doGetBean<span style="color: #ff7f00;">(</span>
                        nameToLookup, requiredType, args, typeCheckOnly<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>args != <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Delegation to parent with explicit args.</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, args<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>requiredType != <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">No args -&gt; delegate to standard getBean method.</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, requiredType<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>typeCheckOnly<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            markBeanAsCreated<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span> = getMergedLocalBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            checkMergedBeanDefinition<span style="color: #24a222;">(</span>mbd, beanName, args<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Guarantee initialization of beans that the current bean depends on.</span>
            <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #24a222;">[]</span> <span style="color: #7590db;">dependsOn</span> = mbd.getDependsOn<span style="color: #24a222;">()</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>dependsOn != <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">dep</span> : dependsOn<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>isDependent<span style="color: #00bed1;">(</span>beanName, dep<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #2d9574;">"Circular depends-on relationship between '"</span> + beanName + <span style="color: #2d9574;">"' and '"</span> + dep + <span style="color: #2d9574;">"'"</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    registerDependentBean<span style="color: #1776b6;">(</span>dep, beanName<span style="color: #1776b6;">)</span>;
                    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #1776b6;">{</span>
                        getBean<span style="color: #00bed1;">(</span>dep<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">NoSuchBeanDefinitionException</span> <span style="color: #7590db;">ex</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #2d9574;">"'"</span> + beanName + <span style="color: #2d9574;">"' depends on missing bean '"</span> + dep + <span style="color: #2d9574;">"'"</span>, ex<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Create bean instance.</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>mbd.isSingleton<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                sharedInstance = getSingleton<span style="color: #ff7f00;">(</span>beanName, <span style="color: #1776b6;">()</span> -&gt; <span style="color: #1776b6;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">return</span> createBean<span style="color: #bcbf00;">(</span>beanName, mbd, args<span style="color: #bcbf00;">)</span>;
                    <span style="color: #00bed1;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #7590db;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Explicitly remove instance from singleton cache: It might have been put there</span>
                        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">eagerly by the creation process, to allow for circular reference resolution.</span>
                        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Also remove any beans that received a temporary reference to the bean.</span>
                        destroySingleton<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">throw</span> ex;
                    <span style="color: #00bed1;">}</span>
                <span style="color: #1776b6;">}</span><span style="color: #ff7f00;">)</span>;
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>sharedInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>mbd.isPrototype<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">It's a prototype -&gt; create a new instance.</span>
                <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">prototypeInstance</span> = <span style="color: #a45bad;">null</span>;
                <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #ff7f00;">{</span>
                    beforePrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                    prototypeInstance = createBean<span style="color: #1776b6;">(</span>beanName, mbd, args<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #ff7f00;">{</span>
                    afterPrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>prototypeInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">scopeName</span> = mbd.getScope<span style="color: #ff7f00;">()</span>;
                <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Scope</span> <span style="color: #7590db;">scope</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.scopes.get<span style="color: #ff7f00;">(</span>scopeName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>scope == <span style="color: #a45bad;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">IllegalStateException</span><span style="color: #1776b6;">(</span><span style="color: #2d9574;">"No Scope registered for scope name '"</span> + scopeName + <span style="color: #2d9574;">"'"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">scopedInstance</span> = scope.get<span style="color: #1776b6;">(</span>beanName, <span style="color: #00bed1;">()</span> -&gt; <span style="color: #00bed1;">{</span>
                        beforePrototypeCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #bcbf00;">{</span>
                            <span style="color: #4f97d7; font-weight: bold;">return</span> createBean<span style="color: #e574c3;">(</span>beanName, mbd, args<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                        <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #bcbf00;">{</span>
                            afterPrototypeCreation<span style="color: #e574c3;">(</span>beanName<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                    <span style="color: #00bed1;">}</span><span style="color: #1776b6;">)</span>;
                    bean = getObjectForBeanInstance<span style="color: #1776b6;">(</span>scopedInstance, name, beanName, mbd<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">IllegalStateException</span> <span style="color: #7590db;">ex</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #2d9574;">"Scope '"</span> + scopeName + <span style="color: #2d9574;">"' is not active for the current thread; consider "</span> +
                            <span style="color: #2d9574;">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,
                            ex<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #7590db;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            cleanupAfterBeanCreationFailure<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">throw</span> ex;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Check if required type matches the type of the actual bean instance.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>requiredType != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #a45bad;">!</span>requiredType.isInstance<span style="color: #9564bf;">(</span>bean<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">T</span> <span style="color: #7590db;">convertedBean</span> = getTypeConverter<span style="color: #24a222;">()</span>.convertIfNecessary<span style="color: #24a222;">(</span>bean, requiredType<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>convertedBean == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanNotOfRequiredTypeException</span><span style="color: #ff7f00;">(</span>name, requiredType, bean.getClass<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> convertedBean;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">TypeMismatchException</span> <span style="color: #7590db;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Failed to convert bean '"</span> + name + <span style="color: #2d9574;">"' to required type '"</span> +
                        ClassUtils.getQualifiedName<span style="color: #1776b6;">(</span>requiredType<span style="color: #1776b6;">)</span> + <span style="color: #2d9574;">"'"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanNotOfRequiredTypeException</span><span style="color: #24a222;">(</span>name, requiredType, bean.getClass<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">)</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd111db2" class="outline-3">
<h3 id="orgd111db2"><span class="section-number-3">3.3</span> 特殊的 Spring Bean: FactoryBean</h3>
<div class="outline-text-3" id="text-3-3">
<p>
FactoryBean 不同于普通的 Bean， FactoryBean 自身就是一个组装 Bean 的微型工厂，
即在调用 <code>BeanFactory#getBean(...)</code> 方法时不返回 FactoryBean，而是返回工厂方
法返回的 Bean，定义 FactoryBean 只需要实现 <code>FactoryBean</code> 接口即可
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">FactoryBean</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>
    <span style="color: #a45bad;">@Nullable</span>
    <span style="color: #ce537a; font-weight: bold;">T</span> <span style="color: #bc6ec5; font-weight: bold;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">Exception</span>;

    <span style="color: #a45bad;">@Nullable</span>
    <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #bc6ec5; font-weight: bold;">getObjectType</span><span style="color: #d8241f;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">default</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isSingleton</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">true</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ol class="org-ol">
<li><code>getObject(...)</code> 方法返回 FactoryBean 创建的实例，也称工厂方法</li>
<li><code>getObjectType(...)</code> 方法返回 FactoryBean 创建的实例的类型</li>
<li><code>isSingleton(...)</code> 方法返回 FactoryBean 创建的实例的 Scope</li>
</ol>
</div>
</div>

<div id="outline-container-org5232613" class="outline-3">
<h3 id="org5232613"><span class="section-number-3">3.4</span> 单例 Bean 工厂的实现</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-orgc2ef99e" class="outline-4">
<h4 id="orgc2ef99e"><span class="section-number-4">3.4.1</span> 单例 Bean 工厂的三级缓存: <code>DefaultSingletonBeanRegistry</code> 类的缓存</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
<code>DefaultSingletonBeanRegistry</code> 是对单例 Bean 注册的实现类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultSingletonBeanRegistry

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry

    All Implemented Interfaces:
        SingletonBeanRegistry, org.springframework.core.AliasRegistry
</pre>
</div>

<p>
<code>DefaultSingletonBeanRegistry</code> 定义了如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/** Cache of singleton objects: bean name to bean instance. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">singletonObjects</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Cache of singleton factories: bean name to ObjectFactory. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">ObjectFactory</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">singletonFactories</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">HashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Cache of early singleton objects: bean name to bean instance. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">earlySingletonObjects</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">HashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Set of registered singletons, containing the bean names in registration order. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">registeredSingletons</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LinkedHashSet</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Names of beans that are currently in creation. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">singletonsCurrentlyInCreation</span> =
        Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>16<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Names of beans currently excluded from in creation checks. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">inCreationCheckExclusions</span> =
        Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>16<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** List of suppressed Exceptions, available for associating related causes. */</span>
<span style="color: #a45bad;">@Nullable</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Exception</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">suppressedExceptions</span>;

<span style="color: #9f8766;">/** Flag that indicates whether we're currently within destroySingletons. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">singletonsCurrentlyInDestruction</span> = <span style="color: #a45bad;">false</span>;

<span style="color: #9f8766;">/** Disposable bean instances: bean name to disposable instance. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">disposableBeans</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LinkedHashMap</span><span style="color: #8d5649;">&lt;&gt;()</span>;

<span style="color: #9f8766;">/** Map between containing bean names: bean name to Set of bean names that the bean contains. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">containedBeanMap</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Map between dependent bean names: bean name to Set of dependent bean names. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">dependentBeanMap</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #9f8766;">/** Map between depending bean names: bean name to Set of bean names for the bean's dependencies. */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #7590db;">dependenciesForBeanMap</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;
</pre>
</div>
<p>
这里需要注意的是其定义的三级缓存结构
</p>
<ol class="org-ol">
<li>singletonObjects: 一级缓存单例 Bean 对象，用来保存实例化、初始化都完成的
对象</li>
<li>earlySingletonObjects: 二级缓存早期创建的单例 Bean 对象，用来保存实例化完
成，但是未初始化完成的对象
<ul class="org-ul">
<li>earlySingletonObjects 于 singletonObjects 不同之处是，当一个单例 Bean 还
在创建过程中可以将其依赖的单例 Bean 放入 earlySingletonObjects 哈希表内</li>
<li>这样做，即使单例 Bean 在创建过程中，调用 <code>getBean(...)</code> 方法依然可以获
取到所依赖的 Bean 对象</li>
<li>另外该方案用来循环检测，避免循环依赖</li>
</ul></li>
<li><p>
singletonFactories: 三级缓存单例对象工厂 ObjectFactory，用来保存一个对象
工厂，提供一个匿名内部类，用于创建二级缓存中的对象
</p>
<ul class="org-ul">
<li>singletonFactories 哈希表的值是 <code>ObjectFactory</code> 接口类型</li>
<li><code>ObjectFactory</code> 是个函数式接口，用于延迟创建 Bean</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@FunctionalInterface</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">ObjectFactory</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>

    <span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;">     * Return an instance (possibly shared or independent)</span>
<span style="color: #9f8766;">     * of the object managed by this factory.</span>
<span style="color: #9f8766;">     * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the resulting instance</span>
<span style="color: #9f8766;">     * </span><span style="color: #a45bad;">@throws</span><span style="color: #9f8766;"> BeansException in case of creation errors</span>
<span style="color: #9f8766;">     */</span>
    <span style="color: #ce537a; font-weight: bold;">T</span> <span style="color: #bc6ec5; font-weight: bold;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;

<span style="color: #8d5649;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-org25e2bd8" class="outline-4">
<h4 id="org25e2bd8"><span class="section-number-4">3.4.2</span> 为什么必须要三级缓存</h4>
<div class="outline-text-4" id="text-3-4-2">
<ol class="org-ol">
<li>不可以，主要是为了生成代理对象</li>
<li>因为三级缓存中放的是生成具体对象的匿名内部类
<ul class="org-ul">
<li>他可以生成代理对象</li>
<li>也可以是普通的实例对象</li>
</ul></li>
<li>使用三级缓存主要是为了保证不管什么时候使用的都是一个对象</li>
<li>假设只有二级缓存的情况
<ul class="org-ul">
<li>往二级缓存中放的显示一个普通的 Bean 对象</li>
<li>BeanPostProcessor 去生成代理对象之后，覆盖掉二级缓存中的普通 Bean 对象</li>
<li>那么多线程环境下可能取到的对象会不一致</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org47c4fd6" class="outline-4">
<h4 id="org47c4fd6"><span class="section-number-4">3.4.3</span> 获取单例 Bean 方法: <code>getSingleton(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
<code>getSingleton()</code> 方法是获取 Bean 的核心方法, 它的实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462;&#21333;&#20363;&#65292;&#21487;&#20197;&#20174; earlySingletonObjects &#20013;&#33719;&#21462;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> getSingleton<span style="color: #d8241f;">(</span>beanName, <span style="color: #a45bad;">true</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462;&#21333;&#20363;&#65292;&#28155;&#21152;&#26159;&#21542;&#21487;&#20197;&#20174; earlySingletonObjects &#20013;&#33719;&#21462;&#21442;&#25968;</span>
<span style="color: #a45bad;">@Nullable</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">allowEarlyReference</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">singletonObject</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>singletonObject == <span style="color: #a45bad;">null</span> &amp;&amp; isSingletonCurrentlyInCreation<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            singletonObject = <span style="color: #4f97d7; font-weight: bold;">this</span>.earlySingletonObjects.get<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>singletonObject == <span style="color: #a45bad;">null</span> &amp;&amp; allowEarlyReference<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">ObjectFactory</span><span style="color: #ff7f00;">&lt;</span>?<span style="color: #ff7f00;">&gt;</span> <span style="color: #7590db;">singletonFactory</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonFactories.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>singletonFactory != <span style="color: #a45bad;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    singletonObject = singletonFactory.getObject<span style="color: #1776b6;">()</span>;
                    <span style="color: #4f97d7; font-weight: bold;">this</span>.earlySingletonObjects.put<span style="color: #1776b6;">(</span>beanName, singletonObject<span style="color: #1776b6;">)</span>;
                    <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonFactories.remove<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> singletonObject;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
允许从 earlySingletonObjects 获取单例的 <code>getSingleton(...)</code> 方法逻辑比较清晰
</p>
<ol class="org-ol">
<li>先尝试从 singletonObjects 中获取 singletonObject, 如果成功直接返回
singletonObject</li>
<li>如果获取失败，则尝试从 earlySingletonObjects 中获取 singletonObject, 如果
成功直接返回 singletonObject</li>
<li>如果再次失败，尝试从 singletonFactories 中创建 singletonObject，并返回创
建结果
<ul class="org-ul">
<li>首先通过 beanName, 查找到 <code>ObjectFactory</code> 的值, 即 singletonFactory</li>
<li>若 singletonFactory 存在，调用 <code>singletonFactory.getObject(...)</code> 方法创
建 singletonObject</li>
<li>创建成功将 singletonObject, 将 singletonObject 添加到
earlySingletonObjects, 并从 singletonFactories 移除 beanName 对应的值</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462;&#21333;&#20363;&#65292;&#20027;&#35201;&#38024;&#23545;&#26410;&#21019;&#24314;&#30340; Bean &#23545;&#35937;&#65292;&#36890;&#36807; ObjectFactory &#21019;&#24314;&#23545;&#35937;&#24182;&#36820;&#22238;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">ObjectFactory</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">singletonFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>beanName, <span style="color: #2d9574;">"Bean name must not be null"</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">singletonObject</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects.get<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>singletonObject == <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.singletonsCurrentlyInDestruction<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationNotAllowedException</span><span style="color: #ff7f00;">(</span>beanName,
                        <span style="color: #2d9574;">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +
                        <span style="color: #2d9574;">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Creating shared instance of singleton bean '"</span> + beanName + <span style="color: #2d9574;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            beforeSingletonCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">newSingleton</span> = <span style="color: #a45bad;">false</span>;
            <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">recordSuppressedExceptions</span> = <span style="color: #24a222;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.suppressedExceptions == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>recordSuppressedExceptions<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">this</span>.suppressedExceptions = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LinkedHashSet</span><span style="color: #ff7f00;">&lt;&gt;()</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #24a222;">{</span>
                singletonObject = singletonFactory.getObject<span style="color: #ff7f00;">()</span>;
                newSingleton = <span style="color: #a45bad;">true</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">IllegalStateException</span> <span style="color: #7590db;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Has the singleton object implicitly appeared in the meantime -&gt;</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if yes, proceed with it since the exception indicates that state.</span>
                singletonObject = <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>singletonObject == <span style="color: #a45bad;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">throw</span> ex;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">BeanCreationException</span> <span style="color: #7590db;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>recordSuppressedExceptions<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">Exception</span> <span style="color: #7590db;">suppressedException</span> : <span style="color: #4f97d7; font-weight: bold;">this</span>.suppressedExceptions<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        ex.addRelatedCause<span style="color: #00bed1;">(</span>suppressedException<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> ex;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>recordSuppressedExceptions<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">this</span>.suppressedExceptions = <span style="color: #a45bad;">null</span>;
                <span style="color: #ff7f00;">}</span>
                afterSingletonCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>newSingleton<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                addSingleton<span style="color: #ff7f00;">(</span>beanName, singletonObject<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> singletonObject;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
获取单例 Bean 的总逻辑逻辑如下
</p>
<ol class="org-ol">
<li>首先尝试从 singletonObjects 获取 singletonObject, 获取成功直接返回
singletonObject</li>
<li>如果 singletonObjects 获取失败，则需要创建 singletonObject
<ul class="org-ul">
<li>先调用 <code>beforeSingletonCreation(...)</code> 前置钩子函数</li>
<li>调用 <code>ObjectFactory</code> 的 <code>getObject(...)</code> 方法来创建 singletonObject</li>
<li>然后调用 <code>afterSingletonCreation(...)</code> 后置钩子函数</li>
<li><p>
如果有信创建的 singletonObject, 调用 <code>addSingleton(...)</code> 来处理添加新创
建 singletonObject
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">addSingleton</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">singletonObject</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonObjects.put<span style="color: #9564bf;">(</span>beanName, singletonObject<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.singletonFactories.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.earlySingletonObjects.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.registeredSingletons.add<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ul class="org-ul">
<li><code>addSingleton(...)</code> 将新创建的 singletonObject 放入 singletonObjects,
并从 singletonFactories 和 earlySingletonObjects 中移除
singletonObject 对象</li>
<li>将 singletonObject 添加到 registeredSingletons 中，完成 Bean 的注册</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org7ff2a63" class="outline-4">
<h4 id="org7ff2a63"><span class="section-number-4">3.4.4</span> beanInstance 到 beanOject 过程: <code>getObjectForBeanInstance(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
beanInstance -&gt; beanOject 是将缓存中的 Bean 实例转化成最终用户所需对象的过程，
</p>
<ol class="org-ol">
<li>在 <code>doGetBean(...)</code> 方法中的 <code>getObjectForBeanInstance(...)</code> 方法实现</li>
<li>beanInstance 如果是非 FactoryBean, beanInstance 即为 beanOject, 直接返回
创建好的 Bean 对象</li>
<li>beanInstance 如果是 FactoryBean, 需要调用工厂方法进行处理，创建 beanOject
<ul class="org-ul">
<li>先调用 <code>getCachedObjectForFactoryBean(...)</code> 从缓存中获取，获取成功直接
返回结果</li>
<li>如果未获取成功，调用 <code>getObjectFromFactoryBean(...)</code> 创建 beanOject</li>
<li>最终通过 <code>doGetObjectFromFactoryBean(...)</code> 完成调用工厂方法并获取
beanObject 逻辑</li>
</ul></li>
</ol>

<p>
这里分析一下 <code>doGetObjectFromFactoryBean(...)</code> 的逻辑，先查看一下调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">doGetObjectFromFactoryBean:161, FactoryBeanRegistrySupport (org.springframework.beans.factory.support)
getObjectFromFactoryBean:101, FactoryBeanRegistrySupport (org.springframework.beans.factory.support)
getObjectForBeanInstance:1818, AbstractBeanFactory (org.springframework.beans.factory.support)
getObjectForBeanInstance:1266, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doGetBean:260, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:1108, AbstractApplicationContext (org.springframework.context.support)
main:25, MyApp04 (io.github.jeanhwea.app04_factory_bean)
</pre>
</div>

<p>
<code>doGetObjectFromFactoryBean(...)</code> 方法逻辑如下，可以看出在进行了一些校验工作，
最终调用 <code>factory.getObject()</code> 方法获取 beanObject
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Obtain an object to expose from the given FactoryBean.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> factory the FactoryBean instance</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the object obtained from the FactoryBean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@throws</span><span style="color: #9f8766;"> BeanCreationException if FactoryBean object creation failed</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> org.springframework.beans.factory.FactoryBean#getObject()</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">doGetObjectFromFactoryBean</span><span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">FactoryBean</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">factory</span>, <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">object</span>;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">AccessControlContext</span> <span style="color: #7590db;">acc</span> = getAccessControlContext<span style="color: #24a222;">()</span>;
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #24a222;">{</span>
                object = AccessController.doPrivileged<span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">PrivilegedExceptionAction</span><span style="color: #00bed1;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> factory::getObject, acc<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">PrivilegedActionException</span> <span style="color: #7590db;">pae</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> pae.getException<span style="color: #ff7f00;">()</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            object = factory.getObject<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">FactoryBeanNotInitializedException</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCurrentlyInCreationException</span><span style="color: #9564bf;">(</span>beanName, ex.toString<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #9564bf;">(</span>beanName, <span style="color: #2d9574;">"FactoryBean threw exception on object creation"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Do not accept a null value for a FactoryBean that's not fully</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">initialized yet: Many FactoryBeans just return null then.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>object == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>isSingletonCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>
                    beanName, <span style="color: #2d9574;">"FactoryBean which is currently in creation returned null from getObject"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        object = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">NullBean</span><span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> object;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
往上跳一级，查看 <code>FactoryBeanRegistrySupport#getObjectFromFactoryBean(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Obtain an object to expose from the given FactoryBean.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> factory the FactoryBean instance</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> shouldPostProcess whether the bean is subject to post-processing</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the object obtained from the FactoryBean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@throws</span><span style="color: #9f8766;"> BeanCreationException if FactoryBean object creation failed</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> org.springframework.beans.factory.FactoryBean#getObject()</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">getObjectFromFactoryBean</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">FactoryBean</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">factory</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">shouldPostProcess</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>factory.isSingleton<span style="color: #9564bf;">()</span> &amp;&amp; containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #9564bf;">(</span>getSingletonMutex<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">object</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.factoryBeanObjectCache.get<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>object == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                object = doGetObjectFromFactoryBean<span style="color: #ff7f00;">(</span>factory, beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Only post-process and store if not put there already during getObject() call above</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">(e.g. because of circular reference processing triggered by custom getBean calls)</span>
                <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">alreadyThere</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.factoryBeanObjectCache.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>alreadyThere != <span style="color: #a45bad;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    object = alreadyThere;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>shouldPostProcess<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #00bed1;">(</span>isSingletonCurrentlyInCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Temporarily return non-post-processed object, not storing it yet..</span>
                            <span style="color: #4f97d7; font-weight: bold;">return</span> object;
                        <span style="color: #00bed1;">}</span>
                        beforeSingletonCreation<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #00bed1;">{</span>
                            object = postProcessObjectFromFactoryBean<span style="color: #bcbf00;">(</span>object, beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #bcbf00;">(</span>beanName,
                                    <span style="color: #2d9574;">"Post-processing of FactoryBean's singleton object failed"</span>, ex<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #00bed1;">{</span>
                            afterSingletonCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>containsSingleton<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">this</span>.factoryBeanObjectCache.put<span style="color: #00bed1;">(</span>beanName, object<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> object;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">object</span> = doGetObjectFromFactoryBean<span style="color: #9564bf;">(</span>factory, beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>shouldPostProcess<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #24a222;">{</span>
                object = postProcessObjectFromFactoryBean<span style="color: #ff7f00;">(</span>object, beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #ff7f00;">(</span>beanName, <span style="color: #2d9574;">"Post-processing of FactoryBean's object failed"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> object;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>getObjectFromFactoryBean</code> 实现了获取 FactoryBean 的 beanObject 的业务逻辑
</p>
<ol class="org-ol">
<li>如果是非单例 FactoryBean，在最外层的 else 代码，直接创建 beanObject</li>
<li>如果是单例 FactoryBean
<ul class="org-ul">
<li>首先获取单例缓存池 singletonObjects 的互斥锁</li>
<li>尝试从 factoryBeanObjectCache 缓存中获取创建好的 beanObject, 如果成功
直接返回结果</li>
<li>如果缓存获取失败，则需要调用 <code>doGetObjectFromFactoryBean(...)</code> 方法创
建 beanObject，并将创建好的 beanObject 放入 factoryBeanObjectCache 缓
存中</li>
</ul></li>
<li>在上述两种情况过后都需要调用 <code>postProcessObjectFromFactoryBean(...)</code> 方法
<ul class="org-ul">
<li><code>postProcessObjectFromFactoryBean(...)</code> 是一个空方法</li>
<li>这样设计是为子类提供扩展点</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org6e642a2" class="outline-3">
<h3 id="org6e642a2"><span class="section-number-3">3.5</span> Bean 生命周期的实现</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-org48d4d07" class="outline-4">
<h4 id="org48d4d07"><span class="section-number-4">3.5.1</span> Bean 创建的实现类: <code>AbstractAutowireCapableBeanFactory</code></h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
先看 <code>AbstractAutowireCapableBeanFactory</code> 的类继承关系
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class AbstractAutowireCapableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory

    All Implemented Interfaces:
        BeanFactory, AutowireCapableBeanFactory, ConfigurableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory,
        org.springframework.core.AliasRegistry
</pre>
</div>
<ol class="org-ol">
<li><code>AbstractAutowireCapableBeanFactory</code> 实现了 <code>AutowireCapableBeanFactory</code> 接口</li>
<li><p>
<code>AutowireCapableBeanFactory</code> 中有管理 Autowire 功能 Bean 的方法
</p>
<ul class="org-ul">
<li><code>createBean(...)</code> 实例化 Bean</li>
<li><code>initializeBean(...)</code> 初始化 Bean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
<li>还有一些 Bean 的 <code>*PostProcessor*</code> 的增强函数</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">AutowireCapableBeanFactory</span> <span style="color: #4f97d7; font-weight: bold;">extends</span> <span style="color: #ce537a; font-weight: bold;">BeanFactory</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">-------------------------------------------------------------------------</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Typical methods for creating and populating external bean instances</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">-------------------------------------------------------------------------</span>
    <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> T createBean<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">beanClass</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">autowireBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">configureBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;

    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">-------------------------------------------------------------------------</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Specialized methods for fine-grained control over the bean lifecycle</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">-------------------------------------------------------------------------</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">createBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">beanClass</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">autowireMode</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">dependencyCheck</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">autowire</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">beanClass</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">autowireMode</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">dependencyCheck</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">autowireBeanProperties</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">autowireMode</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">dependencyCheck</span><span style="color: #d8241f;">)</span>
            <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">applyBeanPropertyValues</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">initializeBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">applyBeanPostProcessorsBeforeInitialization</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #d8241f;">)</span>
            <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">applyBeanPostProcessorsAfterInitialization</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #d8241f;">)</span>
            <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">destroyBean</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">existingBean</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">-------------------------------------------------------------------------</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Delegate methods for resolving injection points</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #2aa1ae; background-color: #292e34;">-------------------------------------------------------------------------</span>
    <span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ce537a; font-weight: bold;">NamedBeanHolder</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #d8241f;">&gt;</span> resolveNamedBean<span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">resolveBeanByName</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">DependencyDescriptor</span> <span style="color: #7590db;">descriptor</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #a45bad;">@Nullable</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">resolveDependency</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">DependencyDescriptor</span> <span style="color: #7590db;">descriptor</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">requestingBeanName</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
    <span style="color: #a45bad;">@Nullable</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">resolveDependency</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">DependencyDescriptor</span> <span style="color: #7590db;">descriptor</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">requestingBeanName</span>,
            <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">autowiredBeanNames</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">TypeConverter</span> <span style="color: #7590db;">typeConverter</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org59d1433" class="outline-4">
<h4 id="org59d1433"><span class="section-number-4">3.5.2</span> Bean 的实例化: <code>createBean(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
实际实例化 Bean 是在 <code>doCreateBean(...)</code> 方法中完成的，先准备一下调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">doCreateBean:552, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1989335500 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:21, MyApp04 (io.github.jeanhwea.app04_factory_bean)
</pre>
</div>

<p>
<code>createBean(...)</code> 方法实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Central method of this class: creates a bean instance,</span>
<span style="color: #9f8766;"> * populates the bean instance, applies post-processors, etc.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #doCreateBean</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">createBean</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">args</span><span style="color: #8d5649;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"Creating instance of bean '"</span> + beanName + <span style="color: #2d9574;">"'"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbdToUse</span> = mbd;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Make sure bean class is actually resolved at this point, and</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">clone the bean definition in case of a dynamically resolved Class</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">which cannot be stored in the shared merged bean definition.</span>
    <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">resolvedClass</span> = resolveBeanClass<span style="color: #d8241f;">(</span>mbd, beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>resolvedClass != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #a45bad;">!</span>mbd.hasBeanClass<span style="color: #9564bf;">()</span> &amp;&amp; mbd.getBeanClassName<span style="color: #9564bf;">()</span> != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        mbdToUse = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span><span style="color: #9564bf;">(</span>mbd<span style="color: #9564bf;">)</span>;
        mbdToUse.setBeanClass<span style="color: #9564bf;">(</span>resolvedClass<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Prepare method overrides.</span>
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        mbdToUse.prepareMethodOverrides<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionValidationException</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>,
                beanName, <span style="color: #2d9574;">"Validation of method overrides failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span> = resolveBeforeInstantiation<span style="color: #9564bf;">(</span>beanName, mbdToUse<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>bean != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #9564bf;">(</span>mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>, beanName,
                <span style="color: #2d9574;">"BeanPostProcessor before instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">beanInstance</span> = doCreateBean<span style="color: #9564bf;">(</span>beanName, mbdToUse, args<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Finished creating instance of bean '"</span> + beanName + <span style="color: #2d9574;">"'"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> beanInstance;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span>BeanCreationException | ImplicitlyAppearedSingletonException ex<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">A previously detected exception with proper bean creation context already,</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2d9574;">"Unexpected exception during bean creation"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>

</pre>
</div>
<p>
该方法的流程如下
</p>
<ol class="org-ol">
<li>通过 BeanDefinition 和 beanName 解析获取到待创建的类 resolvedClass</li>
<li>对 override 属性进行标记及验证
<ul class="org-ul">
<li><code>lookup-method</code>, <code>replace-method</code> 等</li>
</ul></li>
<li>处理 BeanPostProcessors, 进行一些前置处理工作
<ul class="org-ul">
<li><p>
<code>resolveBeforeInstantiation(...)</code> 方法完成前置处理工作
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Apply before-instantiation post-processors, resolving whether there is a</span>
<span style="color: #9f8766;"> * before-instantiation shortcut for the specified bean.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> mbd the bean definition for the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the shortcut-determined bean instance, or </span><span style="color: #a45bad;">{@code null}</span><span style="color: #9f8766;"> if none</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #a45bad;">@Nullable</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">resolveBeforeInstantiation</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span> = <span style="color: #a45bad;">null</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span><span style="color: #a45bad;">Boolean</span>.FALSE.equals<span style="color: #9564bf;">(</span>mbd.beforeInstantiationResolved<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Make sure bean class is actually resolved at this point.</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>mbd.isSynthetic<span style="color: #24a222;">()</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #24a222;">&lt;</span>?<span style="color: #24a222;">&gt;</span> <span style="color: #7590db;">targetType</span> = determineTargetType<span style="color: #24a222;">(</span>beanName, mbd<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>targetType != <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                bean = applyBeanPostProcessorsBeforeInstantiation<span style="color: #ff7f00;">(</span>targetType, beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>bean != <span style="color: #a45bad;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    bean = applyBeanPostProcessorsAfterInitialization<span style="color: #1776b6;">(</span>bean, beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        mbd.beforeInstantiationResolved = <span style="color: #9564bf;">(</span>bean != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li><code>applyBeanPostProcessorsBeforeInstantiation(...)</code> 方法在实例化前调用</li>
<li><code>applyBeanPostProcessorsAfterInitialization(...)</code> 方法在初始化后调用</li>
</ul></li>
<li>调用 <code>doCreateBean(...)</code> 创建 Bean 实例 beanInstance, 并返回 beanInstance</li>
</ol>

<p>
<code>doCreateBean(...)</code> 方法实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Actually create the specified bean. Pre-creation processing has already happened</span>
<span style="color: #9f8766;"> * at this point, e.g. checking </span><span style="color: #a45bad;">{@code postProcessBeforeInstantiation}</span><span style="color: #9f8766;"> callbacks.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">&lt;p&gt;</span><span style="color: #9f8766;">Differentiates between default bean instantiation, use of a</span>
<span style="color: #9f8766;"> * factory method, and autowiring a constructor.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> mbd the merged bean definition for the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> args explicit arguments to use for constructor or factory method invocation</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> a new instance of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@throws</span><span style="color: #9f8766;"> BeanCreationException if the bean could not be created</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #instantiateBean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #instantiateUsingFactoryMethod</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #autowireConstructor</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">doCreateBean</span><span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span>, <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">args</span><span style="color: #8d5649;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Instantiate the bean.</span>
    <span style="color: #ce537a; font-weight: bold;">BeanWrapper</span> <span style="color: #7590db;">instanceWrapper</span> = <span style="color: #a45bad;">null</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>mbd.isSingleton<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        instanceWrapper = <span style="color: #4f97d7; font-weight: bold;">this</span>.factoryBeanInstanceCache.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>instanceWrapper == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        instanceWrapper = createBeanInstance<span style="color: #9564bf;">(</span>beanName, mbd, args<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span> = instanceWrapper.getWrappedInstance<span style="color: #d8241f;">()</span>;
    <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">beanType</span> = instanceWrapper.getWrappedClass<span style="color: #d8241f;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanType != NullBean.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        mbd.resolvedTargetType = beanType;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Allow post-processors to modify the merged bean definition.</span>
    <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #d8241f;">(</span>mbd.postProcessingLock<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>mbd.postProcessed<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #24a222;">{</span>
                applyMergedBeanDefinitionPostProcessors<span style="color: #ff7f00;">(</span>mbd, beanType, beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #ff7f00;">(</span>mbd.getResourceDescription<span style="color: #1776b6;">()</span>, beanName,
                        <span style="color: #2d9574;">"Post-processing of merged bean definition failed"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            mbd.postProcessed = <span style="color: #a45bad;">true</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Eagerly cache singletons to be able to resolve circular references</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
    <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">earlySingletonExposure</span> = <span style="color: #d8241f;">(</span>mbd.isSingleton<span style="color: #9564bf;">()</span> &amp;&amp; <span style="color: #4f97d7; font-weight: bold;">this</span>.allowCircularReferences &amp;&amp;
            isSingletonCurrentlyInCreation<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>earlySingletonExposure<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Eagerly caching bean '"</span> + beanName +
                    <span style="color: #2d9574;">"' to allow for resolving potential circular references"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        addSingletonFactory<span style="color: #9564bf;">(</span>beanName, <span style="color: #24a222;">()</span> -&gt; getEarlyBeanReference<span style="color: #24a222;">(</span>beanName, mbd, bean<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize the bean instance.</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">exposedObject</span> = bean;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        populateBean<span style="color: #9564bf;">(</span>beanName, mbd, instanceWrapper<span style="color: #9564bf;">)</span>;
        exposedObject = initializeBean<span style="color: #9564bf;">(</span>beanName, exposedObject, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>ex <span style="color: #4f97d7; font-weight: bold;">instanceof</span> BeanCreationException &amp;&amp; beanName.equals<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #1776b6;">)</span> ex<span style="color: #ff7f00;">)</span>.getBeanName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #24a222;">)</span> ex;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #24a222;">(</span>
                    mbd.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName, <span style="color: #2d9574;">"Initialization of bean failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>earlySingletonExposure<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">earlySingletonReference</span> = getSingleton<span style="color: #9564bf;">(</span>beanName, <span style="color: #a45bad;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>earlySingletonReference != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>exposedObject == bean<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                exposedObject = earlySingletonReference;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span><span style="color: #a45bad;">!</span><span style="color: #4f97d7; font-weight: bold;">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #ff7f00;">[]</span> <span style="color: #7590db;">dependentBeans</span> = getDependentBeans<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #ff7f00;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #7590db;">actualDependentBeans</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LinkedHashSet</span><span style="color: #ff7f00;">&lt;&gt;(</span>dependentBeans.length<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">dependentBean</span> : dependentBeans<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span><span style="color: #a45bad;">!</span>removeSingletonIfCreatedForTypeCheckOnly<span style="color: #00bed1;">(</span>dependentBean<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        actualDependentBeans.add<span style="color: #00bed1;">(</span>dependentBean<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span><span style="color: #a45bad;">!</span>actualDependentBeans.isEmpty<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCurrentlyInCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #2d9574;">"Bean with name '"</span> + beanName + <span style="color: #2d9574;">"' has been injected into other beans ["</span> +
                            StringUtils.collectionToCommaDelimitedString<span style="color: #00bed1;">(</span>actualDependentBeans<span style="color: #00bed1;">)</span> +
                            <span style="color: #2d9574;">"] in its raw version as part of a circular reference, but has eventually been "</span> +
                            <span style="color: #2d9574;">"wrapped. This means that said other beans do not use the final version of the "</span> +
                            <span style="color: #2d9574;">"bean. This is often the result of over-eager type matching - consider using "</span> +
                            <span style="color: #2d9574;">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register bean as disposable.</span>
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        registerDisposableBeanIfNecessary<span style="color: #9564bf;">(</span>beanName, bean, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionValidationException</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2d9574;">"Invalid destruction signature"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> exposedObject;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法实现流程如下
</p>
<ol class="org-ol">
<li>如果是单例 Bean, 首先清理缓存</li>
<li>通过 <code>createBeanInstance(...)</code> 方法将 BeanDefinition 转化成 BeanWrapper,
BeanWrapper 的作用如下
<ul class="org-ul">
<li>如果检测到 Supplier, 使用 Supplier 进行实例化，具体实现见
<code>obtainFromSupplier(...)</code> 方法</li>
<li>如果存在工厂方法, 则使用工厂方法进行实例化, 具体实现见
<code>instantiateUsingFactoryMethod(...)</code></li>
<li>如果包含多参数构造器，根据参数类型锁定的构造方法，然后调用进行实例化，具
体实现见 <code>autowireConstructor(...)</code> 方法</li>
<li>其它情况使用无参构造器进行实例化, 具体实现见 <code>instantiateBean(...)</code> 方法</li>
</ul></li>
<li>允许后置处理器合并 BeanDefinition</li>
<li>解决依赖，若有依赖项调用 <code>addSingletonFactory(...)</code> 添加到
singletonFactories 缓存中</li>
<li>调用 <code>populateBean(...)</code> 方法进行属性填充</li>
<li>调用 <code>initializeBean(...)</code> 方法进行初始化</li>
<li>循环依赖检测
<ul class="org-ul">
<li>只检测单例 Bean 的循环依赖</li>
<li>原型 Bean 的循环检测很难做到，Spring 做法是直接抛出异常</li>
</ul></li>
<li>注册 DisposableBean
<ul class="org-ul">
<li>便于 destroy-method 在 Bean 销毁时调用</li>
</ul></li>
<li>完成创建并返回</li>
</ol>
</div>
</div>

<div id="outline-container-orgad76908" class="outline-4">
<h4 id="orgad76908"><span class="section-number-4">3.5.3</span> Bean 的初始化: <code>initializeBean(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-5-3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Initialize the given bean instance, applying factory callbacks</span>
<span style="color: #9f8766;"> * as well as init methods and bean post processors.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">&lt;p&gt;</span><span style="color: #9f8766;">Called from </span><span style="color: #a45bad;">{@link #createBean}</span><span style="color: #9f8766;"> for traditionally defined beans,</span>
<span style="color: #9f8766;"> * and from </span><span style="color: #a45bad;">{@link #initializeBean}</span><span style="color: #9f8766;"> for existing bean instances.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the bean name in the factory (for debugging purposes)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> bean the new bean instance we may need to initialize</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> mbd the bean definition that the bean was created with</span>
<span style="color: #9f8766;"> * (can also be </span><span style="color: #a45bad;">{@code null}</span><span style="color: #9f8766;">, if given an existing bean instance)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the initialized bean instance (potentially wrapped)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> BeanNameAware</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> BeanClassLoaderAware</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> BeanFactoryAware</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #applyBeanPostProcessorsBeforeInitialization</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #invokeInitMethods</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #applyBeanPostProcessorsAfterInitialization</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">initializeBean</span><span style="color: #8d5649;">(</span><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>System.getSecurityManager<span style="color: #9564bf;">()</span> != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AccessController.doPrivileged<span style="color: #9564bf;">(</span><span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">PrivilegedAction</span><span style="color: #ff7f00;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #ff7f00;">&gt;</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">()</span> -&gt; <span style="color: #24a222;">{</span>
            invokeAwareMethods<span style="color: #ff7f00;">(</span>beanName, bean<span style="color: #ff7f00;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
        <span style="color: #24a222;">}</span>, getAccessControlContext<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        invokeAwareMethods<span style="color: #9564bf;">(</span>beanName, bean<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">wrappedBean</span> = bean;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>mbd == <span style="color: #a45bad;">null</span> || <span style="color: #a45bad;">!</span>mbd.isSynthetic<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        wrappedBean = applyBeanPostProcessorsBeforeInitialization<span style="color: #9564bf;">(</span>wrappedBean, beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        invokeInitMethods<span style="color: #9564bf;">(</span>beanName, wrappedBean, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                <span style="color: #24a222;">(</span>mbd != <span style="color: #a45bad;">null</span> ? mbd.getResourceDescription<span style="color: #ff7f00;">()</span> : <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span>,
                beanName, <span style="color: #2d9574;">"Invocation of init method failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>mbd == <span style="color: #a45bad;">null</span> || <span style="color: #a45bad;">!</span>mbd.isSynthetic<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        wrappedBean = applyBeanPostProcessorsAfterInitialization<span style="color: #9564bf;">(</span>wrappedBean, beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> wrappedBean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法用于初始化 Bean，它完成了如下工作
</p>
<ol class="org-ol">
<li>调用 Aware 方法，例如
<ul class="org-ul">
<li>BeanFactoryAware</li>
<li>ApplicationContextAware</li>
<li>ResourceLoaderAware</li>
<li>ServletContextAware</li>
</ul></li>
<li>提供 BeanPostProcessor 的扩展点，环绕调用了如下两个钩子方法
<ul class="org-ul">
<li><code>applyBeanPostProcessorsBeforeInitialization(...)</code></li>
<li><code>applyBeanPostProcessorsAfterInitialization(...)</code></li>
</ul></li>
<li>调用自定义的初始化方法，及 init-method
<ul class="org-ul">
<li><code>invokeInitMethods(beanName, wrappedBean, mbd);</code></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org4e0ce19" class="outline-4">
<h4 id="org4e0ce19"><span class="section-number-4">3.5.4</span> Bean 的销毁</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
在 <code>doCreateBean(...)</code> 方法中调用了 <code>registerDisposableBeanIfNecessary(...)</code>
方法来提供 <code>destroy-method</code> 销毁的扩展
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Add the given bean to the list of disposable beans in this factory,</span>
<span style="color: #9f8766;"> * registering its DisposableBean interface and/or the given destroy method</span>
<span style="color: #9f8766;"> * to be called on factory shutdown (if applicable). Only applies to singletons.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> bean the bean instance</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> mbd the bean definition for the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> RootBeanDefinition#isSingleton</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> RootBeanDefinition#getDependsOn</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #registerDisposableBean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #registerDependentBean</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerDisposableBeanIfNecessary</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span>, <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">AccessControlContext</span> <span style="color: #7590db;">acc</span> = <span style="color: #d8241f;">(</span>System.getSecurityManager<span style="color: #9564bf;">()</span> != <span style="color: #a45bad;">null</span> ? getAccessControlContext<span style="color: #9564bf;">()</span> : <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>mbd.isPrototype<span style="color: #9564bf;">()</span> &amp;&amp; requiresDestruction<span style="color: #9564bf;">(</span>bean, mbd<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>mbd.isSingleton<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register a DisposableBean implementation that performs all destruction</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">work for the given bean: DestructionAwareBeanPostProcessors,</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">DisposableBean interface, custom destroy method.</span>
            registerDisposableBean<span style="color: #24a222;">(</span>beanName,
                    <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DisposableBeanAdapter</span><span style="color: #ff7f00;">(</span>bean, beanName, mbd, getBeanPostProcessors<span style="color: #1776b6;">()</span>, acc<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">A bean with a custom scope...</span>
            <span style="color: #ce537a; font-weight: bold;">Scope</span> <span style="color: #7590db;">scope</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.scopes.get<span style="color: #24a222;">(</span>mbd.getScope<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>scope == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">IllegalStateException</span><span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"No Scope registered for scope name '"</span> + mbd.getScope<span style="color: #1776b6;">()</span> + <span style="color: #2d9574;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            scope.registerDestructionCallback<span style="color: #24a222;">(</span>beanName,
                    <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DisposableBeanAdapter</span><span style="color: #ff7f00;">(</span>bean, beanName, mbd, getBeanPostProcessors<span style="color: #1776b6;">()</span>, acc<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org9bc4da8" class="outline-2">
<h2 id="org9bc4da8"><span class="section-number-2">4</span> 容器功能扩展</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgce38d28" class="outline-3">
<h3 id="orgce38d28"><span class="section-number-3">4.1</span> 应用上下文: ApplicationContext</h3>
<div class="outline-text-3" id="text-4-1">
<p>
首先查看 <code>ApplicationContext</code> 接口的相关信息
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.context
Interface ApplicationContext

    All Superinterfaces:
        ApplicationEventPublisher,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.ListableBeanFactory, MessageSource,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>
<p>
可以看出 <code>ApplicationContext</code> 提供了所以 <code>BeanFactory</code> 的功能，另外还扩展了如
下功能
</p>
<ol class="org-ol">
<li><code>ResourceLoader</code> 加载资源文件</li>
<li><code>ApplicationEventPublisher</code> 事件发布和监听器注册</li>
<li><code>MessageSource</code> 国际化的消息支持</li>
<li><code>HierarchicalBeanFactory</code> 继承父的上下文功能</li>
<li><code>EnvironmentCapable</code> 系统环境变量和 Java 属性支持</li>
</ol>
</div>
</div>

<div id="outline-container-orga792179" class="outline-3">
<h3 id="orga792179"><span class="section-number-3">4.2</span> ApplicationContext 接口的常见实现类</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org35806ba" class="outline-4">
<h4 id="org35806ba"><span class="section-number-4">4.2.1</span> ClassPathXmlApplicationContext</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
读取 ClassPath 中 XML 配置文件的 Bean 定义的容器
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.context.support
Class ClassPathXmlApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.AbstractRefreshableApplicationContext
                    org.springframework.context.support.AbstractRefreshableConfigApplicationContext
                        org.springframework.context.support.AbstractXmlApplicationContext
                            org.springframework.context.support.ClassPathXmlApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable, org.springframework.beans.factory.Aware,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.BeanNameAware,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.InitializingBean,
        org.springframework.beans.factory.ListableBeanFactory,
        ApplicationContext, ApplicationEventPublisher,
        ConfigurableApplicationContext, Lifecycle, MessageSource,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
<code>ClassPathXmlApplicationContext</code> 的构造器的实现如下，该构造器实现逻辑比较清
晰，需要注意的是这里后面调用了刷新上下文的 <code>refresh()</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Create a new ClassPathXmlApplicationContext with the given parent,</span>
<span style="color: #9f8766;"> * loading the definitions from the given XML files.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> configLocations array of resource locations</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> refresh whether to automatically refresh the context,</span>
<span style="color: #9f8766;"> * loading all bean definitions and creating all singletons.</span>
<span style="color: #9f8766;"> * Alternatively, call refresh manually after further configuring the context.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> parent the parent context</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@throws</span><span style="color: #9f8766;"> BeansException if context creation failed</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #refresh()</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #bc6ec5; font-weight: bold;">ClassPathXmlApplicationContext</span><span style="color: #8d5649;">(</span>
        <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">configLocations</span>, <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">refresh</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">ApplicationContext</span> <span style="color: #7590db;">parent</span><span style="color: #8d5649;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #4f97d7; font-weight: bold;">super</span><span style="color: #d8241f;">(</span>parent<span style="color: #d8241f;">)</span>;
    setConfigLocations<span style="color: #d8241f;">(</span>configLocations<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>refresh<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        refresh<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3c648d" class="outline-4">
<h4 id="orgf3c648d"><span class="section-number-4">4.2.2</span> AnnotationConfigApplicationContext</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
读取注解类型 Bean 定义的容器, <code>@Component</code>, <code>@Service</code> 等
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.context.annotation
Class AnnotationConfigApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.GenericApplicationContext
                    org.springframework.context.annotation.AnnotationConfigApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.ListableBeanFactory,
        org.springframework.beans.factory.support.BeanDefinitionRegistry,
        AnnotationConfigRegistry, ApplicationContext,
        ApplicationEventPublisher, ConfigurableApplicationContext,
        Lifecycle, MessageSource, org.springframework.core.AliasRegistry,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
常见的类简单可以分成以下几类
</p>
<ol class="org-ol">
<li>资源处理
<ul class="org-ul">
<li><code>Resource</code> Spring 中关于资源的定义</li>
<li><code>ResourceLoader</code> 提供资源加载方法</li>
<li><code>BeanDefinitionReader</code> 读取接口主要用来读取信息</li>
</ul></li>
<li>注册形式，在 Spring 中关于注册的几个核心
<ul class="org-ul">
<li><code>AliasRegistry</code> 别名注册</li>
<li><code>BeanDefinitionRegistry</code> Bean 定义注册</li>
<li><code>SingletonBeanRegistry</code> 单例 Bean 注册
<ul class="org-ul">
<li><code>DefaultSingletonBeanRegistry</code></li>
</ul></li>
</ul></li>
<li>生命周期，可以分成容器生命周期和 Bean 生命周期两个小类
<ul class="org-ul">
<li><code>Lifecycle</code> 容器生命周期的核心接口</li>
<li><code>InitializingBean</code>, <code>DisposableBean</code> 等 Bean 的生命周期接口</li>
</ul></li>
<li>Bean 拓展
<ul class="org-ul">
<li><code>BeanPostProcessor</code></li>
<li><code>Aware</code> 系列接口</li>
</ul></li>
<li>上下文的接口:
<ul class="org-ul">
<li><code>ApplicationContext</code> 作为主导接口
<ul class="org-ul">
<li><code>AbstractApplicationContext</code></li>
</ul></li>
</ul></li>
</ol>

<p>
<code>AnnotationConfigApplicationContext</code> 的构造器的实现如下，扫描包过后，然后调
用了刷新上下文的 <code>refresh()</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Create a new AnnotationConfigApplicationContext, scanning for components</span>
<span style="color: #9f8766;"> * in the given packages, registering bean definitions for those components,</span>
<span style="color: #9f8766;"> * and automatically refreshing the context.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> basePackages the packages to scan for component classes</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #bc6ec5; font-weight: bold;">AnnotationConfigApplicationContext</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">String</span>... <span style="color: #7590db;">basePackages</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #d8241f;">()</span>;
    scan<span style="color: #d8241f;">(</span>basePackages<span style="color: #d8241f;">)</span>;
    refresh<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8cf92d7" class="outline-3">
<h3 id="org8cf92d7"><span class="section-number-3">4.3</span> 刷新应用上下文: <code>refresh()</code> 方法</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgd888c6a" class="outline-4">
<h4 id="orgd888c6a"><span class="section-number-4">4.3.1</span> <code>refresh()</code> 方法总览</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
该 <code>refresh()</code> 方法实现了 Spring 的 Bean 管理的全周期的流程，其中调用了 15
个辅助方法，它的主要实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">refresh</span><span style="color: #8d5649;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span>, <span style="color: #ce537a; font-weight: bold;">IllegalStateException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.startupShutdownMonitor<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Prepare this context for refreshing.</span>
        prepareRefresh<span style="color: #9564bf;">()</span>;

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Tell the subclass to refresh the internal bean factory.</span>
        <span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span> = obtainFreshBeanFactory<span style="color: #9564bf;">()</span>;

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Prepare the bean factory for use in this context.</span>
        prepareBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Allows post-processing of the bean factory in context subclasses.</span>
            postProcessBeanFactory<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Invoke factory processors registered as beans in the context.</span>
            invokeBeanFactoryPostProcessors<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register bean processors that intercept bean creation.</span>
            registerBeanPostProcessors<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize message source for this context.</span>
            initMessageSource<span style="color: #24a222;">()</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize event multicaster for this context.</span>
            initApplicationEventMulticaster<span style="color: #24a222;">()</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize other special beans in specific context subclasses.</span>
            onRefresh<span style="color: #24a222;">()</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Check for listener beans and register them.</span>
            registerListeners<span style="color: #24a222;">()</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Instantiate all remaining (non-lazy-init) singletons.</span>
            finishBeanFactoryInitialization<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Last step: publish corresponding event.</span>
            finishRefresh<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #7590db;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>logger.isWarnEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.warn<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"Exception encountered during context initialization - "</span> +
                        <span style="color: #2d9574;">"cancelling refresh attempt: "</span> + ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Destroy already created singletons to avoid dangling resources.</span>
            destroyBeans<span style="color: #24a222;">()</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Reset 'active' flag.</span>
            cancelRefresh<span style="color: #24a222;">(</span>ex<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Propagate exception to caller.</span>
            <span style="color: #4f97d7; font-weight: bold;">throw</span> ex;
        <span style="color: #9564bf;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Reset common introspection caches in Spring's core, since we</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">might not ever need metadata for singleton beans anymore...</span>
            resetCommonCaches<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
每个方法的解释如下
</p>
<ol class="org-ol">
<li><code>prepareRefresh()</code> 刷新应用上下文的准备工作
<ul class="org-ul">
<li>验证系统变量等</li>
</ul></li>
<li><code>obtainFreshBeanFactory()</code> 初始化 BeanFactory, 填充 BeanFactory 的属性
<ul class="org-ul">
<li>创建 BeanFactory</li>
<li>加载 BeanDefinition</li>
</ul></li>
<li><code>prepareBeanFactory(beanFactory)</code> 准备当前上下文的 BeanFactory
<ul class="org-ul">
<li><code>@Qualifier</code>, <code>@Autowired</code> 注解支持</li>
</ul></li>
<li><code>postProcessBeanFactory(beanFactory)</code> 的实现该方法来扩展其功能，即子类重
写当前方法来改变 BeanFactory 的功能</li>
<li><code>invokeBeanFactoryPostProcessors(beanFactory)</code> 唤醒
BeanFactoryPostProcessor 的后置处理方法
<ul class="org-ul">
<li>调用 <code>postProcessBeanFactory(...)</code> 方法</li>
</ul></li>
<li><code>registerBeanPostProcessors(beanFactory)</code> 注册 BeanPostProcessor 的拦截器
<ul class="org-ul">
<li>拦截器在这里只是注册</li>
<li>调用拦截器在 <code>getBean(...)</code> 中实现</li>
</ul></li>
<li><code>initMessageSource()</code> 初始化不同语言的消息，提供国际化支持</li>
<li><code>initApplicationEventMulticaster()</code> 初始化消息多播器
<ul class="org-ul">
<li>将 Bean 放入 <code>applicationEventMulticaster</code> 中</li>
</ul></li>
<li><code>onRefresh()</code> 提供子类的扩展接入点</li>
<li><code>registerListeners()</code> 注册监听器，在所有注册的 Bean 中查找 listenerBean,
并将 listenerBean 添加到 applicationEventMulticaster 中</li>
<li><code>finishBeanFactoryInitialization(beanFactory)</code> 初始化剩下的单例（非懒加
载的）</li>
<li><code>finishRefresh()</code> 完成刷新过程，发布 ContextRefreshedEvent</li>
<li>如果出现异常
<ul class="org-ul">
<li><code>destroyBeans()</code> 销毁 Bean</li>
<li><code>cancelRefresh(ex)</code> 重置 active 标注</li>
</ul></li>
<li>最终结束, <code>resetCommonCaches()</code> 清空缓存</li>
</ol>
</div>
</div>

<div id="outline-container-org66e952e" class="outline-4">
<h4 id="org66e952e"><span class="section-number-4">4.3.2</span> 环境准备</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
该部分主要包括以下几类工作
</p>
<ol class="org-ol">
<li>设置一下系统启动时间</li>
<li><code>initPropertySources()</code> 提供个性化初始属性功能</li>
<li><code>getEnvironment().validateRequiredProperties()</code> 对系统属性进行校验</li>
<li>准备一些监听器 ApplicationListener</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Prepare this context for refreshing, setting its startup date and</span>
<span style="color: #9f8766;"> * active flag as well as performing any initialization of property sources.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">prepareRefresh</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Switch to active.</span>
    <span style="color: #4f97d7; font-weight: bold;">this</span>.startupDate = System.currentTimeMillis<span style="color: #d8241f;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">this</span>.closed.set<span style="color: #d8241f;">(</span><span style="color: #a45bad;">false</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">this</span>.active.set<span style="color: #d8241f;">(</span><span style="color: #a45bad;">true</span><span style="color: #d8241f;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>logger.isDebugEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Refreshing "</span> + <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            logger.debug<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Refreshing "</span> + getDisplayName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize any placeholder property sources in the context environment.</span>
    initPropertySources<span style="color: #d8241f;">()</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Validate that all properties marked as required are resolvable:</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">see ConfigurablePropertyResolver#setRequiredProperties</span>
    getEnvironment<span style="color: #d8241f;">()</span>.validateRequiredProperties<span style="color: #d8241f;">()</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Store pre-refresh ApplicationListeners...</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationListeners == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationListeners = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LinkedHashSet</span><span style="color: #9564bf;">&lt;&gt;(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.applicationListeners<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Reset local application listeners to pre-refresh state.</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationListeners.clear<span style="color: #9564bf;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationListeners.addAll<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationListeners<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Allow for the collection of early ApplicationEvents,</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">to be published once the multicaster is available...</span>
    <span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationEvents = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LinkedHashSet</span><span style="color: #d8241f;">&lt;&gt;()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgffb1635" class="outline-4">
<h4 id="orgffb1635"><span class="section-number-4">4.3.3</span> 加载 BeanFactory</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
ApplicationContext 是对 BeanFactory 的扩展，这里调用
<code>obtainFreshBeanFactory()</code> 方法获取 BeanFactory，但实际加载 BeanFactory 的实
现在 BeanFactory 中已经实现，通过之前对 BeanDefinition 加载分析知道
<code>AbstractRefreshableApplicationContext</code> 中的 <code>refreshBeanFactory()</code> 方法实现
了初始化 BeanFactory 的功能
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * This implementation performs an actual refresh of this context's underlying</span>
<span style="color: #9f8766;"> * bean factory, shutting down the previous bean factory (if any) and</span>
<span style="color: #9f8766;"> * initializing a fresh bean factory for the next phase of the context's lifecycle.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">refreshBeanFactory</span><span style="color: #8d5649;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>hasBeanFactory<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        destroyBeans<span style="color: #9564bf;">()</span>;
        closeBeanFactory<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">DefaultListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span> = createBeanFactory<span style="color: #9564bf;">()</span>;
        beanFactory.setSerializationId<span style="color: #9564bf;">(</span>getId<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        customizeBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        loadBeanDefinitions<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactoryMonitor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory = beanFactory;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">IOException</span> <span style="color: #7590db;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ApplicationContextException</span><span style="color: #9564bf;">(</span><span style="color: #2d9574;">"I/O error parsing bean definition source for "</span> + getDisplayName<span style="color: #24a222;">()</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
该方法功能如下
</p>
<ol class="org-ol">
<li>调用 <code>createBeanFactory()</code> 方法创建 <code>DefaultListableBeanFactory</code></li>
<li>指定序列化 ID</li>
<li>配置自定义的 BeanFactory 参数</li>
<li>加载 BeanDefinition</li>
<li>设置全局的 beanFactory 类实例</li>
</ol>
</div>
</div>

<div id="outline-container-orgef94fd4" class="outline-4">
<h4 id="orgef94fd4"><span class="section-number-4">4.3.4</span> BeanFactory 准备工作</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
该项功能在 <code>prepareBeanFactory(beanFactory)</code> 函数中完成，它的实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Configure the factory's standard context characteristics,</span>
<span style="color: #9f8766;"> * such as the context's ClassLoader and post-processors.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanFactory the BeanFactory to configure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">prepareBeanFactory</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Tell the internal bean factory to use the context's class loader etc.</span>
    beanFactory.setBeanClassLoader<span style="color: #d8241f;">(</span>getClassLoader<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    beanFactory.setBeanExpressionResolver<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">StandardBeanExpressionResolver</span><span style="color: #9564bf;">(</span>beanFactory.getBeanClassLoader<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    beanFactory.addPropertyEditorRegistrar<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ResourceEditorRegistrar</span><span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, getEnvironment<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Configure the bean factory with context callbacks.</span>
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ApplicationContextAwareProcessor</span><span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>EnvironmentAware.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>EmbeddedValueResolverAware.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>ResourceLoaderAware.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>ApplicationEventPublisherAware.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>MessageSourceAware.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>ApplicationContextAware.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">BeanFactory interface not registered as resolvable type in a plain factory.</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">MessageSource registered (and found for autowiring) as a bean.</span>
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>BeanFactory.<span style="color: #4f97d7; font-weight: bold;">class</span>, beanFactory<span style="color: #d8241f;">)</span>;
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>ResourceLoader.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #d8241f;">)</span>;
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>ApplicationEventPublisher.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #d8241f;">)</span>;
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>ApplicationContext.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register early post-processor for detecting inner beans as ApplicationListeners.</span>
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ApplicationListenerDetector</span><span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Detect a LoadTimeWeaver and prepare for weaving, if found.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsBean<span style="color: #9564bf;">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.addBeanPostProcessor<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LoadTimeWeaverAwareProcessor</span><span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Set a temporary ClassLoader for type matching.</span>
        beanFactory.setTempClassLoader<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ContextTypeMatchClassLoader</span><span style="color: #24a222;">(</span>beanFactory.getBeanClassLoader<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register default environment beans.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>ENVIRONMENT_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>ENVIRONMENT_BEAN_NAME, getEnvironment<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment<span style="color: #24a222;">()</span>.getSystemProperties<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment<span style="color: #24a222;">()</span>.getSystemEnvironment<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
该方法做了以下工作
</p>
<ol class="org-ol">
<li>配置 beanFactory 的内部环境，使 beanFactory 使用当前 ApplicationContext
的上下文，具体包括
<ul class="org-ul">
<li>设置 beanFactory 的类加载器</li>
<li>设置 beanFactory 对 SPEL 语言的支持</li>
<li>设置 beanFactory 对属性编辑器的支持</li>
</ul></li>
<li>配置 beanFactory 的 ApplicationContext 回调函数
<ul class="org-ul">
<li>设置 <code>ApplicationContextAwareProcessor</code> 后置处理器</li>
<li>忽略下列自动装配忽略的 Aware 接口，因为这些接口在
<code>ApplicationContextAwareProcessor</code> 已经进行处理
<ul class="org-ul">
<li>EnvironmentAware</li>
<li>EmbeddedValueResolverAware</li>
<li>ResourceLoaderAware</li>
<li>ApplicationEventPublisherAware</li>
<li>MessageSourceAware</li>
<li>ApplicationContextAware</li>
</ul></li>
</ul></li>
<li>配置几个特殊装配的规则</li>
<li>添加 ApplicationListenerDetector</li>
<li>添加对 AspectJ 的支持</li>
<li>将相关环境变量及系统属性以单例模式注册</li>
</ol>
</div>
</div>

<div id="outline-container-org8698a60" class="outline-4">
<h4 id="org8698a60"><span class="section-number-4">4.3.5</span> BeanFactory 后续处理工作</h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
调用 <code>postProcessBeanFactory</code>, 其中 <code>postProcessBeanFactory</code> 是一个空方法，
目的是为 BeanFactory 的后置处理器提供扩展接口
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Modify the application context's internal bean factory after its standard</span>
<span style="color: #9f8766;"> * initialization. All bean definitions will have been loaded, but no beans</span>
<span style="color: #9f8766;"> * will have been instantiated yet. This allows for registering special</span>
<span style="color: #9f8766;"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanFactory the bean factory used by the application context</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">postProcessBeanFactory</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>invokeBeanFactoryPostProcessors()</code> 唤醒注册的 BeanFactoryPostProcessor
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span>
<span style="color: #9f8766;"> * respecting explicit order if given.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">&lt;p&gt;</span><span style="color: #9f8766;">Must be called before singleton instantiation.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">invokeBeanFactoryPostProcessors</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>beanFactory, getBeanFactoryPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">(e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory.getTempClassLoader<span style="color: #9564bf;">()</span> == <span style="color: #a45bad;">null</span> &amp;&amp; beanFactory.containsBean<span style="color: #9564bf;">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.addBeanPostProcessor<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LoadTimeWeaverAwareProcessor</span><span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        beanFactory.setTempClassLoader<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ContextTypeMatchClassLoader</span><span style="color: #24a222;">(</span>beanFactory.getBeanClassLoader<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">invokeBeanFactoryPostProcessors</span><span style="color: #8d5649;">(</span>
        <span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span>, <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">beanFactoryPostProcessors</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Invoke BeanDefinitionRegistryPostProcessors first, if any.</span>
    <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">processedBeans</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">HashSet</span><span style="color: #d8241f;">&lt;&gt;()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory <span style="color: #4f97d7; font-weight: bold;">instanceof</span> BeanDefinitionRegistry<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistry</span> <span style="color: #7590db;">registry</span> = <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistry</span><span style="color: #9564bf;">)</span> beanFactory;
        <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanFactoryPostProcessor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">regularPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;()</span>;
        <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistryPostProcessor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">registryProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;()</span>;

        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">BeanFactoryPostProcessor</span> <span style="color: #7590db;">postProcessor</span> : beanFactoryPostProcessors<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>postProcessor <span style="color: #4f97d7; font-weight: bold;">instanceof</span> BeanDefinitionRegistryPostProcessor<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistryPostProcessor</span> <span style="color: #7590db;">registryProcessor</span> =
                        <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistryPostProcessor</span><span style="color: #ff7f00;">)</span> postProcessor;
                registryProcessor.postProcessBeanDefinitionRegistry<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
                registryProcessors.add<span style="color: #ff7f00;">(</span>registryProcessor<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #24a222;">{</span>
                regularPostProcessors.add<span style="color: #ff7f00;">(</span>postProcessor<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Do not initialize FactoryBeans here: We need to leave all regular beans</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">uninitialized to let the bean factory post-processors apply to them!</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Separate between BeanDefinitionRegistryPostProcessors that implement</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">PriorityOrdered, Ordered, and the rest.</span>
        <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistryPostProcessor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">currentRegistryProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;()</span>;

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span>
        <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #7590db;">postProcessorNames</span> =
                beanFactory.getBeanNamesForType<span style="color: #9564bf;">(</span>BeanDefinitionRegistryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : postProcessorNames<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>beanFactory.isTypeMatch<span style="color: #ff7f00;">(</span>ppName, PriorityOrdered.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                currentRegistryProcessors.add<span style="color: #ff7f00;">(</span>beanFactory.getBean<span style="color: #1776b6;">(</span>ppName, BeanDefinitionRegistryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                processedBeans.add<span style="color: #ff7f00;">(</span>ppName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        sortPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, beanFactory<span style="color: #9564bf;">)</span>;
        registryProcessors.addAll<span style="color: #9564bf;">(</span>currentRegistryProcessors<span style="color: #9564bf;">)</span>;
        invokeBeanDefinitionRegistryPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, registry<span style="color: #9564bf;">)</span>;
        currentRegistryProcessors.clear<span style="color: #9564bf;">()</span>;

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span>
        postProcessorNames = beanFactory.getBeanNamesForType<span style="color: #9564bf;">(</span>BeanDefinitionRegistryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : postProcessorNames<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span><span style="color: #a45bad;">!</span>processedBeans.contains<span style="color: #ff7f00;">(</span>ppName<span style="color: #ff7f00;">)</span> &amp;&amp; beanFactory.isTypeMatch<span style="color: #ff7f00;">(</span>ppName, Ordered.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                currentRegistryProcessors.add<span style="color: #ff7f00;">(</span>beanFactory.getBean<span style="color: #1776b6;">(</span>ppName, BeanDefinitionRegistryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                processedBeans.add<span style="color: #ff7f00;">(</span>ppName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        sortPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, beanFactory<span style="color: #9564bf;">)</span>;
        registryProcessors.addAll<span style="color: #9564bf;">(</span>currentRegistryProcessors<span style="color: #9564bf;">)</span>;
        invokeBeanDefinitionRegistryPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, registry<span style="color: #9564bf;">)</span>;
        currentRegistryProcessors.clear<span style="color: #9564bf;">()</span>;

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span>
        <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">reiterate</span> = <span style="color: #a45bad;">true</span>;
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #9564bf;">(</span>reiterate<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            reiterate = <span style="color: #a45bad;">false</span>;
            postProcessorNames = beanFactory.getBeanNamesForType<span style="color: #24a222;">(</span>BeanDefinitionRegistryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : postProcessorNames<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span><span style="color: #a45bad;">!</span>processedBeans.contains<span style="color: #1776b6;">(</span>ppName<span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    currentRegistryProcessors.add<span style="color: #1776b6;">(</span>beanFactory.getBean<span style="color: #00bed1;">(</span>ppName, BeanDefinitionRegistryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span>;
                    processedBeans.add<span style="color: #1776b6;">(</span>ppName<span style="color: #1776b6;">)</span>;
                    reiterate = <span style="color: #a45bad;">true</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            sortPostProcessors<span style="color: #24a222;">(</span>currentRegistryProcessors, beanFactory<span style="color: #24a222;">)</span>;
            registryProcessors.addAll<span style="color: #24a222;">(</span>currentRegistryProcessors<span style="color: #24a222;">)</span>;
            invokeBeanDefinitionRegistryPostProcessors<span style="color: #24a222;">(</span>currentRegistryProcessors, registry<span style="color: #24a222;">)</span>;
            currentRegistryProcessors.clear<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span>
        invokeBeanFactoryPostProcessors<span style="color: #9564bf;">(</span>registryProcessors, beanFactory<span style="color: #9564bf;">)</span>;
        invokeBeanFactoryPostProcessors<span style="color: #9564bf;">(</span>regularPostProcessors, beanFactory<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Invoke factory processors registered with the context instance.</span>
        invokeBeanFactoryPostProcessors<span style="color: #9564bf;">(</span>beanFactoryPostProcessors, beanFactory<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">uninitialized to let the bean factory post-processors apply to them!</span>
    <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">postProcessorNames</span> =
            beanFactory.getBeanNamesForType<span style="color: #d8241f;">(</span>BeanFactoryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Ordered, and the rest.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">priorityOrderedPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">orderedPostProcessorNames</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">nonOrderedPostProcessorNames</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : postProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>processedBeans.contains<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">skip - already processed in first phase above</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, PriorityOrdered.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            priorityOrderedPostProcessors.add<span style="color: #24a222;">(</span>beanFactory.getBean<span style="color: #ff7f00;">(</span>ppName, BeanFactoryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, Ordered.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            orderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            nonOrderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>priorityOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>priorityOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">orderedPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>orderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">postProcessorName</span> : orderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        orderedPostProcessors.add<span style="color: #9564bf;">(</span>beanFactory.getBean<span style="color: #24a222;">(</span>postProcessorName, BeanFactoryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>orderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>orderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Finally, invoke all other BeanFactoryPostProcessors.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">nonOrderedPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>nonOrderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">postProcessorName</span> : nonOrderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        nonOrderedPostProcessors.add<span style="color: #9564bf;">(</span>beanFactory.getBean<span style="color: #24a222;">(</span>postProcessorName, BeanFactoryPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>nonOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Clear cached merged bean definitions since the post-processors might have</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">modified the original metadata, e.g. replacing placeholders in values...</span>
    beanFactory.clearMetadataCache<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(...)</code> 方
法完成唤醒后置处理，它将 BeanFactoryPostProcessor 分成两类
</p>
<ol class="org-ol">
<li>regularPostProcessors 记录的 <code>BeanFactoryPostProcessor</code> 后置处理器</li>
<li>registryProcessors 记录的 <code>BeanDefinitionRegistry</code> 后置处理器</li>
<li>在唤醒时还需要考虑后置处理器的顺序
<ul class="org-ul">
<li>PriorityOrdered 优先序的</li>
<li>Ordered 有序的</li>
<li>Non-Ordered 无序的</li>
</ul></li>
</ol>

<p>
注册 BeanPostProcessor <code>registerBeanPostProcessors(beanFactory)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerBeanPostProcessors</span><span style="color: #8d5649;">(</span>
        <span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span>, <span style="color: #ce537a; font-weight: bold;">AbstractApplicationContext</span> <span style="color: #7590db;">applicationContext</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">postProcessorNames</span> = beanFactory.getBeanNamesForType<span style="color: #d8241f;">(</span>BeanPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register BeanPostProcessorChecker that logs an info message when</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">a bean is created during BeanPostProcessor instantiation, i.e. when</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">a bean is not eligible for getting processed by all BeanPostProcessors.</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">beanProcessorTargetCount</span> = beanFactory.getBeanPostProcessorCount<span style="color: #d8241f;">()</span> + 1 + postProcessorNames.length;
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanPostProcessorChecker</span><span style="color: #9564bf;">(</span>beanFactory, beanProcessorTargetCount<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Separate between BeanPostProcessors that implement PriorityOrdered,</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Ordered, and the rest.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">priorityOrderedPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">internalPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">orderedPostProcessorNames</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">nonOrderedPostProcessorNames</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : postProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, PriorityOrdered.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span> <span style="color: #7590db;">pp</span> = beanFactory.getBean<span style="color: #24a222;">(</span>ppName, BeanPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span>;
            priorityOrderedPostProcessors.add<span style="color: #24a222;">(</span>pp<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>pp <span style="color: #4f97d7; font-weight: bold;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                internalPostProcessors.add<span style="color: #ff7f00;">(</span>pp<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, Ordered.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            orderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            nonOrderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">First, register the BeanPostProcessors that implement PriorityOrdered.</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>priorityOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, priorityOrderedPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Next, register the BeanPostProcessors that implement Ordered.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">orderedPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>orderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : orderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span> <span style="color: #7590db;">pp</span> = beanFactory.getBean<span style="color: #9564bf;">(</span>ppName, BeanPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span>;
        orderedPostProcessors.add<span style="color: #9564bf;">(</span>pp<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>pp <span style="color: #4f97d7; font-weight: bold;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            internalPostProcessors.add<span style="color: #24a222;">(</span>pp<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>orderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, orderedPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Now, register all regular BeanPostProcessors.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">nonOrderedPostProcessors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>nonOrderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">ppName</span> : nonOrderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">BeanPostProcessor</span> <span style="color: #7590db;">pp</span> = beanFactory.getBean<span style="color: #9564bf;">(</span>ppName, BeanPostProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span>;
        nonOrderedPostProcessors.add<span style="color: #9564bf;">(</span>pp<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>pp <span style="color: #4f97d7; font-weight: bold;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            internalPostProcessors.add<span style="color: #24a222;">(</span>pp<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, nonOrderedPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Finally, re-register all internal BeanPostProcessors.</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>internalPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, internalPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Re-register post-processor for detecting inner beans as ApplicationListeners,</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">moving it to the end of the processor chain (for picking up proxies etc).</span>
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ApplicationListenerDetector</span><span style="color: #9564bf;">(</span>applicationContext<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
处理国际化消息 <code>initMessageSource()</code>, 这部分不重要，可以跳过
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Initialize the MessageSource.</span>
<span style="color: #9f8766;"> * Use parent's if none defined in this context.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">initMessageSource</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span> = getBeanFactory<span style="color: #d8241f;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>MESSAGE_SOURCE_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource = beanFactory.getBean<span style="color: #9564bf;">(</span>MESSAGE_SOURCE_BEAN_NAME, MessageSource.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Make MessageSource aware of parent MessageSource.</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.parent != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource <span style="color: #4f97d7; font-weight: bold;">instanceof</span> HierarchicalMessageSource<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">HierarchicalMessageSource</span> <span style="color: #7590db;">hms</span> = <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">HierarchicalMessageSource</span><span style="color: #24a222;">)</span> <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>hms.getParentMessageSource<span style="color: #ff7f00;">()</span> == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Only set parent context as parent MessageSource if no parent MessageSource</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">registered already.</span>
                hms.setParentMessageSource<span style="color: #ff7f00;">(</span>getInternalParentMessageSource<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Using MessageSource ["</span> + <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource + <span style="color: #2d9574;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Use empty MessageSource to be able to accept getMessage calls.</span>
        <span style="color: #ce537a; font-weight: bold;">DelegatingMessageSource</span> <span style="color: #7590db;">dms</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DelegatingMessageSource</span><span style="color: #9564bf;">()</span>;
        dms.setParentMessageSource<span style="color: #9564bf;">(</span>getInternalParentMessageSource<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource = dms;
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>MESSAGE_SOURCE_BEAN_NAME, <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"No '"</span> + MESSAGE_SOURCE_BEAN_NAME + <span style="color: #2d9574;">"' bean, using ["</span> + <span style="color: #4f97d7; font-weight: bold;">this</span>.messageSource + <span style="color: #2d9574;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>initApplicationEventMulticaster()</code> 初始化多播，初始化多播属性
applicationEventMulticaster, 如果存在直接设置多播器，如果不存在则创建
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Initialize the ApplicationEventMulticaster.</span>
<span style="color: #9f8766;"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> org.springframework.context.event.SimpleApplicationEventMulticaster</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">initApplicationEventMulticaster</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span> = getBeanFactory<span style="color: #d8241f;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>APPLICATION_EVENT_MULTICASTER_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationEventMulticaster =
                beanFactory.getBean<span style="color: #9564bf;">(</span>APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Using ApplicationEventMulticaster ["</span> + <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationEventMulticaster + <span style="color: #2d9574;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationEventMulticaster = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">SimpleApplicationEventMulticaster</span><span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationEventMulticaster<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"No '"</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span style="color: #2d9574;">"' bean, using "</span> +
                    <span style="color: #2d9574;">"["</span> + <span style="color: #4f97d7; font-weight: bold;">this</span>.applicationEventMulticaster.getClass<span style="color: #ff7f00;">()</span>.getSimpleName<span style="color: #ff7f00;">()</span> + <span style="color: #2d9574;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>onRefresh()</code> 是一个空方法，提供子类刷新的扩展点
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">onRefresh</span><span style="color: #8d5649;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">For subclasses: do nothing by default.</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>registerListeners()</code> 获取多播器，然后注册 listener 监听器
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Add beans that implement ApplicationListener as listeners.</span>
<span style="color: #9f8766;"> * Doesn't affect other listeners, which can be added without being beans.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerListeners</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register statically specified listeners first.</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">ApplicationListener</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">listener</span> : getApplicationListeners<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        getApplicationEventMulticaster<span style="color: #9564bf;">()</span>.addApplicationListener<span style="color: #9564bf;">(</span>listener<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">uninitialized to let post-processors apply to them!</span>
    <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">listenerBeanNames</span> = getBeanNamesForType<span style="color: #d8241f;">(</span>ApplicationListener.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">listenerBeanName</span> : listenerBeanNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        getApplicationEventMulticaster<span style="color: #9564bf;">()</span>.addApplicationListenerBean<span style="color: #9564bf;">(</span>listenerBeanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Publish early application events now that we finally have a multicaster...</span>
    <span style="color: #ce537a; font-weight: bold;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">ApplicationEvent</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">earlyEventsToProcess</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationEvents;
    <span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationEvents = <span style="color: #a45bad;">null</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>earlyEventsToProcess != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">ApplicationEvent</span> <span style="color: #7590db;">earlyEvent</span> : earlyEventsToProcess<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getApplicationEventMulticaster<span style="color: #24a222;">()</span>.multicastEvent<span style="color: #24a222;">(</span>earlyEvent<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6640b6e" class="outline-4">
<h4 id="org6640b6e"><span class="section-number-4">4.3.6</span> 初始化非延迟加载单例</h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
非延迟加载单例可以在 Spring 启动后就进行创建，然后下次加载可以快速获取，减少
创建的时间
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Finish the initialization of this context's bean factory,</span>
<span style="color: #9f8766;"> * initializing all remaining singleton beans.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">finishBeanFactoryInitialization</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize conversion service for this context.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsBean<span style="color: #9564bf;">(</span>CONVERSION_SERVICE_BEAN_NAME<span style="color: #9564bf;">)</span> &amp;&amp;
            beanFactory.isTypeMatch<span style="color: #9564bf;">(</span>CONVERSION_SERVICE_BEAN_NAME, ConversionService.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.setConversionService<span style="color: #9564bf;">(</span>
                beanFactory.getBean<span style="color: #24a222;">(</span>CONVERSION_SERVICE_BEAN_NAME, ConversionService.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Register a default embedded value resolver if no bean post-processor</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">(such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">at this point, primarily for resolution in annotation attribute values.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>beanFactory.hasEmbeddedValueResolver<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.addEmbeddedValueResolver<span style="color: #9564bf;">(</span>strVal -&gt; getEnvironment<span style="color: #24a222;">()</span>.resolvePlaceholders<span style="color: #24a222;">(</span>strVal<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span>
    <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">weaverAwareNames</span> = beanFactory.getBeanNamesForType<span style="color: #d8241f;">(</span>LoadTimeWeaverAware.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">false</span>, <span style="color: #a45bad;">false</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">weaverAwareName</span> : weaverAwareNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        getBean<span style="color: #9564bf;">(</span>weaverAwareName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Stop using the temporary ClassLoader for type matching.</span>
    beanFactory.setTempClassLoader<span style="color: #d8241f;">(</span><span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Allow for caching all bean definition metadata, not expecting further changes.</span>
    beanFactory.freezeConfiguration<span style="color: #d8241f;">()</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Instantiate all remaining (non-lazy-init) singletons.</span>
    beanFactory.preInstantiateSingletons<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>preInstantiateSingletons()</code> 方法一次性初始化所有的初始化非延迟加载单例
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">preInstantiateSingletons</span><span style="color: #8d5649;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"Pre-instantiating singletons in "</span> + <span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Iterate over a copy to allow for init methods which in turn register new bean definitions.</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">beanNames</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Trigger initialization of all non-lazy singleton beans...</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span> : beanNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">bd</span> = getMergedLocalBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>bd.isAbstract<span style="color: #24a222;">()</span> &amp;&amp; bd.isSingleton<span style="color: #24a222;">()</span> &amp;&amp; <span style="color: #a45bad;">!</span>bd.isLazyInit<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>isFactoryBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span> = getBean<span style="color: #ff7f00;">(</span>FACTORY_BEAN_PREFIX + beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #ff7f00;">(</span>bean <span style="color: #4f97d7; font-weight: bold;">instanceof</span> FactoryBean<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">FactoryBean</span><span style="color: #1776b6;">&lt;</span>?<span style="color: #1776b6;">&gt;</span> <span style="color: #7590db;">factory</span> = <span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">FactoryBean</span><span style="color: #00bed1;">&lt;</span>?<span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> bean;
                    <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">isEagerInit</span>;
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>System.getSecurityManager<span style="color: #00bed1;">()</span> != <span style="color: #a45bad;">null</span> &amp;&amp; factory <span style="color: #4f97d7; font-weight: bold;">instanceof</span> SmartFactoryBean<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        isEagerInit = AccessController.doPrivileged<span style="color: #00bed1;">(</span><span style="color: #bcbf00;">(</span><span style="color: #ce537a; font-weight: bold;">PrivilegedAction</span><span style="color: #e574c3;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Boolean</span><span style="color: #e574c3;">&gt;</span><span style="color: #bcbf00;">)</span>
                                        <span style="color: #bcbf00;">(</span><span style="color: #e574c3;">(</span><span style="color: #ce537a; font-weight: bold;">SmartFactoryBean</span><span style="color: #8d5649;">&lt;</span>?<span style="color: #8d5649;">&gt;</span><span style="color: #e574c3;">)</span> factory<span style="color: #bcbf00;">)</span>::isEagerInit,
                                getAccessControlContext<span style="color: #bcbf00;">()</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #1776b6;">{</span>
                        isEagerInit = <span style="color: #00bed1;">(</span>factory <span style="color: #4f97d7; font-weight: bold;">instanceof</span> SmartFactoryBean &amp;&amp;
                                <span style="color: #bcbf00;">(</span><span style="color: #e574c3;">(</span><span style="color: #ce537a; font-weight: bold;">SmartFactoryBean</span><span style="color: #8d5649;">&lt;</span>?<span style="color: #8d5649;">&gt;</span><span style="color: #e574c3;">)</span> factory<span style="color: #bcbf00;">)</span>.isEagerInit<span style="color: #bcbf00;">()</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>isEagerInit<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        getBean<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #24a222;">{</span>
                getBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Trigger post-initialization callback for all applicable beans...</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span> : beanNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">singletonInstance</span> = getSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>singletonInstance <span style="color: #4f97d7; font-weight: bold;">instanceof</span> SmartInitializingSingleton<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">SmartInitializingSingleton</span> <span style="color: #7590db;">smartSingleton</span> = <span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">SmartInitializingSingleton</span><span style="color: #24a222;">)</span> singletonInstance;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>System.getSecurityManager<span style="color: #ff7f00;">()</span> != <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AccessController.doPrivileged<span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #ce537a; font-weight: bold;">PrivilegedAction</span><span style="color: #00bed1;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">()</span> -&gt; <span style="color: #1776b6;">{</span>
                    smartSingleton.afterSingletonsInstantiated<span style="color: #00bed1;">()</span>;
                    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
                <span style="color: #1776b6;">}</span>, getAccessControlContext<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #24a222;">{</span>
                smartSingleton.afterSingletonsInstantiated<span style="color: #ff7f00;">()</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d37fd6" class="outline-4">
<h4 id="org6d37fd6"><span class="section-number-4">4.3.7</span> 完成上下文刷新</h4>
<div class="outline-text-4" id="text-4-3-7">
<p>
<code>finishRefresh()</code> 完成上下文的刷新
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Finish the refresh of this context, invoking the LifecycleProcessor's</span>
<span style="color: #9f8766;"> * onRefresh() method and publishing the</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">{@link org.springframework.context.event.ContextRefreshedEvent}</span><span style="color: #9f8766;">.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">finishRefresh</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Clear context-level resource caches (such as ASM metadata from scanning).</span>
    clearResourceCaches<span style="color: #d8241f;">()</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize lifecycle processor for this context.</span>
    initLifecycleProcessor<span style="color: #d8241f;">()</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Propagate refresh to lifecycle processor first.</span>
    getLifecycleProcessor<span style="color: #d8241f;">()</span>.onRefresh<span style="color: #d8241f;">()</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Publish the final event.</span>
    publishEvent<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ContextRefreshedEvent</span><span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Participate in LiveBeansView MBean, if active.</span>
    LiveBeansView.registerApplicationContext<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
首先调用 <code>clearResourceCaches()</code> 方法清理资源的缓存
</p>

<p>
接着 <code>initLifecycleProcessor()</code> 初始化生命周期的处理器，该方法主要是初始化了
<code>LifecycleProcessor</code> 类
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Initialize the LifecycleProcessor.</span>
<span style="color: #9f8766;"> * Uses DefaultLifecycleProcessor if none defined in the context.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> org.springframework.context.support.DefaultLifecycleProcessor</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">initLifecycleProcessor</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span> <span style="color: #7590db;">beanFactory</span> = getBeanFactory<span style="color: #d8241f;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>LIFECYCLE_PROCESSOR_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.lifecycleProcessor =
                beanFactory.getBean<span style="color: #9564bf;">(</span>LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"Using LifecycleProcessor ["</span> + <span style="color: #4f97d7; font-weight: bold;">this</span>.lifecycleProcessor + <span style="color: #2d9574;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">DefaultLifecycleProcessor</span> <span style="color: #7590db;">defaultProcessor</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DefaultLifecycleProcessor</span><span style="color: #9564bf;">()</span>;
        defaultProcessor.setBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.lifecycleProcessor = defaultProcessor;
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>LIFECYCLE_PROCESSOR_BEAN_NAME, <span style="color: #4f97d7; font-weight: bold;">this</span>.lifecycleProcessor<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2d9574;">"No '"</span> + LIFECYCLE_PROCESSOR_BEAN_NAME + <span style="color: #2d9574;">"' bean, using "</span> +
                    <span style="color: #2d9574;">"["</span> + <span style="color: #4f97d7; font-weight: bold;">this</span>.lifecycleProcessor.getClass<span style="color: #ff7f00;">()</span>.getSimpleName<span style="color: #ff7f00;">()</span> + <span style="color: #2d9574;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>getLifecycleProcessor().onRefresh()</code> 方法传播更新状态
</p>

<p>
调用 <code>publishEvent(...)</code> 方法发布事件
</p>
<ol class="org-ol">
<li>发布 ContextRefreshedEvent 事件</li>
<li>如果父 ApplicationContext 存在，将事件传播到父 ApplicationContext 中</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Publish the given event to all listeners.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> event the event to publish (may be an </span><span style="color: #a45bad;">{@link ApplicationEvent}</span>
<span style="color: #9f8766;"> * or a payload object to be turned into a </span><span style="color: #a45bad;">{@link PayloadApplicationEvent}</span><span style="color: #9f8766;">)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> eventType the resolved event type, if known</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@since</span><span style="color: #9f8766;"> 4.2</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">publishEvent</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">event</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">ResolvableType</span> <span style="color: #7590db;">eventType</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>event, <span style="color: #2d9574;">"Event must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Decorate event as an ApplicationEvent if necessary</span>
    <span style="color: #ce537a; font-weight: bold;">ApplicationEvent</span> <span style="color: #7590db;">applicationEvent</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>event <span style="color: #4f97d7; font-weight: bold;">instanceof</span> ApplicationEvent<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        applicationEvent = <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">ApplicationEvent</span><span style="color: #9564bf;">)</span> event;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        applicationEvent = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">PayloadApplicationEvent</span><span style="color: #9564bf;">&lt;&gt;(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, event<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>eventType == <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            eventType = <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">PayloadApplicationEvent</span><span style="color: #1776b6;">&lt;</span>?<span style="color: #1776b6;">&gt;</span><span style="color: #ff7f00;">)</span> applicationEvent<span style="color: #24a222;">)</span>.getResolvableType<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Multicast right now if possible - or lazily once the multicaster is initialized</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationEvents != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.earlyApplicationEvents.add<span style="color: #9564bf;">(</span>applicationEvent<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #d8241f;">{</span>
        getApplicationEventMulticaster<span style="color: #9564bf;">()</span>.multicastEvent<span style="color: #9564bf;">(</span>applicationEvent, eventType<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Publish event via parent context as well...</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.parent != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.parent <span style="color: #4f97d7; font-weight: bold;">instanceof</span> AbstractApplicationContext<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">AbstractApplicationContext</span><span style="color: #ff7f00;">)</span> <span style="color: #4f97d7; font-weight: bold;">this</span>.parent<span style="color: #24a222;">)</span>.publishEvent<span style="color: #24a222;">(</span>event, eventType<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">this</span>.parent.publishEvent<span style="color: #24a222;">(</span>event<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdec5a9a" class="outline-2">
<h2 id="orgdec5a9a"><span class="section-number-2">5</span> AOP 面向切面编程</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org5ba22ae" class="outline-3">
<h3 id="org5ba22ae"><span class="section-number-3">5.1</span> AOP 预备知识</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org019e8ec" class="outline-4">
<h4 id="org019e8ec"><span class="section-number-4">5.1.1</span> AOP 核心概念</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
AOP 叫做面向切面编程，他是一个编程范式，目的就是提高代码的模块性。Spring AOP
基于动态代理的方式实现，如果是实现了接口的话就会使用 JDK 动态代理，反之则使
用 CGLIB 代理，Spring 中 AOP 的应用主要体现在 事务、日志、异常处理等方面，通
过在代码的前后做一些增强处理，可以实现对业务逻辑的隔离，提高代码的模块化能力，
同时也是解耦。
</p>

<ol class="org-ol">
<li>Aspect: 切面，由一系列切点、增强和引入组成的模块对象，可定义优先级，从而
影响增强和引入的执行顺序。事务管理在 Java 企业应用中就是一个很好的切面样例</li>
<li>Join point: 接入点，程序执行期的一个点，例如方法执行、类初始化、异常处理。
在 Spring AOP 中，接入点始终表示方法执行</li>
<li>Advice: 增强，切面在特定接入点的执行动作，包括 Around, Before 和 After 等
多种类型。包含 Spring 在内的许多 AOP 框架，通常会使用拦截器来实现增强，围
绕着接入点维护着一个拦截器链</li>
<li>Pointcut: 切点，用来匹配特定接入点的谓词表达式，增强将会与切点表达式产生
关联，并运行在任何切点匹配到的接入点上。通过切点表达式匹配接入点是 AOP 的
核心，Spring 默认使用 AspectJ 的切点表达式</li>
<li>Introduction: 引入，为某个 Type 声明额外的方法和字段。Spring AOP 允许你引
入任何接口以及它的默认实现到被增强对象上</li>
<li>Target object: 目标对象，被一个或多个切面增强的对象。也叫作被增强对象。既
然 Spring AOP 使用运行时代理，那么目标对象就总是代理对象</li>
<li>AOP proxy: AOP 代理，为了实现切面功能一个对象会被 AOP 框架创建出来。</li>
<li>Weaving：织入，将一个或多个切面与类或对象链接在一起创建一个被增强对象。织
入能发生在编译时 ，加载时或运行时。Spring AOP 默认就是运行时织入，可以通
过枚举 AdviceMode 来设置</li>
</ol>
</div>
</div>

<div id="outline-container-orge98124c" class="outline-4">
<h4 id="orge98124c"><span class="section-number-4">5.1.2</span> JDK 动态代理和 cglib 动态代理</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
使用动态代理实现主要使用下面两种方法
</p>
<ol class="org-ol">
<li>JDK 动态代理
<ul class="org-ul">
<li><p>
其代理对象必须是某个接口的实现
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@CallerSensitive</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">newProxyInstance</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">ClassLoader</span> <span style="color: #7590db;">loader</span>,
                                      <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;[]</span> <span style="color: #7590db;">interfaces</span>,
                                      <span style="color: #ce537a; font-weight: bold;">InvocationHandler</span> <span style="color: #7590db;">h</span><span style="color: #8d5649;">)</span>
  <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">IllegalArgumentException</span> <span style="color: #8d5649;">{</span>...<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li>它是通过运行期间创建一个接口的实现类来完成对目标对象的代理</li>
</ul></li>
<li>cglib 动态代理
<ul class="org-ul">
<li>原理类似 JDK 动态代理，只是它在运行期间创建的代理对象是针对目标类扩展的
子类</li>
<li>cglib 底层基于 ASM 开源 Java 字节码编辑类库实现，通过修改字节码生成成成
一个子类，然后重写父类的方法，实现对代码的增强</li>
<li>性能优于 JDK 动态代理</li>
</ul></li>
<li>常见 XML 设置属性
<ul class="org-ul">
<li>proxy-target-class 属性
<ul class="org-ul">
<li>属性值决定是基于接口的还是基于类的代理被创建。</li>
<li><code>proxy-target-class="true"</code> 基于类的代理将起作用（需要 cglib 库）</li>
<li><code>proxy-target-class="false"</code> 标准的 JDK 基于接口的代理将起作用</li>
<li>在 Spring 事务, AOP, 缓存这几块都有设置，其作用都是一样的</li>
</ul></li>
<li>expose-class 属性
<ul class="org-ul">
<li>通过 ThreadLocal 暴露 AOP 代理对象</li>
<li><code>this.b();</code> 修改为 <code>((AService) AopContext.currentProxy()).b();</code> 来显
示调用</li>
<li>开启新的事务最好写在另外一个 Service 中, 将传播机制设为 <code>REQUIRE_NEW</code></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org5295842" class="outline-4">
<h4 id="org5295842"><span class="section-number-4">5.1.3</span> Spring AOP 和 AspectJ 的区别</h4>
<div class="outline-text-4" id="text-5-1-3">
<ol class="org-ol">
<li>Spring AOP 基于动态代理实现，属于运行时增强</li>
<li>AspectJ 则属于编译时增强，主要有 3 种方式
<ul class="org-ul">
<li><b>编译时织入</b>: 指的是增强的代码和源代码我们都有，直接使用 AspectJ 编译器
编译就行，编译之后生成一个新的类，他也会作为一个正常的 Java 类装载到
JVM 虚拟机中</li>
<li><b>编译后织入</b>: 指的是代码已经被编译成 class 文件或者已经打成 jar 包，这
时候要增强的话，就是编译后织入，比如你依赖了第三方的类库，又想对他增强
的话，就可以通过这种方式</li>
<li><b>加载时织入</b>: 指的是在 JVM 加载类的时候进行织入</li>
</ul></li>
<li>总结下来的话，就是 Spring AOP 只能在运行时织入，不需要单独编译，性能相比
AspectJ 编译织入的方式慢，而 AspectJ 只支持编译前后和类加载时织入，性能更
好， 功能更加强大</li>
</ol>
</div>
</div>

<div id="outline-container-org97cfd38" class="outline-4">
<h4 id="org97cfd38"><span class="section-number-4">5.1.4</span> AOP 组件</h4>
<div class="outline-text-4" id="text-5-1-4">
<p>
PointCut 接口的定义如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20999;&#20837;&#28857;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">Pointcut</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">ClassFilter</span> <span style="color: #bc6ec5; font-weight: bold;">getClassFilter</span><span style="color: #d8241f;">()</span>;
  <span style="color: #ce537a; font-weight: bold;">MethodMatcher</span> <span style="color: #bc6ec5; font-weight: bold;">getMethodMatcher</span><span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#31867;&#36807;&#28388;&#22120;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">ClassFilter</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">matches</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span> <span style="color: #7590db;">clazz</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#26041;&#27861;&#36807;&#28388;&#22120;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">MethodMatcher</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">matches</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Method</span> <span style="color: #7590db;">m</span>, <span style="color: #ce537a; font-weight: bold;">Class</span> <span style="color: #7590db;">targetClass</span><span style="color: #d8241f;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isRuntime</span><span style="color: #d8241f;">()</span>;
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">matches</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Method</span> <span style="color: #7590db;">m</span>, <span style="color: #ce537a; font-weight: bold;">Class</span> <span style="color: #7590db;">targetClass</span>, <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #9564bf;">[]</span> <span style="color: #7590db;">args</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
Advisor 及 Advice 的接口定义如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22686;&#21152;&#22120;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">Advisor</span> <span style="color: #8d5649;">{</span>
  <span style="color: #ce537a; font-weight: bold;">Advice</span> <span style="color: #7590db;">EMPTY_ADVICE</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">Advice</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{}</span>;
  <span style="color: #ce537a; font-weight: bold;">Advice</span> <span style="color: #bc6ec5; font-weight: bold;">getAdvice</span><span style="color: #d8241f;">()</span>;
  <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">isPerInstance</span><span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22686;&#24378;</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">Advice</span> <span style="color: #8d5649;">{}</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">BeforeAdvice</span> <span style="color: #4f97d7; font-weight: bold;">extends</span> <span style="color: #ce537a; font-weight: bold;">Advice</span> <span style="color: #8d5649;">{}</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">AfterAdvice</span> <span style="color: #4f97d7; font-weight: bold;">extends</span> <span style="color: #ce537a; font-weight: bold;">Advice</span> <span style="color: #8d5649;">{}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0d0fec3" class="outline-4">
<h4 id="org0d0fec3"><span class="section-number-4">5.1.5</span> AOP 实践案例</h4>
<div class="outline-text-4" id="text-5-1-5">
<p>
添加日志的 Bean 对象
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">package</span> io.github.jeanhwea.app07_aop.<span style="color: #a45bad;">beans</span>;

<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">springframework</span>.<span style="color: #a45bad;">beans</span>.<span style="color: #a45bad;">factory</span>.<span style="color: #a45bad;">annotation</span>.<span style="color: #ce537a; font-weight: bold;">Value</span>;
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">springframework</span>.<span style="color: #a45bad;">stereotype</span>.<span style="color: #ce537a; font-weight: bold;">Component</span>;

<span style="color: #a45bad;">@Component</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">LogEntry</span> <span style="color: #8d5649;">{</span>

  <span style="color: #a45bad;">@Value</span><span style="color: #d8241f;">(</span><span style="color: #2d9574;">"Hello in LogEntry"</span><span style="color: #d8241f;">)</span>
  <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">message</span>;

  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #bc6ec5; font-weight: bold;">getMessage</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> message;
  <span style="color: #d8241f;">}</span>

  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setMessage</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">message</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">this</span>.message = message;
  <span style="color: #d8241f;">}</span>

  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">say</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"say: "</span> + message<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
添加 Aspect 对象，对象中包含如下组件
</p>
<ol class="org-ol">
<li><code>@Aspect</code> 注解当前类为 Aspect</li>
<li><code>@EnableAspectJAutoProxy</code> 需要开启自动 Aspect 代理</li>
<li><code>@Pointcut("execution(* *.say(..))")</code> 添加切入点</li>
<li>添加增强方法
<ul class="org-ul">
<li><code>@Before("say()")</code> 前置执行函数</li>
<li><code>@After("say()")</code> 后置执行函数</li>
<li><code>@Around("say()")</code> 环绕执行函数</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">package</span> io.github.jeanhwea.app07_aop.<span style="color: #a45bad;">beans</span>;

<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">aspectj</span>.<span style="color: #a45bad;">lang</span>.<span style="color: #ce537a; font-weight: bold;">ProceedingJoinPoint</span>;
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">aspectj</span>.<span style="color: #a45bad;">lang</span>.<span style="color: #a45bad;">annotation</span>.*;
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">springframework</span>.<span style="color: #a45bad;">context</span>.<span style="color: #a45bad;">annotation</span>.<span style="color: #ce537a; font-weight: bold;">EnableAspectJAutoProxy</span>;
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">springframework</span>.<span style="color: #a45bad;">stereotype</span>.<span style="color: #ce537a; font-weight: bold;">Component</span>;

<span style="color: #a45bad;">@Aspect</span>
<span style="color: #a45bad;">@Component</span>
<span style="color: #a45bad;">@EnableAspectJAutoProxy</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">LogEntryAspect</span> <span style="color: #8d5649;">{</span>

  <span style="color: #a45bad;">@Pointcut</span><span style="color: #d8241f;">(</span><span style="color: #2d9574;">"execution(* *.say(..))"</span><span style="color: #d8241f;">)</span>
  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">say</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{}</span>

  <span style="color: #a45bad;">@Before</span><span style="color: #d8241f;">(</span><span style="color: #2d9574;">"say()"</span><span style="color: #d8241f;">)</span>
  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">beforeSay</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"beforeSay"</span><span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #a45bad;">@After</span><span style="color: #d8241f;">(</span><span style="color: #2d9574;">"say()"</span><span style="color: #d8241f;">)</span>
  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">afterSay</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"afterSay"</span><span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #a45bad;">@Around</span><span style="color: #d8241f;">(</span><span style="color: #2d9574;">"say()"</span><span style="color: #d8241f;">)</span>
  <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">aroundSay</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">ProceedingJoinPoint</span> <span style="color: #7590db;">point</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"aroundSay/preActions"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">obj</span> = <span style="color: #a45bad;">null</span>;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #9564bf;">{</span>
      obj = point.proceed<span style="color: #24a222;">()</span>;
    <span style="color: #9564bf;">}</span> <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">e</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      e.printStackTrace<span style="color: #24a222;">()</span>;
    <span style="color: #9564bf;">}</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"aroundSay/postActions"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> obj;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org43f24f0" class="outline-3">
<h3 id="org43f24f0"><span class="section-number-3">5.2</span> AOP 实现原理</h3>
<div class="outline-text-3" id="text-5-2">
</div>
<div id="outline-container-org87a08ca" class="outline-4">
<h4 id="org87a08ca"><span class="section-number-4">5.2.1</span> AOP 的工具类 <code>AopNamespaceUtils</code></h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
<code>AopNamespaceUtils</code> 实现了 AOP 的常用方法
</p>
<ol class="org-ol">
<li><code>registerAutoProxyCreatorIfNecessary(...)</code> 注册 AOP 代理创建器</li>
<li><code>registerAspectJAutoProxyCreatorIfNecessary(...)</code> 注册 AspectJ 代理创建器</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">abstract</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">AopNamespaceUtils</span> <span style="color: #8d5649;">{</span>

    <span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;">     * The </span><span style="color: #a45bad;">{@code proxy-target-class}</span><span style="color: #9f8766;"> attribute as found on AOP-related XML tags.</span>
<span style="color: #9f8766;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">PROXY_TARGET_CLASS_ATTRIBUTE</span> = <span style="color: #2d9574;">"proxy-target-class"</span>;

    <span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;">     * The </span><span style="color: #a45bad;">{@code expose-proxy}</span><span style="color: #9f8766;"> attribute as found on AOP-related XML tags.</span>
<span style="color: #9f8766;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">EXPOSE_PROXY_ATTRIBUTE</span> = <span style="color: #2d9574;">"expose-proxy"</span>;


    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerAutoProxyCreatorIfNecessary</span><span style="color: #d8241f;">(</span>
            <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span>, <span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDefinition</span> = AopConfigUtils.registerAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>
                parserContext.getRegistry<span style="color: #24a222;">()</span>, parserContext.extractSource<span style="color: #24a222;">(</span>sourceElement<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        useClassProxyingIfNecessary<span style="color: #9564bf;">(</span>parserContext.getRegistry<span style="color: #24a222;">()</span>, sourceElement<span style="color: #9564bf;">)</span>;
        registerComponentIfNecessary<span style="color: #9564bf;">(</span>beanDefinition, parserContext<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerAspectJAutoProxyCreatorIfNecessary</span><span style="color: #d8241f;">(</span>
            <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span>, <span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDefinition</span> = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>
                parserContext.getRegistry<span style="color: #24a222;">()</span>, parserContext.extractSource<span style="color: #24a222;">(</span>sourceElement<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        useClassProxyingIfNecessary<span style="color: #9564bf;">(</span>parserContext.getRegistry<span style="color: #24a222;">()</span>, sourceElement<span style="color: #9564bf;">)</span>;
        registerComponentIfNecessary<span style="color: #9564bf;">(</span>beanDefinition, parserContext<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span style="color: #d8241f;">(</span>
            <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span>, <span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDefinition</span> = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>
                parserContext.getRegistry<span style="color: #24a222;">()</span>, parserContext.extractSource<span style="color: #24a222;">(</span>sourceElement<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        useClassProxyingIfNecessary<span style="color: #9564bf;">(</span>parserContext.getRegistry<span style="color: #24a222;">()</span>, sourceElement<span style="color: #9564bf;">)</span>;
        registerComponentIfNecessary<span style="color: #9564bf;">(</span>beanDefinition, parserContext<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">useClassProxyingIfNecessary</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistry</span> <span style="color: #7590db;">registry</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>sourceElement != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">proxyTargetClass</span> = Boolean.parseBoolean<span style="color: #24a222;">(</span>sourceElement.getAttribute<span style="color: #ff7f00;">(</span>PROXY_TARGET_CLASS_ATTRIBUTE<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>proxyTargetClass<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">exposeProxy</span> = Boolean.parseBoolean<span style="color: #24a222;">(</span>sourceElement.getAttribute<span style="color: #ff7f00;">(</span>EXPOSE_PROXY_ATTRIBUTE<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>exposeProxy<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToExposeProxy<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerComponentIfNecessary</span><span style="color: #d8241f;">(</span><span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDefinition</span>, <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>beanDefinition != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            parserContext.registerComponent<span style="color: #24a222;">(</span>
                    <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanComponentDefinition</span><span style="color: #ff7f00;">(</span>beanDefinition, <span style="color: #a45bad;">AopConfigUtils</span>.AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org44c5657" class="outline-4">
<h4 id="org44c5657"><span class="section-number-4">5.2.2</span> AOP 代理是否开启 <code>AspectJAutoProxyRegistrar</code></h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
<code>AspectJAutoProxyRegistrar</code> 类实现了扫描是否开启自动进行 AOP 代理其实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">AspectJAutoProxyRegistrar</span> <span style="color: #4f97d7; font-weight: bold;">implements</span> <span style="color: #ce537a; font-weight: bold;">ImportBeanDefinitionRegistrar</span> <span style="color: #8d5649;">{</span>

    <span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;">     * Register, escalate, and configure the AspectJ auto proxy creator based on the value</span>
<span style="color: #9f8766;">     * of the @</span><span style="color: #a45bad;">{@link EnableAspectJAutoProxy#proxyTargetClass()}</span><span style="color: #9f8766;"> attribute on the importing</span>
<span style="color: #9f8766;">     * </span><span style="color: #a45bad;">{@code @Configuration}</span><span style="color: #9f8766;"> class.</span>
<span style="color: #9f8766;">     */</span>
    <span style="color: #a45bad;">@Override</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">registerBeanDefinitions</span><span style="color: #d8241f;">(</span>
            <span style="color: #ce537a; font-weight: bold;">AnnotationMetadata</span> <span style="color: #7590db;">importingClassMetadata</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistry</span> <span style="color: #7590db;">registry</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>registry<span style="color: #9564bf;">)</span>;

        <span style="color: #ce537a; font-weight: bold;">AnnotationAttributes</span> <span style="color: #7590db;">enableAspectJAutoProxy</span> =
                AnnotationConfigUtils.attributesFor<span style="color: #9564bf;">(</span>importingClassMetadata, EnableAspectJAutoProxy.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>enableAspectJAutoProxy != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>enableAspectJAutoProxy.getBoolean<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"proxyTargetClass"</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>enableAspectJAutoProxy.getBoolean<span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"exposeProxy"</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToExposeProxy<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法实现逻辑如下
</p>
<ol class="org-ol">
<li>扫描是否开启 AOP 自动代理开关</li>
<li>如果开启则创建 AspectJ 的代理创建器</li>
<li>并且配置 <code>proxyTargetClass</code> 和 <code>exposeProxy</code> 属性</li>
</ol>

<p>
进入 <code>registerBeanDefinitions(...)</code> 方法里面可以看出
</p>
<div class="org-src-container">
<pre class="src src-text">registerOrEscalateApcAsRequired:123, AopConfigUtils (org.springframework.aop.config)
registerAspectJAnnotationAutoProxyCreatorIfNecessary:100, AopConfigUtils (org.springframework.aop.config)
registerAspectJAnnotationAutoProxyCreatorIfNecessary:93, AopConfigUtils (org.springframework.aop.config)
registerBeanDefinitions:45, AspectJAutoProxyRegistrar (org.springframework.context.annotation)
registerBeanDefinitions:86, ImportBeanDefinitionRegistrar (org.springframework.context.annotation)
lambda$loadBeanDefinitionsFromRegistrars$1:385, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
accept:-1, 1233990028 (org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader$$Lambda$45)
forEach:684, LinkedHashMap (java.util)
loadBeanDefinitionsFromRegistrars:384, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
loadBeanDefinitionsForConfigurationClass:148, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
loadBeanDefinitions:120, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
processConfigBeanDefinitions:331, ConfigurationClassPostProcessor (org.springframework.context.annotation)
postProcessBeanDefinitionRegistry:236, ConfigurationClassPostProcessor (org.springframework.context.annotation)
invokeBeanDefinitionRegistryPostProcessors:275, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:95, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:9, MyApp07 (io.github.jeanhwea.app07_aop)
</pre>
</div>

<p>
<code>registerOrEscalateApcAsRequired(...)</code> 的实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Nullable</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #bc6ec5; font-weight: bold;">registerOrEscalateApcAsRequired</span><span style="color: #8d5649;">(</span>
        <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">cls</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinitionRegistry</span> <span style="color: #7590db;">registry</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">source</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    Assert.notNull<span style="color: #d8241f;">(</span>registry, <span style="color: #2d9574;">"BeanDefinitionRegistry must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>registry.containsBeanDefinition<span style="color: #9564bf;">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">apcDefinition</span> = registry.getBeanDefinition<span style="color: #9564bf;">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>cls.getName<span style="color: #24a222;">()</span>.equals<span style="color: #24a222;">(</span>apcDefinition.getBeanClassName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">currentPriority</span> = findPriorityForClass<span style="color: #24a222;">(</span>apcDefinition.getBeanClassName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
            <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">requiredPriority</span> = findPriorityForClass<span style="color: #24a222;">(</span>cls<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>currentPriority &lt; <span style="color: #ce537a; font-weight: bold;">requiredPriority</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                apcDefinition.setBeanClassName<span style="color: #ff7f00;">(</span>cls.getName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span> <span style="color: #7590db;">beanDefinition</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">RootBeanDefinition</span><span style="color: #d8241f;">(</span>cls<span style="color: #d8241f;">)</span>;
    beanDefinition.setSource<span style="color: #d8241f;">(</span>source<span style="color: #d8241f;">)</span>;
    beanDefinition.getPropertyValues<span style="color: #d8241f;">()</span>.add<span style="color: #d8241f;">(</span><span style="color: #2d9574;">"order"</span>, <span style="color: #a45bad;">Ordered</span>.HIGHEST_PRECEDENCE<span style="color: #d8241f;">)</span>;
    beanDefinition.setRole<span style="color: #d8241f;">(</span><span style="color: #a45bad;">BeanDefinition</span>.ROLE_INFRASTRUCTURE<span style="color: #d8241f;">)</span>;
    registry.registerBeanDefinition<span style="color: #d8241f;">(</span>AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> beanDefinition;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>如果存在自动代理创建器
<ul class="org-ul">
<li>通过优先级判断需要使用哪个创建器</li>
<li>如果 currentPriority 小于 requiredPriority 则需要修改 Bean 的</li>
</ul></li>
<li>否则设置默认优先级等 BeanDefinition 参数</li>
<li><p>
注意 AUTO_PROXY_CREATOR_BEAN_NAME 的值为
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * The bean name of the internally managed auto-proxy creator.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">AUTO_PROXY_CREATOR_BEAN_NAME</span> =
        <span style="color: #2d9574;">"org.springframework.aop.config.internalAutoProxyCreator"</span>;
</pre>
</div></li>
<li>这里给容器中注册一个 <code>AnnotationAwareAspectJAutoProxyCreator</code></li>
</ol>
</div>
</div>

<div id="outline-container-org7162e4e" class="outline-4">
<h4 id="org7162e4e"><span class="section-number-4">5.2.3</span> AspectJ 创建器 <code>AnnotationAwareAspectJAutoProxyCreator</code></h4>
<div class="outline-text-4" id="text-5-2-3">
<p>
<code>AnnotationAwareAspectJAutoProxyCreator</code> 是自动创建 AspectJ 代理类的创建器，
该类的概览如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.aop.aspectj.annotation
Class AnnotationAwareAspectJAutoProxyCreator

    java.lang.Object
        org.springframework.aop.framework.ProxyConfig
            org.springframework.aop.framework.ProxyProcessorSupport
                org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator
                    org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator
                        org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator
                            org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator

     All Implemented Interfaces:
        Serializable, AopInfrastructureBean,
        org.springframework.beans.factory.Aware,
        org.springframework.beans.factory.BeanClassLoaderAware,
        org.springframework.beans.factory.BeanFactoryAware,
        org.springframework.beans.factory.config.BeanPostProcessor,
        org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor,
        org.springframework.beans.factory.config.SmartInstantiationAwareBeanPostProcessor,
        org.springframework.core.Ordered
</pre>
</div>
<ol class="org-ol">
<li><code>AbstractAutoProxyCreator</code> 实现了 AOP 的核心方法
<ul class="org-ul">
<li>实现了 <code>BeanFactoryAware</code> 和 <code>BeanPostProcessor</code> 接口</li>
<li><code>createProxy(...)</code> 创建代理类</li>
<li><code>buildAdvisors(...)</code> 通过传入的 Bean 来创建 Advisor</li>
<li><code>wrapIfNecessary(...)</code> 包裹 Bean 方法，添加代理包裹信息</li>
<li><code>isInfrastructureClass(...)</code>
<ul class="org-ul">
<li>判断是否是 <code>Advice</code>, <code>PointCut</code>, <code>Advisor</code> 或 <code>AopInfrastructureBean</code></li>
<li>InfrastructureClass 需要添加 AOP 代理</li>
</ul></li>
</ul></li>
<li><code>InstantiationAwareBeanPostProcessor</code> 接口包含类实例化和初始化前后的构造函数
<ul class="org-ul">
<li><code>postProcessBeforeInstantiation(...)</code> 实例化前调用的代理类创建方法</li>
<li><code>postProcessAfterInitialization(...)</code> 初始化后调用的代理类创建方法</li>
<li><code>postProcessAfterInstantiation(...)</code> 实例化后调用的代理类创建方法</li>
<li><code>postProcessBeforeInitialization(...)</code> 初始化前调用的代理类创建方法</li>
</ul></li>
<li><code>AbstractAdvisorAutoProxyCreator</code> 包括 Advisor 的创建方法
<ul class="org-ul">
<li><code>getAdvicesAndAdvisorsForBean(...)</code> 查找 Bean 的 Advisor</li>
<li><code>findEligibleAdvisors(...)</code> 获取 Bean 所需的合适的 Advisor</li>
<li><code>findAdvisorsThatCanApply(...)</code> 获取可以应用的 Advisor</li>
</ul></li>
<li><code>AspectJAwareAdvisorAutoProxyCreator</code>
<ul class="org-ul">
<li>类似 <code>AbstractAdvisorAutoProxyCreator</code>, 针对 AspectJ 进行扩展</li>
<li><code>AbstractAdvisorAutoProxyCreator</code> 是抽象类,
<code>AspectJAwareAdvisorAutoProxyCreator</code> 是类</li>
</ul></li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code>
<ul class="org-ul">
<li>添加对注解 Aspect 的扩展</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org6fbdb6c" class="outline-4">
<h4 id="org6fbdb6c"><span class="section-number-4">5.2.4</span> <code>AbstractAutoProxyCreator</code> 提前埋点</h4>
<div class="outline-text-4" id="text-5-2-4">
<p>
实例化前 <code>getAdvicesAndAdvisorsForBean(...)</code> 创建 Bean 的增强器
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">postProcessBeforeInstantiation</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">beanClass</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">cacheKey</span> = getCacheKey<span style="color: #d8241f;">(</span>beanClass, beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> || <span style="color: #a45bad;">!</span><span style="color: #4f97d7; font-weight: bold;">this</span>.targetSourcedBeans.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.advisedBeans.containsKey<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>isInfrastructureClass<span style="color: #24a222;">(</span>beanClass<span style="color: #24a222;">)</span> || shouldSkip<span style="color: #24a222;">(</span>beanClass, beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">this</span>.advisedBeans.put<span style="color: #24a222;">(</span>cacheKey, <span style="color: #a45bad;">Boolean</span>.FALSE<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Create proxy here if we have a custom TargetSource.</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Suppresses unnecessary default instantiation of the target bean:</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The TargetSource will handle target instances in a custom fashion.</span>
    <span style="color: #ce537a; font-weight: bold;">TargetSource</span> <span style="color: #7590db;">targetSource</span> = getCustomTargetSource<span style="color: #d8241f;">(</span>beanClass, beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>targetSource != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>StringUtils.hasLength<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">this</span>.targetSourcedBeans.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #9564bf;">[]</span> <span style="color: #7590db;">specificInterceptors</span> = getAdvicesAndAdvisorsForBean<span style="color: #9564bf;">(</span>beanClass, beanName, targetSource<span style="color: #9564bf;">)</span>;
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">proxy</span> = createProxy<span style="color: #9564bf;">(</span>beanClass, beanName, specificInterceptors, targetSource<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.proxyTypes.put<span style="color: #9564bf;">(</span>cacheKey, proxy.getClass<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> proxy;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
初始化后调用 <code>wrapIfNecessary(...)</code> 进行 Bean 的包裹，这里会调用
<code>createProxy(...)</code> 方法创建代理类
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Create a proxy with the configured interceptors if the bean is</span>
<span style="color: #9f8766;"> * identified as one to proxy by the subclass.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #getAdvicesAndAdvisorsForBean</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">postProcessAfterInitialization</span><span style="color: #8d5649;">(</span><span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>bean != <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">cacheKey</span> = getCacheKey<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span>, beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.earlyProxyReferences.remove<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span> != bean<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> wrapIfNecessary<span style="color: #24a222;">(</span>bean, beanName, cacheKey<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org721be0a" class="outline-4">
<h4 id="org721be0a"><span class="section-number-4">5.2.5</span> XML 方式的 AOP 读取</h4>
<div class="outline-text-4" id="text-5-2-5">
<p>
<code>&lt;aspectj-autoproxy/&gt;</code> 自动注解 <code>AopNamespaceHandler</code> 类中添加自动注解标签
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">AopNamespaceHandler</span> <span style="color: #4f97d7; font-weight: bold;">extends</span> <span style="color: #ce537a; font-weight: bold;">NamespaceHandlerSupport</span> <span style="color: #8d5649;">{</span>

    <span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;">     * Register the </span><span style="color: #a45bad;">{@link BeanDefinitionParser BeanDefinitionParsers}</span><span style="color: #9f8766;"> for the</span>
<span style="color: #9f8766;">     * '</span><span style="color: #a45bad;">{@code config}</span><span style="color: #9f8766;">', '</span><span style="color: #a45bad;">{@code spring-configured}</span><span style="color: #9f8766;">', '</span><span style="color: #a45bad;">{@code aspectj-autoproxy}</span><span style="color: #9f8766;">'</span>
<span style="color: #9f8766;">     * and '</span><span style="color: #a45bad;">{@code scoped-proxy}</span><span style="color: #9f8766;">' tags.</span>
<span style="color: #9f8766;">     */</span>
    <span style="color: #a45bad;">@Override</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">init</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">In 2.0 XSD as well as in 2.1 XSD.</span>
        registerBeanDefinitionParser<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"config"</span>, <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ConfigBeanDefinitionParser</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        registerBeanDefinitionParser<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"aspectj-autoproxy"</span>, <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">AspectJAutoProxyBeanDefinitionParser</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        registerBeanDefinitionDecorator<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"scoped-proxy"</span>, <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ScopedProxyBeanDefinitionDecorator</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Only in 2.0 XSD: moved to context namespace as of 2.1</span>
        registerBeanDefinitionParser<span style="color: #9564bf;">(</span><span style="color: #2d9574;">"spring-configured"</span>, <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">SpringConfiguredBeanDefinitionParser</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>NamespaceHandler</code> 提供 <code>BeanDefinitionParser</code> 的 <code>&lt;aop:config&gt;</code> 标签支持，例
如接入地 <code>&lt;pointcut/&gt;</code> 标签的定义
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #4f97d7;">aop</span>:<span style="color: #bc6ec5; font-weight: bold;">pointcut</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"getNameCalls"</span> <span style="color: #7590db;">expression</span>=<span style="color: #2d9574;">"execution(* *..ITestBean.getName(..))"</span>/&gt;
</pre>
</div>

<p>
增强器 <code>&lt;advisor/&gt;</code> 标签的定义
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #4f97d7;">aop</span>:<span style="color: #bc6ec5; font-weight: bold;">advisor</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"getAgeAdvisor"</span>
    <span style="color: #7590db;">pointcut</span>=<span style="color: #2d9574;">"execution(* *..ITestBean.getAge(..))"</span>
    <span style="color: #7590db;">advice-ref</span>=<span style="color: #2d9574;">"getAgeCounter"</span>/&gt;

&lt;<span style="color: #4f97d7;">aop</span>:<span style="color: #bc6ec5; font-weight: bold;">advisor</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"getNameAdvisor"</span>
    <span style="color: #7590db;">pointcut-ref</span>=<span style="color: #2d9574;">"getNameCalls"</span>
    <span style="color: #7590db;">advice-ref</span>=<span style="color: #2d9574;">"getNameCounter"</span>/&gt;
</pre>
</div>

<p>
所有的解析器需要实现 <code>BeanDefinitionParser</code> 接口，入口函数为 <code>parse(...)</code> 方
法，而对 AspectJ 的解析器实现的源码如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">AspectJAutoProxyBeanDefinitionParser</span> <span style="color: #4f97d7; font-weight: bold;">implements</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinitionParser</span> <span style="color: #8d5649;">{</span>

    <span style="color: #a45bad;">@Override</span>
    <span style="color: #a45bad;">@Nullable</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #bc6ec5; font-weight: bold;">parse</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">element</span>, <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>parserContext, element<span style="color: #9564bf;">)</span>;
        extendBeanDefinition<span style="color: #9564bf;">(</span>element, parserContext<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">extendBeanDefinition</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">element</span>, <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDef</span> =
                parserContext.getRegistry<span style="color: #9564bf;">()</span>.getBeanDefinition<span style="color: #9564bf;">(</span><span style="color: #a45bad;">AopConfigUtils</span>.AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>element.hasChildNodes<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            addIncludePatterns<span style="color: #24a222;">(</span>element, parserContext, beanDef<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">addIncludePatterns</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">element</span>, <span style="color: #ce537a; font-weight: bold;">ParserContext</span> <span style="color: #7590db;">parserContext</span>, <span style="color: #ce537a; font-weight: bold;">BeanDefinition</span> <span style="color: #7590db;">beanDef</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">ManagedList</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">TypedStringValue</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">includePatterns</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ManagedList</span><span style="color: #9564bf;">&lt;&gt;()</span>;
        <span style="color: #ce537a; font-weight: bold;">NodeList</span> <span style="color: #7590db;">childNodes</span> = element.getChildNodes<span style="color: #9564bf;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #9564bf;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = 0; i &lt; childNodes.<span style="color: #ce537a; font-weight: bold;">getLength</span><span style="color: #24a222;">()</span>; i++<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">Node</span> <span style="color: #7590db;">node</span> = childNodes.item<span style="color: #24a222;">(</span>i<span style="color: #24a222;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>node <span style="color: #4f97d7; font-weight: bold;">instanceof</span> Element<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">Element</span> <span style="color: #7590db;">includeElement</span> = <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">Element</span><span style="color: #ff7f00;">)</span> node;
                <span style="color: #ce537a; font-weight: bold;">TypedStringValue</span> <span style="color: #7590db;">valueHolder</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">TypedStringValue</span><span style="color: #ff7f00;">(</span>includeElement.getAttribute<span style="color: #1776b6;">(</span><span style="color: #2d9574;">"name"</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                valueHolder.setSource<span style="color: #ff7f00;">(</span>parserContext.extractSource<span style="color: #1776b6;">(</span>includeElement<span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                includePatterns.add<span style="color: #ff7f00;">(</span>valueHolder<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span><span style="color: #a45bad;">!</span>includePatterns.isEmpty<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            includePatterns.setSource<span style="color: #24a222;">(</span>parserContext.extractSource<span style="color: #ff7f00;">(</span>element<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
            beanDef.getPropertyValues<span style="color: #24a222;">()</span>.add<span style="color: #24a222;">(</span><span style="color: #2d9574;">"includePatterns"</span>, includePatterns<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf3bf51e" class="outline-3">
<h3 id="orgf3bf51e"><span class="section-number-3">5.3</span> 创建 AOP 代理</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-org16b96d8" class="outline-4">
<h4 id="org16b96d8"><span class="section-number-4">5.3.1</span> 创建 AOP 代理</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
创建代理类的调用栈如下，最终通过 <code>createAopProxy</code> 方法创建 JDK 动态代理或
cglib 动态代理
</p>
<div class="org-src-container">
<pre class="src src-text">createAopProxy:51, DefaultAopProxyFactory (org.springframework.aop.framework)
createAopProxy:105, ProxyCreatorSupport (org.springframework.aop.framework)
getProxy:110, ProxyFactory (org.springframework.aop.framework)
createProxy:471, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
wrapIfNecessary:350, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
postProcessAfterInitialization:299, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
applyBeanPostProcessorsAfterInitialization:431, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
initializeBean:1800, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:595, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1625082366 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
preInstantiateSingletons:882, DefaultListableBeanFactory (org.springframework.beans.factory.support)
finishBeanFactoryInitialization:878, AbstractApplicationContext (org.springframework.context.support)
refresh:550, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:9, MyApp07 (io.github.jeanhwea.app07_aop)
</pre>
</div>

<p>
创建 AOP 代理嵌套了好几层，最终调用 <code>DefaultAopProxyFactory</code> 的
<code>createAopProxy(...)</code> 方法的实现，这里可以
</p>
<ol class="org-ol">
<li>如果目标对象实现了接口，默认采用 JDK 动态代理实现 AOP</li>
<li>如果目标对象实现了接口，可以强制使用 cglib 实现 AOP</li>
<li>如果目标对象没有实现了接口，必须采用 cglib 实现 AOP，Spring 会自动在 JDK
动态代理和 cglib 中切换</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@SuppressWarnings</span><span style="color: #8d5649;">(</span><span style="color: #2d9574;">"serial"</span><span style="color: #8d5649;">)</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">DefaultAopProxyFactory</span> <span style="color: #4f97d7; font-weight: bold;">implements</span> <span style="color: #ce537a; font-weight: bold;">AopProxyFactory</span>, <span style="color: #ce537a; font-weight: bold;">Serializable</span> <span style="color: #8d5649;">{</span>

    <span style="color: #a45bad;">@Override</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">AopProxy</span> <span style="color: #bc6ec5; font-weight: bold;">createAopProxy</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">AdvisedSupport</span> <span style="color: #7590db;">config</span><span style="color: #d8241f;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">AopConfigException</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>config.isOptimize<span style="color: #24a222;">()</span> || config.isProxyTargetClass<span style="color: #24a222;">()</span> || hasNoUserSuppliedProxyInterfaces<span style="color: #24a222;">(</span>config<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #24a222;">&lt;</span>?<span style="color: #24a222;">&gt;</span> <span style="color: #7590db;">targetClass</span> = config.getTargetClass<span style="color: #24a222;">()</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>targetClass == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">AopConfigException</span><span style="color: #ff7f00;">(</span><span style="color: #2d9574;">"TargetSource cannot determine target class: "</span> +
                        <span style="color: #2d9574;">"Either an interface or a target is required for proxy creation."</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>targetClass.isInterface<span style="color: #ff7f00;">()</span> || Proxy.isProxyClass<span style="color: #ff7f00;">(</span>targetClass<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">JdkDynamicAopProxy</span><span style="color: #ff7f00;">(</span>config<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ObjenesisCglibAopProxy</span><span style="color: #24a222;">(</span>config<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">JdkDynamicAopProxy</span><span style="color: #24a222;">(</span>config<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;">     * Determine whether the supplied </span><span style="color: #a45bad;">{@link AdvisedSupport}</span><span style="color: #9f8766;"> has only the</span>
<span style="color: #9f8766;">     * </span><span style="color: #a45bad;">{@link org.springframework.aop.SpringProxy}</span><span style="color: #9f8766;"> interface specified</span>
<span style="color: #9f8766;">     * (or no proxy interfaces specified at all).</span>
<span style="color: #9f8766;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">hasNoUserSuppliedProxyInterfaces</span><span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">AdvisedSupport</span> <span style="color: #7590db;">config</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;[]</span> <span style="color: #7590db;">ifcs</span> = config.getProxiedInterfaces<span style="color: #9564bf;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #9564bf;">(</span>ifcs.length == 0 || <span style="color: #24a222;">(</span>ifcs.length == 1 &amp;&amp; SpringProxy.<span style="color: #4f97d7; font-weight: bold;">class</span>.isAssignableFrom<span style="color: #ff7f00;">(</span>ifcs<span style="color: #1776b6;">[</span>0<span style="color: #1776b6;">]</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>postProcessAfterInitialization(...)</code> 方法中调用了 <code>wrapIfNecessary(...)</code> 方
法获取包裹 Bean 对象，该方法有以下作用
</p>
<ol class="org-ol">
<li>前置判断是否需要创建增强器</li>
<li>如果存在增强方法
<ul class="org-ul">
<li><code>getAdvicesAndAdvisorsForBean(...)</code> 获取拦截器，如果有拦截器说明该方法
需要增强</li>
</ul></li>
<li>调用 <code>createProxy(...)</code> 方法创建代理类，并返回代理对象</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Wrap the given bean if necessary, i.e. if it is eligible for being proxied.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> bean the raw bean instance</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> cacheKey the cache key for metadata access</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> a proxy wrapping the bean, or the raw bean instance as-is</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">wrapIfNecessary</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">bean</span>, <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>, <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">cacheKey</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> &amp;&amp; <span style="color: #4f97d7; font-weight: bold;">this</span>.targetSourcedBeans.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">Boolean</span>.FALSE.equals<span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.advisedBeans.get<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>isInfrastructureClass<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> || shouldSkip<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span>, beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.advisedBeans.put<span style="color: #9564bf;">(</span>cacheKey, <span style="color: #a45bad;">Boolean</span>.FALSE<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Create proxy if we have advice.</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">specificInterceptors</span> = getAdvicesAndAdvisorsForBean<span style="color: #d8241f;">(</span>bean.getClass<span style="color: #9564bf;">()</span>, beanName, <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>specificInterceptors != DO_NOT_PROXY<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.advisedBeans.put<span style="color: #9564bf;">(</span>cacheKey, <span style="color: #a45bad;">Boolean</span>.TRUE<span style="color: #9564bf;">)</span>;
        <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">proxy</span> = createProxy<span style="color: #9564bf;">(</span>
                bean.getClass<span style="color: #24a222;">()</span>, beanName, specificInterceptors, <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">SingletonTargetSource</span><span style="color: #24a222;">(</span>bean<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">this</span>.proxyTypes.put<span style="color: #9564bf;">(</span>cacheKey, proxy.getClass<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> proxy;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">this</span>.advisedBeans.put<span style="color: #d8241f;">(</span>cacheKey, <span style="color: #a45bad;">Boolean</span>.FALSE<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>


<p>
<code>createProxy(...)</code> 方法逻辑如下
</p>
<ol class="org-ol">
<li>获取增强方法或者增强器</li>
<li>根据获取的增强进行代理</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Create an AOP proxy for the given bean.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanClass the class of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> beanName the name of the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> specificInterceptors the set of interceptors that is</span>
<span style="color: #9f8766;"> * specific to this bean (may be empty, but not null)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> targetSource the TargetSource for the proxy,</span>
<span style="color: #9f8766;"> * already pre-configured to access the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the AOP proxy for the bean</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #buildAdvisors</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #bc6ec5; font-weight: bold;">createProxy</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">beanClass</span>, <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span>,
        <span style="color: #a45bad;">@Nullable</span> <span style="color: #ce537a; font-weight: bold;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">specificInterceptors</span>, <span style="color: #ce537a; font-weight: bold;">TargetSource</span> <span style="color: #7590db;">targetSource</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory <span style="color: #4f97d7; font-weight: bold;">instanceof</span> ConfigurableListableBeanFactory<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AutoProxyUtils.exposeTargetClass<span style="color: #9564bf;">(</span><span style="color: #24a222;">(</span><span style="color: #ce537a; font-weight: bold;">ConfigurableListableBeanFactory</span><span style="color: #24a222;">)</span> <span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory, beanName, beanClass<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">ProxyFactory</span> <span style="color: #7590db;">proxyFactory</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ProxyFactory</span><span style="color: #d8241f;">()</span>;
    proxyFactory.copyFrom<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #d8241f;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>proxyFactory.isProxyTargetClass<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>shouldProxyTargetClass<span style="color: #24a222;">(</span>beanClass, beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            proxyFactory.setProxyTargetClass<span style="color: #24a222;">(</span><span style="color: #a45bad;">true</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            evaluateProxyInterfaces<span style="color: #24a222;">(</span>beanClass, proxyFactory<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #d8241f;">[]</span> <span style="color: #7590db;">advisors</span> = buildAdvisors<span style="color: #d8241f;">(</span>beanName, specificInterceptors<span style="color: #d8241f;">)</span>;
    proxyFactory.addAdvisors<span style="color: #d8241f;">(</span>advisors<span style="color: #d8241f;">)</span>;
    proxyFactory.setTargetSource<span style="color: #d8241f;">(</span>targetSource<span style="color: #d8241f;">)</span>;
    customizeProxyFactory<span style="color: #d8241f;">(</span>proxyFactory<span style="color: #d8241f;">)</span>;

    proxyFactory.setFrozen<span style="color: #d8241f;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.freezeProxy<span style="color: #d8241f;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>advisorsPreFiltered<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        proxyFactory.setPreFiltered<span style="color: #9564bf;">(</span><span style="color: #a45bad;">true</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> proxyFactory.getProxy<span style="color: #d8241f;">(</span>getProxyClassLoader<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e2de85" class="outline-4">
<h4 id="org9e2de85"><span class="section-number-4">5.3.2</span> 获取增强器 Advisor</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
获取增强器的最终调用方法为 <code>buildAspectJAdvisors(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-text">buildAspectJAdvisors:84, BeanFactoryAspectJAdvisorsBuilder (org.springframework.aop.aspectj.annotation)
findCandidateAdvisors:95, AnnotationAwareAspectJAutoProxyCreator (org.springframework.aop.aspectj.annotation)
shouldSkip:101, AspectJAwareAdvisorAutoProxyCreator (org.springframework.aop.aspectj.autoproxy)
wrapIfNecessary:341, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
postProcessAfterInitialization:299, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
applyBeanPostProcessorsAfterInitialization:431, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
initializeBean:1800, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:595, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 343856911 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
preInstantiateSingletons:882, DefaultListableBeanFactory (org.springframework.beans.factory.support)
finishBeanFactoryInitialization:878, AbstractApplicationContext (org.springframework.context.support)
refresh:550, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:9, MyApp07 (io.github.jeanhwea.app07_aop)
</pre>
</div>

<p>
该方法的实现流程如下：
</p>
<ol class="org-ol">
<li>获取所有的 beanName, 在这一步骤中将 beanFactory 中注册的 Bean 都提取出来</li>
<li>遍历所以 beanName, 并找出声明  AspectJ 注解的类</li>
<li>对标记为 AspectJ 注解的类进行增强器提取
<ul class="org-ul">
<li><code>this.advisorFactory.getAdvisors(factory)</code></li>
</ul></li>
<li>将提取的结果加入缓存
<ul class="org-ul">
<li><code>this.advisorsCache.put(...)</code></li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * Look for AspectJ-annotated aspect beans in the current bean factory,</span>
<span style="color: #9f8766;"> * and return to a list of Spring AOP Advisors representing them.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">&lt;p&gt;</span><span style="color: #9f8766;">Creates a Spring Advisor for each AspectJ advice method.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the list of </span><span style="color: #a45bad;">{@link org.springframework.aop.Advisor}</span><span style="color: #9f8766;"> beans</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@see</span><span style="color: #9f8766;"> #isEligibleBean</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #8d5649;">&gt;</span> <span style="color: #bc6ec5; font-weight: bold;">buildAspectJAdvisors</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">aspectNames</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.aspectBeanNames;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>aspectNames == <span style="color: #a45bad;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            aspectNames = <span style="color: #4f97d7; font-weight: bold;">this</span>.aspectBeanNames;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #24a222;">(</span>aspectNames == <span style="color: #a45bad;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #7590db;">advisors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;()</span>;
                aspectNames = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;()</span>;
                <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #ff7f00;">[]</span> <span style="color: #7590db;">beanNames</span> = BeanFactoryUtils.beanNamesForTypeIncludingAncestors<span style="color: #ff7f00;">(</span>
                        <span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory, Object.<span style="color: #4f97d7; font-weight: bold;">class</span>, <span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">false</span><span style="color: #ff7f00;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">beanName</span> : beanNames<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span><span style="color: #a45bad;">!</span>isEligibleBean<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">continue</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">We must be careful not to instantiate beans eagerly as in this case they</span>
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">would be cached by the Spring container but would not have been weaved.</span>
                    <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #1776b6;">&lt;</span>?<span style="color: #1776b6;">&gt;</span> <span style="color: #7590db;">beanType</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory.getType<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span>beanType == <span style="color: #a45bad;">null</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">continue</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #1776b6;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.advisorFactory.isAspect<span style="color: #00bed1;">(</span>beanType<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        aspectNames.add<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span>;
                        <span style="color: #ce537a; font-weight: bold;">AspectMetadata</span> <span style="color: #7590db;">amd</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">AspectMetadata</span><span style="color: #00bed1;">(</span>beanType, beanName<span style="color: #00bed1;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #00bed1;">(</span>amd.getAjType<span style="color: #bcbf00;">()</span>.getPerClause<span style="color: #bcbf00;">()</span>.getKind<span style="color: #bcbf00;">()</span> == <span style="color: #a45bad;">PerClauseKind</span>.SINGLETON<span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #ce537a; font-weight: bold;">MetadataAwareAspectInstanceFactory</span> <span style="color: #7590db;">factory</span> =
                                    <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">BeanFactoryAspectInstanceFactory</span><span style="color: #bcbf00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory, beanName<span style="color: #bcbf00;">)</span>;
                            <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #bcbf00;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #bcbf00;">&gt;</span> <span style="color: #7590db;">classAdvisors</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.advisorFactory.getAdvisors<span style="color: #bcbf00;">(</span>factory<span style="color: #bcbf00;">)</span>;
                            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bcbf00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory.isSingleton<span style="color: #e574c3;">(</span>beanName<span style="color: #e574c3;">)</span><span style="color: #bcbf00;">)</span> <span style="color: #bcbf00;">{</span>
                                <span style="color: #4f97d7; font-weight: bold;">this</span>.advisorsCache.put<span style="color: #e574c3;">(</span>beanName, classAdvisors<span style="color: #e574c3;">)</span>;
                            <span style="color: #bcbf00;">}</span>
                            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bcbf00;">{</span>
                                <span style="color: #4f97d7; font-weight: bold;">this</span>.aspectFactoryCache.put<span style="color: #e574c3;">(</span>beanName, factory<span style="color: #e574c3;">)</span>;
                            <span style="color: #bcbf00;">}</span>
                            advisors.addAll<span style="color: #bcbf00;">(</span>classAdvisors<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Per target or per this.</span>
                            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bcbf00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory.isSingleton<span style="color: #e574c3;">(</span>beanName<span style="color: #e574c3;">)</span><span style="color: #bcbf00;">)</span> <span style="color: #bcbf00;">{</span>
                                <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">IllegalArgumentException</span><span style="color: #e574c3;">(</span><span style="color: #2d9574;">"Bean with name '"</span> + beanName +
                                        <span style="color: #2d9574;">"' is a singleton, but aspect instantiation model is not singleton"</span><span style="color: #e574c3;">)</span>;
                            <span style="color: #bcbf00;">}</span>
                            <span style="color: #ce537a; font-weight: bold;">MetadataAwareAspectInstanceFactory</span> <span style="color: #7590db;">factory</span> =
                                    <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">PrototypeAspectInstanceFactory</span><span style="color: #bcbf00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.beanFactory, beanName<span style="color: #bcbf00;">)</span>;
                            <span style="color: #4f97d7; font-weight: bold;">this</span>.aspectFactoryCache.put<span style="color: #bcbf00;">(</span>beanName, factory<span style="color: #bcbf00;">)</span>;
                            advisors.addAll<span style="color: #bcbf00;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.advisorFactory.getAdvisors<span style="color: #e574c3;">(</span>factory<span style="color: #e574c3;">)</span><span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">this</span>.aspectBeanNames = aspectNames;
                <span style="color: #4f97d7; font-weight: bold;">return</span> advisors;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span>aspectNames.isEmpty<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> Collections.emptyList<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">advisors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">aspectName</span> : aspectNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #7590db;">cachedAdvisors</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.advisorsCache.get<span style="color: #9564bf;">(</span>aspectName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>cachedAdvisors != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            advisors.addAll<span style="color: #24a222;">(</span>cachedAdvisors<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #ce537a; font-weight: bold;">MetadataAwareAspectInstanceFactory</span> <span style="color: #7590db;">factory</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.aspectFactoryCache.get<span style="color: #24a222;">(</span>aspectName<span style="color: #24a222;">)</span>;
            advisors.addAll<span style="color: #24a222;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>.advisorFactory.getAdvisors<span style="color: #ff7f00;">(</span>factory<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> advisors;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>getAdvisors(...)</code> 方法获取 Advisor
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Override</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #8d5649;">&gt;</span> <span style="color: #bc6ec5; font-weight: bold;">getAdvisors</span><span style="color: #8d5649;">(</span><span style="color: #ce537a; font-weight: bold;">MetadataAwareAspectInstanceFactory</span> <span style="color: #7590db;">aspectInstanceFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">aspectClass</span> = aspectInstanceFactory.getAspectMetadata<span style="color: #d8241f;">()</span>.getAspectClass<span style="color: #d8241f;">()</span>;
    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">aspectName</span> = aspectInstanceFactory.getAspectMetadata<span style="color: #d8241f;">()</span>.getAspectName<span style="color: #d8241f;">()</span>;
    validate<span style="color: #d8241f;">(</span>aspectClass<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">so that it will only instantiate once.</span>
    <span style="color: #ce537a; font-weight: bold;">MetadataAwareAspectInstanceFactory</span> <span style="color: #7590db;">lazySingletonAspectInstanceFactory</span> =
            <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">LazySingletonAspectInstanceFactoryDecorator</span><span style="color: #d8241f;">(</span>aspectInstanceFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #ce537a; font-weight: bold;">Advisor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #7590db;">advisors</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Method</span> <span style="color: #7590db;">method</span> : getAdvisorMethods<span style="color: #9564bf;">(</span>aspectClass<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Advisor</span> <span style="color: #7590db;">advisor</span> = getAdvisor<span style="color: #9564bf;">(</span>method, lazySingletonAspectInstanceFactory, advisors.size<span style="color: #24a222;">()</span>, aspectName<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>advisor != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            advisors.add<span style="color: #24a222;">(</span>advisor<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">If it's a per target aspect, emit the dummy instantiating aspect.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #d8241f;">(</span><span style="color: #a45bad;">!</span>advisors.isEmpty<span style="color: #9564bf;">()</span> &amp;&amp; lazySingletonAspectInstanceFactory.getAspectMetadata<span style="color: #9564bf;">()</span>.isLazilyInstantiated<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Advisor</span> <span style="color: #7590db;">instantiationAdvisor</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">SyntheticInstantiationAdvisor</span><span style="color: #9564bf;">(</span>lazySingletonAspectInstanceFactory<span style="color: #9564bf;">)</span>;
        advisors.add<span style="color: #9564bf;">(</span>0, instantiationAdvisor<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Find introduction fields.</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #d8241f;">(</span><span style="color: #ce537a; font-weight: bold;">Field</span> <span style="color: #7590db;">field</span> : aspectClass.getDeclaredFields<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Advisor</span> <span style="color: #7590db;">advisor</span> = getDeclareParentsAdvisor<span style="color: #9564bf;">(</span>field<span style="color: #9564bf;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #9564bf;">(</span>advisor != <span style="color: #a45bad;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            advisors.add<span style="color: #24a222;">(</span>advisor<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> advisors;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcd0fbb4" class="outline-2">
<h2 id="orgcd0fbb4"><span class="section-number-2">6</span> SpringBoot 自动装配</h2>
</div>
<div id="outline-container-org0c7e01e" class="outline-2">
<h2 id="org0c7e01e"><span class="section-number-2">7</span> 参考链接</h2>
<div class="outline-text-2" id="text-7">
<ol class="org-ol">
<li><a href="https://github.com/spring-projects/spring-framework">Spring Framework on Github</a></li>
<li><a href="https://spring.io/projects/spring-framework">Spring Framework Documentation</a></li>
<li><a href="https://doocs.gitee.io/source-code-hunter/#/">source-code-hounter</a> 互联网公司常用框架源码赏析</li>
<li><a href="https://huifer.github.io/spring-analysis/">Spring Analysis</a> Spring 框架分析</li>
<li><a href="https://github.com/fuzhengwei/small-spring">Small Spring</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-07-30 Fri 09:17. Created by Jinghui Hu at 2021-07-14 Wed 12:16.</p>
</div>
</body>
</html>
