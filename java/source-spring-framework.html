<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-15 Thu 12:18 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring Framework v5.2.5.RELEASE</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring Framework v5.2.5.RELEASE</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org364bbe7">1. IoC</a>
<ul>
<li><a href="#org2dcc3b7">1.1. IoC 核心接口和类</a></li>
<li><a href="#org8e3401e">1.2. IoC 资源读取及注册</a>
<ul>
<li><a href="#org0abc6a2">1.2.1. XML 文档验证</a></li>
<li><a href="#org3595bec">1.2.2. XML 文档读取</a></li>
<li><a href="#org8cb4396">1.2.3. XML 标签解析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4b6f293">2. BeanFactory</a>
<ul>
<li><a href="#orgdf64f19">2.1. DefaultListableBeanFactory</a></li>
<li><a href="#orgd2d5160">2.2. XmlBeanDefinitionReader</a></li>
</ul>
</li>
<li><a href="#org1e696db">3. ApplicationContext</a></li>
<li><a href="#org64f2167">4. AOP</a></li>
<li><a href="#org9382cd3">5. Spring 核心类梳理</a></li>
<li><a href="#org879290f">6. SpringBoot 自动装配</a></li>
<li><a href="#orga685936">7. 参考链接</a></li>
</ul>
</div>
</div>


<div id="outline-container-org364bbe7" class="outline-2">
<h2 id="org364bbe7"><span class="section-number-2">1</span> IoC</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org2dcc3b7" class="outline-3">
<h3 id="org2dcc3b7"><span class="section-number-3">1.1</span> IoC 核心接口和类</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Spring 的 IoC 容器对象一般继承自 <code>ApplicationContext</code> 接口，常见的对象类如下
</p>

<p>
<code>ClassPathXmlApplicationContext</code>: 读取 ClassPath 中 XML 配置文件的 Bean 定义
的容器
</p>


<div id="org5214789" class="figure">
<p><img src="../static/image/2021/07/ClassPathXmlApplicationContext.png" alt="ClassPathXmlApplicationContext.png" />
</p>
</div>

<p>
<code>AnnotationConfigApplicationContext</code>: 读取注解 Bean 定义的容器
</p>


<div id="org905c3f2" class="figure">
<p><img src="../static/image/2021/07/AnnotationConfigApplicationContext.png" alt="AnnotationConfigApplicationContext.png" />
</p>
</div>

<p>
常见的类简单可以分成以下几类
</p>
<ol class="org-ol">
<li>资源处理
<ul class="org-ul">
<li><code>Resource</code> Spring 中关于资源的定义</li>
<li><code>ResourceLoader</code> 提供资源加载方法</li>
<li><code>BeanDefinitionReader</code> 读取接口主要用来读取信息</li>
</ul></li>
<li>注册形式，在 Spring 中关于注册的几个核心
<ul class="org-ul">
<li><code>AliasRegistry</code> 别名注册</li>
<li><code>BeanDefinitionRegistry</code> Bean 定义注册</li>
<li><code>SingletonBeanRegistry</code> 单例 Bean 注册
<ul class="org-ul">
<li><code>DefaultSingletonBeanRegistry</code></li>
</ul></li>
</ul></li>
<li>生命周期，可以分成容器生命周期和 Bean 生命周期两个小类
<ul class="org-ul">
<li><code>Lifecycle</code> 容器生命周期的核心接口</li>
<li><code>InitializingBean</code>, <code>DisposableBean</code> 等 Bean 的生命周期接口</li>
</ul></li>
<li>Bean 拓展
<ul class="org-ul">
<li><code>BeanPostProcessor</code></li>
<li><code>Aware</code> 系列接口</li>
</ul></li>
<li>上下文的接口:
<ul class="org-ul">
<li><code>ApplicationContext</code> 作为主导接口
<ul class="org-ul">
<li><code>AbstractApplicationContext</code></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org8e3401e" class="outline-3">
<h3 id="org8e3401e"><span class="section-number-3">1.2</span> IoC 资源读取及注册</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0abc6a2" class="outline-4">
<h4 id="org0abc6a2"><span class="section-number-4">1.2.1</span> XML 文档验证</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
XML 文档验证常见有如下两种方式
</p>
<ul class="org-ul">
<li>DTD (Document Type Definition) 验证</li>
<li>XSD (XML Schema Definition) 验证</li>
</ul>
<p>
XML 文档读取实现位于 <code>XmlBeanDefinitionReader</code> 类中实现，该类中的实现了对上
述两种格式 XML 文档的读取
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that the validation should be disabled.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_NONE</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_NONE;

<span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that the validation mode should be detected automatically.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_AUTO</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_AUTO;

<span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that DTD validation should be used.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_DTD</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_DTD;

<span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that XSD validation should be used.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_XSD</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_XSD;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3595bec" class="outline-4">
<h4 id="org3595bec"><span class="section-number-4">1.2.2</span> XML 文档读取</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
读取 XML 文件核心方法 <code>loadBeanDefinitions(...)</code> 实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Load bean definitions from the specified XML file.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> encodedResource the resource descriptor for the XML file,</span>
<span style="color: #d33682;"> * allowing to specify an encoding to use for parsing the file</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the number of bean definitions found</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException in case of loading or parsing errors</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">loadBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">EncodedResource</span> <span style="color: #6c71c4;">encodedResource</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>encodedResource, <span style="color: #2aa198;">"EncodedResource must not be null"</span><span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #2aa198;">"Loading XML bean definitions from "</span> + encodedResource<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">EncodedResource</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">currentResources</span> = <span style="color: #859900;">this</span>.resourcesCurrentlyBeingLoaded.get<span style="color: #d8241f;">()</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>currentResources == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        currentResources = <span style="color: #859900;">new</span> <span style="color: #268bd2;">HashSet</span><span style="color: #9564bf;">&lt;&gt;(</span>4<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">this</span>.resourcesCurrentlyBeingLoaded.set<span style="color: #9564bf;">(</span>currentResources<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span>currentResources.add<span style="color: #9564bf;">(</span>encodedResource<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>
                <span style="color: #2aa198;">"Detected cyclic loading of "</span> + encodedResource + <span style="color: #2aa198;">" - check your import definitions!"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">InputStream</span> <span style="color: #6c71c4;">inputStream</span> = encodedResource.getResource<span style="color: #9564bf;">()</span>.getInputStream<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">InputSource</span> <span style="color: #6c71c4;">inputSource</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">InputSource</span><span style="color: #9564bf;">(</span>inputStream<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>encodedResource.getEncoding<span style="color: #24a222;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            inputSource.setEncoding<span style="color: #24a222;">(</span>encodedResource.getEncoding<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> doLoadBeanDefinitions<span style="color: #9564bf;">(</span>inputSource, encodedResource.getResource<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>
                <span style="color: #2aa198;">"IOException parsing XML document from "</span> + encodedResource.getResource<span style="color: #24a222;">()</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">finally</span> <span style="color: #d8241f;">{</span>
        currentResources.remove<span style="color: #9564bf;">(</span>encodedResource<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>currentResources.isEmpty<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">this</span>.resourcesCurrentlyBeingLoaded.remove<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
其中的 <code>doLoadBeanDefinitions(...)</code> 方法具体实现加载 <code>BeanDefinition</code>
</p>
<ul class="org-ul">
<li><code>doLoadDocument()</code> 加载文档，这部分将 XML 作为资源读取</li>
<li><code>registerBeanDefinitions()</code> 注册 <code>BeanDefinition</code>
<ul class="org-ul">
<li>其中 <code>DefaultBeanDefinitionDocumentReader</code> 中的
<code>registerBeanDefinitions()</code> 方法实现了注册 <code>BeanDefinition</code></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Actually load bean definitions from the specified XML file.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> inputSource the SAX InputSource to read from</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> resource the resource descriptor for the XML file</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the number of bean definitions found</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException in case of loading or parsing errors</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #doLoadDocument</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinitions</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">doLoadBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">InputSource</span> <span style="color: #6c71c4;">inputSource</span>, <span style="color: #268bd2;">Resource</span> <span style="color: #6c71c4;">resource</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Document</span> <span style="color: #6c71c4;">doc</span> = doLoadDocument<span style="color: #9564bf;">(</span>inputSource, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">count</span> = registerBeanDefinitions<span style="color: #9564bf;">(</span>doc, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isDebugEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.debug<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Loaded "</span> + count + <span style="color: #2aa198;">" bean definitions from "</span> + resource<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> count;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXParseException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Line "</span> + ex.getLineNumber<span style="color: #24a222;">()</span> + <span style="color: #2aa198;">" in XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">ParserConfigurationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Parser configuration exception parsing XML from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"IOException parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Unexpected exception parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Document</span> <span style="color: #6c71c4;">doc</span>, <span style="color: #268bd2;">XmlReaderContext</span> <span style="color: #6c71c4;">readerContext</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">this</span>.readerContext = readerContext;
    doRegisterBeanDefinitions<span style="color: #d8241f;">(</span>doc.getDocumentElement<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>DefaultBeanDefinitionDocumentReader</code> 实现
</p>
<ul class="org-ul">
<li><p>
<code>protected void doRegisterBeanDefinitions(Element root)</code> 读取 XML 的
<code>&lt;bean&gt;</code> 标签中的信息
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #859900;">xml</span> <span style="color: #d33682;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #b58900;">beans</span> <span style="color: #6c71c4;">xmlns</span>=<span style="color: #2aa198;">"http://www.springframework.org/schema/beans"</span>
       <span style="color: #6c71c4;">xmlns</span>:<span style="color: #6c71c4;">xsi</span>=<span style="color: #2aa198;">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span style="color: #6c71c4;">xsi</span>:<span style="color: #6c71c4;">schemaLocation</span>=<span style="color: #2aa198;">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;

    &lt;<span style="color: #b58900;">bean</span> <span style="color: #6c71c4;">id</span>=<span style="color: #2aa198;">"author"</span> <span style="color: #6c71c4;">class</span>=<span style="color: #2aa198;">"io.github.jeanhwea.bean.Author"</span>&gt;
        &lt;<span style="color: #b58900;">property</span> <span style="color: #6c71c4;">name</span>=<span style="color: #2aa198;">"name"</span> <span style="color: #6c71c4;">value</span>=<span style="color: #2aa198;">"Martin Flower"</span>/&gt;
    &lt;/<span style="color: #b58900;">bean</span>&gt;

&lt;/<span style="color: #b58900;">beans</span>&gt;
</pre>
</div></li>
</ul>

<p>
至此 XML 格式的 <code>BeanDefinition</code> 注册完成
</p>
</div>
</div>

<div id="outline-container-org8cb4396" class="outline-4">
<h4 id="org8cb4396"><span class="section-number-4">1.2.3</span> XML 标签解析</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
标签解析的细节比较多，这里跳过
</p>
<ol class="org-ol">
<li>beans 标签的解析
<ul class="org-ul">
<li>id</li>
<li>name</li>
<li>class</li>
<li>parent</li>
<li>scope</li>
<li>abstract</li>
<li>lazy-init</li>
<li>autowire</li>
<li>depends-on</li>
<li>autowire-candidate</li>
<li>init-method</li>
<li>destroy-method</li>
<li>factory-method</li>
<li>factory-bean</li>
</ul></li>
<li>import 标签的解析</li>
<li>alias 标签的解析</li>
</ol>
</div>
</div>
</div>
</div>

<div id="outline-container-org4b6f293" class="outline-2">
<h2 id="org4b6f293"><span class="section-number-2">2</span> BeanFactory</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgdf64f19" class="outline-3">
<h3 id="orgdf64f19"><span class="section-number-3">2.1</span> DefaultListableBeanFactory</h3>
<div class="outline-text-3" id="text-2-1">
<p>
XmlBeanFactory 继承自 DefaultListableBeanFactory, 并且
DefaultListableBeanFactory 实现了大部分的 Spring 注册及加载的实现
</p>


<div id="org1032564" class="figure">
<p><img src="../static/image/2021/07/DefaultListableBeanFactory.png" alt="DefaultListableBeanFactory.png" />
</p>
</div>

<p>
该类定了 BeanDefinition 类的 Map
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Map of bean definition objects, keyed by bean name. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">BeanDefinition</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton and non-singleton bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">allBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton-only bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** List of bean definition names, in registration order. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">volatile</span> <span style="color: #268bd2;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionNames</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd2d5160" class="outline-3">
<h3 id="orgd2d5160"><span class="section-number-3">2.2</span> XmlBeanDefinitionReader</h3>
<div class="outline-text-3" id="text-2-2">
<p>
实际实现读取 BeanDefinition 的方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Actually load bean definitions from the specified XML file.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> inputSource the SAX InputSource to read from</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> resource the resource descriptor for the XML file</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the number of bean definitions found</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException in case of loading or parsing errors</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #doLoadDocument</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinitions</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">doLoadBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">InputSource</span> <span style="color: #6c71c4;">inputSource</span>, <span style="color: #268bd2;">Resource</span> <span style="color: #6c71c4;">resource</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Document</span> <span style="color: #6c71c4;">doc</span> = doLoadDocument<span style="color: #9564bf;">(</span>inputSource, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">count</span> = registerBeanDefinitions<span style="color: #9564bf;">(</span>doc, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isDebugEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.debug<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Loaded "</span> + count + <span style="color: #2aa198;">" bean definitions from "</span> + resource<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> count;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXParseException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Line "</span> + ex.getLineNumber<span style="color: #24a222;">()</span> + <span style="color: #2aa198;">" in XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">ParserConfigurationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Parser configuration exception parsing XML from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"IOException parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Unexpected exception parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1e696db" class="outline-2">
<h2 id="org1e696db"><span class="section-number-2">3</span> ApplicationContext</h2>
</div>

<div id="outline-container-org64f2167" class="outline-2">
<h2 id="org64f2167"><span class="section-number-2">4</span> AOP</h2>
<div class="outline-text-2" id="text-4">
<p>
使用动态代理实现
</p>
<ul class="org-ul">
<li>JDK 代理</li>
<li>cglib 代理</li>
</ul>
</div>
</div>

<div id="outline-container-org9382cd3" class="outline-2">
<h2 id="org9382cd3"><span class="section-number-2">5</span> Spring 核心类梳理</h2>
<div class="outline-text-2" id="text-5">
<ol class="org-ol">
<li>ApplicationContext
<ul class="org-ul">
<li>AbstractApplicationContext
<ul class="org-ul">
<li><code>refresh()</code> 实现 Spring Bean 加载的核心逻辑</li>
</ul></li>
</ul></li>
<li>BeanDefinition
<ul class="org-ul">
<li>AbstractBeanDefinition</li>
</ul></li>
<li>BeanDefinitionReader
<ul class="org-ul">
<li>读取 BeanDefinition 对象</li>
</ul></li>
<li>BeanFactory
<ul class="org-ul">
<li>Bean 工厂类</li>
<li>AbstractBeanFactory
<ul class="org-ul">
<li><code>doGetBean(...)</code></li>
</ul></li>
</ul></li>
<li>BeanFactoryPostProcessor
<ul class="org-ul">
<li>函数式接口 <code>@FunctionalInterface</code></li>
</ul></li>
<li>BeanPostProcessor
<ul class="org-ul">
<li>提供自定义 Bean 实例化的处理接口扩展</li>
<li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化前置处理方法</li>
</ul></li>
<li><code>postProcessAfterInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化后置处理方法</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org879290f" class="outline-2">
<h2 id="org879290f"><span class="section-number-2">6</span> SpringBoot 自动装配</h2>
</div>
<div id="outline-container-orga685936" class="outline-2">
<h2 id="orga685936"><span class="section-number-2">7</span> 参考链接</h2>
<div class="outline-text-2" id="text-7">
<ol class="org-ol">
<li><a href="https://huifer.github.io/spring-analysis/">Spring Analysis</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-07-15 Thu 12:18. Created by Jinghui Hu at 2021-07-14 Wed 12:16.</p>
</div>
</body>
</html>
