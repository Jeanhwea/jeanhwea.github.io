<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-16 Fri 22:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring Framework v5.2.5.RELEASE</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring Framework v5.2.5.RELEASE</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgec41319">1. IoC</a>
<ul>
<li><a href="#org405112d">1.1. IoC 核心接口和类</a></li>
<li><a href="#org0a16da1">1.2. IoC 资源读取及注册</a>
<ul>
<li><a href="#org44a7740">1.2.1. XML 文档验证</a></li>
<li><a href="#org4fdf41a">1.2.2. XML 文档读取</a></li>
<li><a href="#org730fbd5">1.2.3. XML 标签解析</a></li>
</ul>
</li>
<li><a href="#org19f2665">1.3. <span class="todo TODO">TODO</span> 自定义标签注册</a></li>
<li><a href="#org620c058">1.4. <span class="todo TODO">TODO</span> 别名注册</a></li>
<li><a href="#orga7d2ae4">1.5. <code>&lt;bean/&gt;</code> 标签解析</a></li>
<li><a href="#orgf96e0ed">1.6. BeanDefinition 注册</a>
<ul>
<li><a href="#orgcaf5666">1.6.1. BeanDefinition 的注册</a></li>
<li><a href="#org66bbb8d">1.6.2. DefaultListableBeanFactory</a></li>
</ul>
</li>
<li><a href="#org53c4086">1.7. Bean 的生命周期</a>
<ul>
<li><a href="#org86e92f8">1.7.1. XmlBeanDefinitionReader</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbdf721d">2. ApplicationContext</a></li>
<li><a href="#org00de8d2">3. AOP</a></li>
<li><a href="#org2a86989">4. Spring 核心类梳理</a></li>
<li><a href="#org38f5dba">5. SpringBoot 自动装配</a></li>
<li><a href="#org67424dd">6. 参考链接</a></li>
</ul>
</div>
</div>


<div id="outline-container-orgec41319" class="outline-2">
<h2 id="orgec41319"><span class="section-number-2">1</span> IoC</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org405112d" class="outline-3">
<h3 id="org405112d"><span class="section-number-3">1.1</span> IoC 核心接口和类</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Spring 的 IoC 容器对象一般继承自 <code>ApplicationContext</code> 接口，常见的对象类如下
</p>

<p>
<code>ClassPathXmlApplicationContext</code>: 读取 ClassPath 中 XML 配置文件的 Bean 定义
的容器
</p>


<div id="orgfda4b6a" class="figure">
<p><img src="../static/image/2021/07/ClassPathXmlApplicationContext.png" alt="ClassPathXmlApplicationContext.png" />
</p>
</div>

<p>
<code>AnnotationConfigApplicationContext</code>: 读取注解 Bean 定义的容器
</p>


<div id="orgd9cc6ca" class="figure">
<p><img src="../static/image/2021/07/AnnotationConfigApplicationContext.png" alt="AnnotationConfigApplicationContext.png" />
</p>
</div>

<p>
常见的类简单可以分成以下几类
</p>
<ol class="org-ol">
<li>资源处理
<ul class="org-ul">
<li><code>Resource</code> Spring 中关于资源的定义</li>
<li><code>ResourceLoader</code> 提供资源加载方法</li>
<li><code>BeanDefinitionReader</code> 读取接口主要用来读取信息</li>
</ul></li>
<li>注册形式，在 Spring 中关于注册的几个核心
<ul class="org-ul">
<li><code>AliasRegistry</code> 别名注册</li>
<li><code>BeanDefinitionRegistry</code> Bean 定义注册</li>
<li><code>SingletonBeanRegistry</code> 单例 Bean 注册
<ul class="org-ul">
<li><code>DefaultSingletonBeanRegistry</code></li>
</ul></li>
</ul></li>
<li>生命周期，可以分成容器生命周期和 Bean 生命周期两个小类
<ul class="org-ul">
<li><code>Lifecycle</code> 容器生命周期的核心接口</li>
<li><code>InitializingBean</code>, <code>DisposableBean</code> 等 Bean 的生命周期接口</li>
</ul></li>
<li>Bean 拓展
<ul class="org-ul">
<li><code>BeanPostProcessor</code></li>
<li><code>Aware</code> 系列接口</li>
</ul></li>
<li>上下文的接口:
<ul class="org-ul">
<li><code>ApplicationContext</code> 作为主导接口
<ul class="org-ul">
<li><code>AbstractApplicationContext</code></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org0a16da1" class="outline-3">
<h3 id="org0a16da1"><span class="section-number-3">1.2</span> IoC 资源读取及注册</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org44a7740" class="outline-4">
<h4 id="org44a7740"><span class="section-number-4">1.2.1</span> XML 文档验证</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
XML 文档验证常见有如下两种方式
</p>
<ul class="org-ul">
<li>DTD (Document Type Definition) 验证</li>
<li>XSD (XML Schema Definition) 验证</li>
</ul>
<p>
XML 文档读取实现位于 <code>XmlBeanDefinitionReader</code> 类中实现，该类中的实现了对上
述两种格式 XML 文档的读取
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that the validation should be disabled.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_NONE</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_NONE;

<span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that the validation mode should be detected automatically.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_AUTO</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_AUTO;

<span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that DTD validation should be used.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_DTD</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_DTD;

<span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Indicates that XSD validation should be used.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">VALIDATION_XSD</span> = <span style="color: #268bd2;">XmlValidationModeDetector</span>.VALIDATION_XSD;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fdf41a" class="outline-4">
<h4 id="org4fdf41a"><span class="section-number-4">1.2.2</span> XML 文档读取</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
读取 XML 文件核心方法 <code>loadBeanDefinitions(...)</code> 实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Load bean definitions from the specified XML file.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> encodedResource the resource descriptor for the XML file,</span>
<span style="color: #d33682;"> * allowing to specify an encoding to use for parsing the file</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the number of bean definitions found</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException in case of loading or parsing errors</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">loadBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">EncodedResource</span> <span style="color: #6c71c4;">encodedResource</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>encodedResource, <span style="color: #2aa198;">"EncodedResource must not be null"</span><span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #2aa198;">"Loading XML bean definitions from "</span> + encodedResource<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">EncodedResource</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">currentResources</span> = <span style="color: #859900;">this</span>.resourcesCurrentlyBeingLoaded.get<span style="color: #d8241f;">()</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>currentResources == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        currentResources = <span style="color: #859900;">new</span> <span style="color: #268bd2;">HashSet</span><span style="color: #9564bf;">&lt;&gt;(</span>4<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">this</span>.resourcesCurrentlyBeingLoaded.set<span style="color: #9564bf;">(</span>currentResources<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span>currentResources.add<span style="color: #9564bf;">(</span>encodedResource<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>
                <span style="color: #2aa198;">"Detected cyclic loading of "</span> + encodedResource + <span style="color: #2aa198;">" - check your import definitions!"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">InputStream</span> <span style="color: #6c71c4;">inputStream</span> = encodedResource.getResource<span style="color: #9564bf;">()</span>.getInputStream<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">InputSource</span> <span style="color: #6c71c4;">inputSource</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">InputSource</span><span style="color: #9564bf;">(</span>inputStream<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>encodedResource.getEncoding<span style="color: #24a222;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            inputSource.setEncoding<span style="color: #24a222;">(</span>encodedResource.getEncoding<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> doLoadBeanDefinitions<span style="color: #9564bf;">(</span>inputSource, encodedResource.getResource<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>
                <span style="color: #2aa198;">"IOException parsing XML document from "</span> + encodedResource.getResource<span style="color: #24a222;">()</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">finally</span> <span style="color: #d8241f;">{</span>
        currentResources.remove<span style="color: #9564bf;">(</span>encodedResource<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>currentResources.isEmpty<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">this</span>.resourcesCurrentlyBeingLoaded.remove<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
其中的 <code>doLoadBeanDefinitions(...)</code> 方法具体实现加载 <code>BeanDefinition</code>
</p>
<ul class="org-ul">
<li><code>doLoadDocument()</code> 加载文档，这部分将 XML 作为资源读取</li>
<li><code>registerBeanDefinitions()</code> 注册 <code>BeanDefinition</code>
<ul class="org-ul">
<li>其中 <code>DefaultBeanDefinitionDocumentReader</code> 中的
<code>registerBeanDefinitions()</code> 方法实现了注册 <code>BeanDefinition</code></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Actually load bean definitions from the specified XML file.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> inputSource the SAX InputSource to read from</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> resource the resource descriptor for the XML file</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the number of bean definitions found</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException in case of loading or parsing errors</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #doLoadDocument</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinitions</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">doLoadBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">InputSource</span> <span style="color: #6c71c4;">inputSource</span>, <span style="color: #268bd2;">Resource</span> <span style="color: #6c71c4;">resource</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Document</span> <span style="color: #6c71c4;">doc</span> = doLoadDocument<span style="color: #9564bf;">(</span>inputSource, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">count</span> = registerBeanDefinitions<span style="color: #9564bf;">(</span>doc, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isDebugEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.debug<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Loaded "</span> + count + <span style="color: #2aa198;">" bean definitions from "</span> + resource<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> count;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXParseException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Line "</span> + ex.getLineNumber<span style="color: #24a222;">()</span> + <span style="color: #2aa198;">" in XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">ParserConfigurationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Parser configuration exception parsing XML from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"IOException parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Unexpected exception parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Document</span> <span style="color: #6c71c4;">doc</span>, <span style="color: #268bd2;">XmlReaderContext</span> <span style="color: #6c71c4;">readerContext</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">this</span>.readerContext = readerContext;
    doRegisterBeanDefinitions<span style="color: #d8241f;">(</span>doc.getDocumentElement<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>DefaultBeanDefinitionDocumentReader</code> 实现
</p>
<ul class="org-ul">
<li><p>
<code>protected void doRegisterBeanDefinitions(Element root)</code> 读取 XML 的
<code>&lt;bean&gt;</code> 标签中的信息
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #859900;">?xml</span> <span style="color: #6c71c4;">version</span>="1.0" <span style="color: #6c71c4;">encoding</span>="UTF-8"?&gt;
&lt;<span style="color: #b58900;">beans</span> <span style="color: #6c71c4;">xmlns</span>=<span style="color: #2aa198;">"http://www.springframework.org/schema/beans"</span>
       <span style="color: #6c71c4;">xmlns</span>:<span style="color: #6c71c4;">xsi</span>=<span style="color: #2aa198;">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span style="color: #6c71c4;">xsi</span>:<span style="color: #6c71c4;">schemaLocation</span>=<span style="color: #2aa198;">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;

  &lt;<span style="color: #b58900;">bean</span> <span style="color: #6c71c4;">id</span>=<span style="color: #2aa198;">"author"</span> <span style="color: #6c71c4;">class</span>=<span style="color: #2aa198;">"io.github.jeanhwea.bean.Author"</span>&gt;
    &lt;<span style="color: #b58900;">property</span> <span style="color: #6c71c4;">name</span>=<span style="color: #2aa198;">"name"</span> <span style="color: #6c71c4;">value</span>=<span style="color: #2aa198;">"Martin Flower"</span>/&gt;
  &lt;/<span style="color: #b58900;">bean</span>&gt;

&lt;/<span style="color: #b58900;">beans</span>&gt;
</pre>
</div></li>
</ul>

<p>
至此 XML 格式的 <code>BeanDefinition</code> 注册完成
</p>
</div>
</div>

<div id="outline-container-org730fbd5" class="outline-4">
<h4 id="org730fbd5"><span class="section-number-4">1.2.3</span> XML 标签解析</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
标签解析的细节比较多，这里跳过
</p>
<ol class="org-ol">
<li>beans 标签的解析
<ul class="org-ul">
<li>id</li>
<li>name</li>
<li>class</li>
<li>parent</li>
<li>scope</li>
<li>abstract</li>
<li>lazy-init</li>
<li>autowire</li>
<li>depends-on</li>
<li>autowire-candidate</li>
<li>init-method</li>
<li>destroy-method</li>
<li>factory-method</li>
<li>factory-bean</li>
</ul></li>
<li>import 标签的解析</li>
<li>alias 标签的解析</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org19f2665" class="outline-3">
<h3 id="org19f2665"><span class="section-number-3">1.3</span> <span class="todo TODO">TODO</span> 自定义标签注册</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<code>BeanDefinitionParser</code>
</p>
</div>
</div>

<div id="outline-container-org620c058" class="outline-3">
<h3 id="org620c058"><span class="section-number-3">1.4</span> <span class="todo TODO">TODO</span> 别名注册</h3>
</div>

<div id="outline-container-orga7d2ae4" class="outline-3">
<h3 id="orga7d2ae4"><span class="section-number-3">1.5</span> <code>&lt;bean/&gt;</code> 标签解析</h3>
<div class="outline-text-3" id="text-1-5">
<p>
<code>BeanDefinitionDocumentReader</code> 类中的 <code>processBeanDefinition(...)</code> 方法事先对
<code>&lt;bean/&gt;</code> 标签的解析
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Process the given bean element, parsing the bean definition</span>
<span style="color: #d33682;"> * and registering it with the registry.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">processBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Element</span> <span style="color: #6c71c4;">ele</span>, <span style="color: #268bd2;">BeanDefinitionParserDelegate</span> <span style="color: #6c71c4;">delegate</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">BeanDefinitionHolder</span> <span style="color: #6c71c4;">bdHolder</span> = delegate.parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bdHolder != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        bdHolder = delegate.decorateBeanDefinitionIfRequired<span style="color: #9564bf;">(</span>ele, bdHolder<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register the final decorated instance.</span>
            BeanDefinitionReaderUtils.registerBeanDefinition<span style="color: #24a222;">(</span>bdHolder, getReaderContext<span style="color: #ff7f00;">()</span>.getRegistry<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getReaderContext<span style="color: #24a222;">()</span>.error<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Failed to register bean definition with name '"</span> +
                    bdHolder.getBeanName<span style="color: #ff7f00;">()</span> + <span style="color: #2aa198;">"'"</span>, ele, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Send registration event.</span>
        getReaderContext<span style="color: #9564bf;">()</span>.fireComponentRegistered<span style="color: #9564bf;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanComponentDefinition</span><span style="color: #24a222;">(</span>bdHolder<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf96e0ed" class="outline-3">
<h3 id="orgf96e0ed"><span class="section-number-3">1.6</span> BeanDefinition 注册</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-orgcaf5666" class="outline-4">
<h4 id="orgcaf5666"><span class="section-number-4">1.6.1</span> BeanDefinition 的注册</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
BeanDefinition 的注册方法位于 <code>BeanDefinitionReaderUtils</code> 抽象类中
</p>
<ol class="org-ol">
<li>确定 beanName 和 BeanDefinition 的绑定关系</li>
<li>确定 beanName 和 Alias 的对应关系</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Register the given bean definition with the given bean factory.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> definitionHolder the bean definition including name and aliases</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> registry the bean factory to register with</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException if registration failed</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinition</span><span style="color: #8d5649;">(</span>
        <span style="color: #268bd2;">BeanDefinitionHolder</span> <span style="color: #6c71c4;">definitionHolder</span>, <span style="color: #268bd2;">BeanDefinitionRegistry</span> <span style="color: #6c71c4;">registry</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register bean definition under primary name.</span>
    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span> = definitionHolder.getBeanName<span style="color: #d8241f;">()</span>;
    registry.registerBeanDefinition<span style="color: #d8241f;">(</span>beanName, definitionHolder.getBeanDefinition<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register aliases for bean name, if any.</span>
    <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #6c71c4;">aliases</span> = definitionHolder.getAliases<span style="color: #d8241f;">()</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>aliases != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">for</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">alias</span> : aliases<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            registry.registerAlias<span style="color: #24a222;">(</span>beanName, alias<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在调用到注册方法的调用栈如下
</p>
<div class="org-src-container">
<pre class="src src-text">registerBeanDefinition:163, BeanDefinitionReaderUtils (org.springframework.beans.factory.support)
processBeanDefinition:311, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseDefaultElement:197, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseBeanDefinitions:176, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
doRegisterBeanDefinitions:149, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:96, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:509, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
doLoadBeanDefinitions:389, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:336, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:305, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:188, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:224, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:195, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:257, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:128, AbstractXmlApplicationContext (org.springframework.context.support)
loadBeanDefinitions:94, AbstractXmlApplicationContext (org.springframework.context.support)
refreshBeanFactory:133, AbstractRefreshableApplicationContext (org.springframework.context.support)
obtainFreshBeanFactory:637, AbstractApplicationContext (org.springframework.context.support)
refresh:522, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:144, ClassPathXmlApplicationContext (org.springframework.context.support)
&lt;init&gt;:85, ClassPathXmlApplicationContext (org.springframework.context.support)
main:10, MyApplication (io.github.jeanhwea)
</pre>
</div>
</div>
</div>

<div id="outline-container-org66bbb8d" class="outline-4">
<h4 id="org66bbb8d"><span class="section-number-4">1.6.2</span> DefaultListableBeanFactory</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
通过观察上文的调用栈可以发现注册 BeanDefinition 是通过
<code>AbstractRefreshableApplicationContext</code> 类中的 <code>loadBeanDefinitions(...)</code> 方
法实现
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * This implementation performs an actual refresh of this context's underlying</span>
<span style="color: #d33682;"> * bean factory, shutting down the previous bean factory (if any) and</span>
<span style="color: #d33682;"> * initializing a fresh bean factory for the next phase of the context's lifecycle.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">protected</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">refreshBeanFactory</span><span style="color: #8d5649;">()</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>hasBeanFactory<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        destroyBeans<span style="color: #9564bf;">()</span>;
        closeBeanFactory<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">DefaultListableBeanFactory</span> <span style="color: #6c71c4;">beanFactory</span> = createBeanFactory<span style="color: #9564bf;">()</span>;
        beanFactory.setSerializationId<span style="color: #9564bf;">(</span>getId<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        customizeBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        loadBeanDefinitions<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.beanFactoryMonitor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">this</span>.beanFactory = beanFactory;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">ApplicationContextException</span><span style="color: #9564bf;">(</span><span style="color: #2aa198;">"I/O error parsing bean definition source for "</span> + getDisplayName<span style="color: #24a222;">()</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
这里使用的 beanFactory 是 <code>DefaultListableBeanFactory</code>, 并且
<code>DefaultListableBeanFactory</code> 实现了大部分的 Spring 注册及加载的实现，先查看
其集成关系
</p>


<div id="orge6d0a28" class="figure">
<p><img src="../static/image/2021/07/DefaultListableBeanFactory.png" alt="DefaultListableBeanFactory.png" />
</p>
</div>

<p>
该类定了 BeanDefinition 类的 Map, 是用于存 BeanDefinition 信息的缓存
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Map of bean definition objects, keyed by bean name. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">BeanDefinition</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton and non-singleton bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">allBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton-only bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** List of bean definition names, in registration order. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">volatile</span> <span style="color: #268bd2;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionNames</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org335bb29"></a>BeanDefinition 注册的实现<br />
<div class="outline-text-5" id="text-1-6-2-1">
<p>
<code>DefaultListableBeanFactory</code> 的 <code>registerBeanDefinition(...)</code> 才是真正实现
注册 BeanDefinition 逻辑，其代码如下：
</p>
<ol class="org-ol">
<li>对 beanDefinition 进行验证</li>
<li>检查 beanDefinition 是否存在
<ul class="org-ul">
<li>如果存在，判断是否覆盖对应的 BeanDefinition</li>
<li>如果 beanDefinition 不存在，进行创建并注册</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2aa198;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #859900;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2aa198;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">existingDefinition</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #859900;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #268bd2;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在上面注册过程中， <code>hasBeanCreationStarted()</code> 方法用于判断 Bean 是否开始创
建，它实现逻辑在父类 <code>AbstractBeanFactory</code> 中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Check whether this factory's bean creation phase already started,</span>
<span style="color: #d33682;"> * i.e. whether any bean has been marked as created in the meantime.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@since</span><span style="color: #d33682;"> 4.2.2</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #markBeanAsCreated</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">hasBeanCreationStarted</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.isEmpty<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
父类 <code>AbstractBeanFactory</code> 中定义了一个集合记录正在创建的 Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Names of beans that have already been created at least once. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">alreadyCreated</span> = Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>256<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
创建时通过 <code>markBeanAsCreated(...)</code> 方法标记，注意对 <code>alreadyCreated</code> 的访
问是需要加锁的
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Mark the specified bean as already created (or about to be created).</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">This allows the bean factory to optimize its caching for repeated</span>
<span style="color: #d33682;"> * creation of the specified bean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">markBeanAsCreated</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.mergedBeanDefinitions<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.contains<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Let the bean definition get re-merged now that we're actually creating</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">the bean... just in case some of its metadata changed in the meantime.</span>
                clearMergedBeanDefinition<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.alreadyCreated.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="orgcab28a8"></a>BeanDefinition 移除的实现<br />
<div class="outline-text-5" id="text-1-6-2-2">
<p>
BeanDefinition 的移除方法如下，通过 <code>removeBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">removeBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"'beanName' must not be empty"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.remove<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No bean named '"</span> + beanName + <span style="color: #2aa198;">"' found in "</span> + <span style="color: #859900;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>hasBeanCreationStarted<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">List</span><span style="color: #24a222;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #24a222;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #24a222;">)</span>;
            updatedDefinitions.remove<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Still in startup registration phase</span>
        <span style="color: #859900;">this</span>.beanDefinitionNames.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;

    resetBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
移除 BeanDefinition 中调用了刷新 BeanDefinition 的方法
<code>resetBeanDefinition(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Reset all bean definition caches for the given bean,</span>
<span style="color: #d33682;"> * including the caches of beans that are derived from it.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">Called after an existing bean definition has been replaced or removed,</span>
<span style="color: #d33682;"> * triggering </span><span style="color: #268bd2;">{@link #clearMergedBeanDefinition}</span><span style="color: #d33682;">, </span><span style="color: #268bd2;">{@link #destroySingleton}</span>
<span style="color: #d33682;"> * and </span><span style="color: #268bd2;">{@link MergedBeanDefinitionPostProcessor#resetBeanDefinition}</span><span style="color: #d33682;"> on the</span>
<span style="color: #d33682;"> * given bean and on all bean definitions that have the given bean as parent.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean to reset</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinition</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #removeBeanDefinition</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">resetBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Remove the merged bean definition for the given bean, if already created.</span>
    clearMergedBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Remove corresponding bean from singleton cache, if any. Shouldn't usually</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">be necessary, rather just meant for overriding a context's default beans</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">(e.g. the default StaticMessageSource in a StaticApplicationContext).</span>
    destroySingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Notify all post-processors that the specified bean definition has been reset.</span>
    <span style="color: #859900;">for</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanPostProcessor</span> <span style="color: #6c71c4;">processor</span> : getBeanPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>processor <span style="color: #859900;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">MergedBeanDefinitionPostProcessor</span><span style="color: #ff7f00;">)</span> processor<span style="color: #24a222;">)</span>.resetBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Reset all bean definitions that have the given bean as parent (recursively).</span>
    <span style="color: #859900;">for</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">bdName</span> : <span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanName.equals<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span>;
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Ensure bd is non-null due to potential concurrent modification</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">of the beanDefinitionMap.</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>bd != <span style="color: #268bd2;">null</span> &amp;&amp; beanName.equals<span style="color: #ff7f00;">(</span>bd.getParentName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                resetBeanDefinition<span style="color: #ff7f00;">(</span>bdName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="orgb2b8957"></a>BeanDefinition 获取<br />
<div class="outline-text-5" id="text-1-6-2-3">
<p>
<code>DefaultListableBeanFactory</code> 的实现获取 BeanDefinition 的逻辑如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #b58900;">getBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No bean named '"</span> + beanName + <span style="color: #2aa198;">"' found in "</span> + <span style="color: #859900;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> bd;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org53c4086" class="outline-3">
<h3 id="org53c4086"><span class="section-number-3">1.7</span> Bean 的生命周期</h3>
<div class="outline-text-3" id="text-1-7">
<p>
<code>BeanFactory</code> 的注释中完整地说明的实现标准 BeanFactory 的代码
</p>
<ol class="org-ol">
<li>BeanFactory 初始化过程，支持的标准 Bean 的生命周期
<ul class="org-ul">
<li><code>BeanNameAware#setBeanName(...)</code></li>
<li><code>BeanClassLoaderAware#setBeanClassLoader(...)</code></li>
<li><code>BeanFactoryAware#setBeanFactory(...)</code></li>
<li><code>EnvironmentAware#setEnvironment(...)</code></li>
<li><code>EmbeddedValueResolverAware#setEmbeddedValueResolver(...)</code></li>
<li><code>ResourceLoaderAware#setResourceLoader(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationEventPublisherAware#setApplicationEventPublisher(...)</code> 在
ApplicationContext 中</li>
<li><code>MessageSourceAware#setMessageSource(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationContextAware#setApplicationContext(...)</code> 在
ApplicationContext 中</li>
<li><code>ServletContextAware#setServletContext(...)</code> 在 ApplicationContext 中</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessBeforeInitialization(...)</code> 方法</li>
<li><code>InitializingBean#afterPropertiesSet(...)</code></li>
<li>a custom init-method definition</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessAfterInitialization(...)</code> 方法</li>
</ul></li>
<li>关闭 BeanFactory 时，执行的 Bean 销毁方法
<ul class="org-ul">
<li><code>DestructionAwareBeanPostProcessors</code> 的一系列
<code>postProcessBeforeDestruction(...)</code> 方法</li>
<li><code>DisposableBean#destroy(...)</code></li>
<li>a custom destroy-method definition</li>
</ul></li>
</ol>
</div>
<div id="outline-container-org86e92f8" class="outline-4">
<h4 id="org86e92f8"><span class="section-number-4">1.7.1</span> XmlBeanDefinitionReader</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
实际实现读取 BeanDefinition 的方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Actually load bean definitions from the specified XML file.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> inputSource the SAX InputSource to read from</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> resource the resource descriptor for the XML file</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the number of bean definitions found</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanDefinitionStoreException in case of loading or parsing errors</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #doLoadDocument</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinitions</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">int</span> <span style="color: #b58900;">doLoadBeanDefinitions</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">InputSource</span> <span style="color: #6c71c4;">inputSource</span>, <span style="color: #268bd2;">Resource</span> <span style="color: #6c71c4;">resource</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Document</span> <span style="color: #6c71c4;">doc</span> = doLoadDocument<span style="color: #9564bf;">(</span>inputSource, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">count</span> = registerBeanDefinitions<span style="color: #9564bf;">(</span>doc, resource<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isDebugEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.debug<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Loaded "</span> + count + <span style="color: #2aa198;">" bean definitions from "</span> + resource<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> count;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXParseException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Line "</span> + ex.getLineNumber<span style="color: #24a222;">()</span> + <span style="color: #2aa198;">" in XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">SAXException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">XmlBeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"XML document from "</span> + resource + <span style="color: #2aa198;">" is invalid"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">ParserConfigurationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Parser configuration exception parsing XML from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">IOException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"IOException parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>resource.getDescription<span style="color: #24a222;">()</span>,
                <span style="color: #2aa198;">"Unexpected exception parsing XML document from "</span> + resource, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbdf721d" class="outline-2">
<h2 id="orgbdf721d"><span class="section-number-2">2</span> ApplicationContext</h2>
</div>

<div id="outline-container-org00de8d2" class="outline-2">
<h2 id="org00de8d2"><span class="section-number-2">3</span> AOP</h2>
<div class="outline-text-2" id="text-3">
<p>
使用动态代理实现
</p>
<ul class="org-ul">
<li>JDK 代理</li>
<li>cglib 代理</li>
</ul>
</div>
</div>

<div id="outline-container-org2a86989" class="outline-2">
<h2 id="org2a86989"><span class="section-number-2">4</span> Spring 核心类梳理</h2>
<div class="outline-text-2" id="text-4">
<ol class="org-ol">
<li>ApplicationContext
<ul class="org-ul">
<li>AbstractApplicationContext
<ul class="org-ul">
<li><code>refresh()</code> 实现 Spring Bean 加载的核心逻辑</li>
</ul></li>
</ul></li>
<li>BeanDefinition
<ul class="org-ul">
<li>AbstractBeanDefinition</li>
</ul></li>
<li>BeanDefinitionReader
<ul class="org-ul">
<li>读取 BeanDefinition 对象</li>
</ul></li>
<li>BeanFactory
<ul class="org-ul">
<li>Bean 工厂类</li>
<li>AbstractBeanFactory
<ul class="org-ul">
<li><code>doGetBean(...)</code></li>
</ul></li>
</ul></li>
<li>BeanFactoryPostProcessor
<ul class="org-ul">
<li>函数式接口 <code>@FunctionalInterface</code></li>
</ul></li>
<li>BeanPostProcessor
<ul class="org-ul">
<li>提供自定义 Bean 实例化的处理接口扩展</li>
<li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化前置处理方法</li>
</ul></li>
<li><code>postProcessAfterInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化后置处理方法</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org38f5dba" class="outline-2">
<h2 id="org38f5dba"><span class="section-number-2">5</span> SpringBoot 自动装配</h2>
</div>
<div id="outline-container-org67424dd" class="outline-2">
<h2 id="org67424dd"><span class="section-number-2">6</span> 参考链接</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li><a href="https://huifer.github.io/spring-analysis/">Spring Analysis</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-07-16 Fri 22:51. Created by Jinghui Hu at 2021-07-14 Wed 12:16.</p>
</div>
</body>
</html>
