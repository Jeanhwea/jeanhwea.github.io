<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-21 Wed 16:55 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring Framework 源码赏析</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring Framework 源码赏析</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8ac29af">1. Spring 核心类和方法</a>
<ul>
<li><a href="#orgd5f7d54">1.1. 核心类</a></li>
<li><a href="#org0d69299">1.2. IoC 核心方法</a></li>
</ul>
</li>
<li><a href="#orgdfb1dc9">2. 容器实现原理</a>
<ul>
<li><a href="#orgfb2cc19">2.1. Bean 工厂接口: BeanFactory</a></li>
<li><a href="#org5777237">2.2. Bean 工厂的实现类: DefaultListableBeanFactory</a></li>
<li><a href="#org51d773d">2.3. Bean 定义的读取器: XmlBeanDefinitionReader</a></li>
<li><a href="#org0115835">2.4. BeanDefinition 自动加载流程</a></li>
<li><a href="#org1c0ecaa">2.5. BeanDefinition 注册的实现</a></li>
<li><a href="#org7d7d187">2.6. BeanDefinition 移除的实现</a></li>
<li><a href="#org5ce1b51">2.7. BeanDefinition 获取的实现</a></li>
<li><a href="#org4d6bfa5">2.8. <code>&lt;bean/&gt;</code> 标签解析</a></li>
</ul>
</li>
<li><a href="#orgd7ef7fe">3. Bean 实现原理</a>
<ul>
<li><a href="#orgefc5819">3.1. Bean 的生命周期</a></li>
<li><a href="#org6a7134e">3.2. Bean 的流程分析</a>
<ul>
<li><a href="#org71be163">3.2.1. 实例化 Bean: <code>instantiateBean()</code> 方法</a></li>
<li><a href="#org8b9f3ed">3.2.2. 获取 Bean 实例: <code>doGetBean()</code> 方法</a></li>
</ul>
</li>
<li><a href="#orgd2c5984">3.3. 特殊的 Spring Bean: FactoryBean</a></li>
<li><a href="#orgd318143">3.4. 单例 Bean 工厂的实现</a>
<ul>
<li><a href="#orgf33cafb">3.4.1. 单例 Bean 工厂的三级缓存: <code>DefaultSingletonBeanRegistry</code> 类的缓存</a></li>
<li><a href="#org517aadd">3.4.2. 获取单例 Bean 方法: <code>getSingleton(...)</code> 方法</a></li>
<li><a href="#org99cd70c">3.4.3. beanInstance 到 beanOject 过程: <code>getObjectForBeanInstance(...)</code> 方法</a></li>
</ul>
</li>
<li><a href="#orgf1fbbf9">3.5. Bean 生命周期的实现</a>
<ul>
<li><a href="#orgaee7135">3.5.1. Bean 创建的实现类: <code>AbstractAutowireCapableBeanFactory</code></a></li>
<li><a href="#orgdd4a229">3.5.2. Bean 的实例化: <code>createBean(...)</code> 方法</a></li>
<li><a href="#orgd5de475">3.5.3. Bean 的初始化: <code>initializeBean(...)</code> 方法</a></li>
<li><a href="#orga43bb6f">3.5.4. Bean 的销毁</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org14b31b0">4. 容器功能扩展</a>
<ul>
<li><a href="#org8d425b3">4.1. 应用上下文: ApplicationContext</a></li>
<li><a href="#orgd5134cd">4.2. ApplicationContext 接口的常见实现类</a>
<ul>
<li><a href="#org50d57b8">4.2.1. ClassPathXmlApplicationContext</a></li>
<li><a href="#orgc635d87">4.2.2. AnnotationConfigApplicationContext</a></li>
</ul>
</li>
<li><a href="#org9142d3a">4.3. 刷新应用上下文: <code>refresh()</code> 方法</a>
<ul>
<li><a href="#orge63eff0">4.3.1. <code>refresh()</code> 方法总览</a></li>
<li><a href="#orgd3ea342">4.3.2. 环境准备</a></li>
<li><a href="#orgdb94a83">4.3.3. 加载 BeanFactory</a></li>
<li><a href="#orga247930">4.3.4. BeanFactory 准备工作</a></li>
<li><a href="#org50c68dd">4.3.5. BeanFactory 后续处理工作</a></li>
<li><a href="#org8121c77">4.3.6. 初始化非延迟加载单例</a></li>
<li><a href="#orgbbf9632">4.3.7. 完成上下文刷新</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0557036">5. AOP 面向切面编程</a>
<ul>
<li><a href="#orga82916f">5.1. AOP 实现原理</a></li>
<li><a href="#orgf3ff5b5">5.2. AOP 的实验案例</a></li>
<li><a href="#org624c7c0">5.3. AOP 实现原理: <code>&lt;aspectj-autoproxy/&gt;</code> 自动注解</a></li>
<li><a href="#org1035402">5.4. AOP 实现原理: 注册 <code>AnnotationAwareAspectJAutoProxyCreator</code></a></li>
<li><a href="#org789a2ad">5.5. Creator 的注册</a></li>
<li><a href="#org14985b1">5.6. AOP 工具类 <code>AopNamespaceUtils</code></a></li>
<li><a href="#org895e731">5.7. 创建 AOP 代理</a>
<ul>
<li><a href="#org963f9ae">5.7.1. 抽象代理创建器 AbstractAutoProxyCreator</a></li>
<li><a href="#org6eae544">5.7.2. 获取增强器 AspectJAwareAdvisorAutoProxyCreator</a></li>
<li><a href="#org71c761f">5.7.3. 寻找增强器</a></li>
<li><a href="#org86eb1de">5.7.4. 创建代理</a></li>
</ul>
</li>
<li><a href="#org463c5ed">5.8. 创建 AOP 静态代理</a>
<ul>
<li><a href="#org6d9c95f">5.8.1. Instrumentation 使用</a></li>
<li><a href="#org589f60f">5.8.2. 自定义标签</a></li>
<li><a href="#orga782514">5.8.3. 织入 Weaving</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgac0ed36">6. SpringBoot 自动装配</a></li>
<li><a href="#org4cc7bc9">7. 参考链接</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8ac29af" class="outline-2">
<h2 id="org8ac29af"><span class="section-number-2">1</span> Spring 核心类和方法</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgd5f7d54" class="outline-3">
<h3 id="orgd5f7d54"><span class="section-number-3">1.1</span> 核心类</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li>BeanFactory <code>Bean工厂</code>
<ul class="org-ul">
<li><code>getBean(...)</code></li>
<li>AbstractBeanFactory (实现了 BeanFactory 的核心方法)
<ul class="org-ul">
<li><code>doGetBean(...)</code></li>
</ul></li>
<li>DefaultListableBeanFactory</li>
</ul></li>
<li>BeanDefinition <code>Bean定义</code>
<ul class="org-ul">
<li>BeanDefinition 描述 Bean 实例定义的相关信息</li>
<li>BeanDefinition 提供 BeanFactoryPostProcessor 操作属性的最小接口</li>
<li>抽象类 <code>AbstractBeanDefinition</code> 实现了一些常用的方法
<ul class="org-ul">
<li><code>setBeanClassName(...)</code></li>
<li><code>isSingleton(...)</code></li>
</ul></li>
<li>BeanDefinitionReader 接口提供 <code>loadBeanDefinitions(...)</code> 方法
<ul class="org-ul">
<li>读取 BeanDefinition 对象</li>
<li>在 <code>XmlBeanDefinitionReader</code> 具体实现 <code>doLoadBeanDefinitions(...)</code> 读取
XML 中定义的 Bean 数据</li>
</ul></li>
</ul></li>
<li>SingletonBeanRegistry <code>单例 Bean 注册</code>
<ul class="org-ul">
<li><code>registerSingleton(...)</code> 方法提供注册单例 Bean 入口</li>
<li>常见的实现类 <code>DefaultSingletonBeanRegistry</code>
<ul class="org-ul">
<li><code>registerBeanDefinition(...)</code> 注册 BeanDefinition
<ul class="org-ul">
<li><code>Map&lt;String, BeanDefinition&gt; beanDefinitionMap</code></li>
<li><code>registerBeanDefinition(...)</code> 添加 BeanDefinition 到
beanDefinitionMap</li>
</ul></li>
<li>三级缓存解决循环依赖
<ul class="org-ul">
<li><code>Map&lt;String, Object&gt; singletonObjects</code></li>
<li><code>Map&lt;String, Object&gt; earlySingletonObjects</code></li>
<li><code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories</code></li>
</ul></li>
</ul></li>
</ul></li>
<li>ApplicationContext <code>应用上下文</code>
<ul class="org-ul">
<li>AbstractApplicationContext
<ul class="org-ul">
<li><code>refresh()</code> 实现 Spring Bean 加载的核心逻辑</li>
<li>包含 15 个子函数处理 Bean 全生命周期的事情</li>
</ul></li>
<li><code>ClassPathXmlApplicationContext</code> 读取 XML 文件中的 BeanDefinition</li>
<li><code>AnnotationConfigApplicationContext</code> 扫描包含 <code>@Component</code> 注解的
BeanDefinition</li>
</ul></li>
<li>BeanFactoryPostProcessor <code>Bean工厂后置处理器</code>
<ul class="org-ul">
<li>函数式接口 <code>@FunctionalInterface</code></li>
<li><code>postProcessBeanFactory(...)</code>  Bean 工厂后置器</li>
<li>实现</li>
</ul></li>
<li>BeanPostProcessor <code>Bean后置处理器</code>
<ul class="org-ul">
<li>提供自定义 Bean 实例化的处理接口扩展</li>
<li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化前置处理方法</li>
</ul></li>
<li><code>postProcessAfterInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化后置处理方法</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org0d69299" class="outline-3">
<h3 id="org0d69299"><span class="section-number-3">1.2</span> IoC 核心方法</h3>
<div class="outline-text-3" id="text-1-2">
<ol class="org-ol">
<li><code>getBean()</code> 获取 Bean</li>
<li><code>doGetBean()</code> 真正获取 Bean</li>
<li><code>transformedBeanName()</code> 转换 Bean 名称</li>
<li><code>getSingleton()</code> 获取单例 Bean</li>
<li><code>getParentBeanFactory()</code> 获取父 Bean 工厂</li>
<li><code>getDependsOn()</code> 获取依赖项</li>
<li><code>getSingleton()</code> 获取单例 Bean</li>
<li><code>createBean()</code> 创建 Bean</li>
<li><code>resolveBeforeInstantiation()</code> 实例化前解析</li>
<li><code>doCreateBean()</code> 真正创建 Bean</li>
<li><code>createBeanInstance()</code> 创建 Bean 实例</li>
<li><code>addSingletonFactory()</code> 添加单例工厂</li>
<li><code>populateBean()</code> 填充 Bean 属性</li>
<li><code>initializeBean()</code> 初始化 Bean</li>
<li><code>addSingleton()</code> 添加单例 Bean</li>
</ol>

<p>
添加单例的典型调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">addSingleton:134, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
registerSingleton:123, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
registerSingleton:1061, DefaultListableBeanFactory (org.springframework.beans.factory.support)
prepareBeanFactory:680, AbstractApplicationContext (org.springframework.context.support)
refresh:525, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:29, MyApp02 (io.github.jeanhwea.app02_bean_lifecycle)
</pre>
</div>

<p>
添加单例工厂的典型调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">addSingletonFactory:152, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doCreateBean:588, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1519736165 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$36)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:29, MyApp02 (io.github.jeanhwea.app02_bean_lifecycle)
</pre>
</div>

<p>
填充 Bean 的典型调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">populateBean:1370, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:594, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1519736165 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$36)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:29, MyApp02 (io.github.jeanhwea.app02_bean_lifecycle)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdfb1dc9" class="outline-2">
<h2 id="orgdfb1dc9"><span class="section-number-2">2</span> 容器实现原理</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgfb2cc19" class="outline-3">
<h3 id="orgfb2cc19"><span class="section-number-3">2.1</span> Bean 工厂接口: BeanFactory</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<code>BeanFactory</code> 是 Spring 的 Bean 工厂的接口定义，它定义对 Spring Bean 容器访问的
基本操作方法，这里简化如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">BeanFactory</span> <span style="color: #8d5649;">{</span>

  <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">FactoryBean &#30340; beanName &#21069;&#32512;</span>
  <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">FACTORY_BEAN_PREFIX</span> = <span style="color: #66cccc;">"&amp;"</span>;

  <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#33719;&#21462; Bean &#30340;&#20027;&#26041;&#27861;</span>
  <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
  <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">Object</span>... <span style="color: #ffcc66;">args</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">requiredType</span>, <span style="color: #6699cc;">Object</span>... <span style="color: #ffcc66;">args</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;

  <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6699cc;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">requiredType</span><span style="color: #d8241f;">)</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6699cc;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #6699cc;">ResolvableType</span> <span style="color: #ffcc66;">requiredType</span><span style="color: #d8241f;">)</span>;

  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">containsBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span><span style="color: #d8241f;">)</span>;

  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isSingleton</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span>;
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isPrototype</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span>;

  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">ResolvableType</span> <span style="color: #ffcc66;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span>;
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span>;

  <span style="color: #6699cc;">@Nullable</span>
  <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #f99157;">getType</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span>;
  <span style="color: #6699cc;">@Nullable</span>
  <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #f99157;">getType</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">allowFactoryBeanInit</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span>;

  <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #f99157;">getAliases</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5777237" class="outline-3">
<h3 id="org5777237"><span class="section-number-3">2.2</span> Bean 工厂的实现类: DefaultListableBeanFactory</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<code>DefaultListableBeanFactory</code> 是实现 <code>BeanFactory</code> 接口的核心类，熟悉它的类继
承和实现接口是了解 Bean 工厂功能的基本方法， <code>DefaultListableBeanFactory</code> 的
关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultListableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory
                            org.springframework.beans.factory.support.DefaultListableBeanFactory

    All Implemented Interfaces:
        Serializable, BeanFactory, AutowireCapableBeanFactory,
        ConfigurableBeanFactory, ConfigurableListableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory, ListableBeanFactory,
        BeanDefinitionRegistry, org.springframework.core.AliasRegistry

    Direct Known Subclasses:
        XmlBeanFactory
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><code>SimpleAliasRegistry</code> 实现了 <code>AliasRegistry</code> 接口
<ul class="org-ul">
<li><code>AliasRegistry</code> 定义了对别名的增删查改操作</li>
</ul></li>
<li><code>DefaultSingletonBeanRegistry</code> 实现了 <code>SingletonBeanRegistry</code> 接口
<ul class="org-ul">
<li><code>SingletonBeanRegistry</code> 定义了对单例 Bean 的注册及获取方法</li>
<li><code>SingletonBeanRegistry</code> 通过三级缓存来解决循环依赖</li>
</ul></li>
<li><code>FactoryBeanRegistrySupport</code> 实现了对 <code>FactoryBean</code> 的操作支持
<ul class="org-ul">
<li>在 Spring 管理中, <code>FactoryBean</code> 的 beanName 以 <code>&amp;</code> 开头</li>
<li><code>FactoryBean</code> 的创建方式和普通 Spring Bean 是不一样的，它没有
BeanDefinition, 直接通过实现 <code>T getObject()</code> 方法来返回创建的 Bean 对象</li>
<li><code>FactoryBean</code> 还需要实现一些其他的方法，例如： <code>isSingleton()</code>,
<code>getObjectType()</code></li>
</ul></li>
<li><code>AbstractBeanFactory</code> 实现了 <code>BeanFactory</code> 接口
<ul class="org-ul">
<li><code>BeanFactory</code> 接口的直接实现是 <code>AbstractBeanFactory</code> 抽象类</li>
<li><code>AbstractBeanFactory</code> 有很多核心方法
<ul class="org-ul">
<li><code>doGetBean(...)</code> 实现了获取 Bean 的核心逻辑</li>
<li><code>isSingleton(...)</code> 实现了判断 Bean 是否单例的核心逻辑</li>
<li><code>isPrototype(...)</code> 实现了判断 Bean 是否原型的核心逻辑</li>
</ul></li>
</ul></li>
<li><code>HierarchicalBeanFactory</code> 接口继承自 <code>BeanFactory</code>, 它增强了对 parentFactory
的支持</li>
<li><code>ConfigurableBeanFactory</code> 接口提供了配置 Factory 的各种操作
<ul class="org-ul">
<li><code>setBeanClassLoader(...)</code> 设置 Bean 的类加载器</li>
<li><code>registerDependentBean(...)</code> 方法注册依赖 Bean</li>
<li><code>registerScope(...)</code> 注册 Scope</li>
<li><code>isFactoryBean(...)</code> 判断是否为 FactoryBean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
</ul></li>
<li><code>ListableBeanFactory</code> 定义了一些获取 Bean 清单的操作
<ul class="org-ul">
<li><code>getBeanDefinitionCount()</code> 获取工厂中定义 BeanDefinition 的数量</li>
<li><code>getBeanDefinitionNames()</code> 获取工厂定义的 BeanDefinition 名称</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org51d773d" class="outline-3">
<h3 id="org51d773d"><span class="section-number-3">2.3</span> Bean 定义的读取器: XmlBeanDefinitionReader</h3>
<div class="outline-text-3" id="text-2-3">
<p>
<code>XmlBeanDefinitionReader</code> 是实现读取 BeanDefinition 的类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.xml
Class XmlBeanDefinitionReader

    java.lang.Object
        org.springframework.beans.factory.support.AbstractBeanDefinitionReader
            org.springframework.beans.factory.xml.XmlBeanDefinitionReader

    All Implemented Interfaces:
        BeanDefinitionReader, org.springframework.core.env.EnvironmentCapable
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><p>
<code>AbstractBeanDefinitionReader</code> 实现了对 BeanDefinition 的读取操作，它包含
如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">BeanDefinitionRegistry</span> <span style="color: #ffcc66;">registry</span>;
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">ResourceLoader</span> <span style="color: #ffcc66;">resourceLoader</span>;
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">ClassLoader</span> <span style="color: #ffcc66;">beanClassLoader</span>;
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">Environment</span> <span style="color: #ffcc66;">environment</span>;
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">BeanNameGenerator</span> <span style="color: #ffcc66;">beanNameGenerator</span> = <span style="color: #6699cc;">DefaultBeanNameGenerator</span>.INSTANCE;
</pre>
</div>
<ul class="org-ul">
<li>registry 表示 BeanDefinition 的注册类</li>
<li>resourceLoader 实现了资源加载</li>
<li>environment 实现了读取系统环境变量和 Java 属性</li>
<li>beanNameGenerator 是 beanName 生成器</li>
</ul></li>
<li><code>XmlBeanDefinitionReader</code> 直接继承自 <code>AbstractBeanDefinitionReader</code>, 增加了
<ul class="org-ul">
<li><code>DocumentLoader</code> 将资源转化成 Document 对象功能</li>
<li>添加了对 XML 的格式验证的方法
<ul class="org-ul">
<li>DTD (Document Type Definition) 验证</li>
<li>XSD (XML Schema Definition) 验证</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org0115835" class="outline-3">
<h3 id="org0115835"><span class="section-number-3">2.4</span> BeanDefinition 自动加载流程</h3>
<div class="outline-text-3" id="text-2-4">
<p>
<code>DefaultListableBeanFactory</code> 类定义了存储 BeanDefinition 类的哈希表, 具体定义如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/** Map of bean definition objects, keyed by bean name. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">BeanDefinition</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">beanDefinitionMap</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Map of singleton and non-singleton bean names, keyed by dependency type. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">allBeanNamesByType</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Map of singleton-only bean names, keyed by dependency type. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">singletonBeanNamesByType</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** List of bean definition names, in registration order. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">volatile</span> <span style="color: #6699cc;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">beanDefinitionNames</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
最终 BeanDefinition 通过调用 <code>registerBeanDefinition(...)</code> 方法注册到
<code>beanDefinitionMap</code> 中，代码的注释也写了是对 <code>BeanDefinitionRegistry</code> 的实现
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #66cccc;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #66cccc;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #99cc99;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #6699cc;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeanDefinitionValidationException</span> <span style="color: #ffcc66;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #66cccc;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">existingDefinition</span> = <span style="color: #99cc99;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #66cccc;">"] with ["</span> + beanDefinition + <span style="color: #66cccc;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #66cccc;">"] with ["</span> + beanDefinition + <span style="color: #66cccc;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #66cccc;">"] with ["</span> + beanDefinition + <span style="color: #66cccc;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #99cc99;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #99cc99;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #6699cc;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #ffcc66;">updatedDefinitions</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #99cc99;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #99cc99;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #99cc99;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">this</span>.frozenBeanDefinitionNames = <span style="color: #6699cc;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #6699cc;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在 <code>registerBeanDefinition(...)</code> 方法中添加端点可以获得如下的调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">registerBeanDefinition:914, DefaultListableBeanFactory (org.springframework.beans.factory.support)
registerBeanDefinition:164, BeanDefinitionReaderUtils (org.springframework.beans.factory.support)
processBeanDefinition:311, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseDefaultElement:197, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseBeanDefinitions:176, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
doRegisterBeanDefinitions:149, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:96, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:509, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
doLoadBeanDefinitions:389, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:336, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:305, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:188, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:224, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:195, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:257, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:128, AbstractXmlApplicationContext (org.springframework.context.support)
loadBeanDefinitions:94, AbstractXmlApplicationContext (org.springframework.context.support)
refreshBeanFactory:133, AbstractRefreshableApplicationContext (org.springframework.context.support)
obtainFreshBeanFactory:637, AbstractApplicationContext (org.springframework.context.support)
refresh:522, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:144, ClassPathXmlApplicationContext (org.springframework.context.support)
&lt;init&gt;:85, ClassPathXmlApplicationContext (org.springframework.context.support)
main:10, MyApp01 (io.github.jeanhwea.app01)
</pre>
</div>

<p>
观察调用栈可以得到 BeanDefinition 的加载步骤如下:
</p>
<ol class="org-ol">
<li>入口方法为 <code>AbstractApplicationContext#refresh(...)</code></li>
<li><code>obtainFreshBeanFactory(...)</code> 方法获取 BeanFactory 的同时需要注册
BeanDefinition</li>
<li><code>XmlBeanDefinitionReader#doLoadBeanDefinitions(...)</code> 方法完成如下操作
<ul class="org-ul">
<li><p>
定义了 documentLoader 成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">private</span> <span style="color: #6699cc;">DocumentLoader</span> <span style="color: #ffcc66;">documentLoader</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">DefaultDocumentLoader</span><span style="color: #8d5649;">()</span>;
</pre>
</div></li>
<li>首先调用 <code>doLoadDocument(inputSource, resource)</code> 读取到 Document 对象</li>
<li>然后调用 <code>registerBeanDefinitions(doc, resource)</code> 完成 BeanDefinition 的
注册</li>
</ul></li>
<li>调用 <code>parseDefaultElement(...)</code> 方法对默认元素进行解析
<ul class="org-ul">
<li>对 import 类型标签解析</li>
<li>对 alias 类型标签解析</li>
<li>对 bean 类型标签解析</li>
<li>对嵌套 bean 类型标签解析</li>
</ul></li>
<li>接着对标签进行处理，最终交付到
<code>DefaultListableBeanFactory#registerBeanDefinition(...)</code> 方法进行注册</li>
</ol>
</div>
</div>

<div id="outline-container-org1c0ecaa" class="outline-3">
<h3 id="org1c0ecaa"><span class="section-number-3">2.5</span> BeanDefinition 注册的实现</h3>
<div class="outline-text-3" id="text-2-5">
<p>
<code>DefaultListableBeanFactory</code> 的 <code>registerBeanDefinition(...)</code> 才是真正实现注
册 BeanDefinition 逻辑，其代码如下：
</p>
<ol class="org-ol">
<li>对 beanDefinition 进行验证</li>
<li>检查 beanDefinition 是否存在
<ul class="org-ul">
<li>如果存在，判断是否覆盖对应的 BeanDefinition</li>
<li>如果 beanDefinition 不存在，进行创建并注册</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #66cccc;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #66cccc;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #99cc99;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #6699cc;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeanDefinitionValidationException</span> <span style="color: #ffcc66;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #66cccc;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">existingDefinition</span> = <span style="color: #99cc99;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #66cccc;">"] with ["</span> + beanDefinition + <span style="color: #66cccc;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #66cccc;">"] with ["</span> + beanDefinition + <span style="color: #66cccc;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #66cccc;">"] with ["</span> + beanDefinition + <span style="color: #66cccc;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #99cc99;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #99cc99;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #6699cc;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #ffcc66;">updatedDefinitions</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #99cc99;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #99cc99;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #99cc99;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">this</span>.frozenBeanDefinitionNames = <span style="color: #6699cc;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #6699cc;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在上面注册过程中， <code>hasBeanCreationStarted()</code> 方法用于判断 Bean 是否开始创建，
它实现逻辑在父类 <code>AbstractBeanFactory</code> 中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Check whether this factory's bean creation phase already started,</span>
<span style="color: #cc99cc;"> * i.e. whether any bean has been marked as created in the meantime.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@since</span><span style="color: #cc99cc;"> 4.2.2</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #markBeanAsCreated</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">hasBeanCreationStarted</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">!</span><span style="color: #99cc99;">this</span>.alreadyCreated.isEmpty<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
父类 <code>AbstractBeanFactory</code> 中定义了一个集合记录正在创建的 Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/** Names of beans that have already been created at least once. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">alreadyCreated</span> = Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>256<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
创建时通过 <code>markBeanAsCreated(...)</code> 方法标记，注意对 <code>alreadyCreated</code> 的访问
是需要加锁的
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Mark the specified bean as already created (or about to be created).</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">&lt;p&gt;</span><span style="color: #cc99cc;">This allows the bean factory to optimize its caching for repeated</span>
<span style="color: #cc99cc;"> * creation of the specified bean.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">markBeanAsCreated</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span><span style="color: #99cc99;">this</span>.alreadyCreated.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.mergedBeanDefinitions<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">!</span><span style="color: #99cc99;">this</span>.alreadyCreated.contains<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Let the bean definition get re-merged now that we're actually creating</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">the bean... just in case some of its metadata changed in the meantime.</span>
                clearMergedBeanDefinition<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">this</span>.alreadyCreated.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d7d187" class="outline-3">
<h3 id="org7d7d187"><span class="section-number-3">2.6</span> BeanDefinition 移除的实现</h3>
<div class="outline-text-3" id="text-2-6">
<p>
BeanDefinition 的移除方法如下，通过 <code>removeBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">removeBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #66cccc;">"'beanName' must not be empty"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">bd</span> = <span style="color: #99cc99;">this</span>.beanDefinitionMap.remove<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"No bean named '"</span> + beanName + <span style="color: #66cccc;">"' found in "</span> + <span style="color: #99cc99;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>hasBeanCreationStarted<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
        <span style="color: #99cc99;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.beanDefinitionMap<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">List</span><span style="color: #24a222;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #ffcc66;">updatedDefinitions</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #24a222;">&lt;&gt;(</span><span style="color: #99cc99;">this</span>.beanDefinitionNames<span style="color: #24a222;">)</span>;
            updatedDefinitions.remove<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">this</span>.beanDefinitionNames = updatedDefinitions;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Still in startup registration phase</span>
        <span style="color: #99cc99;">this</span>.beanDefinitionNames.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">this</span>.frozenBeanDefinitionNames = <span style="color: #6699cc;">null</span>;

    resetBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
移除 BeanDefinition 中调用了刷新 BeanDefinition 的方法
<code>resetBeanDefinition(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Reset all bean definition caches for the given bean,</span>
<span style="color: #cc99cc;"> * including the caches of beans that are derived from it.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">&lt;p&gt;</span><span style="color: #cc99cc;">Called after an existing bean definition has been replaced or removed,</span>
<span style="color: #cc99cc;"> * triggering </span><span style="color: #6699cc;">{@link #clearMergedBeanDefinition}</span><span style="color: #cc99cc;">, </span><span style="color: #6699cc;">{@link #destroySingleton}</span>
<span style="color: #cc99cc;"> * and </span><span style="color: #6699cc;">{@link MergedBeanDefinitionPostProcessor#resetBeanDefinition}</span><span style="color: #cc99cc;"> on the</span>
<span style="color: #cc99cc;"> * given bean and on all bean definitions that have the given bean as parent.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean to reset</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #registerBeanDefinition</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #removeBeanDefinition</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">resetBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Remove the merged bean definition for the given bean, if already created.</span>
    clearMergedBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Remove corresponding bean from singleton cache, if any. Shouldn't usually</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">be necessary, rather just meant for overriding a context's default beans</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">(e.g. the default StaticMessageSource in a StaticApplicationContext).</span>
    destroySingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Notify all post-processors that the specified bean definition has been reset.</span>
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">BeanPostProcessor</span> <span style="color: #ffcc66;">processor</span> : getBeanPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>processor <span style="color: #99cc99;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #6699cc;">MergedBeanDefinitionPostProcessor</span><span style="color: #ff7f00;">)</span> processor<span style="color: #24a222;">)</span>.resetBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Reset all bean definitions that have the given bean as parent (recursively).</span>
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">bdName</span> : <span style="color: #99cc99;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>beanName.equals<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">bd</span> = <span style="color: #99cc99;">this</span>.beanDefinitionMap.get<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span>;
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Ensure bd is non-null due to potential concurrent modification</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">of the beanDefinitionMap.</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>bd != <span style="color: #6699cc;">null</span> &amp;&amp; beanName.equals<span style="color: #ff7f00;">(</span>bd.getParentName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                resetBeanDefinition<span style="color: #ff7f00;">(</span>bdName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ce1b51" class="outline-3">
<h3 id="org5ce1b51"><span class="section-number-3">2.7</span> BeanDefinition 获取的实现</h3>
<div class="outline-text-3" id="text-2-7">
<p>
<code>DefaultListableBeanFactory</code> 的实现获取 BeanDefinition 的逻辑如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #f99157;">getBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">bd</span> = <span style="color: #99cc99;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"No bean named '"</span> + beanName + <span style="color: #66cccc;">"' found in "</span> + <span style="color: #99cc99;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> bd;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d6bfa5" class="outline-3">
<h3 id="org4d6bfa5"><span class="section-number-3">2.8</span> <code>&lt;bean/&gt;</code> 标签解析</h3>
<div class="outline-text-3" id="text-2-8">
<p>
之前在 BeanDefinition 自动加载流程中忽略了对 <code>&lt;bean/&gt;</code> 标签的解析，其核心实现
逻辑 <code>BeanDefinitionDocumentReader</code> 类中的 <code>processBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Process the given bean element, parsing the bean definition</span>
<span style="color: #cc99cc;"> * and registering it with the registry.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">processBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">ele</span>, <span style="color: #6699cc;">BeanDefinitionParserDelegate</span> <span style="color: #ffcc66;">delegate</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">BeanDefinitionHolder</span> <span style="color: #ffcc66;">bdHolder</span> = delegate.parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>bdHolder != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        bdHolder = delegate.decorateBeanDefinitionIfRequired<span style="color: #9564bf;">(</span>ele, bdHolder<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register the final decorated instance.</span>
            BeanDefinitionReaderUtils.registerBeanDefinition<span style="color: #24a222;">(</span>bdHolder, getReaderContext<span style="color: #ff7f00;">()</span>.getRegistry<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeanDefinitionStoreException</span> <span style="color: #ffcc66;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getReaderContext<span style="color: #24a222;">()</span>.error<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Failed to register bean definition with name '"</span> +
                    bdHolder.getBeanName<span style="color: #ff7f00;">()</span> + <span style="color: #66cccc;">"'"</span>, ele, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Send registration event.</span>
        getReaderContext<span style="color: #9564bf;">()</span>.fireComponentRegistered<span style="color: #9564bf;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanComponentDefinition</span><span style="color: #24a222;">(</span>bdHolder<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
可以看出对 XML 标签的解析核心逻辑为 <code>parseBeanDefinitionElement(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Parses the supplied </span><span style="color: #6699cc;">{@code </span><span style="color: #6699cc;">&lt;bean&gt;</span><span style="color: #6699cc;">}</span><span style="color: #cc99cc;"> element. May return </span><span style="color: #6699cc;">{@code null}</span>
<span style="color: #cc99cc;"> * if there were errors during parse. Errors are reported to the</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">{@link org.springframework.beans.factory.parsing.ProblemReporter}</span><span style="color: #cc99cc;">.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@Nullable</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">BeanDefinitionHolder</span> <span style="color: #f99157;">parseBeanDefinitionElement</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">ele</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">containingBean</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">id</span> = ele.getAttribute<span style="color: #d8241f;">(</span>ID_ATTRIBUTE<span style="color: #d8241f;">)</span>;
    <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">nameAttr</span> = ele.getAttribute<span style="color: #d8241f;">(</span>NAME_ATTRIBUTE<span style="color: #d8241f;">)</span>;

    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">aliases</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>nameAttr<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #ffcc66;">nameArr</span> = StringUtils.tokenizeToStringArray<span style="color: #9564bf;">(</span>nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS<span style="color: #9564bf;">)</span>;
        aliases.addAll<span style="color: #9564bf;">(</span>Arrays.asList<span style="color: #24a222;">(</span>nameArr<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span> = id;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>StringUtils.hasText<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> &amp;&amp; <span style="color: #6699cc;">!</span>aliases.isEmpty<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanName = aliases.remove<span style="color: #9564bf;">(</span>0<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"No XML 'id' specified - using '"</span> + beanName +
                    <span style="color: #66cccc;">"' as bean name and "</span> + aliases + <span style="color: #66cccc;">" as aliases"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>containingBean == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        checkNameUniqueness<span style="color: #9564bf;">(</span>beanName, aliases, ele<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">AbstractBeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span> = parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele, beanName, containingBean<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanDefinition != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>StringUtils.hasText<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">try</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>containingBean != <span style="color: #6699cc;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    beanName = BeanDefinitionReaderUtils.generateBeanName<span style="color: #1776b6;">(</span>
                            beanDefinition, <span style="color: #99cc99;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>, <span style="color: #6699cc;">true</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">else</span> <span style="color: #ff7f00;">{</span>
                    beanName = <span style="color: #99cc99;">this</span>.readerContext.generateBeanName<span style="color: #1776b6;">(</span>beanDefinition<span style="color: #1776b6;">)</span>;
                    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register an alias for the plain bean class name, if still possible,</span>
                    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">if the generator returned the class name plus a suffix.</span>
                    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">This is expected for Spring 1.2/2.0 backwards compatibility.</span>
                    <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanClassName</span> = beanDefinition.getBeanClassName<span style="color: #1776b6;">()</span>;
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span>beanClassName != <span style="color: #6699cc;">null</span> &amp;&amp;
                            beanName.startsWith<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span> &amp;&amp; beanName.length<span style="color: #00bed1;">()</span> &gt; beanClassName.length<span style="color: #00bed1;">()</span> &amp;&amp;
                            <span style="color: #6699cc;">!</span><span style="color: #99cc99;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>.isBeanNameInUse<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        aliases.add<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>logger.isTraceEnabled<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    logger.trace<span style="color: #1776b6;">(</span><span style="color: #66cccc;">"Neither XML 'id' nor 'name' specified - "</span> +
                            <span style="color: #66cccc;">"using generated bean name ["</span> + beanName + <span style="color: #66cccc;">"]"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">catch</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">Exception</span> <span style="color: #ffcc66;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                error<span style="color: #ff7f00;">(</span>ex.getMessage<span style="color: #1776b6;">()</span>, ele<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #6699cc;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #ffcc66;">aliasesArray</span> = StringUtils.toStringArray<span style="color: #9564bf;">(</span>aliases<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">return</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanDefinitionHolder</span><span style="color: #9564bf;">(</span>beanDefinition, beanName, aliasesArray<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd7ef7fe" class="outline-2">
<h2 id="orgd7ef7fe"><span class="section-number-2">3</span> Bean 实现原理</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgefc5819" class="outline-3">
<h3 id="orgefc5819"><span class="section-number-3">3.1</span> Bean 的生命周期</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<code>BeanFactory</code> 的注释中完整地说明的实现标准 BeanFactory 的代码
</p>
<ol class="org-ol">
<li>BeanFactory 初始化过程，支持的标准 Bean 的生命周期
<ul class="org-ul">
<li><code>BeanNameAware#setBeanName(...)</code></li>
<li><code>BeanClassLoaderAware#setBeanClassLoader(...)</code></li>
<li><code>BeanFactoryAware#setBeanFactory(...)</code></li>
<li><code>EnvironmentAware#setEnvironment(...)</code></li>
<li><code>EmbeddedValueResolverAware#setEmbeddedValueResolver(...)</code></li>
<li><code>ResourceLoaderAware#setResourceLoader(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationEventPublisherAware#setApplicationEventPublisher(...)</code> 在
ApplicationContext 中</li>
<li><code>MessageSourceAware#setMessageSource(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationContextAware#setApplicationContext(...)</code> 在
ApplicationContext 中</li>
<li><code>ServletContextAware#setServletContext(...)</code> 在 ApplicationContext 中</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessBeforeInitialization(...)</code> 方法</li>
<li><code>InitializingBean#afterPropertiesSet(...)</code></li>
<li>a custom init-method definition</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessAfterInitialization(...)</code> 方法</li>
</ul></li>
<li>关闭 BeanFactory 时，执行的 Bean 销毁方法
<ul class="org-ul">
<li><code>DestructionAwareBeanPostProcessors</code> 的一系列
<code>postProcessBeforeDestruction(...)</code> 方法</li>
<li><code>DisposableBean#destroy(...)</code></li>
<li>a custom destroy-method definition</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org6a7134e" class="outline-3">
<h3 id="org6a7134e"><span class="section-number-3">3.2</span> Bean 的流程分析</h3>
<div class="outline-text-3" id="text-3-2">
<p>
实例化 Bean 的方法为 <code>BeanUtils#instantiateClass(...)</code>, 先添加断点获取调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">instantiateClass:185, BeanUtils (org.springframework.beans)
instantiate:87, SimpleInstantiationStrategy (org.springframework.beans.factory.support)
instantiateBean:1312, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBeanInstance:1214, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:557, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1027007693 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$29)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
main:18, MyApp02 (io.github.jeanhwea.app02)
</pre>
</div>

<p>
先分析调用栈，可以知道创建 Bean 的入口是 <code>refresh()</code> 方法的
<code>invokeBeanFactoryPostProcessors()</code> 方法，这里牵扯到几个核心的方法
</p>
<ol class="org-ol">
<li><code>AbstractApplicationContext#refresh()</code></li>
<li><code>AbstractBeanFactory#doGetBean(...)</code></li>
<li><code>AbstractAutowireCapableBeanFactory#instantiateBean(...)</code></li>
</ol>
</div>

<div id="outline-container-org71be163" class="outline-4">
<h4 id="org71be163"><span class="section-number-4">3.2.1</span> 实例化 Bean: <code>instantiateBean()</code> 方法</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
<code>instantiateBean(...)</code> 实例化 Bean 主要完成如下工作
</p>
<ol class="org-ol">
<li>使用 InstantiationStrategy 实例化策略来实例化 Bean, Spring 中创建 Bean 有如
下两种方式
<ul class="org-ul">
<li>通过 <code>BeanUtils.instantiateClass()</code> 方法创建实例</li>
<li>通过 <code>new CglibSubclassCreator(bd, owner).instantiate(ctor, args)</code> 方式
进行创建</li>
</ul></li>
<li>添加 BeanWrapper 封装 Bean 对象
<ul class="org-ul">
<li>实现类为 <code>BeanWrapperImpl</code></li>
<li><code>BeanWrapperImpl</code> 继承自 <code>AbstractNestablePropertyAccessor</code></li>
<li><code>AbstractNestablePropertyAccessor#setPropertyValue(...)</code> 方法设置属性值</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Instantiate the given bean using its default constructor.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> mbd the bean definition for the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> a BeanWrapper for the new instance</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">BeanWrapper</span> <span style="color: #f99157;">instantiateBean</span><span style="color: #8d5649;">(</span><span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">beanInstance</span>;
        <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">BeanFactory</span> <span style="color: #ffcc66;">parent</span> = <span style="color: #99cc99;">this</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            beanInstance = AccessController.doPrivileged<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #6699cc;">PrivilegedAction</span><span style="color: #1776b6;">&lt;</span><span style="color: #6699cc;">Object</span><span style="color: #1776b6;">&gt;</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">()</span> -&gt;
                    getInstantiationStrategy<span style="color: #ff7f00;">()</span>.instantiate<span style="color: #ff7f00;">(</span>mbd, beanName, parent<span style="color: #ff7f00;">)</span>,
                    getAccessControlContext<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            beanInstance = getInstantiationStrategy<span style="color: #24a222;">()</span>.instantiate<span style="color: #24a222;">(</span>mbd, beanName, parent<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #6699cc;">BeanWrapper</span> <span style="color: #ffcc66;">bw</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanWrapperImpl</span><span style="color: #9564bf;">(</span>beanInstance<span style="color: #9564bf;">)</span>;
        initBeanWrapper<span style="color: #9564bf;">(</span>bw<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">return</span> bw;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #66cccc;">"Instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8b9f3ed" class="outline-4">
<h4 id="org8b9f3ed"><span class="section-number-4">3.2.2</span> 获取 Bean 实例: <code>doGetBean()</code> 方法</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
<code>doGetBean(...)</code> 方法是获取 Bean 的最终处理函数，它的逻辑比较复杂，可以分成
以下流程
</p>
<ol class="org-ol">
<li>获取 beanName
<ul class="org-ul">
<li>解析带有别名的 Bean 到最终的名称</li>
<li>去除 FactoryBean 的修饰符，即 <code>&amp;</code> 前缀</li>
</ul></li>
<li>缓存获取
<ul class="org-ul">
<li>调用 <code>DefaultSingletonBeanRegistry#getSingleton()</code> 尝试从单例容器缓存中
获取</li>
<li>单例 Bean 只创建一次，创建完成直接放入缓存，参考
<code>DefaultSingletonBeanRegistry</code> 的实现</li>
<li>依赖的 Bean 避免循环依赖，只记录 <code>ObjectFactory</code> 对象, 参考
<code>singletonFactories</code> 变量的定义及循环依赖的解决方法</li>
</ul></li>
<li>创建 Bean 实例
<ul class="org-ul">
<li>获取 FactoryBean 生成的 Bean 实例
<ul class="org-ul">
<li>FactoryBean 实例需要获取到的对象是 <code>factory-method</code> 返回的 Bean 对象</li>
<li><code>getObjectForBeanInstance()</code> 方法实现了从 Bean 实例中获取 Bean 对象的
逻辑，后续再说明该方法的逻辑</li>
</ul></li>
<li>如果不是 FactoryBean
<ul class="org-ul">
<li>调用 <code>isPrototypeCurrentlyInCreation(...)</code> 判断创建原型 Bean 是否出现
循环依赖</li>
<li>尝试从 parentBeanFactory 中获取 Bean</li>
<li>将 BeanDefinition 进行合并，得到 <code>RootBeanDefinition</code>, 并检验</li>
<li>调用 <code>markBeanAsCreated()</code> 方法标记创建 Bean</li>
<li>解决 Bean 依赖
<ul class="org-ul">
<li>Bean 是动态加载的，当前待创建 Bean 的可能存在依赖项</li>
<li>解决依赖的策略是顺序寻找出所有依赖，并完成创建</li>
</ul></li>
<li>通过不同的 scope 完成对应 Bean 的创建
<ul class="org-ul">
<li>单例 Bean 创建: <code>getSingleton(...)</code></li>
<li>原型 Bean 创建: <code>getSingleton(...)</code></li>
<li>其它情况 Bean 创建，例如： <code>@RequestScope</code> <code>@SessionScope</code> 等</li>
</ul></li>
</ul></li>
</ul></li>
<li>检查 Bean 实例，完成类型转换</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Return an instance, which may be shared or independent, of the specified bean.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> name the name of the bean to retrieve</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> requiredType the required type of the bean to retrieve</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> args arguments to use when creating a bean instance using explicit arguments</span>
<span style="color: #cc99cc;"> * (only applied when creating a new instance as opposed to retrieving an existing one)</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> typeCheckOnly whether the instance is obtained for a type check,</span>
<span style="color: #cc99cc;"> * not for actual use</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> an instance of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@throws</span><span style="color: #cc99cc;"> BeansException if the bean could not be created</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@SuppressWarnings</span><span style="color: #8d5649;">(</span><span style="color: #66cccc;">"unchecked"</span><span style="color: #8d5649;">)</span>
<span style="color: #99cc99;">protected</span> <span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6699cc;">T</span> <span style="color: #f99157;">doGetBean</span><span style="color: #8d5649;">(</span><span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">requiredType</span>,
        <span style="color: #6699cc;">@Nullable</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">args</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">typeCheckOnly</span><span style="color: #8d5649;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span> = transformedBeanName<span style="color: #d8241f;">(</span>name<span style="color: #d8241f;">)</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Eagerly check singleton cache for manually registered singletons.</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">sharedInstance</span> = getSingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>sharedInstance != <span style="color: #6699cc;">null</span> &amp;&amp; args == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>isSingletonCurrentlyInCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Returning eagerly cached instance of singleton bean '"</span> + beanName +
                        <span style="color: #66cccc;">"' that is not fully initialized yet - a consequence of a circular reference"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Returning cached instance of singleton bean '"</span> + beanName + <span style="color: #66cccc;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        bean = getObjectForBeanInstance<span style="color: #9564bf;">(</span>sharedInstance, name, beanName, <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Fail if we're already creating this bean instance:</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">We're assumably within a circular reference.</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>isPrototypeCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Check if bean definition exists in this factory.</span>
        <span style="color: #6699cc;">BeanFactory</span> <span style="color: #ffcc66;">parentBeanFactory</span> = getParentBeanFactory<span style="color: #9564bf;">()</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>parentBeanFactory != <span style="color: #6699cc;">null</span> &amp;&amp; <span style="color: #6699cc;">!</span>containsBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Not found -&gt; check parent.</span>
            <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">nameToLookup</span> = originalBeanName<span style="color: #24a222;">(</span>name<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>parentBeanFactory <span style="color: #99cc99;">instanceof</span> AbstractBeanFactory<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #6699cc;">AbstractBeanFactory</span><span style="color: #1776b6;">)</span> parentBeanFactory<span style="color: #ff7f00;">)</span>.doGetBean<span style="color: #ff7f00;">(</span>
                        nameToLookup, requiredType, args, typeCheckOnly<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>args != <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Delegation to parent with explicit args.</span>
                <span style="color: #99cc99;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, args<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>requiredType != <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">No args -&gt; delegate to standard getBean method.</span>
                <span style="color: #99cc99;">return</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, requiredType<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>

        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>typeCheckOnly<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            markBeanAsCreated<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span> = getMergedLocalBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            checkMergedBeanDefinition<span style="color: #24a222;">(</span>mbd, beanName, args<span style="color: #24a222;">)</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Guarantee initialization of beans that the current bean depends on.</span>
            <span style="color: #6699cc;">String</span><span style="color: #24a222;">[]</span> <span style="color: #ffcc66;">dependsOn</span> = mbd.getDependsOn<span style="color: #24a222;">()</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>dependsOn != <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">dep</span> : dependsOn<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span>isDependent<span style="color: #00bed1;">(</span>beanName, dep<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #66cccc;">"Circular depends-on relationship between '"</span> + beanName + <span style="color: #66cccc;">"' and '"</span> + dep + <span style="color: #66cccc;">"'"</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    registerDependentBean<span style="color: #1776b6;">(</span>dep, beanName<span style="color: #1776b6;">)</span>;
                    <span style="color: #99cc99;">try</span> <span style="color: #1776b6;">{</span>
                        getBean<span style="color: #00bed1;">(</span>dep<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #99cc99;">catch</span> <span style="color: #1776b6;">(</span><span style="color: #6699cc;">NoSuchBeanDefinitionException</span> <span style="color: #ffcc66;">ex</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #66cccc;">"'"</span> + beanName + <span style="color: #66cccc;">"' depends on missing bean '"</span> + dep + <span style="color: #66cccc;">"'"</span>, ex<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Create bean instance.</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>mbd.isSingleton<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                sharedInstance = getSingleton<span style="color: #ff7f00;">(</span>beanName, <span style="color: #1776b6;">()</span> -&gt; <span style="color: #1776b6;">{</span>
                    <span style="color: #99cc99;">try</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #99cc99;">return</span> createBean<span style="color: #bcbf00;">(</span>beanName, mbd, args<span style="color: #bcbf00;">)</span>;
                    <span style="color: #00bed1;">}</span>
                    <span style="color: #99cc99;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #6699cc;">BeansException</span> <span style="color: #ffcc66;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Explicitly remove instance from singleton cache: It might have been put there</span>
                        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">eagerly by the creation process, to allow for circular reference resolution.</span>
                        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Also remove any beans that received a temporary reference to the bean.</span>
                        destroySingleton<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #99cc99;">throw</span> ex;
                    <span style="color: #00bed1;">}</span>
                <span style="color: #1776b6;">}</span><span style="color: #ff7f00;">)</span>;
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>sharedInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>mbd.isPrototype<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">It's a prototype -&gt; create a new instance.</span>
                <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">prototypeInstance</span> = <span style="color: #6699cc;">null</span>;
                <span style="color: #99cc99;">try</span> <span style="color: #ff7f00;">{</span>
                    beforePrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                    prototypeInstance = createBean<span style="color: #1776b6;">(</span>beanName, mbd, args<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">finally</span> <span style="color: #ff7f00;">{</span>
                    afterPrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>prototypeInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #99cc99;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">scopeName</span> = mbd.getScope<span style="color: #ff7f00;">()</span>;
                <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Scope</span> <span style="color: #ffcc66;">scope</span> = <span style="color: #99cc99;">this</span>.scopes.get<span style="color: #ff7f00;">(</span>scopeName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>scope == <span style="color: #6699cc;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">IllegalStateException</span><span style="color: #1776b6;">(</span><span style="color: #66cccc;">"No Scope registered for scope name '"</span> + scopeName + <span style="color: #66cccc;">"'"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">try</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">scopedInstance</span> = scope.get<span style="color: #1776b6;">(</span>beanName, <span style="color: #00bed1;">()</span> -&gt; <span style="color: #00bed1;">{</span>
                        beforePrototypeCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #99cc99;">try</span> <span style="color: #bcbf00;">{</span>
                            <span style="color: #99cc99;">return</span> createBean<span style="color: #e574c3;">(</span>beanName, mbd, args<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                        <span style="color: #99cc99;">finally</span> <span style="color: #bcbf00;">{</span>
                            afterPrototypeCreation<span style="color: #e574c3;">(</span>beanName<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                    <span style="color: #00bed1;">}</span><span style="color: #1776b6;">)</span>;
                    bean = getObjectForBeanInstance<span style="color: #1776b6;">(</span>scopedInstance, name, beanName, mbd<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">IllegalStateException</span> <span style="color: #ffcc66;">ex</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #66cccc;">"Scope '"</span> + scopeName + <span style="color: #66cccc;">"' is not active for the current thread; consider "</span> +
                            <span style="color: #66cccc;">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,
                            ex<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeansException</span> <span style="color: #ffcc66;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            cleanupAfterBeanCreationFailure<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">throw</span> ex;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Check if required type matches the type of the actual bean instance.</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>requiredType != <span style="color: #6699cc;">null</span> &amp;&amp; <span style="color: #6699cc;">!</span>requiredType.isInstance<span style="color: #9564bf;">(</span>bean<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">T</span> <span style="color: #ffcc66;">convertedBean</span> = getTypeConverter<span style="color: #24a222;">()</span>.convertIfNecessary<span style="color: #24a222;">(</span>bean, requiredType<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>convertedBean == <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanNotOfRequiredTypeException</span><span style="color: #ff7f00;">(</span>name, requiredType, bean.getClass<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">return</span> convertedBean;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">TypeMismatchException</span> <span style="color: #ffcc66;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Failed to convert bean '"</span> + name + <span style="color: #66cccc;">"' to required type '"</span> +
                        ClassUtils.getQualifiedName<span style="color: #1776b6;">(</span>requiredType<span style="color: #1776b6;">)</span> + <span style="color: #66cccc;">"'"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanNotOfRequiredTypeException</span><span style="color: #24a222;">(</span>name, requiredType, bean.getClass<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">)</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd2c5984" class="outline-3">
<h3 id="orgd2c5984"><span class="section-number-3">3.3</span> 特殊的 Spring Bean: FactoryBean</h3>
<div class="outline-text-3" id="text-3-3">
<p>
FactoryBean 不同于普通的 Bean， FactoryBean 自身就是一个组装 Bean 的微型工厂，
即在调用 <code>BeanFactory#getBean(...)</code> 方法时不返回 FactoryBean，而是返回工厂方
法返回的 Bean，定义 FactoryBean 只需要实现 <code>FactoryBean</code> 接口即可
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">FactoryBean</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">@Nullable</span>
    <span style="color: #6699cc;">T</span> <span style="color: #f99157;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">Exception</span>;

    <span style="color: #6699cc;">@Nullable</span>
    <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #f99157;">getObjectType</span><span style="color: #d8241f;">()</span>;

    <span style="color: #99cc99;">default</span> <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isSingleton</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">true</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ol class="org-ol">
<li><code>getObject(...)</code> 方法返回 FactoryBean 创建的实例，也称工厂方法</li>
<li><code>getObjectType(...)</code> 方法返回 FactoryBean 创建的实例的类型</li>
<li><code>isSingleton(...)</code> 方法返回 FactoryBean 创建的实例的 Scope</li>
</ol>
</div>
</div>

<div id="outline-container-orgd318143" class="outline-3">
<h3 id="orgd318143"><span class="section-number-3">3.4</span> 单例 Bean 工厂的实现</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-orgf33cafb" class="outline-4">
<h4 id="orgf33cafb"><span class="section-number-4">3.4.1</span> 单例 Bean 工厂的三级缓存: <code>DefaultSingletonBeanRegistry</code> 类的缓存</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
<code>DefaultSingletonBeanRegistry</code> 是对单例 Bean 注册的实现类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultSingletonBeanRegistry

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry

    All Implemented Interfaces:
        SingletonBeanRegistry, org.springframework.core.AliasRegistry
</pre>
</div>

<p>
<code>DefaultSingletonBeanRegistry</code> 定义了如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/** Cache of singleton objects: bean name to bean instance. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">singletonObjects</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Cache of singleton factories: bean name to ObjectFactory. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">ObjectFactory</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">singletonFactories</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">HashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Cache of early singleton objects: bean name to bean instance. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">earlySingletonObjects</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">HashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Set of registered singletons, containing the bean names in registration order. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">registeredSingletons</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LinkedHashSet</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Names of beans that are currently in creation. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">singletonsCurrentlyInCreation</span> =
        Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>16<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Names of beans currently excluded from in creation checks. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">inCreationCheckExclusions</span> =
        Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>16<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** List of suppressed Exceptions, available for associating related causes. */</span>
<span style="color: #6699cc;">@Nullable</span>
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">Exception</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">suppressedExceptions</span>;

<span style="color: #cc99cc;">/** Flag that indicates whether we're currently within destroySingletons. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">singletonsCurrentlyInDestruction</span> = <span style="color: #6699cc;">false</span>;

<span style="color: #cc99cc;">/** Disposable bean instances: bean name to disposable instance. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">disposableBeans</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LinkedHashMap</span><span style="color: #8d5649;">&lt;&gt;()</span>;

<span style="color: #cc99cc;">/** Map between containing bean names: bean name to Set of bean names that the bean contains. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">containedBeanMap</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Map between dependent bean names: bean name to Set of dependent bean names. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">dependentBeanMap</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #cc99cc;">/** Map between depending bean names: bean name to Set of bean names for the bean's dependencies. */</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">String</span>, <span style="color: #6699cc;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #ffcc66;">dependenciesForBeanMap</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;
</pre>
</div>
<p>
这里需要注意的是其定义的三级缓存结构
</p>
<ol class="org-ol">
<li>singletonObjects: 一级缓存单例 Bean 对象</li>
<li>earlySingletonObjects: 二级缓存早期创建的单例 Bean 对象
<ul class="org-ul">
<li>earlySingletonObjects 于 singletonObjects 不同之处是，当一个单例 Bean
还在创建过程中可以将其依赖的单例 Bean 放入 earlySingletonObjects 哈希表
内</li>
<li>这样做，即使单例 Bean 在创建过程中，调用 <code>getBean(...)</code> 方法依然可以获
取到所依赖的 Bean 对象</li>
<li>另外该方案用来循环检测，避免循环依赖</li>
</ul></li>
<li><p>
singletonFactories: 三级缓存单例对象工厂 ObjectFactory
</p>
<ul class="org-ul">
<li>singletonFactories 哈希表的值是 <code>ObjectFactory</code> 接口类型</li>
<li><code>ObjectFactory</code> 是个函数式接口，用于延迟创建 Bean</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@FunctionalInterface</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">ObjectFactory</span><span style="color: #8d5649;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>

    <span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;">     * Return an instance (possibly shared or independent)</span>
<span style="color: #cc99cc;">     * of the object managed by this factory.</span>
<span style="color: #cc99cc;">     * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> the resulting instance</span>
<span style="color: #cc99cc;">     * </span><span style="color: #6699cc;">@throws</span><span style="color: #cc99cc;"> BeansException in case of creation errors</span>
<span style="color: #cc99cc;">     */</span>
    <span style="color: #6699cc;">T</span> <span style="color: #f99157;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;

<span style="color: #8d5649;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-org517aadd" class="outline-4">
<h4 id="org517aadd"><span class="section-number-4">3.4.2</span> 获取单例 Bean 方法: <code>getSingleton(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
<code>getSingleton()</code> 方法是获取 Bean 的核心方法, 它的实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#33719;&#21462;&#21333;&#20363;&#65292;&#21487;&#20197;&#20174; earlySingletonObjects &#20013;&#33719;&#21462;</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">return</span> getSingleton<span style="color: #d8241f;">(</span>beanName, <span style="color: #6699cc;">true</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#33719;&#21462;&#21333;&#20363;&#65292;&#28155;&#21152;&#26159;&#21542;&#21487;&#20197;&#20174; earlySingletonObjects &#20013;&#33719;&#21462;&#21442;&#25968;</span>
<span style="color: #6699cc;">@Nullable</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">allowEarlyReference</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">singletonObject</span> = <span style="color: #99cc99;">this</span>.singletonObjects.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>singletonObject == <span style="color: #6699cc;">null</span> &amp;&amp; isSingletonCurrentlyInCreation<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.singletonObjects<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            singletonObject = <span style="color: #99cc99;">this</span>.earlySingletonObjects.get<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>singletonObject == <span style="color: #6699cc;">null</span> &amp;&amp; allowEarlyReference<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #6699cc;">ObjectFactory</span><span style="color: #ff7f00;">&lt;</span>?<span style="color: #ff7f00;">&gt;</span> <span style="color: #ffcc66;">singletonFactory</span> = <span style="color: #99cc99;">this</span>.singletonFactories.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>singletonFactory != <span style="color: #6699cc;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    singletonObject = singletonFactory.getObject<span style="color: #1776b6;">()</span>;
                    <span style="color: #99cc99;">this</span>.earlySingletonObjects.put<span style="color: #1776b6;">(</span>beanName, singletonObject<span style="color: #1776b6;">)</span>;
                    <span style="color: #99cc99;">this</span>.singletonFactories.remove<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> singletonObject;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
允许从 earlySingletonObjects 获取单例的 <code>getSingleton(...)</code> 方法逻辑比较清晰
</p>
<ol class="org-ol">
<li>先尝试从 singletonObjects 中获取 singletonObject, 如果成功直接返回
singletonObject</li>
<li>如果获取失败，则尝试从 earlySingletonObjects 中获取 singletonObject, 如果
成功直接返回 singletonObject</li>
<li>如果再次失败，尝试从 singletonFactories 中创建 singletonObject，并返回创
建结果
<ul class="org-ul">
<li>首先通过 beanName, 查找到 <code>ObjectFactory</code> 的值, 即 singletonFactory</li>
<li>若 singletonFactory 存在，调用 <code>singletonFactory.getObject(...)</code> 方法创
建 singletonObject</li>
<li>创建成功将 singletonObject, 将 singletonObject 添加到
earlySingletonObjects, 并从 singletonFactories 移除 beanName 对应的值</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#33719;&#21462;&#21333;&#20363;&#65292;&#20027;&#35201;&#38024;&#23545;&#26410;&#21019;&#24314;&#30340; Bean &#23545;&#35937;&#65292;&#36890;&#36807; ObjectFactory &#21019;&#24314;&#23545;&#35937;&#24182;&#36820;&#22238;</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">ObjectFactory</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">singletonFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>beanName, <span style="color: #66cccc;">"Bean name must not be null"</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.singletonObjects<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">singletonObject</span> = <span style="color: #99cc99;">this</span>.singletonObjects.get<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>singletonObject == <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span><span style="color: #99cc99;">this</span>.singletonsCurrentlyInDestruction<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationNotAllowedException</span><span style="color: #ff7f00;">(</span>beanName,
                        <span style="color: #66cccc;">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +
                        <span style="color: #66cccc;">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Creating shared instance of singleton bean '"</span> + beanName + <span style="color: #66cccc;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            beforeSingletonCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">newSingleton</span> = <span style="color: #6699cc;">false</span>;
            <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">recordSuppressedExceptions</span> = <span style="color: #24a222;">(</span><span style="color: #99cc99;">this</span>.suppressedExceptions == <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>recordSuppressedExceptions<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">this</span>.suppressedExceptions = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LinkedHashSet</span><span style="color: #ff7f00;">&lt;&gt;()</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">try</span> <span style="color: #24a222;">{</span>
                singletonObject = singletonFactory.getObject<span style="color: #ff7f00;">()</span>;
                newSingleton = <span style="color: #6699cc;">true</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">catch</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">IllegalStateException</span> <span style="color: #ffcc66;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Has the singleton object implicitly appeared in the meantime -&gt;</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">if yes, proceed with it since the exception indicates that state.</span>
                singletonObject = <span style="color: #99cc99;">this</span>.singletonObjects.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>singletonObject == <span style="color: #6699cc;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">throw</span> ex;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">catch</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">BeanCreationException</span> <span style="color: #ffcc66;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>recordSuppressedExceptions<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">for</span> <span style="color: #1776b6;">(</span><span style="color: #6699cc;">Exception</span> <span style="color: #ffcc66;">suppressedException</span> : <span style="color: #99cc99;">this</span>.suppressedExceptions<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        ex.addRelatedCause<span style="color: #00bed1;">(</span>suppressedException<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">throw</span> ex;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">finally</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>recordSuppressedExceptions<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">this</span>.suppressedExceptions = <span style="color: #6699cc;">null</span>;
                <span style="color: #ff7f00;">}</span>
                afterSingletonCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>newSingleton<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                addSingleton<span style="color: #ff7f00;">(</span>beanName, singletonObject<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">return</span> singletonObject;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
获取单例 Bean 的总逻辑逻辑如下
</p>
<ol class="org-ol">
<li>首先尝试从 singletonObjects 获取 singletonObject, 获取成功直接返回
singletonObject</li>
<li>如果 singletonObjects 获取失败，则需要创建 singletonObject
<ul class="org-ul">
<li>先调用 <code>beforeSingletonCreation(...)</code> 前置钩子函数</li>
<li>调用 <code>ObjectFactory</code> 的 <code>getObject(...)</code> 方法来创建 singletonObject</li>
<li>然后调用 <code>afterSingletonCreation(...)</code> 后置钩子函数</li>
<li><p>
如果有信创建的 singletonObject, 调用 <code>addSingleton(...)</code> 来处理添加新创
建 singletonObject
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">addSingleton</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">singletonObject</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.singletonObjects<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.singletonObjects.put<span style="color: #9564bf;">(</span>beanName, singletonObject<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.singletonFactories.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.earlySingletonObjects.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.registeredSingletons.add<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ul class="org-ul">
<li><code>addSingleton(...)</code> 将新创建的 singletonObject 放入 singletonObjects,
并从 singletonFactories 和 earlySingletonObjects 中移除
singletonObject 对象</li>
<li>将 singletonObject 添加到 registeredSingletons 中，完成 Bean 的注册</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org99cd70c" class="outline-4">
<h4 id="org99cd70c"><span class="section-number-4">3.4.3</span> beanInstance 到 beanOject 过程: <code>getObjectForBeanInstance(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
beanInstance -&gt; beanOject 是将缓存中的 Bean 实例转化成最终用户所需对象的过程，
</p>
<ol class="org-ol">
<li>在 <code>doGetBean(...)</code> 方法中的 <code>getObjectForBeanInstance(...)</code> 方法实现</li>
<li>beanInstance 如果是非 FactoryBean, beanInstance 即为 beanOject, 直接返回
创建好的 Bean 对象</li>
<li>beanInstance 如果是 FactoryBean, 需要调用工厂方法进行处理，创建 beanOject
<ul class="org-ul">
<li>先调用 <code>getCachedObjectForFactoryBean(...)</code> 从缓存中获取，获取成功直接
返回结果</li>
<li>如果未获取成功，调用 <code>getObjectFromFactoryBean(...)</code> 创建 beanOject</li>
<li>最终通过 <code>doGetObjectFromFactoryBean(...)</code> 完成调用工厂方法并获取
beanObject 逻辑</li>
</ul></li>
</ol>

<p>
这里分析一下 <code>doGetObjectFromFactoryBean(...)</code> 的逻辑，先查看一下调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">doGetObjectFromFactoryBean:161, FactoryBeanRegistrySupport (org.springframework.beans.factory.support)
getObjectFromFactoryBean:101, FactoryBeanRegistrySupport (org.springframework.beans.factory.support)
getObjectForBeanInstance:1818, AbstractBeanFactory (org.springframework.beans.factory.support)
getObjectForBeanInstance:1266, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doGetBean:260, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:1108, AbstractApplicationContext (org.springframework.context.support)
main:25, MyApp04 (io.github.jeanhwea.app04_factory_bean)
</pre>
</div>

<p>
<code>doGetObjectFromFactoryBean(...)</code> 方法逻辑如下，可以看出在进行了一些校验工作，
最终调用 <code>factory.getObject()</code> 方法获取 beanObject
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Obtain an object to expose from the given FactoryBean.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> factory the FactoryBean instance</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> the object obtained from the FactoryBean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@throws</span><span style="color: #cc99cc;"> BeanCreationException if FactoryBean object creation failed</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> org.springframework.beans.factory.FactoryBean#getObject()</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">private</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">doGetObjectFromFactoryBean</span><span style="color: #8d5649;">(</span><span style="color: #99cc99;">final</span> <span style="color: #6699cc;">FactoryBean</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">factory</span>, <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span>
        <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">object</span>;
    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">AccessControlContext</span> <span style="color: #ffcc66;">acc</span> = getAccessControlContext<span style="color: #24a222;">()</span>;
            <span style="color: #99cc99;">try</span> <span style="color: #24a222;">{</span>
                object = AccessController.doPrivileged<span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #6699cc;">PrivilegedExceptionAction</span><span style="color: #00bed1;">&lt;</span><span style="color: #6699cc;">Object</span><span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> factory::getObject, acc<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">catch</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">PrivilegedActionException</span> <span style="color: #ffcc66;">pae</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">throw</span> pae.getException<span style="color: #ff7f00;">()</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            object = factory.getObject<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">FactoryBeanNotInitializedException</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCurrentlyInCreationException</span><span style="color: #9564bf;">(</span>beanName, ex.toString<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #9564bf;">(</span>beanName, <span style="color: #66cccc;">"FactoryBean threw exception on object creation"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Do not accept a null value for a FactoryBean that's not fully</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">initialized yet: Many FactoryBeans just return null then.</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>object == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>isSingletonCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>
                    beanName, <span style="color: #66cccc;">"FactoryBean which is currently in creation returned null from getObject"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        object = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">NullBean</span><span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> object;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
往上跳一级，查看 <code>FactoryBeanRegistrySupport#getObjectFromFactoryBean(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Obtain an object to expose from the given FactoryBean.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> factory the FactoryBean instance</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> shouldPostProcess whether the bean is subject to post-processing</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> the object obtained from the FactoryBean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@throws</span><span style="color: #cc99cc;"> BeanCreationException if FactoryBean object creation failed</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> org.springframework.beans.factory.FactoryBean#getObject()</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">getObjectFromFactoryBean</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">FactoryBean</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">factory</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">shouldPostProcess</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>factory.isSingleton<span style="color: #9564bf;">()</span> &amp;&amp; containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">synchronized</span> <span style="color: #9564bf;">(</span>getSingletonMutex<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">object</span> = <span style="color: #99cc99;">this</span>.factoryBeanObjectCache.get<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>object == <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                object = doGetObjectFromFactoryBean<span style="color: #ff7f00;">(</span>factory, beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Only post-process and store if not put there already during getObject() call above</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">(e.g. because of circular reference processing triggered by custom getBean calls)</span>
                <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">alreadyThere</span> = <span style="color: #99cc99;">this</span>.factoryBeanObjectCache.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>alreadyThere != <span style="color: #6699cc;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    object = alreadyThere;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">else</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span>shouldPostProcess<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #99cc99;">if</span> <span style="color: #00bed1;">(</span>isSingletonCurrentlyInCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Temporarily return non-post-processed object, not storing it yet..</span>
                            <span style="color: #99cc99;">return</span> object;
                        <span style="color: #00bed1;">}</span>
                        beforeSingletonCreation<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span>;
                        <span style="color: #99cc99;">try</span> <span style="color: #00bed1;">{</span>
                            object = postProcessObjectFromFactoryBean<span style="color: #bcbf00;">(</span>object, beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #99cc99;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #bcbf00;">(</span>beanName,
                                    <span style="color: #66cccc;">"Post-processing of FactoryBean's singleton object failed"</span>, ex<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #99cc99;">finally</span> <span style="color: #00bed1;">{</span>
                            afterSingletonCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span>containsSingleton<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #99cc99;">this</span>.factoryBeanObjectCache.put<span style="color: #00bed1;">(</span>beanName, object<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">return</span> object;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">object</span> = doGetObjectFromFactoryBean<span style="color: #9564bf;">(</span>factory, beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>shouldPostProcess<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">try</span> <span style="color: #24a222;">{</span>
                object = postProcessObjectFromFactoryBean<span style="color: #ff7f00;">(</span>object, beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">catch</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #ff7f00;">(</span>beanName, <span style="color: #66cccc;">"Post-processing of FactoryBean's object failed"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">return</span> object;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>getObjectFromFactoryBean</code> 实现了获取 FactoryBean 的 beanObject 的业务逻辑
</p>
<ol class="org-ol">
<li>如果是非单例 FactoryBean，在最外层的 else 代码，直接创建 beanObject</li>
<li>如果是单例 FactoryBean
<ul class="org-ul">
<li>首先获取单例缓存池 singletonObjects 的互斥锁</li>
<li>尝试从 factoryBeanObjectCache 缓存中获取创建好的 beanObject, 如果成功
直接返回结果</li>
<li>如果缓存获取失败，则需要调用 <code>doGetObjectFromFactoryBean(...)</code> 方法创
建 beanObject，并将创建好的 beanObject 放入 factoryBeanObjectCache 缓
存中</li>
</ul></li>
<li>在上述两种情况过后都需要调用 <code>postProcessObjectFromFactoryBean(...)</code> 方法
<ul class="org-ul">
<li><code>postProcessObjectFromFactoryBean(...)</code> 是一个空方法</li>
<li>这样设计是为子类提供扩展点</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgf1fbbf9" class="outline-3">
<h3 id="orgf1fbbf9"><span class="section-number-3">3.5</span> Bean 生命周期的实现</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-orgaee7135" class="outline-4">
<h4 id="orgaee7135"><span class="section-number-4">3.5.1</span> Bean 创建的实现类: <code>AbstractAutowireCapableBeanFactory</code></h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
先看 <code>AbstractAutowireCapableBeanFactory</code> 的类继承关系
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class AbstractAutowireCapableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory

    All Implemented Interfaces:
        BeanFactory, AutowireCapableBeanFactory, ConfigurableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory,
        org.springframework.core.AliasRegistry
</pre>
</div>
<ol class="org-ol">
<li><code>AbstractAutowireCapableBeanFactory</code> 实现了 <code>AutowireCapableBeanFactory</code> 接口</li>
<li><p>
<code>AutowireCapableBeanFactory</code> 中有管理 Autowire 功能 Bean 的方法
</p>
<ul class="org-ul">
<li><code>createBean(...)</code> 实例化 Bean</li>
<li><code>initializeBean(...)</code> 初始化 Bean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
<li>还有一些 Bean 的 <code>*PostProcessor*</code> 的增强函数</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">AutowireCapableBeanFactory</span> <span style="color: #99cc99;">extends</span> <span style="color: #6699cc;">BeanFactory</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Typical methods for creating and populating external bean instances</span>
    <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> T createBean<span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">beanClass</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">void</span> <span style="color: #f99157;">autowireBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">configureBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;

    <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Specialized methods for fine-grained control over the bean lifecycle</span>
    <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">createBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">beanClass</span>, <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">autowireMode</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">dependencyCheck</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">autowire</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">beanClass</span>, <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">autowireMode</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">dependencyCheck</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">void</span> <span style="color: #f99157;">autowireBeanProperties</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span>, <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">autowireMode</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">dependencyCheck</span><span style="color: #d8241f;">)</span>
            <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">void</span> <span style="color: #f99157;">applyBeanPropertyValues</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">initializeBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">applyBeanPostProcessorsBeforeInitialization</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #d8241f;">)</span>
            <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">applyBeanPostProcessorsAfterInitialization</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #d8241f;">)</span>
            <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">void</span> <span style="color: #f99157;">destroyBean</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">existingBean</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Delegate methods for resolving injection points</span>
    <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6699cc;">NamedBeanHolder</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #d8241f;">&gt;</span> resolveNamedBean<span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">resolveBeanByName</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">name</span>, <span style="color: #6699cc;">DependencyDescriptor</span> <span style="color: #ffcc66;">descriptor</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">@Nullable</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">resolveDependency</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">DependencyDescriptor</span> <span style="color: #ffcc66;">descriptor</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">requestingBeanName</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
    <span style="color: #6699cc;">@Nullable</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">resolveDependency</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">DependencyDescriptor</span> <span style="color: #ffcc66;">descriptor</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">requestingBeanName</span>,
            <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Set</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">autowiredBeanNames</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">TypeConverter</span> <span style="color: #ffcc66;">typeConverter</span><span style="color: #d8241f;">)</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-orgdd4a229" class="outline-4">
<h4 id="orgdd4a229"><span class="section-number-4">3.5.2</span> Bean 的实例化: <code>createBean(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
实际实例化 Bean 是在 <code>doCreateBean(...)</code> 方法中完成的，先准备一下调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">doCreateBean:552, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1989335500 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:21, MyApp04 (io.github.jeanhwea.app04_factory_bean)
</pre>
</div>

<p>
<code>createBean(...)</code> 方法实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Central method of this class: creates a bean instance,</span>
<span style="color: #cc99cc;"> * populates the bean instance, applies post-processors, etc.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #doCreateBean</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">createBean</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">args</span><span style="color: #8d5649;">)</span>
        <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"Creating instance of bean '"</span> + beanName + <span style="color: #66cccc;">"'"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbdToUse</span> = mbd;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Make sure bean class is actually resolved at this point, and</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">clone the bean definition in case of a dynamically resolved Class</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">which cannot be stored in the shared merged bean definition.</span>
    <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">resolvedClass</span> = resolveBeanClass<span style="color: #d8241f;">(</span>mbd, beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>resolvedClass != <span style="color: #6699cc;">null</span> &amp;&amp; <span style="color: #6699cc;">!</span>mbd.hasBeanClass<span style="color: #9564bf;">()</span> &amp;&amp; mbd.getBeanClassName<span style="color: #9564bf;">()</span> != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        mbdToUse = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">RootBeanDefinition</span><span style="color: #9564bf;">(</span>mbd<span style="color: #9564bf;">)</span>;
        mbdToUse.setBeanClass<span style="color: #9564bf;">(</span>resolvedClass<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Prepare method overrides.</span>
    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        mbdToUse.prepareMethodOverrides<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">BeanDefinitionValidationException</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>,
                beanName, <span style="color: #66cccc;">"Validation of method overrides failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span> = resolveBeforeInstantiation<span style="color: #9564bf;">(</span>beanName, mbdToUse<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>bean != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">return</span> bean;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #9564bf;">(</span>mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>, beanName,
                <span style="color: #66cccc;">"BeanPostProcessor before instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">beanInstance</span> = doCreateBean<span style="color: #9564bf;">(</span>beanName, mbdToUse, args<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Finished creating instance of bean '"</span> + beanName + <span style="color: #66cccc;">"'"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">return</span> beanInstance;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span>BeanCreationException | ImplicitlyAppearedSingletonException ex<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">A previously detected exception with proper bean creation context already,</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
        <span style="color: #99cc99;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #66cccc;">"Unexpected exception during bean creation"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>

</pre>
</div>
<p>
该方法的流程如下
</p>
<ol class="org-ol">
<li>通过 BeanDefinition 和 beanName 解析获取到待创建的类 resolvedClass</li>
<li>对 override 属性进行标记及验证
<ul class="org-ul">
<li><code>lookup-method</code>, <code>replace-method</code> 等</li>
</ul></li>
<li>处理 BeanPostProcessors, 进行一些前置处理工作
<ul class="org-ul">
<li><p>
<code>resolveBeforeInstantiation(...)</code> 方法完成前置处理工作
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Apply before-instantiation post-processors, resolving whether there is a</span>
<span style="color: #cc99cc;"> * before-instantiation shortcut for the specified bean.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> mbd the bean definition for the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> the shortcut-determined bean instance, or </span><span style="color: #6699cc;">{@code null}</span><span style="color: #cc99cc;"> if none</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@Nullable</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">resolveBeforeInstantiation</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span> = <span style="color: #6699cc;">null</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span><span style="color: #6699cc;">Boolean</span>.FALSE.equals<span style="color: #9564bf;">(</span>mbd.beforeInstantiationResolved<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Make sure bean class is actually resolved at this point.</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>mbd.isSynthetic<span style="color: #24a222;">()</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">Class</span><span style="color: #24a222;">&lt;</span>?<span style="color: #24a222;">&gt;</span> <span style="color: #ffcc66;">targetType</span> = determineTargetType<span style="color: #24a222;">(</span>beanName, mbd<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>targetType != <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                bean = applyBeanPostProcessorsBeforeInstantiation<span style="color: #ff7f00;">(</span>targetType, beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>bean != <span style="color: #6699cc;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    bean = applyBeanPostProcessorsAfterInitialization<span style="color: #1776b6;">(</span>bean, beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        mbd.beforeInstantiationResolved = <span style="color: #9564bf;">(</span>bean != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li><code>applyBeanPostProcessorsBeforeInstantiation(...)</code> 方法在实例化前调用</li>
<li><code>applyBeanPostProcessorsAfterInitialization(...)</code> 方法在初始化后调用</li>
</ul></li>
<li>调用 <code>doCreateBean(...)</code> 创建 Bean 实例 beanInstance, 并返回 beanInstance</li>
</ol>

<p>
<code>doCreateBean(...)</code> 方法实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Actually create the specified bean. Pre-creation processing has already happened</span>
<span style="color: #cc99cc;"> * at this point, e.g. checking </span><span style="color: #6699cc;">{@code postProcessBeforeInstantiation}</span><span style="color: #cc99cc;"> callbacks.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">&lt;p&gt;</span><span style="color: #cc99cc;">Differentiates between default bean instantiation, use of a</span>
<span style="color: #cc99cc;"> * factory method, and autowiring a constructor.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> mbd the merged bean definition for the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> args explicit arguments to use for constructor or factory method invocation</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> a new instance of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@throws</span><span style="color: #cc99cc;"> BeanCreationException if the bean could not be created</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #instantiateBean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #instantiateUsingFactoryMethod</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #autowireConstructor</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">doCreateBean</span><span style="color: #8d5649;">(</span><span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span>, <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">args</span><span style="color: #8d5649;">)</span>
        <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Instantiate the bean.</span>
    <span style="color: #6699cc;">BeanWrapper</span> <span style="color: #ffcc66;">instanceWrapper</span> = <span style="color: #6699cc;">null</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>mbd.isSingleton<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        instanceWrapper = <span style="color: #99cc99;">this</span>.factoryBeanInstanceCache.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>instanceWrapper == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        instanceWrapper = createBeanInstance<span style="color: #9564bf;">(</span>beanName, mbd, args<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span> = instanceWrapper.getWrappedInstance<span style="color: #d8241f;">()</span>;
    <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">beanType</span> = instanceWrapper.getWrappedClass<span style="color: #d8241f;">()</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanType != NullBean.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        mbd.resolvedTargetType = beanType;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Allow post-processors to modify the merged bean definition.</span>
    <span style="color: #99cc99;">synchronized</span> <span style="color: #d8241f;">(</span>mbd.postProcessingLock<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>mbd.postProcessed<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">try</span> <span style="color: #24a222;">{</span>
                applyMergedBeanDefinitionPostProcessors<span style="color: #ff7f00;">(</span>mbd, beanType, beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">catch</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #ff7f00;">(</span>mbd.getResourceDescription<span style="color: #1776b6;">()</span>, beanName,
                        <span style="color: #66cccc;">"Post-processing of merged bean definition failed"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            mbd.postProcessed = <span style="color: #6699cc;">true</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Eagerly cache singletons to be able to resolve circular references</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
    <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">earlySingletonExposure</span> = <span style="color: #d8241f;">(</span>mbd.isSingleton<span style="color: #9564bf;">()</span> &amp;&amp; <span style="color: #99cc99;">this</span>.allowCircularReferences &amp;&amp;
            isSingletonCurrentlyInCreation<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>earlySingletonExposure<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Eagerly caching bean '"</span> + beanName +
                    <span style="color: #66cccc;">"' to allow for resolving potential circular references"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        addSingletonFactory<span style="color: #9564bf;">(</span>beanName, <span style="color: #24a222;">()</span> -&gt; getEarlyBeanReference<span style="color: #24a222;">(</span>beanName, mbd, bean<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize the bean instance.</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">exposedObject</span> = bean;
    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        populateBean<span style="color: #9564bf;">(</span>beanName, mbd, instanceWrapper<span style="color: #9564bf;">)</span>;
        exposedObject = initializeBean<span style="color: #9564bf;">(</span>beanName, exposedObject, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>ex <span style="color: #99cc99;">instanceof</span> BeanCreationException &amp;&amp; beanName.equals<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #6699cc;">BeanCreationException</span><span style="color: #1776b6;">)</span> ex<span style="color: #ff7f00;">)</span>.getBeanName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">BeanCreationException</span><span style="color: #24a222;">)</span> ex;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #24a222;">(</span>
                    mbd.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName, <span style="color: #66cccc;">"Initialization of bean failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>earlySingletonExposure<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">earlySingletonReference</span> = getSingleton<span style="color: #9564bf;">(</span>beanName, <span style="color: #6699cc;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>earlySingletonReference != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>exposedObject == bean<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                exposedObject = earlySingletonReference;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">!</span><span style="color: #99cc99;">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #6699cc;">String</span><span style="color: #ff7f00;">[]</span> <span style="color: #ffcc66;">dependentBeans</span> = getDependentBeans<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #6699cc;">Set</span><span style="color: #ff7f00;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #ffcc66;">actualDependentBeans</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LinkedHashSet</span><span style="color: #ff7f00;">&lt;&gt;(</span>dependentBeans.length<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">dependentBean</span> : dependentBeans<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span><span style="color: #6699cc;">!</span>removeSingletonIfCreatedForTypeCheckOnly<span style="color: #00bed1;">(</span>dependentBean<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        actualDependentBeans.add<span style="color: #00bed1;">(</span>dependentBean<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">!</span>actualDependentBeans.isEmpty<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCurrentlyInCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #66cccc;">"Bean with name '"</span> + beanName + <span style="color: #66cccc;">"' has been injected into other beans ["</span> +
                            StringUtils.collectionToCommaDelimitedString<span style="color: #00bed1;">(</span>actualDependentBeans<span style="color: #00bed1;">)</span> +
                            <span style="color: #66cccc;">"] in its raw version as part of a circular reference, but has eventually been "</span> +
                            <span style="color: #66cccc;">"wrapped. This means that said other beans do not use the final version of the "</span> +
                            <span style="color: #66cccc;">"bean. This is often the result of over-eager type matching - consider using "</span> +
                            <span style="color: #66cccc;">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register bean as disposable.</span>
    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        registerDisposableBeanIfNecessary<span style="color: #9564bf;">(</span>beanName, bean, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">BeanDefinitionValidationException</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #66cccc;">"Invalid destruction signature"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">return</span> exposedObject;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法实现流程如下
</p>
<ol class="org-ol">
<li>如果是单例 Bean, 首先清理缓存</li>
<li>通过 <code>createBeanInstance(...)</code> 方法将 BeanDefinition 转化成 BeanWrapper,
BeanWrapper 的作用如下
<ul class="org-ul">
<li>如果检测到 Supplier, 使用 Supplier 进行实例化，具体实现见
<code>obtainFromSupplier(...)</code> 方法</li>
<li>如果存在工厂方法, 则使用工厂方法进行实例化, 具体实现见
<code>instantiateUsingFactoryMethod(...)</code></li>
<li>如果包含多参数构造器，根据参数类型锁定的构造方法，然后调用进行实例化，具
体实现见 <code>autowireConstructor(...)</code> 方法</li>
<li>其它情况使用无参构造器进行实例化, 具体实现见 <code>instantiateBean(...)</code> 方法</li>
</ul></li>
<li>允许后置处理器合并 BeanDefinition</li>
<li>解决依赖，若有依赖项调用 <code>addSingletonFactory(...)</code> 添加到
singletonFactories 缓存中</li>
<li>调用 <code>populateBean(...)</code> 方法进行属性填充</li>
<li>调用 <code>initializeBean(...)</code> 方法进行初始化</li>
<li>循环依赖检测
<ul class="org-ul">
<li>只检测单例 Bean 的循环依赖</li>
<li>原型 Bean 的循环检测很难做到，Spring 做法是直接抛出异常</li>
</ul></li>
<li>注册 DisposableBean
<ul class="org-ul">
<li>便于 destroy-method 在 Bean 销毁时调用</li>
</ul></li>
<li>完成创建并返回</li>
</ol>
</div>
</div>

<div id="outline-container-orgd5de475" class="outline-4">
<h4 id="orgd5de475"><span class="section-number-4">3.5.3</span> Bean 的初始化: <code>initializeBean(...)</code> 方法</h4>
<div class="outline-text-4" id="text-3-5-3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Initialize the given bean instance, applying factory callbacks</span>
<span style="color: #cc99cc;"> * as well as init methods and bean post processors.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">&lt;p&gt;</span><span style="color: #cc99cc;">Called from </span><span style="color: #6699cc;">{@link #createBean}</span><span style="color: #cc99cc;"> for traditionally defined beans,</span>
<span style="color: #cc99cc;"> * and from </span><span style="color: #6699cc;">{@link #initializeBean}</span><span style="color: #cc99cc;"> for existing bean instances.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the bean name in the factory (for debugging purposes)</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> bean the new bean instance we may need to initialize</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> mbd the bean definition that the bean was created with</span>
<span style="color: #cc99cc;"> * (can also be </span><span style="color: #6699cc;">{@code null}</span><span style="color: #cc99cc;">, if given an existing bean instance)</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> the initialized bean instance (potentially wrapped)</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> BeanNameAware</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> BeanClassLoaderAware</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> BeanFactoryAware</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #applyBeanPostProcessorsBeforeInitialization</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #invokeInitMethods</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #applyBeanPostProcessorsAfterInitialization</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">initializeBean</span><span style="color: #8d5649;">(</span><span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>System.getSecurityManager<span style="color: #9564bf;">()</span> != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AccessController.doPrivileged<span style="color: #9564bf;">(</span><span style="color: #24a222;">(</span><span style="color: #6699cc;">PrivilegedAction</span><span style="color: #ff7f00;">&lt;</span><span style="color: #6699cc;">Object</span><span style="color: #ff7f00;">&gt;</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">()</span> -&gt; <span style="color: #24a222;">{</span>
            invokeAwareMethods<span style="color: #ff7f00;">(</span>beanName, bean<span style="color: #ff7f00;">)</span>;
            <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
        <span style="color: #24a222;">}</span>, getAccessControlContext<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        invokeAwareMethods<span style="color: #9564bf;">(</span>beanName, bean<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">wrappedBean</span> = bean;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>mbd == <span style="color: #6699cc;">null</span> || <span style="color: #6699cc;">!</span>mbd.isSynthetic<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        wrappedBean = applyBeanPostProcessorsBeforeInitialization<span style="color: #9564bf;">(</span>wrappedBean, beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        invokeInitMethods<span style="color: #9564bf;">(</span>beanName, wrappedBean, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                <span style="color: #24a222;">(</span>mbd != <span style="color: #6699cc;">null</span> ? mbd.getResourceDescription<span style="color: #ff7f00;">()</span> : <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span>,
                beanName, <span style="color: #66cccc;">"Invocation of init method failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>mbd == <span style="color: #6699cc;">null</span> || <span style="color: #6699cc;">!</span>mbd.isSynthetic<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        wrappedBean = applyBeanPostProcessorsAfterInitialization<span style="color: #9564bf;">(</span>wrappedBean, beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">return</span> wrappedBean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法用于初始化 Bean，它完成了如下工作
</p>
<ol class="org-ol">
<li>调用 Aware 方法，例如
<ul class="org-ul">
<li>BeanFactoryAware</li>
<li>ApplicationContextAware</li>
<li>ResourceLoaderAware</li>
<li>ServletContextAware</li>
</ul></li>
<li>提供 BeanPostProcessor 的扩展点，环绕调用了如下两个钩子方法
<ul class="org-ul">
<li><code>applyBeanPostProcessorsBeforeInitialization(...)</code></li>
<li><code>applyBeanPostProcessorsAfterInitialization(...)</code></li>
</ul></li>
<li>调用自定义的初始化方法，及 init-method
<ul class="org-ul">
<li><code>invokeInitMethods(beanName, wrappedBean, mbd);</code></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orga43bb6f" class="outline-4">
<h4 id="orga43bb6f"><span class="section-number-4">3.5.4</span> Bean 的销毁</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
在 <code>doCreateBean(...)</code> 方法中调用了 <code>registerDisposableBeanIfNecessary(...)</code>
方法来提供 <code>destroy-method</code> 销毁的扩展
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Add the given bean to the list of disposable beans in this factory,</span>
<span style="color: #cc99cc;"> * registering its DisposableBean interface and/or the given destroy method</span>
<span style="color: #cc99cc;"> * to be called on factory shutdown (if applicable). Only applies to singletons.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> bean the bean instance</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> mbd the bean definition for the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> RootBeanDefinition#isSingleton</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> RootBeanDefinition#getDependsOn</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #registerDisposableBean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #registerDependentBean</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerDisposableBeanIfNecessary</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span>, <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">AccessControlContext</span> <span style="color: #ffcc66;">acc</span> = <span style="color: #d8241f;">(</span>System.getSecurityManager<span style="color: #9564bf;">()</span> != <span style="color: #6699cc;">null</span> ? getAccessControlContext<span style="color: #9564bf;">()</span> : <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>mbd.isPrototype<span style="color: #9564bf;">()</span> &amp;&amp; requiresDestruction<span style="color: #9564bf;">(</span>bean, mbd<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>mbd.isSingleton<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register a DisposableBean implementation that performs all destruction</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">work for the given bean: DestructionAwareBeanPostProcessors,</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">DisposableBean interface, custom destroy method.</span>
            registerDisposableBean<span style="color: #24a222;">(</span>beanName,
                    <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">DisposableBeanAdapter</span><span style="color: #ff7f00;">(</span>bean, beanName, mbd, getBeanPostProcessors<span style="color: #1776b6;">()</span>, acc<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">A bean with a custom scope...</span>
            <span style="color: #6699cc;">Scope</span> <span style="color: #ffcc66;">scope</span> = <span style="color: #99cc99;">this</span>.scopes.get<span style="color: #24a222;">(</span>mbd.getScope<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>scope == <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">IllegalStateException</span><span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"No Scope registered for scope name '"</span> + mbd.getScope<span style="color: #1776b6;">()</span> + <span style="color: #66cccc;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            scope.registerDestructionCallback<span style="color: #24a222;">(</span>beanName,
                    <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">DisposableBeanAdapter</span><span style="color: #ff7f00;">(</span>bean, beanName, mbd, getBeanPostProcessors<span style="color: #1776b6;">()</span>, acc<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org14b31b0" class="outline-2">
<h2 id="org14b31b0"><span class="section-number-2">4</span> 容器功能扩展</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org8d425b3" class="outline-3">
<h3 id="org8d425b3"><span class="section-number-3">4.1</span> 应用上下文: ApplicationContext</h3>
<div class="outline-text-3" id="text-4-1">
<p>
首先查看 <code>ApplicationContext</code> 接口的相关信息
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.context
Interface ApplicationContext

    All Superinterfaces:
        ApplicationEventPublisher,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.ListableBeanFactory, MessageSource,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>
<p>
可以看出 <code>ApplicationContext</code> 提供了所以 <code>BeanFactory</code> 的功能，另外还扩展了如
下功能
</p>
<ol class="org-ol">
<li><code>ResourceLoader</code> 加载资源文件</li>
<li><code>ApplicationEventPublisher</code> 事件发布和监听器注册</li>
<li><code>MessageSource</code> 国际化的消息支持</li>
<li><code>HierarchicalBeanFactory</code> 继承父的上下文功能</li>
<li><code>EnvironmentCapable</code> 系统环境变量和 Java 属性支持</li>
</ol>
</div>
</div>

<div id="outline-container-orgd5134cd" class="outline-3">
<h3 id="orgd5134cd"><span class="section-number-3">4.2</span> ApplicationContext 接口的常见实现类</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org50d57b8" class="outline-4">
<h4 id="org50d57b8"><span class="section-number-4">4.2.1</span> ClassPathXmlApplicationContext</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
读取 ClassPath 中 XML 配置文件的 Bean 定义的容器
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.context.support
Class ClassPathXmlApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.AbstractRefreshableApplicationContext
                    org.springframework.context.support.AbstractRefreshableConfigApplicationContext
                        org.springframework.context.support.AbstractXmlApplicationContext
                            org.springframework.context.support.ClassPathXmlApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable, org.springframework.beans.factory.Aware,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.BeanNameAware,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.InitializingBean,
        org.springframework.beans.factory.ListableBeanFactory,
        ApplicationContext, ApplicationEventPublisher,
        ConfigurableApplicationContext, Lifecycle, MessageSource,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
<code>ClassPathXmlApplicationContext</code> 的构造器的实现如下，该构造器实现逻辑比较清
晰，需要注意的是这里后面调用了刷新上下文的 <code>refresh()</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Create a new ClassPathXmlApplicationContext with the given parent,</span>
<span style="color: #cc99cc;"> * loading the definitions from the given XML files.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> configLocations array of resource locations</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> refresh whether to automatically refresh the context,</span>
<span style="color: #cc99cc;"> * loading all bean definitions and creating all singletons.</span>
<span style="color: #cc99cc;"> * Alternatively, call refresh manually after further configuring the context.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> parent the parent context</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@throws</span><span style="color: #cc99cc;"> BeansException if context creation failed</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #refresh()</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">public</span> <span style="color: #f99157;">ClassPathXmlApplicationContext</span><span style="color: #8d5649;">(</span>
        <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">configLocations</span>, <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">refresh</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">ApplicationContext</span> <span style="color: #ffcc66;">parent</span><span style="color: #8d5649;">)</span>
        <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #99cc99;">super</span><span style="color: #d8241f;">(</span>parent<span style="color: #d8241f;">)</span>;
    setConfigLocations<span style="color: #d8241f;">(</span>configLocations<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>refresh<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        refresh<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc635d87" class="outline-4">
<h4 id="orgc635d87"><span class="section-number-4">4.2.2</span> AnnotationConfigApplicationContext</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
读取注解类型 Bean 定义的容器, <code>@Component</code>, <code>@Service</code> 等
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.context.annotation
Class AnnotationConfigApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.GenericApplicationContext
                    org.springframework.context.annotation.AnnotationConfigApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.ListableBeanFactory,
        org.springframework.beans.factory.support.BeanDefinitionRegistry,
        AnnotationConfigRegistry, ApplicationContext,
        ApplicationEventPublisher, ConfigurableApplicationContext,
        Lifecycle, MessageSource, org.springframework.core.AliasRegistry,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
常见的类简单可以分成以下几类
</p>
<ol class="org-ol">
<li>资源处理
<ul class="org-ul">
<li><code>Resource</code> Spring 中关于资源的定义</li>
<li><code>ResourceLoader</code> 提供资源加载方法</li>
<li><code>BeanDefinitionReader</code> 读取接口主要用来读取信息</li>
</ul></li>
<li>注册形式，在 Spring 中关于注册的几个核心
<ul class="org-ul">
<li><code>AliasRegistry</code> 别名注册</li>
<li><code>BeanDefinitionRegistry</code> Bean 定义注册</li>
<li><code>SingletonBeanRegistry</code> 单例 Bean 注册
<ul class="org-ul">
<li><code>DefaultSingletonBeanRegistry</code></li>
</ul></li>
</ul></li>
<li>生命周期，可以分成容器生命周期和 Bean 生命周期两个小类
<ul class="org-ul">
<li><code>Lifecycle</code> 容器生命周期的核心接口</li>
<li><code>InitializingBean</code>, <code>DisposableBean</code> 等 Bean 的生命周期接口</li>
</ul></li>
<li>Bean 拓展
<ul class="org-ul">
<li><code>BeanPostProcessor</code></li>
<li><code>Aware</code> 系列接口</li>
</ul></li>
<li>上下文的接口:
<ul class="org-ul">
<li><code>ApplicationContext</code> 作为主导接口
<ul class="org-ul">
<li><code>AbstractApplicationContext</code></li>
</ul></li>
</ul></li>
</ol>

<p>
<code>AnnotationConfigApplicationContext</code> 的构造器的实现如下，扫描包过后，然后调
用了刷新上下文的 <code>refresh()</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Create a new AnnotationConfigApplicationContext, scanning for components</span>
<span style="color: #cc99cc;"> * in the given packages, registering bean definitions for those components,</span>
<span style="color: #cc99cc;"> * and automatically refreshing the context.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> basePackages the packages to scan for component classes</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">public</span> <span style="color: #f99157;">AnnotationConfigApplicationContext</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">String</span>... <span style="color: #ffcc66;">basePackages</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">this</span><span style="color: #d8241f;">()</span>;
    scan<span style="color: #d8241f;">(</span>basePackages<span style="color: #d8241f;">)</span>;
    refresh<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9142d3a" class="outline-3">
<h3 id="org9142d3a"><span class="section-number-3">4.3</span> 刷新应用上下文: <code>refresh()</code> 方法</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orge63eff0" class="outline-4">
<h4 id="orge63eff0"><span class="section-number-4">4.3.1</span> <code>refresh()</code> 方法总览</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
该 <code>refresh()</code> 方法实现了 Spring 的 Bean 管理的全周期的流程，其中调用了 15
个辅助方法，它的主要实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">refresh</span><span style="color: #8d5649;">()</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span>, <span style="color: #6699cc;">IllegalStateException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.startupShutdownMonitor<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Prepare this context for refreshing.</span>
        prepareRefresh<span style="color: #9564bf;">()</span>;

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Tell the subclass to refresh the internal bean factory.</span>
        <span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span> = obtainFreshBeanFactory<span style="color: #9564bf;">()</span>;

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Prepare the bean factory for use in this context.</span>
        prepareBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;

        <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Allows post-processing of the bean factory in context subclasses.</span>
            postProcessBeanFactory<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Invoke factory processors registered as beans in the context.</span>
            invokeBeanFactoryPostProcessors<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register bean processors that intercept bean creation.</span>
            registerBeanPostProcessors<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize message source for this context.</span>
            initMessageSource<span style="color: #24a222;">()</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize event multicaster for this context.</span>
            initApplicationEventMulticaster<span style="color: #24a222;">()</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize other special beans in specific context subclasses.</span>
            onRefresh<span style="color: #24a222;">()</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Check for listener beans and register them.</span>
            registerListeners<span style="color: #24a222;">()</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Instantiate all remaining (non-lazy-init) singletons.</span>
            finishBeanFactoryInitialization<span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Last step: publish corresponding event.</span>
            finishRefresh<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeansException</span> <span style="color: #ffcc66;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>logger.isWarnEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.warn<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"Exception encountered during context initialization - "</span> +
                        <span style="color: #66cccc;">"cancelling refresh attempt: "</span> + ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Destroy already created singletons to avoid dangling resources.</span>
            destroyBeans<span style="color: #24a222;">()</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Reset 'active' flag.</span>
            cancelRefresh<span style="color: #24a222;">(</span>ex<span style="color: #24a222;">)</span>;

            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Propagate exception to caller.</span>
            <span style="color: #99cc99;">throw</span> ex;
        <span style="color: #9564bf;">}</span>

        <span style="color: #99cc99;">finally</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Reset common introspection caches in Spring's core, since we</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">might not ever need metadata for singleton beans anymore...</span>
            resetCommonCaches<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
每个方法的解释如下
</p>
<ol class="org-ol">
<li><code>prepareRefresh()</code> 刷新应用上下文的准备工作
<ul class="org-ul">
<li>验证系统变量等</li>
</ul></li>
<li><code>obtainFreshBeanFactory()</code> 初始化 BeanFactory, 填充 BeanFactory 的属性
<ul class="org-ul">
<li>创建 BeanFactory</li>
<li>加载 BeanDefinition</li>
</ul></li>
<li><code>prepareBeanFactory(beanFactory)</code> 准备当前上下文的 BeanFactory
<ul class="org-ul">
<li><code>@Qualifier</code>, <code>@Autowired</code> 注解支持</li>
</ul></li>
<li><code>postProcessBeanFactory(beanFactory)</code> 的实现该方法来扩展其功能，即子类重
写当前方法来改变 BeanFactory 的功能</li>
<li><code>invokeBeanFactoryPostProcessors(beanFactory)</code> 唤醒
BeanFactoryPostProcessor 的后置处理方法
<ul class="org-ul">
<li>调用 <code>postProcessBeanFactory(...)</code> 方法</li>
</ul></li>
<li><code>registerBeanPostProcessors(beanFactory)</code> 注册 BeanPostProcessor 的拦截器
<ul class="org-ul">
<li>拦截器在这里只是注册</li>
<li>调用拦截器在 <code>getBean(...)</code> 中实现</li>
</ul></li>
<li><code>initMessageSource()</code> 初始化不同语言的消息，提供国际化支持</li>
<li><code>initApplicationEventMulticaster()</code> 初始化消息多播器
<ul class="org-ul">
<li>将 Bean 放入 <code>applicationEventMulticaster</code> 中</li>
</ul></li>
<li><code>onRefresh()</code> 提供子类的扩展接入点</li>
<li><code>registerListeners()</code> 注册监听器，在所有注册的 Bean 中查找 listenerBean,
并将 listenerBean 添加到 applicationEventMulticaster 中</li>
<li><code>finishBeanFactoryInitialization(beanFactory)</code> 初始化剩下的单例（非懒加
载的）</li>
<li><code>finishRefresh()</code> 完成刷新过程，发布 ContextRefreshedEvent</li>
<li>如果出现异常
<ul class="org-ul">
<li><code>destroyBeans()</code> 销毁 Bean</li>
<li><code>cancelRefresh(ex)</code> 重置 active 标注</li>
</ul></li>
<li>最终结束, <code>resetCommonCaches()</code> 清空缓存</li>
</ol>
</div>
</div>

<div id="outline-container-orgd3ea342" class="outline-4">
<h4 id="orgd3ea342"><span class="section-number-4">4.3.2</span> 环境准备</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
该部分主要包括以下几类工作
</p>
<ol class="org-ol">
<li>设置一下系统启动时间</li>
<li><code>initPropertySources()</code> 提供个性化初始属性功能</li>
<li><code>getEnvironment().validateRequiredProperties()</code> 对系统属性进行校验</li>
<li>准备一些监听器 ApplicationListener</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Prepare this context for refreshing, setting its startup date and</span>
<span style="color: #cc99cc;"> * active flag as well as performing any initialization of property sources.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">prepareRefresh</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Switch to active.</span>
    <span style="color: #99cc99;">this</span>.startupDate = System.currentTimeMillis<span style="color: #d8241f;">()</span>;
    <span style="color: #99cc99;">this</span>.closed.set<span style="color: #d8241f;">(</span><span style="color: #6699cc;">false</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">this</span>.active.set<span style="color: #d8241f;">(</span><span style="color: #6699cc;">true</span><span style="color: #d8241f;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>logger.isDebugEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Refreshing "</span> + <span style="color: #99cc99;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            logger.debug<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Refreshing "</span> + getDisplayName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize any placeholder property sources in the context environment.</span>
    initPropertySources<span style="color: #d8241f;">()</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Validate that all properties marked as required are resolvable:</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">see ConfigurablePropertyResolver#setRequiredProperties</span>
    getEnvironment<span style="color: #d8241f;">()</span>.validateRequiredProperties<span style="color: #d8241f;">()</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Store pre-refresh ApplicationListeners...</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.earlyApplicationListeners == <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.earlyApplicationListeners = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LinkedHashSet</span><span style="color: #9564bf;">&lt;&gt;(</span><span style="color: #99cc99;">this</span>.applicationListeners<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Reset local application listeners to pre-refresh state.</span>
        <span style="color: #99cc99;">this</span>.applicationListeners.clear<span style="color: #9564bf;">()</span>;
        <span style="color: #99cc99;">this</span>.applicationListeners.addAll<span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.earlyApplicationListeners<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Allow for the collection of early ApplicationEvents,</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">to be published once the multicaster is available...</span>
    <span style="color: #99cc99;">this</span>.earlyApplicationEvents = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LinkedHashSet</span><span style="color: #d8241f;">&lt;&gt;()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdb94a83" class="outline-4">
<h4 id="orgdb94a83"><span class="section-number-4">4.3.3</span> 加载 BeanFactory</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
ApplicationContext 是对 BeanFactory 的扩展，这里调用
<code>obtainFreshBeanFactory()</code> 方法获取 BeanFactory，但实际加载 BeanFactory 的实
现在 BeanFactory 中已经实现，通过之前对 BeanDefinition 加载分析知道
<code>AbstractRefreshableApplicationContext</code> 中的 <code>refreshBeanFactory()</code> 方法实现
了初始化 BeanFactory 的功能
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * This implementation performs an actual refresh of this context's underlying</span>
<span style="color: #cc99cc;"> * bean factory, shutting down the previous bean factory (if any) and</span>
<span style="color: #cc99cc;"> * initializing a fresh bean factory for the next phase of the context's lifecycle.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">protected</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">refreshBeanFactory</span><span style="color: #8d5649;">()</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>hasBeanFactory<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        destroyBeans<span style="color: #9564bf;">()</span>;
        closeBeanFactory<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">DefaultListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span> = createBeanFactory<span style="color: #9564bf;">()</span>;
        beanFactory.setSerializationId<span style="color: #9564bf;">(</span>getId<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        customizeBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        loadBeanDefinitions<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.beanFactoryMonitor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">this</span>.beanFactory = beanFactory;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">IOException</span> <span style="color: #ffcc66;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">throw</span> <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ApplicationContextException</span><span style="color: #9564bf;">(</span><span style="color: #66cccc;">"I/O error parsing bean definition source for "</span> + getDisplayName<span style="color: #24a222;">()</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
该方法功能如下
</p>
<ol class="org-ol">
<li>调用 <code>createBeanFactory()</code> 方法创建 <code>DefaultListableBeanFactory</code></li>
<li>指定序列化 ID</li>
<li>配置自定义的 BeanFactory 参数</li>
<li>加载 BeanDefinition</li>
<li>设置全局的 beanFactory 类实例</li>
</ol>
</div>
</div>

<div id="outline-container-orga247930" class="outline-4">
<h4 id="orga247930"><span class="section-number-4">4.3.4</span> BeanFactory 准备工作</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
该项功能在 <code>prepareBeanFactory(beanFactory)</code> 函数中完成，它的实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Configure the factory's standard context characteristics,</span>
<span style="color: #cc99cc;"> * such as the context's ClassLoader and post-processors.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanFactory the BeanFactory to configure</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">prepareBeanFactory</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Tell the internal bean factory to use the context's class loader etc.</span>
    beanFactory.setBeanClassLoader<span style="color: #d8241f;">(</span>getClassLoader<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    beanFactory.setBeanExpressionResolver<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">StandardBeanExpressionResolver</span><span style="color: #9564bf;">(</span>beanFactory.getBeanClassLoader<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    beanFactory.addPropertyEditorRegistrar<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ResourceEditorRegistrar</span><span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>, getEnvironment<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Configure the bean factory with context callbacks.</span>
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ApplicationContextAwareProcessor</span><span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>EnvironmentAware.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>EmbeddedValueResolverAware.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>ResourceLoaderAware.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>ApplicationEventPublisherAware.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>MessageSourceAware.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span>;
    beanFactory.ignoreDependencyInterface<span style="color: #d8241f;">(</span>ApplicationContextAware.<span style="color: #99cc99;">class</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">BeanFactory interface not registered as resolvable type in a plain factory.</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">MessageSource registered (and found for autowiring) as a bean.</span>
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>BeanFactory.<span style="color: #99cc99;">class</span>, beanFactory<span style="color: #d8241f;">)</span>;
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>ResourceLoader.<span style="color: #99cc99;">class</span>, <span style="color: #99cc99;">this</span><span style="color: #d8241f;">)</span>;
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>ApplicationEventPublisher.<span style="color: #99cc99;">class</span>, <span style="color: #99cc99;">this</span><span style="color: #d8241f;">)</span>;
    beanFactory.registerResolvableDependency<span style="color: #d8241f;">(</span>ApplicationContext.<span style="color: #99cc99;">class</span>, <span style="color: #99cc99;">this</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register early post-processor for detecting inner beans as ApplicationListeners.</span>
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ApplicationListenerDetector</span><span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Detect a LoadTimeWeaver and prepare for weaving, if found.</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsBean<span style="color: #9564bf;">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.addBeanPostProcessor<span style="color: #9564bf;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LoadTimeWeaverAwareProcessor</span><span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Set a temporary ClassLoader for type matching.</span>
        beanFactory.setTempClassLoader<span style="color: #9564bf;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ContextTypeMatchClassLoader</span><span style="color: #24a222;">(</span>beanFactory.getBeanClassLoader<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register default environment beans.</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>ENVIRONMENT_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>ENVIRONMENT_BEAN_NAME, getEnvironment<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment<span style="color: #24a222;">()</span>.getSystemProperties<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment<span style="color: #24a222;">()</span>.getSystemEnvironment<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
该方法做了以下工作
</p>
<ol class="org-ol">
<li>配置 beanFactory 的内部环境，使 beanFactory 使用当前 ApplicationContext
的上下文，具体包括
<ul class="org-ul">
<li>设置 beanFactory 的类加载器</li>
<li>设置 beanFactory 对 SPEL 语言的支持</li>
<li>设置 beanFactory 对属性编辑器的支持</li>
</ul></li>
<li>配置 beanFactory 的 ApplicationContext 回调函数
<ul class="org-ul">
<li>设置 <code>ApplicationContextAwareProcessor</code> 后置处理器</li>
<li>忽略下列自动装配忽略的 Aware 接口，因为这些接口在
<code>ApplicationContextAwareProcessor</code> 已经进行处理
<ul class="org-ul">
<li>EnvironmentAware</li>
<li>EmbeddedValueResolverAware</li>
<li>ResourceLoaderAware</li>
<li>ApplicationEventPublisherAware</li>
<li>MessageSourceAware</li>
<li>ApplicationContextAware</li>
</ul></li>
</ul></li>
<li>配置几个特殊装配的规则</li>
<li>添加 ApplicationListenerDetector</li>
<li>添加对 AspectJ 的支持</li>
<li>将相关环境变量及系统属性以单例模式注册</li>
</ol>
</div>
</div>

<div id="outline-container-org50c68dd" class="outline-4">
<h4 id="org50c68dd"><span class="section-number-4">4.3.5</span> BeanFactory 后续处理工作</h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
调用 <code>postProcessBeanFactory</code>, 其中 <code>postProcessBeanFactory</code> 是一个空方法，
目的是为 BeanFactory 的后置处理器提供扩展接口
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Modify the application context's internal bean factory after its standard</span>
<span style="color: #cc99cc;"> * initialization. All bean definitions will have been loaded, but no beans</span>
<span style="color: #cc99cc;"> * will have been instantiated yet. This allows for registering special</span>
<span style="color: #cc99cc;"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanFactory the bean factory used by the application context</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">postProcessBeanFactory</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>invokeBeanFactoryPostProcessors()</code> 唤醒注册的 BeanFactoryPostProcessor
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span>
<span style="color: #cc99cc;"> * respecting explicit order if given.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">&lt;p&gt;</span><span style="color: #cc99cc;">Must be called before singleton instantiation.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">invokeBeanFactoryPostProcessors</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>beanFactory, getBeanFactoryPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">(e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory.getTempClassLoader<span style="color: #9564bf;">()</span> == <span style="color: #6699cc;">null</span> &amp;&amp; beanFactory.containsBean<span style="color: #9564bf;">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.addBeanPostProcessor<span style="color: #9564bf;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">LoadTimeWeaverAwareProcessor</span><span style="color: #24a222;">(</span>beanFactory<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        beanFactory.setTempClassLoader<span style="color: #9564bf;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ContextTypeMatchClassLoader</span><span style="color: #24a222;">(</span>beanFactory.getBeanClassLoader<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">invokeBeanFactoryPostProcessors</span><span style="color: #8d5649;">(</span>
        <span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span>, <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">beanFactoryPostProcessors</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Invoke BeanDefinitionRegistryPostProcessors first, if any.</span>
    <span style="color: #6699cc;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">processedBeans</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">HashSet</span><span style="color: #d8241f;">&lt;&gt;()</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory <span style="color: #99cc99;">instanceof</span> BeanDefinitionRegistry<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">BeanDefinitionRegistry</span> <span style="color: #ffcc66;">registry</span> = <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeanDefinitionRegistry</span><span style="color: #9564bf;">)</span> beanFactory;
        <span style="color: #6699cc;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">BeanFactoryPostProcessor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">regularPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;()</span>;
        <span style="color: #6699cc;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">BeanDefinitionRegistryPostProcessor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">registryProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;()</span>;

        <span style="color: #99cc99;">for</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">BeanFactoryPostProcessor</span> <span style="color: #ffcc66;">postProcessor</span> : beanFactoryPostProcessors<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>postProcessor <span style="color: #99cc99;">instanceof</span> BeanDefinitionRegistryPostProcessor<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #6699cc;">BeanDefinitionRegistryPostProcessor</span> <span style="color: #ffcc66;">registryProcessor</span> =
                        <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">BeanDefinitionRegistryPostProcessor</span><span style="color: #ff7f00;">)</span> postProcessor;
                registryProcessor.postProcessBeanDefinitionRegistry<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
                registryProcessors.add<span style="color: #ff7f00;">(</span>registryProcessor<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #24a222;">{</span>
                regularPostProcessors.add<span style="color: #ff7f00;">(</span>postProcessor<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Do not initialize FactoryBeans here: We need to leave all regular beans</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">uninitialized to let the bean factory post-processors apply to them!</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Separate between BeanDefinitionRegistryPostProcessors that implement</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">PriorityOrdered, Ordered, and the rest.</span>
        <span style="color: #6699cc;">List</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">BeanDefinitionRegistryPostProcessor</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">currentRegistryProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #9564bf;">&lt;&gt;()</span>;

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span>
        <span style="color: #6699cc;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #ffcc66;">postProcessorNames</span> =
                beanFactory.getBeanNamesForType<span style="color: #9564bf;">(</span>BeanDefinitionRegistryPostProcessor.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">true</span>, <span style="color: #6699cc;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">for</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : postProcessorNames<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>beanFactory.isTypeMatch<span style="color: #ff7f00;">(</span>ppName, PriorityOrdered.<span style="color: #99cc99;">class</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                currentRegistryProcessors.add<span style="color: #ff7f00;">(</span>beanFactory.getBean<span style="color: #1776b6;">(</span>ppName, BeanDefinitionRegistryPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                processedBeans.add<span style="color: #ff7f00;">(</span>ppName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        sortPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, beanFactory<span style="color: #9564bf;">)</span>;
        registryProcessors.addAll<span style="color: #9564bf;">(</span>currentRegistryProcessors<span style="color: #9564bf;">)</span>;
        invokeBeanDefinitionRegistryPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, registry<span style="color: #9564bf;">)</span>;
        currentRegistryProcessors.clear<span style="color: #9564bf;">()</span>;

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span>
        postProcessorNames = beanFactory.getBeanNamesForType<span style="color: #9564bf;">(</span>BeanDefinitionRegistryPostProcessor.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">true</span>, <span style="color: #6699cc;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">for</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : postProcessorNames<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">!</span>processedBeans.contains<span style="color: #ff7f00;">(</span>ppName<span style="color: #ff7f00;">)</span> &amp;&amp; beanFactory.isTypeMatch<span style="color: #ff7f00;">(</span>ppName, Ordered.<span style="color: #99cc99;">class</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                currentRegistryProcessors.add<span style="color: #ff7f00;">(</span>beanFactory.getBean<span style="color: #1776b6;">(</span>ppName, BeanDefinitionRegistryPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                processedBeans.add<span style="color: #ff7f00;">(</span>ppName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        sortPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, beanFactory<span style="color: #9564bf;">)</span>;
        registryProcessors.addAll<span style="color: #9564bf;">(</span>currentRegistryProcessors<span style="color: #9564bf;">)</span>;
        invokeBeanDefinitionRegistryPostProcessors<span style="color: #9564bf;">(</span>currentRegistryProcessors, registry<span style="color: #9564bf;">)</span>;
        currentRegistryProcessors.clear<span style="color: #9564bf;">()</span>;

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span>
        <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">reiterate</span> = <span style="color: #6699cc;">true</span>;
        <span style="color: #99cc99;">while</span> <span style="color: #9564bf;">(</span>reiterate<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            reiterate = <span style="color: #6699cc;">false</span>;
            postProcessorNames = beanFactory.getBeanNamesForType<span style="color: #24a222;">(</span>BeanDefinitionRegistryPostProcessor.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">true</span>, <span style="color: #6699cc;">false</span><span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">for</span> <span style="color: #24a222;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : postProcessorNames<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">!</span>processedBeans.contains<span style="color: #1776b6;">(</span>ppName<span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    currentRegistryProcessors.add<span style="color: #1776b6;">(</span>beanFactory.getBean<span style="color: #00bed1;">(</span>ppName, BeanDefinitionRegistryPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span>;
                    processedBeans.add<span style="color: #1776b6;">(</span>ppName<span style="color: #1776b6;">)</span>;
                    reiterate = <span style="color: #6699cc;">true</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            sortPostProcessors<span style="color: #24a222;">(</span>currentRegistryProcessors, beanFactory<span style="color: #24a222;">)</span>;
            registryProcessors.addAll<span style="color: #24a222;">(</span>currentRegistryProcessors<span style="color: #24a222;">)</span>;
            invokeBeanDefinitionRegistryPostProcessors<span style="color: #24a222;">(</span>currentRegistryProcessors, registry<span style="color: #24a222;">)</span>;
            currentRegistryProcessors.clear<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span>
        invokeBeanFactoryPostProcessors<span style="color: #9564bf;">(</span>registryProcessors, beanFactory<span style="color: #9564bf;">)</span>;
        invokeBeanFactoryPostProcessors<span style="color: #9564bf;">(</span>regularPostProcessors, beanFactory<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Invoke factory processors registered with the context instance.</span>
        invokeBeanFactoryPostProcessors<span style="color: #9564bf;">(</span>beanFactoryPostProcessors, beanFactory<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">uninitialized to let the bean factory post-processors apply to them!</span>
    <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">postProcessorNames</span> =
            beanFactory.getBeanNamesForType<span style="color: #d8241f;">(</span>BeanFactoryPostProcessor.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">true</span>, <span style="color: #6699cc;">false</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Ordered, and the rest.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">priorityOrderedPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">orderedPostProcessorNames</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">nonOrderedPostProcessorNames</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : postProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>processedBeans.contains<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">skip - already processed in first phase above</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, PriorityOrdered.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            priorityOrderedPostProcessors.add<span style="color: #24a222;">(</span>beanFactory.getBean<span style="color: #ff7f00;">(</span>ppName, BeanFactoryPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, Ordered.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            orderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            nonOrderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>priorityOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>priorityOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">orderedPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>orderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">postProcessorName</span> : orderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        orderedPostProcessors.add<span style="color: #9564bf;">(</span>beanFactory.getBean<span style="color: #24a222;">(</span>postProcessorName, BeanFactoryPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>orderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>orderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Finally, invoke all other BeanFactoryPostProcessors.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanFactoryPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">nonOrderedPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>nonOrderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">postProcessorName</span> : nonOrderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        nonOrderedPostProcessors.add<span style="color: #9564bf;">(</span>beanFactory.getBean<span style="color: #24a222;">(</span>postProcessorName, BeanFactoryPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    invokeBeanFactoryPostProcessors<span style="color: #d8241f;">(</span>nonOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Clear cached merged bean definitions since the post-processors might have</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">modified the original metadata, e.g. replacing placeholders in values...</span>
    beanFactory.clearMetadataCache<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(...)</code> 方
法完成唤醒后置处理，它将 BeanFactoryPostProcessor 分成两类
</p>
<ol class="org-ol">
<li>regularPostProcessors 记录的 <code>BeanFactoryPostProcessor</code> 后置处理器</li>
<li>registryProcessors 记录的 <code>BeanDefinitionRegistry</code> 后置处理器</li>
<li>在唤醒时还需要考虑后置处理器的顺序
<ul class="org-ul">
<li>PriorityOrdered 优先序的</li>
<li>Ordered 有序的</li>
<li>Non-Ordered 无序的</li>
</ul></li>
</ol>

<p>
注册 BeanPostProcessor <code>registerBeanPostProcessors(beanFactory)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerBeanPostProcessors</span><span style="color: #8d5649;">(</span>
        <span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span>, <span style="color: #6699cc;">AbstractApplicationContext</span> <span style="color: #ffcc66;">applicationContext</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">postProcessorNames</span> = beanFactory.getBeanNamesForType<span style="color: #d8241f;">(</span>BeanPostProcessor.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">true</span>, <span style="color: #6699cc;">false</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register BeanPostProcessorChecker that logs an info message when</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">a bean is created during BeanPostProcessor instantiation, i.e. when</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">a bean is not eligible for getting processed by all BeanPostProcessors.</span>
    <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">beanProcessorTargetCount</span> = beanFactory.getBeanPostProcessorCount<span style="color: #d8241f;">()</span> + 1 + postProcessorNames.length;
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanPostProcessorChecker</span><span style="color: #9564bf;">(</span>beanFactory, beanProcessorTargetCount<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Separate between BeanPostProcessors that implement PriorityOrdered,</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Ordered, and the rest.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">priorityOrderedPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">internalPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">orderedPostProcessorNames</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">nonOrderedPostProcessorNames</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : postProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, PriorityOrdered.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">BeanPostProcessor</span> <span style="color: #ffcc66;">pp</span> = beanFactory.getBean<span style="color: #24a222;">(</span>ppName, BeanPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span>;
            priorityOrderedPostProcessors.add<span style="color: #24a222;">(</span>pp<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>pp <span style="color: #99cc99;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                internalPostProcessors.add<span style="color: #ff7f00;">(</span>pp<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>beanFactory.isTypeMatch<span style="color: #24a222;">(</span>ppName, Ordered.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            orderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            nonOrderedPostProcessorNames.add<span style="color: #24a222;">(</span>ppName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">First, register the BeanPostProcessors that implement PriorityOrdered.</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>priorityOrderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, priorityOrderedPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Next, register the BeanPostProcessors that implement Ordered.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">orderedPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>orderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : orderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">BeanPostProcessor</span> <span style="color: #ffcc66;">pp</span> = beanFactory.getBean<span style="color: #9564bf;">(</span>ppName, BeanPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span>;
        orderedPostProcessors.add<span style="color: #9564bf;">(</span>pp<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>pp <span style="color: #99cc99;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            internalPostProcessors.add<span style="color: #24a222;">(</span>pp<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>orderedPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, orderedPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Now, register all regular BeanPostProcessors.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">BeanPostProcessor</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">nonOrderedPostProcessors</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span>nonOrderedPostProcessorNames.size<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">ppName</span> : nonOrderedPostProcessorNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">BeanPostProcessor</span> <span style="color: #ffcc66;">pp</span> = beanFactory.getBean<span style="color: #9564bf;">(</span>ppName, BeanPostProcessor.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span>;
        nonOrderedPostProcessors.add<span style="color: #9564bf;">(</span>pp<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>pp <span style="color: #99cc99;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            internalPostProcessors.add<span style="color: #24a222;">(</span>pp<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, nonOrderedPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Finally, re-register all internal BeanPostProcessors.</span>
    sortPostProcessors<span style="color: #d8241f;">(</span>internalPostProcessors, beanFactory<span style="color: #d8241f;">)</span>;
    registerBeanPostProcessors<span style="color: #d8241f;">(</span>beanFactory, internalPostProcessors<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Re-register post-processor for detecting inner beans as ApplicationListeners,</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">moving it to the end of the processor chain (for picking up proxies etc).</span>
    beanFactory.addBeanPostProcessor<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ApplicationListenerDetector</span><span style="color: #9564bf;">(</span>applicationContext<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
处理国际化消息 <code>initMessageSource()</code>, 这部分不重要，可以跳过
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Initialize the MessageSource.</span>
<span style="color: #cc99cc;"> * Use parent's if none defined in this context.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">initMessageSource</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span> = getBeanFactory<span style="color: #d8241f;">()</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>MESSAGE_SOURCE_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.messageSource = beanFactory.getBean<span style="color: #9564bf;">(</span>MESSAGE_SOURCE_BEAN_NAME, MessageSource.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Make MessageSource aware of parent MessageSource.</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.parent != <span style="color: #6699cc;">null</span> &amp;&amp; <span style="color: #99cc99;">this</span>.messageSource <span style="color: #99cc99;">instanceof</span> HierarchicalMessageSource<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">HierarchicalMessageSource</span> <span style="color: #ffcc66;">hms</span> = <span style="color: #24a222;">(</span><span style="color: #6699cc;">HierarchicalMessageSource</span><span style="color: #24a222;">)</span> <span style="color: #99cc99;">this</span>.messageSource;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>hms.getParentMessageSource<span style="color: #ff7f00;">()</span> == <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Only set parent context as parent MessageSource if no parent MessageSource</span>
                <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">registered already.</span>
                hms.setParentMessageSource<span style="color: #ff7f00;">(</span>getInternalParentMessageSource<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Using MessageSource ["</span> + <span style="color: #99cc99;">this</span>.messageSource + <span style="color: #66cccc;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Use empty MessageSource to be able to accept getMessage calls.</span>
        <span style="color: #6699cc;">DelegatingMessageSource</span> <span style="color: #ffcc66;">dms</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">DelegatingMessageSource</span><span style="color: #9564bf;">()</span>;
        dms.setParentMessageSource<span style="color: #9564bf;">(</span>getInternalParentMessageSource<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.messageSource = dms;
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>MESSAGE_SOURCE_BEAN_NAME, <span style="color: #99cc99;">this</span>.messageSource<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"No '"</span> + MESSAGE_SOURCE_BEAN_NAME + <span style="color: #66cccc;">"' bean, using ["</span> + <span style="color: #99cc99;">this</span>.messageSource + <span style="color: #66cccc;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>initApplicationEventMulticaster()</code> 初始化多播，初始化多播属性
applicationEventMulticaster, 如果存在直接设置多播器，如果不存在则创建
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Initialize the ApplicationEventMulticaster.</span>
<span style="color: #cc99cc;"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> org.springframework.context.event.SimpleApplicationEventMulticaster</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">initApplicationEventMulticaster</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span> = getBeanFactory<span style="color: #d8241f;">()</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>APPLICATION_EVENT_MULTICASTER_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.applicationEventMulticaster =
                beanFactory.getBean<span style="color: #9564bf;">(</span>APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Using ApplicationEventMulticaster ["</span> + <span style="color: #99cc99;">this</span>.applicationEventMulticaster + <span style="color: #66cccc;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.applicationEventMulticaster = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">SimpleApplicationEventMulticaster</span><span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span style="color: #99cc99;">this</span>.applicationEventMulticaster<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"No '"</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span style="color: #66cccc;">"' bean, using "</span> +
                    <span style="color: #66cccc;">"["</span> + <span style="color: #99cc99;">this</span>.applicationEventMulticaster.getClass<span style="color: #ff7f00;">()</span>.getSimpleName<span style="color: #ff7f00;">()</span> + <span style="color: #66cccc;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>onRefresh()</code> 是一个空方法，提供子类刷新的扩展点
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">onRefresh</span><span style="color: #8d5649;">()</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">For subclasses: do nothing by default.</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>registerListeners()</code> 获取多播器，然后注册 listener 监听器
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Add beans that implement ApplicationListener as listeners.</span>
<span style="color: #cc99cc;"> * Doesn't affect other listeners, which can be added without being beans.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerListeners</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register statically specified listeners first.</span>
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">ApplicationListener</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">listener</span> : getApplicationListeners<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        getApplicationEventMulticaster<span style="color: #9564bf;">()</span>.addApplicationListener<span style="color: #9564bf;">(</span>listener<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">uninitialized to let post-processors apply to them!</span>
    <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">listenerBeanNames</span> = getBeanNamesForType<span style="color: #d8241f;">(</span>ApplicationListener.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">true</span>, <span style="color: #6699cc;">false</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">listenerBeanName</span> : listenerBeanNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        getApplicationEventMulticaster<span style="color: #9564bf;">()</span>.addApplicationListenerBean<span style="color: #9564bf;">(</span>listenerBeanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Publish early application events now that we finally have a multicaster...</span>
    <span style="color: #6699cc;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">ApplicationEvent</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">earlyEventsToProcess</span> = <span style="color: #99cc99;">this</span>.earlyApplicationEvents;
    <span style="color: #99cc99;">this</span>.earlyApplicationEvents = <span style="color: #6699cc;">null</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>earlyEventsToProcess != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">for</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">ApplicationEvent</span> <span style="color: #ffcc66;">earlyEvent</span> : earlyEventsToProcess<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getApplicationEventMulticaster<span style="color: #24a222;">()</span>.multicastEvent<span style="color: #24a222;">(</span>earlyEvent<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8121c77" class="outline-4">
<h4 id="org8121c77"><span class="section-number-4">4.3.6</span> 初始化非延迟加载单例</h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
非延迟加载单例可以在 Spring 启动后就进行创建，然后下次加载可以快速获取，减少
创建的时间
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Finish the initialization of this context's bean factory,</span>
<span style="color: #cc99cc;"> * initializing all remaining singleton beans.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">finishBeanFactoryInitialization</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize conversion service for this context.</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsBean<span style="color: #9564bf;">(</span>CONVERSION_SERVICE_BEAN_NAME<span style="color: #9564bf;">)</span> &amp;&amp;
            beanFactory.isTypeMatch<span style="color: #9564bf;">(</span>CONVERSION_SERVICE_BEAN_NAME, ConversionService.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.setConversionService<span style="color: #9564bf;">(</span>
                beanFactory.getBean<span style="color: #24a222;">(</span>CONVERSION_SERVICE_BEAN_NAME, ConversionService.<span style="color: #99cc99;">class</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Register a default embedded value resolver if no bean post-processor</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">(such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">at this point, primarily for resolution in annotation attribute values.</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>beanFactory.hasEmbeddedValueResolver<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanFactory.addEmbeddedValueResolver<span style="color: #9564bf;">(</span>strVal -&gt; getEnvironment<span style="color: #24a222;">()</span>.resolvePlaceholders<span style="color: #24a222;">(</span>strVal<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span>
    <span style="color: #6699cc;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">weaverAwareNames</span> = beanFactory.getBeanNamesForType<span style="color: #d8241f;">(</span>LoadTimeWeaverAware.<span style="color: #99cc99;">class</span>, <span style="color: #6699cc;">false</span>, <span style="color: #6699cc;">false</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">weaverAwareName</span> : weaverAwareNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        getBean<span style="color: #9564bf;">(</span>weaverAwareName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Stop using the temporary ClassLoader for type matching.</span>
    beanFactory.setTempClassLoader<span style="color: #d8241f;">(</span><span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Allow for caching all bean definition metadata, not expecting further changes.</span>
    beanFactory.freezeConfiguration<span style="color: #d8241f;">()</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Instantiate all remaining (non-lazy-init) singletons.</span>
    beanFactory.preInstantiateSingletons<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>preInstantiateSingletons()</code> 方法一次性初始化所有的初始化非延迟加载单例
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">preInstantiateSingletons</span><span style="color: #8d5649;">()</span> <span style="color: #99cc99;">throws</span> <span style="color: #6699cc;">BeansException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"Pre-instantiating singletons in "</span> + <span style="color: #99cc99;">this</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Iterate over a copy to allow for init methods which in turn register new bean definitions.</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span>
    <span style="color: #6699cc;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #6699cc;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">beanNames</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;(</span><span style="color: #99cc99;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Trigger initialization of all non-lazy singleton beans...</span>
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span> : beanNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">bd</span> = getMergedLocalBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>bd.isAbstract<span style="color: #24a222;">()</span> &amp;&amp; bd.isSingleton<span style="color: #24a222;">()</span> &amp;&amp; <span style="color: #6699cc;">!</span>bd.isLazyInit<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>isFactoryBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span> = getBean<span style="color: #ff7f00;">(</span>FACTORY_BEAN_PREFIX + beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #99cc99;">if</span> <span style="color: #ff7f00;">(</span>bean <span style="color: #99cc99;">instanceof</span> FactoryBean<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">FactoryBean</span><span style="color: #1776b6;">&lt;</span>?<span style="color: #1776b6;">&gt;</span> <span style="color: #ffcc66;">factory</span> = <span style="color: #1776b6;">(</span><span style="color: #6699cc;">FactoryBean</span><span style="color: #00bed1;">&lt;</span>?<span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> bean;
                    <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">isEagerInit</span>;
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span>System.getSecurityManager<span style="color: #00bed1;">()</span> != <span style="color: #6699cc;">null</span> &amp;&amp; factory <span style="color: #99cc99;">instanceof</span> SmartFactoryBean<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        isEagerInit = AccessController.doPrivileged<span style="color: #00bed1;">(</span><span style="color: #bcbf00;">(</span><span style="color: #6699cc;">PrivilegedAction</span><span style="color: #e574c3;">&lt;</span><span style="color: #6699cc;">Boolean</span><span style="color: #e574c3;">&gt;</span><span style="color: #bcbf00;">)</span>
                                        <span style="color: #bcbf00;">(</span><span style="color: #e574c3;">(</span><span style="color: #6699cc;">SmartFactoryBean</span><span style="color: #8d5649;">&lt;</span>?<span style="color: #8d5649;">&gt;</span><span style="color: #e574c3;">)</span> factory<span style="color: #bcbf00;">)</span>::isEagerInit,
                                getAccessControlContext<span style="color: #bcbf00;">()</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #99cc99;">else</span> <span style="color: #1776b6;">{</span>
                        isEagerInit = <span style="color: #00bed1;">(</span>factory <span style="color: #99cc99;">instanceof</span> SmartFactoryBean &amp;&amp;
                                <span style="color: #bcbf00;">(</span><span style="color: #e574c3;">(</span><span style="color: #6699cc;">SmartFactoryBean</span><span style="color: #8d5649;">&lt;</span>?<span style="color: #8d5649;">&gt;</span><span style="color: #e574c3;">)</span> factory<span style="color: #bcbf00;">)</span>.isEagerInit<span style="color: #bcbf00;">()</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #99cc99;">if</span> <span style="color: #1776b6;">(</span>isEagerInit<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        getBean<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #24a222;">{</span>
                getBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Trigger post-initialization callback for all applicable beans...</span>
    <span style="color: #99cc99;">for</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span> : beanNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">singletonInstance</span> = getSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>singletonInstance <span style="color: #99cc99;">instanceof</span> SmartInitializingSingleton<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">SmartInitializingSingleton</span> <span style="color: #ffcc66;">smartSingleton</span> = <span style="color: #24a222;">(</span><span style="color: #6699cc;">SmartInitializingSingleton</span><span style="color: #24a222;">)</span> singletonInstance;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>System.getSecurityManager<span style="color: #ff7f00;">()</span> != <span style="color: #6699cc;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AccessController.doPrivileged<span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #6699cc;">PrivilegedAction</span><span style="color: #00bed1;">&lt;</span><span style="color: #6699cc;">Object</span><span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">()</span> -&gt; <span style="color: #1776b6;">{</span>
                    smartSingleton.afterSingletonsInstantiated<span style="color: #00bed1;">()</span>;
                    <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
                <span style="color: #1776b6;">}</span>, getAccessControlContext<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">else</span> <span style="color: #24a222;">{</span>
                smartSingleton.afterSingletonsInstantiated<span style="color: #ff7f00;">()</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbbf9632" class="outline-4">
<h4 id="orgbbf9632"><span class="section-number-4">4.3.7</span> 完成上下文刷新</h4>
<div class="outline-text-4" id="text-4-3-7">
<p>
<code>finishRefresh()</code> 完成上下文的刷新
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Finish the refresh of this context, invoking the LifecycleProcessor's</span>
<span style="color: #cc99cc;"> * onRefresh() method and publishing the</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">{@link org.springframework.context.event.ContextRefreshedEvent}</span><span style="color: #cc99cc;">.</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">finishRefresh</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Clear context-level resource caches (such as ASM metadata from scanning).</span>
    clearResourceCaches<span style="color: #d8241f;">()</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Initialize lifecycle processor for this context.</span>
    initLifecycleProcessor<span style="color: #d8241f;">()</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Propagate refresh to lifecycle processor first.</span>
    getLifecycleProcessor<span style="color: #d8241f;">()</span>.onRefresh<span style="color: #d8241f;">()</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Publish the final event.</span>
    publishEvent<span style="color: #d8241f;">(</span><span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ContextRefreshedEvent</span><span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Participate in LiveBeansView MBean, if active.</span>
    LiveBeansView.registerApplicationContext<span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
首先调用 <code>clearResourceCaches()</code> 方法清理资源的缓存
</p>

<p>
接着 <code>initLifecycleProcessor()</code> 初始化生命周期的处理器，该方法主要是初始化了
<code>LifecycleProcessor</code> 类
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Initialize the LifecycleProcessor.</span>
<span style="color: #cc99cc;"> * Uses DefaultLifecycleProcessor if none defined in the context.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> org.springframework.context.support.DefaultLifecycleProcessor</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">initLifecycleProcessor</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">ConfigurableListableBeanFactory</span> <span style="color: #ffcc66;">beanFactory</span> = getBeanFactory<span style="color: #d8241f;">()</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>beanFactory.containsLocalBean<span style="color: #9564bf;">(</span>LIFECYCLE_PROCESSOR_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.lifecycleProcessor =
                beanFactory.getBean<span style="color: #9564bf;">(</span>LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"Using LifecycleProcessor ["</span> + <span style="color: #99cc99;">this</span>.lifecycleProcessor + <span style="color: #66cccc;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">DefaultLifecycleProcessor</span> <span style="color: #ffcc66;">defaultProcessor</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">DefaultLifecycleProcessor</span><span style="color: #9564bf;">()</span>;
        defaultProcessor.setBeanFactory<span style="color: #9564bf;">(</span>beanFactory<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.lifecycleProcessor = defaultProcessor;
        beanFactory.registerSingleton<span style="color: #9564bf;">(</span>LIFECYCLE_PROCESSOR_BEAN_NAME, <span style="color: #99cc99;">this</span>.lifecycleProcessor<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #66cccc;">"No '"</span> + LIFECYCLE_PROCESSOR_BEAN_NAME + <span style="color: #66cccc;">"' bean, using "</span> +
                    <span style="color: #66cccc;">"["</span> + <span style="color: #99cc99;">this</span>.lifecycleProcessor.getClass<span style="color: #ff7f00;">()</span>.getSimpleName<span style="color: #ff7f00;">()</span> + <span style="color: #66cccc;">"]"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
调用 <code>getLifecycleProcessor().onRefresh()</code> 方法传播更新状态
</p>

<p>
调用 <code>publishEvent(...)</code> 方法发布事件
</p>
<ol class="org-ol">
<li>发布 ContextRefreshedEvent 事件</li>
<li>如果父 ApplicationContext 存在，将事件传播到父 ApplicationContext 中</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Publish the given event to all listeners.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> event the event to publish (may be an </span><span style="color: #6699cc;">{@link ApplicationEvent}</span>
<span style="color: #cc99cc;"> * or a payload object to be turned into a </span><span style="color: #6699cc;">{@link PayloadApplicationEvent}</span><span style="color: #cc99cc;">)</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> eventType the resolved event type, if known</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@since</span><span style="color: #cc99cc;"> 4.2</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">publishEvent</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">event</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">ResolvableType</span> <span style="color: #ffcc66;">eventType</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>event, <span style="color: #66cccc;">"Event must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Decorate event as an ApplicationEvent if necessary</span>
    <span style="color: #6699cc;">ApplicationEvent</span> <span style="color: #ffcc66;">applicationEvent</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>event <span style="color: #99cc99;">instanceof</span> ApplicationEvent<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        applicationEvent = <span style="color: #9564bf;">(</span><span style="color: #6699cc;">ApplicationEvent</span><span style="color: #9564bf;">)</span> event;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        applicationEvent = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">PayloadApplicationEvent</span><span style="color: #9564bf;">&lt;&gt;(</span><span style="color: #99cc99;">this</span>, event<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>eventType == <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            eventType = <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #6699cc;">PayloadApplicationEvent</span><span style="color: #1776b6;">&lt;</span>?<span style="color: #1776b6;">&gt;</span><span style="color: #ff7f00;">)</span> applicationEvent<span style="color: #24a222;">)</span>.getResolvableType<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Multicast right now if possible - or lazily once the multicaster is initialized</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.earlyApplicationEvents != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.earlyApplicationEvents.add<span style="color: #9564bf;">(</span>applicationEvent<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">else</span> <span style="color: #d8241f;">{</span>
        getApplicationEventMulticaster<span style="color: #9564bf;">()</span>.multicastEvent<span style="color: #9564bf;">(</span>applicationEvent, eventType<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Publish event via parent context as well...</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.parent != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.parent <span style="color: #99cc99;">instanceof</span> AbstractApplicationContext<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #6699cc;">AbstractApplicationContext</span><span style="color: #ff7f00;">)</span> <span style="color: #99cc99;">this</span>.parent<span style="color: #24a222;">)</span>.publishEvent<span style="color: #24a222;">(</span>event, eventType<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">this</span>.parent.publishEvent<span style="color: #24a222;">(</span>event<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org0557036" class="outline-2">
<h2 id="org0557036"><span class="section-number-2">5</span> AOP 面向切面编程</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orga82916f" class="outline-3">
<h3 id="orga82916f"><span class="section-number-3">5.1</span> AOP 实现原理</h3>
<div class="outline-text-3" id="text-5-1">
<p>
使用动态代理实现主要使用下面两种方法
</p>
<ol class="org-ol">
<li>JDK 动态代理
<ul class="org-ul">
<li>其代理对象必须是某个接口的实现</li>
<li>它是通过运行期间创建一个接口的实现类来完成对目标对象的代理</li>
</ul></li>
<li>cglib 动态代理
<ul class="org-ul">
<li>原理类似 JDK 动态代理，只是它在运行期间创建的代理对象是针对目标类扩展的
子类</li>
<li>cglib 底层基于 ASM 开源 Java 字节码编辑类库实现，性能优于 JDK 动态代理</li>
</ul></li>
<li>常见 XML 设置属性
<ul class="org-ul">
<li>proxy-target-class 属性
<ul class="org-ul">
<li>属性值决定是基于接口的还是基于类的代理被创建。</li>
<li><code>proxy-target-class="true"</code> 基于类的代理将起作用（需要cglib库）</li>
<li><code>proxy-target-class="false"</code> 标准的J DK 基于接口的代理将起作用</li>
<li>在 Spring 事务, AOP, 缓存这几块都有设置，其作用都是一样的</li>
</ul></li>
<li>expose-class 属性
<ul class="org-ul">
<li>通过 ThreadLocal 暴露 AOP 代理对象</li>
<li><code>this.b();</code> 修改为 <code>((AService) AopContext.currentProxy()).b();</code> 来显
示调用</li>
<li>开启新的事务最好写在另外一个 Service 中, 将传播机制设为 <code>REQUIRE_NEW</code></li>
</ul></li>
</ul></li>
</ol>

<p>
切入点的定义
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#20999;&#20837;&#28857;</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">Pointcut</span> <span style="color: #8d5649;">{</span>
  <span style="color: #6699cc;">ClassFilter</span> <span style="color: #f99157;">getClassFilter</span><span style="color: #d8241f;">()</span>;
  <span style="color: #6699cc;">MethodMatcher</span> <span style="color: #f99157;">getMethodMatcher</span><span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#31867;&#36807;&#28388;&#22120;</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">ClassFilter</span> <span style="color: #8d5649;">{</span>
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">matches</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Class</span> <span style="color: #ffcc66;">clazz</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#26041;&#27861;&#36807;&#28388;&#22120;</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">MethodMatcher</span> <span style="color: #8d5649;">{</span>
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">matches</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Method</span> <span style="color: #ffcc66;">m</span>, <span style="color: #6699cc;">Class</span> <span style="color: #ffcc66;">targetClass</span><span style="color: #d8241f;">)</span>;
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isRuntime</span><span style="color: #d8241f;">()</span>;
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">matches</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Method</span> <span style="color: #ffcc66;">m</span>, <span style="color: #6699cc;">Class</span> <span style="color: #ffcc66;">targetClass</span>, <span style="color: #6699cc;">Object</span><span style="color: #9564bf;">[]</span> <span style="color: #ffcc66;">args</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
增强的接口定义
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#22686;&#21152;&#22120;</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">Advisor</span> <span style="color: #8d5649;">{</span>
  <span style="color: #6699cc;">Advice</span> <span style="color: #ffcc66;">EMPTY_ADVICE</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Advice</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{}</span>;
  <span style="color: #6699cc;">Advice</span> <span style="color: #f99157;">getAdvice</span><span style="color: #d8241f;">()</span>;
  <span style="color: #6699cc;">boolean</span> <span style="color: #f99157;">isPerInstance</span><span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">&#22686;&#24378;</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">Advice</span> <span style="color: #8d5649;">{}</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">BeforeAdvice</span> <span style="color: #99cc99;">extends</span> <span style="color: #6699cc;">Advice</span> <span style="color: #8d5649;">{}</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">interface</span> <span style="color: #6699cc;">AfterAdvice</span> <span style="color: #99cc99;">extends</span> <span style="color: #6699cc;">Advice</span> <span style="color: #8d5649;">{}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3ff5b5" class="outline-3">
<h3 id="orgf3ff5b5"><span class="section-number-3">5.2</span> AOP 的实验案例</h3>
<div class="outline-text-3" id="text-5-2">
<p>
添加日志的 Bean 对象
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">package</span> io.github.jeanhwea.app07_aop.<span style="color: #6699cc;">beans</span>;

<span style="color: #99cc99;">import</span> <span style="color: #6699cc;">org</span>.<span style="color: #6699cc;">springframework</span>.<span style="color: #6699cc;">beans</span>.<span style="color: #6699cc;">factory</span>.<span style="color: #6699cc;">annotation</span>.<span style="color: #6699cc;">Value</span>;
<span style="color: #99cc99;">import</span> <span style="color: #6699cc;">org</span>.<span style="color: #6699cc;">springframework</span>.<span style="color: #6699cc;">stereotype</span>.<span style="color: #6699cc;">Component</span>;

<span style="color: #6699cc;">@Component</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">class</span> <span style="color: #6699cc;">LogEntry</span> <span style="color: #8d5649;">{</span>

  <span style="color: #6699cc;">@Value</span><span style="color: #d8241f;">(</span><span style="color: #66cccc;">"Hello in LogEntry"</span><span style="color: #d8241f;">)</span>
  <span style="color: #99cc99;">private</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">message</span>;

  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">String</span> <span style="color: #f99157;">getMessage</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    <span style="color: #99cc99;">return</span> message;
  <span style="color: #d8241f;">}</span>

  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">setMessage</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">message</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    <span style="color: #99cc99;">this</span>.message = message;
  <span style="color: #d8241f;">}</span>

  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">say</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"say: "</span> + message<span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
添加 Aspect 对象，对象中包含如下组件
</p>
<ol class="org-ol">
<li><code>@Aspect</code> 注解当前类为 Aspect</li>
<li><code>@EnableAspectJAutoProxy</code> 需要开启自动 Aspect 代理</li>
<li><code>@Pointcut("execution(* *.say(..))")</code> 添加切入点</li>
<li>添加增强方法
<ul class="org-ul">
<li><code>@Before("say()")</code> 前置执行函数</li>
<li><code>@After("say()")</code> 后置执行函数</li>
<li><code>@Around("say()")</code> 环绕执行函数</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">package</span> io.github.jeanhwea.app07_aop.<span style="color: #6699cc;">beans</span>;

<span style="color: #99cc99;">import</span> <span style="color: #6699cc;">org</span>.<span style="color: #6699cc;">aspectj</span>.<span style="color: #6699cc;">lang</span>.<span style="color: #6699cc;">ProceedingJoinPoint</span>;
<span style="color: #99cc99;">import</span> <span style="color: #6699cc;">org</span>.<span style="color: #6699cc;">aspectj</span>.<span style="color: #6699cc;">lang</span>.<span style="color: #6699cc;">annotation</span>.*;
<span style="color: #99cc99;">import</span> <span style="color: #6699cc;">org</span>.<span style="color: #6699cc;">springframework</span>.<span style="color: #6699cc;">context</span>.<span style="color: #6699cc;">annotation</span>.<span style="color: #6699cc;">EnableAspectJAutoProxy</span>;
<span style="color: #99cc99;">import</span> <span style="color: #6699cc;">org</span>.<span style="color: #6699cc;">springframework</span>.<span style="color: #6699cc;">stereotype</span>.<span style="color: #6699cc;">Component</span>;

<span style="color: #6699cc;">@Aspect</span>
<span style="color: #6699cc;">@Component</span>
<span style="color: #6699cc;">@EnableAspectJAutoProxy</span>
<span style="color: #99cc99;">public</span> <span style="color: #99cc99;">class</span> <span style="color: #6699cc;">LogEntryAspect</span> <span style="color: #8d5649;">{</span>

  <span style="color: #6699cc;">@Pointcut</span><span style="color: #d8241f;">(</span><span style="color: #66cccc;">"execution(* *.say(..))"</span><span style="color: #d8241f;">)</span>
  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">say</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{}</span>

  <span style="color: #6699cc;">@Before</span><span style="color: #d8241f;">(</span><span style="color: #66cccc;">"say()"</span><span style="color: #d8241f;">)</span>
  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">beforeSay</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"beforeSay"</span><span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #6699cc;">@After</span><span style="color: #d8241f;">(</span><span style="color: #66cccc;">"say()"</span><span style="color: #d8241f;">)</span>
  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">afterSay</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"afterSay"</span><span style="color: #9564bf;">)</span>;
  <span style="color: #d8241f;">}</span>

  <span style="color: #6699cc;">@Around</span><span style="color: #d8241f;">(</span><span style="color: #66cccc;">"say()"</span><span style="color: #d8241f;">)</span>
  <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">aroundSay</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">ProceedingJoinPoint</span> <span style="color: #ffcc66;">point</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"aroundSay/preActions"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">obj</span> = <span style="color: #6699cc;">null</span>;
    <span style="color: #99cc99;">try</span> <span style="color: #9564bf;">{</span>
      obj = point.proceed<span style="color: #24a222;">()</span>;
    <span style="color: #9564bf;">}</span> <span style="color: #99cc99;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">Throwable</span> <span style="color: #ffcc66;">e</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
      e.printStackTrace<span style="color: #24a222;">()</span>;
    <span style="color: #9564bf;">}</span>
    System.out.println<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"aroundSay/postActions"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #99cc99;">return</span> obj;
  <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org624c7c0" class="outline-3">
<h3 id="org624c7c0"><span class="section-number-3">5.3</span> AOP 实现原理: <code>&lt;aspectj-autoproxy/&gt;</code> 自动注解</h3>
<div class="outline-text-3" id="text-5-3">
<p>
<code>AopNamespaceHandler</code> 类中添加自动注解  标签
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">class</span> <span style="color: #6699cc;">AopNamespaceHandler</span> <span style="color: #99cc99;">extends</span> <span style="color: #6699cc;">NamespaceHandlerSupport</span> <span style="color: #8d5649;">{</span>

    <span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;">     * Register the </span><span style="color: #6699cc;">{@link BeanDefinitionParser BeanDefinitionParsers}</span><span style="color: #cc99cc;"> for the</span>
<span style="color: #cc99cc;">     * '</span><span style="color: #6699cc;">{@code config}</span><span style="color: #cc99cc;">', '</span><span style="color: #6699cc;">{@code spring-configured}</span><span style="color: #cc99cc;">', '</span><span style="color: #6699cc;">{@code aspectj-autoproxy}</span><span style="color: #cc99cc;">'</span>
<span style="color: #cc99cc;">     * and '</span><span style="color: #6699cc;">{@code scoped-proxy}</span><span style="color: #cc99cc;">' tags.</span>
<span style="color: #cc99cc;">     */</span>
    <span style="color: #6699cc;">@Override</span>
    <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">init</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">In 2.0 XSD as well as in 2.1 XSD.</span>
        registerBeanDefinitionParser<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"config"</span>, <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ConfigBeanDefinitionParser</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        registerBeanDefinitionParser<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"aspectj-autoproxy"</span>, <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">AspectJAutoProxyBeanDefinitionParser</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        registerBeanDefinitionDecorator<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"scoped-proxy"</span>, <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ScopedProxyBeanDefinitionDecorator</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;

        <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Only in 2.0 XSD: moved to context namespace as of 2.1</span>
        registerBeanDefinitionParser<span style="color: #9564bf;">(</span><span style="color: #66cccc;">"spring-configured"</span>, <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">SpringConfiguredBeanDefinitionParser</span><span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>NamespaceHandler</code> 提供 <code>BeanDefinitionParser</code> 的 <code>&lt;aop:config&gt;</code> 标签支持，例
如接入地 <code>&lt;pointcut/&gt;</code> 标签的定义
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #cc99cc;">aop</span>:<span style="color: #f99157;">pointcut</span> <span style="color: #ffcc66;">id</span>=<span style="color: #66cccc;">"getNameCalls"</span> <span style="color: #ffcc66;">expression</span>=<span style="color: #66cccc;">"execution(* *..ITestBean.getName(..))"</span>/&gt;
</pre>
</div>

<p>
增强器 <code>&lt;advisor/&gt;</code> 标签的定义
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #cc99cc;">aop</span>:<span style="color: #f99157;">advisor</span> <span style="color: #ffcc66;">id</span>=<span style="color: #66cccc;">"getAgeAdvisor"</span>
    <span style="color: #ffcc66;">pointcut</span>=<span style="color: #66cccc;">"execution(* *..ITestBean.getAge(..))"</span>
    <span style="color: #ffcc66;">advice-ref</span>=<span style="color: #66cccc;">"getAgeCounter"</span>/&gt;

&lt;<span style="color: #cc99cc;">aop</span>:<span style="color: #f99157;">advisor</span> <span style="color: #ffcc66;">id</span>=<span style="color: #66cccc;">"getNameAdvisor"</span>
    <span style="color: #ffcc66;">pointcut-ref</span>=<span style="color: #66cccc;">"getNameCalls"</span>
    <span style="color: #ffcc66;">advice-ref</span>=<span style="color: #66cccc;">"getNameCounter"</span>/&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org1035402" class="outline-3">
<h3 id="org1035402"><span class="section-number-3">5.4</span> AOP 实现原理: 注册 <code>AnnotationAwareAspectJAutoProxyCreator</code></h3>
<div class="outline-text-3" id="text-5-4">
<p>
<code>AnnotationAwareAspectJAutoProxyCreator</code> 是自动创建 AspectJ 代理类的创建器，
该类的概览如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.aop.aspectj.annotation
Class AnnotationAwareAspectJAutoProxyCreator

    java.lang.Object
        org.springframework.aop.framework.ProxyConfig
            org.springframework.aop.framework.ProxyProcessorSupport
                org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator
                    org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator
                        org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator
                            org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator

     All Implemented Interfaces:
        Serializable, AopInfrastructureBean,
        org.springframework.beans.factory.Aware,
        org.springframework.beans.factory.BeanClassLoaderAware,
        org.springframework.beans.factory.BeanFactoryAware,
        org.springframework.beans.factory.config.BeanPostProcessor,
        org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor,
        org.springframework.beans.factory.config.SmartInstantiationAwareBeanPostProcessor,
        org.springframework.core.Ordered
</pre>
</div>
<ol class="org-ol">
<li>该类实现里 <code>BeanPostProcessor</code> 接口，在 Bean 的注册时创建添加增强器</li>
<li><code>AbstractAutoProxyCreator</code> 实现了一些 AOP 的常见方法
<ul class="org-ul">
<li><code>postProcessBeforeInstantiation(...)</code> 实例化前调用的代理类创建方法</li>
<li><code>postProcessAfterInitialization(...)</code> 初始化后调用的代理类创建方法
<ul class="org-ul">
<li>由子类声明的代理类，在改方法中调用并创建代理类</li>
</ul></li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">postProcessBeforeInstantiation</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">beanClass</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">cacheKey</span> = getCacheKey<span style="color: #d8241f;">(</span>beanClass, beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> || <span style="color: #6699cc;">!</span><span style="color: #99cc99;">this</span>.targetSourcedBeans.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.advisedBeans.containsKey<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>isInfrastructureClass<span style="color: #24a222;">(</span>beanClass<span style="color: #24a222;">)</span> || shouldSkip<span style="color: #24a222;">(</span>beanClass, beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">this</span>.advisedBeans.put<span style="color: #24a222;">(</span>cacheKey, <span style="color: #6699cc;">Boolean</span>.FALSE<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Create proxy here if we have a custom TargetSource.</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Suppresses unnecessary default instantiation of the target bean:</span>
    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">The TargetSource will handle target instances in a custom fashion.</span>
    <span style="color: #6699cc;">TargetSource</span> <span style="color: #ffcc66;">targetSource</span> = getCustomTargetSource<span style="color: #d8241f;">(</span>beanClass, beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>targetSource != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>StringUtils.hasLength<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">this</span>.targetSourcedBeans.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #6699cc;">Object</span><span style="color: #9564bf;">[]</span> <span style="color: #ffcc66;">specificInterceptors</span> = getAdvicesAndAdvisorsForBean<span style="color: #9564bf;">(</span>beanClass, beanName, targetSource<span style="color: #9564bf;">)</span>;
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">proxy</span> = createProxy<span style="color: #9564bf;">(</span>beanClass, beanName, specificInterceptors, targetSource<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.proxyTypes.put<span style="color: #9564bf;">(</span>cacheKey, proxy.getClass<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">return</span> proxy;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
Advisor 的创建的方法调用路径如下：
</p>
<div class="org-src-container">
<pre class="src src-text">findCandidateAdvisors:97, AnnotationAwareAspectJAutoProxyCreator (org.springframework.aop.aspectj.annotation)
shouldSkip:101, AspectJAwareAdvisorAutoProxyCreator (org.springframework.aop.aspectj.autoproxy)
postProcessBeforeInstantiation:251, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
applyBeanPostProcessorsBeforeInstantiation:1141, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
resolveBeforeInstantiation:1114, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:506, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 343856911 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
preInstantiateSingletons:882, DefaultListableBeanFactory (org.springframework.beans.factory.support)
finishBeanFactoryInitialization:878, AbstractApplicationContext (org.springframework.context.support)
refresh:550, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:9, MyApp07 (io.github.jeanhwea.app07_aop)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Create a proxy with the configured interceptors if the bean is</span>
<span style="color: #cc99cc;"> * identified as one to proxy by the subclass.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #getAdvicesAndAdvisorsForBean</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">postProcessAfterInitialization</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>bean != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">cacheKey</span> = getCacheKey<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span>, beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.earlyProxyReferences.remove<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span> != bean<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">return</span> wrapIfNecessary<span style="color: #24a222;">(</span>bean, beanName, cacheKey<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org789a2ad" class="outline-3">
<h3 id="org789a2ad"><span class="section-number-3">5.5</span> Creator 的注册</h3>
<div class="outline-text-3" id="text-5-5">
<p>
所有的解析器需要实现 <code>BeanDefinitionParser</code> 接口，入口函数为 <code>parse(...)</code> 方
法，而对 AspectJ 的解析器实现的源码如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">class</span> <span style="color: #6699cc;">AspectJAutoProxyBeanDefinitionParser</span> <span style="color: #99cc99;">implements</span> <span style="color: #6699cc;">BeanDefinitionParser</span> <span style="color: #8d5649;">{</span>

    <span style="color: #6699cc;">@Override</span>
    <span style="color: #6699cc;">@Nullable</span>
    <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #f99157;">parse</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">element</span>, <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>parserContext, element<span style="color: #9564bf;">)</span>;
        extendBeanDefinition<span style="color: #9564bf;">(</span>element, parserContext<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">private</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">extendBeanDefinition</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">element</span>, <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDef</span> =
                parserContext.getRegistry<span style="color: #9564bf;">()</span>.getBeanDefinition<span style="color: #9564bf;">(</span><span style="color: #6699cc;">AopConfigUtils</span>.AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>element.hasChildNodes<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            addIncludePatterns<span style="color: #24a222;">(</span>element, parserContext, beanDef<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">private</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">addIncludePatterns</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">element</span>, <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span>, <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDef</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">ManagedList</span><span style="color: #9564bf;">&lt;</span><span style="color: #6699cc;">TypedStringValue</span><span style="color: #9564bf;">&gt;</span> <span style="color: #ffcc66;">includePatterns</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ManagedList</span><span style="color: #9564bf;">&lt;&gt;()</span>;
        <span style="color: #6699cc;">NodeList</span> <span style="color: #ffcc66;">childNodes</span> = element.getChildNodes<span style="color: #9564bf;">()</span>;
        <span style="color: #99cc99;">for</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">i</span> = 0; i &lt; childNodes.<span style="color: #6699cc;">getLength</span><span style="color: #24a222;">()</span>; i++<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">Node</span> <span style="color: #ffcc66;">node</span> = childNodes.item<span style="color: #24a222;">(</span>i<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>node <span style="color: #99cc99;">instanceof</span> Element<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">includeElement</span> = <span style="color: #ff7f00;">(</span><span style="color: #6699cc;">Element</span><span style="color: #ff7f00;">)</span> node;
                <span style="color: #6699cc;">TypedStringValue</span> <span style="color: #ffcc66;">valueHolder</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">TypedStringValue</span><span style="color: #ff7f00;">(</span>includeElement.getAttribute<span style="color: #1776b6;">(</span><span style="color: #66cccc;">"name"</span><span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                valueHolder.setSource<span style="color: #ff7f00;">(</span>parserContext.extractSource<span style="color: #1776b6;">(</span>includeElement<span style="color: #1776b6;">)</span><span style="color: #ff7f00;">)</span>;
                includePatterns.add<span style="color: #ff7f00;">(</span>valueHolder<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>includePatterns.isEmpty<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            includePatterns.setSource<span style="color: #24a222;">(</span>parserContext.extractSource<span style="color: #ff7f00;">(</span>element<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
            beanDef.getPropertyValues<span style="color: #24a222;">()</span>.add<span style="color: #24a222;">(</span><span style="color: #66cccc;">"includePatterns"</span>, includePatterns<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
如果是注解的 AspectJ 最终通过 <code>registerOrEscalateApcAsRequired(...)</code> 方法自动
创建代理器
</p>
<div class="org-src-container">
<pre class="src src-text">registerOrEscalateApcAsRequired:121, AopConfigUtils (org.springframework.aop.config)
registerAspectJAnnotationAutoProxyCreatorIfNecessary:100, AopConfigUtils (org.springframework.aop.config)
registerAspectJAnnotationAutoProxyCreatorIfNecessary:93, AopConfigUtils (org.springframework.aop.config)
registerBeanDefinitions:45, AspectJAutoProxyRegistrar (org.springframework.context.annotation)
registerBeanDefinitions:86, ImportBeanDefinitionRegistrar (org.springframework.context.annotation)
lambda$loadBeanDefinitionsFromRegistrars$1:385, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
accept:-1, 1608297024 (org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader$$Lambda$45)
forEach:684, LinkedHashMap (java.util)
loadBeanDefinitionsFromRegistrars:384, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
loadBeanDefinitionsForConfigurationClass:148, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
loadBeanDefinitions:120, ConfigurationClassBeanDefinitionReader (org.springframework.context.annotation)
processConfigBeanDefinitions:331, ConfigurationClassPostProcessor (org.springframework.context.annotation)
postProcessBeanDefinitionRegistry:236, ConfigurationClassPostProcessor (org.springframework.context.annotation)
invokeBeanDefinitionRegistryPostProcessors:275, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:95, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:9, MyApp07 (io.github.jeanhwea.app07_aop)
</pre>
</div>

<p>
<code>registerOrEscalateApcAsRequired(...)</code> 的实现如下：
</p>
<ol class="org-ol">
<li>如果存在自动代理创建器
<ul class="org-ul">
<li>通过优先级判断需要使用哪个创建器</li>
<li>如果 currentPriority 小于 requiredPriority 则需要修改 Bean 的</li>
</ul></li>
<li>否则设置默认优先级等 BeanDefinition 参数</li>
<li>注意 AUTO<sub>PROXY</sub><sub>CREATOR</sub><sub>BEAN</sub><sub>NAME</sub> 的值为
<code>org.springframework.aop.config.internalAutoProxyCreator</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #6699cc;">@Nullable</span>
<span style="color: #99cc99;">private</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #f99157;">registerOrEscalateApcAsRequired</span><span style="color: #8d5649;">(</span>
        <span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">cls</span>, <span style="color: #6699cc;">BeanDefinitionRegistry</span> <span style="color: #ffcc66;">registry</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">source</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    Assert.notNull<span style="color: #d8241f;">(</span>registry, <span style="color: #66cccc;">"BeanDefinitionRegistry must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>registry.containsBeanDefinition<span style="color: #9564bf;">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">apcDefinition</span> = registry.getBeanDefinition<span style="color: #9564bf;">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #6699cc;">!</span>cls.getName<span style="color: #24a222;">()</span>.equals<span style="color: #24a222;">(</span>apcDefinition.getBeanClassName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">currentPriority</span> = findPriorityForClass<span style="color: #24a222;">(</span>apcDefinition.getBeanClassName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
            <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">requiredPriority</span> = findPriorityForClass<span style="color: #24a222;">(</span>cls<span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>currentPriority &lt; <span style="color: #6699cc;">requiredPriority</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                apcDefinition.setBeanClassName<span style="color: #ff7f00;">(</span>cls.getName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">RootBeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">RootBeanDefinition</span><span style="color: #d8241f;">(</span>cls<span style="color: #d8241f;">)</span>;
    beanDefinition.setSource<span style="color: #d8241f;">(</span>source<span style="color: #d8241f;">)</span>;
    beanDefinition.getPropertyValues<span style="color: #d8241f;">()</span>.add<span style="color: #d8241f;">(</span><span style="color: #66cccc;">"order"</span>, <span style="color: #6699cc;">Ordered</span>.HIGHEST_PRECEDENCE<span style="color: #d8241f;">)</span>;
    beanDefinition.setRole<span style="color: #d8241f;">(</span><span style="color: #6699cc;">BeanDefinition</span>.ROLE_INFRASTRUCTURE<span style="color: #d8241f;">)</span>;
    registry.registerBeanDefinition<span style="color: #d8241f;">(</span>AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">return</span> beanDefinition;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>AspectJAutoProxyRegistrar</code> 类的 <code>registerBeanDefinitions(...)</code> 方法实现了注
册 <code>AspectJAnnotationAutoProxyCreator</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">class</span> <span style="color: #6699cc;">AspectJAutoProxyRegistrar</span> <span style="color: #99cc99;">implements</span> <span style="color: #6699cc;">ImportBeanDefinitionRegistrar</span> <span style="color: #8d5649;">{</span>

    <span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;">     * Register, escalate, and configure the AspectJ auto proxy creator based on the value</span>
<span style="color: #cc99cc;">     * of the @</span><span style="color: #6699cc;">{@link EnableAspectJAutoProxy#proxyTargetClass()}</span><span style="color: #cc99cc;"> attribute on the importing</span>
<span style="color: #cc99cc;">     * </span><span style="color: #6699cc;">{@code @Configuration}</span><span style="color: #cc99cc;"> class.</span>
<span style="color: #cc99cc;">     */</span>
    <span style="color: #6699cc;">@Override</span>
    <span style="color: #99cc99;">public</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerBeanDefinitions</span><span style="color: #d8241f;">(</span>
            <span style="color: #6699cc;">AnnotationMetadata</span> <span style="color: #ffcc66;">importingClassMetadata</span>, <span style="color: #6699cc;">BeanDefinitionRegistry</span> <span style="color: #ffcc66;">registry</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>registry<span style="color: #9564bf;">)</span>;

        <span style="color: #6699cc;">AnnotationAttributes</span> <span style="color: #ffcc66;">enableAspectJAutoProxy</span> =
                AnnotationConfigUtils.attributesFor<span style="color: #9564bf;">(</span>importingClassMetadata, EnableAspectJAutoProxy.<span style="color: #99cc99;">class</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>enableAspectJAutoProxy != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>enableAspectJAutoProxy.getBoolean<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"proxyTargetClass"</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>enableAspectJAutoProxy.getBoolean<span style="color: #ff7f00;">(</span><span style="color: #66cccc;">"exposeProxy"</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToExposeProxy<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org14985b1" class="outline-3">
<h3 id="org14985b1"><span class="section-number-3">5.6</span> AOP 工具类 <code>AopNamespaceUtils</code></h3>
<div class="outline-text-3" id="text-5-6">
<p>
<code>AopNamespaceUtils</code> 实现了常用方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #99cc99;">public</span> <span style="color: #99cc99;">abstract</span> <span style="color: #99cc99;">class</span> <span style="color: #6699cc;">AopNamespaceUtils</span> <span style="color: #8d5649;">{</span>

    <span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;">     * The </span><span style="color: #6699cc;">{@code proxy-target-class}</span><span style="color: #cc99cc;"> attribute as found on AOP-related XML tags.</span>
<span style="color: #cc99cc;">     */</span>
    <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">static</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">PROXY_TARGET_CLASS_ATTRIBUTE</span> = <span style="color: #66cccc;">"proxy-target-class"</span>;

    <span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;">     * The </span><span style="color: #6699cc;">{@code expose-proxy}</span><span style="color: #cc99cc;"> attribute as found on AOP-related XML tags.</span>
<span style="color: #cc99cc;">     */</span>
    <span style="color: #99cc99;">private</span> <span style="color: #99cc99;">static</span> <span style="color: #99cc99;">final</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">EXPOSE_PROXY_ATTRIBUTE</span> = <span style="color: #66cccc;">"expose-proxy"</span>;


    <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerAutoProxyCreatorIfNecessary</span><span style="color: #d8241f;">(</span>
            <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span>, <span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span> = AopConfigUtils.registerAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>
                parserContext.getRegistry<span style="color: #24a222;">()</span>, parserContext.extractSource<span style="color: #24a222;">(</span>sourceElement<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        useClassProxyingIfNecessary<span style="color: #9564bf;">(</span>parserContext.getRegistry<span style="color: #24a222;">()</span>, sourceElement<span style="color: #9564bf;">)</span>;
        registerComponentIfNecessary<span style="color: #9564bf;">(</span>beanDefinition, parserContext<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerAspectJAutoProxyCreatorIfNecessary</span><span style="color: #d8241f;">(</span>
            <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span>, <span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span> = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>
                parserContext.getRegistry<span style="color: #24a222;">()</span>, parserContext.extractSource<span style="color: #24a222;">(</span>sourceElement<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        useClassProxyingIfNecessary<span style="color: #9564bf;">(</span>parserContext.getRegistry<span style="color: #24a222;">()</span>, sourceElement<span style="color: #9564bf;">)</span>;
        registerComponentIfNecessary<span style="color: #9564bf;">(</span>beanDefinition, parserContext<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span style="color: #d8241f;">(</span>
            <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span>, <span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>

        <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span> = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary<span style="color: #9564bf;">(</span>
                parserContext.getRegistry<span style="color: #24a222;">()</span>, parserContext.extractSource<span style="color: #24a222;">(</span>sourceElement<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        useClassProxyingIfNecessary<span style="color: #9564bf;">(</span>parserContext.getRegistry<span style="color: #24a222;">()</span>, sourceElement<span style="color: #9564bf;">)</span>;
        registerComponentIfNecessary<span style="color: #9564bf;">(</span>beanDefinition, parserContext<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">private</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">useClassProxyingIfNecessary</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">BeanDefinitionRegistry</span> <span style="color: #ffcc66;">registry</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Element</span> <span style="color: #ffcc66;">sourceElement</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>sourceElement != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">proxyTargetClass</span> = Boolean.parseBoolean<span style="color: #24a222;">(</span>sourceElement.getAttribute<span style="color: #ff7f00;">(</span>PROXY_TARGET_CLASS_ATTRIBUTE<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>proxyTargetClass<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #6699cc;">boolean</span> <span style="color: #ffcc66;">exposeProxy</span> = Boolean.parseBoolean<span style="color: #24a222;">(</span>sourceElement.getAttribute<span style="color: #ff7f00;">(</span>EXPOSE_PROXY_ATTRIBUTE<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
            <span style="color: #99cc99;">if</span> <span style="color: #24a222;">(</span>exposeProxy<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                AopConfigUtils.forceAutoProxyCreatorToExposeProxy<span style="color: #ff7f00;">(</span>registry<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">private</span> <span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">registerComponentIfNecessary</span><span style="color: #d8241f;">(</span><span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">BeanDefinition</span> <span style="color: #ffcc66;">beanDefinition</span>, <span style="color: #6699cc;">ParserContext</span> <span style="color: #ffcc66;">parserContext</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>beanDefinition != <span style="color: #6699cc;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            parserContext.registerComponent<span style="color: #24a222;">(</span>
                    <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">BeanComponentDefinition</span><span style="color: #ff7f00;">(</span>beanDefinition, <span style="color: #6699cc;">AopConfigUtils</span>.AUTO_PROXY_CREATOR_BEAN_NAME<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org895e731" class="outline-3">
<h3 id="org895e731"><span class="section-number-3">5.7</span> 创建 AOP 代理</h3>
<div class="outline-text-3" id="text-5-7">
</div>
<div id="outline-container-org963f9ae" class="outline-4">
<h4 id="org963f9ae"><span class="section-number-4">5.7.1</span> 抽象代理创建器 AbstractAutoProxyCreator</h4>
<div class="outline-text-4" id="text-5-7-1">
<p>
<code>postProcessAfterInitialization(...)</code> 方法中调用了包裹 bean 的
<code>wrapIfNecessary(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Create a proxy with the configured interceptors if the bean is</span>
<span style="color: #cc99cc;"> * identified as one to proxy by the subclass.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #getAdvicesAndAdvisorsForBean</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #6699cc;">@Override</span>
<span style="color: #99cc99;">public</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">postProcessAfterInitialization</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>bean != <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">cacheKey</span> = getCacheKey<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span>, beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.earlyProxyReferences.remove<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span> != bean<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #99cc99;">return</span> wrapIfNecessary<span style="color: #24a222;">(</span>bean, beanName, cacheKey<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
<code>wrapIfNecessary(...)</code> 方法
</p>
<ol class="org-ol">
<li>前置判断是否需要创建增强器</li>
<li>如果存在增强方法
<ul class="org-ul">
<li><code>getAdvicesAndAdvisorsForBean(...)</code> 获取拦截器，如果有拦截器说明该方法
需要增强</li>
</ul></li>
<li>调用 <code>createProxy(...)</code> 方法创建代理类</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Wrap the given bean if necessary, i.e. if it is eligible for being proxied.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> bean the raw bean instance</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> cacheKey the cache key for metadata access</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> a proxy wrapping the bean, or the raw bean instance as-is</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">wrapIfNecessary</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">bean</span>, <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>, <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">cacheKey</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> &amp;&amp; <span style="color: #99cc99;">this</span>.targetSourcedBeans.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">return</span> bean;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">Boolean</span>.FALSE.equals<span style="color: #9564bf;">(</span><span style="color: #99cc99;">this</span>.advisedBeans.get<span style="color: #24a222;">(</span>cacheKey<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">return</span> bean;
    <span style="color: #d8241f;">}</span>
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>isInfrastructureClass<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> || shouldSkip<span style="color: #9564bf;">(</span>bean.getClass<span style="color: #24a222;">()</span>, beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.advisedBeans.put<span style="color: #9564bf;">(</span>cacheKey, <span style="color: #6699cc;">Boolean</span>.FALSE<span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">return</span> bean;
    <span style="color: #d8241f;">}</span>

    <span style="color: #999999; font-style: italic;">// </span><span style="color: #999999; font-style: italic;">Create proxy if we have advice.</span>
    <span style="color: #6699cc;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">specificInterceptors</span> = getAdvicesAndAdvisorsForBean<span style="color: #d8241f;">(</span>bean.getClass<span style="color: #9564bf;">()</span>, beanName, <span style="color: #6699cc;">null</span><span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>specificInterceptors != DO_NOT_PROXY<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">this</span>.advisedBeans.put<span style="color: #9564bf;">(</span>cacheKey, <span style="color: #6699cc;">Boolean</span>.TRUE<span style="color: #9564bf;">)</span>;
        <span style="color: #6699cc;">Object</span> <span style="color: #ffcc66;">proxy</span> = createProxy<span style="color: #9564bf;">(</span>
                bean.getClass<span style="color: #24a222;">()</span>, beanName, specificInterceptors, <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">SingletonTargetSource</span><span style="color: #24a222;">(</span>bean<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">this</span>.proxyTypes.put<span style="color: #9564bf;">(</span>cacheKey, proxy.getClass<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
        <span style="color: #99cc99;">return</span> proxy;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">this</span>.advisedBeans.put<span style="color: #d8241f;">(</span>cacheKey, <span style="color: #6699cc;">Boolean</span>.FALSE<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
创建代理类的调用栈如下
</p>
<div class="org-src-container">
<pre class="src src-text">createProxy:445, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
wrapIfNecessary:350, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
postProcessAfterInitialization:299, AbstractAutoProxyCreator (org.springframework.aop.framework.autoproxy)
applyBeanPostProcessorsAfterInitialization:431, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
initializeBean:1800, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:595, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 343856911 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
preInstantiateSingletons:882, DefaultListableBeanFactory (org.springframework.beans.factory.support)
finishBeanFactoryInitialization:878, AbstractApplicationContext (org.springframework.context.support)
refresh:550, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:9, MyApp07 (io.github.jeanhwea.app07_aop)
</pre>
</div>

<p>
<code>createProxy(...)</code> 方法逻辑如下
</p>
<ol class="org-ol">
<li>获取增强方法或者增强器</li>
<li>根据获取的增强进行代理</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #cc99cc;">/**</span>
<span style="color: #cc99cc;"> * Create an AOP proxy for the given bean.</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanClass the class of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> beanName the name of the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> specificInterceptors the set of interceptors that is</span>
<span style="color: #cc99cc;"> * specific to this bean (may be empty, but not null)</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@param</span><span style="color: #cc99cc;"> targetSource the TargetSource for the proxy,</span>
<span style="color: #cc99cc;"> * already pre-configured to access the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@return</span><span style="color: #cc99cc;"> the AOP proxy for the bean</span>
<span style="color: #cc99cc;"> * </span><span style="color: #6699cc;">@see</span><span style="color: #cc99cc;"> #buildAdvisors</span>
<span style="color: #cc99cc;"> */</span>
<span style="color: #99cc99;">protected</span> <span style="color: #6699cc;">Object</span> <span style="color: #f99157;">createProxy</span><span style="color: #8d5649;">(</span><span style="color: #6699cc;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #ffcc66;">beanClass</span>, <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">String</span> <span style="color: #ffcc66;">beanName</span>,
        <span style="color: #6699cc;">@Nullable</span> <span style="color: #6699cc;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">specificInterceptors</span>, <span style="color: #6699cc;">TargetSource</span> <span style="color: #ffcc66;">targetSource</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.beanFactory <span style="color: #99cc99;">instanceof</span> ConfigurableListableBeanFactory<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AutoProxyUtils.exposeTargetClass<span style="color: #9564bf;">(</span><span style="color: #24a222;">(</span><span style="color: #6699cc;">ConfigurableListableBeanFactory</span><span style="color: #24a222;">)</span> <span style="color: #99cc99;">this</span>.beanFactory, beanName, beanClass<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">ProxyFactory</span> <span style="color: #ffcc66;">proxyFactory</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">ProxyFactory</span><span style="color: #d8241f;">()</span>;
    proxyFactory.copyFrom<span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span><span style="color: #d8241f;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span><span style="color: #6699cc;">!</span>proxyFactory.isProxyTargetClass<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #99cc99;">if</span> <span style="color: #9564bf;">(</span>shouldProxyTargetClass<span style="color: #24a222;">(</span>beanClass, beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            proxyFactory.setProxyTargetClass<span style="color: #24a222;">(</span><span style="color: #6699cc;">true</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #99cc99;">else</span> <span style="color: #9564bf;">{</span>
            evaluateProxyInterfaces<span style="color: #24a222;">(</span>beanClass, proxyFactory<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #6699cc;">Advisor</span><span style="color: #d8241f;">[]</span> <span style="color: #ffcc66;">advisors</span> = buildAdvisors<span style="color: #d8241f;">(</span>beanName, specificInterceptors<span style="color: #d8241f;">)</span>;
    proxyFactory.addAdvisors<span style="color: #d8241f;">(</span>advisors<span style="color: #d8241f;">)</span>;
    proxyFactory.setTargetSource<span style="color: #d8241f;">(</span>targetSource<span style="color: #d8241f;">)</span>;
    customizeProxyFactory<span style="color: #d8241f;">(</span>proxyFactory<span style="color: #d8241f;">)</span>;

    proxyFactory.setFrozen<span style="color: #d8241f;">(</span><span style="color: #99cc99;">this</span>.freezeProxy<span style="color: #d8241f;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #d8241f;">(</span>advisorsPreFiltered<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        proxyFactory.setPreFiltered<span style="color: #9564bf;">(</span><span style="color: #6699cc;">true</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #99cc99;">return</span> proxyFactory.getProxy<span style="color: #d8241f;">(</span>getProxyClassLoader<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6eae544" class="outline-4">
<h4 id="org6eae544"><span class="section-number-4">5.7.2</span> 获取增强器 AspectJAwareAdvisorAutoProxyCreator</h4>
<div class="outline-text-4" id="text-5-7-2">
<p>
<code>AspectJAwareAdvisorAutoProxyCreator</code> 是增强器自动代理创建器
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.aop.aspectj.autoproxy
Class AspectJAwareAdvisorAutoProxyCreator

    java.lang.Object
        org.springframework.aop.framework.ProxyConfig
            org.springframework.aop.framework.ProxyProcessorSupport
                org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator
                    org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator
                        org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator

 All Implemented Interfaces:
     Serializable, AopInfrastructureBean,
     org.springframework.beans.factory.Aware,
     org.springframework.beans.factory.BeanClassLoaderAware,
     org.springframework.beans.factory.BeanFactoryAware,
     org.springframework.beans.factory.config.BeanPostProcessor,
     org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor,
     org.springframework.beans.factory.config.SmartInstantiationAwareBeanPostProcessor,
     org.springframework.core.Ordered
</pre>
</div>
</div>
</div>

<div id="outline-container-org71c761f" class="outline-4">
<h4 id="org71c761f"><span class="section-number-4">5.7.3</span> 寻找增强器</h4>
</div>

<div id="outline-container-org86eb1de" class="outline-4">
<h4 id="org86eb1de"><span class="section-number-4">5.7.4</span> 创建代理</h4>
</div>
</div>

<div id="outline-container-org463c5ed" class="outline-3">
<h3 id="org463c5ed"><span class="section-number-3">5.8</span> 创建 AOP 静态代理</h3>
<div class="outline-text-3" id="text-5-8">
</div>
<div id="outline-container-org6d9c95f" class="outline-4">
<h4 id="org6d9c95f"><span class="section-number-4">5.8.1</span> Instrumentation 使用</h4>
</div>

<div id="outline-container-org589f60f" class="outline-4">
<h4 id="org589f60f"><span class="section-number-4">5.8.2</span> 自定义标签</h4>
</div>

<div id="outline-container-orga782514" class="outline-4">
<h4 id="orga782514"><span class="section-number-4">5.8.3</span> 织入 Weaving</h4>
</div>
</div>
</div>

<div id="outline-container-orgac0ed36" class="outline-2">
<h2 id="orgac0ed36"><span class="section-number-2">6</span> SpringBoot 自动装配</h2>
</div>
<div id="outline-container-org4cc7bc9" class="outline-2">
<h2 id="org4cc7bc9"><span class="section-number-2">7</span> 参考链接</h2>
<div class="outline-text-2" id="text-7">
<ol class="org-ol">
<li><a href="https://github.com/spring-projects/spring-framework">Spring Framework on Github</a></li>
<li><a href="https://spring.io/projects/spring-framework">Spring Framework Documentation</a></li>
<li><a href="https://huifer.github.io/spring-analysis/">Spring Analysis</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-07-21 Wed 16:55. Created by Jinghui Hu at 2021-07-14 Wed 12:16.</p>
</div>
</body>
</html>
