<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-18 Sun 01:27 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring Framework v5.2.5.RELEASE</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring Framework v5.2.5.RELEASE</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org09fdc6c">1. 容器实现原理</a>
<ul>
<li><a href="#orgba822bb">1.1. Bean 工厂接口: BeanFactory</a></li>
<li><a href="#org92ef925">1.2. Bean 工厂的实现类: DefaultListableBeanFactory</a></li>
<li><a href="#org498ec2c">1.3. Bean 定义的读取器: XmlBeanDefinitionReader</a></li>
<li><a href="#orgee3d83d">1.4. BeanDefinition 自动加载流程</a></li>
<li><a href="#orgb959e56">1.5. BeanDefinition 注册的实现</a></li>
<li><a href="#org08cae01">1.6. BeanDefinition 移除的实现</a></li>
<li><a href="#org74d1119">1.7. BeanDefinition 获取的实现</a></li>
<li><a href="#orge39ba5c">1.8. <code>&lt;bean/&gt;</code> 标签解析</a></li>
</ul>
</li>
<li><a href="#org899beb5">2. Bean 实现原理</a>
<ul>
<li><a href="#org6deebf8">2.1. Bean 的生命周期</a></li>
<li><a href="#org3ea8be7">2.2. Bean 的流程分析</a>
<ul>
<li><a href="#org2a2d4ab">2.2.1. 实例化 Bean: <code>instantiateBean()</code> 方法</a></li>
<li><a href="#orgca15760">2.2.2. 获取 Bean 实例: <code>doGetBean()</code> 方法</a></li>
</ul>
</li>
<li><a href="#org3135a63">2.3. FactoryBean</a></li>
</ul>
</li>
<li><a href="#orgc7cc552">3. IoC</a>
<ul>
<li><a href="#org4b9254a">3.1. IoC 核心接口和类</a></li>
</ul>
</li>
<li><a href="#orgfd6c087">4. ApplicationContext</a></li>
<li><a href="#org40d7b12">5. AOP</a></li>
<li><a href="#orgfb71311">6. Spring 核心类梳理</a></li>
<li><a href="#org61c2bcb">7. SpringBoot 自动装配</a></li>
<li><a href="#orgd3a2d38">8. 参考链接</a></li>
</ul>
</div>
</div>

<div id="outline-container-org09fdc6c" class="outline-2">
<h2 id="org09fdc6c"><span class="section-number-2">1</span> 容器实现原理</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgba822bb" class="outline-3">
<h3 id="orgba822bb"><span class="section-number-3">1.1</span> Bean 工厂接口: BeanFactory</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<code>BeanFactory</code> 是 Spring 的 Bean 工厂的接口定义，它定义对 Spring Bean 容器访问的
基本操作方法，这里简化如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #268bd2;">BeanFactory</span> <span style="color: #8d5649;">{</span>

  <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">FactoryBean &#30340; beanName &#21069;&#32512;</span>
  <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">FACTORY_BEAN_PREFIX</span> = <span style="color: #2aa198;">"&amp;"</span>;

  <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">&#33719;&#21462; Bean &#30340;&#20027;&#26041;&#27861;</span>
  <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">Object</span>... <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span>, <span style="color: #268bd2;">Object</span>... <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;

  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #268bd2;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #268bd2;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #268bd2;">ResolvableType</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span>;

  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">containsBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span>;

  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isSingleton</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;
  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isPrototype</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;

  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">ResolvableType</span> <span style="color: #6c71c4;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;
  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;

  <span style="color: #268bd2;">@Nullable</span>
  <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">getType</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;
  <span style="color: #268bd2;">@Nullable</span>
  <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">getType</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">allowFactoryBeanInit</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;

  <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #b58900;">getAliases</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org92ef925" class="outline-3">
<h3 id="org92ef925"><span class="section-number-3">1.2</span> Bean 工厂的实现类: DefaultListableBeanFactory</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<code>DefaultListableBeanFactory</code> 是实现 <code>BeanFactory</code> 接口的核心类，熟悉它的类继
承和实现接口是了解 Bean 工厂功能的基本方法， <code>DefaultListableBeanFactory</code> 的
关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultListableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory
                            org.springframework.beans.factory.support.DefaultListableBeanFactory

    All Implemented Interfaces:
        Serializable, BeanFactory, AutowireCapableBeanFactory,
        ConfigurableBeanFactory, ConfigurableListableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory, ListableBeanFactory,
        BeanDefinitionRegistry, org.springframework.core.AliasRegistry

    Direct Known Subclasses:
        XmlBeanFactory
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><code>SimpleAliasRegistry</code> 实现了 <code>AliasRegistry</code> 接口
<ul class="org-ul">
<li><code>AliasRegistry</code> 定义了对别名的增删查改操作</li>
</ul></li>
<li><code>DefaultSingletonBeanRegistry</code> 实现了 <code>SingletonBeanRegistry</code> 接口
<ul class="org-ul">
<li><code>SingletonBeanRegistry</code> 定义了对单例 Bean 的注册及获取方法</li>
<li><code>SingletonBeanRegistry</code> 通过三级缓存来解决循环依赖</li>
</ul></li>
<li><code>FactoryBeanRegistrySupport</code> 实现了对 <code>FactoryBean</code> 的操作支持
<ul class="org-ul">
<li>在 Spring 管理中, <code>FactoryBean</code> 的 beanName 以 <code>&amp;</code> 开头</li>
<li><code>FactoryBean</code> 的创建方式和普通 Spring Bean 是不一样的，它没有
BeanDefinition, 直接通过实现 <code>T getObject()</code> 方法来返回创建的 Bean 对象</li>
<li><code>FactoryBean</code> 还需要实现一些其他的方法，例如： <code>isSingleton()</code>,
<code>getObjectType()</code></li>
</ul></li>
<li><code>AbstractBeanFactory</code> 实现了 <code>BeanFactory</code> 接口
<ul class="org-ul">
<li><code>BeanFactory</code> 接口的直接实现是 <code>AbstractBeanFactory</code> 抽象类</li>
<li><code>AbstractBeanFactory</code> 有很多核心方法
<ul class="org-ul">
<li><code>doGetBean(...)</code> 实现了获取 Bean 的核心逻辑</li>
<li><code>isSingleton(...)</code> 实现了判断 Bean 是否单例的核心逻辑</li>
<li><code>isPrototype(...)</code> 实现了判断 Bean 是否原型的核心逻辑</li>
</ul></li>
</ul></li>
<li><code>HierarchicalBeanFactory</code> 接口继承自 <code>BeanFactory</code>, 它增强了对 parentFactory
的支持</li>
<li><code>ConfigurableBeanFactory</code> 接口提供了配置 Factory 的各种操作
<ul class="org-ul">
<li><code>setBeanClassLoader(...)</code> 设置 Bean 的类加载器</li>
<li><code>registerDependentBean(...)</code> 方法注册依赖 Bean</li>
<li><code>registerScope(...)</code> 注册 Scope</li>
<li><code>isFactoryBean(...)</code> 判断是否为 FactoryBean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
</ul></li>
<li><code>ListableBeanFactory</code> 定义了一些获取 Bean 清单的操作
<ul class="org-ul">
<li><code>getBeanDefinitionCount()</code> 获取工厂中定义 BeanDefinition 的数量</li>
<li><code>getBeanDefinitionNames()</code> 获取工厂定义的 BeanDefinition 名称</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org498ec2c" class="outline-3">
<h3 id="org498ec2c"><span class="section-number-3">1.3</span> Bean 定义的读取器: XmlBeanDefinitionReader</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<code>XmlBeanDefinitionReader</code> 是实现读取 BeanDefinition 的类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.xml
Class XmlBeanDefinitionReader

    java.lang.Object
        org.springframework.beans.factory.support.AbstractBeanDefinitionReader
            org.springframework.beans.factory.xml.XmlBeanDefinitionReader

    All Implemented Interfaces:
        BeanDefinitionReader, org.springframework.core.env.EnvironmentCapable
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><p>
<code>AbstractBeanDefinitionReader</code> 实现了对 BeanDefinition 的读取操作，它包含
如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">BeanDefinitionRegistry</span> <span style="color: #6c71c4;">registry</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">ResourceLoader</span> <span style="color: #6c71c4;">resourceLoader</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">ClassLoader</span> <span style="color: #6c71c4;">beanClassLoader</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">Environment</span> <span style="color: #6c71c4;">environment</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">BeanNameGenerator</span> <span style="color: #6c71c4;">beanNameGenerator</span> = <span style="color: #268bd2;">DefaultBeanNameGenerator</span>.INSTANCE;
</pre>
</div>
<ul class="org-ul">
<li>registry 表示 BeanDefinition 的注册类</li>
<li>resourceLoader 实现了资源加载</li>
<li>environment 实现了读取系统环境变量和 Java 属性</li>
<li>beanNameGenerator 是 beanName 生成器</li>
</ul></li>
<li><code>XmlBeanDefinitionReader</code> 直接继承自 <code>AbstractBeanDefinitionReader</code>, 增加了
<ul class="org-ul">
<li><code>DocumentLoader</code> 将资源转化成 Document 对象功能</li>
<li>添加了对 XML 的格式验证的方法
<ul class="org-ul">
<li>DTD (Document Type Definition) 验证</li>
<li>XSD (XML Schema Definition) 验证</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgee3d83d" class="outline-3">
<h3 id="orgee3d83d"><span class="section-number-3">1.4</span> BeanDefinition 自动加载流程</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<code>DefaultListableBeanFactory</code> 类定义了存储 BeanDefinition 类的哈希表, 具体定义如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Map of bean definition objects, keyed by bean name. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">BeanDefinition</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton and non-singleton bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">allBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton-only bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** List of bean definition names, in registration order. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">volatile</span> <span style="color: #268bd2;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionNames</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
最终 BeanDefinition 通过调用 <code>registerBeanDefinition(...)</code> 方法注册到
<code>beanDefinitionMap</code> 中，代码的注释也写了是对 <code>BeanDefinitionRegistry</code> 的实现
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #586e75; font-style: italic;">//</span><span style="color: #586e75; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #586e75; font-style: italic;">//</span><span style="color: #586e75; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2aa198;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #859900;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2aa198;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">existingDefinition</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #859900;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #268bd2;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在 <code>registerBeanDefinition(...)</code> 方法中添加端点可以获得如下的调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">registerBeanDefinition:914, DefaultListableBeanFactory (org.springframework.beans.factory.support)
registerBeanDefinition:164, BeanDefinitionReaderUtils (org.springframework.beans.factory.support)
processBeanDefinition:311, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseDefaultElement:197, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseBeanDefinitions:176, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
doRegisterBeanDefinitions:149, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:96, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:509, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
doLoadBeanDefinitions:389, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:336, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:305, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:188, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:224, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:195, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:257, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:128, AbstractXmlApplicationContext (org.springframework.context.support)
loadBeanDefinitions:94, AbstractXmlApplicationContext (org.springframework.context.support)
refreshBeanFactory:133, AbstractRefreshableApplicationContext (org.springframework.context.support)
obtainFreshBeanFactory:637, AbstractApplicationContext (org.springframework.context.support)
refresh:522, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:144, ClassPathXmlApplicationContext (org.springframework.context.support)
&lt;init&gt;:85, ClassPathXmlApplicationContext (org.springframework.context.support)
main:10, MyApp01 (io.github.jeanhwea.app01)
</pre>
</div>

<p>
观察调用栈可以得到 BeanDefinition 的加载步骤如下:
</p>
<ol class="org-ol">
<li>入口方法为 <code>AbstractApplicationContext#refresh(...)</code></li>
<li><code>obtainFreshBeanFactory(...)</code> 方法获取 BeanFactory 的同时需要注册
BeanDefinition</li>
<li><code>XmlBeanDefinitionReader#doLoadBeanDefinitions(...)</code> 方法完成如下操作
<ul class="org-ul">
<li><p>
定义了 documentLoader 成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #268bd2;">DocumentLoader</span> <span style="color: #6c71c4;">documentLoader</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">DefaultDocumentLoader</span><span style="color: #8d5649;">()</span>;
</pre>
</div></li>
<li>首先调用 <code>doLoadDocument(inputSource, resource)</code> 读取到 Document 对象</li>
<li>然后调用 <code>registerBeanDefinitions(doc, resource)</code> 完成 BeanDefinition 的
注册</li>
</ul></li>
<li>调用 <code>parseDefaultElement(...)</code> 方法对默认元素进行解析
<ul class="org-ul">
<li>对 import 类型标签解析</li>
<li>对 alias 类型标签解析</li>
<li>对 bean 类型标签解析</li>
<li>对嵌套 bean 类型标签解析</li>
</ul></li>
<li>接着对标签进行处理，最终交付到
<code>DefaultListableBeanFactory#registerBeanDefinition(...)</code> 方法进行注册</li>
</ol>
</div>
</div>

<div id="outline-container-orgb959e56" class="outline-3">
<h3 id="orgb959e56"><span class="section-number-3">1.5</span> BeanDefinition 注册的实现</h3>
<div class="outline-text-3" id="text-1-5">
<p>
<code>DefaultListableBeanFactory</code> 的 <code>registerBeanDefinition(...)</code> 才是真正实现注
册 BeanDefinition 逻辑，其代码如下：
</p>
<ol class="org-ol">
<li>对 beanDefinition 进行验证</li>
<li>检查 beanDefinition 是否存在
<ul class="org-ul">
<li>如果存在，判断是否覆盖对应的 BeanDefinition</li>
<li>如果 beanDefinition 不存在，进行创建并注册</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #586e75; font-style: italic;">//</span><span style="color: #586e75; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #586e75; font-style: italic;">//</span><span style="color: #586e75; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2aa198;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #859900;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2aa198;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">existingDefinition</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #859900;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #268bd2;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在上面注册过程中， <code>hasBeanCreationStarted()</code> 方法用于判断 Bean 是否开始创建，
它实现逻辑在父类 <code>AbstractBeanFactory</code> 中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Check whether this factory's bean creation phase already started,</span>
<span style="color: #d33682;"> * i.e. whether any bean has been marked as created in the meantime.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@since</span><span style="color: #d33682;"> 4.2.2</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #markBeanAsCreated</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">hasBeanCreationStarted</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.isEmpty<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
父类 <code>AbstractBeanFactory</code> 中定义了一个集合记录正在创建的 Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Names of beans that have already been created at least once. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">alreadyCreated</span> = Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>256<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
创建时通过 <code>markBeanAsCreated(...)</code> 方法标记，注意对 <code>alreadyCreated</code> 的访问
是需要加锁的
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Mark the specified bean as already created (or about to be created).</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">This allows the bean factory to optimize its caching for repeated</span>
<span style="color: #d33682;"> * creation of the specified bean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">markBeanAsCreated</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.mergedBeanDefinitions<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.contains<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Let the bean definition get re-merged now that we're actually creating</span>
                <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">the bean... just in case some of its metadata changed in the meantime.</span>
                clearMergedBeanDefinition<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.alreadyCreated.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org08cae01" class="outline-3">
<h3 id="org08cae01"><span class="section-number-3">1.6</span> BeanDefinition 移除的实现</h3>
<div class="outline-text-3" id="text-1-6">
<p>
BeanDefinition 的移除方法如下，通过 <code>removeBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">removeBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"'beanName' must not be empty"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.remove<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No bean named '"</span> + beanName + <span style="color: #2aa198;">"' found in "</span> + <span style="color: #859900;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>hasBeanCreationStarted<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">List</span><span style="color: #24a222;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #24a222;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #24a222;">)</span>;
            updatedDefinitions.remove<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Still in startup registration phase</span>
        <span style="color: #859900;">this</span>.beanDefinitionNames.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;

    resetBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
移除 BeanDefinition 中调用了刷新 BeanDefinition 的方法
<code>resetBeanDefinition(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Reset all bean definition caches for the given bean,</span>
<span style="color: #d33682;"> * including the caches of beans that are derived from it.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">Called after an existing bean definition has been replaced or removed,</span>
<span style="color: #d33682;"> * triggering </span><span style="color: #268bd2;">{@link #clearMergedBeanDefinition}</span><span style="color: #d33682;">, </span><span style="color: #268bd2;">{@link #destroySingleton}</span>
<span style="color: #d33682;"> * and </span><span style="color: #268bd2;">{@link MergedBeanDefinitionPostProcessor#resetBeanDefinition}</span><span style="color: #d33682;"> on the</span>
<span style="color: #d33682;"> * given bean and on all bean definitions that have the given bean as parent.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean to reset</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinition</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #removeBeanDefinition</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">resetBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Remove the merged bean definition for the given bean, if already created.</span>
    clearMergedBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Remove corresponding bean from singleton cache, if any. Shouldn't usually</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">be necessary, rather just meant for overriding a context's default beans</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">(e.g. the default StaticMessageSource in a StaticApplicationContext).</span>
    destroySingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Notify all post-processors that the specified bean definition has been reset.</span>
    <span style="color: #859900;">for</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanPostProcessor</span> <span style="color: #6c71c4;">processor</span> : getBeanPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>processor <span style="color: #859900;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">MergedBeanDefinitionPostProcessor</span><span style="color: #ff7f00;">)</span> processor<span style="color: #24a222;">)</span>.resetBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Reset all bean definitions that have the given bean as parent (recursively).</span>
    <span style="color: #859900;">for</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">bdName</span> : <span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanName.equals<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span>;
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Ensure bd is non-null due to potential concurrent modification</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">of the beanDefinitionMap.</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>bd != <span style="color: #268bd2;">null</span> &amp;&amp; beanName.equals<span style="color: #ff7f00;">(</span>bd.getParentName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                resetBeanDefinition<span style="color: #ff7f00;">(</span>bdName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org74d1119" class="outline-3">
<h3 id="org74d1119"><span class="section-number-3">1.7</span> BeanDefinition 获取的实现</h3>
<div class="outline-text-3" id="text-1-7">
<p>
<code>DefaultListableBeanFactory</code> 的实现获取 BeanDefinition 的逻辑如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #b58900;">getBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No bean named '"</span> + beanName + <span style="color: #2aa198;">"' found in "</span> + <span style="color: #859900;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> bd;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge39ba5c" class="outline-3">
<h3 id="orge39ba5c"><span class="section-number-3">1.8</span> <code>&lt;bean/&gt;</code> 标签解析</h3>
<div class="outline-text-3" id="text-1-8">
<p>
之前在 BeanDefinition 自动加载流程中忽略了对 <code>&lt;bean/&gt;</code> 标签的解析，其核心实现
逻辑 <code>BeanDefinitionDocumentReader</code> 类中的 <code>processBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Process the given bean element, parsing the bean definition</span>
<span style="color: #d33682;"> * and registering it with the registry.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">processBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Element</span> <span style="color: #6c71c4;">ele</span>, <span style="color: #268bd2;">BeanDefinitionParserDelegate</span> <span style="color: #6c71c4;">delegate</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">BeanDefinitionHolder</span> <span style="color: #6c71c4;">bdHolder</span> = delegate.parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bdHolder != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        bdHolder = delegate.decorateBeanDefinitionIfRequired<span style="color: #9564bf;">(</span>ele, bdHolder<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Register the final decorated instance.</span>
            BeanDefinitionReaderUtils.registerBeanDefinition<span style="color: #24a222;">(</span>bdHolder, getReaderContext<span style="color: #ff7f00;">()</span>.getRegistry<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getReaderContext<span style="color: #24a222;">()</span>.error<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Failed to register bean definition with name '"</span> +
                    bdHolder.getBeanName<span style="color: #ff7f00;">()</span> + <span style="color: #2aa198;">"'"</span>, ele, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Send registration event.</span>
        getReaderContext<span style="color: #9564bf;">()</span>.fireComponentRegistered<span style="color: #9564bf;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanComponentDefinition</span><span style="color: #24a222;">(</span>bdHolder<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
可以看出对 XML 标签的解析核心逻辑为 <code>parseBeanDefinitionElement(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Parses the supplied </span><span style="color: #268bd2;">{@code </span><span style="color: #268bd2;">&lt;bean&gt;</span><span style="color: #268bd2;">}</span><span style="color: #d33682;"> element. May return </span><span style="color: #268bd2;">{@code null}</span>
<span style="color: #d33682;"> * if there were errors during parse. Errors are reported to the</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">{@link org.springframework.beans.factory.parsing.ProblemReporter}</span><span style="color: #d33682;">.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@Nullable</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">BeanDefinitionHolder</span> <span style="color: #b58900;">parseBeanDefinitionElement</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Element</span> <span style="color: #6c71c4;">ele</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">containingBean</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">id</span> = ele.getAttribute<span style="color: #d8241f;">(</span>ID_ATTRIBUTE<span style="color: #d8241f;">)</span>;
    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">nameAttr</span> = ele.getAttribute<span style="color: #d8241f;">(</span>NAME_ATTRIBUTE<span style="color: #d8241f;">)</span>;

    <span style="color: #268bd2;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">aliases</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>nameAttr<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">nameArr</span> = StringUtils.tokenizeToStringArray<span style="color: #9564bf;">(</span>nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS<span style="color: #9564bf;">)</span>;
        aliases.addAll<span style="color: #9564bf;">(</span>Arrays.asList<span style="color: #24a222;">(</span>nameArr<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span> = id;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span>StringUtils.hasText<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> &amp;&amp; <span style="color: #268bd2;">!</span>aliases.isEmpty<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanName = aliases.remove<span style="color: #9564bf;">(</span>0<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No XML 'id' specified - using '"</span> + beanName +
                    <span style="color: #2aa198;">"' as bean name and "</span> + aliases + <span style="color: #2aa198;">" as aliases"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>containingBean == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        checkNameUniqueness<span style="color: #9564bf;">(</span>beanName, aliases, ele<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">AbstractBeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span> = parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele, beanName, containingBean<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>StringUtils.hasText<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">try</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>containingBean != <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    beanName = BeanDefinitionReaderUtils.generateBeanName<span style="color: #1776b6;">(</span>
                            beanDefinition, <span style="color: #859900;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>, <span style="color: #268bd2;">true</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">else</span> <span style="color: #ff7f00;">{</span>
                    beanName = <span style="color: #859900;">this</span>.readerContext.generateBeanName<span style="color: #1776b6;">(</span>beanDefinition<span style="color: #1776b6;">)</span>;
                    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Register an alias for the plain bean class name, if still possible,</span>
                    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">if the generator returned the class name plus a suffix.</span>
                    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">This is expected for Spring 1.2/2.0 backwards compatibility.</span>
                    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanClassName</span> = beanDefinition.getBeanClassName<span style="color: #1776b6;">()</span>;
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span>beanClassName != <span style="color: #268bd2;">null</span> &amp;&amp;
                            beanName.startsWith<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span> &amp;&amp; beanName.length<span style="color: #00bed1;">()</span> &gt; beanClassName.length<span style="color: #00bed1;">()</span> &amp;&amp;
                            <span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>.isBeanNameInUse<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        aliases.add<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>logger.isTraceEnabled<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    logger.trace<span style="color: #1776b6;">(</span><span style="color: #2aa198;">"Neither XML 'id' nor 'name' specified - "</span> +
                            <span style="color: #2aa198;">"using generated bean name ["</span> + beanName + <span style="color: #2aa198;">"]"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">Exception</span> <span style="color: #6c71c4;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                error<span style="color: #ff7f00;">(</span>ex.getMessage<span style="color: #1776b6;">()</span>, ele<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">aliasesArray</span> = StringUtils.toStringArray<span style="color: #9564bf;">(</span>aliases<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">return</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionHolder</span><span style="color: #9564bf;">(</span>beanDefinition, beanName, aliasesArray<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org899beb5" class="outline-2">
<h2 id="org899beb5"><span class="section-number-2">2</span> Bean 实现原理</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org6deebf8" class="outline-3">
<h3 id="org6deebf8"><span class="section-number-3">2.1</span> Bean 的生命周期</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<code>BeanFactory</code> 的注释中完整地说明的实现标准 BeanFactory 的代码
</p>
<ol class="org-ol">
<li>BeanFactory 初始化过程，支持的标准 Bean 的生命周期
<ul class="org-ul">
<li><code>BeanNameAware#setBeanName(...)</code></li>
<li><code>BeanClassLoaderAware#setBeanClassLoader(...)</code></li>
<li><code>BeanFactoryAware#setBeanFactory(...)</code></li>
<li><code>EnvironmentAware#setEnvironment(...)</code></li>
<li><code>EmbeddedValueResolverAware#setEmbeddedValueResolver(...)</code></li>
<li><code>ResourceLoaderAware#setResourceLoader(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationEventPublisherAware#setApplicationEventPublisher(...)</code> 在
ApplicationContext 中</li>
<li><code>MessageSourceAware#setMessageSource(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationContextAware#setApplicationContext(...)</code> 在
ApplicationContext 中</li>
<li><code>ServletContextAware#setServletContext(...)</code> 在 ApplicationContext 中</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessBeforeInitialization(...)</code> 方法</li>
<li><code>InitializingBean#afterPropertiesSet(...)</code></li>
<li>a custom init-method definition</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessAfterInitialization(...)</code> 方法</li>
</ul></li>
<li>关闭 BeanFactory 时，执行的 Bean 销毁方法
<ul class="org-ul">
<li><code>DestructionAwareBeanPostProcessors</code> 的一系列
<code>postProcessBeforeDestruction(...)</code> 方法</li>
<li><code>DisposableBean#destroy(...)</code></li>
<li>a custom destroy-method definition</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org3ea8be7" class="outline-3">
<h3 id="org3ea8be7"><span class="section-number-3">2.2</span> Bean 的流程分析</h3>
<div class="outline-text-3" id="text-2-2">
<p>
实例化 Bean 的方法为 <code>BeanUtils#instantiateClass(...)</code>, 先添加断点获取调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">instantiateClass:185, BeanUtils (org.springframework.beans)
instantiate:87, SimpleInstantiationStrategy (org.springframework.beans.factory.support)
instantiateBean:1312, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBeanInstance:1214, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:557, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1027007693 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$29)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
main:18, MyApp02 (io.github.jeanhwea.app02)
</pre>
</div>

<p>
先分析调用栈，可以知道创建 Bean 的入口是 <code>refresh()</code> 方法的
<code>invokeBeanFactoryPostProcessors()</code> 方法，这里牵扯到几个核心的方法
</p>
<ol class="org-ol">
<li><code>AbstractApplicationContext#refresh()</code></li>
<li><code>AbstractBeanFactory#doGetBean(...)</code></li>
<li><code>AbstractAutowireCapableBeanFactory#instantiateBean(...)</code></li>
</ol>
</div>

<div id="outline-container-org2a2d4ab" class="outline-4">
<h4 id="org2a2d4ab"><span class="section-number-4">2.2.1</span> 实例化 Bean: <code>instantiateBean()</code> 方法</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
<code>instantiateBean(...)</code> 实例化 Bean 主要完成如下工作
</p>
<ol class="org-ol">
<li>使用 InstantiationStrategy 实例化策略来实例化 Bean, Spring 中创建 Bean 有如
下两种方式
<ul class="org-ul">
<li>通过 <code>BeanUtils.instantiateClass()</code> 方法创建实例</li>
<li>通过 <code>new CglibSubclassCreator(bd, owner).instantiate(ctor, args)</code> 方式
进行创建</li>
</ul></li>
<li>添加 BeanWrapper 封装 Bean 对象
<ul class="org-ul">
<li>实现类为 <code>BeanWrapperImpl</code></li>
<li><code>BeanWrapperImpl</code> 继承自 <code>AbstractNestablePropertyAccessor</code></li>
<li><code>AbstractNestablePropertyAccessor#setPropertyValue(...)</code> 方法设置属性值</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Instantiate the given bean using its default constructor.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> mbd the bean definition for the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> a BeanWrapper for the new instance</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">BeanWrapper</span> <span style="color: #b58900;">instantiateBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #859900;">final</span> <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">beanInstance</span>;
        <span style="color: #859900;">final</span> <span style="color: #268bd2;">BeanFactory</span> <span style="color: #6c71c4;">parent</span> = <span style="color: #859900;">this</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            beanInstance = AccessController.doPrivileged<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">PrivilegedAction</span><span style="color: #1776b6;">&lt;</span><span style="color: #268bd2;">Object</span><span style="color: #1776b6;">&gt;</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">()</span> -&gt;
                    getInstantiationStrategy<span style="color: #ff7f00;">()</span>.instantiate<span style="color: #ff7f00;">(</span>mbd, beanName, parent<span style="color: #ff7f00;">)</span>,
                    getAccessControlContext<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            beanInstance = getInstantiationStrategy<span style="color: #24a222;">()</span>.instantiate<span style="color: #24a222;">(</span>mbd, beanName, parent<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #268bd2;">BeanWrapper</span> <span style="color: #6c71c4;">bw</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanWrapperImpl</span><span style="color: #9564bf;">(</span>beanInstance<span style="color: #9564bf;">)</span>;
        initBeanWrapper<span style="color: #9564bf;">(</span>bw<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">return</span> bw;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2aa198;">"Instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgca15760" class="outline-4">
<h4 id="orgca15760"><span class="section-number-4">2.2.2</span> 获取 Bean 实例: <code>doGetBean()</code> 方法</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
<code>doGetBean(...)</code> 方法是获取 Bean 的最终处理函数，它的逻辑比较复杂，可以分成
以下流程
</p>
<ol class="org-ol">
<li>获取 beanName
<ul class="org-ul">
<li>解析带有别名的 Bean 到最终的名称</li>
<li>去除 FactoryBean 的修饰符，即 <code>&amp;</code> 前缀</li>
</ul></li>
<li>缓存获取
<ul class="org-ul">
<li>调用 <code>DefaultSingletonBeanRegistry#getSingleton()</code> 尝试从单例容器缓存中
获取</li>
<li>单例 Bean 只创建一次，创建完成直接放入缓存，参考
<code>DefaultSingletonBeanRegistry</code> 的实现</li>
<li>依赖的 Bean 避免循环依赖，只记录 <code>ObjectFactory</code> 对象, 参考
<code>singletonFactories</code> 变量的定义及循环依赖的解决方法</li>
</ul></li>
<li>创建 Bean 实例
<ul class="org-ul">
<li>获取 FactoryBean 生成的 Bean 实例
<ul class="org-ul">
<li>FactoryBean 的实例是 <code>factory-method</code> 返回的 Bean, 后面称为
beanInstance</li>
<li><code>getObjectForBeanInstance()</code> 方法实现了获取 beanInstance 的逻辑</li>
</ul></li>
<li>如果不是 FactoryBean
<ul class="org-ul">
<li>调用 <code>isPrototypeCurrentlyInCreation(...)</code> 判断创建原型 Bean 是否出现
循环依赖</li>
<li>尝试从 parentBeanFactory 中获取 Bean</li>
<li>将 BeanDefinition 进行合并，得到 <code>RootBeanDefinition</code>, 并检验</li>
<li>调用 <code>markBeanAsCreated()</code> 方法标记创建 Bean</li>
<li>解决 Bean 依赖
<ul class="org-ul">
<li>Bean 是动态加载的，当前待创建 Bean 的可能存在依赖项</li>
<li>解决依赖的策略是顺序寻找出所有依赖，并完成创建</li>
</ul></li>
<li>通过不同的 scope 完成对应 Bean 的创建
<ul class="org-ul">
<li>单例 Bean 创建: <code>getSingleton(...)</code></li>
<li>原型 Bean 创建: <code>getSingleton(...)</code></li>
<li>其它情况 Bean 创建，例如： <code>@RequestScope</code> <code>@SessionScope</code> 等</li>
</ul></li>
</ul></li>
</ul></li>
<li>检查 Bean 实例，完成类型转换</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Return an instance, which may be shared or independent, of the specified bean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> name the name of the bean to retrieve</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> requiredType the required type of the bean to retrieve</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> args arguments to use when creating a bean instance using explicit arguments</span>
<span style="color: #d33682;"> * (only applied when creating a new instance as opposed to retrieving an existing one)</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> typeCheckOnly whether the instance is obtained for a type check,</span>
<span style="color: #d33682;"> * not for actual use</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> an instance of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeansException if the bean could not be created</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@SuppressWarnings</span><span style="color: #8d5649;">(</span><span style="color: #2aa198;">"unchecked"</span><span style="color: #8d5649;">)</span>
<span style="color: #859900;">protected</span> <span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #268bd2;">T</span> <span style="color: #b58900;">doGetBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">requiredType</span>,
        <span style="color: #268bd2;">@Nullable</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #6c71c4;">args</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">typeCheckOnly</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span> = transformedBeanName<span style="color: #d8241f;">(</span>name<span style="color: #d8241f;">)</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span>;

    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Eagerly check singleton cache for manually registered singletons.</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">sharedInstance</span> = getSingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>sharedInstance != <span style="color: #268bd2;">null</span> &amp;&amp; args == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>isSingletonCurrentlyInCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Returning eagerly cached instance of singleton bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' that is not fully initialized yet - a consequence of a circular reference"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Returning cached instance of singleton bean '"</span> + beanName + <span style="color: #2aa198;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        bean = getObjectForBeanInstance<span style="color: #9564bf;">(</span>sharedInstance, name, beanName, <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Fail if we're already creating this bean instance:</span>
        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">We're assumably within a circular reference.</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>isPrototypeCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Check if bean definition exists in this factory.</span>
        <span style="color: #268bd2;">BeanFactory</span> <span style="color: #6c71c4;">parentBeanFactory</span> = getParentBeanFactory<span style="color: #9564bf;">()</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>parentBeanFactory != <span style="color: #268bd2;">null</span> &amp;&amp; <span style="color: #268bd2;">!</span>containsBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Not found -&gt; check parent.</span>
            <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">nameToLookup</span> = originalBeanName<span style="color: #24a222;">(</span>name<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>parentBeanFactory <span style="color: #859900;">instanceof</span> AbstractBeanFactory<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #268bd2;">AbstractBeanFactory</span><span style="color: #1776b6;">)</span> parentBeanFactory<span style="color: #ff7f00;">)</span>.doGetBean<span style="color: #ff7f00;">(</span>
                        nameToLookup, requiredType, args, typeCheckOnly<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>args != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Delegation to parent with explicit args.</span>
                <span style="color: #859900;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, args<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>requiredType != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">No args -&gt; delegate to standard getBean method.</span>
                <span style="color: #859900;">return</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, requiredType<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>

        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>typeCheckOnly<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            markBeanAsCreated<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">final</span> <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span> = getMergedLocalBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            checkMergedBeanDefinition<span style="color: #24a222;">(</span>mbd, beanName, args<span style="color: #24a222;">)</span>;

            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Guarantee initialization of beans that the current bean depends on.</span>
            <span style="color: #268bd2;">String</span><span style="color: #24a222;">[]</span> <span style="color: #6c71c4;">dependsOn</span> = mbd.getDependsOn<span style="color: #24a222;">()</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>dependsOn != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">dep</span> : dependsOn<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span>isDependent<span style="color: #00bed1;">(</span>beanName, dep<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #2aa198;">"Circular depends-on relationship between '"</span> + beanName + <span style="color: #2aa198;">"' and '"</span> + dep + <span style="color: #2aa198;">"'"</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    registerDependentBean<span style="color: #1776b6;">(</span>dep, beanName<span style="color: #1776b6;">)</span>;
                    <span style="color: #859900;">try</span> <span style="color: #1776b6;">{</span>
                        getBean<span style="color: #00bed1;">(</span>dep<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #859900;">catch</span> <span style="color: #1776b6;">(</span><span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #6c71c4;">ex</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #2aa198;">"'"</span> + beanName + <span style="color: #2aa198;">"' depends on missing bean '"</span> + dep + <span style="color: #2aa198;">"'"</span>, ex<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>

            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Create bean instance.</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>mbd.isSingleton<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                sharedInstance = getSingleton<span style="color: #ff7f00;">(</span>beanName, <span style="color: #1776b6;">()</span> -&gt; <span style="color: #1776b6;">{</span>
                    <span style="color: #859900;">try</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #859900;">return</span> createBean<span style="color: #bcbf00;">(</span>beanName, mbd, args<span style="color: #bcbf00;">)</span>;
                    <span style="color: #00bed1;">}</span>
                    <span style="color: #859900;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #268bd2;">BeansException</span> <span style="color: #6c71c4;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Explicitly remove instance from singleton cache: It might have been put there</span>
                        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">eagerly by the creation process, to allow for circular reference resolution.</span>
                        <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Also remove any beans that received a temporary reference to the bean.</span>
                        destroySingleton<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #859900;">throw</span> ex;
                    <span style="color: #00bed1;">}</span>
                <span style="color: #1776b6;">}</span><span style="color: #ff7f00;">)</span>;
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>sharedInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>mbd.isPrototype<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">It's a prototype -&gt; create a new instance.</span>
                <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">prototypeInstance</span> = <span style="color: #268bd2;">null</span>;
                <span style="color: #859900;">try</span> <span style="color: #ff7f00;">{</span>
                    beforePrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                    prototypeInstance = createBean<span style="color: #1776b6;">(</span>beanName, mbd, args<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">finally</span> <span style="color: #ff7f00;">{</span>
                    afterPrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>prototypeInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #859900;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">scopeName</span> = mbd.getScope<span style="color: #ff7f00;">()</span>;
                <span style="color: #859900;">final</span> <span style="color: #268bd2;">Scope</span> <span style="color: #6c71c4;">scope</span> = <span style="color: #859900;">this</span>.scopes.get<span style="color: #ff7f00;">(</span>scopeName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>scope == <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">IllegalStateException</span><span style="color: #1776b6;">(</span><span style="color: #2aa198;">"No Scope registered for scope name '"</span> + scopeName + <span style="color: #2aa198;">"'"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">try</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">scopedInstance</span> = scope.get<span style="color: #1776b6;">(</span>beanName, <span style="color: #00bed1;">()</span> -&gt; <span style="color: #00bed1;">{</span>
                        beforePrototypeCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #859900;">try</span> <span style="color: #bcbf00;">{</span>
                            <span style="color: #859900;">return</span> createBean<span style="color: #e574c3;">(</span>beanName, mbd, args<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                        <span style="color: #859900;">finally</span> <span style="color: #bcbf00;">{</span>
                            afterPrototypeCreation<span style="color: #e574c3;">(</span>beanName<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                    <span style="color: #00bed1;">}</span><span style="color: #1776b6;">)</span>;
                    bean = getObjectForBeanInstance<span style="color: #1776b6;">(</span>scopedInstance, name, beanName, mbd<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">IllegalStateException</span> <span style="color: #6c71c4;">ex</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #2aa198;">"Scope '"</span> + scopeName + <span style="color: #2aa198;">"' is not active for the current thread; consider "</span> +
                            <span style="color: #2aa198;">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,
                            ex<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeansException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            cleanupAfterBeanCreationFailure<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">throw</span> ex;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">Check if required type matches the type of the actual bean instance.</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>requiredType != <span style="color: #268bd2;">null</span> &amp;&amp; <span style="color: #268bd2;">!</span>requiredType.isInstance<span style="color: #9564bf;">(</span>bean<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">T</span> <span style="color: #6c71c4;">convertedBean</span> = getTypeConverter<span style="color: #24a222;">()</span>.convertIfNecessary<span style="color: #24a222;">(</span>bean, requiredType<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>convertedBean == <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanNotOfRequiredTypeException</span><span style="color: #ff7f00;">(</span>name, requiredType, bean.getClass<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">return</span> convertedBean;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">TypeMismatchException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Failed to convert bean '"</span> + name + <span style="color: #2aa198;">"' to required type '"</span> +
                        ClassUtils.getQualifiedName<span style="color: #1776b6;">(</span>requiredType<span style="color: #1776b6;">)</span> + <span style="color: #2aa198;">"'"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanNotOfRequiredTypeException</span><span style="color: #24a222;">(</span>name, requiredType, bean.getClass<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">)</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3135a63" class="outline-3">
<h3 id="org3135a63"><span class="section-number-3">2.3</span> FactoryBean</h3>
<div class="outline-text-3" id="text-2-3">
<p>
FactoryBean 不同于普通的 Bean， FactoryBean 自身就是一个组装 Bean 的微型工厂，
即在调用 <code>BeanFactory#getBean(...)</code> 方法时不返回 FactoryBean，而是返回工厂方
法返回的 Bean，定义 FactoryBean 只需要实现 <code>FactoryBean</code> 接口即可
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #268bd2;">FactoryBean</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">@Nullable</span>
    <span style="color: #268bd2;">T</span> <span style="color: #b58900;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span>;

    <span style="color: #268bd2;">@Nullable</span>
    <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">getObjectType</span><span style="color: #d8241f;">()</span>;

    <span style="color: #859900;">default</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isSingleton</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">true</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ol class="org-ol">
<li><code>getObject(...)</code> 方法返回 FactoryBean 创建的实例，也称工厂方法</li>
<li><code>getObjectType(...)</code> 方法返回 FactoryBean 创建的实例的类型</li>
<li><code>isSingleton(...)</code> 方法返回FactoryBean创建的实例的Scope</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgc7cc552" class="outline-2">
<h2 id="orgc7cc552"><span class="section-number-2">3</span> IoC</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org4b9254a" class="outline-3">
<h3 id="org4b9254a"><span class="section-number-3">3.1</span> IoC 核心接口和类</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Spring 的 IoC 容器对象一般继承自 <code>ApplicationContext</code> 接口，常见的对象类如下
</p>

<p>
<code>ClassPathXmlApplicationContext</code>: 读取 ClassPath 中 XML 配置文件的 Bean 定义
的容器
</p>

<div class="org-src-container">
<pre class="src src-text">org.springframework.context.support
Class ClassPathXmlApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.AbstractRefreshableApplicationContext
                    org.springframework.context.support.AbstractRefreshableConfigApplicationContext
                        org.springframework.context.support.AbstractXmlApplicationContext
                            org.springframework.context.support.ClassPathXmlApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable, org.springframework.beans.factory.Aware,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.BeanNameAware,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.InitializingBean,
        org.springframework.beans.factory.ListableBeanFactory,
        ApplicationContext, ApplicationEventPublisher,
        ConfigurableApplicationContext, Lifecycle, MessageSource,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
<code>AnnotationConfigApplicationContext</code>: 读取注解 Bean 定义的容器
</p>

<div class="org-src-container">
<pre class="src src-text">org.springframework.context.annotation
Class AnnotationConfigApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.GenericApplicationContext
                    org.springframework.context.annotation.AnnotationConfigApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.ListableBeanFactory,
        org.springframework.beans.factory.support.BeanDefinitionRegistry,
        AnnotationConfigRegistry, ApplicationContext,
        ApplicationEventPublisher, ConfigurableApplicationContext,
        Lifecycle, MessageSource, org.springframework.core.AliasRegistry,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
常见的类简单可以分成以下几类
</p>
<ol class="org-ol">
<li>资源处理
<ul class="org-ul">
<li><code>Resource</code> Spring 中关于资源的定义</li>
<li><code>ResourceLoader</code> 提供资源加载方法</li>
<li><code>BeanDefinitionReader</code> 读取接口主要用来读取信息</li>
</ul></li>
<li>注册形式，在 Spring 中关于注册的几个核心
<ul class="org-ul">
<li><code>AliasRegistry</code> 别名注册</li>
<li><code>BeanDefinitionRegistry</code> Bean 定义注册</li>
<li><code>SingletonBeanRegistry</code> 单例 Bean 注册
<ul class="org-ul">
<li><code>DefaultSingletonBeanRegistry</code></li>
</ul></li>
</ul></li>
<li>生命周期，可以分成容器生命周期和 Bean 生命周期两个小类
<ul class="org-ul">
<li><code>Lifecycle</code> 容器生命周期的核心接口</li>
<li><code>InitializingBean</code>, <code>DisposableBean</code> 等 Bean 的生命周期接口</li>
</ul></li>
<li>Bean 拓展
<ul class="org-ul">
<li><code>BeanPostProcessor</code></li>
<li><code>Aware</code> 系列接口</li>
</ul></li>
<li>上下文的接口:
<ul class="org-ul">
<li><code>ApplicationContext</code> 作为主导接口
<ul class="org-ul">
<li><code>AbstractApplicationContext</code></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgfd6c087" class="outline-2">
<h2 id="orgfd6c087"><span class="section-number-2">4</span> ApplicationContext</h2>
</div>

<div id="outline-container-org40d7b12" class="outline-2">
<h2 id="org40d7b12"><span class="section-number-2">5</span> AOP</h2>
<div class="outline-text-2" id="text-5">
<p>
使用动态代理实现
</p>
<ul class="org-ul">
<li>JDK 代理</li>
<li>cglib 代理</li>
</ul>
</div>
</div>

<div id="outline-container-orgfb71311" class="outline-2">
<h2 id="orgfb71311"><span class="section-number-2">6</span> Spring 核心类梳理</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li>ApplicationContext
<ul class="org-ul">
<li>AbstractApplicationContext
<ul class="org-ul">
<li><code>refresh()</code> 实现 Spring Bean 加载的核心逻辑</li>
</ul></li>
</ul></li>
<li>BeanDefinition
<ul class="org-ul">
<li>AbstractBeanDefinition</li>
</ul></li>
<li>BeanDefinitionReader
<ul class="org-ul">
<li>读取 BeanDefinition 对象</li>
</ul></li>
<li>BeanFactory
<ul class="org-ul">
<li>Bean 工厂类</li>
<li>AbstractBeanFactory
<ul class="org-ul">
<li><code>doGetBean(...)</code></li>
</ul></li>
</ul></li>
<li>BeanFactoryPostProcessor
<ul class="org-ul">
<li>函数式接口 <code>@FunctionalInterface</code></li>
</ul></li>
<li>BeanPostProcessor
<ul class="org-ul">
<li>提供自定义 Bean 实例化的处理接口扩展</li>
<li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化前置处理方法</li>
</ul></li>
<li><code>postProcessAfterInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化后置处理方法</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org61c2bcb" class="outline-2">
<h2 id="org61c2bcb"><span class="section-number-2">7</span> SpringBoot 自动装配</h2>
</div>
<div id="outline-container-orgd3a2d38" class="outline-2">
<h2 id="orgd3a2d38"><span class="section-number-2">8</span> 参考链接</h2>
<div class="outline-text-2" id="text-8">
<ol class="org-ol">
<li><a href="https://huifer.github.io/spring-analysis/">Spring Analysis</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-07-18 Sun 01:27. Created by Jinghui Hu at 2021-07-14 Wed 12:16.</p>
</div>
</body>
</html>
