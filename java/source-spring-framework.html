<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-18 Sun 21:59 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spring Framework v5.2.5.RELEASE 源码赏析</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jinghui Hu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../readme.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Spring Framework v5.2.5.RELEASE 源码赏析</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1e7e61e">1. 容器实现原理</a>
<ul>
<li><a href="#orgdfd5de3">1.1. Bean 工厂接口: BeanFactory</a></li>
<li><a href="#org3f7edc4">1.2. Bean 工厂的实现类: DefaultListableBeanFactory</a></li>
<li><a href="#org3e377e5">1.3. Bean 定义的读取器: XmlBeanDefinitionReader</a></li>
<li><a href="#org232ed5a">1.4. BeanDefinition 自动加载流程</a></li>
<li><a href="#org73456a3">1.5. BeanDefinition 注册的实现</a></li>
<li><a href="#orgf976560">1.6. BeanDefinition 移除的实现</a></li>
<li><a href="#org791f308">1.7. BeanDefinition 获取的实现</a></li>
<li><a href="#orga13a8dd">1.8. <code>&lt;bean/&gt;</code> 标签解析</a></li>
</ul>
</li>
<li><a href="#org8002360">2. Bean 实现原理</a>
<ul>
<li><a href="#org669a35d">2.1. Bean 的生命周期</a></li>
<li><a href="#orgb9d2b28">2.2. Bean 的流程分析</a>
<ul>
<li><a href="#orgc015f96">2.2.1. 实例化 Bean: <code>instantiateBean()</code> 方法</a></li>
<li><a href="#org7f88981">2.2.2. 获取 Bean 实例: <code>doGetBean()</code> 方法</a></li>
</ul>
</li>
<li><a href="#org60fd9a6">2.3. 特殊的 Spring Bean: FactoryBean</a></li>
<li><a href="#orgebebbe3">2.4. 单例 Bean 工厂的实现</a>
<ul>
<li><a href="#orgabf6533">2.4.1. 单例 Bean 工厂的三级缓存: <code>DefaultSingletonBeanRegistry</code> 类的缓存</a></li>
<li><a href="#org78e625a">2.4.2. 获取单例 Bean 方法: <code>getSingleton(...)</code> 方法</a></li>
<li><a href="#orgaf41a58">2.4.3. beanInstance 到 beanOject 过程: <code>getObjectForBeanInstance(...)</code> 方法</a></li>
</ul>
</li>
<li><a href="#orgc7f348c">2.5. Bean 生命周期的实现</a>
<ul>
<li><a href="#org5318523">2.5.1. Bean 创建的实现类: <code>AbstractAutowireCapableBeanFactory</code></a></li>
<li><a href="#orgcc685a8">2.5.2. Bean 的实例化: <code>createBean(...)</code> 方法</a></li>
<li><a href="#org75f531e">2.5.3. Bean 的初始化: <code>initializeBean(...)</code> 方法</a></li>
<li><a href="#org8a5cee4">2.5.4. Bean 的销毁</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb8613c5">3. IoC</a>
<ul>
<li><a href="#org0a72d25">3.1. IoC 核心接口和类</a></li>
</ul>
</li>
<li><a href="#orgfe982f2">4. ApplicationContext</a></li>
<li><a href="#org8cdd2e4">5. AOP</a></li>
<li><a href="#org59c8192">6. Spring 核心类梳理</a></li>
<li><a href="#orgacd0711">7. SpringBoot 自动装配</a></li>
<li><a href="#orgf85c95a">8. 参考链接</a></li>
</ul>
</div>
</div>

<div id="outline-container-org1e7e61e" class="outline-2">
<h2 id="org1e7e61e"><span class="section-number-2">1</span> 容器实现原理</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgdfd5de3" class="outline-3">
<h3 id="orgdfd5de3"><span class="section-number-3">1.1</span> Bean 工厂接口: BeanFactory</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<code>BeanFactory</code> 是 Spring 的 Bean 工厂的接口定义，它定义对 Spring Bean 容器访问的
基本操作方法，这里简化如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #268bd2;">BeanFactory</span> <span style="color: #8d5649;">{</span>

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">FactoryBean &#30340; beanName &#21069;&#32512;</span>
  <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">FACTORY_BEAN_PREFIX</span> = <span style="color: #2aa198;">"&amp;"</span>;

  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">&#33719;&#21462; Bean &#30340;&#20027;&#26041;&#27861;</span>
  <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">Object</span>... <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T getBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span>, <span style="color: #268bd2;">Object</span>... <span style="color: #6c71c4;">args</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;

  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #268bd2;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span>;
  <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #268bd2;">ObjectProvider</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> getBeanProvider<span style="color: #d8241f;">(</span><span style="color: #268bd2;">ResolvableType</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span>;

  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">containsBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span>;

  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isSingleton</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;
  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isPrototype</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;

  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">ResolvableType</span> <span style="color: #6c71c4;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;
  <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isTypeMatch</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">typeToMatch</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;

  <span style="color: #268bd2;">@Nullable</span>
  <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">getType</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;
  <span style="color: #268bd2;">@Nullable</span>
  <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">getType</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">allowFactoryBeanInit</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span>;

  <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span> <span style="color: #b58900;">getAliases</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f7edc4" class="outline-3">
<h3 id="org3f7edc4"><span class="section-number-3">1.2</span> Bean 工厂的实现类: DefaultListableBeanFactory</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<code>DefaultListableBeanFactory</code> 是实现 <code>BeanFactory</code> 接口的核心类，熟悉它的类继
承和实现接口是了解 Bean 工厂功能的基本方法， <code>DefaultListableBeanFactory</code> 的
关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultListableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory
                            org.springframework.beans.factory.support.DefaultListableBeanFactory

    All Implemented Interfaces:
        Serializable, BeanFactory, AutowireCapableBeanFactory,
        ConfigurableBeanFactory, ConfigurableListableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory, ListableBeanFactory,
        BeanDefinitionRegistry, org.springframework.core.AliasRegistry

    Direct Known Subclasses:
        XmlBeanFactory
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><code>SimpleAliasRegistry</code> 实现了 <code>AliasRegistry</code> 接口
<ul class="org-ul">
<li><code>AliasRegistry</code> 定义了对别名的增删查改操作</li>
</ul></li>
<li><code>DefaultSingletonBeanRegistry</code> 实现了 <code>SingletonBeanRegistry</code> 接口
<ul class="org-ul">
<li><code>SingletonBeanRegistry</code> 定义了对单例 Bean 的注册及获取方法</li>
<li><code>SingletonBeanRegistry</code> 通过三级缓存来解决循环依赖</li>
</ul></li>
<li><code>FactoryBeanRegistrySupport</code> 实现了对 <code>FactoryBean</code> 的操作支持
<ul class="org-ul">
<li>在 Spring 管理中, <code>FactoryBean</code> 的 beanName 以 <code>&amp;</code> 开头</li>
<li><code>FactoryBean</code> 的创建方式和普通 Spring Bean 是不一样的，它没有
BeanDefinition, 直接通过实现 <code>T getObject()</code> 方法来返回创建的 Bean 对象</li>
<li><code>FactoryBean</code> 还需要实现一些其他的方法，例如： <code>isSingleton()</code>,
<code>getObjectType()</code></li>
</ul></li>
<li><code>AbstractBeanFactory</code> 实现了 <code>BeanFactory</code> 接口
<ul class="org-ul">
<li><code>BeanFactory</code> 接口的直接实现是 <code>AbstractBeanFactory</code> 抽象类</li>
<li><code>AbstractBeanFactory</code> 有很多核心方法
<ul class="org-ul">
<li><code>doGetBean(...)</code> 实现了获取 Bean 的核心逻辑</li>
<li><code>isSingleton(...)</code> 实现了判断 Bean 是否单例的核心逻辑</li>
<li><code>isPrototype(...)</code> 实现了判断 Bean 是否原型的核心逻辑</li>
</ul></li>
</ul></li>
<li><code>HierarchicalBeanFactory</code> 接口继承自 <code>BeanFactory</code>, 它增强了对 parentFactory
的支持</li>
<li><code>ConfigurableBeanFactory</code> 接口提供了配置 Factory 的各种操作
<ul class="org-ul">
<li><code>setBeanClassLoader(...)</code> 设置 Bean 的类加载器</li>
<li><code>registerDependentBean(...)</code> 方法注册依赖 Bean</li>
<li><code>registerScope(...)</code> 注册 Scope</li>
<li><code>isFactoryBean(...)</code> 判断是否为 FactoryBean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
</ul></li>
<li><code>ListableBeanFactory</code> 定义了一些获取 Bean 清单的操作
<ul class="org-ul">
<li><code>getBeanDefinitionCount()</code> 获取工厂中定义 BeanDefinition 的数量</li>
<li><code>getBeanDefinitionNames()</code> 获取工厂定义的 BeanDefinition 名称</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org3e377e5" class="outline-3">
<h3 id="org3e377e5"><span class="section-number-3">1.3</span> Bean 定义的读取器: XmlBeanDefinitionReader</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<code>XmlBeanDefinitionReader</code> 是实现读取 BeanDefinition 的类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.xml
Class XmlBeanDefinitionReader

    java.lang.Object
        org.springframework.beans.factory.support.AbstractBeanDefinitionReader
            org.springframework.beans.factory.xml.XmlBeanDefinitionReader

    All Implemented Interfaces:
        BeanDefinitionReader, org.springframework.core.env.EnvironmentCapable
</pre>
</div>

<p>
这里说明一下重要的类和接口的作用
</p>
<ol class="org-ol">
<li><p>
<code>AbstractBeanDefinitionReader</code> 实现了对 BeanDefinition 的读取操作，它包含
如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">BeanDefinitionRegistry</span> <span style="color: #6c71c4;">registry</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">ResourceLoader</span> <span style="color: #6c71c4;">resourceLoader</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">ClassLoader</span> <span style="color: #6c71c4;">beanClassLoader</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">Environment</span> <span style="color: #6c71c4;">environment</span>;
<span style="color: #859900;">private</span> <span style="color: #268bd2;">BeanNameGenerator</span> <span style="color: #6c71c4;">beanNameGenerator</span> = <span style="color: #268bd2;">DefaultBeanNameGenerator</span>.INSTANCE;
</pre>
</div>
<ul class="org-ul">
<li>registry 表示 BeanDefinition 的注册类</li>
<li>resourceLoader 实现了资源加载</li>
<li>environment 实现了读取系统环境变量和 Java 属性</li>
<li>beanNameGenerator 是 beanName 生成器</li>
</ul></li>
<li><code>XmlBeanDefinitionReader</code> 直接继承自 <code>AbstractBeanDefinitionReader</code>, 增加了
<ul class="org-ul">
<li><code>DocumentLoader</code> 将资源转化成 Document 对象功能</li>
<li>添加了对 XML 的格式验证的方法
<ul class="org-ul">
<li>DTD (Document Type Definition) 验证</li>
<li>XSD (XML Schema Definition) 验证</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org232ed5a" class="outline-3">
<h3 id="org232ed5a"><span class="section-number-3">1.4</span> BeanDefinition 自动加载流程</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<code>DefaultListableBeanFactory</code> 类定义了存储 BeanDefinition 类的哈希表, 具体定义如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Map of bean definition objects, keyed by bean name. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">BeanDefinition</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton and non-singleton bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">allBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map of singleton-only bean names, keyed by dependency type. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span>, <span style="color: #268bd2;">String</span><span style="color: #d8241f;">[]</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonBeanNamesByType</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** List of bean definition names, in registration order. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">volatile</span> <span style="color: #268bd2;">List</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">beanDefinitionNames</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
最终 BeanDefinition 通过调用 <code>registerBeanDefinition(...)</code> 方法注册到
<code>beanDefinitionMap</code> 中，代码的注释也写了是对 <code>BeanDefinitionRegistry</code> 的实现
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2aa198;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #859900;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2aa198;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">existingDefinition</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #859900;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #268bd2;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在 <code>registerBeanDefinition(...)</code> 方法中添加端点可以获得如下的调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">registerBeanDefinition:914, DefaultListableBeanFactory (org.springframework.beans.factory.support)
registerBeanDefinition:164, BeanDefinitionReaderUtils (org.springframework.beans.factory.support)
processBeanDefinition:311, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseDefaultElement:197, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
parseBeanDefinitions:176, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
doRegisterBeanDefinitions:149, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:96, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)
registerBeanDefinitions:509, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
doLoadBeanDefinitions:389, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:336, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:305, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)
loadBeanDefinitions:188, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:224, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:195, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:257, AbstractBeanDefinitionReader (org.springframework.beans.factory.support)
loadBeanDefinitions:128, AbstractXmlApplicationContext (org.springframework.context.support)
loadBeanDefinitions:94, AbstractXmlApplicationContext (org.springframework.context.support)
refreshBeanFactory:133, AbstractRefreshableApplicationContext (org.springframework.context.support)
obtainFreshBeanFactory:637, AbstractApplicationContext (org.springframework.context.support)
refresh:522, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:144, ClassPathXmlApplicationContext (org.springframework.context.support)
&lt;init&gt;:85, ClassPathXmlApplicationContext (org.springframework.context.support)
main:10, MyApp01 (io.github.jeanhwea.app01)
</pre>
</div>

<p>
观察调用栈可以得到 BeanDefinition 的加载步骤如下:
</p>
<ol class="org-ol">
<li>入口方法为 <code>AbstractApplicationContext#refresh(...)</code></li>
<li><code>obtainFreshBeanFactory(...)</code> 方法获取 BeanFactory 的同时需要注册
BeanDefinition</li>
<li><code>XmlBeanDefinitionReader#doLoadBeanDefinitions(...)</code> 方法完成如下操作
<ul class="org-ul">
<li><p>
定义了 documentLoader 成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #268bd2;">DocumentLoader</span> <span style="color: #6c71c4;">documentLoader</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">DefaultDocumentLoader</span><span style="color: #8d5649;">()</span>;
</pre>
</div></li>
<li>首先调用 <code>doLoadDocument(inputSource, resource)</code> 读取到 Document 对象</li>
<li>然后调用 <code>registerBeanDefinitions(doc, resource)</code> 完成 BeanDefinition 的
注册</li>
</ul></li>
<li>调用 <code>parseDefaultElement(...)</code> 方法对默认元素进行解析
<ul class="org-ul">
<li>对 import 类型标签解析</li>
<li>对 alias 类型标签解析</li>
<li>对 bean 类型标签解析</li>
<li>对嵌套 bean 类型标签解析</li>
</ul></li>
<li>接着对标签进行处理，最终交付到
<code>DefaultListableBeanFactory#registerBeanDefinition(...)</code> 方法进行注册</li>
</ol>
</div>
</div>

<div id="outline-container-org73456a3" class="outline-3">
<h3 id="org73456a3"><span class="section-number-3">1.5</span> BeanDefinition 注册的实现</h3>
<div class="outline-text-3" id="text-1-5">
<p>
<code>DefaultListableBeanFactory</code> 的 <code>registerBeanDefinition(...)</code> 才是真正实现注
册 BeanDefinition 逻辑，其代码如下：
</p>
<ol class="org-ol">
<li>对 beanDefinition 进行验证</li>
<li>检查 beanDefinition 是否存在
<ul class="org-ul">
<li>如果存在，判断是否覆盖对应的 BeanDefinition</li>
<li>如果 beanDefinition 不存在，进行创建并注册</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">---------------------------------------------------------------------</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Implementation of BeanDefinitionRegistry interface</span>
<span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">---------------------------------------------------------------------</span>

<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #8d5649;">{</span>

    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"Bean name must not be empty"</span><span style="color: #d8241f;">)</span>;
    Assert.notNull<span style="color: #d8241f;">(</span>beanDefinition, <span style="color: #2aa198;">"BeanDefinition must not be null"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition <span style="color: #859900;">instanceof</span> AbstractBeanDefinition<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">AbstractBeanDefinition</span><span style="color: #ff7f00;">)</span> beanDefinition<span style="color: #24a222;">)</span>.validate<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #24a222;">(</span>beanDefinition.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName,
                    <span style="color: #2aa198;">"Validation of bean definition failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">existingDefinition</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>isAllowBeanDefinitionOverriding<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionOverrideException</span><span style="color: #24a222;">(</span>beanName, beanDefinition, existingDefinition<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>existingDefinition.getRole<span style="color: #24a222;">()</span> &lt; beanDefinition.getRole<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isInfoEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.info<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding user-defined bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a framework-generated bean definition: replacing ["</span> +
                        existingDefinition + <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanDefinition.equals<span style="color: #24a222;">(</span>existingDefinition<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with a different definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Overriding bean definition for bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' with an equivalent definition: replacing ["</span> + existingDefinition +
                        <span style="color: #2aa198;">"] with ["</span> + beanDefinition + <span style="color: #2aa198;">"]"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #9564bf;">(</span>beanName, beanDefinition<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>hasBeanCreationStarted<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
            <span style="color: #859900;">synchronized</span> <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #ff7f00;">(</span>beanName, beanDefinition<span style="color: #ff7f00;">)</span>;
                <span style="color: #268bd2;">List</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #ff7f00;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames.size<span style="color: #1776b6;">()</span> + 1<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.addAll<span style="color: #ff7f00;">(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #ff7f00;">)</span>;
                updatedDefinitions.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
                removeManualSingletonName<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Still in startup registration phase</span>
            <span style="color: #859900;">this</span>.beanDefinitionMap.put<span style="color: #24a222;">(</span>beanName, beanDefinition<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames.add<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            removeManualSingletonName<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>existingDefinition != <span style="color: #268bd2;">null</span> || containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        resetBeanDefinition<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
在上面注册过程中， <code>hasBeanCreationStarted()</code> 方法用于判断 Bean 是否开始创建，
它实现逻辑在父类 <code>AbstractBeanFactory</code> 中
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Check whether this factory's bean creation phase already started,</span>
<span style="color: #d33682;"> * i.e. whether any bean has been marked as created in the meantime.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@since</span><span style="color: #d33682;"> 4.2.2</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #markBeanAsCreated</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">hasBeanCreationStarted</span><span style="color: #8d5649;">()</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">return</span> <span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.isEmpty<span style="color: #d8241f;">()</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
父类 <code>AbstractBeanFactory</code> 中定义了一个集合记录正在创建的 Bean
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Names of beans that have already been created at least once. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">alreadyCreated</span> = Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>256<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;
</pre>
</div>

<p>
创建时通过 <code>markBeanAsCreated(...)</code> 方法标记，注意对 <code>alreadyCreated</code> 的访问
是需要加锁的
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Mark the specified bean as already created (or about to be created).</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">This allows the bean factory to optimize its caching for repeated</span>
<span style="color: #d33682;"> * creation of the specified bean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">markBeanAsCreated</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.contains<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.mergedBeanDefinitions<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.alreadyCreated.contains<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Let the bean definition get re-merged now that we're actually creating</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">the bean... just in case some of its metadata changed in the meantime.</span>
                clearMergedBeanDefinition<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">this</span>.alreadyCreated.add<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf976560" class="outline-3">
<h3 id="orgf976560"><span class="section-number-3">1.6</span> BeanDefinition 移除的实现</h3>
<div class="outline-text-3" id="text-1-6">
<p>
BeanDefinition 的移除方法如下，通过 <code>removeBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">removeBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    Assert.hasText<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"'beanName' must not be empty"</span><span style="color: #d8241f;">)</span>;

    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.remove<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No bean named '"</span> + beanName + <span style="color: #2aa198;">"' found in "</span> + <span style="color: #859900;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>hasBeanCreationStarted<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Cannot modify startup-time collection elements anymore (for stable iteration)</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.beanDefinitionMap<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">List</span><span style="color: #24a222;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #24a222;">&gt;</span> <span style="color: #6c71c4;">updatedDefinitions</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #24a222;">&lt;&gt;(</span><span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #24a222;">)</span>;
            updatedDefinitions.remove<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">this</span>.beanDefinitionNames = updatedDefinitions;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Still in startup registration phase</span>
        <span style="color: #859900;">this</span>.beanDefinitionNames.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">this</span>.frozenBeanDefinitionNames = <span style="color: #268bd2;">null</span>;

    resetBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
移除 BeanDefinition 中调用了刷新 BeanDefinition 的方法
<code>resetBeanDefinition(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Reset all bean definition caches for the given bean,</span>
<span style="color: #d33682;"> * including the caches of beans that are derived from it.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">Called after an existing bean definition has been replaced or removed,</span>
<span style="color: #d33682;"> * triggering </span><span style="color: #268bd2;">{@link #clearMergedBeanDefinition}</span><span style="color: #d33682;">, </span><span style="color: #268bd2;">{@link #destroySingleton}</span>
<span style="color: #d33682;"> * and </span><span style="color: #268bd2;">{@link MergedBeanDefinitionPostProcessor#resetBeanDefinition}</span><span style="color: #d33682;"> on the</span>
<span style="color: #d33682;"> * given bean and on all bean definitions that have the given bean as parent.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean to reset</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerBeanDefinition</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #removeBeanDefinition</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">resetBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Remove the merged bean definition for the given bean, if already created.</span>
    clearMergedBeanDefinition<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Remove corresponding bean from singleton cache, if any. Shouldn't usually</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">be necessary, rather just meant for overriding a context's default beans</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">(e.g. the default StaticMessageSource in a StaticApplicationContext).</span>
    destroySingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Notify all post-processors that the specified bean definition has been reset.</span>
    <span style="color: #859900;">for</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanPostProcessor</span> <span style="color: #6c71c4;">processor</span> : getBeanPostProcessors<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>processor <span style="color: #859900;">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">MergedBeanDefinitionPostProcessor</span><span style="color: #ff7f00;">)</span> processor<span style="color: #24a222;">)</span>.resetBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Reset all bean definitions that have the given bean as parent (recursively).</span>
    <span style="color: #859900;">for</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">bdName</span> : <span style="color: #859900;">this</span>.beanDefinitionNames<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>beanName.equals<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #24a222;">(</span>bdName<span style="color: #24a222;">)</span>;
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Ensure bd is non-null due to potential concurrent modification</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">of the beanDefinitionMap.</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>bd != <span style="color: #268bd2;">null</span> &amp;&amp; beanName.equals<span style="color: #ff7f00;">(</span>bd.getParentName<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                resetBeanDefinition<span style="color: #ff7f00;">(</span>bdName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org791f308" class="outline-3">
<h3 id="org791f308"><span class="section-number-3">1.7</span> BeanDefinition 获取的实现</h3>
<div class="outline-text-3" id="text-1-7">
<p>
<code>DefaultListableBeanFactory</code> 的实现获取 BeanDefinition 的逻辑如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #b58900;">getBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">bd</span> = <span style="color: #859900;">this</span>.beanDefinitionMap.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bd == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No bean named '"</span> + beanName + <span style="color: #2aa198;">"' found in "</span> + <span style="color: #859900;">this</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">NoSuchBeanDefinitionException</span><span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> bd;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga13a8dd" class="outline-3">
<h3 id="orga13a8dd"><span class="section-number-3">1.8</span> <code>&lt;bean/&gt;</code> 标签解析</h3>
<div class="outline-text-3" id="text-1-8">
<p>
之前在 BeanDefinition 自动加载流程中忽略了对 <code>&lt;bean/&gt;</code> 标签的解析，其核心实现
逻辑 <code>BeanDefinitionDocumentReader</code> 类中的 <code>processBeanDefinition(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Process the given bean element, parsing the bean definition</span>
<span style="color: #d33682;"> * and registering it with the registry.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">processBeanDefinition</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Element</span> <span style="color: #6c71c4;">ele</span>, <span style="color: #268bd2;">BeanDefinitionParserDelegate</span> <span style="color: #6c71c4;">delegate</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">BeanDefinitionHolder</span> <span style="color: #6c71c4;">bdHolder</span> = delegate.parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>bdHolder != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        bdHolder = delegate.decorateBeanDefinitionIfRequired<span style="color: #9564bf;">(</span>ele, bdHolder<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register the final decorated instance.</span>
            BeanDefinitionReaderUtils.registerBeanDefinition<span style="color: #24a222;">(</span>bdHolder, getReaderContext<span style="color: #ff7f00;">()</span>.getRegistry<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeanDefinitionStoreException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            getReaderContext<span style="color: #24a222;">()</span>.error<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Failed to register bean definition with name '"</span> +
                    bdHolder.getBeanName<span style="color: #ff7f00;">()</span> + <span style="color: #2aa198;">"'"</span>, ele, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Send registration event.</span>
        getReaderContext<span style="color: #9564bf;">()</span>.fireComponentRegistered<span style="color: #9564bf;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanComponentDefinition</span><span style="color: #24a222;">(</span>bdHolder<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
可以看出对 XML 标签的解析核心逻辑为 <code>parseBeanDefinitionElement(...)</code>
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Parses the supplied </span><span style="color: #268bd2;">{@code </span><span style="color: #268bd2;">&lt;bean&gt;</span><span style="color: #268bd2;">}</span><span style="color: #d33682;"> element. May return </span><span style="color: #268bd2;">{@code null}</span>
<span style="color: #d33682;"> * if there were errors during parse. Errors are reported to the</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">{@link org.springframework.beans.factory.parsing.ProblemReporter}</span><span style="color: #d33682;">.</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@Nullable</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">BeanDefinitionHolder</span> <span style="color: #b58900;">parseBeanDefinitionElement</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">Element</span> <span style="color: #6c71c4;">ele</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">BeanDefinition</span> <span style="color: #6c71c4;">containingBean</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">id</span> = ele.getAttribute<span style="color: #d8241f;">(</span>ID_ATTRIBUTE<span style="color: #d8241f;">)</span>;
    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">nameAttr</span> = ele.getAttribute<span style="color: #d8241f;">(</span>NAME_ATTRIBUTE<span style="color: #d8241f;">)</span>;

    <span style="color: #268bd2;">List</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">aliases</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ArrayList</span><span style="color: #d8241f;">&lt;&gt;()</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>StringUtils.hasLength<span style="color: #9564bf;">(</span>nameAttr<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">nameArr</span> = StringUtils.tokenizeToStringArray<span style="color: #9564bf;">(</span>nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS<span style="color: #9564bf;">)</span>;
        aliases.addAll<span style="color: #9564bf;">(</span>Arrays.asList<span style="color: #24a222;">(</span>nameArr<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span> = id;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span>StringUtils.hasText<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span> &amp;&amp; <span style="color: #268bd2;">!</span>aliases.isEmpty<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        beanName = aliases.remove<span style="color: #9564bf;">(</span>0<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"No XML 'id' specified - using '"</span> + beanName +
                    <span style="color: #2aa198;">"' as bean name and "</span> + aliases + <span style="color: #2aa198;">" as aliases"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>containingBean == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        checkNameUniqueness<span style="color: #9564bf;">(</span>beanName, aliases, ele<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">AbstractBeanDefinition</span> <span style="color: #6c71c4;">beanDefinition</span> = parseBeanDefinitionElement<span style="color: #d8241f;">(</span>ele, beanName, containingBean<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanDefinition != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>StringUtils.hasText<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">try</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>containingBean != <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    beanName = BeanDefinitionReaderUtils.generateBeanName<span style="color: #1776b6;">(</span>
                            beanDefinition, <span style="color: #859900;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>, <span style="color: #268bd2;">true</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">else</span> <span style="color: #ff7f00;">{</span>
                    beanName = <span style="color: #859900;">this</span>.readerContext.generateBeanName<span style="color: #1776b6;">(</span>beanDefinition<span style="color: #1776b6;">)</span>;
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register an alias for the plain bean class name, if still possible,</span>
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">if the generator returned the class name plus a suffix.</span>
                    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">This is expected for Spring 1.2/2.0 backwards compatibility.</span>
                    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanClassName</span> = beanDefinition.getBeanClassName<span style="color: #1776b6;">()</span>;
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span>beanClassName != <span style="color: #268bd2;">null</span> &amp;&amp;
                            beanName.startsWith<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span> &amp;&amp; beanName.length<span style="color: #00bed1;">()</span> &gt; beanClassName.length<span style="color: #00bed1;">()</span> &amp;&amp;
                            <span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.readerContext.getRegistry<span style="color: #00bed1;">()</span>.isBeanNameInUse<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        aliases.add<span style="color: #00bed1;">(</span>beanClassName<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>logger.isTraceEnabled<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    logger.trace<span style="color: #1776b6;">(</span><span style="color: #2aa198;">"Neither XML 'id' nor 'name' specified - "</span> +
                            <span style="color: #2aa198;">"using generated bean name ["</span> + beanName + <span style="color: #2aa198;">"]"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">Exception</span> <span style="color: #6c71c4;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                error<span style="color: #ff7f00;">(</span>ex.getMessage<span style="color: #1776b6;">()</span>, ele<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #268bd2;">String</span><span style="color: #9564bf;">[]</span> <span style="color: #6c71c4;">aliasesArray</span> = StringUtils.toStringArray<span style="color: #9564bf;">(</span>aliases<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">return</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionHolder</span><span style="color: #9564bf;">(</span>beanDefinition, beanName, aliasesArray<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8002360" class="outline-2">
<h2 id="org8002360"><span class="section-number-2">2</span> Bean 实现原理</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org669a35d" class="outline-3">
<h3 id="org669a35d"><span class="section-number-3">2.1</span> Bean 的生命周期</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<code>BeanFactory</code> 的注释中完整地说明的实现标准 BeanFactory 的代码
</p>
<ol class="org-ol">
<li>BeanFactory 初始化过程，支持的标准 Bean 的生命周期
<ul class="org-ul">
<li><code>BeanNameAware#setBeanName(...)</code></li>
<li><code>BeanClassLoaderAware#setBeanClassLoader(...)</code></li>
<li><code>BeanFactoryAware#setBeanFactory(...)</code></li>
<li><code>EnvironmentAware#setEnvironment(...)</code></li>
<li><code>EmbeddedValueResolverAware#setEmbeddedValueResolver(...)</code></li>
<li><code>ResourceLoaderAware#setResourceLoader(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationEventPublisherAware#setApplicationEventPublisher(...)</code> 在
ApplicationContext 中</li>
<li><code>MessageSourceAware#setMessageSource(...)</code> 在 ApplicationContext 中</li>
<li><code>ApplicationContextAware#setApplicationContext(...)</code> 在
ApplicationContext 中</li>
<li><code>ServletContextAware#setServletContext(...)</code> 在 ApplicationContext 中</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessBeforeInitialization(...)</code> 方法</li>
<li><code>InitializingBean#afterPropertiesSet(...)</code></li>
<li>a custom init-method definition</li>
<li><code>BeanPostProcessors</code> 的一系列 <code>postProcessAfterInitialization(...)</code> 方法</li>
</ul></li>
<li>关闭 BeanFactory 时，执行的 Bean 销毁方法
<ul class="org-ul">
<li><code>DestructionAwareBeanPostProcessors</code> 的一系列
<code>postProcessBeforeDestruction(...)</code> 方法</li>
<li><code>DisposableBean#destroy(...)</code></li>
<li>a custom destroy-method definition</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgb9d2b28" class="outline-3">
<h3 id="orgb9d2b28"><span class="section-number-3">2.2</span> Bean 的流程分析</h3>
<div class="outline-text-3" id="text-2-2">
<p>
实例化 Bean 的方法为 <code>BeanUtils#instantiateClass(...)</code>, 先添加断点获取调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">instantiateClass:185, BeanUtils (org.springframework.beans)
instantiate:87, SimpleInstantiationStrategy (org.springframework.beans.factory.support)
instantiateBean:1312, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBeanInstance:1214, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doCreateBean:557, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1027007693 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$29)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
main:18, MyApp02 (io.github.jeanhwea.app02)
</pre>
</div>

<p>
先分析调用栈，可以知道创建 Bean 的入口是 <code>refresh()</code> 方法的
<code>invokeBeanFactoryPostProcessors()</code> 方法，这里牵扯到几个核心的方法
</p>
<ol class="org-ol">
<li><code>AbstractApplicationContext#refresh()</code></li>
<li><code>AbstractBeanFactory#doGetBean(...)</code></li>
<li><code>AbstractAutowireCapableBeanFactory#instantiateBean(...)</code></li>
</ol>
</div>

<div id="outline-container-orgc015f96" class="outline-4">
<h4 id="orgc015f96"><span class="section-number-4">2.2.1</span> 实例化 Bean: <code>instantiateBean()</code> 方法</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
<code>instantiateBean(...)</code> 实例化 Bean 主要完成如下工作
</p>
<ol class="org-ol">
<li>使用 InstantiationStrategy 实例化策略来实例化 Bean, Spring 中创建 Bean 有如
下两种方式
<ul class="org-ul">
<li>通过 <code>BeanUtils.instantiateClass()</code> 方法创建实例</li>
<li>通过 <code>new CglibSubclassCreator(bd, owner).instantiate(ctor, args)</code> 方式
进行创建</li>
</ul></li>
<li>添加 BeanWrapper 封装 Bean 对象
<ul class="org-ul">
<li>实现类为 <code>BeanWrapperImpl</code></li>
<li><code>BeanWrapperImpl</code> 继承自 <code>AbstractNestablePropertyAccessor</code></li>
<li><code>AbstractNestablePropertyAccessor#setPropertyValue(...)</code> 方法设置属性值</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Instantiate the given bean using its default constructor.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> mbd the bean definition for the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> a BeanWrapper for the new instance</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">BeanWrapper</span> <span style="color: #b58900;">instantiateBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #859900;">final</span> <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">beanInstance</span>;
        <span style="color: #859900;">final</span> <span style="color: #268bd2;">BeanFactory</span> <span style="color: #6c71c4;">parent</span> = <span style="color: #859900;">this</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            beanInstance = AccessController.doPrivileged<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #268bd2;">PrivilegedAction</span><span style="color: #1776b6;">&lt;</span><span style="color: #268bd2;">Object</span><span style="color: #1776b6;">&gt;</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">()</span> -&gt;
                    getInstantiationStrategy<span style="color: #ff7f00;">()</span>.instantiate<span style="color: #ff7f00;">(</span>mbd, beanName, parent<span style="color: #ff7f00;">)</span>,
                    getAccessControlContext<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            beanInstance = getInstantiationStrategy<span style="color: #24a222;">()</span>.instantiate<span style="color: #24a222;">(</span>mbd, beanName, parent<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #268bd2;">BeanWrapper</span> <span style="color: #6c71c4;">bw</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanWrapperImpl</span><span style="color: #9564bf;">(</span>beanInstance<span style="color: #9564bf;">)</span>;
        initBeanWrapper<span style="color: #9564bf;">(</span>bw<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">return</span> bw;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2aa198;">"Instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f88981" class="outline-4">
<h4 id="org7f88981"><span class="section-number-4">2.2.2</span> 获取 Bean 实例: <code>doGetBean()</code> 方法</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
<code>doGetBean(...)</code> 方法是获取 Bean 的最终处理函数，它的逻辑比较复杂，可以分成
以下流程
</p>
<ol class="org-ol">
<li>获取 beanName
<ul class="org-ul">
<li>解析带有别名的 Bean 到最终的名称</li>
<li>去除 FactoryBean 的修饰符，即 <code>&amp;</code> 前缀</li>
</ul></li>
<li>缓存获取
<ul class="org-ul">
<li>调用 <code>DefaultSingletonBeanRegistry#getSingleton()</code> 尝试从单例容器缓存中
获取</li>
<li>单例 Bean 只创建一次，创建完成直接放入缓存，参考
<code>DefaultSingletonBeanRegistry</code> 的实现</li>
<li>依赖的 Bean 避免循环依赖，只记录 <code>ObjectFactory</code> 对象, 参考
<code>singletonFactories</code> 变量的定义及循环依赖的解决方法</li>
</ul></li>
<li>创建 Bean 实例
<ul class="org-ul">
<li>获取 FactoryBean 生成的 Bean 实例
<ul class="org-ul">
<li>FactoryBean 实例需要获取到的对象是 <code>factory-method</code> 返回的 Bean 对象</li>
<li><code>getObjectForBeanInstance()</code> 方法实现了从 Bean 实例中获取 Bean 对象的
逻辑，后续再说明该方法的逻辑</li>
</ul></li>
<li>如果不是 FactoryBean
<ul class="org-ul">
<li>调用 <code>isPrototypeCurrentlyInCreation(...)</code> 判断创建原型 Bean 是否出现
循环依赖</li>
<li>尝试从 parentBeanFactory 中获取 Bean</li>
<li>将 BeanDefinition 进行合并，得到 <code>RootBeanDefinition</code>, 并检验</li>
<li>调用 <code>markBeanAsCreated()</code> 方法标记创建 Bean</li>
<li>解决 Bean 依赖
<ul class="org-ul">
<li>Bean 是动态加载的，当前待创建 Bean 的可能存在依赖项</li>
<li>解决依赖的策略是顺序寻找出所有依赖，并完成创建</li>
</ul></li>
<li>通过不同的 scope 完成对应 Bean 的创建
<ul class="org-ul">
<li>单例 Bean 创建: <code>getSingleton(...)</code></li>
<li>原型 Bean 创建: <code>getSingleton(...)</code></li>
<li>其它情况 Bean 创建，例如： <code>@RequestScope</code> <code>@SessionScope</code> 等</li>
</ul></li>
</ul></li>
</ul></li>
<li>检查 Bean 实例，完成类型转换</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Return an instance, which may be shared or independent, of the specified bean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> name the name of the bean to retrieve</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> requiredType the required type of the bean to retrieve</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> args arguments to use when creating a bean instance using explicit arguments</span>
<span style="color: #d33682;"> * (only applied when creating a new instance as opposed to retrieving an existing one)</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> typeCheckOnly whether the instance is obtained for a type check,</span>
<span style="color: #d33682;"> * not for actual use</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> an instance of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeansException if the bean could not be created</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@SuppressWarnings</span><span style="color: #8d5649;">(</span><span style="color: #2aa198;">"unchecked"</span><span style="color: #8d5649;">)</span>
<span style="color: #859900;">protected</span> <span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #268bd2;">T</span> <span style="color: #b58900;">doGetBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">requiredType</span>,
        <span style="color: #268bd2;">@Nullable</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #6c71c4;">args</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">typeCheckOnly</span><span style="color: #8d5649;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span> = transformedBeanName<span style="color: #d8241f;">(</span>name<span style="color: #d8241f;">)</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span>;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Eagerly check singleton cache for manually registered singletons.</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">sharedInstance</span> = getSingleton<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>sharedInstance != <span style="color: #268bd2;">null</span> &amp;&amp; args == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>isSingletonCurrentlyInCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Returning eagerly cached instance of singleton bean '"</span> + beanName +
                        <span style="color: #2aa198;">"' that is not fully initialized yet - a consequence of a circular reference"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Returning cached instance of singleton bean '"</span> + beanName + <span style="color: #2aa198;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        bean = getObjectForBeanInstance<span style="color: #9564bf;">(</span>sharedInstance, name, beanName, <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Fail if we're already creating this bean instance:</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">We're assumably within a circular reference.</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>isPrototypeCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Check if bean definition exists in this factory.</span>
        <span style="color: #268bd2;">BeanFactory</span> <span style="color: #6c71c4;">parentBeanFactory</span> = getParentBeanFactory<span style="color: #9564bf;">()</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>parentBeanFactory != <span style="color: #268bd2;">null</span> &amp;&amp; <span style="color: #268bd2;">!</span>containsBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Not found -&gt; check parent.</span>
            <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">nameToLookup</span> = originalBeanName<span style="color: #24a222;">(</span>name<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>parentBeanFactory <span style="color: #859900;">instanceof</span> AbstractBeanFactory<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #268bd2;">AbstractBeanFactory</span><span style="color: #1776b6;">)</span> parentBeanFactory<span style="color: #ff7f00;">)</span>.doGetBean<span style="color: #ff7f00;">(</span>
                        nameToLookup, requiredType, args, typeCheckOnly<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>args != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Delegation to parent with explicit args.</span>
                <span style="color: #859900;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, args<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>requiredType != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">No args -&gt; delegate to standard getBean method.</span>
                <span style="color: #859900;">return</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup, requiredType<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">return</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">T</span><span style="color: #ff7f00;">)</span> parentBeanFactory.getBean<span style="color: #ff7f00;">(</span>nameToLookup<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>

        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>typeCheckOnly<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            markBeanAsCreated<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>

        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">final</span> <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span> = getMergedLocalBeanDefinition<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            checkMergedBeanDefinition<span style="color: #24a222;">(</span>mbd, beanName, args<span style="color: #24a222;">)</span>;

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Guarantee initialization of beans that the current bean depends on.</span>
            <span style="color: #268bd2;">String</span><span style="color: #24a222;">[]</span> <span style="color: #6c71c4;">dependsOn</span> = mbd.getDependsOn<span style="color: #24a222;">()</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>dependsOn != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">dep</span> : dependsOn<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span>isDependent<span style="color: #00bed1;">(</span>beanName, dep<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #2aa198;">"Circular depends-on relationship between '"</span> + beanName + <span style="color: #2aa198;">"' and '"</span> + dep + <span style="color: #2aa198;">"'"</span><span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    registerDependentBean<span style="color: #1776b6;">(</span>dep, beanName<span style="color: #1776b6;">)</span>;
                    <span style="color: #859900;">try</span> <span style="color: #1776b6;">{</span>
                        getBean<span style="color: #00bed1;">(</span>dep<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #859900;">catch</span> <span style="color: #1776b6;">(</span><span style="color: #268bd2;">NoSuchBeanDefinitionException</span> <span style="color: #6c71c4;">ex</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #00bed1;">(</span>mbd.getResourceDescription<span style="color: #bcbf00;">()</span>, beanName,
                                <span style="color: #2aa198;">"'"</span> + beanName + <span style="color: #2aa198;">"' depends on missing bean '"</span> + dep + <span style="color: #2aa198;">"'"</span>, ex<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>

            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create bean instance.</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>mbd.isSingleton<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                sharedInstance = getSingleton<span style="color: #ff7f00;">(</span>beanName, <span style="color: #1776b6;">()</span> -&gt; <span style="color: #1776b6;">{</span>
                    <span style="color: #859900;">try</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #859900;">return</span> createBean<span style="color: #bcbf00;">(</span>beanName, mbd, args<span style="color: #bcbf00;">)</span>;
                    <span style="color: #00bed1;">}</span>
                    <span style="color: #859900;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #268bd2;">BeansException</span> <span style="color: #6c71c4;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Explicitly remove instance from singleton cache: It might have been put there</span>
                        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">eagerly by the creation process, to allow for circular reference resolution.</span>
                        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Also remove any beans that received a temporary reference to the bean.</span>
                        destroySingleton<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #859900;">throw</span> ex;
                    <span style="color: #00bed1;">}</span>
                <span style="color: #1776b6;">}</span><span style="color: #ff7f00;">)</span>;
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>sharedInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>mbd.isPrototype<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">It's a prototype -&gt; create a new instance.</span>
                <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">prototypeInstance</span> = <span style="color: #268bd2;">null</span>;
                <span style="color: #859900;">try</span> <span style="color: #ff7f00;">{</span>
                    beforePrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                    prototypeInstance = createBean<span style="color: #1776b6;">(</span>beanName, mbd, args<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">finally</span> <span style="color: #ff7f00;">{</span>
                    afterPrototypeCreation<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                bean = getObjectForBeanInstance<span style="color: #ff7f00;">(</span>prototypeInstance, name, beanName, mbd<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>

            <span style="color: #859900;">else</span> <span style="color: #24a222;">{</span>
                <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">scopeName</span> = mbd.getScope<span style="color: #ff7f00;">()</span>;
                <span style="color: #859900;">final</span> <span style="color: #268bd2;">Scope</span> <span style="color: #6c71c4;">scope</span> = <span style="color: #859900;">this</span>.scopes.get<span style="color: #ff7f00;">(</span>scopeName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>scope == <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">IllegalStateException</span><span style="color: #1776b6;">(</span><span style="color: #2aa198;">"No Scope registered for scope name '"</span> + scopeName + <span style="color: #2aa198;">"'"</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">try</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">scopedInstance</span> = scope.get<span style="color: #1776b6;">(</span>beanName, <span style="color: #00bed1;">()</span> -&gt; <span style="color: #00bed1;">{</span>
                        beforePrototypeCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #859900;">try</span> <span style="color: #bcbf00;">{</span>
                            <span style="color: #859900;">return</span> createBean<span style="color: #e574c3;">(</span>beanName, mbd, args<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                        <span style="color: #859900;">finally</span> <span style="color: #bcbf00;">{</span>
                            afterPrototypeCreation<span style="color: #e574c3;">(</span>beanName<span style="color: #e574c3;">)</span>;
                        <span style="color: #bcbf00;">}</span>
                    <span style="color: #00bed1;">}</span><span style="color: #1776b6;">)</span>;
                    bean = getObjectForBeanInstance<span style="color: #1776b6;">(</span>scopedInstance, name, beanName, mbd<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">catch</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">IllegalStateException</span> <span style="color: #6c71c4;">ex</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #2aa198;">"Scope '"</span> + scopeName + <span style="color: #2aa198;">"' is not active for the current thread; consider "</span> +
                            <span style="color: #2aa198;">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,
                            ex<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">BeansException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            cleanupAfterBeanCreationFailure<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">throw</span> ex;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Check if required type matches the type of the actual bean instance.</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>requiredType != <span style="color: #268bd2;">null</span> &amp;&amp; <span style="color: #268bd2;">!</span>requiredType.isInstance<span style="color: #9564bf;">(</span>bean<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">try</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">T</span> <span style="color: #6c71c4;">convertedBean</span> = getTypeConverter<span style="color: #24a222;">()</span>.convertIfNecessary<span style="color: #24a222;">(</span>bean, requiredType<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>convertedBean == <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanNotOfRequiredTypeException</span><span style="color: #ff7f00;">(</span>name, requiredType, bean.getClass<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">return</span> convertedBean;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">catch</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">TypeMismatchException</span> <span style="color: #6c71c4;">ex</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isTraceEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.trace<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Failed to convert bean '"</span> + name + <span style="color: #2aa198;">"' to required type '"</span> +
                        ClassUtils.getQualifiedName<span style="color: #1776b6;">(</span>requiredType<span style="color: #1776b6;">)</span> + <span style="color: #2aa198;">"'"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanNotOfRequiredTypeException</span><span style="color: #24a222;">(</span>name, requiredType, bean.getClass<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">)</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org60fd9a6" class="outline-3">
<h3 id="org60fd9a6"><span class="section-number-3">2.3</span> 特殊的 Spring Bean: FactoryBean</h3>
<div class="outline-text-3" id="text-2-3">
<p>
FactoryBean 不同于普通的 Bean， FactoryBean 自身就是一个组装 Bean 的微型工厂，
即在调用 <code>BeanFactory#getBean(...)</code> 方法时不返回 FactoryBean，而是返回工厂方
法返回的 Bean，定义 FactoryBean 只需要实现 <code>FactoryBean</code> 接口即可
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #268bd2;">FactoryBean</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">@Nullable</span>
    <span style="color: #268bd2;">T</span> <span style="color: #b58900;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span>;

    <span style="color: #268bd2;">@Nullable</span>
    <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #b58900;">getObjectType</span><span style="color: #d8241f;">()</span>;

    <span style="color: #859900;">default</span> <span style="color: #268bd2;">boolean</span> <span style="color: #b58900;">isSingleton</span><span style="color: #d8241f;">()</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">true</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ol class="org-ol">
<li><code>getObject(...)</code> 方法返回 FactoryBean 创建的实例，也称工厂方法</li>
<li><code>getObjectType(...)</code> 方法返回 FactoryBean 创建的实例的类型</li>
<li><code>isSingleton(...)</code> 方法返回 FactoryBean 创建的实例的 Scope</li>
</ol>
</div>
</div>

<div id="outline-container-orgebebbe3" class="outline-3">
<h3 id="orgebebbe3"><span class="section-number-3">2.4</span> 单例 Bean 工厂的实现</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-orgabf6533" class="outline-4">
<h4 id="orgabf6533"><span class="section-number-4">2.4.1</span> 单例 Bean 工厂的三级缓存: <code>DefaultSingletonBeanRegistry</code> 类的缓存</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
<code>DefaultSingletonBeanRegistry</code> 是对单例 Bean 注册的实现类，它的继承关系如下
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class DefaultSingletonBeanRegistry

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry

    All Implemented Interfaces:
        SingletonBeanRegistry, org.springframework.core.AliasRegistry
</pre>
</div>

<p>
<code>DefaultSingletonBeanRegistry</code> 定义了如下成员变量
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/** Cache of singleton objects: bean name to bean instance. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonObjects</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Cache of singleton factories: bean name to ObjectFactory. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">ObjectFactory</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonFactories</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">HashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Cache of early singleton objects: bean name to bean instance. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">earlySingletonObjects</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">HashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Set of registered singletons, containing the bean names in registration order. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">registeredSingletons</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">LinkedHashSet</span><span style="color: #8d5649;">&lt;&gt;(</span>256<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Names of beans that are currently in creation. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">singletonsCurrentlyInCreation</span> =
        Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>16<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Names of beans currently excluded from in creation checks. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">inCreationCheckExclusions</span> =
        Collections.newSetFromMap<span style="color: #8d5649;">(</span><span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #d8241f;">&lt;&gt;(</span>16<span style="color: #d8241f;">)</span><span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** List of suppressed Exceptions, available for associating related causes. */</span>
<span style="color: #268bd2;">@Nullable</span>
<span style="color: #859900;">private</span> <span style="color: #268bd2;">Set</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">Exception</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">suppressedExceptions</span>;

<span style="color: #d33682;">/** Flag that indicates whether we're currently within destroySingletons. */</span>
<span style="color: #859900;">private</span> <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">singletonsCurrentlyInDestruction</span> = <span style="color: #268bd2;">false</span>;

<span style="color: #d33682;">/** Disposable bean instances: bean name to disposable instance. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Object</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">disposableBeans</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">LinkedHashMap</span><span style="color: #8d5649;">&lt;&gt;()</span>;

<span style="color: #d33682;">/** Map between containing bean names: bean name to Set of bean names that the bean contains. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">containedBeanMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>16<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map between dependent bean names: bean name to Set of dependent bean names. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">dependentBeanMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;

<span style="color: #d33682;">/** Map between depending bean names: bean name to Set of bean names for the bean's dependencies. */</span>
<span style="color: #859900;">private</span> <span style="color: #859900;">final</span> <span style="color: #268bd2;">Map</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">String</span>, <span style="color: #268bd2;">Set</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #d8241f;">&gt;</span><span style="color: #8d5649;">&gt;</span> <span style="color: #6c71c4;">dependenciesForBeanMap</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">ConcurrentHashMap</span><span style="color: #8d5649;">&lt;&gt;(</span>64<span style="color: #8d5649;">)</span>;
</pre>
</div>
<p>
这里需要注意的是其定义的三级缓存结构
</p>
<ol class="org-ol">
<li>singletonObjects: 一级缓存单例 Bean 对象</li>
<li>earlySingletonObjects: 二级缓存早期创建的单例 Bean 对象
<ul class="org-ul">
<li>earlySingletonObjects 于 singletonObjects 不同之处是，当一个单例 Bean
还在创建过程中可以将其依赖的单例 Bean 放入 earlySingletonObjects 哈希表
内</li>
<li>这样做，即使单例 Bean 在创建过程中，调用 <code>getBean(...)</code> 方法依然可以获
取到所依赖的 Bean 对象</li>
<li>另外该方案用来循环检测，避免循环依赖</li>
</ul></li>
<li><p>
singletonFactories: 三级缓存单例对象工厂 ObjectFactory
</p>
<ul class="org-ul">
<li>singletonFactories 哈希表的值是 <code>ObjectFactory</code> 接口类型</li>
<li><code>ObjectFactory</code> 是个函数式接口，用于延迟创建 Bean</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #268bd2;">@FunctionalInterface</span>
<span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #268bd2;">ObjectFactory</span><span style="color: #8d5649;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #8d5649;">&gt;</span> <span style="color: #8d5649;">{</span>

    <span style="color: #d33682;">/**</span>
<span style="color: #d33682;">     * Return an instance (possibly shared or independent)</span>
<span style="color: #d33682;">     * of the object managed by this factory.</span>
<span style="color: #d33682;">     * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the resulting instance</span>
<span style="color: #d33682;">     * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeansException in case of creation errors</span>
<span style="color: #d33682;">     */</span>
    <span style="color: #268bd2;">T</span> <span style="color: #b58900;">getObject</span><span style="color: #d8241f;">()</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;

<span style="color: #8d5649;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-org78e625a" class="outline-4">
<h4 id="org78e625a"><span class="section-number-4">2.4.2</span> 获取单例 Bean 方法: <code>getSingleton(...)</code> 方法</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
<code>getSingleton()</code> 方法是获取 Bean 的核心方法, 它的实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">&#33719;&#21462;&#21333;&#20363;&#65292;&#21487;&#20197;&#20174; earlySingletonObjects &#20013;&#33719;&#21462;</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">return</span> getSingleton<span style="color: #d8241f;">(</span>beanName, <span style="color: #268bd2;">true</span><span style="color: #d8241f;">)</span>;
<span style="color: #8d5649;">}</span>

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">&#33719;&#21462;&#21333;&#20363;&#65292;&#28155;&#21152;&#26159;&#21542;&#21487;&#20197;&#20174; earlySingletonObjects &#20013;&#33719;&#21462;&#21442;&#25968;</span>
<span style="color: #268bd2;">@Nullable</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">allowEarlyReference</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">singletonObject</span> = <span style="color: #859900;">this</span>.singletonObjects.get<span style="color: #d8241f;">(</span>beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>singletonObject == <span style="color: #268bd2;">null</span> &amp;&amp; isSingletonCurrentlyInCreation<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span><span style="color: #859900;">this</span>.singletonObjects<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            singletonObject = <span style="color: #859900;">this</span>.earlySingletonObjects.get<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>singletonObject == <span style="color: #268bd2;">null</span> &amp;&amp; allowEarlyReference<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #268bd2;">ObjectFactory</span><span style="color: #ff7f00;">&lt;</span>?<span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">singletonFactory</span> = <span style="color: #859900;">this</span>.singletonFactories.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>singletonFactory != <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    singletonObject = singletonFactory.getObject<span style="color: #1776b6;">()</span>;
                    <span style="color: #859900;">this</span>.earlySingletonObjects.put<span style="color: #1776b6;">(</span>beanName, singletonObject<span style="color: #1776b6;">)</span>;
                    <span style="color: #859900;">this</span>.singletonFactories.remove<span style="color: #1776b6;">(</span>beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> singletonObject;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
允许从 earlySingletonObjects 获取单例的 <code>getSingleton(...)</code> 方法逻辑比较清晰
</p>
<ol class="org-ol">
<li>先尝试从 singletonObjects 中获取 singletonObject, 如果成功直接返回
singletonObject</li>
<li>如果获取失败，则尝试从 earlySingletonObjects 中获取 singletonObject, 如果
成功直接返回 singletonObject</li>
<li>如果再次失败，尝试从 singletonFactories 中创建 singletonObject，并返回创
建结果
<ul class="org-ul">
<li>首先通过 beanName, 查找到 <code>ObjectFactory</code> 的值, 即 singletonFactory</li>
<li>若 singletonFactory 存在，调用 <code>singletonFactory.getObject(...)</code> 方法创
建 singletonObject</li>
<li>创建成功将 singletonObject, 将 singletonObject 添加到
earlySingletonObjects, 并从 singletonFactories 移除 beanName 对应的值</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">&#33719;&#21462;&#21333;&#20363;&#65292;&#20027;&#35201;&#38024;&#23545;&#26410;&#21019;&#24314;&#30340; Bean &#23545;&#35937;&#65292;&#36890;&#36807; ObjectFactory &#21019;&#24314;&#23545;&#35937;&#24182;&#36820;&#22238;</span>
<span style="color: #859900;">public</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getSingleton</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">ObjectFactory</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">singletonFactory</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    Assert.notNull<span style="color: #d8241f;">(</span>beanName, <span style="color: #2aa198;">"Bean name must not be null"</span><span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #859900;">this</span>.singletonObjects<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">singletonObject</span> = <span style="color: #859900;">this</span>.singletonObjects.get<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>singletonObject == <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.singletonsCurrentlyInDestruction<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationNotAllowedException</span><span style="color: #ff7f00;">(</span>beanName,
                        <span style="color: #2aa198;">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +
                        <span style="color: #2aa198;">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>logger.isDebugEnabled<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                logger.debug<span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"Creating shared instance of singleton bean '"</span> + beanName + <span style="color: #2aa198;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            beforeSingletonCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">newSingleton</span> = <span style="color: #268bd2;">false</span>;
            <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">recordSuppressedExceptions</span> = <span style="color: #24a222;">(</span><span style="color: #859900;">this</span>.suppressedExceptions == <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>recordSuppressedExceptions<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">this</span>.suppressedExceptions = <span style="color: #859900;">new</span> <span style="color: #268bd2;">LinkedHashSet</span><span style="color: #ff7f00;">&lt;&gt;()</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">try</span> <span style="color: #24a222;">{</span>
                singletonObject = singletonFactory.getObject<span style="color: #ff7f00;">()</span>;
                newSingleton = <span style="color: #268bd2;">true</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">IllegalStateException</span> <span style="color: #6c71c4;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Has the singleton object implicitly appeared in the meantime -&gt;</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">if yes, proceed with it since the exception indicates that state.</span>
                singletonObject = <span style="color: #859900;">this</span>.singletonObjects.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>singletonObject == <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">throw</span> ex;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">BeanCreationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>recordSuppressedExceptions<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">for</span> <span style="color: #1776b6;">(</span><span style="color: #268bd2;">Exception</span> <span style="color: #6c71c4;">suppressedException</span> : <span style="color: #859900;">this</span>.suppressedExceptions<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        ex.addRelatedCause<span style="color: #00bed1;">(</span>suppressedException<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">throw</span> ex;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">finally</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>recordSuppressedExceptions<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">this</span>.suppressedExceptions = <span style="color: #268bd2;">null</span>;
                <span style="color: #ff7f00;">}</span>
                afterSingletonCreation<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>newSingleton<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                addSingleton<span style="color: #ff7f00;">(</span>beanName, singletonObject<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> singletonObject;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
获取单例 Bean 的总逻辑逻辑如下
</p>
<ol class="org-ol">
<li>首先尝试从 singletonObjects 获取 singletonObject, 获取成功直接返回
singletonObject</li>
<li>如果 singletonObjects 获取失败，则需要创建 singletonObject
<ul class="org-ul">
<li>先调用 <code>beforeSingletonCreation(...)</code> 前置钩子函数</li>
<li>调用 <code>ObjectFactory</code> 的 <code>getObject(...)</code> 方法来创建 singletonObject</li>
<li>然后调用 <code>afterSingletonCreation(...)</code> 后置钩子函数</li>
<li><p>
如果有信创建的 singletonObject, 调用 <code>addSingleton(...)</code> 来处理添加新创
建 singletonObject
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">addSingleton</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">singletonObject</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">synchronized</span> <span style="color: #d8241f;">(</span><span style="color: #859900;">this</span>.singletonObjects<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">this</span>.singletonObjects.put<span style="color: #9564bf;">(</span>beanName, singletonObject<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">this</span>.singletonFactories.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">this</span>.earlySingletonObjects.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">this</span>.registeredSingletons.add<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<ul class="org-ul">
<li><code>addSingleton(...)</code> 将新创建的 singletonObject 放入 singletonObjects,
并从 singletonFactories 和 earlySingletonObjects 中移除
singletonObject 对象</li>
<li>将 singletonObject 添加到 registeredSingletons 中，完成 Bean 的注册</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgaf41a58" class="outline-4">
<h4 id="orgaf41a58"><span class="section-number-4">2.4.3</span> beanInstance 到 beanOject 过程: <code>getObjectForBeanInstance(...)</code> 方法</h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
beanInstance -&gt; beanOject 是将缓存中的 Bean 实例转化成最终用户所需对象的过程，
</p>
<ol class="org-ol">
<li>在 <code>doGetBean(...)</code> 方法中的 <code>getObjectForBeanInstance(...)</code> 方法实现</li>
<li>beanInstance 如果是非 FactoryBean, beanInstance 即为 beanOject, 直接返回
创建好的 Bean 对象</li>
<li>beanInstance 如果是 FactoryBean, 需要调用工厂方法进行处理，创建 beanOject
<ul class="org-ul">
<li>先调用 <code>getCachedObjectForFactoryBean(...)</code> 从缓存中获取，获取成功直接
返回结果</li>
<li>如果未获取成功，调用 <code>getObjectFromFactoryBean(...)</code> 创建 beanOject</li>
<li>最终通过 <code>doGetObjectFromFactoryBean(...)</code> 完成调用工厂方法并获取
beanObject 逻辑</li>
</ul></li>
</ol>

<p>
这里分析一下 <code>doGetObjectFromFactoryBean(...)</code> 的逻辑，先查看一下调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">doGetObjectFromFactoryBean:161, FactoryBeanRegistrySupport (org.springframework.beans.factory.support)
getObjectFromFactoryBean:101, FactoryBeanRegistrySupport (org.springframework.beans.factory.support)
getObjectForBeanInstance:1818, AbstractBeanFactory (org.springframework.beans.factory.support)
getObjectForBeanInstance:1266, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
doGetBean:260, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:1108, AbstractApplicationContext (org.springframework.context.support)
main:25, MyApp04 (io.github.jeanhwea.app04_factory_bean)
</pre>
</div>

<p>
<code>doGetObjectFromFactoryBean(...)</code> 方法逻辑如下，可以看出在进行了一些校验工作，
最终调用 <code>factory.getObject()</code> 方法获取 beanObject
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Obtain an object to expose from the given FactoryBean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> factory the FactoryBean instance</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the object obtained from the FactoryBean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanCreationException if FactoryBean object creation failed</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> org.springframework.beans.factory.FactoryBean#getObject()</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">private</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">doGetObjectFromFactoryBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">FactoryBean</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">factory</span>, <span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">object</span>;
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>System.getSecurityManager<span style="color: #24a222;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">AccessControlContext</span> <span style="color: #6c71c4;">acc</span> = getAccessControlContext<span style="color: #24a222;">()</span>;
            <span style="color: #859900;">try</span> <span style="color: #24a222;">{</span>
                object = AccessController.doPrivileged<span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #268bd2;">PrivilegedExceptionAction</span><span style="color: #00bed1;">&lt;</span><span style="color: #268bd2;">Object</span><span style="color: #00bed1;">&gt;</span><span style="color: #1776b6;">)</span> factory::getObject, acc<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">PrivilegedActionException</span> <span style="color: #6c71c4;">pae</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> pae.getException<span style="color: #ff7f00;">()</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            object = factory.getObject<span style="color: #24a222;">()</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">FactoryBeanNotInitializedException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCurrentlyInCreationException</span><span style="color: #9564bf;">(</span>beanName, ex.toString<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>beanName, <span style="color: #2aa198;">"FactoryBean threw exception on object creation"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Do not accept a null value for a FactoryBean that's not fully</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">initialized yet: Many FactoryBeans just return null then.</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>object == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>isSingletonCurrentlyInCreation<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCurrentlyInCreationException</span><span style="color: #24a222;">(</span>
                    beanName, <span style="color: #2aa198;">"FactoryBean which is currently in creation returned null from getObject"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        object = <span style="color: #859900;">new</span> <span style="color: #268bd2;">NullBean</span><span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> object;
<span style="color: #8d5649;">}</span>
</pre>
</div>

<p>
往上跳一级，查看 <code>FactoryBeanRegistrySupport#getObjectFromFactoryBean(...)</code> 方法
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Obtain an object to expose from the given FactoryBean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> factory the FactoryBean instance</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> shouldPostProcess whether the bean is subject to post-processing</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the object obtained from the FactoryBean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanCreationException if FactoryBean object creation failed</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> org.springframework.beans.factory.FactoryBean#getObject()</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">getObjectFromFactoryBean</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">FactoryBean</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">factory</span>, <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">shouldPostProcess</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>factory.isSingleton<span style="color: #9564bf;">()</span> &amp;&amp; containsSingleton<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">synchronized</span> <span style="color: #9564bf;">(</span>getSingletonMutex<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">object</span> = <span style="color: #859900;">this</span>.factoryBeanObjectCache.get<span style="color: #24a222;">(</span>beanName<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>object == <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                object = doGetObjectFromFactoryBean<span style="color: #ff7f00;">(</span>factory, beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Only post-process and store if not put there already during getObject() call above</span>
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">(e.g. because of circular reference processing triggered by custom getBean calls)</span>
                <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">alreadyThere</span> = <span style="color: #859900;">this</span>.factoryBeanObjectCache.get<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>alreadyThere != <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    object = alreadyThere;
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">else</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span>shouldPostProcess<span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #859900;">if</span> <span style="color: #00bed1;">(</span>isSingletonCurrentlyInCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Temporarily return non-post-processed object, not storing it yet..</span>
                            <span style="color: #859900;">return</span> object;
                        <span style="color: #00bed1;">}</span>
                        beforeSingletonCreation<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span>;
                        <span style="color: #859900;">try</span> <span style="color: #00bed1;">{</span>
                            object = postProcessObjectFromFactoryBean<span style="color: #bcbf00;">(</span>object, beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #859900;">catch</span> <span style="color: #00bed1;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #00bed1;">)</span> <span style="color: #00bed1;">{</span>
                            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #bcbf00;">(</span>beanName,
                                    <span style="color: #2aa198;">"Post-processing of FactoryBean's singleton object failed"</span>, ex<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                        <span style="color: #859900;">finally</span> <span style="color: #00bed1;">{</span>
                            afterSingletonCreation<span style="color: #bcbf00;">(</span>beanName<span style="color: #bcbf00;">)</span>;
                        <span style="color: #00bed1;">}</span>
                    <span style="color: #1776b6;">}</span>
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span>containsSingleton<span style="color: #00bed1;">(</span>beanName<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        <span style="color: #859900;">this</span>.factoryBeanObjectCache.put<span style="color: #00bed1;">(</span>beanName, object<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">return</span> object;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">object</span> = doGetObjectFromFactoryBean<span style="color: #9564bf;">(</span>factory, beanName<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>shouldPostProcess<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">try</span> <span style="color: #24a222;">{</span>
                object = postProcessObjectFromFactoryBean<span style="color: #ff7f00;">(</span>object, beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #ff7f00;">(</span>beanName, <span style="color: #2aa198;">"Post-processing of FactoryBean's object failed"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> object;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
<code>getObjectFromFactoryBean</code> 实现了获取 FactoryBean 的 beanObject 的业务逻辑
</p>
<ol class="org-ol">
<li>如果是非单例 FactoryBean，在最外层的 else 代码，直接创建 beanObject</li>
<li>如果是单例 FactoryBean
<ul class="org-ul">
<li>首先获取单例缓存池 singletonObjects 的互斥锁</li>
<li>尝试从 factoryBeanObjectCache 缓存中获取创建好的 beanObject, 如果成功
直接返回结果</li>
<li>如果缓存获取失败，则需要调用 <code>doGetObjectFromFactoryBean(...)</code> 方法创
建 beanObject，并将创建好的 beanObject 放入 factoryBeanObjectCache 缓
存中</li>
</ul></li>
<li>在上述两种情况过后都需要调用 <code>postProcessObjectFromFactoryBean(...)</code> 方法
<ul class="org-ul">
<li><code>postProcessObjectFromFactoryBean(...)</code> 是一个空方法</li>
<li>这样设计是为子类提供扩展点</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgc7f348c" class="outline-3">
<h3 id="orgc7f348c"><span class="section-number-3">2.5</span> Bean 生命周期的实现</h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-org5318523" class="outline-4">
<h4 id="org5318523"><span class="section-number-4">2.5.1</span> Bean 创建的实现类: <code>AbstractAutowireCapableBeanFactory</code></h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
先看 <code>AbstractAutowireCapableBeanFactory</code> 的类继承关系
</p>
<div class="org-src-container">
<pre class="src src-text">org.springframework.beans.factory.support
Class AbstractAutowireCapableBeanFactory

    java.lang.Object
        org.springframework.core.SimpleAliasRegistry
            org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
                org.springframework.beans.factory.support.FactoryBeanRegistrySupport
                    org.springframework.beans.factory.support.AbstractBeanFactory
                        org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory

    All Implemented Interfaces:
        BeanFactory, AutowireCapableBeanFactory, ConfigurableBeanFactory,
        SingletonBeanRegistry, HierarchicalBeanFactory,
        org.springframework.core.AliasRegistry
</pre>
</div>
<ol class="org-ol">
<li><code>AbstractAutowireCapableBeanFactory</code> 实现了 <code>AutowireCapableBeanFactory</code> 接口</li>
<li><p>
<code>AutowireCapableBeanFactory</code> 中有管理 Autowire 功能 Bean 的方法
</p>
<ul class="org-ul">
<li><code>createBean(...)</code> 实例化 Bean</li>
<li><code>initializeBean(...)</code> 初始化 Bean</li>
<li><code>destroyBean(...)</code> 销毁 Bean</li>
<li>还有一些 Bean 的 <code>*PostProcessor*</code> 的增强函数</li>
</ul>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #268bd2;">AutowireCapableBeanFactory</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">BeanFactory</span> <span style="color: #8d5649;">{</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Typical methods for creating and populating external bean instances</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> T createBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">beanClass</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">void</span> <span style="color: #b58900;">autowireBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">configureBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span>, <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;

    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Specialized methods for fine-grained control over the bean lifecycle</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">createBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">beanClass</span>, <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">autowireMode</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">dependencyCheck</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">autowire</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span>?<span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">beanClass</span>, <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">autowireMode</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">dependencyCheck</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">void</span> <span style="color: #b58900;">autowireBeanProperties</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span>, <span style="color: #268bd2;">int</span> <span style="color: #6c71c4;">autowireMode</span>, <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">dependencyCheck</span><span style="color: #d8241f;">)</span>
            <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">void</span> <span style="color: #b58900;">applyBeanPropertyValues</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span>, <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">initializeBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span>, <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">applyBeanPostProcessorsBeforeInitialization</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span>, <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #d8241f;">)</span>
            <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">applyBeanPostProcessorsAfterInitialization</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span>, <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span><span style="color: #d8241f;">)</span>
            <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">void</span> <span style="color: #b58900;">destroyBean</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">existingBean</span><span style="color: #d8241f;">)</span>;

    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Delegate methods for resolving injection points</span>
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">-------------------------------------------------------------------------</span>
    <span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> <span style="color: #268bd2;">NamedBeanHolder</span><span style="color: #d8241f;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #d8241f;">&gt;</span> resolveNamedBean<span style="color: #d8241f;">(</span><span style="color: #268bd2;">Class</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">T</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">requiredType</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">resolveBeanByName</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">name</span>, <span style="color: #268bd2;">DependencyDescriptor</span> <span style="color: #6c71c4;">descriptor</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">@Nullable</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">resolveDependency</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">DependencyDescriptor</span> <span style="color: #6c71c4;">descriptor</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">requestingBeanName</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
    <span style="color: #268bd2;">@Nullable</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">resolveDependency</span><span style="color: #d8241f;">(</span><span style="color: #268bd2;">DependencyDescriptor</span> <span style="color: #6c71c4;">descriptor</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">requestingBeanName</span>,
            <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">Set</span><span style="color: #9564bf;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #9564bf;">&gt;</span> <span style="color: #6c71c4;">autowiredBeanNames</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">TypeConverter</span> <span style="color: #6c71c4;">typeConverter</span><span style="color: #d8241f;">)</span> <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeansException</span>;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-orgcc685a8" class="outline-4">
<h4 id="orgcc685a8"><span class="section-number-4">2.5.2</span> Bean 的实例化: <code>createBean(...)</code> 方法</h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
实际实例化 Bean 是在 <code>doCreateBean(...)</code> 方法中完成的，先准备一下调用栈
</p>
<div class="org-src-container">
<pre class="src src-text">doCreateBean:552, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
createBean:517, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)
lambda$doGetBean$0:323, AbstractBeanFactory (org.springframework.beans.factory.support)
getObject:-1, 1989335500 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$37)
getSingleton:222, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)
doGetBean:321, AbstractBeanFactory (org.springframework.beans.factory.support)
getBean:207, AbstractBeanFactory (org.springframework.beans.factory.support)
invokeBeanFactoryPostProcessors:89, PostProcessorRegistrationDelegate (org.springframework.context.support)
invokeBeanFactoryPostProcessors:706, AbstractApplicationContext (org.springframework.context.support)
refresh:532, AbstractApplicationContext (org.springframework.context.support)
&lt;init&gt;:101, AnnotationConfigApplicationContext (org.springframework.context.annotation)
main:21, MyApp04 (io.github.jeanhwea.app04_factory_bean)
</pre>
</div>

<p>
<code>createBean(...)</code> 方法实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Central method of this class: creates a bean instance,</span>
<span style="color: #d33682;"> * populates the bean instance, applies post-processors, etc.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #doCreateBean</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@Override</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">createBean</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>logger.isTraceEnabled<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        logger.trace<span style="color: #9564bf;">(</span><span style="color: #2aa198;">"Creating instance of bean '"</span> + beanName + <span style="color: #2aa198;">"'"</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbdToUse</span> = mbd;

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Make sure bean class is actually resolved at this point, and</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">clone the bean definition in case of a dynamically resolved Class</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">which cannot be stored in the shared merged bean definition.</span>
    <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">resolvedClass</span> = resolveBeanClass<span style="color: #d8241f;">(</span>mbd, beanName<span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>resolvedClass != <span style="color: #268bd2;">null</span> &amp;&amp; <span style="color: #268bd2;">!</span>mbd.hasBeanClass<span style="color: #9564bf;">()</span> &amp;&amp; mbd.getBeanClassName<span style="color: #9564bf;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        mbdToUse = <span style="color: #859900;">new</span> <span style="color: #268bd2;">RootBeanDefinition</span><span style="color: #9564bf;">(</span>mbd<span style="color: #9564bf;">)</span>;
        mbdToUse.setBeanClass<span style="color: #9564bf;">(</span>resolvedClass<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Prepare method overrides.</span>
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        mbdToUse.prepareMethodOverrides<span style="color: #9564bf;">()</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanDefinitionStoreException</span><span style="color: #9564bf;">(</span>mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>,
                beanName, <span style="color: #2aa198;">"Validation of method overrides failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span> = resolveBeforeInstantiation<span style="color: #9564bf;">(</span>beanName, mbdToUse<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>bean != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">return</span> bean;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>, beanName,
                <span style="color: #2aa198;">"BeanPostProcessor before instantiation of bean failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">beanInstance</span> = doCreateBean<span style="color: #9564bf;">(</span>beanName, mbdToUse, args<span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Finished creating instance of bean '"</span> + beanName + <span style="color: #2aa198;">"'"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">return</span> beanInstance;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span>BeanCreationException | ImplicitlyAppearedSingletonException ex<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">A previously detected exception with proper bean creation context already,</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
        <span style="color: #859900;">throw</span> ex;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbdToUse.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2aa198;">"Unexpected exception during bean creation"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>

</pre>
</div>
<p>
该方法的流程如下
</p>
<ol class="org-ol">
<li>通过 BeanDefinition 和 beanName 解析获取到待创建的类 resolvedClass</li>
<li>对 override 属性进行标记及验证
<ul class="org-ul">
<li><code>lookup-method</code>, <code>replace-method</code> 等</li>
</ul></li>
<li>处理 BeanPostProcessors, 进行一些前置处理工作
<ul class="org-ul">
<li><p>
<code>resolveBeforeInstantiation(...)</code> 方法完成前置处理工作
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Apply before-instantiation post-processors, resolving whether there is a</span>
<span style="color: #d33682;"> * before-instantiation shortcut for the specified bean.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> mbd the bean definition for the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the shortcut-determined bean instance, or </span><span style="color: #268bd2;">{@code null}</span><span style="color: #d33682;"> if none</span>
<span style="color: #d33682;"> */</span>
<span style="color: #268bd2;">@Nullable</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">resolveBeforeInstantiation</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span> = <span style="color: #268bd2;">null</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span><span style="color: #268bd2;">Boolean</span>.FALSE.equals<span style="color: #9564bf;">(</span>mbd.beforeInstantiationResolved<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Make sure bean class is actually resolved at this point.</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>mbd.isSynthetic<span style="color: #24a222;">()</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #268bd2;">Class</span><span style="color: #24a222;">&lt;</span>?<span style="color: #24a222;">&gt;</span> <span style="color: #6c71c4;">targetType</span> = determineTargetType<span style="color: #24a222;">(</span>beanName, mbd<span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>targetType != <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                bean = applyBeanPostProcessorsBeforeInstantiation<span style="color: #ff7f00;">(</span>targetType, beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span>bean != <span style="color: #268bd2;">null</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    bean = applyBeanPostProcessorsAfterInitialization<span style="color: #1776b6;">(</span>bean, beanName<span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
        mbd.beforeInstantiationResolved = <span style="color: #9564bf;">(</span>bean != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">return</span> bean;
<span style="color: #8d5649;">}</span>
</pre>
</div></li>
<li><code>applyBeanPostProcessorsBeforeInstantiation(...)</code> 方法在实例化前调用</li>
<li><code>applyBeanPostProcessorsAfterInitialization(...)</code> 方法在初始化后调用</li>
</ul></li>
<li>调用 <code>doCreateBean(...)</code> 创建 Bean 实例 beanInstance, 并返回 beanInstance</li>
</ol>

<p>
<code>doCreateBean(...)</code> 方法实现如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Actually create the specified bean. Pre-creation processing has already happened</span>
<span style="color: #d33682;"> * at this point, e.g. checking </span><span style="color: #268bd2;">{@code postProcessBeforeInstantiation}</span><span style="color: #d33682;"> callbacks.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">Differentiates between default bean instantiation, use of a</span>
<span style="color: #d33682;"> * factory method, and autowiring a constructor.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> mbd the merged bean definition for the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> args explicit arguments to use for constructor or factory method invocation</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> a new instance of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@throws</span><span style="color: #d33682;"> BeanCreationException if the bean could not be created</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #instantiateBean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #instantiateUsingFactoryMethod</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #autowireConstructor</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">doCreateBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #859900;">final</span> <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span>, <span style="color: #859900;">final</span> <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">Object</span><span style="color: #d8241f;">[]</span> <span style="color: #6c71c4;">args</span><span style="color: #8d5649;">)</span>
        <span style="color: #859900;">throws</span> <span style="color: #268bd2;">BeanCreationException</span> <span style="color: #8d5649;">{</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Instantiate the bean.</span>
    <span style="color: #268bd2;">BeanWrapper</span> <span style="color: #6c71c4;">instanceWrapper</span> = <span style="color: #268bd2;">null</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>mbd.isSingleton<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        instanceWrapper = <span style="color: #859900;">this</span>.factoryBeanInstanceCache.remove<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>instanceWrapper == <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        instanceWrapper = createBeanInstance<span style="color: #9564bf;">(</span>beanName, mbd, args<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">final</span> <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span> = instanceWrapper.getWrappedInstance<span style="color: #d8241f;">()</span>;
    <span style="color: #268bd2;">Class</span><span style="color: #d8241f;">&lt;</span>?<span style="color: #d8241f;">&gt;</span> <span style="color: #6c71c4;">beanType</span> = instanceWrapper.getWrappedClass<span style="color: #d8241f;">()</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>beanType != NullBean.<span style="color: #859900;">class</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        mbd.resolvedTargetType = beanType;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Allow post-processors to modify the merged bean definition.</span>
    <span style="color: #859900;">synchronized</span> <span style="color: #d8241f;">(</span>mbd.postProcessingLock<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span><span style="color: #268bd2;">!</span>mbd.postProcessed<span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">try</span> <span style="color: #24a222;">{</span>
                applyMergedBeanDefinitionPostProcessors<span style="color: #ff7f00;">(</span>mbd, beanType, beanName<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">catch</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #ff7f00;">(</span>mbd.getResourceDescription<span style="color: #1776b6;">()</span>, beanName,
                        <span style="color: #2aa198;">"Post-processing of merged bean definition failed"</span>, ex<span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            mbd.postProcessed = <span style="color: #268bd2;">true</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Eagerly cache singletons to be able to resolve circular references</span>
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
    <span style="color: #268bd2;">boolean</span> <span style="color: #6c71c4;">earlySingletonExposure</span> = <span style="color: #d8241f;">(</span>mbd.isSingleton<span style="color: #9564bf;">()</span> &amp;&amp; <span style="color: #859900;">this</span>.allowCircularReferences &amp;&amp;
            isSingletonCurrentlyInCreation<span style="color: #9564bf;">(</span>beanName<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>earlySingletonExposure<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>logger.isTraceEnabled<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            logger.trace<span style="color: #24a222;">(</span><span style="color: #2aa198;">"Eagerly caching bean '"</span> + beanName +
                    <span style="color: #2aa198;">"' to allow for resolving potential circular references"</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        addSingletonFactory<span style="color: #9564bf;">(</span>beanName, <span style="color: #24a222;">()</span> -&gt; getEarlyBeanReference<span style="color: #24a222;">(</span>beanName, mbd, bean<span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Initialize the bean instance.</span>
    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">exposedObject</span> = bean;
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        populateBean<span style="color: #9564bf;">(</span>beanName, mbd, instanceWrapper<span style="color: #9564bf;">)</span>;
        exposedObject = initializeBean<span style="color: #9564bf;">(</span>beanName, exposedObject, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>ex <span style="color: #859900;">instanceof</span> BeanCreationException &amp;&amp; beanName.equals<span style="color: #24a222;">(</span><span style="color: #ff7f00;">(</span><span style="color: #1776b6;">(</span><span style="color: #268bd2;">BeanCreationException</span><span style="color: #1776b6;">)</span> ex<span style="color: #ff7f00;">)</span>.getBeanName<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">BeanCreationException</span><span style="color: #24a222;">)</span> ex;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #24a222;">(</span>
                    mbd.getResourceDescription<span style="color: #ff7f00;">()</span>, beanName, <span style="color: #2aa198;">"Initialization of bean failed"</span>, ex<span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>earlySingletonExposure<span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">earlySingletonReference</span> = getSingleton<span style="color: #9564bf;">(</span>beanName, <span style="color: #268bd2;">false</span><span style="color: #9564bf;">)</span>;
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>earlySingletonReference != <span style="color: #268bd2;">null</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>exposedObject == bean<span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                exposedObject = earlySingletonReference;
            <span style="color: #24a222;">}</span>
            <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span><span style="color: #268bd2;">!</span><span style="color: #859900;">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #268bd2;">String</span><span style="color: #ff7f00;">[]</span> <span style="color: #6c71c4;">dependentBeans</span> = getDependentBeans<span style="color: #ff7f00;">(</span>beanName<span style="color: #ff7f00;">)</span>;
                <span style="color: #268bd2;">Set</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">String</span><span style="color: #ff7f00;">&gt;</span> <span style="color: #6c71c4;">actualDependentBeans</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">LinkedHashSet</span><span style="color: #ff7f00;">&lt;&gt;(</span>dependentBeans.length<span style="color: #ff7f00;">)</span>;
                <span style="color: #859900;">for</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">dependentBean</span> : dependentBeans<span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">if</span> <span style="color: #1776b6;">(</span><span style="color: #268bd2;">!</span>removeSingletonIfCreatedForTypeCheckOnly<span style="color: #00bed1;">(</span>dependentBean<span style="color: #00bed1;">)</span><span style="color: #1776b6;">)</span> <span style="color: #1776b6;">{</span>
                        actualDependentBeans.add<span style="color: #00bed1;">(</span>dependentBean<span style="color: #00bed1;">)</span>;
                    <span style="color: #1776b6;">}</span>
                <span style="color: #ff7f00;">}</span>
                <span style="color: #859900;">if</span> <span style="color: #ff7f00;">(</span><span style="color: #268bd2;">!</span>actualDependentBeans.isEmpty<span style="color: #1776b6;">()</span><span style="color: #ff7f00;">)</span> <span style="color: #ff7f00;">{</span>
                    <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCurrentlyInCreationException</span><span style="color: #1776b6;">(</span>beanName,
                            <span style="color: #2aa198;">"Bean with name '"</span> + beanName + <span style="color: #2aa198;">"' has been injected into other beans ["</span> +
                            StringUtils.collectionToCommaDelimitedString<span style="color: #00bed1;">(</span>actualDependentBeans<span style="color: #00bed1;">)</span> +
                            <span style="color: #2aa198;">"] in its raw version as part of a circular reference, but has eventually been "</span> +
                            <span style="color: #2aa198;">"wrapped. This means that said other beans do not use the final version of the "</span> +
                            <span style="color: #2aa198;">"bean. This is often the result of over-eager type matching - consider using "</span> +
                            <span style="color: #2aa198;">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span style="color: #1776b6;">)</span>;
                <span style="color: #ff7f00;">}</span>
            <span style="color: #24a222;">}</span>
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>

    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register bean as disposable.</span>
    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        registerDisposableBeanIfNecessary<span style="color: #9564bf;">(</span>beanName, bean, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">BeanDefinitionValidationException</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                mbd.getResourceDescription<span style="color: #24a222;">()</span>, beanName, <span style="color: #2aa198;">"Invalid destruction signature"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">return</span> exposedObject;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法实现流程如下
</p>
<ol class="org-ol">
<li>如果是单例 Bean, 首先清理缓存</li>
<li>通过 <code>createBeanInstance(...)</code> 方法将 BeanDefinition 转化成 BeanWrapper,
BeanWrapper 的作用如下
<ul class="org-ul">
<li>如果检测到 Supplier, 使用 Supplier 进行实例化，具体实现见
<code>obtainFromSupplier(...)</code> 方法</li>
<li>如果存在工厂方法, 则使用工厂方法进行实例化, 具体实现见
<code>instantiateUsingFactoryMethod(...)</code></li>
<li>如果包含多参数构造器，根据参数类型锁定的构造方法，然后调用进行实例化，具
体实现见 <code>autowireConstructor(...)</code> 方法</li>
<li>其它情况使用无参构造器进行实例化, 具体实现见 <code>instantiateBean(...)</code> 方法</li>
</ul></li>
<li>允许后置处理器合并 BeanDefinition</li>
<li>解决依赖，若有依赖项调用 <code>addSingletonFactory(...)</code> 添加到
singletonFactories 缓存中</li>
<li>调用 <code>populateBean(...)</code> 方法进行属性填充</li>
<li>调用 <code>initializeBean(...)</code> 方法进行初始化</li>
<li>循环依赖检测
<ul class="org-ul">
<li>只检测单例 Bean 的循环依赖</li>
<li>原型 Bean 的循环检测很难做到，Spring 做法是直接抛出异常</li>
</ul></li>
<li>注册 DisposableBean
<ul class="org-ul">
<li>便于 destroy-method 在Bean销毁时调用</li>
</ul></li>
<li>完成创建并返回</li>
</ol>
</div>
</div>

<div id="outline-container-org75f531e" class="outline-4">
<h4 id="org75f531e"><span class="section-number-4">2.5.3</span> Bean 的初始化: <code>initializeBean(...)</code> 方法</h4>
<div class="outline-text-4" id="text-2-5-3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Initialize the given bean instance, applying factory callbacks</span>
<span style="color: #d33682;"> * as well as init methods and bean post processors.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">&lt;p&gt;</span><span style="color: #d33682;">Called from </span><span style="color: #268bd2;">{@link #createBean}</span><span style="color: #d33682;"> for traditionally defined beans,</span>
<span style="color: #d33682;"> * and from </span><span style="color: #268bd2;">{@link #initializeBean}</span><span style="color: #d33682;"> for existing bean instances.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the bean name in the factory (for debugging purposes)</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> bean the new bean instance we may need to initialize</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> mbd the bean definition that the bean was created with</span>
<span style="color: #d33682;"> * (can also be </span><span style="color: #268bd2;">{@code null}</span><span style="color: #d33682;">, if given an existing bean instance)</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@return</span><span style="color: #d33682;"> the initialized bean instance (potentially wrapped)</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> BeanNameAware</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> BeanClassLoaderAware</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> BeanFactoryAware</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #applyBeanPostProcessorsBeforeInitialization</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #invokeInitMethods</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #applyBeanPostProcessorsAfterInitialization</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">Object</span> <span style="color: #b58900;">initializeBean</span><span style="color: #8d5649;">(</span><span style="color: #859900;">final</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #859900;">final</span> <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span>, <span style="color: #268bd2;">@Nullable</span> <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>System.getSecurityManager<span style="color: #9564bf;">()</span> != <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        AccessController.doPrivileged<span style="color: #9564bf;">(</span><span style="color: #24a222;">(</span><span style="color: #268bd2;">PrivilegedAction</span><span style="color: #ff7f00;">&lt;</span><span style="color: #268bd2;">Object</span><span style="color: #ff7f00;">&gt;</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">()</span> -&gt; <span style="color: #24a222;">{</span>
            invokeAwareMethods<span style="color: #ff7f00;">(</span>beanName, bean<span style="color: #ff7f00;">)</span>;
            <span style="color: #859900;">return</span> <span style="color: #268bd2;">null</span>;
        <span style="color: #24a222;">}</span>, getAccessControlContext<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">else</span> <span style="color: #d8241f;">{</span>
        invokeAwareMethods<span style="color: #9564bf;">(</span>beanName, bean<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">wrappedBean</span> = bean;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>mbd == <span style="color: #268bd2;">null</span> || <span style="color: #268bd2;">!</span>mbd.isSynthetic<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        wrappedBean = applyBeanPostProcessorsBeforeInitialization<span style="color: #9564bf;">(</span>wrappedBean, beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">try</span> <span style="color: #d8241f;">{</span>
        invokeInitMethods<span style="color: #9564bf;">(</span>beanName, wrappedBean, mbd<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">catch</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">Throwable</span> <span style="color: #6c71c4;">ex</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">BeanCreationException</span><span style="color: #9564bf;">(</span>
                <span style="color: #24a222;">(</span>mbd != <span style="color: #268bd2;">null</span> ? mbd.getResourceDescription<span style="color: #ff7f00;">()</span> : <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span>,
                beanName, <span style="color: #2aa198;">"Invocation of init method failed"</span>, ex<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span>mbd == <span style="color: #268bd2;">null</span> || <span style="color: #268bd2;">!</span>mbd.isSynthetic<span style="color: #9564bf;">()</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        wrappedBean = applyBeanPostProcessorsAfterInitialization<span style="color: #9564bf;">(</span>wrappedBean, beanName<span style="color: #9564bf;">)</span>;
    <span style="color: #d8241f;">}</span>

    <span style="color: #859900;">return</span> wrappedBean;
<span style="color: #8d5649;">}</span>
</pre>
</div>
<p>
该方法用于初始化 Bean，它完成了如下工作
</p>
<ol class="org-ol">
<li>调用 Aware 方法，例如
<ul class="org-ul">
<li>BeanFactoryAware</li>
<li>ApplicationContextAware</li>
<li>ResourceLoaderAware</li>
<li>ServletContextAware</li>
</ul></li>
<li>提供 BeanPostProcessor 的扩展点，环绕调用了如下两个钩子方法
<ul class="org-ul">
<li><code>applyBeanPostProcessorsBeforeInitialization(...)</code></li>
<li><code>applyBeanPostProcessorsAfterInitialization(...)</code></li>
</ul></li>
<li>调用自定义的初始化方法，及 init-method
<ul class="org-ul">
<li><code>invokeInitMethods(beanName, wrappedBean, mbd);</code></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org8a5cee4" class="outline-4">
<h4 id="org8a5cee4"><span class="section-number-4">2.5.4</span> Bean 的销毁</h4>
<div class="outline-text-4" id="text-2-5-4">
<p>
在 <code>doCreateBean(...)</code> 方法中调用了 <code>registerDisposableBeanIfNecessary(...)</code>
方法来提供 <code>destroy-method</code> 销毁的扩展
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #d33682;">/**</span>
<span style="color: #d33682;"> * Add the given bean to the list of disposable beans in this factory,</span>
<span style="color: #d33682;"> * registering its DisposableBean interface and/or the given destroy method</span>
<span style="color: #d33682;"> * to be called on factory shutdown (if applicable). Only applies to singletons.</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> beanName the name of the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> bean the bean instance</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@param</span><span style="color: #d33682;"> mbd the bean definition for the bean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> RootBeanDefinition#isSingleton</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> RootBeanDefinition#getDependsOn</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerDisposableBean</span>
<span style="color: #d33682;"> * </span><span style="color: #268bd2;">@see</span><span style="color: #d33682;"> #registerDependentBean</span>
<span style="color: #d33682;"> */</span>
<span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">registerDisposableBeanIfNecessary</span><span style="color: #8d5649;">(</span><span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">beanName</span>, <span style="color: #268bd2;">Object</span> <span style="color: #6c71c4;">bean</span>, <span style="color: #268bd2;">RootBeanDefinition</span> <span style="color: #6c71c4;">mbd</span><span style="color: #8d5649;">)</span> <span style="color: #8d5649;">{</span>
    <span style="color: #268bd2;">AccessControlContext</span> <span style="color: #6c71c4;">acc</span> = <span style="color: #d8241f;">(</span>System.getSecurityManager<span style="color: #9564bf;">()</span> != <span style="color: #268bd2;">null</span> ? getAccessControlContext<span style="color: #9564bf;">()</span> : <span style="color: #268bd2;">null</span><span style="color: #d8241f;">)</span>;
    <span style="color: #859900;">if</span> <span style="color: #d8241f;">(</span><span style="color: #268bd2;">!</span>mbd.isPrototype<span style="color: #9564bf;">()</span> &amp;&amp; requiresDestruction<span style="color: #9564bf;">(</span>bean, mbd<span style="color: #9564bf;">)</span><span style="color: #d8241f;">)</span> <span style="color: #d8241f;">{</span>
        <span style="color: #859900;">if</span> <span style="color: #9564bf;">(</span>mbd.isSingleton<span style="color: #24a222;">()</span><span style="color: #9564bf;">)</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Register a DisposableBean implementation that performs all destruction</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">work for the given bean: DestructionAwareBeanPostProcessors,</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">DisposableBean interface, custom destroy method.</span>
            registerDisposableBean<span style="color: #24a222;">(</span>beanName,
                    <span style="color: #859900;">new</span> <span style="color: #268bd2;">DisposableBeanAdapter</span><span style="color: #ff7f00;">(</span>bean, beanName, mbd, getBeanPostProcessors<span style="color: #1776b6;">()</span>, acc<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
        <span style="color: #859900;">else</span> <span style="color: #9564bf;">{</span>
            <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">A bean with a custom scope...</span>
            <span style="color: #268bd2;">Scope</span> <span style="color: #6c71c4;">scope</span> = <span style="color: #859900;">this</span>.scopes.get<span style="color: #24a222;">(</span>mbd.getScope<span style="color: #ff7f00;">()</span><span style="color: #24a222;">)</span>;
            <span style="color: #859900;">if</span> <span style="color: #24a222;">(</span>scope == <span style="color: #268bd2;">null</span><span style="color: #24a222;">)</span> <span style="color: #24a222;">{</span>
                <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">IllegalStateException</span><span style="color: #ff7f00;">(</span><span style="color: #2aa198;">"No Scope registered for scope name '"</span> + mbd.getScope<span style="color: #1776b6;">()</span> + <span style="color: #2aa198;">"'"</span><span style="color: #ff7f00;">)</span>;
            <span style="color: #24a222;">}</span>
            scope.registerDestructionCallback<span style="color: #24a222;">(</span>beanName,
                    <span style="color: #859900;">new</span> <span style="color: #268bd2;">DisposableBeanAdapter</span><span style="color: #ff7f00;">(</span>bean, beanName, mbd, getBeanPostProcessors<span style="color: #1776b6;">()</span>, acc<span style="color: #ff7f00;">)</span><span style="color: #24a222;">)</span>;
        <span style="color: #9564bf;">}</span>
    <span style="color: #d8241f;">}</span>
<span style="color: #8d5649;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb8613c5" class="outline-2">
<h2 id="orgb8613c5"><span class="section-number-2">3</span> IoC</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org0a72d25" class="outline-3">
<h3 id="org0a72d25"><span class="section-number-3">3.1</span> IoC 核心接口和类</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Spring 的 IoC 容器对象一般继承自 <code>ApplicationContext</code> 接口，常见的对象类如下
</p>

<p>
<code>ClassPathXmlApplicationContext</code>: 读取 ClassPath 中 XML 配置文件的 Bean 定义
的容器
</p>

<div class="org-src-container">
<pre class="src src-text">org.springframework.context.support
Class ClassPathXmlApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.AbstractRefreshableApplicationContext
                    org.springframework.context.support.AbstractRefreshableConfigApplicationContext
                        org.springframework.context.support.AbstractXmlApplicationContext
                            org.springframework.context.support.ClassPathXmlApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable, org.springframework.beans.factory.Aware,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.BeanNameAware,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.InitializingBean,
        org.springframework.beans.factory.ListableBeanFactory,
        ApplicationContext, ApplicationEventPublisher,
        ConfigurableApplicationContext, Lifecycle, MessageSource,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
<code>AnnotationConfigApplicationContext</code>: 读取注解 Bean 定义的容器
</p>

<div class="org-src-container">
<pre class="src src-text">org.springframework.context.annotation
Class AnnotationConfigApplicationContext

    java.lang.Object
        org.springframework.core.io.DefaultResourceLoader
            org.springframework.context.support.AbstractApplicationContext
                org.springframework.context.support.GenericApplicationContext
                    org.springframework.context.annotation.AnnotationConfigApplicationContext

    All Implemented Interfaces:
        Closeable, AutoCloseable,
        org.springframework.beans.factory.BeanFactory,
        org.springframework.beans.factory.HierarchicalBeanFactory,
        org.springframework.beans.factory.ListableBeanFactory,
        org.springframework.beans.factory.support.BeanDefinitionRegistry,
        AnnotationConfigRegistry, ApplicationContext,
        ApplicationEventPublisher, ConfigurableApplicationContext,
        Lifecycle, MessageSource, org.springframework.core.AliasRegistry,
        org.springframework.core.env.EnvironmentCapable,
        org.springframework.core.io.ResourceLoader,
        org.springframework.core.io.support.ResourcePatternResolver
</pre>
</div>

<p>
常见的类简单可以分成以下几类
</p>
<ol class="org-ol">
<li>资源处理
<ul class="org-ul">
<li><code>Resource</code> Spring 中关于资源的定义</li>
<li><code>ResourceLoader</code> 提供资源加载方法</li>
<li><code>BeanDefinitionReader</code> 读取接口主要用来读取信息</li>
</ul></li>
<li>注册形式，在 Spring 中关于注册的几个核心
<ul class="org-ul">
<li><code>AliasRegistry</code> 别名注册</li>
<li><code>BeanDefinitionRegistry</code> Bean 定义注册</li>
<li><code>SingletonBeanRegistry</code> 单例 Bean 注册
<ul class="org-ul">
<li><code>DefaultSingletonBeanRegistry</code></li>
</ul></li>
</ul></li>
<li>生命周期，可以分成容器生命周期和 Bean 生命周期两个小类
<ul class="org-ul">
<li><code>Lifecycle</code> 容器生命周期的核心接口</li>
<li><code>InitializingBean</code>, <code>DisposableBean</code> 等 Bean 的生命周期接口</li>
</ul></li>
<li>Bean 拓展
<ul class="org-ul">
<li><code>BeanPostProcessor</code></li>
<li><code>Aware</code> 系列接口</li>
</ul></li>
<li>上下文的接口:
<ul class="org-ul">
<li><code>ApplicationContext</code> 作为主导接口
<ul class="org-ul">
<li><code>AbstractApplicationContext</code></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgfe982f2" class="outline-2">
<h2 id="orgfe982f2"><span class="section-number-2">4</span> ApplicationContext</h2>
</div>

<div id="outline-container-org8cdd2e4" class="outline-2">
<h2 id="org8cdd2e4"><span class="section-number-2">5</span> AOP</h2>
<div class="outline-text-2" id="text-5">
<p>
使用动态代理实现
</p>
<ul class="org-ul">
<li>JDK 代理</li>
<li>cglib 代理</li>
</ul>
</div>
</div>

<div id="outline-container-org59c8192" class="outline-2">
<h2 id="org59c8192"><span class="section-number-2">6</span> Spring 核心类梳理</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li>ApplicationContext
<ul class="org-ul">
<li>AbstractApplicationContext
<ul class="org-ul">
<li><code>refresh()</code> 实现 Spring Bean 加载的核心逻辑</li>
</ul></li>
</ul></li>
<li>BeanDefinition
<ul class="org-ul">
<li>AbstractBeanDefinition</li>
</ul></li>
<li>BeanDefinitionReader
<ul class="org-ul">
<li>读取 BeanDefinition 对象</li>
</ul></li>
<li>BeanFactory
<ul class="org-ul">
<li>Bean 工厂类</li>
<li>AbstractBeanFactory
<ul class="org-ul">
<li><code>doGetBean(...)</code></li>
</ul></li>
</ul></li>
<li>BeanFactoryPostProcessor
<ul class="org-ul">
<li>函数式接口 <code>@FunctionalInterface</code></li>
</ul></li>
<li>BeanPostProcessor
<ul class="org-ul">
<li>提供自定义 Bean 实例化的处理接口扩展</li>
<li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化前置处理方法</li>
</ul></li>
<li><code>postProcessAfterInitialization(Object bean, String beanName)</code>
<ul class="org-ul">
<li>Bean 实例化后置处理方法</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgacd0711" class="outline-2">
<h2 id="orgacd0711"><span class="section-number-2">7</span> SpringBoot 自动装配</h2>
</div>
<div id="outline-container-orgf85c95a" class="outline-2">
<h2 id="orgf85c95a"><span class="section-number-2">8</span> 参考链接</h2>
<div class="outline-text-2" id="text-8">
<ol class="org-ol">
<li><a href="https://huifer.github.io/spring-analysis/">Spring Analysis</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Last Updated 2021-07-18 Sun 21:59. Created by Jinghui Hu at 2021-07-14 Wed 12:16.</p>
</div>
</body>
</html>
